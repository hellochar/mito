{"version":3,"sources":["math/random.ts","math/index.ts","core/tile/fountain.ts","core/tile/rock.ts","core/tile/index.ts","core/cell/gene.ts","core/constants.ts","std/genes/index.ts","game/audio.ts","game/ui/common/ResourceIcon.tsx","std/genes/GN.tsx","common/formatters.ts","core/cell/genome.ts","core/directions.ts","std/ticker.ts","core/cell/index.ts","core/temperature.ts","core/cell/cell.ts","std/genes/RI.tsx","core/cell/chromosome.ts","game/params.ts","core/inventory.ts","core/tile/soil.ts","game/ui/common/DynamicNumber.tsx","core/tile/tile.ts","std/genes/GeneReproducer.tsx","game/ui/common/MP.tsx","core/cell/cellEffect.ts","math/shuffle.ts","core/entity.ts","std/genes/GeneObstacle.tsx","std/genes/GeneTransport.tsx","common/mapRecord.ts","core/cell/realizedGene.ts","common/devlog.ts","common/perlin.ts","core/tile/deadCell.ts","std/genes/GeneDiffuseWater.tsx","core/tile/air.ts","std/genes/GenePipes.tsx","std/geneUtil.ts","std/genes/GeneAttractsSugar.tsx","std/genes/GeneCannotFreeze.tsx","std/genes/GenePhotosynthesis.tsx","core/cell/growingCell.ts","core/cell/cellProperties.ts","core/cell/geneInstance.ts","core/cell/materialInfo.ts","core/interactable.ts","core/tile/BarrenLand.ts","std/genes/GeneAiryExpansion.tsx","std/genes/GeneAttractsWater.tsx","std/genes/GeneBark.tsx","std/genes/GeneCostly.tsx","std/genes/GeneDiffuseSugar.tsx","std/genes/GeneEnergyTransfer.tsx","std/genes/GeneHydrostasis.tsx","std/genes/GeneInventory.tsx","std/genes/GeneLiving.tsx","std/genes/GeneMetabolism.tsx","std/genes/GeneNetworkEffect.tsx","std/genes/GeneNutrientExtraction.tsx","std/genes/GeneOsmosis.tsx","std/genes/GenePushWater.tsx","std/genes/GeneScaffolding.tsx","std/genes/GeneSoilAbsorption.tsx","std/genes/GeneVascular.tsx","assets/audio/Blop-Mark_DiAngelo-79054334.mp3","assets/audio/build.mp3","assets/audio/build_complete.mp3","assets/audio/deconstruct.mp3","assets/audio/drop_water.mp3","assets/audio/eating.mp3","assets/audio/footsteps.wav","assets/audio/fruit-popOpen.mp3","assets/audio/impactSoft_medium_003.mp3","assets/audio/interact.mp3","assets/audio/intro-bounce.mp3","assets/audio/mito-base.mp3","assets/audio/mito-drums.mp3","assets/audio/mito-overworld.mp3","assets/audio/mito-start.mp3","assets/audio/mito-strings.mp3","assets/audio/mitodeath.mp3","assets/audio/sticky.mp3","assets/audio/suckwater.wav","assets/audio/switch25.wav","assets/audio/whoosh.mp3","assets/images/sugar.png","assets/images/water.png","assets/images/fruit.png","assets/images/character.png","assets/images/test-vignette.png","assets/images/spritesheet.png","assets/audio/switch26.wav","assets/audio/rollover6.wav","std/genes sync /Gene.*/.tsx?$","std/genes/GeneAdhesion.tsx","std/genomes/standardGenome.ts","common/promise.ts","core/player/player.ts","core/season.ts","core/world/stepStats.ts","math/arrays.ts","std/tileGenerators.ts","core/world/generatorContext.ts","core/world/weatherController.ts","core/world/world.ts","std/genomes/tutorialGenome.ts","core/species.ts","tests/experiment.ts","tests/TestDiffusion.tsx","std/environments.ts","game/ui/common/Character.tsx","game/ui/common/Glow.tsx","game/screens/GameResultsScreen.tsx","tests/TestWinScreen.tsx","tests/TestLoseScreen.tsx","common/useMousePosition.ts","game/ui/SpeciesViewer/generateRandomGenes.tsx","game/app/reducer.ts","common/capitalize.ts","common/randomName.ts","core/environment.ts","core/overworld/levelInfo.ts","core/overworld/hexTile.ts","core/overworld/hexStore.ts","core/overworld/overWorld.ts","game/app/state.ts","game/app/saveLoad.ts","game/ui/common/Button.tsx","game/ui/overworld/SpeciesNode.tsx","game/ui/overworld/PhylogeneticTree.tsx","game/ui/overworld/EpochUI.tsx","math/poissonDisc.ts","game/ui/overworld/hexMath.ts","game/ui/common/Expand.tsx","game/ui/overworld/map/HexInfo.tsx","game/ui/overworld/map/hexTileSprite.ts","game/ui/overworld/map/OverWorldPopover.tsx","game/ui/overworld/map/OverWorldMap.tsx","common/configure.ts","game/ui/SpeciesViewer/AddCellCard.tsx","common/lazy.ts","game/spritesheet.ts","game/ui/common/IconCell.tsx","game/ui/SpeciesViewer/CellInteractionSelector.tsx","game/ui/SpeciesViewer/droppableId.ts","game/ui/SpeciesViewer/MoreOptionsPopover.tsx","game/ui/SpeciesViewer/GeneCost.tsx","game/ui/SpeciesViewer/RealizedGeneViewer.tsx","game/ui/SpeciesViewer/viewerState.ts","game/ui/SpeciesViewer/CellTypeViewer.tsx","game/ui/SpeciesViewer/GenomeViewer.tsx","game/ui/SpeciesViewer/speciesViewerDragEnd.ts","game/ui/SpeciesViewer/SpeciesViewer.tsx","game/ui/SpeciesViewer/index.ts","game/screens/OverWorldScreen.tsx","game/app/AppStateProvider.tsx","game/input/mouse.ts","game/screens/sketch/sketch.ts","game/renderers/Renderer.tsx","game/renderers/glsl.ts","game/renderers/committablePoints.ts","game/renderers/fireAndForgetPoints.ts","game/renderers/events/eventRenderer.ts","game/renderers/events/eventRendererFFPoints.ts","game/renderers/events/eventCellEatRenderer.ts","game/renderers/events/eventCellTransferEnergyRenderer.ts","math/easing.ts","game/renderers/events/eventCollectSunlightRenderer.ts","game/renderers/InventoryRenderer.tsx","game/renderers/events/eventEvaporationRenderer.ts","game/renderers/events/eventGrowFruitRenderer.ts","game/renderers/events/eventPhotosynthesisRenderer.ts","game/renderers/tile/CellEffectsRenderer.tsx","game/renderers/events/eventThawIceRenderer.ts","game/renderers/events/eventLogRenderer.ts","game/input/keyboard.ts","core/player/action.ts","game/renderers/neuronMesh.ts","game/renderers/tile/Animation.tsx","game/renderers/PlayerRenderer.tsx","game/renderers/PlayerSeedRenderer.tsx","common/arrayProxy.ts","game/renderers/tile/GeneRenderer.tsx","game/renderers/tile/makeLine.ts","game/renderers/tile/GenePhotosynthesisRenderer.tsx","game/renderers/tile/GenePipesRenderer.tsx","game/renderers/tile/GeneReproducerRenderer.tsx","game/renderers/tile/GeneSoilAbsorptionRenderer.tsx","game/renderers/tile/GeneTransportRenderer.tsx","game/renderers/tile/InstancedTileRenderer.tsx","game/renderers/tile/tileBatcher.ts","game/renderers/WorldRenderer.tsx","std/vignette.ts","game/gameResult.ts","game/input/keymap.ts","game/input/ControlScheme.tsx","game/input/toolBar.ts","game/mito/WorldDOMElement.tsx","game/renderers/r3/Animate.tsx","game/renderers/r3/sceneObject.tsx","game/renderers/r3/buildBlueprint.tsx","game/renderers/r3/PointHighlight.tsx","game/renderers/r3/tileHighlight.tsx","std/worldUtils.ts","game/ui/ingame/Hover.tsx","game/ui/ingame/HotkeyButton.tsx","game/ui/ingame/InventoryBar.tsx","game/ui/ingame/TemperatureGauge.tsx","game/ui/ingame/TileDetails.tsx","game/ui/ingame/hud/CellInspector.tsx","game/ui/ingame/hud/GameMenu.tsx","game/ui/ingame/hud/HUD.tsx","game/ui/ingame/hud/InvalidActionMessage.tsx","game/ui/ingame/hud/PausedTileDetailsPopover.tsx","game/ui/ingame/hud/SeasonsTracker.tsx","game/ui/ingame/hud/ToolBarUI.tsx","game/ui/ingame/hud/Tutorial.tsx","game/ui/ingame/PlantStats.tsx","game/ui/ingame/Debug.tsx","game/mito/ovalNode.ts","game/mito/mito.tsx","game/mito/logRenderInfo.tsx","game/mito/perfDebugThreeObjects.ts","game/screens/sketch/SketchComponent.tsx","game/screens/MitoScreen.tsx","game/screens/StartScreen.tsx","game/screens/App.tsx","tests/TestStats.tsx","Routes.tsx","addThreeJsModelSchemas.ts","serviceWorker.ts","index.tsx"],"names":["randFloat","min","max","Math","random","randInt","inclusiveMin","inclusiveMax","floor","randElement","arr","length","lerp","a","b","x","lerp2","v","t","l","y","map","xStart","xStop","yStart","yStop","clamp","randRound","ix","fx","mod","m","sawTooth","roundToNearest","to","round","toVector2","Vector2","Fountain","pos","world","secondsPerWater","waterRemaining","displayName","isObstacle","cooldown","dt","this","inventory","space","add","silt","Silt","clone","give","water","sugar","maybeRemoveCellAt","setTileAt","Rock","isStructuralSupport","Inventory","Tile","Gene","blueprint","initialStateFn","stepFn","shouldStepFn","level","RealizedGene","levelCosts","initialState","step","shouldStep","alwaysStep","neverStep","gene","stepNoOP","name","exists","AllGenesByName","has","console","error","set","Map","PLAYER_BASE_SPEED","PLAYER_MAX_RESOURCES","PLAYER_STARTING_WATER","PLAYER_STARTING_SUGAR","PLAYER_INTERACT_EXCHANGE_SPEED","TIME_PER_YEAR","TIME_PER_SEASON","TIME_PER_MONTH","TIME_PER_DAY","PERCENT_DAYLIGHT","CELL_BUILD_TIME","CELL_DROOP","SUNLIGHT_REINTRODUCTION","SUNLIGHT_DIFFUSION","mito","strings","drums","genePickUp","Howl","src","genePickUpSrc","geneDrop","require","moveBumped","mitoDeath","mitoDeathMp3","autoplay","loop","volume","mitoOverworld","mitoStartScreenMp3","mitoOverworldMp3","footsteps","footstepsSrc","interactSound","interactSoundSrc","introBounce","introBounceSrc","whoosh","whooshSrc","fruitPoof","fruitPoofSrc","build","buildSoundSrc","buildComplete","buildCompleteSrc","deconstruct","deconstructSoundSrc","sticky","stickySoundSrc","dropSugar","impactSoftMedium003Src","dropWater","dropWaterSrc","loader","THREE","loadAudioPromise","Promise","resolve","reject","load","audioBuffer","xhr","err","devlog","blopBuffer","blopSrc","suckWaterBuffer","suckWaterSrc","eatBuffer","eatingSoundSrc","hookUpAudio","ctx","numDone","oneMoreLoaded","audio","currentTime","gain","connect","makeUnitFromAudioAsset","mitoBaseSrc","oncanplaythrough","value","mitoStringsSrc","mitoDrumsSrc","sourceElement","type","substr","source","document","createElement","srcs","appendChild","createMediaElementSource","createGain","distScalar","player","dist","distanceToSquared","ResourceIcon","React","s","alt","sugarSrc","waterSrc","className","GN","props","cache","nf","n","maximumSignificantDigits","minimumSignificantDigits","key","Intl","NumberFormat","undefined","useGrouping","get","format","interactSpeedMap","interactionSpeed","interaction","resources","CellInteractionSchema","createSimpleSchema","CellType","serializable","object","Chromosome","MaterialInfoSchema","geneSlots","chromosome","material","args","computeStaticProperties","isDirectional","direction","rotateAround","PI","setLength","genes","some","getStaticProperties","isReproductive","duplicateGenesPairs","toPairs","groupBy","rg","filter","Set","flatMap","geneSlotsNet","pow","abs","Genome","list","cellTypes","unusedGenes","cell","describeCellInteraction","DIRECTIONS","nw","w","sw","ne","e","se","DIRECTION_VALUES","Object","keys","o","Ticker","tickerId","tickers","_time","tickerLoop","time","toDelete","id","f","push","Number","removeAnimation","requestAnimationFrame","fn","start","Temperature","temperatureFor","Freezing","Cold","Mild","Hot","Scorching","nextTemperature","currentTemperature","neighborTemperatures","averageTemperature","Cell","energy","darkness","droopY","effects","geneInstances","staticProperties","properties","isDead","inventoryCapacity","copy","temperatureFloat","computeDynamicProperties","newGeneInstances","diffusionWater","diffusionSugar","timeToBuild","tempo","temperatureTempo","energyUpkeep","getDynamicProperties","giver","effect","constructor","stacks","findEffectOfType","cantFreeze","FreezeEffect","attachTo","find","isInteractable","action","interact","target","continuous","DeadCell","g","isType","params","debug","validateDirection","stepDroop","stepCancer","stepCellEffects","stepGeneInstances","stepEnergyUpkeep","die","forEach","getChanceToBecomeCancerous","addEffect","CancerEffect","neighbors","tileNeighbors","Array","from","values","chanceToFreeze","waterToLose","chanceEvaporate","logEvent","tile","below","belowLeft","belowRight","left","right","above","aboveLeft","aboveRight","droopAmount","springNeighborCells","reduce","sum","stepDroopPositionUpdate","height","equals","posFloat","dir","isFractional","manhattanLength","RI","defaultCellProperties","entries","k","newInstance","r","getCost","c","geneSlotsAdded","geneSlotsUsed","PARAMS_DEFAULT","hud","showGodUI","showFPS","debugPerf","process","search","parse","window","location","urlHashParams","JSON","assign","nonDefaultParams","stringified","stringify","updateParamsHash","fpref","capacity","carrier","events","validate","other","amountWater","amountSugar","Error","spaceNeeded","spaceAvailable","change","emit","EventEmitter","on","off","newWater","newSugar","warn","Soil","depth","Air","stepEvaporation","secondsToEvaporate","environment","evaporationChance","waterToEvaporate","numEvaporatedSoil","diffusionRate","saturation","freeWater","fallAmount","lowerNeighbor","tileAt","canPullResources","waterToGive","_dt","outsideTemperature","weather","getCurrentTemperature","Sand","depthDiffusionFactor","Clay","DynamicNumber","speed","sigFigs","useState","setV","useEffect","tickOnce","addAnimation","Infinity","dtSinceLastStepped","timeMade","sqrt","giveCandidates","guard","shuffle","i","neighbor","waterGiven","sugarGiven","isMaxed","splice","stepDarkness","stepDiffusion","stepTemperature","stepGravity","minDarkness","darknessFromNeighbor","darknessContrib","diffuseWater","diffuseSugar","difference","isBreakingSurfaceTension","diffusionAmount","GeneFruit","make","levelProps","mpEarned","neededEnergy","static","description","reproducerDescription","isMature","energyRecieved","instance","reproducerStep","GeneSeed","amount","state","seed","energyLeftToTake","manhattanDistanceTo","energyToTake","resourcesUsed","commitEnergy","isNowMature","reproducerGetPercentMatured","timeMatured","earnMP","MP","total","classNames","CellEffect","onAttached","index","indexOf","secondsToDie","percentFrozen","chunkCooldown","where","onFrozenChanged","temperature","StopStep","remove","age","secondsPerDuplication","timeToDuplicate","canBuildAt","newCell","array","temporaryValue","randomIndex","currentIndex","isSteppable","obj","sDt","GeneObstacle","GeneTransport","secondsPerPush","didJustTransport","forwardTile","backwardTile","waterToTransport","sugarToTransport","mapRecord","out","val","custom","identifier","setLevel","isArray","dynamic","newLevel","numLevels","GeneInstance","getProps","uuid","message","Grad","z","grad3","p","F2","G2","G3","Noise","perm","gradP","octaveNum","octaveFalloff","octaveMatrix2","cos","sin","xin","yin","i1","j1","j","x0","y0","x1","y1","x2","y2","gi0","gi1","gi2","t0","t1","t2","dot2","scalar","simplex2","newX","newY","zin","k1","i2","j2","k2","z0","z1","z2","x3","y3","z3","gi3","t3","dot3","simplex3","X","Y","n00","n01","n10","n11","u","fade","Z","n000","n001","n010","n011","n100","n101","n110","n111","GeneDiffuseWater","sunlightCached","_co2","computeCo2","base","floorCo2","scaleX","offset","noiseCo2","perlin3","width","sunlight","stepDiffusionCheap","tryDiffuse","airEvaporation","numEvaporatedAir","GenePipes","connections","directionName","cellAt","takeFromOneNeighborCell","waterTaken","sugarTaken","GeneAttractsSugar","secondsPerPull","GeneCannotFreeze","GenePhotosynthesis","reactionChancePerSecond","totalSugarProduced","averageConversionRate","averageChancePerSecond","sugarConverted","activeNeighbors","numAir","maybePhotosynthesize","air","waterToConvert","ambientChancePerSecond","leaf","numSunlight","chancePerSecond","sugarMade","chromosomeGrowingCell","GeneLiving","GrowingCell","completedCell","cellTypeGrowingCell","percentGrown","timeToGrow","silent","play","rate","costSugar","costWater","maybeNewState","color","Color","texturePosition","BarrenLand","GeneAiryExpansion","GROWTH_RATE","GeneAttractsWater","GeneBark","timeBeforeGrowth","tried","deadCell","GeneCostly","_","GeneDiffuseSugar","GeneEnergyTransfer","differenceThreshold","ENERGY_GIVE_RATE","maybeGiveEnergy","energyToGive","GeneHydrostasis","PERCENT_FASTER","GeneInventory","secondsPerUpkeep","GeneMetabolism","energyPerSugar","EAT_ENERGY_PER_SECOND","maxEnergyToEat","hunger","getMaxEnergyToEat","sugarToEat","gotEnergy","who","stepEatSugar","GeneNetworkEffect","numSameType","GeneNutrientExtraction","energyPerSecond","hasMonthPassed","soil","barrenSoil","GeneOsmosis","isOsmosising","GenePushWater","GeneScaffolding","GeneSoilAbsorption","secondsPerAbsorb","totalSucked","absorbWater","GeneVascular","vascularNeighbors","module","exports","webpackContext","req","webpackContextResolve","__webpack_require__","code","GeneAdhesion","nonCellNeighbors","cellTypeTissue","cellTypeLeaf","cellTypeRoot","cellTypeTransport","cellTypeFruit","standardGenome","sleep","millis","setTimeout","Player","baseSpeed","currentTile","getMovespeedMultiplier","actions","cellType","duration","elapsed","bfsIterator","isWalkable","event","cb","nearestWalkableCell","findNearestWalkableCell","attemptAction","result","_attemptAction","log","attemptMove","attemptBuild","attemptDeconstruct","attemptDrop","attemptPickup","attemptMultiple","attemptLong","attemptThaw","attemptRemoveCancer","nextPos","existingTile","position","existingCell","needWater","needSugar","canBuild","matureCell","force","waterToDrop","sugarToDrop","inv","multiple","allSuccess","thaw","removeCancer","PlayerSeed","poppedOut","velY","removePlayerSeed","genome","growingCell","distanceTo","then","seasonFromTime","year","timeInYear","season","percent","month","day","SEASON_NAMES","seasonDisplay","StepStats","frame","deleted","added","evaporation","photosynthesis","oof","arrayRange","fill","gridRange","mixedSoilRock","generatorContext","noiseSoil","noiseWater","octaveSimplex2","TileGenerators","Level0","noiseHeight","noiseRock","soilLevel","perlin2","rockThreshold","heightScalar","simplexValue","emitWaterScalar","Temperate","Desert","isRock","Rocky","Reservoires","isRockHere","isRockBelow","SkySoil","modulateSeed","letter","charCodeAt","createGeneratorContext","WeatherController","temperaturePerSeason","updateTemperatures","computeSunlight","stepWeather","climate","timeBetweenRainfall","rainDuration","numWater","waterPerSecond","dropletSize","numRainWater","sunAngle","directionalBias","sunAmount","environmentTileAt","tileUp","tileRight","tileLeft","upSunlight","rightSunlight","leftSunlight","allCells","timeOfDay","atan","optionsDefault","World","species","optionsPartial","playerSeed","gridEnvironment","gridCells","neighborCache","mpEarners","cachedEntities","stepStats","options","tileGenerator","computeTileNeighbors","fillCachedEntities","computeSoilDepths","firstNonAir","tileEnvironment","tileCell","xOrVec2","isValidPosition","oldTile","redistributeInventoryToNeighbors","oldCell","oldEnvironmentTile","handleTileUpdated","px","py","mapping","DIRECTION_VALUES_RAND","newEntities","reverse","entities","entity","airPositions","allEnvironmentTiles","minNeighborDepth","totalSugar","totalWater","totalEnergy","Symbol","iterator","self","row","return","limit","heuristic","frontier","processed","size","shift","sort","slice","cellTypeSeed","tutorialGenome","SpeciesSchema","primitive","freeMutationPoints","totalMutationPoints","geneOptions","newBaseSpecies","descendants","lineage","parent","reference","Experiment","visitors","trials","tiles","trial","results","visitor","visit","ExperimentSuite","experiments","recordDataFor","allSoilEnvironment","testWorld","runTwoWideCompare","world1","world2","cell1","cell2","c1w","experiment","timeEnd","TestDiffusion","script","addEventListener","divId","data","trialIndex","visitorNames","trace","div","getElementById","Plotly","newPlot","barmode","plotStackedBar","e1","runOneWideAbsolute","table","e2","body","Character","otherProps","characterSrc","Glow","FruitResult","fruit","scale","style","transform","fruitSrc","toFixed","ReproductiveCellResult","findGene","toString","MPEarnerList","VignetteList","vignettes","setIndex","stepSize","onChange","showTrackFill","labelRenderer","toDataURL","GameWonScreen","winDescription","mutationPointsPerEpoch","GameLostScreen","stop","GameResultsScreen","onDone","attempt","primaryButtonText","sourceHex","status","onClick","mockFruit","neededResources","TestWinScreen","f1","f2","f3","mockResults","TestLoseScreen","MousePositionContext","createContext","innerWidth","innerHeight","useMousePosition","populateGeneOptions","allGenes","getAllGenes","hasTransport","hasPipes","hasDiffuseWater","numGenes","AllGenes","generateRandomGenes","AppReducerContext","useAppReducer","useContext","reducer","rootSpecies","handleUpdateSpecies","populationAttempt","targetHex","info","visible","flora","activePopulationAttempt","handleStartPopulationAttempt","handlePopulationAttemptSuccess","produce","draft","overWorld","getMaxGenePool","epoch","handleNextEpoch","activeGameResult","handleGetGameResult","handleGameResultDone","transition","handleTransitionStart","settlingSpecies","hexAt","gtag","label","oldSpecies","hexNeighbors","capitalize","toLocaleUpperCase","CHARS_LOWER","CHARS_UPPER","toUpperCase","character","letters","pool","casing","alpha","numeric","symbols","charAt","syllable","chr","text","consonants","LANDSCAPES","randomName","syllables","substring","word","replace","EnvironmentSchema","LevelInfoSchema","rainfall","soilType","wind","actionPoints","C","HexTile","_displayName","MAX_SAFE_INTEGER","HexStore","hash","OverWorld","storage","startTile","hex","populatedActiveNeighbors","getHexesPopulatedBy","hexes","noise","cartesian","noise3D","randomHeight","maxDist","SimplexNoise","populateLevelInfo","getDefaultStartTile","magnitude","AppStateSchema","save","appState","json","serialize","stringToSave","localforage","setItem","getItem","string","deserialize","ACTIONS_TO_SAVE_ON","AAGameResultDone","AAGetGameResult","AAUpdateSpecies","AANextEpoch","AAPopulationAttemptSuccess","AAStartPopulationAttempt","Button","children","SpeciesNode","onMutate","handleClick","useCallback","PhylogeneticTree","EpochUI","onNextEpoch","onFocusHex","transitioning","setTransitioning","speciesProductionEls","allSpecies","pointsPerEpoch","epochButtonTooltipContent","content","disabled","poissonDisc","radius","initialSample","rng","radius2","R","cellSize","SQRT1_2","gridWidth","ceil","gridHeight","grid","queue","queueSize","sampleSize","far","i0","j0","dx","dy","sample","sampler","samples","Y_SQUISH_FACTOR","getClickedHexCoords","canvas","camera","dX","dY","cX","cY","nativeEvent","offsetX","offsetY","rx","ry","rz","x_diff","y_diff","z_diff","roundCubeCoordinates","pixelPosition","getCameraPositionCenteredOn","vectors","isPointInHexagon","HALF_HEIGHT","q2x","q2y","Expand","shrunkElements","expanded","setExpanded","HexInfo","playSpecies","onClickPlay","playButtonElement","isHabitable","stringifyInfo","expand","fontSize","testVignette","Image","testVignetteUrl","COLOR_SCALE_HEIGHT","scaleLinear","domain","range","HexTileSprite","context","vignettePositions","isHovered","lineWidth","isShadowed","globalAlpha","fillStyle","strokeStyle","drawHex","drawNumericHeight","drawVignettes","beginPath","moveTo","arc","stroke","drawCircle","drawPulse","tOffset","thickness","easePulse","now","font","textAlign","textBaseline","fillText","positions","dropFirst","normSamples","generateNaturalRandomHexagonPoints","sizeScale","drawImage","highlightedHex","angle","lineTo","closePath","easeExpIn","OverWorldPopover","container","top","OverWorldMap","hexTileSprites","rafId","handleCanvasRef","ref","handleResize","handleCanvasClick","setState","coords","cameraState","clicked","possibleMigrationSources","handleCanvasMouseLeave","hoveredHex","handleCanvasMouseMove","handleClickPlay","dispatch","appAction","getAppAction","handleKeyDown","repeat","newPressedKeys","pressedKeys","handleKeyUp","handleWheel","delta","deltaX","deltaY","updateCanvas","updateCamera","nextScale","targetDX","targetDY","getStartHex","sprite","getContext","drawMap","drawMigrationArrows","drawPopulationAttempt","clearRect","setIsHovered","sprites","zIndex","draw","drawPossibleMigrationIntoArrows","drawPossibleMigrationOutOfArrows","drawMigrationArrow","removeEventListener","prevProps","focusedHex","focusHex","tStart","targetX","targetY","tabIndex","onMouseLeave","onMouseMove","onWheel","maybeRenderPopover","possibleMigrationTargets","shadowBlur","shadowOffsetX","shadowOffsetY","shadowColor","lineCap","lineJoin","targetCenter","sourceCenter","arrowStart","arrowEnd","fromx","fromy","tox","toy","headlen","atan2","drawArrow","PureComponent","configure","callback","contextType","AddCellCard","handleAddCell","newCellType","lazy","spritesheetLoaded","SPRITESHEET","spritesheetUrl","texture","magFilter","flipY","wrapS","wrapT","dispatchEvent","textureFromSpritesheet","backgroundColor","drawSpriteToCanvas","image","fillRect","needsUpdate","ActionBarItem","IconCell","showCosts","getStyle","useMemo","url","HTMLCanvasElement","backgroundImage","costsEl","reproducer","isReproducer","CellInteractionSelector","memo","setInteraction","handleSelect","indexOrUndefined","possibleInteractions","selectValue","findIndex","interactionEl","defaultValue","String","resourceTypes","droppableIdToCell","droppableId","MoreOptionsPopover","isOpen","setIsOpen","handleMoreClicked","open","handleOuterAction","popoverContent","transitionDuration","popoverClassName","GeneCost","cost","negative","EnergyUpkeep","els","upkeep","RealizedGeneViewer","draggable","view","invalid","gd","energyUpkeepEl","geneLevelEl","draggableId","isDragDisabled","provided","snapshot","rubric","innerRef","draggableProps","dragHandleProps","provider","ViewerContext","editable","isDragging","CellTypeViewer","handleSetInteraction","GeneSlots","chanceForCancer","cancerEl","isGeneSlotsOver","tooltipContent","hoverOpenDelay","ChromosomeViewer","viewerState","empty","duplicateGenes","getDuplicateGenes","validationEl","droppableProps","dragging","placeholder","CellActionsPopover","deleteCellType","chromosomeEmpty","isEmpty","GenomeViewer","speciesViewerDragEnd","destination","sourceIndex","destinationIndex","shouldRepopulateGeneOptions","sourceCell","destinationCell","SpeciesViewer","speciesId","setIsDragging","setView","handleDragEnd","handleBeforeCapture","before","handleViewSmall","handleViewExpanded","onDragEnd","onBeforeCapture","Provider","active","MutationChooser","isDropDisabled","DeleteGeneDroppable","hovered","isDraggingOver","foo","UnusedGeneArea","OverWorldScreen","leftPanelOpen","setLeftPanelOpen","preventDefault","viewedSpecies","setViewedSpecies","handleStartMutate","onMountEpoch","useRef","current","speciesReadyToMutate","handleSpeciesViewerClose","speciesViewerEl","onClose","setFocusedHex","handleFocusHex","unusedPoints","unusedPointsEl","maybeRenderPhylogeneticTreePanel","confirm","removeItem","reload","handleTransitionEndMiddleware","stateWithoutTransition","handleTransitionEnd","AppStateProvider","reducerWithMiddleware","newState","hasOwnProperty","useReducer","dispatchRaw","newDispatch","autoTransitionEndDispatchMiddleware","reducerTuple","LocalForageStateProvider","loadingComponent","catch","newGameState","generateRectangle","startHex","newInitialAppState","Mouse","el","isPressed","button","handleMouseDown","handleMouseMove","clientX","clientY","handleMouseUp","UI_EVENTS","click","contextmenu","dblclick","mousedown","mouseup","mousemove","touchstart","touchmove","touchend","keyup","keydown","keypress","wheel","ISketch","renderer","audioContext","elements","timeElapsed","frameCount","domElement","Renderer","scene","glsl","CommittablePoints","geometry","newGeometry","ResourcePointsMaterial","frustumCulled","BufferGeometry","Float32Array","rotations","sizes","alphas","setAttribute","BufferAttribute","setUsage","DynamicDrawUsage","attributes","setXYZ","setX","rotation","setDrawRange","Points","uniforms","opacity","sizeGlobal","vertexShader","fragmentShader","depthTest","transparent","ShaderMaterial","FireAndForgetPoints","lifeFn","toRemove","delete","startFrame","commit","endFrame","EventRenderer","eventName","worldRenderer","getLastStepStats","EventRendererFFPoints","ffPoints","update","handle","commitAll","EventCellEatRenderer","makePoints","Audio","audioListener","setVolume","buffer","setBuffer","setDetune","setValueAtTime","cancelScheduledValues","setTargetAtTime","tileRenderer","renderers","activeSugar","inventoryRenderer","getActiveSugar","fire","EventCellTransferEnergyRenderer","reversed","polyUpDown","polyEarlyUpDown","EventCollectSunlightRenderer","point","itr","randWaterPosition","waters","graphics","WATER_POINTS_PARAMS","SUGAR_POINTS_PARAMS","InventoryPoints","sugars","InventoryRenderer","particlePoints","animationOffset","stableWater","handleGetResources","updateSugarAndWaterParticles","handleGiveResources","handleAddResources","updateParticlesArray","verifyArrayLengths","particles","resource","wantedParticles","sub","resourceArray","numFullSizedParticles","fract","numWaters","numResources","vx","vy","goTowardsCenterStrength","playerX","playerY","mag2","avoidPlayerStrength","otherResource","lengthSq","fraction","strength","simulateResourcePositions","commitParticles","EventEvaporationRenderer","getStableWater","EventGrowFruitRenderer","a0","easeCubicIn","smoothstep","EventPhotosynthesisRenderer","CellEffectsRenderer","createEffectRenderer","destroy","FreezeEffectRenderer","CancerEffectRenderer","FREEZE_BLUE","mesh","newMesh","PlaneBufferGeometry","MeshBasicMaterial","side","DoubleSide","Mesh","lastTimeToDuplicate","RingBufferGeometry","EventThawIceRenderer","easeSinOut","EventLogRenderer","singleEventRenderers","OPPOSITE_KEYS","KeyS","KeyW","KeyA","KeyD","Keyboard","keyMap","handleBlur","clear","shiftKey","ctrlKey","altKey","metaKey","isContinuous","baseMesh","CircleBufferGeometry","Node","vel","NeuronMesh","numNodes","nodes","meshes","line","pullForceScalar","towardsTargetForce","dragForceScalar","goTowardsTargetForce","node","multiplyScalar","dragForce","drag","pullForce","lineGeo","Geometry","vertices","Line","LineBasicMaterial","last","prev","next","verticesNeedUpdate","Object3D","AnimationController","animation","timeStarted","timeLastUpdated","ended","chain","animations","numEnded","lastStarted","currAnimation","also","firstAnim","secondAnim","secondEnded","firstEnded","animPause","PlayerRenderer","neuronMesh","handleStartLongAction","buildReproducerAnimation","handleAction","handleInteracted","playing","handlePlayerActionFail","invalidAction","showInvalidAction","prevHighlightedTile","droopPosFloat","addFloatingText","isUsingShift","isInteract","controls","wouldLeftClickInteract","highlight","highlightedTile","neuronMeshTarget","ZERO","actionLong","animWaitForCameraZoomIn","animSendCopy","animWaitEnd","tNorm","shakeFrequency","shakeAmplitude","suggestCamera","center","zoom","easeSinInOut","renderOrder","PlayerSeedRenderer","scenePlayerSeed","fallInAnimation","wiggleAnimationForever","popOutAnimation","setScalar","easeQuadOut","easeBounceOut","tBounded","zRot","NO_OP","GeneRenderer","init","lineGeometry","Float32BufferAttribute","makeLine","origin","quaternion","axis","Vector3","normalize","radians","acos","setFromAxisAngle","updateMatrix","matrixAutoUpdate","GenePhotosynthesisRenderer","renderResources","lastAudioValueTracker","neighborLines","newAudioValueTracker","baseVolume","growPulseAnimation","lines","disconnect","geom","BoxBufferGeometry","materialMap","GenePipesRenderer","argsEditor","positionFn","renderFn","addMesh","removeMesh","updateArgsEditor","getHex","getPipeMaterial","shouldShowArgsEditor","getTileAtScreen","addWorldDOMElement","removeWorldDOMElement","PipesEditor","setDirN","setDirS","setDirE","setDirW","clearDirections","GeneReproducerRenderer","percentMatureElement","matured","updateScale","GeneSoilAbsorptionRenderer","GeneTransportRenderer","arrow","lastDir","updateArrow","updateArrowPosition","arrowMoveAnimation","arrowDir","ArrowHelper","arrowSetAnimation","len","easeExpOut","vibrationAmount","easeCubicOut","TransportEditor","wantedDirection","latestMovements","setLatestMovements","addEvent","movementX","movementY","movement","totalMovement","nearestAngle90","useWantedDirection","buttons","InstancedTileRenderer","batchMesh","originalColor","cellEffectsRenderer","geneRenderer","temperatureColor","TEMPERATURE_COLORS","currentLerp","getBatchInstance","materialInfo","WHITE","inventoryPoints","createGeneRendererFor","Proxy","v0","method","apply","getMaterialInfo","materialInfoMapping","inst","t1Pos","commitCenter","commitTexturePosition","commitColor","commitTemperature","commitScale","updateColor","updateInventory","maybeUpdateCellEffectsRenderer","ONE","lightAmount","colorIndex","co2","AIR_COLORSCALE","startColorIndex","startColor","endColor","amountBlack","BLACK","lerpColorTemperature","tColor","targetLerp","hover","ease","easeCubic","freeze","materials","siltColor","TileBatcher","prop","referenceGeometry","InstancedBufferGeometry","newTileBatcherGeometry","maxTiles","centers","attr","colors","scales","texturePositions","temperatures","instances","RawShaderMaterial","spriteSheet","updateMatrixWorld","InstancedBufferAttribute","dim","isInteger","BatchInstance","checkout","batcher","owner","numInUse","setXY","WorldRenderer","tileBatcher","eventLogRenderer","deleteDeadEntityRenderers","createSelector","stats","deletedEntities","created","createRendererFor","getOrCreateRenderer","VignetteCapturer","pxPerTile","captureInterval","lastCaptureTime","renderTarget","rtBuffer","rtCanvas","picturesqueCells","getBounds","minBounds","maxBounds","Scene","picturesqueRenderers","cameraEncompassingBounds","setRenderTarget","render","readRenderTargetPixels","imageData","createImageData","imageBuffer","putImageData","boundsWidth","boundsHeight","maxDimension","roiWidth","roiHeight","roiTopLeft","dest","subScalar","addScalar","largerDim","OrthographicCamera","WebGLRenderTarget","Uint8Array","getDecidedGameResult","matureEarners","shouldWin","ACTION_CONTINUOUS_KEYMAP","ACTION_INSTANT_KEYMAP","MOVEMENT_KEYS","PlayerControlScheme","isPaused","pausedInspectedTile","inspectedCell","leftClick","rightClick","setAction","toolBar","keyDown","_ms","moveAction","keysToMovement","mouse","leftClickHold","PlayerSeedControlScheme","popOut","handleLeftClick","highlightedPosition","clickedPos","ToolBar","tools","KeyQ","TOOL_INTERACT","currentKey","validCellTypes","digitKey","DIGIT_KEYS","makeToolToBuildCellType","currentTool","nextConfiguration","setKey","shouldCapture","rotateArgDirection","WorldDOMElement","posOrTile","worldToScreen","worldTopLeft","worldBottomRight","pixelTopLeft","pixelBottomRight","WorldDOMComponent","Animate","rafid","animate","Component","SceneObject","BUILD_BLUEPRINT","BuildBlueprint","mat","POINT_HIGHLIGHT","PointHighlight","TILE_HIGHLIGHT","edgesGeometry","lineSegments","TileHighlight","findBuildCandidateTiles","predicate","candidates","Hover","isTakingLongAction","maybeRenderBuildBlueprint","maybeRenderTileHighlight","maybeRenderTutorialBuildHighlights","leftClickType","isBuildValid","valid","isFirstPlaythrough","buildCandidateHighlights","candidate","HotkeyButton","hotkey","restProps","getElementsByTagName","focus","ensureCanvasFocus","InventoryBar","colored","capacityBasedWidth","sugarPercent","emptyPercent","waterStyles","sugarStyles","emptyStyles","textElements","barStyles","COLOR_FOR_TEMPERATURE","TemperatureGauge","temperatureScaleElements","tempBarLow","tempBarMid","midAngle","borderRight","tempAngle","formatSeconds","seconds","fractionDigits","TileDetails","tileInfo","cellInfo","growingCellInfo","airInfo","soilInfo","fountainInfo","interactInfo","leftClickEl","living","secondsRemaining","secondsRemainingEl","energyEl","cellEffects","geneInfos","soilAbsorptionInfo","photosynthesisInfo","reproducerInfo","osmosisInfo","descriptors","join","CellInspector","onMouseUpCapture","stopPropagation","GameMenu","handleOverlayClose","handleGameMenuToggleClick","toggleMenu","handleAbandonPlant","onWinLoss","menuPanel","canEscapeKeyClose","canOutsideClickClose","backdropClassName","defaultSelectedTabId","title","panel","InvalidActionMessage","PausedTileDetailsPopover","usePortal","autoFocus","minimal","temperatureTooltipContentMap","timeTooltipContent","SeasonsTracker","temperatureName","temperatureTooltipContent","temperatureElement","Date","toISOString","ToolBarUI","bar","selected","tool","ToolBarItem","itemIcon","ToolBuildIcon","argsChildren","TransportDirArrow","Tutorial","activeIndex","setActiveIndex","handleDone","tutorialSteps","Step","isFirst","useCountActionTarget","count","setCount","useCountActions","setPercentDone","setSugarMade","TutorialStepContainer","percentDoneRaw","percentDone","isDone","first","done","HUD","traitsPanelOpen","genomeViewerOpen","handleCellInspectorDone","isMaxedEl","showPlayerHUD","maybeRenderMenu","maybeRenderSpeciesViewer","maybeRenderCollectButton","maybeRenderWinShine","maybeRenderGerminateButton","maybeRenderPausedUI","maybeRenderInvalidAction","maybeRenderTutorial","hidden","maybeRenderCellInspector","popOutFn","mouseInstructions","popover","PlantStats","lastTime","lastTotalEnergy","numSugar","numCells","totalWaterAbsorbed","soilAbsorb","energyUsePerSecond","sugarUsePerSeason","timeUntilStarvation","averageWaterPerSeason","averageSugarPerSeason","margin","Debug","doWin","doLose","plusWater","plusSugar","bottom","background","display","OvalNode","uv","UVNode","builder","output","include","ovalOutFn","getType","TempNode","FunctionNode","trim","Mito","_inspectedCell","vignetteCapturer","hackCamera","orbitControls","suggestedCamera","userZoom","_controls","nodeFrame","Nodes","nodePost","ovalOutTime","Stats","currZoom","newZoom","handleBeforeUnload","handleContextMenu","PLAYER_TETHER_DISTANCE","worldDomElements","autoClear","noiseNode","MIN","environmentFromLevelInfo","lookAt","OrbitControls","updateAmbientAudio","attachWindowEvents","onbeforeunload","worldDomElementComponents","yPos","drumVolume","stringsVolume","gameResult","anyCellsAlive","maybeGetGameResult","cursorWorld","getWorldCoordinates","clampLength","cursorCameraNorm","getCameraNormCoordinates","unproject","getPlayerInfluenceVector","computeHighlightedPosition","screen","project","worldDomElement","element","millisDelta","end","begin","getAction","worldStep","defaultCameraState","computeHighlightedTile","updateHover","isTimeForNewCapture","capture","easeSinIn","clearDepth","yes","no","traverse","perfDebugThreeObjects","memory","geometries","textures","programs","calls","points","triangles","mouseNorm","cameraTarget","targetState","updateProjectionMatrix","h","aspect","setSize","WindowFPS","dom","removeChild","SketchSuccessComponent","frameId","lastTimestamp","handleVolumeButtonClick","volumeEnabled","localStorage","timestamp","millisElapsed","sketch","syncAudioContext","handleWindowResize","updateRendererCanvasToMatchParent","resize","handleVisibilityChange","visibilityState","hasFocus","shouldPlayAudio","resume","suspend","eventsOnBody","sketchElementsWithKey","idx","renderVolumeButton","dispose","parentElement","clientWidth","clientHeight","SketchComponent","userVolume","handleContainerRef","Howler","setContext","masterGain","preserveDrawingBuffer","antialias","checkShaderErrors","otherArgs","containerProps","errorElement","classnames","renderSketchOrStatus","renderDefaultErrorElement","MitoScreen","handleDivRef","exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","StartScreen","onStart","listenForEnter","rel","href","AppComponent","handleMousePosition","mousePosition","handleWinLoss","handleResultsDone","handleCloseStartScreen","showStartScreen","otherArgsSelector","appContent","AppError","AppScreen","show","appStateJson","errorRef","errorReport","stack","select","execCommand","readOnly","CSSTransition","in","timeout","mountOnEnter","unmountOnExit","App","runTests","suite","countAir","countSoil","countRock","countFountain","startAdjacentWaters","adjacentTiles","countWaters","names","plotHistogram","layout","TestStats","Page404","createModelSchema","Boolean","hostname","match","ReactDOM","path","exact","component","navigator","serviceWorker","ready","registration","unregister"],"mappings":"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AAY,yBAAhD/gB,IAA+C,KAA7BK,IAA6B,KAAX0gB,I,iDAElD/gB,EAAWK,GACd,OAAO2B,KAAKhC,EAAIA,EAAIgC,KAAK3B,EAAIA,I,2BAG1BL,EAAWK,EAAW0gB,GACzB,OAAO/e,KAAKhC,EAAIA,EAAIgC,KAAK3B,EAAIA,EAAI2B,KAAK+e,EAAIA,M,KAIxCC,EAAQ,CACZ,IAAIF,EAAK,EAAG,EAAG,GACf,IAAIA,GAAM,EAAG,EAAG,GAChB,IAAIA,EAAK,GAAI,EAAG,GAChB,IAAIA,GAAM,GAAI,EAAG,GACjB,IAAIA,EAAK,EAAG,EAAG,GACf,IAAIA,GAAM,EAAG,EAAG,GAChB,IAAIA,EAAK,EAAG,GAAI,GAChB,IAAIA,GAAM,EAAG,GAAI,GACjB,IAAIA,EAAK,EAAG,EAAG,GACf,IAAIA,EAAK,GAAI,EAAG,GAChB,IAAIA,EAAK,EAAG,GAAI,GAChB,IAAIA,EAAK,GAAI,GAAI,IAGbG,EAAI,CACR,IACA,IACA,IACA,GACA,GACA,GACA,IACA,GACA,IACA,GACA,GACA,GACA,IACA,IACA,EACA,IACA,IACA,GACA,IACA,GACA,GACA,IACA,EACA,GACA,GACA,IACA,GACA,GACA,GACA,IACA,EACA,IACA,IACA,IACA,IACA,GACA,EACA,GACA,IACA,GACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,IACA,IACA,GACA,GACA,IACA,GACA,IACA,IACA,IACA,IACA,GACA,IACA,GACA,IACA,GACA,IACA,IACA,GACA,GACA,IACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,EACA,IACA,GACA,GACA,IACA,GACA,IACA,IACA,IACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,EACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,EACA,IACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,IACA,IACA,IACA,GACA,IACA,GACA,GACA,GACA,GACA,IACA,IACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,EACA,GACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,EACA,IACA,GACA,GACA,IACA,GACA,GACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,GACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,IACA,EACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,IACA,GACA,IACA,KAUIC,EAAK,IAAO9hB,KAAK0b,KAAK,GAAK,GAC3BqG,GAAM,EAAI/hB,KAAK0b,KAAK,IAAM,EAG1BsG,EAAK,EAAI,EAEFC,EAAb,WAuCE,aAAwD,IAA5ClE,EAA2C,uDAAZ,WAAhB/d,KAAKC,SAAuB,yBArChDiiB,KAAO,IAAIpN,MAAM,KAqC+B,KAnChDqN,MAAQ,IAAIrN,MAAM,KAmC8B,KAjChDsN,UAAY,EAiCoC,KA/BhDC,cAAgB,GA+BgC,KA5BhDC,cAAgB,CAAe,EAAdtiB,KAAKuiB,IAAI,GAAuB,GAAdviB,KAAKwiB,IAAI,GAAsB,EAAdxiB,KAAKwiB,IAAI,GAAsB,EAAdxiB,KAAKuiB,IAAI,IA6BnF3f,KAAKmb,KAAKA,GAxCd,iDAecA,GACNA,EAAO,GAAKA,EAAO,IAErBA,GAAQ,QAGVA,EAAO/d,KAAKK,MAAM0d,IACP,MACTA,GAAQA,GAAQ,GAGlB,IAAK,IAAIjC,EAAI,EAAGA,EAAI,IAAKA,IAAK,CAC5B,IAAIhb,OAAC,EAEHA,EADM,EAAJ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","file":"static/js/main.0e251d5b.chunk.js","sourcesContent":["import * as THREE from \"three\";\r\n\r\n/**\r\n * Return a Vector2 that's uniformly randomly chosen from the perimeter\r\n * of the rectangle given by min and max.\r\n */\r\nexport function randomRectPerimeter(min: THREE.Vector2, max: THREE.Vector2): THREE.Vector2 {\r\n  const width = max.x - min.x;\r\n  const height = max.y - min.y;\r\n  let x: number;\r\n  let y: number;\r\n  if (Math.random() * (width + height) < width) {\r\n    // we've chosen the top or bottom line\r\n    x = randFloat(min.x, max.x);\r\n    y = Math.random() < 0.5 ? min.y : max.y;\r\n  } else {\r\n    // we've chosen the left or right line\r\n    x = Math.random() < 0.5 ? min.x : max.x;\r\n    y = randFloat(min.y, max.y);\r\n  }\r\n  return new THREE.Vector2(x, y);\r\n}\r\n\r\nexport function randFloat(min: number, max: number) {\r\n  return Math.random() * (max - min) + min;\r\n}\r\n\r\nexport function randInt(inclusiveMin: number, inclusiveMax: number) {\r\n  return Math.floor(randFloat(inclusiveMin, inclusiveMax + 1));\r\n}\r\n\r\nexport function randElement<T>(arr: T[]) {\r\n  return arr[randInt(0, arr.length - 1)];\r\n}\r\n","import { Vector2 } from \"three\";\r\n\r\nexport * from \"./random\";\r\n\r\nexport function lerp(a: number, b: number, x: number) {\r\n  return a + (b - a) * x;\r\n}\r\n\r\nexport function lerp2(v: { x: number; y: number }, t: { x: number; y: number }, l: number) {\r\n  v.x = v.x * (1 - l) + t.x * l;\r\n  v.y = v.y * (1 - l) + t.y * l;\r\n}\r\n\r\nexport function map(x: number, xStart: number, xStop: number, yStart: number, yStop: number) {\r\n  return lerp(yStart, yStop, (x - xStart) / (xStop - xStart));\r\n}\r\n\r\nexport function clamp(x: number, min: number, max: number) {\r\n  return x < min ? min : x > max ? max : x;\r\n}\r\n\r\nexport function sampleArray<T>(a: T[]) {\r\n  return a[Math.floor(Math.random() * a.length)];\r\n}\r\n\r\nexport function triangleWaveApprox(t: number) {\r\n  return (8 / (Math.PI * Math.PI)) * (Math.sin(t) - (1 / 9) * Math.sin(3 * t) + (1 / 25) * Math.sin(5 * t));\r\n}\r\n\r\n/**\r\n * Get a random integer between floor(x) and ceil(x) such that, over many iterations,\r\n * randRound(x) gives an average of x.\r\n */\r\nexport function randRound(x: number) {\r\n  const ix = Math.floor(x);\r\n  const fx = x - ix;\r\n  return ix + (Math.random() < fx ? 1 : 0);\r\n}\r\n\r\n// mod account for negatives\r\nexport function mod(t: number, m: number) {\r\n  return ((t % m) + m) % m;\r\n}\r\n\r\n// perfect triangle wave that goes from [0, 1, 0] in x = [0, 1, 2]\r\nexport function mirroredRepeat(x: number) {\r\n  return (1 - (Math.abs(mod(x * 2, 4) - 2) - 1)) / 2;\r\n}\r\n\r\n// goes [0, 1] every integer\r\nexport function sawTooth(x: number) {\r\n  return mod(x, 1);\r\n}\r\n\r\nexport function logistic(x: number) {\r\n  if (x < -6) {\r\n    return 0;\r\n  } else if (x > 6) {\r\n    return 1;\r\n  }\r\n  return 1 / (1 + Math.exp(-x));\r\n}\r\n\r\nexport function roundToNearest(x: number, to: number) {\r\n  return Math.round(x / to) * to;\r\n}\r\n\r\nexport function toVector2(v: { x: number; y: number }) {\r\n  return new Vector2(v.x, v.y);\r\n}\r\n","import { Vector2 } from \"three\";\r\nimport { World } from \"../world/world\";\r\nimport { Silt } from \"./soil\";\r\nexport class Fountain extends Silt {\r\n  displayName = \"Fountain\";\r\n\r\n  isObstacle = true;\r\n\r\n  public cooldown = 0;\r\n\r\n  constructor(pos: Vector2, world: World, public secondsPerWater: number, public waterRemaining: number) {\r\n    super(pos, world);\r\n  }\r\n\r\n  shouldStep(dt: number) {\r\n    return dt > 0.1;\r\n  }\r\n\r\n  step(dt: number) {\r\n    super.step(dt);\r\n    if (this.cooldown > 0) {\r\n      this.cooldown -= dt;\r\n    }\r\n    if (this.inventory.space() > 1 && this.cooldown <= 0 && this.waterRemaining > 0) {\r\n      // just constantly give yourself water\r\n      this.inventory.add(1, 0);\r\n      this.waterRemaining -= 1;\r\n      if (this.waterRemaining > 0) {\r\n        this.cooldown = this.secondsPerWater;\r\n      } else {\r\n        const silt = new Silt(this.pos.clone(), this.world);\r\n        this.inventory.give(silt.inventory, this.inventory.water, this.inventory.sugar);\r\n\r\n        // replace self with a silt\r\n        this.world.maybeRemoveCellAt(this.pos);\r\n        this.world.setTileAt(this.pos, silt);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Inventory } from \"../inventory\";\r\nimport { Tile } from \"./tile\";\r\nexport class Rock extends Tile {\r\n  displayName = \"Rock\";\r\n\r\n  isObstacle = true;\r\n\r\n  isStructuralSupport = true;\r\n\r\n  inventory = new Inventory(0, this);\r\n\r\n  get darknessContrib() {\r\n    return 1;\r\n  }\r\n\r\n  shouldStep(dt: number) {\r\n    return dt > 0.3;\r\n  }\r\n}\r\n","import { Cell } from \"../cell/cell\";\r\nimport { GrowingCell } from \"../cell/growingCell\";\r\nimport { Air } from \"./air\";\r\nimport { DeadCell } from \"./deadCell\";\r\nimport { Fountain } from \"./fountain\";\r\nimport { Rock } from \"./rock\";\r\nimport { Soil } from \"./soil\";\r\nimport { Tile } from \"./tile\";\r\n\r\nexport { CellEffect, FreezeEffect } from \"../cell/cellEffect\";\r\nexport { Air, DeadCell, Fountain, Rock, Soil, Tile, Cell, GrowingCell };\r\n","import { Cell } from \"./cell\";\r\nimport { CellProperties } from \"./cellProperties\";\r\nimport { GeneInstance } from \"./geneInstance\";\r\nimport { RealizedGene } from \"./realizedGene\";\r\n\r\nexport class Gene<S = any, K extends string = any> {\r\n  private constructor(\r\n    public readonly blueprint: GeneBlueprint<K>,\r\n    public readonly initialStateFn: GeneInitialStateFn<S, K>,\r\n    public readonly stepFn: GeneStepFn<S, K>,\r\n    public readonly shouldStepFn: GeneShouldStepFn<S, K>\r\n  ) {}\r\n\r\n  get numLevels() {\r\n    return this.blueprint.levelCosts.length;\r\n  }\r\n\r\n  level(level: number): RealizedGene<Gene<S, K>> {\r\n    return new RealizedGene(this, level);\r\n  }\r\n\r\n  static make<S = any, K extends string = string>(\r\n    blueprint: GeneBlueprint<K>,\r\n    initialState?: GeneInitialStateFn<S, K> | S,\r\n    step?: GeneStepFn<S, K>,\r\n    shouldStep: GeneShouldStepFn<S, K> = step != null ? alwaysStep : neverStep\r\n  ) {\r\n    const initialStateFn =\r\n      typeof initialState === \"function\"\r\n        ? (initialState as GeneInitialStateFn<S, K>)\r\n        : () => ({ ...(initialState ?? ({} as S)) });\r\n    const gene = new Gene<S, K>(blueprint, initialStateFn, step ?? (stepNoOP as GeneStepFn<S, K>), shouldStep);\r\n    const { name } = gene.blueprint;\r\n    const exists = AllGenesByName.has(name);\r\n    if (exists) {\r\n      console.error(\"A gene named\", name, \"already exists!\");\r\n    }\r\n    AllGenesByName.set(gene.blueprint.name, (gene as unknown) as Gene);\r\n    return gene;\r\n  }\r\n}\r\n\r\nexport const AllGenesByName: Map<string, Gene> = new Map();\r\n\r\nexport type RealizedProps<K extends string> = Record<K, number>;\r\n\r\nexport type PropBlueprint<K extends string> = Record<K, number | number[]>;\r\n\r\nexport interface GeneBlueprint<K extends string> {\r\n  name: string;\r\n  description: (props: RealizedProps<K>, sProps: Partial<CellProperties>) => React.ReactNode;\r\n  levelCosts: number[];\r\n  levelProps: PropBlueprint<K>;\r\n  static?: CellPropertiesBlueprint;\r\n  /**\r\n   * Dynamic properties get computed at the start of each cell's step.\r\n   */\r\n  dynamic?(cell: Cell, properties: CellProperties): CellProperties;\r\n  requirements?: Gene[];\r\n}\r\n\r\nexport type CellPropertiesBlueprint = {\r\n  [K in keyof CellProperties]?: CellProperties[K] | Array<CellProperties[K]>;\r\n};\r\n\r\n// export type GeneInitialStateFn<S, K extends string> = (instance: GeneInstance<Gene<S, K>>) => S;\r\nexport type GeneInitialStateFn<S, K extends string> = (gene: Gene<S, K>, props: RealizedProps<K>, cell: Cell) => S;\r\n\r\nexport type GeneStepFn<S, K extends string> = (dt: number, instance: GeneInstance<Gene<S, K>>) => S | void;\r\n\r\nexport type GeneShouldStepFn<S, K extends string> = (dt: number, instance: GeneInstance<Gene<S, K>>) => boolean;\r\n\r\nconst stepNoOP: GeneStepFn<any, any> = () => {};\r\n\r\nexport const alwaysStep: GeneShouldStepFn<any, any> = (dt) => {\r\n  return true;\r\n};\r\n\r\nexport const neverStep: GeneShouldStepFn<any, any> = (dt) => {\r\n  return true;\r\n};\r\n","/**\r\n * In Mito, our standard units of measurement are:\r\n *\r\n * Distance - tiles.\r\n * Time - seconds.\r\n */\r\n\r\n/**\r\n * How many tiles per second the Player moves.\r\n */\r\nexport const PLAYER_BASE_SPEED = 4.2;\r\nexport const PLAYER_MAX_RESOURCES = 100;\r\nexport const PLAYER_STARTING_WATER = 25;\r\nexport const PLAYER_STARTING_SUGAR = 25;\r\n\r\nexport const PLAYER_INTERACT_EXCHANGE_SPEED = 30;\r\n/**\r\n * How fast the Player moves from standing on Transport.\r\n */\r\nexport const PLAYER_MOVED_BY_TRANSPORT_SPEED = 0.3;\r\n\r\n/**\r\n * Number of realtime seconds in a game year.\r\n */\r\nexport const TIME_PER_YEAR = 60 * 36; // 60 seconds * 36 minutes = 1800 seconds\r\nexport const TIME_PER_SEASON = TIME_PER_YEAR / 4; // 480 seconds per season (9 minutes)\r\nexport const TIME_PER_MONTH = TIME_PER_SEASON / 3; // 180 seconds per month (3 minutes)\r\nexport const TIME_PER_DAY = TIME_PER_MONTH / 3; // 60 seconds per day (1 minute)\r\n\r\n/**\r\n * The day is further split into a \"daytime\" and a \"nighttime\". Sunlight\r\n * angles from -90 to +90 over the course of the day. This percentage says\r\n * how much of a full day is filled with sun.\r\n *\r\n * We keep it daytime as much as possible because daytime is more fun; nighttime\r\n * is just a time-keeping convenience, and a way to reset the sun angle.\r\n */\r\nexport const PERCENT_DAYLIGHT = 0.9; // 45 second days, 5 second nights\r\n\r\n/**\r\n * How many seconds it takes to build a Cell.\r\n */\r\nexport const CELL_BUILD_TIME = 1.0;\r\n\r\n/**\r\n * How many tiles per frame a cell will freefall in the Air. Unscaled\r\n * by time.\r\n */\r\nexport const CELL_DROOP = 0.13;\r\n\r\n/**\r\n * In a two Cell system with one Water, this water will diffuse, on average, after this many seconds.\r\n * Divide this by 8 to get an idea of how \"fast\" a single water will move on a fully filled out Tissue plane.\r\n */\r\nexport const CELL_DIFFUSION_WATER_TIME = 16.6667;\r\n\r\n/**\r\n * See CELL_DIFFUSION_WATER_TIME explanation.\r\n */\r\nexport const CELL_DIFFUSION_SUGAR_TIME = 16.6667;\r\n\r\n/**\r\n * Max inventory capacity of Tissue, Transports, and Roots.\r\n */\r\nexport const TISSUE_INVENTORY_CAPACITY = 6;\r\n\r\n/**\r\n * On average, for each Air tile adjacent to each Leaf, water will be converted to sugar after this many seconds.\r\n */\r\nexport const LEAF_REACTION_TIME = 40;\r\n\r\nexport const SUNLIGHT_REINTRODUCTION = 0.15;\r\n\r\nexport const SUNLIGHT_DIFFUSION = 0.0;\r\n","export * from \"./GeneAiryExpansion\";\r\nexport * from \"./GeneAttractsSugar\";\r\nexport * from \"./GeneAttractsWater\";\r\nexport * from \"./GeneBark\";\r\nexport * from \"./GeneCannotFreeze\";\r\nexport * from \"./GeneCostly\";\r\nexport * from \"./GeneDiffuseSugar\";\r\nexport * from \"./GeneDiffuseWater\";\r\nexport * from \"./GeneEnergyTransfer\";\r\nexport * from \"./GeneHydrostasis\";\r\nexport * from \"./GeneInventory\";\r\nexport * from \"./GeneLiving\";\r\nexport * from \"./GeneMetabolism\";\r\nexport * from \"./GeneNetworkEffect\";\r\nexport * from \"./GeneNutrientExtraction\";\r\nexport * from \"./GeneObstacle\";\r\nexport * from \"./GeneOsmosis\";\r\nexport * from \"./GenePhotosynthesis\";\r\nexport * from \"./GenePipes\";\r\nexport * from \"./GenePushWater\";\r\nexport * from \"./GeneReproducer\";\r\nexport * from \"./GeneScaffolding\";\r\nexport * from \"./GeneSoilAbsorption\";\r\nexport * from \"./GeneTransport\";\r\nexport * from \"./GeneVascular\";\r\n","import blopSrc from \"assets/audio/Blop-Mark_DiAngelo-79054334.mp3\";\r\nimport buildSoundSrc from \"assets/audio/build.mp3\";\r\nimport buildCompleteSrc from \"assets/audio/build_complete.mp3\";\r\nimport deconstructSoundSrc from \"assets/audio/deconstruct.mp3\";\r\nimport dropWaterSrc from \"assets/audio/drop_water.mp3\";\r\nimport eatingSoundSrc from \"assets/audio/eating.mp3\";\r\nimport footstepsSrc from \"assets/audio/footsteps.wav\";\r\nimport fruitPoofSrc from \"assets/audio/fruit-popOpen.mp3\";\r\nimport impactSoftMedium003Src from \"assets/audio/impactSoft_medium_003.mp3\";\r\nimport interactSoundSrc from \"assets/audio/interact.mp3\";\r\nimport introBounceSrc from \"assets/audio/intro-bounce.mp3\";\r\nimport mitoBaseSrc from \"assets/audio/mito-base.mp3\";\r\nimport mitoDrumsSrc from \"assets/audio/mito-drums.mp3\";\r\nimport mitoOverworldMp3 from \"assets/audio/mito-overworld.mp3\";\r\nimport mitoStartScreenMp3 from \"assets/audio/mito-start.mp3\";\r\nimport mitoStringsSrc from \"assets/audio/mito-strings.mp3\";\r\nimport mitoDeathMp3 from \"assets/audio/mitodeath.mp3\";\r\nimport stickySoundSrc from \"assets/audio/sticky.mp3\";\r\nimport suckWaterSrc from \"assets/audio/suckwater.wav\";\r\nimport genePickUpSrc from \"assets/audio/switch25.wav\";\r\nimport whooshSrc from \"assets/audio/whoosh.mp3\";\r\nimport { SketchAudioContext } from \"game/screens/sketch/sketch\";\r\nimport { Howl } from \"howler\";\r\nimport * as THREE from \"three\";\r\nimport devlog from \"../common/devlog\";\r\nimport { Player } from \"../core\";\r\nimport { Tile } from \"../core/tile\";\r\n\r\nexport let mito: AudioUnit;\r\nexport let strings: AudioUnit;\r\nexport let drums: AudioUnit;\r\n\r\nexport const genePickUp = new Howl({\r\n  src: [genePickUpSrc],\r\n});\r\n\r\nexport const geneDrop = new Howl({\r\n  src: [require(\"assets/audio/switch26.wav\")],\r\n});\r\n\r\nexport const moveBumped = new Howl({\r\n  src: [require(\"assets/audio/rollover6.wav\")],\r\n});\r\n\r\nexport const mitoDeath = new Howl({\r\n  src: mitoDeathMp3,\r\n  autoplay: false,\r\n  loop: true,\r\n  volume: 1,\r\n});\r\n\r\nexport const mitoStartScreen = new Howl({\r\n  src: mitoStartScreenMp3,\r\n  autoplay: false,\r\n  loop: true,\r\n  volume: 0.3,\r\n});\r\n\r\nexport const mitoOverworld = new Howl({\r\n  src: mitoOverworldMp3,\r\n  autoplay: false,\r\n  loop: true,\r\n  volume: 0.15,\r\n});\r\n\r\nexport const footsteps = new Howl({\r\n  src: [footstepsSrc],\r\n  autoplay: true,\r\n  loop: true,\r\n  volume: 0,\r\n});\r\n\r\nexport const interactSound = new Howl({\r\n  src: [interactSoundSrc],\r\n  autoplay: true,\r\n  loop: true,\r\n  volume: 0,\r\n});\r\n\r\nexport const introBounce = new Howl({\r\n  src: introBounceSrc,\r\n  volume: 0.5,\r\n});\r\n\r\nexport const whoosh = new Howl({\r\n  src: whooshSrc,\r\n  volume: 0.2,\r\n});\r\n\r\nexport const fruitPoof = new Howl({\r\n  src: fruitPoofSrc,\r\n  volume: 0.3,\r\n});\r\n\r\nexport const build = new Howl({\r\n  src: [buildSoundSrc],\r\n  volume: 0.1,\r\n});\r\n\r\nexport const buildComplete = new Howl({\r\n  src: [buildCompleteSrc],\r\n  volume: 0.5,\r\n});\r\n\r\nexport const deconstruct = new Howl({\r\n  src: [deconstructSoundSrc],\r\n  volume: 0.5,\r\n});\r\n\r\nexport const sticky = new Howl({\r\n  src: [stickySoundSrc],\r\n});\r\n\r\nexport const dropSugar = new Howl({\r\n  src: [impactSoftMedium003Src],\r\n  volume: 0.5,\r\n});\r\n\r\nexport const dropWater = new Howl({\r\n  src: [dropWaterSrc],\r\n});\r\n\r\nconst loader = new THREE.AudioLoader();\r\nfunction loadAudioPromise(src: string) {\r\n  return new Promise<AudioBuffer>((resolve, reject) => {\r\n    loader.load(\r\n      src,\r\n      (audioBuffer) => {\r\n        resolve(audioBuffer);\r\n      },\r\n      (xhr: ProgressEvent) => {\r\n        // devlog((xhr.loaded / xhr.total * 100) + '% loaded');\r\n      },\r\n      (err: any) => {\r\n        devlog(\"An error happened\");\r\n        reject(err);\r\n      }\r\n    );\r\n  });\r\n}\r\nexport const blopBuffer = loadAudioPromise(blopSrc);\r\nexport const suckWaterBuffer = loadAudioPromise(suckWaterSrc);\r\nexport const eatBuffer = loadAudioPromise(eatingSoundSrc);\r\n\r\nexport function hookUpAudio(ctx: SketchAudioContext) {\r\n  let numDone = 0;\r\n  function oneMoreLoaded() {\r\n    numDone++;\r\n    if (numDone === 3) {\r\n      mito.audio.currentTime = 0;\r\n      strings.audio.currentTime = 0;\r\n      drums.audio.currentTime = 0;\r\n      mito.gain.connect(ctx.gain);\r\n      strings.gain.connect(ctx.gain);\r\n      drums.gain.connect(ctx.gain);\r\n    }\r\n  }\r\n  mito = makeUnitFromAudioAsset(ctx, mitoBaseSrc);\r\n  mito.audio.oncanplaythrough = oneMoreLoaded;\r\n  mito.gain.gain.value = 0.25;\r\n\r\n  strings = makeUnitFromAudioAsset(ctx, mitoStringsSrc);\r\n  strings.audio.oncanplaythrough = oneMoreLoaded;\r\n  strings.gain.gain.value = 0.0;\r\n\r\n  drums = makeUnitFromAudioAsset(ctx, mitoDrumsSrc);\r\n  drums.audio.oncanplaythrough = oneMoreLoaded;\r\n  drums.gain.gain.value = 0.0;\r\n}\r\n\r\nfunction sourceElement(src: string) {\r\n  const type = src.substr(src.length - 3);\r\n  const source = document.createElement(\"source\");\r\n  source.src = src;\r\n  source.type = `audio/${type}`;\r\n  return source;\r\n}\r\n\r\nfunction makeUnitFromAudioAsset(ctx: SketchAudioContext, ...srcs: string[]): AudioUnit {\r\n  const audio = document.createElement(\"audio\");\r\n  audio.autoplay = true;\r\n  audio.loop = true;\r\n  for (const src of srcs) {\r\n    audio.appendChild(sourceElement(src));\r\n  }\r\n  // audio.appendChild(sourceElement(assetName, \"mp3\"));\r\n  // audio.appendChild(sourceElement(assetName, \"wav\"));\r\n  const source = ctx.createMediaElementSource(audio);\r\n  const gain = ctx.createGain();\r\n  source.connect(gain);\r\n  return { audio, gain };\r\n}\r\n\r\ninterface AudioUnit {\r\n  gain: GainNode;\r\n  audio: HTMLAudioElement;\r\n}\r\n\r\nexport function distScalar(source: Tile, player: Player) {\r\n  const dist = source.pos.distanceToSquared(player.pos);\r\n  const scalar = Math.min(1, 1 / (1 + dist / 25));\r\n  return scalar;\r\n}\r\n","import sugarSrc from \"assets/images/sugar.png\";\r\nimport waterSrc from \"assets/images/water.png\";\r\nimport * as React from \"react\";\r\nexport interface ResourceIconProps {\r\n  name?: \"water\" | \"sugar\" | \"w\" | \"s\";\r\n  w?: boolean;\r\n  s?: boolean;\r\n}\r\n\r\nexport const ResourceIcon: React.FC<ResourceIconProps> = React.memo(({ name, s }) => (\r\n  <img alt=\"\" src={s || name === \"sugar\" || name === \"s\" ? sugarSrc : waterSrc} className=\"resource-icon\" />\r\n));\r\n","import DynamicNumber, { DynamicNumberProps } from \"game/ui/common/DynamicNumber\";\r\nimport React from \"react\";\r\n\r\nconst GN: React.FC<DynamicNumberProps> = (props) => {\r\n  return (\r\n    <span className=\"gn\">\r\n      <DynamicNumber {...props} />\r\n    </span>\r\n  );\r\n};\r\n\r\nexport default GN;\r\n","const cache: Map<string, Intl.NumberFormat> = new Map();\r\nexport function nf(n: number, maximumSignificantDigits: number = 3, minimumSignificantDigits?: number) {\r\n  const key = `${minimumSignificantDigits},${maximumSignificantDigits}`;\r\n  if (!cache.has(key)) {\r\n    cache.set(\r\n      key,\r\n      new Intl.NumberFormat(undefined, {\r\n        maximumSignificantDigits,\r\n        minimumSignificantDigits,\r\n        useGrouping: true,\r\n      })\r\n    );\r\n  }\r\n  return cache.get(key)!.format(n);\r\n}\r\n","import { groupBy, toPairs } from \"lodash\";\r\nimport { clamp } from \"math\";\r\nimport { createSimpleSchema, list, object, serializable } from \"serializr\";\r\nimport { Vector2 } from \"three\";\r\nimport { CellArgs } from \"./cell\";\r\nimport Chromosome from \"./chromosome\";\r\nimport { MaterialInfo, MaterialInfoSchema } from \"./materialInfo\";\r\nimport { RealizedGene } from \"./realizedGene\";\r\n\r\nexport interface CellInteraction {\r\n  type: \"give\" | \"take\";\r\n  resources: \"water\" | \"sugar\" | \"water and sugar\" | \"water take sugar\" | \"sugar take water\";\r\n}\r\n\r\nconst interactSpeedMap: Record<string, InteractSpeed> = {\r\n  \"give water\": \"instant\",\r\n  \"give sugar\": \"instant\", // mostly for Tissue\r\n  \"give water and sugar\": \"continuous\", // mostly for Seed\r\n  \"give water take sugar\": \"continuous\", // mostly for Leaf\r\n  \"give sugar take water\": \"instant\",\r\n  \"take water\": \"continuous\",\r\n  \"take sugar\": \"continuous\",\r\n  \"take water and sugar\": \"continuous\", // mostly for Root\r\n};\r\n\r\nexport type InteractSpeed = \"instant\" | \"continuous\";\r\n\r\nexport function interactionSpeed(interaction: CellInteraction): InteractSpeed {\r\n  const { resources, type } = interaction;\r\n  const name = `${type} ${resources}`;\r\n  return interactSpeedMap[name] ?? \"instant\";\r\n}\r\n\r\nconst CellInteractionSchema = createSimpleSchema({\r\n  \"*\": true,\r\n});\r\n\r\nexport class CellType {\r\n  @serializable\r\n  public name: string;\r\n\r\n  @serializable\r\n  public geneSlots: number;\r\n\r\n  @serializable(object(Chromosome))\r\n  public chromosome: Chromosome;\r\n\r\n  @serializable(object(MaterialInfoSchema))\r\n  public material: MaterialInfo;\r\n\r\n  @serializable(object(CellInteractionSchema))\r\n  public interaction?: CellInteraction;\r\n\r\n  public args?: CellArgs;\r\n\r\n  // all params optional because serializr might call this with 0 args\r\n  constructor(\r\n    name?: string,\r\n    geneSlots?: number,\r\n    chromosome?: Chromosome,\r\n    material?: MaterialInfo,\r\n    interaction?: CellInteraction\r\n  ) {\r\n    this.name = name!;\r\n    this.geneSlots = geneSlots!;\r\n    this.chromosome = chromosome!;\r\n    this.material = material!;\r\n    this.interaction = interaction;\r\n    if (chromosome?.computeStaticProperties().isDirectional) {\r\n      this.args = {\r\n        direction: new Vector2(0, -1),\r\n      };\r\n    }\r\n  }\r\n\r\n  rotateArgDirection() {\r\n    const direction = this.args?.direction;\r\n    direction\r\n      ?.rotateAround(new Vector2(), -Math.PI / 4)\r\n      .setLength(1)\r\n      .round();\r\n  }\r\n\r\n  isReproducer() {\r\n    return this.chromosome.genes.some((gene) => gene.getStaticProperties().isReproductive);\r\n  }\r\n\r\n  /**\r\n   * Get all duplicate genes that are on this genome.\r\n   */\r\n  getDuplicateGenes() {\r\n    const genesByType = toPairs(groupBy(this.chromosome.genes, (rg) => rg.gene.blueprint.name));\r\n    const duplicateGenesPairs = genesByType.filter(([, genes]) => genes.length > 1);\r\n    const duplicateGenesSet = new Set(duplicateGenesPairs.flatMap(([, genes]) => genes));\r\n    return duplicateGenesSet;\r\n  }\r\n\r\n  getChanceToBecomeCancerous() {\r\n    const geneSlotsNet = this.chromosome.geneSlotsNet();\r\n    if (geneSlotsNet < 0) {\r\n      // 1.5^x * 0.0125\r\n      // 0.188%, 0.281%, 0.422%, 0.633%, 0.949%, 1.43%, 2.14%, 3.2%, 4.81%, 7.21%\r\n      return clamp(Math.pow(1.3, Math.abs(geneSlotsNet)) * 0.000225, 0, 1);\r\n    } else {\r\n      return 0;\r\n    }\r\n  }\r\n}\r\n\r\nexport default class Genome {\r\n  @serializable(list(object(CellType)))\r\n  public cellTypes: CellType[];\r\n\r\n  @serializable(list(object(RealizedGene)))\r\n  public unusedGenes: RealizedGene[];\r\n\r\n  constructor(cellTypes?: CellType[], unusedGenes?: RealizedGene[]) {\r\n    this.cellTypes = cellTypes!;\r\n    this.unusedGenes = unusedGenes ?? [];\r\n  }\r\n\r\n  /**\r\n   * All genes on this genome - genes on cells, and unused as well.\r\n   */\r\n  public getAllGenes(): RealizedGene[] {\r\n    return [...this.cellTypes.flatMap((cell) => cell.chromosome.genes), ...this.unusedGenes];\r\n  }\r\n}\r\n\r\nexport function describeCellInteraction({ resources, type }: CellInteraction) {\r\n  return `${type} ${resources}`;\r\n}\r\n","import { Vector2 } from \"three\";\r\n\r\nexport const DIRECTIONS = {\r\n  nw: new Vector2(-1, -1),\r\n  w: new Vector2(-1, 0),\r\n  sw: new Vector2(-1, +1),\r\n  n: new Vector2(0, -1),\r\n  // new Vector2( 0,  0),\r\n  s: new Vector2(0, +1),\r\n  ne: new Vector2(+1, -1),\r\n  e: new Vector2(+1, 0),\r\n  se: new Vector2(+1, +1),\r\n};\r\n\r\nexport type Directions = keyof typeof DIRECTIONS;\r\n\r\nexport const DIRECTION_NAMES = Object.keys(DIRECTIONS) as Directions[];\r\nexport const DIRECTION_VALUES: Vector2[] = DIRECTION_NAMES.map((o) => DIRECTIONS[o]);\r\n","export type TickerCallback = (time: number) => boolean | void;\r\nclass TickerClass {\r\n  private tickerId = 1;\r\n\r\n  private tickers: Record<number, TickerCallback> = {};\r\n\r\n  private _time = 0;\r\n\r\n  get now() {\r\n    return this._time;\r\n  }\r\n\r\n  tickerLoop = (time: number) => {\r\n    this._time = time;\r\n    const toDelete: number[] = [];\r\n    for (const id in this.tickers) {\r\n      const f = this.tickers[id];\r\n      const shouldDelete = f(time);\r\n      if (shouldDelete === true) {\r\n        toDelete.push(Number(id));\r\n      }\r\n    }\r\n    for (const id of toDelete) {\r\n      this.removeAnimation(id);\r\n    }\r\n    requestAnimationFrame(this.tickerLoop);\r\n  };\r\n\r\n  /**\r\n   * Return true to kill the ticker.\r\n   */\r\n  public addAnimation(fn: TickerCallback) {\r\n    const id = this.tickerId++;\r\n    this.tickers[id] = fn;\r\n    return id;\r\n  }\r\n\r\n  public removeAnimation(id: number) {\r\n    return delete this.tickers[id];\r\n  }\r\n\r\n  public start() {\r\n    requestAnimationFrame(this.tickerLoop);\r\n  }\r\n}\r\n\r\nconst Ticker = new TickerClass();\r\nTicker.start();\r\n\r\nexport default Ticker;\r\n","export * from \"../tile/deadCell\";\r\nexport * from \"./cell\";\r\nexport * from \"./cellEffect\";\r\nexport * from \"./cellProperties\";\r\nexport * from \"./chromosome\";\r\nexport * from \"./gene\";\r\nexport * from \"./geneInstance\";\r\nexport * from \"./genome\";\r\nexport * from \"./growingCell\";\r\nexport * from \"./materialInfo\";\r\nexport * from \"./realizedGene\";\r\n","import { lerp } from \"math\";\r\n\r\nexport enum Temperature {\r\n  Scorching = \"Scorching\",\r\n  Hot = \"Hot\",\r\n  Mild = \"Mild\",\r\n  Cold = \"Cold\",\r\n  Freezing = \"Freezing\",\r\n}\r\n\r\nexport function temperatureFor(t: number) {\r\n  if (t <= 0) {\r\n    return Temperature.Freezing;\r\n  } else if (t <= 32) {\r\n    return Temperature.Cold;\r\n  } else if (t <= 64) {\r\n    return Temperature.Mild;\r\n  } else if (t <= 96) {\r\n    return Temperature.Hot;\r\n  } else {\r\n    return Temperature.Scorching;\r\n  }\r\n}\r\n\r\nexport function nextTemperature(currentTemperature: number, neighborTemperatures: number[], dt: number): number {\r\n  let averageTemperature = currentTemperature;\r\n  for (const temp of neighborTemperatures) {\r\n    averageTemperature += temp;\r\n  }\r\n  averageTemperature /= neighborTemperatures.length + 1;\r\n  // TODO maybe use proper dt-scaling lerp\r\n  return lerp(currentTemperature, averageTemperature, dt / 12);\r\n}\r\n","import { Player } from \"core\";\r\nimport { Inventory } from \"core/inventory\";\r\nimport { Action } from \"core/player/action\";\r\nimport { params } from \"game/params\";\r\nimport { Vector2 } from \"three\";\r\nimport { CELL_DROOP } from \"../constants\";\r\nimport { DIRECTIONS } from \"../directions\";\r\nimport { step } from \"../entity\";\r\nimport { Interactable, isInteractable } from \"../interactable\";\r\nimport { nextTemperature } from \"../temperature\";\r\nimport { DeadCell } from \"../tile/deadCell\";\r\nimport { Tile } from \"../tile/tile\";\r\nimport { World } from \"../world/world\";\r\nimport { CancerEffect, CellEffect, CellEffectConstructor, FreezeEffect } from \"./cellEffect\";\r\nimport { CellProperties } from \"./cellProperties\";\r\nimport Chromosome from \"./chromosome\";\r\nimport { Gene } from \"./gene\";\r\nimport { GeneInstance } from \"./geneInstance\";\r\nimport { CellType, interactionSpeed } from \"./genome\";\r\n\r\nexport interface CellArgs {\r\n  direction?: Vector2;\r\n}\r\n\r\nexport class Cell extends Tile implements Interactable {\r\n  get displayName() {\r\n    return this.type.name;\r\n  }\r\n\r\n  set displayName(n: string) {}\r\n\r\n  public energy = 1;\r\n\r\n  public darkness = 0;\r\n\r\n  public nextTemperature: number;\r\n\r\n  // offset [-0.5, 0.5] means you're still \"inside\" this cell, going out of it will break you\r\n  // public offset = new Vector2();\r\n  public droopY = 0;\r\n\r\n  public effects: CellEffect[] = [];\r\n\r\n  public chromosome: Chromosome;\r\n\r\n  public geneInstances: GeneInstance<Gene<any, string>>[];\r\n\r\n  public inventory: Inventory;\r\n\r\n  public readonly staticProperties: CellProperties;\r\n\r\n  /**\r\n   * Should compute at the start of every step.\r\n   */\r\n  private properties: CellProperties;\r\n\r\n  get isObstacle() {\r\n    return this.properties.isObstacle;\r\n  }\r\n\r\n  get isReproductive() {\r\n    return this.properties.isReproductive;\r\n  }\r\n\r\n  get diffusionWater() {\r\n    return this.properties.diffusionWater;\r\n  }\r\n\r\n  get diffusionSugar() {\r\n    return this.properties.diffusionSugar;\r\n  }\r\n\r\n  get timeToBuild() {\r\n    return this.properties.timeToBuild;\r\n  }\r\n\r\n  get tempo() {\r\n    return this.properties.tempo * this.temperatureTempo;\r\n  }\r\n\r\n  get energyUpkeep() {\r\n    return this.properties.energyUpkeep;\r\n  }\r\n\r\n  get darknessContrib() {\r\n    return 0;\r\n  }\r\n\r\n  public args: CellArgs = {\r\n    direction: new Vector2(0, -1),\r\n  };\r\n\r\n  constructor(pos: Vector2, world: World, public type: CellType, args?: CellArgs) {\r\n    super(pos, world);\r\n    this.chromosome = type.chromosome;\r\n    this.staticProperties = this.chromosome.computeStaticProperties();\r\n    const { inventoryCapacity } = this.staticProperties;\r\n    this.inventory = new Inventory(inventoryCapacity, this);\r\n    if (args?.direction) {\r\n      this.args.direction!.copy(args?.direction);\r\n    }\r\n    this.temperatureFloat = 48;\r\n    this.nextTemperature = this.temperatureFloat;\r\n\r\n    // careful - ordering matters here (e.g. this.inventory shouldn't be null)\r\n    this.properties = this.computeDynamicProperties();\r\n\r\n    this.geneInstances = this.chromosome.newGeneInstances(this);\r\n  }\r\n\r\n  /**\r\n   * Temperature speed multiplier.\r\n   */\r\n  protected get temperatureTempo() {\r\n    if (this.temperatureFloat <= 0) {\r\n      // 50% slower - 1 / 2;\r\n      return 1 / 2;\r\n    } else if (this.temperatureFloat <= 32) {\r\n      // 33% slower - 2 / (2 / 3) = 3\r\n      return 2 / 3;\r\n    } else if (this.temperatureFloat <= 64) {\r\n      return 1;\r\n    } else if (this.temperatureFloat <= 96) {\r\n      // 25% faster\r\n      return 1.25;\r\n    } else {\r\n      // 50% faster\r\n      return 1.5;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Be careful, this can be expensive! This is cached by dynamicProperties.\r\n   */\r\n  private computeDynamicProperties() {\r\n    let properties = { ...this.staticProperties };\r\n    for (const g of this.chromosome.genes) {\r\n      properties = g.getDynamicProperties(this, properties) ?? properties;\r\n    }\r\n    return properties;\r\n  }\r\n\r\n  /**\r\n   * All cells can pull from each other.\r\n   */\r\n  canPullResources(giver: Tile) {\r\n    return giver instanceof Cell;\r\n  }\r\n\r\n  public getMovespeedMultiplier() {\r\n    return this.temperatureTempo;\r\n  }\r\n\r\n  addEffect(effect: CellEffect) {\r\n    const stacks = (effect.constructor as CellEffectConstructor).stacks;\r\n    if (!stacks) {\r\n      // exit early if we found another one and we don't stack\r\n      if (this.findEffectOfType(effect.constructor as CellEffectConstructor) != null) {\r\n        return;\r\n      }\r\n    }\r\n    if (this.properties.cantFreeze && effect instanceof FreezeEffect) {\r\n      return;\r\n    }\r\n    effect.attachTo(this);\r\n    this.effects.push(effect);\r\n  }\r\n\r\n  findEffectOfType(type: CellEffectConstructor) {\r\n    return this.effects.find((e) => e.constructor === type);\r\n  }\r\n\r\n  interact(source: Player) {\r\n    for (const e of this.effects) {\r\n      if (isInteractable(e)) {\r\n        const action = e.interact(source);\r\n        if (action != null) {\r\n          return action;\r\n        }\r\n      }\r\n    }\r\n    // Cell interaction\r\n    const { interaction } = this.type;\r\n    if (interaction != null) {\r\n      const [water, sugar] = (() => {\r\n        switch (interaction.resources) {\r\n          case \"water\":\r\n            return [1, 0];\r\n          case \"sugar\":\r\n            return [0, 1];\r\n          case \"water and sugar\":\r\n            return [1, 1];\r\n          case \"sugar take water\":\r\n            return [-1, 1];\r\n          case \"water take sugar\":\r\n            return [1, -1];\r\n        }\r\n      })();\r\n      const action: Action = {\r\n        type: interaction.type === \"give\" ? \"drop\" : \"pickup\",\r\n        water,\r\n        sugar,\r\n        target: this,\r\n        continuous: interactionSpeed(interaction) === \"continuous\",\r\n      };\r\n      return action;\r\n    }\r\n  }\r\n\r\n  public isDead = false;\r\n\r\n  die() {\r\n    this.world.setTileAt(this.pos, new DeadCell(this.pos, this.world));\r\n  }\r\n\r\n  shouldStep(dt: number) {\r\n    return dt > 0.1;\r\n  }\r\n\r\n  findGene<G extends Gene>(gene: G): GeneInstance<G> | undefined {\r\n    return this.geneInstances.find((g) => g.isType(gene)) as GeneInstance<G>;\r\n  }\r\n\r\n  step(dt: number) {\r\n    if (params.debug) {\r\n      this.validateDirection();\r\n    }\r\n    this.properties = this.computeDynamicProperties();\r\n\r\n    // diffusion, darkness, gravity\r\n    super.step(dt);\r\n    this.stepDroop(dt);\r\n\r\n    // cell effects and genes scale according to tempo\r\n    dt = this.tempo * dt;\r\n    this.stepCancer(dt);\r\n    this.stepCellEffects(dt);\r\n    this.stepGeneInstances(dt);\r\n    this.stepEnergyUpkeep(dt);\r\n  }\r\n\r\n  private stepEnergyUpkeep(dt: number) {\r\n    this.energy -= this.energyUpkeep * dt;\r\n    if (this.energy <= 0) {\r\n      this.die();\r\n    }\r\n  }\r\n\r\n  private stepGeneInstances(dt: number) {\r\n    this.geneInstances.forEach((g) => step(g, dt));\r\n  }\r\n\r\n  private stepCellEffects(dt: number) {\r\n    // step all cell effects (e.g.freezing)\r\n    for (const effect of this.effects) {\r\n      effect.step(dt);\r\n    }\r\n  }\r\n\r\n  private stepCancer(dt: number) {\r\n    if (Math.random() < this.type.getChanceToBecomeCancerous() * dt) {\r\n      this.addEffect(new CancerEffect());\r\n    }\r\n  }\r\n\r\n  stepTemperature(dt: number) {\r\n    const neighbors = this.world.tileNeighbors(this.pos);\r\n    const neighborTemperatures = Array.from(neighbors.values()).map((t) => t.temperatureFloat);\r\n    this.nextTemperature = nextTemperature(this.temperatureFloat, neighborTemperatures, dt);\r\n    if (this.temperatureFloat <= 0) {\r\n      const chanceToFreeze = 0.01667 * dt; // on average, this cell freezes every day\r\n      if (Math.random() < chanceToFreeze) {\r\n        this.addEffect(new FreezeEffect());\r\n      }\r\n    } else if (this.temperatureFloat > 96) {\r\n      const waterToLose = Math.min(this.inventory.water, 1);\r\n      const chanceEvaporate = waterToLose * 0.01667; // no average, lose 1 water per day\r\n      if (Math.random() < chanceEvaporate * dt) {\r\n        this.inventory.add(-waterToLose, 0);\r\n        this.world.logEvent({\r\n          type: \"evaporation\",\r\n          tile: this,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  stepDroop(dt: number) {\r\n    const tileNeighbors = this.world.tileNeighbors(this.pos);\r\n    const below = tileNeighbors.get(DIRECTIONS.s)!;\r\n    const belowLeft = tileNeighbors.get(DIRECTIONS.sw)!;\r\n    const belowRight = tileNeighbors.get(DIRECTIONS.se)!;\r\n    const left = tileNeighbors.get(DIRECTIONS.w)!;\r\n    const right = tileNeighbors.get(DIRECTIONS.e)!;\r\n    const above = tileNeighbors.get(DIRECTIONS.n)!;\r\n    const aboveLeft = tileNeighbors.get(DIRECTIONS.nw)!;\r\n    const aboveRight = tileNeighbors.get(DIRECTIONS.ne)!;\r\n    const droopAmount = CELL_DROOP;\r\n    this.droopY += droopAmount;\r\n    for (const tile of [below, belowLeft, belowRight]) {\r\n      if (tile.isStructuralSupport) {\r\n        this.droopY = Math.min(this.droopY, 0);\r\n        return;\r\n      } else if (tile instanceof Cell) {\r\n        this.droopY = Math.min(this.droopY, tile.droopY);\r\n        return;\r\n      }\r\n    }\r\n    const springNeighborCells = [aboveLeft, above, aboveRight, left, right, this].filter(\r\n      (n) => n instanceof Cell\r\n    ) as Cell[];\r\n    // TODO tighten springs scaled by dt\r\n    this.droopY = springNeighborCells.reduce((sum, n) => sum + n.droopY, 0) / springNeighborCells.length;\r\n\r\n    this.stepDroopPositionUpdate();\r\n  }\r\n\r\n  private stepDroopPositionUpdate() {\r\n    if (this.droopY > 0.5) {\r\n      if (this.pos.y < this.world.height - 1) {\r\n        // make the player ride the train!\r\n        if (this.world.player.pos.equals(this.pos)) {\r\n          this.world.player.posFloat.y += 1;\r\n        }\r\n        this.world.maybeRemoveCellAt(this.pos);\r\n        this.pos.y += 1;\r\n        this.droopY -= 1;\r\n        this.world.setTileAt(this.pos, this);\r\n      } else {\r\n        this.droopY = 0.5;\r\n      }\r\n    }\r\n  }\r\n\r\n  stepDarkness(neighbors: Map<Vector2, Tile>) {\r\n    return 0;\r\n  }\r\n\r\n  public validateDirection() {\r\n    const isDirectional = this.properties.isDirectional;\r\n    if (isDirectional) {\r\n      const dir = this.args.direction!;\r\n      if (isFractional(dir.x) || isFractional(dir.y)) {\r\n        debugger;\r\n        console.error(\"build transport with fractional dir \" + dir.x + \", \" + dir.y);\r\n      }\r\n      if (dir.manhattanLength() < 1 || dir.manhattanLength() > 3) {\r\n        debugger;\r\n        console.error(\"bad dir length\", dir);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction isFractional(x: number) {\r\n  return x % 1 !== 0;\r\n}\r\n","import { ResourceIcon, ResourceIconProps } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\n\r\nconst RI: React.FC<ResourceIconProps> = (props) => {\r\n  return (\r\n    <span className=\"ri\">\r\n      <ResourceIcon {...props} />\r\n    </span>\r\n  );\r\n};\r\n\r\nexport default RI;\r\n","import { list, object, serializable } from \"serializr\";\r\nimport { Cell } from \"../tile\";\r\nimport { defaultCellProperties } from \"./cellProperties\";\r\nimport { Gene } from \"./gene\";\r\nimport { RealizedGene } from \"./realizedGene\";\r\n\r\nexport default class Chromosome {\r\n  @serializable(list(object(RealizedGene)))\r\n  public genes: RealizedGene[];\r\n\r\n  constructor(...genes: RealizedGene[]) {\r\n    this.genes = genes;\r\n  }\r\n\r\n  /**\r\n   * Values overwrite each other by default; numbers add together.\r\n   */\r\n  public computeStaticProperties() {\r\n    const properties = defaultCellProperties();\r\n    for (const g of this.genes) {\r\n      // TODO beware of clobbering\r\n      for (const [k, v] of Object.entries(g.getStaticProperties())) {\r\n        if (k === \"tempo\") {\r\n          properties[k] *= v as number;\r\n        } else if (typeof v === \"number\") {\r\n          properties[k] = (properties[k] as number) + v;\r\n        } else if (v != null) {\r\n          properties[k] = v;\r\n        }\r\n      }\r\n    }\r\n    properties.timeToBuild = Math.max(properties.timeToBuild, 0);\r\n    return properties;\r\n  }\r\n\r\n  newGeneInstances(cell: Cell) {\r\n    return this.genes.map((g) => g.newInstance(cell));\r\n  }\r\n\r\n  has(gene: Gene): boolean {\r\n    return this.genes.find((r) => r.gene === gene) != null;\r\n  }\r\n\r\n  isEmpty() {\r\n    return this.genes.length === 0;\r\n  }\r\n\r\n  geneSlotsUsed() {\r\n    return this.genes\r\n      .map((g) => g.getCost())\r\n      .filter((c) => c >= 0)\r\n      .reduce((a, b) => a + b, 0);\r\n  }\r\n\r\n  geneSlotsAdded() {\r\n    return (\r\n      this.genes\r\n        .map((g) => g.getCost())\r\n        .filter((c) => c < 0)\r\n        .reduce((a, b) => a + b, 0) * -1\r\n    );\r\n  }\r\n\r\n  geneSlotsNet(): number {\r\n    return this.geneSlotsAdded() - this.geneSlotsUsed();\r\n  }\r\n}\r\n","import { parse, stringify } from \"query-string\";\r\n\r\nconst PARAMS_DEFAULT = {\r\n  hud: true,\r\n  showGodUI: false,\r\n  showFPS: false,\r\n  debugPerf: false,\r\n  debug: process.env.NODE_ENV === \"development\",\r\n};\r\n\r\ntype Params = typeof PARAMS_DEFAULT;\r\n\r\nexport const params = { ...PARAMS_DEFAULT };\r\n\r\nconst search = parse(window.location.search);\r\nif (search.params != null) {\r\n  const urlHashParams: object = JSON.parse(search.params as string);\r\n  Object.assign(params, urlHashParams);\r\n}\r\n\r\nexport function updateParamsHash() {\r\n  const nonDefaultParams: Partial<Params> = {};\r\n  const keys = Object.keys(PARAMS_DEFAULT) as Array<keyof Params>;\r\n  for (const key of keys) {\r\n    const k = params[key];\r\n    if (k !== PARAMS_DEFAULT[key]) {\r\n      nonDefaultParams[key] = k as any;\r\n    }\r\n  }\r\n  if (Object.keys(nonDefaultParams).length > 0) {\r\n    const stringified = stringify({\r\n      ...parse(window.location.search),\r\n      params: JSON.stringify(nonDefaultParams),\r\n    });\r\n    window.location.search = stringified;\r\n  } else {\r\n  }\r\n}\r\nupdateParamsHash();\r\n","import { EventEmitter } from \"events\";\r\nimport { Vector2 } from \"three\";\r\n\r\n// floating point rounding error fix\r\n// without: 0.8 - 0.1 = 0.7000000000000001\r\n// with: fpref(0.8 - 0.1) = 0.7\r\nfunction fpref(x: number) {\r\n  return Math.round(x * 1e12) / 1e12;\r\n}\r\n\r\ninterface HasPosition {\r\n  pos: Vector2;\r\n}\r\n\r\nexport class Inventory {\r\n  constructor(\r\n    public capacity: number,\r\n    public carrier: HasPosition,\r\n    public water: number = 0,\r\n    public sugar: number = 0\r\n  ) {\r\n    this.validate();\r\n  }\r\n\r\n  // public exchange(other: Inventory, giveWater: number, giveSugar: number, getWater: number, getSugar: number) {\r\n  //     giveWater = Math.min(giveWater, this.water);\r\n  //     giveSugar = Math.min(giveSugar, this.sugar);\r\n  //     getWater = Math.min(getWater, other.water);\r\n  //     getSugar = Math.min(getWater, other.sugar);\r\n\r\n  //     // positive = give this amount\r\n  //     // negative = other gives this amount\r\n  //     const wantedExchangedWater = giveWater - getWater;\r\n  //     const wantedExchangedSugar = giveSugar - getSugar;\r\n\r\n  //     const mySpace = fpref(this.space() + wantedExchangedSugar + wantedExchangedWater);\r\n  //     const otherSpace = fpref(other.space() - wantedExchangedSugar - wantedExchangedWater);\r\n\r\n  //     // const mySpace = fpref(this.capacity + giveWater + giveSugar - this.water - this.sugar);\r\n\r\n  //     // const otherSpace = fpref(other.capacity - other.water - other.sugar)\r\n\r\n  //     // const mySpaceNeeded = fpref(getWater + getSugar);\r\n  //     // const otherSpaceNeeded = fpref(giveWater + giveSugar);\r\n\r\n  //     // if (mySpace < mySpaceNeeded) {\r\n  //     //     // e.g. space = 2, needed = 4\r\n  //     //     // only get half\r\n  //     //     const weightedRatio = mySpace / mySpaceNeeded;\r\n  //     //     getWater = getWater * mySpace / mySpaceNeeded;\r\n  //     //     getSugar = getSugar * mySpace / mySpaceNeeded;\r\n  //     // }\r\n\r\n  //     // if (otherSpace < otherSpaceNeeded) {\r\n  //     //     giveWater = giveWater / otherSpace;\r\n  //     //     giveSugar = giveSugar / otherSpace;\r\n  //     // }\r\n  // }\r\n\r\n  public isEmpty() {\r\n    return this.water === 0 && this.sugar === 0;\r\n  }\r\n\r\n  has(water: number, sugar: number) {\r\n    return this.water >= water && this.sugar >= sugar;\r\n  }\r\n\r\n  public give(other: Inventory, amountWater: number, amountSugar: number) {\r\n    if (other === this) {\r\n      throw new Error(\"shouldn't give to self\");\r\n    }\r\n    if (amountWater === 0 && amountSugar === 0) {\r\n      return { water: 0, sugar: 0 };\r\n    }\r\n    // to check:\r\n    // 1) we have enough water and sugar\r\n    //      if we don't, cap water and sugar to the amount available\r\n    // 2) other has enough space\r\n    //      if it doesn't, scale down to the amount that is available\r\n    // 3) if negative, check how much you can take from other\r\n    let water = amountWater > 0 ? Math.min(amountWater, this.water) : -Math.min(-amountWater, other.water);\r\n    let sugar = amountSugar > 0 ? Math.min(amountSugar, this.sugar) : -Math.min(-amountSugar, other.sugar);\r\n\r\n    const spaceNeeded = fpref(water + sugar);\r\n    const spaceAvailable = other.space();\r\n    if (spaceNeeded > spaceAvailable) {\r\n      // scale down the amount to give\r\n      // give less than capacity\r\n      water = Math.floor((water / spaceNeeded) * spaceAvailable);\r\n      sugar = Math.floor((sugar / spaceNeeded) * spaceAvailable);\r\n    }\r\n    if (water !== 0 || sugar !== 0) {\r\n      this.change(-water, -sugar);\r\n      other.change(water, sugar);\r\n      if (this.events) {\r\n        this.events.emit(\"give\", other, water, sugar);\r\n      }\r\n      if (other.events) {\r\n        other.events.emit(\"get\", this, water, sugar);\r\n      }\r\n    }\r\n    return { water, sugar };\r\n  }\r\n\r\n  private events?: EventEmitter;\r\n\r\n  public on(name: \"give\" | \"get\" | \"add\", fn: (...args: any[]) => void) {\r\n    this.events = this.events || new EventEmitter();\r\n    this.events.on(name, fn);\r\n  }\r\n\r\n  public off(name: \"give\" | \"get\" | \"add\", fn: (...args: any[]) => any) {\r\n    this.events = this.events || new EventEmitter();\r\n    this.events.off(name, fn);\r\n  }\r\n\r\n  /**\r\n   * Set resources to an exact value; usually used in tile generation.\r\n   */\r\n  public set(water: number, sugar: number) {\r\n    this.water = 0;\r\n    this.sugar = 0;\r\n    this.add(water, sugar);\r\n  }\r\n\r\n  public add(water: number, sugar: number) {\r\n    const spaceNeeded = fpref(water + sugar);\r\n    const spaceAvailable = this.space();\r\n    if (spaceNeeded > spaceAvailable) {\r\n      // scale down the amount to give\r\n      water = (water / spaceNeeded) * spaceAvailable;\r\n      sugar = (sugar / spaceNeeded) * spaceAvailable;\r\n    }\r\n    this.change(water, sugar);\r\n    if (this.events) {\r\n      this.events.emit(\"add\", water, sugar);\r\n    }\r\n  }\r\n\r\n  private change(water: number, sugar: number) {\r\n    const newWater = fpref(this.water + water);\r\n    const newSugar = fpref(this.sugar + sugar);\r\n    this.validate(newWater, newSugar);\r\n    this.water = newWater;\r\n    this.sugar = newSugar;\r\n\r\n    // fixup if needed\r\n    if (this.water < 0) {\r\n      this.water = 0;\r\n    }\r\n    if (this.sugar < 0) {\r\n      this.sugar = 0;\r\n    }\r\n    if (this.water + this.sugar > this.capacity) {\r\n      if (this.water > this.sugar) {\r\n        this.water = this.capacity - this.sugar;\r\n      } else {\r\n        this.sugar = this.capacity - this.water;\r\n      }\r\n    }\r\n  }\r\n\r\n  public space() {\r\n    const { capacity, water, sugar } = this;\r\n    return fpref(capacity - water - sugar);\r\n  }\r\n\r\n  public isMaxed() {\r\n    return this.space() < 1;\r\n  }\r\n\r\n  validate(water: number = this.water, sugar: number = this.sugar) {\r\n    const { capacity } = this;\r\n    if (water < 0) {\r\n      console.warn(`water < 0: ${water}`);\r\n      // throw new Error(`water < 0: ${water}`);\r\n    }\r\n    if (sugar < 0) {\r\n      console.warn(`sugar < 0: ${sugar}`);\r\n      // throw new Error(`sugar < 0: ${sugar}`);\r\n    }\r\n    if (water + sugar > capacity) {\r\n      console.warn(`bad inventory: ${water} water + ${sugar} > ${capacity} max`);\r\n      // throw new Error(`bad inventory: ${water} water + ${sugar} > ${capacity} max`);\r\n    }\r\n  }\r\n}\r\n","import { Interactable } from \"core/interactable\";\r\nimport { Inventory } from \"core/inventory\";\r\nimport { Action } from \"core/player/action\";\r\nimport { Tile } from \"core/tile/tile\";\r\nimport { clamp, lerp, map, randRound } from \"math/index\";\r\nimport { Air } from \"./air\";\r\nexport abstract class Soil extends Tile implements Interactable {\r\n  /**\r\n   * Soil will aggressively hold onto water below saturation;\r\n   * after saturation, water is easily moved by forces diffusion or gravity.\r\n   */\r\n  abstract get saturation(): number;\r\n\r\n  /**\r\n   * How far away is this soil from the nearest Air?\r\n   */\r\n  public depth = 1000;\r\n\r\n  isObstacle = false;\r\n\r\n  isStructuralSupport = true;\r\n\r\n  get depthDiffusionFactor() {\r\n    // make water move slower in deeper soil. Every depth 10, slow down gravity and fallAmount by this much\r\n    return 1 + (this.depth - 1) / 10;\r\n    // return 1;\r\n  }\r\n\r\n  /**\r\n   * All soils can pull from each other. Also can pull from Air.\r\n   */\r\n  canPullResources(giver: Tile) {\r\n    return giver instanceof Soil || giver instanceof Air;\r\n  }\r\n\r\n  interact(): Action | undefined {\r\n    return {\r\n      type: \"pickup\",\r\n      water: 0.1,\r\n      sugar: 0.1,\r\n      target: this,\r\n      continuous: true,\r\n    };\r\n  }\r\n\r\n  shouldStep(dt: number) {\r\n    // test this out\r\n    return dt > 0.2;\r\n  }\r\n\r\n  step(dt: number) {\r\n    super.step(dt);\r\n    this.stepEvaporation(dt);\r\n  }\r\n\r\n  stepEvaporation(dt: number) {\r\n    const { secondsToEvaporate } = this.world.environment;\r\n    const water = this.inventory.water;\r\n    const evaporationChance = (water / secondsToEvaporate) * clamp(map(this.depth, 1, 8, 1, 0), 0, 1);\r\n    if (Math.random() < evaporationChance * dt) {\r\n      const waterToEvaporate = Math.min(water, 1);\r\n      this.inventory.add(-waterToEvaporate, 0);\r\n      this.world.logEvent({ type: \"evaporation\", tile: this });\r\n      this.world.numEvaporatedSoil += waterToEvaporate;\r\n    }\r\n  }\r\n\r\n  diffuseWater(tile: Tile, dt: number, diffusionRate?: number) {\r\n    if (this.pos.y < tile.pos.y) {\r\n      // test: don't diffuse upwards\r\n      return;\r\n    }\r\n    if (tile instanceof Soil && tile.inventory.water <= tile.saturation) {\r\n      return;\r\n    }\r\n    return super.diffuseWater(tile, dt, diffusionRate);\r\n  }\r\n\r\n  stepGravity(dt: number) {\r\n    const freeWater = this.inventory.water - this.saturation;\r\n    if (freeWater > 0) {\r\n      const fallAmount = this.fallAmount * dt;\r\n      const lowerNeighbor = this.world.tileAt(this.pos.x, this.pos.y + 1);\r\n      if (fallAmount > 0 && lowerNeighbor != null && lowerNeighbor.canPullResources(this)) {\r\n        const waterToGive = Math.min(randRound(fallAmount), freeWater);\r\n        this.inventory.give(lowerNeighbor.inventory, waterToGive, 0);\r\n      }\r\n    }\r\n  }\r\n\r\n  stepTemperature(_dt: number) {\r\n    const outsideTemperature = this.world.weather.getCurrentTemperature();\r\n    this.temperatureFloat = lerp(outsideTemperature, 50, clamp(map(this.depth - 1, 0, 8, 0, 1), 0, 1));\r\n  }\r\n}\r\n\r\nexport class Sand extends Soil {\r\n  displayName = \"Sand\";\r\n\r\n  get diffusionWater() {\r\n    return 1 / (3 * this.depthDiffusionFactor);\r\n  }\r\n\r\n  get saturation() {\r\n    return 0;\r\n  }\r\n\r\n  get fallAmount() {\r\n    return 1.5 / this.depthDiffusionFactor;\r\n  }\r\n\r\n  public inventory = new Inventory(20, this);\r\n}\r\n\r\nexport class Silt extends Soil {\r\n  displayName = \"Silt\";\r\n\r\n  get diffusionWater() {\r\n    return 1 / (12 * this.depthDiffusionFactor);\r\n  }\r\n\r\n  get saturation() {\r\n    return 2;\r\n  }\r\n\r\n  get fallAmount() {\r\n    return 0.2 / this.depthDiffusionFactor;\r\n  }\r\n\r\n  public inventory = new Inventory(10, this);\r\n}\r\n\r\nexport class Clay extends Soil {\r\n  displayName = \"Clay\";\r\n\r\n  get diffusionWater() {\r\n    return 1 / (100 * this.depthDiffusionFactor);\r\n  }\r\n\r\n  get saturation() {\r\n    return 5;\r\n  }\r\n\r\n  get fallAmount() {\r\n    return 0.05 / this.depthDiffusionFactor;\r\n  }\r\n\r\n  public inventory = new Inventory(10, this);\r\n}\r\n","import React from \"react\";\r\nimport Ticker from \"std/ticker\";\r\nimport { nf } from \"../../../common/formatters\";\r\n\r\nexport interface DynamicNumberProps {\r\n  value: number;\r\n  speed?: number;\r\n  sigFigs?: number;\r\n}\r\n\r\nfunction DynamicNumber({ value, speed = 0.5, sigFigs = 3 }: DynamicNumberProps) {\r\n  const [v, setV] = React.useState(value);\r\n\r\n  React.useEffect(() => {\r\n    function tickOnce() {\r\n      setV((v) => {\r\n        if (Math.abs(v - value) < 5e-3) {\r\n          Ticker.removeAnimation(id);\r\n          return value;\r\n        } else {\r\n          return v * (1 - speed) + value * speed;\r\n        }\r\n      });\r\n    }\r\n    tickOnce();\r\n\r\n    const id = Ticker.addAnimation(tickOnce);\r\n    return () => {\r\n      Ticker.removeAnimation(id);\r\n    };\r\n  }, [value, speed]);\r\n\r\n  return <>{nf(v, sigFigs)}</>;\r\n}\r\n\r\nexport default DynamicNumber;\r\n","import shuffle from \"math/shuffle\";\r\nimport { Vector2 } from \"three\";\r\nimport { clamp, randRound } from \"../../math/index\";\r\nimport { Steppable } from \"../entity\";\r\nimport { Inventory } from \"../inventory\";\r\nimport { Temperature, temperatureFor } from \"../temperature\";\r\nimport { World } from \"../world/world\";\r\n\r\nexport abstract class Tile implements Steppable {\r\n  displayName = \"Tile\";\r\n\r\n  static fallAmount = 0;\r\n\r\n  public abstract get isObstacle(): boolean;\r\n\r\n  public darkness = Infinity;\r\n\r\n  public temperatureFloat: number;\r\n\r\n  public isStructuralSupport = false;\r\n\r\n  public dtSinceLastStepped = 0;\r\n\r\n  public abstract inventory: Inventory;\r\n\r\n  // public lightIntersection?: Intersection;\r\n  get temperature(): Temperature {\r\n    return temperatureFor(this.temperatureFloat);\r\n  }\r\n\r\n  get diffusionWater(): number {\r\n    return (this.constructor as any).diffusionWater;\r\n  }\r\n\r\n  get diffusionSugar(): number {\r\n    return (this.constructor as any).diffusionSugar;\r\n  }\r\n\r\n  get fallAmount(): number {\r\n    return (this.constructor as any).fallAmount;\r\n  }\r\n\r\n  get darknessContrib(): number {\r\n    const contrib = Math.max(\r\n      0.2\r\n      // map(this.pos.y, this.world.height / 2, this.world.height, params.soilDarknessBase, 1)\r\n    );\r\n    return contrib;\r\n  }\r\n\r\n  public readonly timeMade: number;\r\n\r\n  public pos: Vector2;\r\n\r\n  public get age() {\r\n    return this.world.time - this.timeMade;\r\n  }\r\n\r\n  public constructor(pos: Vector2, public readonly world: World) {\r\n    this.pos = pos.clone();\r\n    if (world == null) {\r\n      throw new Error(\"null world!\");\r\n    }\r\n    this.timeMade = world.time;\r\n    this.temperatureFloat = this.world.weather.getCurrentTemperature();\r\n  }\r\n\r\n  abstract shouldStep(dt: number): boolean;\r\n\r\n  /**\r\n   * Can this Tile accept resources from the giver? Use this to define\r\n   * boundaries like \"Cells can give to each other but not to Soil\".\r\n   *\r\n   * By default, allow ancestor/child relationships to exchange resources\r\n   * with each other (e.g. Soil and Fountain).\r\n   */\r\n  canPullResources(giver: Tile): boolean {\r\n    const hasAncestry = this instanceof giver.constructor || giver instanceof this.constructor;\r\n    return hasAncestry;\r\n  }\r\n\r\n  /**\r\n   * 0 = full darkness\r\n   * 1 = full light\r\n   */\r\n  public lightAmount() {\r\n    return Math.sqrt(clamp(1 - this.darkness, 0, 1));\r\n  }\r\n\r\n  /**\r\n   * Redistribute this tile's inventory to nearby tiles if possible, usually\r\n   * in preparation for removing this tile.\r\n   */\r\n  public redistributeInventoryToNeighbors(water: number = this.inventory.water, sugar: number = this.inventory.sugar) {\r\n    water = clamp(water, 0, this.inventory.water);\r\n    sugar = clamp(sugar, 0, this.inventory.sugar);\r\n    if (water > 0 || sugar > 0) {\r\n      // push resources to nearby tiles\r\n      const neighbors = this.world.tileNeighbors(this.pos);\r\n      const giveCandidates = Array.from(neighbors.values()).filter((n) => n.canPullResources(this));\r\n      let guard = 0;\r\n      while ((water > 0 || sugar > 0) && giveCandidates.length > 0 && guard < 20) {\r\n        shuffle(giveCandidates);\r\n        for (let i = 0; i < giveCandidates.length; i++) {\r\n          const neighbor = giveCandidates[i];\r\n          // give (up to 1) to this neighbor\r\n          const { water: waterGiven, sugar: sugarGiven } = this.inventory.give(\r\n            neighbor.inventory,\r\n            clamp(water, 0, 1),\r\n            clamp(sugar, 0, 1)\r\n          );\r\n          water -= waterGiven;\r\n          sugar -= sugarGiven;\r\n          if (neighbor.inventory.isMaxed()) {\r\n            // delete this neighbor from candidates to give\r\n            giveCandidates.splice(i, 1);\r\n          }\r\n          if (water === 0 && sugar === 0) {\r\n            // we're all done\r\n            break;\r\n          }\r\n        }\r\n        guard++;\r\n      }\r\n      if (guard >= 100) {\r\n        console.error(\"redistributeInventoryToNeighbors passed guard limit\");\r\n      }\r\n    }\r\n  }\r\n\r\n  // test tiles diffusing water around on same-type tiles\r\n  public step(dt: number) {\r\n    const neighbors = this.world.tileNeighbors(this.pos);\r\n    this.stepDarkness(neighbors);\r\n    this.stepDiffusion(neighbors, dt);\r\n    this.stepTemperature(dt);\r\n    this.stepGravity(dt);\r\n  }\r\n\r\n  stepTemperature(_dt: number) {\r\n    this.temperatureFloat = this.world.weather.getCurrentTemperature();\r\n  }\r\n\r\n  stepDarkness(neighbors: Map<Vector2, Tile>) {\r\n    let minDarkness = this.darkness;\r\n    for (const [, t] of neighbors) {\r\n      const darknessFromNeighbor = t.darkness + t.darknessContrib;\r\n      minDarkness = Math.min(minDarkness, darknessFromNeighbor);\r\n    }\r\n    this.darkness = minDarkness;\r\n  }\r\n\r\n  stepDiffusion(neighbors: Map<Vector2, Tile>, dt: number) {\r\n    for (const tile of neighbors.values()) {\r\n      if (!this.canPullResources(tile)) {\r\n        continue;\r\n      }\r\n      // take water from neighbors that have more water than you\r\n      if (this.diffusionWater != null) {\r\n        if (tile.inventory.water > this.inventory.water) {\r\n          this.diffuseWater(tile, dt);\r\n        }\r\n      }\r\n      if (this.diffusionSugar != null) {\r\n        if (tile.inventory.sugar > this.inventory.sugar) {\r\n          this.diffuseSugar(tile, dt);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This cell gets water. Take water from the giver.\r\n   */\r\n  diffuseWater(giver: Tile, dt: number, diffusionRate = this.diffusionWater) {\r\n    // Diffusion equation by finite difference: the purpose of this equation is to eventually\r\n    // equalize the amount of water between me and giver. The two questions are how long\r\n    // does it take, and what function does it follow to get there? These are generally\r\n    // defined by the diffusionWater variable.\r\n    const difference = giver.inventory.water - this.inventory.water;\r\n\r\n    // Make it harder for water to break into a dry tile. Emulates surface tension at the\r\n    // wet/dry border.\r\n    const isBreakingSurfaceTension = this.inventory.water > 0 || giver.inventory.water > 1;\r\n\r\n    if (difference > 0 && isBreakingSurfaceTension) {\r\n      // At high dt's this isn't accurate, but at these low numbers we can assume near linearity.\r\n      const diffusionAmount = Math.min(difference * diffusionRate * dt, difference / 2);\r\n      giver.inventory.give(this.inventory, diffusionAmount, 0);\r\n    }\r\n  }\r\n\r\n  diffuseSugar(giver: Tile, dt: number, diffusionRate = this.diffusionSugar) {\r\n    const difference = giver.inventory.sugar - this.inventory.sugar;\r\n    if (difference > 1) {\r\n      const diffusionAmount = Math.min(difference * diffusionRate * dt, difference / 2);\r\n      giver.inventory.give(this.inventory, 0, diffusionAmount);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Give to your lower neighbor.\r\n   */\r\n  stepGravity(dt: number) {\r\n    const fallAmount = this.fallAmount * dt;\r\n    const lowerNeighbor = this.world.tileAt(this.pos.x, this.pos.y + 1);\r\n    if (fallAmount > 0 && lowerNeighbor != null && lowerNeighbor.canPullResources(this)) {\r\n      this.inventory.give(lowerNeighbor.inventory, randRound(fallAmount), 0);\r\n    }\r\n  }\r\n\r\n  toString() {\r\n    return this.displayName + \"(\" + this.pos.x + \",\" + this.pos.y + \")\";\r\n  }\r\n}\r\n","import { nf } from \"common/formatters\";\r\nimport MP from \"game/ui/common/MP\";\r\nimport { clamp } from \"math\";\r\nimport React from \"react\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport { GeneInstance } from \"../../core/cell/geneInstance\";\r\n\r\nexport interface ReproducerState {\r\n  timeMatured?: number;\r\n  isMature: boolean;\r\n  energyRecieved: number;\r\n}\r\n\r\nexport const GeneFruit = Gene.make<ReproducerState>(\r\n  {\r\n    name: \"Fruit\",\r\n    levelCosts: [10, 15, 20, 25, 30],\r\n    levelProps: {\r\n      mpEarned: [3, 4, 5, 6, 7],\r\n      neededEnergy: 300,\r\n    },\r\n    static: {\r\n      isReproductive: true,\r\n      // TODO fix this to be a \"set to 0\"\r\n      timeToBuild: -1,\r\n    },\r\n    description: reproducerDescription,\r\n  },\r\n  () => ({\r\n    isMature: false,\r\n    energyRecieved: 0,\r\n  }),\r\n  (dt, instance) => {\r\n    reproducerStep(dt, instance);\r\n  }\r\n);\r\n\r\nexport type GeneFruit = typeof GeneFruit;\r\n\r\nexport const GeneSeed = Gene.make<ReproducerState>(\r\n  {\r\n    name: \"Seed\",\r\n    levelCosts: [10, 12, 14, 16, 18],\r\n    levelProps: {\r\n      mpEarned: [1, 1.25, 1.5, 1.75, 2],\r\n      neededEnergy: 100,\r\n    },\r\n    static: {\r\n      isReproductive: true,\r\n      timeToBuild: -1,\r\n    },\r\n    description: reproducerDescription,\r\n  },\r\n  () => ({\r\n    isMature: false,\r\n    energyRecieved: 0,\r\n  }),\r\n  (dt, instance) => {\r\n    reproducerStep(dt, instance);\r\n  }\r\n);\r\n\r\nexport type GeneSeed = typeof GeneSeed;\r\n\r\nconst ENERGY_TRANSFER_PER_SECOND = 0.25;\r\nconst NEIGHBOR_ENERGY_THRESHOLD = 0.5;\r\n\r\nfunction reproducerDescription({ mpEarned, neededEnergy }: Record<string, number>) {\r\n  return (\r\n    <>\r\n      <p>Absorbs {neededEnergy} energy from neighbors to mature.</p>\r\n      <p>\r\n        Each neighboring Cell contributes 1 energy every <b>{nf(1 / ENERGY_TRANSFER_PER_SECOND, 1)}</b> seconds.\r\n      </p>\r\n      <p>\r\n        On maturation,{\" \"}\r\n        <b>\r\n          achieve <span className=\"reproduction\">Survival</span>\r\n        </b>{\" \"}\r\n        and earn <MP amount={mpEarned} />.\r\n      </p>\r\n    </>\r\n  );\r\n}\r\n\r\nfunction reproducerStep(dt: number, instance: GeneInstance<Gene<ReproducerState, string>>) {\r\n  const {\r\n    cell,\r\n    state,\r\n    props: { mpEarned, neededEnergy },\r\n  } = instance;\r\n  const { isMature } = state;\r\n  if (!isMature) {\r\n    commitEnergy(dt, cell, state, neededEnergy);\r\n    const isNowMature = reproducerGetPercentMatured(instance) >= 1;\r\n    if (isNowMature) {\r\n      state.isMature = isNowMature;\r\n      state.timeMatured = cell.world.time;\r\n      instance.earnMP(cell, mpEarned);\r\n    }\r\n  }\r\n}\r\n\r\nfunction commitEnergy(dt: number, seed: Cell, state: ReproducerState, neededEnergy: number) {\r\n  let energyLeftToTake = neededEnergy - state.energyRecieved;\r\n  let energyRecieved = 0;\r\n  const tileNeighbors = seed.world.tileNeighbors(seed.pos);\r\n  for (const [, neighbor] of tileNeighbors) {\r\n    if (neighbor.pos.manhattanDistanceTo(seed.pos) > 1 || !(neighbor instanceof Cell)) continue;\r\n\r\n    if (neighbor.energy > NEIGHBOR_ENERGY_THRESHOLD && energyLeftToTake > 0 && !neighbor.isReproductive) {\r\n      const energyToTake = clamp(neighbor.energy, 0, ENERGY_TRANSFER_PER_SECOND * dt);\r\n      state.energyRecieved += energyToTake;\r\n      neighbor.energy -= energyToTake;\r\n\r\n      energyLeftToTake -= energyToTake;\r\n      energyRecieved += energyToTake;\r\n\r\n      seed.world.logEvent({ type: \"cell-transfer-energy\", from: neighbor, to: seed, amount: energyToTake });\r\n    }\r\n  }\r\n\r\n  if (energyRecieved > 0) {\r\n    seed.world.logEvent({\r\n      type: \"grow-fruit\",\r\n      cell: seed,\r\n      resourcesUsed: energyRecieved * 20,\r\n    });\r\n  }\r\n}\r\n\r\nexport function reproducerGetPercentMatured(g: GeneInstance<Gene<ReproducerState, any>>) {\r\n  const { energyRecieved } = g.state;\r\n  const neededEnergy = g.props.neededEnergy;\r\n  return energyRecieved / (neededEnergy - 1e-12);\r\n}\r\n","import classNames from \"classnames\";\r\nimport React from \"react\";\r\nimport { GiDna1 } from \"react-icons/gi\";\r\nimport DynamicNumber from \"./DynamicNumber\";\r\nimport \"./MP.scss\";\r\n\r\nexport type MPProps = JSX.IntrinsicElements[\"div\"] & {\r\n  amount: number;\r\n  total?: number;\r\n};\r\n\r\nfunction MP({ amount, total, ...props }: MPProps) {\r\n  return (\r\n    <span {...props} className={classNames(\"mp\", props.className)}>\r\n      <DynamicNumber speed={0.5} sigFigs={5} value={amount} />\r\n      {total != null ? <>/{total}</> : null}\r\n      <GiDna1 className=\"mp-icon\" />\r\n    </span>\r\n  );\r\n}\r\n\r\nexport default MP;\r\n","import { Player } from \"core\";\r\nimport { ActionRemoveCancer, ActionThaw } from \"core/player/action\";\r\nimport { Constructor } from \"../../typings/constructor\";\r\nimport { TIME_PER_DAY } from \"../constants\";\r\nimport { StopStep } from \"../entity\";\r\nimport { Interactable } from \"../interactable\";\r\nimport { Temperature } from \"../temperature\";\r\nimport { Cell } from \"./cell\";\r\nexport abstract class CellEffect {\r\n  private timeMade!: number;\r\n\r\n  public cell!: Cell;\r\n\r\n  get age() {\r\n    return this.cell.world.time - this.timeMade;\r\n  }\r\n\r\n  attachTo(cell: Cell) {\r\n    this.cell = cell;\r\n    this.timeMade = this.cell.world.time;\r\n    this.onAttached();\r\n  }\r\n\r\n  onAttached() {}\r\n\r\n  /**\r\n   * Return whether to step the next behavior in the chain\r\n   */\r\n  abstract step(dt: number): void;\r\n\r\n  remove() {\r\n    const index = this.cell.effects.indexOf(this);\r\n    this.cell.effects.splice(index, 1);\r\n  }\r\n}\r\n\r\nexport interface CellEffectConstructor extends Constructor<CellEffect> {\r\n  displayName: string;\r\n  stacks?: boolean;\r\n}\r\nexport class FreezeEffect extends CellEffect implements Interactable {\r\n  static displayName = \"Frozen\";\r\n\r\n  static stacks = false;\r\n\r\n  public readonly secondsToDie = TIME_PER_DAY;\r\n\r\n  public percentFrozen = 0.25;\r\n\r\n  chunkCooldown = 0;\r\n\r\n  get timeUntilDeath() {\r\n    return this.secondsToDie - this.age;\r\n  }\r\n\r\n  interact(source: Player): ActionThaw {\r\n    return {\r\n      type: \"thaw\",\r\n      target: this,\r\n    };\r\n  }\r\n\r\n  thaw(_dt: number) {\r\n    if (this.chunkCooldown <= 0) {\r\n      this.chunkCooldown += 0.5;\r\n      this.percentFrozen -= (15 / this.secondsToDie) * 0.5;\r\n      if (this.percentFrozen < 0.02) {\r\n        this.percentFrozen = 0;\r\n      }\r\n      this.cell.world.logEvent({\r\n        type: \"thaw\",\r\n        where: this.cell,\r\n      });\r\n    }\r\n    // this.percentFrozen -= (20 / this.secondsToDie) * dt;\r\n    this.onFrozenChanged();\r\n  }\r\n\r\n  step(dt: number) {\r\n    if (this.chunkCooldown > 0) {\r\n      this.chunkCooldown -= dt;\r\n    }\r\n    if (this.cell.temperature === Temperature.Cold) {\r\n      this.percentFrozen += (1 / this.secondsToDie) * dt;\r\n    } else if (this.cell.temperature === Temperature.Freezing) {\r\n      this.percentFrozen += (10 / this.secondsToDie) * dt;\r\n    } else {\r\n      // this.percentFrozen -= (10 / this.secondsToDie) * dt;\r\n    }\r\n    this.onFrozenChanged();\r\n    this.cell.energy -= dt / this.secondsToDie;\r\n    throw new StopStep();\r\n  }\r\n\r\n  onAttached() {\r\n    this.cell.energy -= 0.2;\r\n  }\r\n\r\n  onFrozenChanged() {\r\n    if (this.percentFrozen > 1) {\r\n      this.cell.die();\r\n    } else if (this.percentFrozen <= 0) {\r\n      this.remove();\r\n    }\r\n  }\r\n}\r\n\r\nexport class CancerEffect extends CellEffect implements Interactable {\r\n  static displayName = \"Cancerous\";\r\n\r\n  static stacks = false;\r\n\r\n  public secondsPerDuplication = 12;\r\n\r\n  public timeToDuplicate = this.secondsPerDuplication;\r\n\r\n  interact(source: Player): ActionRemoveCancer {\r\n    return {\r\n      type: \"remove-cancer\",\r\n      target: this,\r\n    };\r\n  }\r\n\r\n  removeCancer(dt: number) {\r\n    this.timeToDuplicate += 4 * dt;\r\n    if (this.timeToDuplicate > this.secondsPerDuplication * 1.05) {\r\n      this.remove();\r\n    }\r\n  }\r\n\r\n  step(dt: number): void {\r\n    this.timeToDuplicate -= dt;\r\n    if (this.timeToDuplicate < 0) {\r\n      const world = this.cell.world;\r\n      const neighbors = world.tileNeighbors(this.cell.pos);\r\n\r\n      // spread to one neighbor:\r\n      // if that neighbor is a cell without cancer, add cancer to that neighbor\r\n      // if that neighbor is empty, duplicate this cell onto that neighbor\r\n      for (const [, tile] of neighbors) {\r\n        if (tile instanceof Cell && !tile.findEffectOfType(CancerEffect)) {\r\n          tile.addEffect(new CancerEffect());\r\n          break;\r\n        } else if (tile.world.player.canBuildAt(tile)) {\r\n          // const cell = new Cell(tile.pos, world, this.cell.type, this.cell.args);\r\n\r\n          const newCell = new Cell(tile.pos, tile.world, this.cell.type, this.cell.args);\r\n          // half this cell's energy, and give it to the new cell\r\n          this.cell.energy /= 2;\r\n          newCell.energy = this.cell.energy;\r\n          newCell.droopY = this.cell.droopY;\r\n          tile.world.setTileAt(newCell.pos, newCell);\r\n          break;\r\n        }\r\n      }\r\n      this.timeToDuplicate += this.secondsPerDuplication;\r\n    }\r\n  }\r\n}\r\n","export default function shuffle<T>(array: T[]) {\r\n  let currentIndex = array.length,\r\n    temporaryValue,\r\n    randomIndex;\r\n  // While there remain elements to shuffle...\r\n  while (0 !== currentIndex) {\r\n    // Pick a remaining element...\r\n    randomIndex = Math.floor(Math.random() * currentIndex);\r\n    currentIndex -= 1;\r\n    // And swap it with the current element.\r\n    temporaryValue = array[currentIndex];\r\n    array[currentIndex] = array[randomIndex];\r\n    array[randomIndex] = temporaryValue;\r\n  }\r\n  return array;\r\n}\r\n","import { Player, PlayerSeed } from \"./player/player\";\r\nimport { Tile } from \"./tile\";\r\n\r\nexport type Entity = Tile | Player | PlayerSeed;\r\n\r\nexport interface Steppable {\r\n  dtSinceLastStepped: number;\r\n  shouldStep(dt: number): boolean;\r\n  step(dt: number): void;\r\n}\r\n\r\nexport class StopStep extends Error {}\r\n\r\nexport function isSteppable(obj: any): obj is Steppable {\r\n  return typeof obj.step === \"function\";\r\n}\r\n\r\nexport function step(s: Steppable, dt: number) {\r\n  const sDt = s.dtSinceLastStepped + dt;\r\n  if (s.shouldStep(sDt)) {\r\n    try {\r\n      s.step(sDt);\r\n    } catch (e) {\r\n      if (e instanceof StopStep) {\r\n        // no-op for exiting early\r\n      } else {\r\n        throw e;\r\n      }\r\n    } finally {\r\n      s.dtSinceLastStepped = 0;\r\n    }\r\n  } else {\r\n    s.dtSinceLastStepped = sDt;\r\n  }\r\n}\r\n","import React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nexport const GeneObstacle = Gene.make(\r\n  {\r\n    name: \"Obstacle\",\r\n    levelCosts: [-4],\r\n    levelProps: {},\r\n    static: {\r\n      isObstacle: true,\r\n    },\r\n    description: () => <>You may not walk on this Cell.</>,\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneObstacle = typeof GeneObstacle;\r\n","import { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport { randFloat } from \"math\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneTransport = Gene.make(\r\n  {\r\n    name: \"Transport\",\r\n    levelCosts: [2, 3, 4, 5, 6],\r\n    levelProps: {\r\n      secondsPerPush: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerPush }) => (\r\n      <>\r\n        <b>Hold Shift to configure.</b>\r\n        <p>\r\n          Every <GN value={secondsPerPush} sigFigs={2} /> seconds, give 1<ResourceIcon name=\"water\" />1\r\n          <ResourceIcon name=\"sugar\" /> into the directed cell.\r\n        </p>\r\n        <p>\r\n          Every <GN value={secondsPerPush} sigFigs={2} /> seconds, take 1\r\n          <ResourceIcon name=\"water\" />1<ResourceIcon name=\"sugar\" /> from behind.\r\n        </p>\r\n      </>\r\n    ),\r\n    static: {\r\n      isDirectional: true,\r\n    },\r\n  },\r\n  (gene, { secondsPerPush }) => ({\r\n    didJustTransport: false,\r\n    cooldown: randFloat(0, secondsPerPush),\r\n  }),\r\n  (dt, { cell, state, props: { secondsPerPush } }) => {\r\n    state.didJustTransport = false;\r\n    if (state.cooldown <= 0) {\r\n      state.cooldown += secondsPerPush;\r\n      const forwardTile = cell.world.tileAt(cell.pos.x + cell.args!.direction!.x, cell.pos.y + cell.args!.direction!.y);\r\n      if (forwardTile instanceof Cell) {\r\n        state.didJustTransport = push(cell, forwardTile, 1, 1);\r\n      }\r\n\r\n      const backwardTile = cell.world.tileAt(\r\n        cell.pos.x - cell.args!.direction!.x,\r\n        cell.pos.y - cell.args!.direction!.y\r\n      );\r\n      if (backwardTile instanceof Cell) {\r\n        state.didJustTransport = state.didJustTransport || push(backwardTile, cell, 1, 1);\r\n      }\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneTransport = typeof GeneTransport;\r\n\r\nfunction push(cell: Cell, target: Cell, waterToTransport: number, sugarToTransport: number) {\r\n  const { water, sugar } = cell.inventory.give(target.inventory, waterToTransport, sugarToTransport);\r\n  return water > 0 || sugar > 0;\r\n}\r\n","export default function mapRecord<O, R>(obj: O, fn: (val: O[keyof O], key: keyof O) => R): Record<keyof O, R> {\r\n  const out = {} as Record<keyof O, R>;\r\n  let key: keyof O;\r\n  for (key in obj) {\r\n    const val = obj[key];\r\n    out[key] = fn(val, key);\r\n  }\r\n  return out;\r\n}\r\n","import mapRecord from \"common/mapRecord\";\r\nimport { clamp } from \"math\";\r\nimport { custom, identifier, serializable } from \"serializr\";\r\nimport uuid from \"uuid\";\r\nimport { Cell } from \"../tile\";\r\nimport { CellProperties } from \"./cellProperties\";\r\nimport { AllGenesByName, Gene } from \"./gene\";\r\nimport { GeneInstance } from \"./geneInstance\";\r\n\r\nfunction serializeGeneIntoName(gene: Gene): string {\r\n  return gene.blueprint.name;\r\n}\r\n\r\nfunction deserializeGeneFromName(name: string): Gene {\r\n  return AllGenesByName.get(name)!;\r\n}\r\n\r\nexport class RealizedGene<G extends Gene = Gene> {\r\n  @serializable(custom(serializeGeneIntoName, deserializeGeneFromName))\r\n  public gene: G;\r\n\r\n  @serializable\r\n  public level!: number;\r\n\r\n  @serializable(identifier())\r\n  public readonly uuid = uuid();\r\n\r\n  public constructor(gene?: G, level?: number) {\r\n    this.gene = gene!;\r\n    if (level != null) {\r\n      this.setLevel(level);\r\n    }\r\n  }\r\n\r\n  getStaticProperties() {\r\n    const staticBlueprint = this.gene.blueprint.static || {};\r\n    return mapRecord(staticBlueprint, (arr) => (Array.isArray(arr) ? arr[this.level] : arr)) as Partial<CellProperties>;\r\n  }\r\n\r\n  getDynamicProperties(cell: Cell, properties: CellProperties) {\r\n    return this.gene.blueprint.dynamic?.(cell, properties);\r\n  }\r\n\r\n  public getProps() {\r\n    return mapRecord(this.gene.blueprint.levelProps, (val) => (typeof val === \"number\" ? val : val[this.level]));\r\n  }\r\n\r\n  public getCost() {\r\n    return this.gene.blueprint.levelCosts[this.level];\r\n  }\r\n\r\n  setLevel(newLevel: number): void {\r\n    this.level = clamp(newLevel, 0, this.gene.numLevels - 1);\r\n  }\r\n\r\n  public newInstance(cell: Cell): GeneInstance<G> {\r\n    return new GeneInstance(this.gene, this.getProps(), cell);\r\n  }\r\n\r\n  toString() {\r\n    return `RealizedGene(${this.gene.blueprint.name} ${this.level} [${this.uuid}])`;\r\n  }\r\n}\r\n","export default function devlog(message?: any, ...optionalParams: any[]) {\r\n  if (process.env.NODE_ENV === \"development\") {\r\n    console.log(message, ...optionalParams);\r\n  }\r\n}\r\n","// LICENSE: https://github.com/josephg/noisejs/blob/master/LICENSE\r\n\r\n// copy-pasted from https://raw.githubusercontent.com/josephg/noisejs/master/perlin.js\r\n// tslint:disable\r\n\r\n/*\r\n * A speed-improved perlin and simplex noise algorithms for 2D.\r\n *\r\n * Based on example code by Stefan Gustavson (stegu@itn.liu.se).\r\n * Optimisations by Peter Eastman (peastman@drizzle.stanford.edu).\r\n * Better rank ordering method by Stefan Gustavson in 2012.\r\n * Converted to Javascript by Joseph Gentle.\r\n *\r\n * Version 2012-03-09\r\n *\r\n * This code was placed in the public domain by its original author,\r\n * Stefan Gustavson. You may use it as you see fit, but\r\n * attribution is appreciated.\r\n *\r\n */\r\n\r\nclass Grad {\r\n  constructor(public x: number, public y: number, public z: number) {}\r\n\r\n  dot2(x: number, y: number) {\r\n    return this.x * x + this.y * y;\r\n  }\r\n\r\n  dot3(x: number, y: number, z: number) {\r\n    return this.x * x + this.y * y + this.z * z;\r\n  }\r\n}\r\n\r\nconst grad3 = [\r\n  new Grad(1, 1, 0),\r\n  new Grad(-1, 1, 0),\r\n  new Grad(1, -1, 0),\r\n  new Grad(-1, -1, 0),\r\n  new Grad(1, 0, 1),\r\n  new Grad(-1, 0, 1),\r\n  new Grad(1, 0, -1),\r\n  new Grad(-1, 0, -1),\r\n  new Grad(0, 1, 1),\r\n  new Grad(0, -1, 1),\r\n  new Grad(0, 1, -1),\r\n  new Grad(0, -1, -1),\r\n];\r\n\r\nconst p = [\r\n  151,\r\n  160,\r\n  137,\r\n  91,\r\n  90,\r\n  15,\r\n  131,\r\n  13,\r\n  201,\r\n  95,\r\n  96,\r\n  53,\r\n  194,\r\n  233,\r\n  7,\r\n  225,\r\n  140,\r\n  36,\r\n  103,\r\n  30,\r\n  69,\r\n  142,\r\n  8,\r\n  99,\r\n  37,\r\n  240,\r\n  21,\r\n  10,\r\n  23,\r\n  190,\r\n  6,\r\n  148,\r\n  247,\r\n  120,\r\n  234,\r\n  75,\r\n  0,\r\n  26,\r\n  197,\r\n  62,\r\n  94,\r\n  252,\r\n  219,\r\n  203,\r\n  117,\r\n  35,\r\n  11,\r\n  32,\r\n  57,\r\n  177,\r\n  33,\r\n  88,\r\n  237,\r\n  149,\r\n  56,\r\n  87,\r\n  174,\r\n  20,\r\n  125,\r\n  136,\r\n  171,\r\n  168,\r\n  68,\r\n  175,\r\n  74,\r\n  165,\r\n  71,\r\n  134,\r\n  139,\r\n  48,\r\n  27,\r\n  166,\r\n  77,\r\n  146,\r\n  158,\r\n  231,\r\n  83,\r\n  111,\r\n  229,\r\n  122,\r\n  60,\r\n  211,\r\n  133,\r\n  230,\r\n  220,\r\n  105,\r\n  92,\r\n  41,\r\n  55,\r\n  46,\r\n  245,\r\n  40,\r\n  244,\r\n  102,\r\n  143,\r\n  54,\r\n  65,\r\n  25,\r\n  63,\r\n  161,\r\n  1,\r\n  216,\r\n  80,\r\n  73,\r\n  209,\r\n  76,\r\n  132,\r\n  187,\r\n  208,\r\n  89,\r\n  18,\r\n  169,\r\n  200,\r\n  196,\r\n  135,\r\n  130,\r\n  116,\r\n  188,\r\n  159,\r\n  86,\r\n  164,\r\n  100,\r\n  109,\r\n  198,\r\n  173,\r\n  186,\r\n  3,\r\n  64,\r\n  52,\r\n  217,\r\n  226,\r\n  250,\r\n  124,\r\n  123,\r\n  5,\r\n  202,\r\n  38,\r\n  147,\r\n  118,\r\n  126,\r\n  255,\r\n  82,\r\n  85,\r\n  212,\r\n  207,\r\n  206,\r\n  59,\r\n  227,\r\n  47,\r\n  16,\r\n  58,\r\n  17,\r\n  182,\r\n  189,\r\n  28,\r\n  42,\r\n  223,\r\n  183,\r\n  170,\r\n  213,\r\n  119,\r\n  248,\r\n  152,\r\n  2,\r\n  44,\r\n  154,\r\n  163,\r\n  70,\r\n  221,\r\n  153,\r\n  101,\r\n  155,\r\n  167,\r\n  43,\r\n  172,\r\n  9,\r\n  129,\r\n  22,\r\n  39,\r\n  253,\r\n  19,\r\n  98,\r\n  108,\r\n  110,\r\n  79,\r\n  113,\r\n  224,\r\n  232,\r\n  178,\r\n  185,\r\n  112,\r\n  104,\r\n  218,\r\n  246,\r\n  97,\r\n  228,\r\n  251,\r\n  34,\r\n  242,\r\n  193,\r\n  238,\r\n  210,\r\n  144,\r\n  12,\r\n  191,\r\n  179,\r\n  162,\r\n  241,\r\n  81,\r\n  51,\r\n  145,\r\n  235,\r\n  249,\r\n  14,\r\n  239,\r\n  107,\r\n  49,\r\n  192,\r\n  214,\r\n  31,\r\n  181,\r\n  199,\r\n  106,\r\n  157,\r\n  184,\r\n  84,\r\n  204,\r\n  176,\r\n  115,\r\n  121,\r\n  50,\r\n  45,\r\n  127,\r\n  4,\r\n  150,\r\n  254,\r\n  138,\r\n  236,\r\n  205,\r\n  93,\r\n  222,\r\n  114,\r\n  67,\r\n  29,\r\n  24,\r\n  72,\r\n  243,\r\n  141,\r\n  128,\r\n  195,\r\n  78,\r\n  66,\r\n  215,\r\n  61,\r\n  156,\r\n  180,\r\n];\r\n\r\n/*\r\nfor(const i=0; i<256; i++) {\r\nperm[i] = perm[i + 256] = p[i];\r\ngradP[i] = gradP[i + 256] = grad3[perm[i] % 12];\r\n}*/\r\n\r\n// Skewing and unskewing factors for 2, 3, and 4 dimensions\r\nconst F2 = 0.5 * (Math.sqrt(3) - 1);\r\nconst G2 = (3 - Math.sqrt(3)) / 6;\r\n\r\nconst F3 = 1 / 3;\r\nconst G3 = 1 / 6;\r\n\r\nexport class Noise {\r\n  // To remove the need for index wrapping, double the permutation table length\r\n  public perm = new Array(512);\r\n\r\n  public gradP = new Array(512);\r\n\r\n  public octaveNum = 6;\r\n\r\n  public octaveFalloff = 0.5;\r\n\r\n  // rotate by 1 radians (~57 deg), scale by 2\r\n  public octaveMatrix2 = [Math.cos(1) * 2, -Math.sin(1) * 2, Math.sin(1) * 2, Math.cos(1) * 2];\r\n\r\n  // This isn't a very good seeding function, but it works ok. It supports 2^16\r\n  // different seed values. Write something better if you need more seeds.\r\n  public seed(seed: number) {\r\n    if (seed > 0 && seed < 1) {\r\n      // Scale the seed out\r\n      seed *= 65536;\r\n    }\r\n\r\n    seed = Math.floor(seed);\r\n    if (seed < 256) {\r\n      seed |= seed << 8;\r\n    }\r\n\r\n    for (let i = 0; i < 256; i++) {\r\n      let v;\r\n      if (i & 1) {\r\n        v = p[i] ^ (seed & 255);\r\n      } else {\r\n        v = p[i] ^ ((seed >> 8) & 255);\r\n      }\r\n\r\n      this.perm[i] = this.perm[i + 256] = v;\r\n      this.gradP[i] = this.gradP[i + 256] = grad3[v % 12];\r\n    }\r\n  }\r\n\r\n  constructor(seed: number = Math.random() * 2147483647) {\r\n    this.seed(seed);\r\n  }\r\n\r\n  // 2D simplex noise\r\n  public simplex2(xin: number, yin: number) {\r\n    let n0, n1, n2; // Noise contributions from the three corners\r\n    // Skew the input space to determine which simplex cell we're in\r\n    const s = (xin + yin) * F2; // Hairy factor for 2D\r\n    let i = Math.floor(xin + s);\r\n    let j = Math.floor(yin + s);\r\n    const t = (i + j) * G2;\r\n    let x0 = xin - i + t; // The x,y distances from the cell origin, unskewed.\r\n    let y0 = yin - j + t;\r\n    // For the 2D case, the simplex shape is an equilateral triangle.\r\n    // Determine which simplex we are in.\r\n    let i1, j1; // Offsets for second (middle) corner of simplex in (i,j) coords\r\n    if (x0 > y0) {\r\n      // lower triangle, XY order: (0,0)->(1,0)->(1,1)\r\n      i1 = 1;\r\n      j1 = 0;\r\n    } else {\r\n      // upper triangle, YX order: (0,0)->(0,1)->(1,1)\r\n      i1 = 0;\r\n      j1 = 1;\r\n    }\r\n    // A step of (1,0) in (i,j) means a step of (1-c,-c) in (x,y), and\r\n    // a step of (0,1) in (i,j) means a step of (-c,1-c) in (x,y), where\r\n    // c = (3-sqrt(3))/6\r\n    const x1 = x0 - i1 + G2; // Offsets for middle corner in (x,y) unskewed coords\r\n    const y1 = y0 - j1 + G2;\r\n    const x2 = x0 - 1 + 2 * G2; // Offsets for last corner in (x,y) unskewed coords\r\n    const y2 = y0 - 1 + 2 * G2;\r\n    // Work out the hashed gradient indices of the three simplex corners\r\n    i &= 255;\r\n    j &= 255;\r\n    const gi0 = this.gradP[i + this.perm[j]];\r\n    const gi1 = this.gradP[i + i1 + this.perm[j + j1]];\r\n    const gi2 = this.gradP[i + 1 + this.perm[j + 1]];\r\n    // Calculate the contribution from the three corners\r\n    let t0 = 0.5 - x0 * x0 - y0 * y0;\r\n    if (t0 < 0) {\r\n      n0 = 0;\r\n    } else {\r\n      t0 *= t0;\r\n      n0 = t0 * t0 * gi0.dot2(x0, y0); // (x,y) of grad3 used for 2D gradient\r\n    }\r\n    let t1 = 0.5 - x1 * x1 - y1 * y1;\r\n    if (t1 < 0) {\r\n      n1 = 0;\r\n    } else {\r\n      t1 *= t1;\r\n      n1 = t1 * t1 * gi1.dot2(x1, y1);\r\n    }\r\n    let t2 = 0.5 - x2 * x2 - y2 * y2;\r\n    if (t2 < 0) {\r\n      n2 = 0;\r\n    } else {\r\n      t2 *= t2;\r\n      n2 = t2 * t2 * gi2.dot2(x2, y2);\r\n    }\r\n    // Add contributions from each corner to get the final noise value.\r\n    // The result is scaled to return values in the interval [-1,1].\r\n    return 70 * (n0 + n1 + n2);\r\n  }\r\n\r\n  public octaveSimplex2(xin: number, yin: number, octaveNum = this.octaveNum, octaveFalloff = this.octaveFalloff) {\r\n    let sum = 0;\r\n    let x = xin;\r\n    let y = yin;\r\n    let scalar = 1;\r\n    for (let i = 0; i < octaveNum; i++) {\r\n      sum += this.simplex2(x, y) * scalar;\r\n      const newX = x * this.octaveMatrix2[0] + y * this.octaveMatrix2[1];\r\n      const newY = x * this.octaveMatrix2[2] + y * this.octaveMatrix2[3];\r\n      x = newX;\r\n      y = newY;\r\n      scalar *= octaveFalloff;\r\n    }\r\n    return sum;\r\n  }\r\n\r\n  // 3D simplex noise\r\n  public simplex3(xin: number, yin: number, zin: number) {\r\n    let n0, n1, n2, n3; // Noise contributions from the four corners\r\n\r\n    // Skew the input space to determine which simplex cell we're in\r\n    const s = (xin + yin + zin) * F3; // Hairy factor for 2D\r\n    let i = Math.floor(xin + s);\r\n    let j = Math.floor(yin + s);\r\n    let k = Math.floor(zin + s);\r\n\r\n    const t = (i + j + k) * G3;\r\n    const x0 = xin - i + t; // The x,y distances from the cell origin, unskewed.\r\n    const y0 = yin - j + t;\r\n    const z0 = zin - k + t;\r\n\r\n    // For the 3D case, the simplex shape is a slightly irregular tetrahedron.\r\n    // Determine which simplex we are in.\r\n    let i1, j1, k1; // Offsets for second corner of simplex in (i,j,k) coords\r\n    let i2, j2, k2; // Offsets for third corner of simplex in (i,j,k) coords\r\n    if (x0 >= y0) {\r\n      if (y0 >= z0) {\r\n        i1 = 1;\r\n        j1 = 0;\r\n        k1 = 0;\r\n        i2 = 1;\r\n        j2 = 1;\r\n        k2 = 0;\r\n      } else if (x0 >= z0) {\r\n        i1 = 1;\r\n        j1 = 0;\r\n        k1 = 0;\r\n        i2 = 1;\r\n        j2 = 0;\r\n        k2 = 1;\r\n      } else {\r\n        i1 = 0;\r\n        j1 = 0;\r\n        k1 = 1;\r\n        i2 = 1;\r\n        j2 = 0;\r\n        k2 = 1;\r\n      }\r\n    } else {\r\n      if (y0 < z0) {\r\n        i1 = 0;\r\n        j1 = 0;\r\n        k1 = 1;\r\n        i2 = 0;\r\n        j2 = 1;\r\n        k2 = 1;\r\n      } else if (x0 < z0) {\r\n        i1 = 0;\r\n        j1 = 1;\r\n        k1 = 0;\r\n        i2 = 0;\r\n        j2 = 1;\r\n        k2 = 1;\r\n      } else {\r\n        i1 = 0;\r\n        j1 = 1;\r\n        k1 = 0;\r\n        i2 = 1;\r\n        j2 = 1;\r\n        k2 = 0;\r\n      }\r\n    }\r\n    // A step of (1,0,0) in (i,j,k) means a step of (1-c,-c,-c) in (x,y,z),\r\n    // a step of (0,1,0) in (i,j,k) means a step of (-c,1-c,-c) in (x,y,z), and\r\n    // a step of (0,0,1) in (i,j,k) means a step of (-c,-c,1-c) in (x,y,z), where\r\n    // c = 1/6.\r\n    const x1 = x0 - i1 + G3; // Offsets for second corner\r\n    const y1 = y0 - j1 + G3;\r\n    const z1 = z0 - k1 + G3;\r\n\r\n    let x2 = x0 - i2 + 2 * G3; // Offsets for third corner\r\n    let y2 = y0 - j2 + 2 * G3;\r\n    let z2 = z0 - k2 + 2 * G3;\r\n\r\n    let x3 = x0 - 1 + 3 * G3; // Offsets for fourth corner\r\n    let y3 = y0 - 1 + 3 * G3;\r\n    let z3 = z0 - 1 + 3 * G3;\r\n\r\n    // Work out the hashed gradient indices of the four simplex corners\r\n    i &= 255;\r\n    j &= 255;\r\n    k &= 255;\r\n    const { gradP, perm } = this;\r\n    let gi0 = gradP[i + perm[j + perm[k]]];\r\n    let gi1 = gradP[i + i1 + perm[j + j1 + perm[k + k1]]];\r\n    let gi2 = gradP[i + i2 + perm[j + j2 + perm[k + k2]]];\r\n    let gi3 = gradP[i + 1 + perm[j + 1 + perm[k + 1]]];\r\n\r\n    // Calculate the contribution from the four corners\r\n    let t0 = 0.6 - x0 * x0 - y0 * y0 - z0 * z0;\r\n    if (t0 < 0) {\r\n      n0 = 0;\r\n    } else {\r\n      t0 *= t0;\r\n      n0 = t0 * t0 * gi0.dot3(x0, y0, z0); // (x,y) of grad3 used for 2D gradient\r\n    }\r\n    let t1 = 0.6 - x1 * x1 - y1 * y1 - z1 * z1;\r\n    if (t1 < 0) {\r\n      n1 = 0;\r\n    } else {\r\n      t1 *= t1;\r\n      n1 = t1 * t1 * gi1.dot3(x1, y1, z1);\r\n    }\r\n    let t2 = 0.6 - x2 * x2 - y2 * y2 - z2 * z2;\r\n    if (t2 < 0) {\r\n      n2 = 0;\r\n    } else {\r\n      t2 *= t2;\r\n      n2 = t2 * t2 * gi2.dot3(x2, y2, z2);\r\n    }\r\n    let t3 = 0.6 - x3 * x3 - y3 * y3 - z3 * z3;\r\n    if (t3 < 0) {\r\n      n3 = 0;\r\n    } else {\r\n      t3 *= t3;\r\n      n3 = t3 * t3 * gi3.dot3(x3, y3, z3);\r\n    }\r\n    // Add contributions from each corner to get the final noise value.\r\n    // The result is scaled to return values in the interval [-1,1].\r\n    return 32 * (n0 + n1 + n2 + n3);\r\n  }\r\n\r\n  public octaveSimplex3(\r\n    xin: number,\r\n    yin: number,\r\n    zin: number,\r\n    octaveNum = this.octaveNum,\r\n    octaveFalloff = this.octaveFalloff\r\n  ) {\r\n    let sum = 0;\r\n    let x = xin;\r\n    let y = yin;\r\n    let z = zin;\r\n    let scalar = 1;\r\n    for (let i = 0; i < octaveNum; i++) {\r\n      sum += this.simplex3(x, y, z) * scalar;\r\n      x *= 2;\r\n      y *= 2;\r\n      z *= 2;\r\n      scalar *= octaveFalloff;\r\n    }\r\n    return sum;\r\n  }\r\n\r\n  // ##### Perlin noise stuff\r\n\r\n  public fade(t: number) {\r\n    return t * t * t * (t * (t * 6 - 15) + 10);\r\n  }\r\n\r\n  public lerp(a: number, b: number, t: number) {\r\n    return (1 - t) * a + t * b;\r\n  }\r\n\r\n  // 2D Perlin Noise\r\n  public perlin2(x: number, y: number) {\r\n    // Find unit grid cell containing point\r\n    let X = Math.floor(x),\r\n      Y = Math.floor(y);\r\n    // Get relative xy coordinates of point within that cell\r\n    x = x - X;\r\n    y = y - Y;\r\n    // Wrap the integer cells at 255 (smaller integer period can be introduced here)\r\n    X = X & 255;\r\n    Y = Y & 255;\r\n\r\n    const { gradP, perm } = this;\r\n    // Calculate noise contributions from each of the four corners\r\n    let n00 = gradP[X + perm[Y]].dot2(x, y);\r\n    let n01 = gradP[X + perm[Y + 1]].dot2(x, y - 1);\r\n    let n10 = gradP[X + 1 + perm[Y]].dot2(x - 1, y);\r\n    let n11 = gradP[X + 1 + perm[Y + 1]].dot2(x - 1, y - 1);\r\n\r\n    // Compute the fade curve value for x\r\n    let u = this.fade(x);\r\n\r\n    // Interpolate the four results\r\n    return this.lerp(this.lerp(n00, n10, u), this.lerp(n01, n11, u), this.fade(y));\r\n  }\r\n\r\n  // 3D Perlin Noise\r\n  public perlin3(x: number, y: number, z: number) {\r\n    const { gradP, perm } = this;\r\n    // Find unit grid cell containing point\r\n    let X = Math.floor(x),\r\n      Y = Math.floor(y),\r\n      Z = Math.floor(z);\r\n    // Get relative xyz coordinates of point within that cell\r\n    x = x - X;\r\n    y = y - Y;\r\n    z = z - Z;\r\n    // Wrap the integer cells at 255 (smaller integer period can be introduced here)\r\n    X = X & 255;\r\n    Y = Y & 255;\r\n    Z = Z & 255;\r\n\r\n    // Calculate noise contributions from each of the eight corners\r\n    let n000 = gradP[X + perm[Y + perm[Z]]].dot3(x, y, z);\r\n    let n001 = gradP[X + perm[Y + perm[Z + 1]]].dot3(x, y, z - 1);\r\n    let n010 = gradP[X + perm[Y + 1 + perm[Z]]].dot3(x, y - 1, z);\r\n    let n011 = gradP[X + perm[Y + 1 + perm[Z + 1]]].dot3(x, y - 1, z - 1);\r\n    let n100 = gradP[X + 1 + perm[Y + perm[Z]]].dot3(x - 1, y, z);\r\n    let n101 = gradP[X + 1 + perm[Y + perm[Z + 1]]].dot3(x - 1, y, z - 1);\r\n    let n110 = gradP[X + 1 + perm[Y + 1 + perm[Z]]].dot3(x - 1, y - 1, z);\r\n    let n111 = gradP[X + 1 + perm[Y + 1 + perm[Z + 1]]].dot3(x - 1, y - 1, z - 1);\r\n\r\n    // Compute the fade curve value for x, y, z\r\n    let u = this.fade(x);\r\n    let v = this.fade(y);\r\n    let w = this.fade(z);\r\n\r\n    // Interpolate\r\n    return this.lerp(\r\n      this.lerp(this.lerp(n000, n100, u), this.lerp(n001, n101, u), w),\r\n      this.lerp(this.lerp(n010, n110, u), this.lerp(n011, n111, u), w),\r\n      v\r\n    );\r\n  }\r\n}\r\n","import { Inventory } from \"../inventory\";\r\nimport { Tile } from \"./tile\";\r\n\r\nexport class DeadCell extends Tile {\r\n  displayName = \"Dead Cell\";\r\n\r\n  isStructuralSupport = true;\r\n\r\n  isObstacle = false;\r\n\r\n  inventory = new Inventory(0, this);\r\n\r\n  shouldStep(dt: number) {\r\n    return dt > 0.3;\r\n  }\r\n}\r\n","import { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneDiffuseWater = Gene.make(\r\n  {\r\n    name: \"Diffuse Water\",\r\n    levelCosts: [0, 1, 2, 3, 5],\r\n    static: {\r\n      diffusionWater: [0.08, 0.1, 0.12, 0.15, 0.2],\r\n    },\r\n    levelProps: {},\r\n    description: (props, { diffusionWater }) => (\r\n      <>\r\n        <p>\r\n          Continuously recieve <ResourceIcon name=\"water\" /> from neighboring Cells with more.\r\n        </p>\r\n        <p>\r\n          On average, get 1<ResourceIcon name=\"water\" /> every <GN value={1 / diffusionWater!} sigFigs={3} /> seconds.\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneDiffuseWater = typeof GeneDiffuseWater;\r\n","import { Interactable } from \"core/interactable\";\r\nimport { Action } from \"core/player/action\";\r\nimport { Vector2 } from \"three\";\r\nimport { Noise } from \"../../common/perlin\";\r\nimport { map } from \"../../math/index\";\r\nimport { Inventory } from \"../inventory\";\r\nimport { World } from \"../world/world\";\r\nimport { Tile } from \"./tile\";\r\nexport class Air extends Tile implements Interactable {\r\n  displayName = \"Air\";\r\n\r\n  static fallAmount = 30;\r\n\r\n  static diffusionWater = 1.5;\r\n\r\n  public sunlightCached: number = 1;\r\n\r\n  public _co2: number;\r\n\r\n  public inventory = new Inventory(6, this);\r\n\r\n  isObstacle = false;\r\n\r\n  public constructor(public pos: Vector2, world: World) {\r\n    super(pos, world);\r\n    this.darkness = 0;\r\n    this._co2 = this.computeCo2();\r\n  }\r\n\r\n  interact(): Action {\r\n    return {\r\n      type: \"pickup\",\r\n      water: 0.1,\r\n      sugar: 0.1,\r\n      target: this,\r\n      continuous: true,\r\n    };\r\n  }\r\n\r\n  // Careful - this affects gravity speed\r\n  shouldStep(dt: number) {\r\n    // if (!this.inventory.isEmpty()) {\r\n    return dt > 0.06667;\r\n    // } else {\r\n    //   return super.shouldStep(dt);\r\n    // }\r\n  }\r\n\r\n  private computeCo2() {\r\n    const base = map(this.pos.y, this.world.height / 2, 0, this.world.environment.floorCo2, 1.15);\r\n    const scaleX = Math.max(1, map(this.pos.y, this.world.height / 2, 0, 4, 9));\r\n    // const offset = noiseCo2.perlin3(94.2321 - this.pos.x / scaleX, 3221 - this.pos.y / 2.5, world.time / 5 + 93.1) * 0.2;\r\n    const time = this.world == null ? 0 : this.world.time;\r\n    const offset =\r\n      noiseCo2.perlin3(\r\n        94.231 + (this.pos.x - this.world.width / 2) / scaleX,\r\n        2312 + this.pos.y / 8,\r\n        time / 1000 + 93.1\r\n      ) * 0.25;\r\n    return Math.max(Math.min(base + offset, 1), Math.min(0.4, this.world.environment.floorCo2 * 0.75));\r\n  }\r\n\r\n  public lightAmount() {\r\n    return this.sunlight();\r\n  }\r\n\r\n  step(dt: number) {\r\n    // we do NOT call super, to avoid stepping darkness and diffusion.\r\n    this.stepGravity(dt);\r\n    const tileBelow = this.world.tileAt(this.pos.x, this.pos.y + 1);\r\n    if (!(tileBelow instanceof Air)) {\r\n      this.stepDiffusionCheap(dt);\r\n    }\r\n    this.stepEvaporation(dt);\r\n    this.stepTemperature(dt);\r\n    this._co2 = this.computeCo2();\r\n  }\r\n\r\n  stepDiffusionCheap(dt: number) {\r\n    // only take water from left and right\r\n    const left = this.world.tileAt(this.pos.x - 1, this.pos.y);\r\n    const right = this.world.tileAt(this.pos.x + 1, this.pos.y);\r\n    // randomize order to remove directional bias\r\n    if (Math.random() < 0.5) {\r\n      this.tryDiffuse(left, dt);\r\n      this.tryDiffuse(right, dt);\r\n    } else {\r\n      this.tryDiffuse(right, dt);\r\n      this.tryDiffuse(left, dt);\r\n    }\r\n  }\r\n\r\n  tryDiffuse(t: Tile | null, dt: number) {\r\n    if (t != null && t.canPullResources(this)) {\r\n      if (t.inventory.water < this.inventory.water) {\r\n        t.diffuseWater(this, dt);\r\n        // this.diffuseWater(t, dt);\r\n      }\r\n    }\r\n  }\r\n\r\n  stepEvaporation(dt: number) {\r\n    if (Math.random() < this.world.environment.airEvaporation * this.inventory.water * dt) {\r\n      this.world.numEvaporatedAir += 1;\r\n      this.inventory.add(-1, 0);\r\n      this.world.logEvent({ type: \"evaporation\", tile: this });\r\n    }\r\n  }\r\n\r\n  public co2() {\r\n    return this._co2;\r\n  }\r\n\r\n  public sunlight() {\r\n    return this.sunlightCached;\r\n  }\r\n}\r\nconst noiseCo2 = new Noise();\r\n","import { DIRECTIONS, Directions } from \"core/directions\";\r\nimport React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport GN from \"./GN\";\r\nimport RI from \"./RI\";\r\n\r\nexport const GenePipes = Gene.make(\r\n  {\r\n    name: \"Pipes\",\r\n    levelCosts: [1, 2, 3, 5, 8],\r\n    levelProps: {\r\n      diffusionRate: [0.025, 0.05, 0.1, 0.2, 0.4],\r\n    },\r\n    description: ({ diffusionRate }) => (\r\n      <>\r\n        <b>Hold Shift to configure.</b>\r\n        <p>\r\n          Continuously equalize <RI w /> <RI s /> between connected cells.\r\n        </p>\r\n        <p>\r\n          On average, exchange 1 sugar and 1 water every <GN value={1 / diffusionRate} sigFigs={3} /> seconds.\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  () => ({\r\n    connections: {\r\n      n: false,\r\n      e: false,\r\n      s: false,\r\n      w: false,\r\n    } as PipesConnections,\r\n  }),\r\n  (dt, { cell, props: { diffusionRate }, state: { connections } }) => {\r\n    let directionName: Directions;\r\n    for (directionName in connections) {\r\n      if (connections[directionName]) {\r\n        const direction = DIRECTIONS[directionName];\r\n        const neighbor = cell.world.cellAt(cell.pos.x + direction.x, cell.pos.y + direction.y);\r\n        if (neighbor) {\r\n          cell.diffuseWater(neighbor, dt, diffusionRate);\r\n          neighbor.diffuseWater(cell, dt, diffusionRate);\r\n          cell.diffuseSugar(neighbor, dt, diffusionRate);\r\n          neighbor.diffuseSugar(cell, dt, diffusionRate);\r\n        }\r\n      }\r\n    }\r\n  }\r\n);\r\nexport type GenePipes = typeof GenePipes;\r\n\r\nexport type PipesConnections = Partial<Record<Directions, boolean>>;\r\n","import { Cell } from \"core/cell\";\r\n\r\n/**\r\n * Find a neighboring cell with resources, and try to take water and sugar from it.\r\n */\r\nexport function takeFromOneNeighborCell(cell: Cell, water: number, sugar: number) {\r\n  const neighbors = cell.world.tileNeighbors(cell.pos);\r\n  for (const [, tile] of neighbors) {\r\n    if (tile instanceof Cell) {\r\n      const { water: waterTaken, sugar: sugarTaken } = tile.inventory.give(cell.inventory, water, sugar);\r\n      if (waterTaken > 0 || sugarTaken > 0) {\r\n        break;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { takeFromOneNeighborCell } from \"std/geneUtil\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport RI from \"./RI\";\r\n\r\nexport const GeneAttractsSugar = Gene.make(\r\n  {\r\n    name: \"Attracts Sugar\",\r\n    levelCosts: [1, 2, 3, 4, 5],\r\n    levelProps: {\r\n      secondsPerPull: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerPull }) => (\r\n      <>\r\n        Every <GN value={secondsPerPull} sigFigs={2} /> seconds, take 1<RI s /> from any neighboring Cell.\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    cooldown: 0,\r\n  },\r\n  (dt, { cell, state, props: { secondsPerPull } }) => {\r\n    if (state.cooldown <= 0) {\r\n      takeFromOneNeighborCell(cell, 0, 1);\r\n      state.cooldown += secondsPerPull;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneAttractsSugar = typeof GeneAttractsSugar;\r\n","import { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneCannotFreeze = Gene.make(\r\n  {\r\n    name: \"Cannot Freeze\",\r\n    levelCosts: [7],\r\n    levelProps: {},\r\n    static: {\r\n      cantFreeze: true,\r\n    },\r\n    description: () => null,\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\n","import { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Vector2 } from \"three\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport { Air } from \"../../core/tile/air\";\r\n\r\nexport interface PhotosynthesisState {\r\n  totalSugarProduced: number;\r\n  averageConversionRate: number;\r\n  averageChancePerSecond: number;\r\n  sugarConverted: number;\r\n  activeNeighbors: Vector2[];\r\n}\r\n\r\nexport const GenePhotosynthesis = Gene.make<PhotosynthesisState>(\r\n  {\r\n    name: \"Photosynthesis\",\r\n    levelCosts: [3, 6, 9, 12, 15],\r\n    levelProps: {\r\n      reactionChancePerSecond: [0.0125, 0.025, 0.05, 0.1, 0.2],\r\n    },\r\n    description: ({ reactionChancePerSecond }) => (\r\n      <>\r\n        <p>\r\n          Converts 2<ResourceIcon name=\"water\" /> into 1<ResourceIcon name=\"sugar\" />.\r\n        </p>\r\n        <p>\r\n          Each neighboring Air provides a <GN value={reactionChancePerSecond * 100} sigFigs={3} />% chance per second,\r\n          scaled with sunlight.\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    totalSugarProduced: 0,\r\n    averageConversionRate: 0,\r\n    averageChancePerSecond: 0,\r\n    sugarConverted: 0,\r\n    activeNeighbors: [],\r\n  },\r\n  (dt, { cell, state, props: { reactionChancePerSecond } }) => {\r\n    state.averageConversionRate = 0;\r\n    state.averageChancePerSecond = 0;\r\n    state.sugarConverted = 0;\r\n    state.activeNeighbors = [];\r\n\r\n    const neighbors = cell.world.tileNeighbors(cell.pos);\r\n    let numAir = 0;\r\n    for (const [dir, tile] of neighbors) {\r\n      if (tile instanceof Air) {\r\n        state.activeNeighbors.push(dir);\r\n        numAir += 1;\r\n        maybePhotosynthesize(dt, tile, cell, reactionChancePerSecond, state);\r\n      }\r\n    }\r\n    if (numAir > 0) {\r\n      state.averageConversionRate /= numAir;\r\n      // this.averageSpeed /= numAir;\r\n    }\r\n  }\r\n);\r\nexport type GenePhotosynthesis = typeof GenePhotosynthesis;\r\n\r\nfunction maybePhotosynthesize(\r\n  dt: number,\r\n  air: Air,\r\n  cell: Cell,\r\n  reactionChancePerSecond: number,\r\n  state: PhotosynthesisState\r\n) {\r\n  const sunlight = air.sunlight();\r\n\r\n  // gives much less sugar lower down\r\n  // const conversionRate = air.co2();\r\n\r\n  const conversionRate = 0.5;\r\n  state.averageConversionRate += conversionRate;\r\n  // in prime conditions:\r\n  //      our rate of conversion is speed * params.leafReactionRate\r\n  //      we get 1 sugar at 1/efficiencyRatio (> 1) water\r\n  // if we have less than 1/efficiencyRatio water\r\n  //      our rate of conversion scales down proportionally\r\n  //      on conversion, we use up all the available water and get the corresponding amount of sugar\r\n  const bestEfficiencyWater = 1 / conversionRate;\r\n  const waterToConvert = Math.min(cell.inventory.water, bestEfficiencyWater);\r\n\r\n  const ambientChancePerSecond = reactionChancePerSecond * sunlight;\r\n  // this.sunlightCollected += chance * dt;\r\n  if (waterToConvert > 0 && ambientChancePerSecond > 0) {\r\n    cell.world.logEvent({\r\n      type: \"collect-sunlight\",\r\n      leaf: cell,\r\n      air,\r\n      // the renderer creates one dot per sunlight unit.\r\n      // 0.05 normalizes chancePerSecond (which is 0.075 for photosynthesis 3),\r\n      // * 5 means photosynthesis 3 gets 5 dots per second per air (this is the new player experience)\r\n      numSunlight: (ambientChancePerSecond / 0.05) * dt * 5,\r\n    });\r\n  }\r\n\r\n  // let intersectionChancePerSecond = 0;\r\n  // if (cell.world.occluderManager.getIntersection(cell) != null) {\r\n  //   intersectionChancePerSecond = reactionChancePerSecond * sunlight * 5;\r\n  //   const p = cell.lightIntersection.point;\r\n  //   cell.world.logEvent({\r\n  //     type: \"collect-sunlight\",\r\n  //     leaf: cell,\r\n  //     air,\r\n  //     // the renderer creates one dot per sunlight unit.\r\n  //     // 0.025 normalizes chancePerSecond (which is 0.025 for photosynthesis 3),\r\n  //     // * 20 means photosynthesis 3 gets 20 dots per second (this is the new player experience)\r\n  //     numSunlight: (intersectionChancePerSecond / 0.025) * dt * 20,\r\n  //     point: new Vector2(p.x, p.y),\r\n  //   });\r\n  // }\r\n  // let chancePerSecond = ambientChancePerSecond + intersectionChancePerSecond; // * (waterToConvert / bestEfficiencyWater);\r\n\r\n  const chancePerSecond = ambientChancePerSecond;\r\n\r\n  state.averageChancePerSecond += chancePerSecond;\r\n\r\n  if (Math.random() < chancePerSecond * dt && waterToConvert > 0) {\r\n    const sugarMade = waterToConvert * conversionRate;\r\n    cell.inventory.add(-waterToConvert, sugarMade);\r\n    state.sugarConverted += sugarMade;\r\n    state.totalSugarProduced += sugarMade;\r\n    cell.world.logEvent({\r\n      type: \"photosynthesis\",\r\n      cell,\r\n      sugarMade,\r\n    });\r\n  }\r\n}\r\n","import { buildComplete } from \"game/audio\";\r\nimport { randFloat } from \"math\";\r\nimport { Vector2 } from \"three\";\r\nimport { GeneLiving } from \"../../std/genes\";\r\nimport { GeneObstacle } from \"../../std/genes/GeneObstacle\";\r\nimport { World } from \"../world/world\";\r\nimport { Cell } from \"./cell\";\r\nimport Chromosome from \"./chromosome\";\r\nimport { CellType } from \"./genome\";\r\n\r\nconst chromosomeGrowingCell = new Chromosome(GeneLiving.level(2), GeneObstacle.level(0));\r\n\r\nexport class GrowingCell extends Cell {\r\n  public percentGrown = 0;\r\n\r\n  public timeToGrow: number;\r\n\r\n  silent?: boolean;\r\n\r\n  constructor(pos: Vector2, world: World, public completedCell: Cell, public start: Vector2) {\r\n    super(pos, world, cellTypeGrowingCell);\r\n    this.timeToGrow = Math.max(completedCell.timeToBuild, 0.00001);\r\n  }\r\n\r\n  step(dt: number) {\r\n    super.step(dt);\r\n    this.percentGrown += (this.tempo * dt) / this.timeToGrow;\r\n    this.completedCell.pos.copy(this.pos);\r\n    if (this.percentGrown >= 1) {\r\n      this.world.maybeRemoveCellAt(this.pos);\r\n      this.completedCell.energy = this.energy;\r\n      for (const effect of this.effects) {\r\n        this.completedCell.addEffect(effect);\r\n      }\r\n      this.world.setTileAt(this.pos, this.completedCell);\r\n      if (!this.silent) {\r\n        const id = buildComplete.play();\r\n        buildComplete.rate(id, randFloat(0.5, 1));\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nconst cellTypeGrowingCell = new CellType(\"Growing Cell\", 0, chromosomeGrowingCell);\r\n","import { CELL_BUILD_TIME } from \"core/constants\";\r\n\r\nexport type CellProperties = {\r\n  cantFreeze: boolean;\r\n  isReproductive: boolean;\r\n  isDirectional: boolean;\r\n  isObstacle: boolean;\r\n  inventoryCapacity: number;\r\n  /**\r\n   * Sugar cost to build.\r\n   */\r\n  costSugar: number;\r\n  /**\r\n   * Water cost to build.\r\n   */\r\n  costWater: number;\r\n  diffusionWater: number;\r\n  diffusionSugar: number;\r\n  /**\r\n   * Seconds it take to build.\r\n   */\r\n  timeToBuild: number;\r\n  /**\r\n   * How fast Genes and Effects happen on the cell.\r\n   */\r\n  tempo: number;\r\n  /**\r\n   * How much energy per second this cell burns.\r\n   */\r\n  energyUpkeep: number;\r\n  [k: string]: number | boolean;\r\n};\r\n\r\nexport function defaultCellProperties(): CellProperties {\r\n  return {\r\n    cantFreeze: false,\r\n    isReproductive: false,\r\n    isObstacle: false,\r\n    inventoryCapacity: 0,\r\n    costSugar: 1,\r\n    costWater: 1,\r\n    diffusionWater: 0,\r\n    diffusionSugar: 0,\r\n    tempo: 1,\r\n    energyUpkeep: 0,\r\n    timeToBuild: CELL_BUILD_TIME,\r\n    isDirectional: false,\r\n  };\r\n}\r\n","import { Steppable } from \"../entity\";\r\nimport { Cell } from \"../tile\";\r\nimport { Gene, RealizedProps } from \"./gene\";\r\n\r\ntype GeneState<G extends Gene> = G extends Gene<infer S, any> ? S : never;\r\n\r\ntype GenePropNames<G extends Gene> = G extends Gene<any, infer K> ? K : never;\r\n\r\nexport class GeneInstance<G extends Gene, S = GeneState<G>, K extends string = GenePropNames<G>> implements Steppable {\r\n  public dtSinceLastStepped = 0;\r\n\r\n  public state: S;\r\n\r\n  public get blueprint() {\r\n    return this.gene.blueprint;\r\n  }\r\n\r\n  constructor(public gene: G, public props: RealizedProps<K>, public cell: Cell) {\r\n    this.state = gene.initialStateFn(gene, props, cell);\r\n  }\r\n\r\n  public isType<S, K extends string>(gene: Gene<S, K>): this is GeneInstance<Gene<S, K>> {\r\n    return this.gene === gene;\r\n  }\r\n\r\n  shouldStep(dt: number): boolean {\r\n    return this.gene.shouldStepFn(dt, this);\r\n  }\r\n\r\n  step(dt: number) {\r\n    const maybeNewState = this.gene.stepFn(dt, this);\r\n    if (maybeNewState !== undefined) {\r\n      this.state = maybeNewState;\r\n    }\r\n  }\r\n\r\n  earnMP(cell: Cell, mpEarned: number) {\r\n    cell.world.earnMP(cell, mpEarned);\r\n  }\r\n}\r\n","import { createSimpleSchema, object } from \"serializr\";\r\nimport { Color, Vector2 } from \"three\";\r\n\r\nexport interface MaterialInfo {\r\n  /**\r\n   * If unspecified, means white but respect transparency\r\n   */\r\n  color?: Color;\r\n\r\n  texturePosition: Vector2;\r\n}\r\n\r\nexport const MaterialInfoSchema = createSimpleSchema({\r\n  color: object(Color),\r\n  texturePosition: object(Vector2),\r\n});\r\n","import { Action } from \"./player/action\";\r\nimport { Player } from \"./player/player\";\r\n\r\n/**\r\n * This thing can be interacted with by the player.\r\n */\r\nexport interface Interactable {\r\n  /**\r\n   * What action, if any, the player should take when\r\n   * interacted on by the player.\r\n   */\r\n  interact(source: Player): Action | undefined;\r\n}\r\n\r\nexport function isInteractable<T>(e: T): e is Interactable & T {\r\n  return typeof (e as any).interact === \"function\";\r\n}\r\n","import { Inventory } from \"core/inventory\";\r\nimport { Tile } from \"core/tile/tile\";\r\nexport class BarrenLand extends Tile {\r\n  displayName = \"Barren Land\";\r\n\r\n  public isObstacle = false;\r\n\r\n  public isStructuralSupport = true;\r\n\r\n  shouldStep(dt: number): boolean {\r\n    return dt > 0.2;\r\n  }\r\n\r\n  public inventory = new Inventory(1, this);\r\n}\r\n","import { Air } from \"core/tile\";\r\nimport React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nconst GROWTH_RATE = 2;\r\nconst NEIGHBORING_AIR_NEEDED = 5;\r\n\r\nexport const GeneAiryExpansion = Gene.make({\r\n  name: \"Airy Expansion\",\r\n  levelCosts: [2],\r\n  levelProps: {},\r\n  description: () => (\r\n    <>\r\n      Grow at <b>{GROWTH_RATE * 100}%</b> speed if there's <b>{NEIGHBORING_AIR_NEEDED}</b> or more neighboring Air\r\n      (diagonals included).\r\n    </>\r\n  ),\r\n  dynamic(cell, properties) {\r\n    // relies on the fact that cell is in the same position as the growing cell.\r\n    const neighbors = Array.from(cell.world.tileNeighbors(cell.pos).values());\r\n    if (neighbors.filter((t) => t instanceof Air).length >= NEIGHBORING_AIR_NEEDED) {\r\n      properties.timeToBuild /= GROWTH_RATE;\r\n    }\r\n    return properties;\r\n  },\r\n});\r\nexport type GeneAiryExpansion = typeof GeneAiryExpansion;\r\n","import { randFloat } from \"math\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { takeFromOneNeighborCell } from \"std/geneUtil\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport RI from \"./RI\";\r\n\r\nexport const GeneAttractsWater = Gene.make(\r\n  {\r\n    name: \"Attracts Water\",\r\n    levelCosts: [1, 2, 3, 4, 5],\r\n    levelProps: {\r\n      secondsPerPull: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerPull }) => (\r\n      <>\r\n        Every <GN value={secondsPerPull} sigFigs={2} /> seconds, take 1<RI w /> from any neighboring Cell.\r\n      </>\r\n    ),\r\n  },\r\n  (gene, props) => ({\r\n    cooldown: randFloat(0, props.secondsPerPull),\r\n  }),\r\n  (dt, { cell, state, props: { secondsPerPull } }) => {\r\n    if (state.cooldown <= 0) {\r\n      takeFromOneNeighborCell(cell, 1, 0);\r\n      state.cooldown += secondsPerPull;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneAttractsWater = typeof GeneAttractsWater;\r\n","import { TIME_PER_DAY } from \"core/constants\";\r\nimport { Air, DeadCell } from \"core/tile\";\r\nimport React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport RI from \"./RI\";\r\n\r\nexport const GeneBark = Gene.make(\r\n  {\r\n    name: \"Bark\",\r\n    levelCosts: [2],\r\n    levelProps: {\r\n      timeBeforeGrowth: TIME_PER_DAY,\r\n    },\r\n    static: {\r\n      costSugar: 1,\r\n      costWater: 1,\r\n    },\r\n    description: ({ timeBeforeGrowth }) => (\r\n      <>\r\n        <p>\r\n          This cell costs 1<RI w />1<RI s /> more to grow.\r\n        </p>\r\n        <p>\r\n          <b>{timeBeforeGrowth} seconds</b> after growth, this cell emits a Dead Cell on each directly neighboring Air.\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  () => ({\r\n    tried: false,\r\n  }),\r\n  (dt, { cell, state, props }) => {\r\n    if (!state.tried && cell.age > props.timeBeforeGrowth) {\r\n      const neighbors = cell.world.tileNeighbors(cell.pos);\r\n      for (const [, tile] of neighbors) {\r\n        if (tile.pos.manhattanDistanceTo(cell.pos) <= 1 && tile instanceof Air) {\r\n          const deadCell = new DeadCell(tile.pos, tile.world);\r\n          tile.world.setTileAt(deadCell.pos, deadCell);\r\n        }\r\n      }\r\n      state.tried = true;\r\n    }\r\n  }\r\n);\r\nexport type GeneBark = typeof GeneBark;\r\n","import { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nexport const GeneCostly = Gene.make(\r\n  {\r\n    name: \"Costly\",\r\n    levelCosts: [-3, -4, -5, -6, -8],\r\n    levelProps: {},\r\n    static: {\r\n      costSugar: [2, 3, 4, 5, 8],\r\n      costWater: [2, 3, 4, 5, 8],\r\n    },\r\n    description: (_, { costSugar, costWater }) => (\r\n      <>\r\n        This cell costs {costWater}\r\n        <ResourceIcon name=\"water\" />\r\n        {costSugar}\r\n        <ResourceIcon name=\"sugar\" /> more to grow.\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneCostly = typeof GeneCostly;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport RI from \"./RI\";\r\n\r\nexport const GeneDiffuseSugar = Gene.make(\r\n  {\r\n    name: \"Diffuse Sugar\",\r\n    levelCosts: [0, 1, 2, 3, 5],\r\n    static: {\r\n      diffusionSugar: [0.08, 0.1, 0.12, 0.15, 0.2],\r\n    },\r\n    levelProps: {},\r\n    description: (props, { diffusionSugar }) => (\r\n      <>\r\n        <p>\r\n          Continuously recieve <RI s /> from neighboring Cells with more.\r\n        </p>\r\n        <p>\r\n          On average, get 1<RI s /> every <GN value={1 / diffusionSugar!} sigFigs={3} /> seconds.\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneDiffuseSugar = typeof GeneDiffuseSugar;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneEnergyTransfer = Gene.make(\r\n  {\r\n    name: \"Energy Transfer\",\r\n    levelCosts: [1, 3, 4, 5, 7],\r\n    levelProps: {\r\n      differenceThreshold: [0.08, 0.04, 0.02, 0.01, 0.005],\r\n    },\r\n    description: ({ differenceThreshold }) => (\r\n      <>\r\n        <p>\r\n          Give energy to neighboring Cells until they're within <GN value={differenceThreshold * 100} sigFigs={3} />%\r\n          energy difference of this Cell.\r\n        </p>\r\n        <p>Gives up to {ENERGY_GIVE_RATE * 100}% energy per second.</p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  (dt, { cell, props: { differenceThreshold } }) => {\r\n    const tileNeighbors = cell.world.tileNeighbors(cell.pos);\r\n    for (const [, neighbor] of tileNeighbors) {\r\n      if (neighbor.pos.manhattanDistanceTo(cell.pos) > 1 || !(neighbor instanceof Cell)) continue;\r\n      maybeGiveEnergy(dt, cell, neighbor, differenceThreshold);\r\n    }\r\n  }\r\n);\r\n\r\nconst ENERGY_GIVE_RATE = 0.25;\r\n\r\nfunction maybeGiveEnergy(dt: number, cell: Cell, neighbor: Cell, differenceThreshold: number) {\r\n  const difference = cell.energy - neighbor.energy;\r\n  if (difference > differenceThreshold) {\r\n    const energyToGive = Math.min(difference - differenceThreshold, ENERGY_GIVE_RATE * dt);\r\n    // safe method but lower upper bound on equalization rate\r\n    // energyTransfer = Math.floor((neighbor.energy - this.energy) / energeticNeighbors.length);\r\n\r\n    // this may be unstable w/o double buffering\r\n    cell.energy -= energyToGive;\r\n    neighbor.energy += energyToGive;\r\n    cell.world.logEvent({ type: \"cell-transfer-energy\", from: cell, to: neighbor, amount: energyToGive });\r\n  }\r\n}\r\n\r\nexport type GeneEnergyTransfer = typeof GeneEnergyTransfer;\r\n","import { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nconst WATER_MIN = 2;\r\nconst WATER_MAX = 5;\r\nconst PERCENT_FASTER = 1;\r\n\r\nexport const GeneHydrostasis = Gene.make({\r\n  name: \"Hydrostasis\",\r\n  levelCosts: [4],\r\n  levelProps: {},\r\n  description: () => (\r\n    <>\r\n      If this cell holds between {WATER_MIN} and {WATER_MAX} <ResourceIcon name=\"water\" />, it operates{\" \"}\r\n      <b>{PERCENT_FASTER * 100}%</b> faster.\r\n    </>\r\n  ),\r\n  dynamic(cell, properties) {\r\n    const { water } = cell.inventory;\r\n    if (water >= WATER_MIN && water <= WATER_MAX) {\r\n      properties.tempo *= 1 + PERCENT_FASTER;\r\n    }\r\n    return properties;\r\n  },\r\n});\r\nexport type GeneHydrostasis = typeof GeneHydrostasis;\r\n","import { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nexport const GeneInventory = Gene.make(\r\n  {\r\n    name: \"Inventory\",\r\n    levelCosts: [1, 2, 3, 4, 5],\r\n    levelProps: {},\r\n    static: {\r\n      inventoryCapacity: [2, 3, 5, 8, 11],\r\n    },\r\n    description: (_, { inventoryCapacity }) => (\r\n      <>\r\n        Allows cell to hold <ResourceIcon name=\"water\" />\r\n        <ResourceIcon name=\"sugar\" />. Capacity +<GN value={inventoryCapacity!} />.\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneInventory = typeof GeneInventory;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nexport const GeneLiving = Gene.make(\r\n  {\r\n    name: \"Living\",\r\n    levelCosts: [-6, -8, -10, -12, -15],\r\n    levelProps: {\r\n      secondsPerUpkeep: [540, 450, 360, 240, 120],\r\n    },\r\n    description: ({ secondsPerUpkeep }) => (\r\n      <>\r\n        Burns 100% energy every <GN value={secondsPerUpkeep} /> seconds.\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  (dt, { cell, props: { secondsPerUpkeep } }) => {\r\n    cell.energy -= (1 / secondsPerUpkeep) * dt;\r\n  }\r\n);\r\nexport type GeneLiving = typeof GeneLiving;\r\n","import { nf } from \"common/formatters\";\r\nimport { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneMetabolism = Gene.make(\r\n  {\r\n    name: \"Metabolism\",\r\n    levelCosts: [0, 1, 3, 6, 10],\r\n    levelProps: {\r\n      energyPerSugar: [0.25, 0.5, 1, 1.5, 2],\r\n    },\r\n    static: {\r\n      // energyUpkeep: 1 / 600,\r\n    },\r\n    description: ({ energyPerSugar }) => (\r\n      <>\r\n        <p>\r\n          Convert 1<ResourceIcon name=\"sugar\" /> into <GN value={energyPerSugar * 100} sigFigs={3} />% energy.\r\n        </p>\r\n        <p>Starts below 95% energy. Restores {nf(EAT_ENERGY_PER_SECOND * 100, 3)}% energy per second.</p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  (dt, { cell, props: { energyPerSugar } }) => {\r\n    let maxEnergyToEat = getMaxEnergyToEat(cell, dt);\r\n    // eat from self\r\n    if (maxEnergyToEat > 0) {\r\n      // if this number goes up, we become less energy efficient\r\n      // if this number goes down, we are more energy efficient\r\n      maxEnergyToEat -= stepEatSugar(cell, maxEnergyToEat, energyPerSugar);\r\n    }\r\n  }\r\n);\r\nexport type GeneMetabolism = typeof GeneMetabolism;\r\n\r\nconst EAT_ENERGY_PER_SECOND = 0.333;\r\n\r\nfunction getMaxEnergyToEat(cell: Cell, dt: number) {\r\n  const hunger = 1 - cell.energy;\r\n  if (hunger < 0.05) {\r\n    return 0;\r\n  }\r\n  return Math.min(hunger, EAT_ENERGY_PER_SECOND * dt);\r\n}\r\n\r\nfunction stepEatSugar(cell: Cell, maxEnergyToEat: number, energyPerSugar: number): number {\r\n  const sugarToEat = Math.min(maxEnergyToEat / energyPerSugar, cell.inventory.sugar);\r\n  // eat if we're hungry\r\n  if (sugarToEat > 0) {\r\n    cell.inventory.add(0, -sugarToEat);\r\n    const gotEnergy = sugarToEat * energyPerSugar;\r\n    cell.energy += gotEnergy;\r\n    if (gotEnergy > 0) {\r\n      cell.world.logEvent({ type: \"cell-eat\", who: cell });\r\n    }\r\n    return gotEnergy;\r\n  }\r\n  return 0;\r\n}\r\n","import { Cell } from \"core/cell\";\r\nimport React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nconst NEIGHBORS_NEEDED = 6;\r\nconst PERCENT_FASTER = 1;\r\n\r\nexport const GeneNetworkEffect = Gene.make({\r\n  name: \"Network Effect\",\r\n  levelCosts: [4],\r\n  levelProps: {},\r\n  description: () => (\r\n    <>\r\n      If this cell has {NEIGHBORS_NEEDED} or more neighbors (diagonals included) of the same type, it operates{\" \"}\r\n      <b>{PERCENT_FASTER * 100}%</b> faster.\r\n    </>\r\n  ),\r\n  dynamic(cell, properties) {\r\n    const neighbors = Array.from(cell.world.tileNeighbors(cell.pos).values());\r\n    let numSameType = 0;\r\n    for (const n of neighbors) {\r\n      if (n instanceof Cell && n.type === cell.type) {\r\n        numSameType++;\r\n      }\r\n    }\r\n\r\n    if (numSameType >= NEIGHBORS_NEEDED) {\r\n      properties.tempo *= 1 + PERCENT_FASTER;\r\n    }\r\n    return properties;\r\n  },\r\n});\r\nexport type GeneNetworkEffect = typeof GeneNetworkEffect;\r\n","import { TIME_PER_DAY } from \"core/constants\";\r\nimport { Soil } from \"core/tile\";\r\nimport { BarrenLand } from \"core/tile/BarrenLand\";\r\nimport React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneNutrientExtraction = Gene.make(\r\n  {\r\n    name: \"Nutrient Extraction\",\r\n    levelCosts: [5],\r\n    levelProps: {\r\n      energyPerSecond: 0.02,\r\n    },\r\n    description: ({ energyPerSecond }) => (\r\n      <>\r\n        <p>\r\n          While this cell has a neighboring Soil, it gets <b>{energyPerSecond * 100}%</b> energy per second.\r\n        </p>\r\n        <p>\r\n          Every <b>{TIME_PER_DAY}</b> seconds, turn one neighboring Soil into Barren Land.{\" \"}\r\n          <i>(Barren Land is not a Soil).</i>\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    hasMonthPassed: false,\r\n    cooldown: TIME_PER_DAY,\r\n    soil: null as Soil | null,\r\n  },\r\n  (dt, { cell, props, state }) => {\r\n    // something else has bumped the soil\r\n    if (state.soil != null && cell.world.tileAt(state.soil.pos) !== state.soil) {\r\n      state.soil = null;\r\n    }\r\n    if (state.soil == null) {\r\n      const neighbors = cell.world.tileNeighbors(cell.pos);\r\n      for (const [, tile] of neighbors) {\r\n        if (tile instanceof Soil) {\r\n          state.soil = tile;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (state.soil != null) {\r\n      // cell.energy = clamp(cell.energy + props.energyPerSoilPerSecond * dt, 0, 1);\r\n      cell.energy += props.energyPerSecond * dt;\r\n      cell.world.logEvent({\r\n        type: \"cell-transfer-energy\",\r\n        amount: props.energyPerSecond * dt,\r\n        from: state.soil,\r\n        to: cell,\r\n      });\r\n      cell.world.logEvent({\r\n        type: \"cell-eat\",\r\n        who: state.soil,\r\n      });\r\n    }\r\n\r\n    if (state.cooldown <= 0 && state.soil != null) {\r\n      const barrenSoil = new BarrenLand(state.soil.pos, state.soil.world);\r\n      state.soil.world.setTileAt(barrenSoil.pos, barrenSoil);\r\n      state.soil = null;\r\n      state.cooldown += TIME_PER_DAY;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneNutrientExtraction = typeof GeneNutrientExtraction;\r\n","import React from \"react\";\r\nimport { takeFromOneNeighborCell } from \"std/geneUtil\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport RI from \"./RI\";\r\n\r\nexport const GeneOsmosis = Gene.make(\r\n  {\r\n    name: \"Osmosis\",\r\n    levelCosts: [4],\r\n    levelProps: {\r\n      secondsPerPull: 3,\r\n    },\r\n    static: {},\r\n    description: ({ secondsPerPull }) => (\r\n      <>\r\n        While this cell has more <RI s /> than <RI w />, take 1<RI w /> every {secondsPerPull} seconds from a neighbor.\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    cooldown: 0,\r\n    isOsmosising: false,\r\n  },\r\n  (dt, { cell, state, props: { secondsPerPull } }) => {\r\n    state.isOsmosising = cell.inventory.sugar > cell.inventory.water;\r\n    if (state.cooldown <= 0) {\r\n      if (state.isOsmosising) {\r\n        takeFromOneNeighborCell(cell, 1, 0);\r\n      }\r\n      state.cooldown += secondsPerPull;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneOsmosis = typeof GeneOsmosis;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GenePushWater = Gene.make(\r\n  {\r\n    name: \"Push Water\",\r\n    levelCosts: [1, 2, 3, 4, 5],\r\n    levelProps: {\r\n      secondsPerPull: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerPull }) => (\r\n      <>\r\n        Every <GN value={secondsPerPull} sigFigs={2} /> seconds, push 1 water from this Cell to each neighboring Cell.\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    cooldown: 0,\r\n  },\r\n  (dt, { cell, state, props: { secondsPerPull } }) => {\r\n    const neighbors = cell.world.tileNeighbors(cell.pos);\r\n    if (state.cooldown <= 0) {\r\n      for (const [, tile] of neighbors) {\r\n        // push water to nearby sources\r\n        if (tile instanceof Cell) {\r\n          // tile.inventory.give(cell.inventory, randRound(LEAF_WATER_INTAKE_PER_SECOND * dt), 0);\r\n          cell.inventory.give(tile.inventory, 1, 0);\r\n          // if (water > 0) {\r\n          //   break;\r\n          // }\r\n        }\r\n      }\r\n      state.cooldown += secondsPerPull;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GenePushWater = typeof GenePushWater;\r\n","import React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport GN from \"./GN\";\r\nexport const GeneScaffolding = Gene.make(\r\n  {\r\n    name: \"Scaffolding\",\r\n    levelCosts: [-2, -3, -4, -5, -10],\r\n    levelProps: {},\r\n    static: {\r\n      timeToBuild: [3, 4, 5, 6, 11],\r\n    },\r\n    description: (_, { timeToBuild }) => (\r\n      <>\r\n        This cell takes <GN value={timeToBuild!} /> seconds longer to grow.\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneScaffolding = typeof GeneScaffolding;\r\n","import { Cell } from \"core/cell\";\r\nimport { Soil } from \"core/tile\";\r\nimport { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Vector2 } from \"three\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport interface SoilAbsorptionState {\r\n  cooldown: number;\r\n  totalSucked: number;\r\n  activeNeighbors: Vector2[];\r\n}\r\n\r\nexport const GeneSoilAbsorption = Gene.make<SoilAbsorptionState>(\r\n  {\r\n    name: \"Soil Absorption\",\r\n    levelCosts: [4, 6, 8, 10, 12],\r\n    levelProps: {\r\n      secondsPerAbsorb: [60, 30, 15, 9, 6],\r\n    },\r\n    description: ({ secondsPerAbsorb }) => (\r\n      <>\r\n        Absorb 1<ResourceIcon name=\"water\" /> every <GN value={secondsPerAbsorb} /> seconds from every neighboring Soil.\r\n      </>\r\n    ),\r\n  },\r\n  { cooldown: 0, totalSucked: 0, activeNeighbors: [] },\r\n  (dt, { cell, state, props: { secondsPerAbsorb } }) => {\r\n    if (state.cooldown <= 0) {\r\n      state.activeNeighbors = [];\r\n      state.totalSucked += absorbWater(state.activeNeighbors, cell);\r\n      state.cooldown += secondsPerAbsorb;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneSoilAbsorption = typeof GeneSoilAbsorption;\r\n\r\nfunction absorbWater(activeNeighbors: Vector2[], cell: Cell) {\r\n  const neighbors = cell.world.tileNeighbors(cell.pos);\r\n  let totalSucked = 0;\r\n  for (const [dir, tile] of neighbors) {\r\n    if (tile instanceof Soil) {\r\n      activeNeighbors.push(dir);\r\n      const { water } = tile.inventory.give(cell.inventory, 1, 0);\r\n      totalSucked += water;\r\n    }\r\n  }\r\n  return totalSucked;\r\n}\r\n","import { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n/**\r\n * Vascular cells will connect to other neighboring Vascular cells.\r\n * Water in a Vascular cell will do two things:\r\n * a) Adhesion - Water will be pulled into this Cell.\r\n * b) Cohesion - Water will move to be near other Water.\r\n */\r\nexport const GeneVascular = Gene.make(\r\n  {\r\n    name: \"Vascular\",\r\n    levelCosts: [1, 2, 3, 5, 8],\r\n    levelProps: {\r\n      diffusionRate: [0.01, 0.05, 0.1, 0.2, 0.4],\r\n    },\r\n    description: ({ diffusionRate }) => `Diffuses water to other Vascular cells with rate ${diffusionRate}.`,\r\n  },\r\n  {},\r\n  (dt, { cell, props: { diffusionRate } }) => {\r\n    const neighbors = Array.from(cell.world.tileNeighbors(cell.pos).values());\r\n    const vascularNeighbors = neighbors.filter((t) => t instanceof Cell && t.chromosome.has(GeneVascular));\r\n    for (const n of vascularNeighbors) {\r\n      cell.diffuseWater(n, dt, diffusionRate);\r\n    }\r\n  }\r\n);\r\nexport type GeneVascular = typeof GeneVascular;\r\n","module.exports = __webpack_public_path__ + \"static/media/Blop-Mark_DiAngelo-79054334.627c0e8b.mp3\";","module.exports = __webpack_public_path__ + \"static/media/build.0e2001c4.mp3\";","module.exports = __webpack_public_path__ + \"static/media/build_complete.9af6ac71.mp3\";","module.exports = __webpack_public_path__ + \"static/media/deconstruct.e5356177.mp3\";","module.exports = __webpack_public_path__ + \"static/media/drop_water.7ab1e6f0.mp3\";","module.exports = __webpack_public_path__ + \"static/media/eating.e78fa644.mp3\";","module.exports = __webpack_public_path__ + \"static/media/footsteps.636605b0.wav\";","module.exports = __webpack_public_path__ + \"static/media/fruit-popOpen.5991698f.mp3\";","module.exports = __webpack_public_path__ + \"static/media/impactSoft_medium_003.b8698323.mp3\";","module.exports = __webpack_public_path__ + \"static/media/interact.848e9d20.mp3\";","module.exports = __webpack_public_path__ + \"static/media/intro-bounce.6e8ea313.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-base.28ee2cbb.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-drums.1c82b4f4.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-overworld.62281b29.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-start.473c2a0e.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-strings.9f30639c.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mitodeath.207c4872.mp3\";","module.exports = __webpack_public_path__ + \"static/media/sticky.6d27b20f.mp3\";","module.exports = __webpack_public_path__ + \"static/media/suckwater.b0fe81fa.wav\";","module.exports = __webpack_public_path__ + \"static/media/switch25.f76e435c.wav\";","module.exports = __webpack_public_path__ + \"static/media/whoosh.fde62e78.mp3\";","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wwdEQIkKFbu2wAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAA0UlEQVRYw2NgGAUjHTCSovjYTIb/xKizSifeXKZBGQK4fGppwEeUoccvfCI6ZAZXCMB8TqxPSQWwkEEOicERAkT7XL4Glf+wheKQGPAQYCFJNZk+HtTlAAtFcY1D3cePqOUAPz/fUAsBYuMahzp8Ph7aJSEpcTtkSkK85QDMxzCfEutjdH1Dtz1AbK1IyMfY4n7whMCzW/txSj7Y7/ifGi0ifG3EwR0CDAwMDFJqjvRrFX/+8GpgywFeATGq+WzI1AVMuIKdXtHBhCvYCUUHtQAAj7ZTZKkXht4AAAAASUVORK5CYII=\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wwdECsv+gDCjwAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAR0lEQVRYw2P8//8/w0ACJoYBBqMOYEEXkBY9TNNE8fS1LeNoFIw6YNQBow4YdcCoA0YdMOqAUQeMOmDUAYPKAYyjfcMR7wAAvzUKOwLggbEAAAAASUVORK5CYII=\"","module.exports = __webpack_public_path__ + \"static/media/fruit.e136487f.png\";","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAQCAYAAADJViUEAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAAsTAAALEwEAmpwYAAACC2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOlJlc29sdXRpb25Vbml0PjI8L3RpZmY6UmVzb2x1dGlvblVuaXQ+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgICAgIDx0aWZmOlBob3RvbWV0cmljSW50ZXJwcmV0YXRpb24+MjwvdGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KD0UqkwAAAM1JREFUKBVjYBgowIjL4v50+/8wucKZB7GqwxCEadJSkYfpZbh25yGYjW4IimaQRpimSbL8cM15jz+C2SBDkA1ggqtAYiBrBAmj82FK4TbDbF2qowSWe/vxLUwNgzC/MJgdfeUe2Asw27HajKwRpAudDzMVq2aYJCGaepr5JSH+hfkRZjOMD5OHicMDDCSAHmgwRSAaPbBAYhjOBpmehQhokBowH91WkDiKzSABWAqztHUEccHg+OH9YBoWRVBhTM0wCZghID66JpgaimgAWfxCZhIsrg0AAAAASUVORK5CYII=\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAsCAYAAABloJjNAAAFJklEQVRIS62We2xTVRzHv+e2ty0bfa223VMjMEjWTXyuBmOIsCiYIGCMRpYoiSYIGjSOmGE0gCSogcnDR0biwIQoCmqmLg4msP2xBLYYQmCj4GOKjLmue/Tlut3b3mPOvbT3di2tiTt/9fZ3ft/+fp/z7e9cgv+wpt4nFD7A9Bkl+bbn3SDshqriA/hDyJmTX7B7JSVn25XCZkOQ6YjdKyla2sEfzl0d25u1Qi0zzyflFJJKrv+VQZKLaYaguBs0le4DFteUQppWFS9wfujIzS1ZEKQEaa+5k9RGHhG7V1CcPZFiVrOoBPuqpuTn1/qNuPDQ3dCdU+PskJK5GS2roiqzo2230R19elnw7YUC6p8cJ2L34xQtP8pMtWJZGXZ13kFPBubKAkvMUTQOJABJpfBBtQFdgQI5XmcLYfmjg2nYMhhuPeaha0qikKZFtEcd+PqPsTSGa+c58ExFFJFoHB3RIuxceym7IO2x9BFvuJoJPuscg5MXcWCoGK3XxnG4JiZXtP6CCUxwc+kwAiKPowEH3n26nyRzszC0fH8maFl1KmiFw12IZYnr6IuK2HVZYbi1UkCN3Yjjo0WwOubgvrgfdfbQD6Q2/ETSGWnl0nPmhq5J+56OUbMcX2oN45fYNJqv8fLzhnIB1UWFOBUoTDFcZgltIQ9GmjIEaY/lC+INr2MtP1UcAp+I45uwC8cHRrFrnmKbRp9Bbnl9RRDBSYq2sENmmMxNa5n2WPzEG3YzwRfcAbh5EbsGS9F6fQKt90zKgqt7FYZvlg/BL/Jo8TuTDOXcTIY9ls9PBy3rToessDsLsFS6AV9UwHs+heEbCwR47Ca0jtlhsZvwgOTHcluYdVafnWGPZVtX1La9Y0xhyHx2ZVLAx38qgi9XCPAUFSLp0+XWEBPcTrzhHdkYniLecJ1sG/cECiHiSKgEx34fxUcLFdtsumSUW95YMYbxGPBt2Il31sgM5dyZDIeJN1zMBF90j8AlMyzDsZ9HcGKFiFW9JllUYXgDIyKPT/2uJEM5NwtDc/OZkHUD86G1yISH8TcuRwQ0XVVaZqvlfg5t43bMtRpRiwDqbMGDxBt5KTvDXuuezoi14aebDB+zhXA1No39A4oPN98u4AYpQTyujDPGeJkt0kRqQ1syGfZaL5La0F2s5eddo7Dp4zg4UY6vfgvgiEexTf15xTY6HYd6xwi+DLmxY/VFQm/mZrTMvmCCz7lGYdfHsX+oGMfPj0Bv06VaZoKvlg7LMbbYfzkVzHYFnO4op4yh2WbEEoxgU7+UNm2a79XjZNCKArMBkxEhtyDtMTdX91o2SII6/xoqRTT9qjB8/U4Be/8ygiY0t0TD0C3Hl3z0VftKqTSl3iGckcN3ixWGzDqE50BFNX6lcTh3y/MbnZTXMItHJOjNXApTYlKCrkB9ziuYrULtrZe3Qs+HZTQtwcCBCmpLMwWInoDGVYaEI6CaO4dU7S+jUiyRaokzcZjJMFeFGT8wv9FFeZvKJIPZPxJ0hWpcilFwc9RzYI7gDOrz7FfoOVCWZhNi5EA1rx7EQEA1viQ8ARVVhtARQOPL2a9wwVsuqp+r9RmFrkBlkohR6LTMpik4oxpn1bKqU9Nm1k+5ijHU2saogzStsZGBg5TLlzqS9t+efYaV29w0jdEUBWe6tc+oCBBl+MiLxgGi3hCY/Qq105Z9rm6uoJqXYuUtXGO7mfv7Nl7PPb6q9mbOw5zTZmueebhoZzHVMpnJiCYAol4xuJJP8P9W+C+xZd+qpRkU/AAAAABJRU5ErkJggg==\"","module.exports = \"data:image/png;base64,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\"","module.exports = __webpack_public_path__ + \"static/media/switch26.69545541.wav\";","module.exports = __webpack_public_path__ + \"static/media/rollover6.a81b9fe6.wav\";","var map = {\n\t\"./GeneAdhesion.tsx\": 331,\n\t\"./GeneAiryExpansion.tsx\": 105,\n\t\"./GeneAttractsSugar.tsx\": 87,\n\t\"./GeneAttractsWater.tsx\": 106,\n\t\"./GeneBark.tsx\": 107,\n\t\"./GeneCannotFreeze.tsx\": 88,\n\t\"./GeneCostly.tsx\": 108,\n\t\"./GeneDiffuseSugar.tsx\": 109,\n\t\"./GeneDiffuseWater.tsx\": 80,\n\t\"./GeneEnergyTransfer.tsx\": 110,\n\t\"./GeneHydrostasis.tsx\": 111,\n\t\"./GeneInventory.tsx\": 112,\n\t\"./GeneLiving.tsx\": 113,\n\t\"./GeneMetabolism.tsx\": 114,\n\t\"./GeneNetworkEffect.tsx\": 115,\n\t\"./GeneNutrientExtraction.tsx\": 116,\n\t\"./GeneObstacle.tsx\": 65,\n\t\"./GeneOsmosis.tsx\": 117,\n\t\"./GenePhotosynthesis.tsx\": 89,\n\t\"./GenePipes.tsx\": 82,\n\t\"./GenePushWater.tsx\": 118,\n\t\"./GeneReproducer.tsx\": 52,\n\t\"./GeneScaffolding.tsx\": 119,\n\t\"./GeneSoilAbsorption.tsx\": 120,\n\t\"./GeneTransport.tsx\": 69,\n\t\"./GeneVascular.tsx\": 121\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 330;","import { Cell } from \"core/cell\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport RI from \"./RI\";\r\n\r\nconst extraDiffusion = 0.1;\r\n\r\nexport const GeneAdhesion = Gene.make(\r\n  {\r\n    name: \"Adhesion\",\r\n    levelCosts: [2],\r\n    levelProps: {},\r\n    dynamic(cell, properties) {\r\n      const neighbors = cell.world.tileNeighbors(cell.pos);\r\n      let nonCellNeighbors = 0;\r\n      for (const [, t] of neighbors) {\r\n        if (!(t instanceof Cell)) {\r\n          nonCellNeighbors++;\r\n        }\r\n      }\r\n      if (nonCellNeighbors >= 3) {\r\n        properties.diffusionWater += extraDiffusion;\r\n      }\r\n      return properties;\r\n    },\r\n    description: () => (\r\n      <>\r\n        <p>\r\n          While this cell has 3 or more non-Cell neighbors, diffuse <RI w /> into this cell.\r\n        </p>\r\n        <p>\r\n          On average, get 1<RI w /> every <GN value={1 / extraDiffusion} sigFigs={3} /> seconds.\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\n\r\nexport type GeneAdhesion = typeof GeneAdhesion;\r\n","import { Color, Vector2 } from \"three\";\r\nimport Chromosome from \"../../core/cell/chromosome\";\r\nimport Genome, { CellType } from \"../../core/cell/genome\";\r\nimport {\r\n  GeneAttractsWater,\r\n  GeneEnergyTransfer,\r\n  GeneInventory,\r\n  GeneLiving,\r\n  GeneMetabolism,\r\n  GeneSoilAbsorption,\r\n} from \"../genes\";\r\nimport { GeneAttractsSugar } from \"../genes/GeneAttractsSugar\";\r\nimport { GeneCannotFreeze } from \"../genes/GeneCannotFreeze\";\r\nimport { GeneObstacle } from \"../genes/GeneObstacle\";\r\nimport { GenePhotosynthesis } from \"../genes/GenePhotosynthesis\";\r\nimport { GeneFruit } from \"../genes/GeneReproducer\";\r\nimport { GeneTransport } from \"../genes/GeneTransport\";\r\n\r\nconst cellTypeTissue = new CellType(\r\n  \"Tissue\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneInventory.level(3), GeneMetabolism.level(2), GeneEnergyTransfer.level(1)),\r\n  {\r\n    texturePosition: new Vector2(1, 1),\r\n    color: new Color(0x30ae25),\r\n  },\r\n  {\r\n    type: \"take\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeLeaf = new CellType(\r\n  \"Leaf\",\r\n  0,\r\n  new Chromosome(\r\n    GeneLiving.level(2),\r\n    GeneInventory.level(3),\r\n    GeneObstacle.level(0),\r\n    GenePhotosynthesis.level(1),\r\n    GeneAttractsWater.level(3)\r\n  ),\r\n  {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(2, 1),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"water take sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeRoot = new CellType(\r\n  \"Root\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneInventory.level(4), GeneObstacle.level(0), GeneSoilAbsorption.level(2)),\r\n  {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(3, 1),\r\n  },\r\n  {\r\n    type: \"take\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeTransport = new CellType(\r\n  \"Transport\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(3), GeneInventory.level(3), GeneTransport.level(2), GeneEnergyTransfer.level(2)),\r\n  {\r\n    texturePosition: new Vector2(1, 1),\r\n    color: new Color(0x30ae25),\r\n  },\r\n  {\r\n    type: \"take\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeFruit = new CellType(\r\n  \"Fruit\",\r\n  0,\r\n  new Chromosome(\r\n    GeneLiving.level(2),\r\n    GeneInventory.level(0),\r\n    GeneObstacle.level(0),\r\n    GeneCannotFreeze.level(0),\r\n    GeneFruit.level(0),\r\n    GeneAttractsSugar.level(1),\r\n    GeneAttractsWater.level(1)\r\n  ),\r\n  {\r\n    texturePosition: new Vector2(0, 2),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nexport const standardGenome = new Genome([\r\n  cellTypeTissue,\r\n  cellTypeLeaf,\r\n  cellTypeRoot,\r\n  cellTypeTransport,\r\n  cellTypeFruit,\r\n]);\r\n","export function sleep(millis: number) {\r\n  return new Promise((r) => {\r\n    setTimeout(r, millis);\r\n  });\r\n}\r\n","import { sleep } from \"common/promise\";\r\nimport { EventEmitter } from \"events\";\r\nimport { params } from \"game/params\";\r\nimport { Vector2 } from \"three\";\r\nimport {\r\n  PLAYER_BASE_SPEED,\r\n  PLAYER_INTERACT_EXCHANGE_SPEED,\r\n  PLAYER_MAX_RESOURCES,\r\n  PLAYER_STARTING_SUGAR,\r\n  PLAYER_STARTING_WATER,\r\n} from \"../constants\";\r\nimport { Steppable } from \"../entity\";\r\nimport { Inventory } from \"../inventory\";\r\nimport { Air, Cell, FreezeEffect, GrowingCell, Tile } from \"../tile\";\r\nimport { World } from \"../world/world\";\r\nimport {\r\n  Action,\r\n  ActionBuild,\r\n  ActionDeconstruct,\r\n  ActionDrop,\r\n  ActionLong,\r\n  ActionMove,\r\n  ActionMultiple,\r\n  ActionPickup,\r\n  ActionRemoveCancer,\r\n  ActionThaw,\r\n} from \"./action\";\r\n\r\nexport class Player implements Steppable {\r\n  public inventory = new Inventory(PLAYER_MAX_RESOURCES, this, PLAYER_STARTING_WATER, PLAYER_STARTING_SUGAR);\r\n\r\n  private action?: Action;\r\n\r\n  private events = new EventEmitter();\r\n\r\n  public baseSpeed: number;\r\n\r\n  public dtSinceLastStepped = 0;\r\n\r\n  public get speed() {\r\n    const t = this.currentTile();\r\n    return this.baseSpeed * (t instanceof Cell ? t.getMovespeedMultiplier() : 1);\r\n  }\r\n\r\n  get pos() {\r\n    return this.posFloat.clone().round();\r\n  }\r\n\r\n  public constructor(public posFloat: Vector2, public world: World) {\r\n    this.baseSpeed = PLAYER_BASE_SPEED;\r\n  }\r\n\r\n  shouldStep() {\r\n    return true;\r\n  }\r\n\r\n  public setAction(action: Action) {\r\n    if (this.action != null) {\r\n      if (this.action.type === \"long\") {\r\n        // don't allow anything to happen during long actions.\r\n        return;\r\n      } else {\r\n        this.action = {\r\n          type: \"multiple\",\r\n          actions: [this.action, action],\r\n        };\r\n      }\r\n    } else {\r\n      if (action.type === \"build\" && action.cellType.chromosome.computeStaticProperties().isReproductive) {\r\n        this.action = {\r\n          type: \"long\",\r\n          duration: 4.5,\r\n          effect: action,\r\n          elapsed: 0,\r\n        };\r\n      } else {\r\n        this.action = action;\r\n      }\r\n    }\r\n  }\r\n\r\n  public getAction() {\r\n    return this.action;\r\n  }\r\n\r\n  public droopY() {\r\n    const tile = this.world.tileAt(this.pos.x, this.pos.y);\r\n    if (tile instanceof Cell) {\r\n      return tile.droopY;\r\n    } else {\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get this player's position taking into\r\n   * account the droop of the cell it's on.\r\n   */\r\n  public droopPosFloat() {\r\n    const droopY = this.droopY();\r\n    if (droopY !== 0) {\r\n      const t = this.posFloat.clone();\r\n      t.y += droopY;\r\n      return t;\r\n    }\r\n    return this.posFloat;\r\n  }\r\n\r\n  public currentTile() {\r\n    return this.world.tileAt(this.pos)!;\r\n  }\r\n\r\n  public findNearestWalkableCell() {\r\n    for (const tile of this.world.bfsIterator(this.pos, this.world.width * this.world.height)) {\r\n      if (this.isWalkable(tile)) {\r\n        return tile;\r\n      }\r\n    }\r\n  }\r\n\r\n  public on(event: \"action\", cb: (action: Action) => void): void;\r\n\r\n  public on(event: \"action-fail\", cb: (action: Action, reason?: string) => void): void;\r\n\r\n  public on(event: \"start-long-action\", cb: (action: ActionLong) => void): void;\r\n\r\n  public on(event: string, cb: (...args: any[]) => void) {\r\n    this.events.on(event, cb);\r\n  }\r\n\r\n  public off(event: string, cb: (...args: any[]) => void) {\r\n    this.events.off(event, cb);\r\n  }\r\n\r\n  public step(dt: number) {\r\n    // this.maybeMoveWithTransports(dt);\r\n    if (!this.isWalkable(this.currentTile())) {\r\n      const nearestWalkableCell = this.findNearestWalkableCell();\r\n      if (nearestWalkableCell != null) {\r\n        this.world.logEvent({\r\n          type: \"oof\",\r\n          from: this.posFloat,\r\n          to: nearestWalkableCell,\r\n        });\r\n        this.posFloat.copy(nearestWalkableCell.pos);\r\n      }\r\n    }\r\n    if (this.action != null) {\r\n      this.attemptAction(this.action, dt);\r\n      if (this.action.type !== \"long\") {\r\n        this.action = undefined;\r\n      }\r\n    }\r\n  }\r\n\r\n  public attemptAction(action: Action, dt: number) {\r\n    const result = this._attemptAction(action, dt);\r\n    if (params.showGodUI) {\r\n      console.log(action);\r\n    }\r\n    if (result === true) {\r\n      this.events.emit(\"action\", action);\r\n    } else {\r\n      this.events.emit(\"action-fail\", action, result === false ? undefined : result);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  private _attemptAction(action: Action, dt: number): boolean | string {\r\n    switch (action.type) {\r\n      case \"move\":\r\n        return this.attemptMove(action, dt);\r\n      case \"build\":\r\n        return this.attemptBuild(action, dt);\r\n      case \"deconstruct\":\r\n        return this.attemptDeconstruct(action, dt);\r\n      case \"drop\":\r\n        return this.attemptDrop(action, dt);\r\n      case \"pickup\":\r\n        return this.attemptPickup(action, dt);\r\n      case \"multiple\":\r\n        return this.attemptMultiple(action, dt);\r\n      case \"long\":\r\n        return this.attemptLong(action, dt);\r\n      case \"thaw\":\r\n        return this.attemptThaw(action, dt);\r\n      case \"remove-cancer\":\r\n        return this.attemptRemoveCancer(action, dt);\r\n    }\r\n  }\r\n\r\n  public isWalkable(pos: Tile): pos is Cell;\r\n\r\n  public isWalkable(pos: Vector2): boolean;\r\n\r\n  public isWalkable(pos: Tile | Vector2) {\r\n    const tile = pos instanceof Vector2 ? this.world.tileAt(Math.round(pos.x), Math.round(pos.y)) : pos;\r\n    if (!(tile instanceof Cell) || tile.isObstacle) {\r\n      // can't move!\r\n      return false;\r\n    }\r\n    if (tile instanceof Cell) {\r\n      return tile.findEffectOfType(FreezeEffect) == null;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public canBuildAt(tile: Tile | null): tile is Tile {\r\n    if (tile == null) {\r\n      return false;\r\n    } else if (tile instanceof Cell) {\r\n      return false;\r\n    } else {\r\n      return !tile.isObstacle;\r\n    }\r\n  }\r\n\r\n  isTakingLongAction() {\r\n    return this.action != null && this.action.type === \"long\";\r\n  }\r\n\r\n  public attemptMove(action: ActionMove, dt: number) {\r\n    const nextPos = this.posFloat.clone().add(action.dir.clone().setLength(this.speed * dt));\r\n    if (this.isWalkable(nextPos)) {\r\n      // const t = this.currentTile();\r\n      // if (t instanceof Cell) {\r\n      //   if (t.temperature < 40) {\r\n      //     t.nextTemperature += 0.2;\r\n      //   }\r\n      //   else if (t.temperature > 60) {\r\n      //     t.nextTemperature -= 0.2;\r\n      //   }\r\n      // }\r\n      // do the move\r\n      this.posFloat.copy(nextPos);\r\n      // this._pos = this.posFloat.clone().round();\r\n      // this.autopickup();\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public attemptStill(_dt: number) {\r\n    // this.autopickup();\r\n    return true;\r\n  }\r\n\r\n  public canBuild(action: ActionBuild): true | string {\r\n    const existingTile = this.world.tileAt(action.position);\r\n    if (!this.canBuildAt(existingTile)) {\r\n      return `Can't build over ${existingTile!.displayName}!`;\r\n    }\r\n    const existingCell = this.world.cellAt(action.position.x, action.position.y);\r\n    if (existingCell != null) {\r\n      // don't allow building over\r\n      return `Deconstruct ${existingCell.displayName} first!`;\r\n    }\r\n\r\n    const { costSugar, costWater } = action.cellType.chromosome.computeStaticProperties();\r\n\r\n    const needWater = this.inventory.water < costWater;\r\n    const needSugar = this.inventory.sugar < costSugar;\r\n\r\n    if (needWater && needSugar) {\r\n      return \"Need water and sugar!\";\r\n    } else if (needWater && !needSugar) {\r\n      return \"Need water!\";\r\n    } else if (needSugar && !needWater) {\r\n      return \"Need sugar!\";\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  public attemptBuild(action: ActionBuild, dt: number) {\r\n    const canBuild = this.canBuild(action);\r\n    if (canBuild !== true) {\r\n      return canBuild;\r\n    }\r\n\r\n    const { costSugar, costWater } = action.cellType.chromosome.computeStaticProperties();\r\n    this.inventory.add(-costWater, -costSugar);\r\n    const matureCell = new Cell(action.position, this.world, action.cellType, action.args);\r\n\r\n    let cell: Cell;\r\n    if (action.cellType.chromosome.computeStaticProperties().timeToBuild > 0) {\r\n      // special - drop a sugar when you grow, to cover for the sugar\r\n      // this.attemptDrop(\r\n      //   {\r\n      //     type: \"drop\",\r\n      //     sugar: 1 / dt,\r\n      //     water: 0,\r\n      //   },\r\n      //   dt\r\n      // );\r\n      cell = new GrowingCell(action.position, this.world, matureCell, this.currentTile().pos);\r\n      // this.inventory.give(cell.inventory, 0, 1);\r\n    } else {\r\n      cell = matureCell;\r\n    }\r\n    cell.droopY = this.droopY();\r\n    this.world.setTileAt(action.position, cell);\r\n    return true;\r\n  }\r\n\r\n  public attemptDeconstruct(action: ActionDeconstruct, _dt: number): boolean {\r\n    if (!action.position.equals(this.pos) || action.force) {\r\n      const cell = this.world.maybeRemoveCellAt(action.position);\r\n      if (cell != null) {\r\n        if (cell instanceof GrowingCell) {\r\n          // refund the resources back\r\n          const { costSugar, costWater } = cell.completedCell.type.chromosome.computeStaticProperties();\r\n          this.inventory.add(costWater, costSugar);\r\n        }\r\n\r\n        // maybeRemoveCellAt has already tried redistributing inventory to neighbors,\r\n        // but if it couldn't do that, as a last ditch, give resources directly to\r\n        // the player\r\n        cell.inventory.give(this.inventory, cell.inventory.water, cell.inventory.sugar);\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public attemptDrop(action: ActionDrop, dt: number) {\r\n    // drop as much as you can onto the current tile\r\n    const target = action.target;\r\n    let { water: waterToDrop, sugar: sugarToDrop } = action;\r\n    if (action.continuous) {\r\n      waterToDrop *= PLAYER_INTERACT_EXCHANGE_SPEED * dt;\r\n      sugarToDrop *= PLAYER_INTERACT_EXCHANGE_SPEED * dt;\r\n    }\r\n\r\n    const { water, sugar } = this.inventory.give(target.inventory, waterToDrop, sugarToDrop);\r\n    return water > 0 || sugar > 0;\r\n  }\r\n\r\n  public attemptPickup(action: ActionPickup, dt: number) {\r\n    const target = action.target;\r\n    const inv = target.inventory;\r\n\r\n    let { water: waterToDrop, sugar: sugarToDrop } = action;\r\n    if (action.continuous) {\r\n      waterToDrop *= PLAYER_INTERACT_EXCHANGE_SPEED * dt;\r\n      sugarToDrop *= PLAYER_INTERACT_EXCHANGE_SPEED * dt;\r\n    }\r\n    const { water, sugar } = inv.give(this.inventory, waterToDrop, sugarToDrop);\r\n    return water > 0 || sugar > 0;\r\n  }\r\n\r\n  public attemptMultiple(multiple: ActionMultiple, dt: number) {\r\n    let allSuccess = true;\r\n    for (const action of multiple.actions) {\r\n      allSuccess = this.attemptAction(action, dt) === true && allSuccess;\r\n    }\r\n    return allSuccess;\r\n  }\r\n\r\n  /**\r\n   * long actions are reponsible for unsetting themselves.\r\n   */\r\n  public attemptLong(action: ActionLong, dt: number) {\r\n    if (action.elapsed === 0) {\r\n      // verify builds\r\n      if (action.effect.type === \"build\") {\r\n        const canBuild = this.canBuild(action.effect);\r\n        if (canBuild !== true) {\r\n          this.action = undefined;\r\n          return canBuild;\r\n        }\r\n      }\r\n      this.events.emit(\"start-long-action\", action);\r\n    }\r\n    action.elapsed += dt;\r\n    if (action.elapsed > action.duration) {\r\n      this.action = undefined;\r\n      const result = this.attemptAction(action.effect, dt);\r\n      return result;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public attemptThaw(action: ActionThaw, dt: number) {\r\n    const { target } = action;\r\n    target.thaw(dt);\r\n    return true;\r\n  }\r\n\r\n  public attemptRemoveCancer(action: ActionRemoveCancer, dt: number) {\r\n    const { target } = action;\r\n    target.removeCancer(dt);\r\n    return true;\r\n  }\r\n}\r\n\r\nexport class PlayerSeed implements Steppable {\r\n  public readonly inventory = new Inventory(0, this);\r\n\r\n  public dtSinceLastStepped = 0;\r\n\r\n  private poppedOut = false;\r\n\r\n  public constructor(public posFloat: Vector2, public world: World, public player: Player) {}\r\n\r\n  shouldStep(): boolean {\r\n    return true;\r\n  }\r\n\r\n  get pos() {\r\n    return this.posFloat.clone().round();\r\n  }\r\n\r\n  step(dt: number): void {\r\n    const pos = this.pos;\r\n    const tileBelow = this.world.tileAt(pos.x, pos.y + 1);\r\n    if (tileBelow instanceof Air) {\r\n      // can keep going\r\n      const velY = Math.min(20 * dt, 1);\r\n      this.posFloat.y += velY;\r\n    } else {\r\n    }\r\n    this.player.posFloat.copy(this.posFloat);\r\n    if (this.poppedOut) {\r\n      this.world.removePlayerSeed();\r\n    }\r\n  }\r\n\r\n  popOut() {\r\n    const start = this.pos;\r\n    const c = new Cell(start, this.world, this.world.genome.cellTypes[0]);\r\n    const growingCell = new GrowingCell(start, this.world, c, start);\r\n    growingCell.silent = true;\r\n    this.world.setTileAt(start, growingCell);\r\n    Array.from(\r\n      this.world.bfsIterator(\r\n        start,\r\n        30,\r\n        (t) => !t.isObstacle && t.pos.distanceTo(start) < 2.5,\r\n        (t) => t.pos.distanceTo(start)\r\n      )\r\n    ).forEach((tile, i) => {\r\n      sleep(300).then(() => {\r\n        const cell = new Cell(tile.pos, this.world, this.world.genome.cellTypes[0]);\r\n        // const growingCell = new GrowingCell(tile.pos, this.world, cell, start);\r\n        this.world.setTileAt(tile.pos, cell);\r\n      });\r\n    });\r\n    this.poppedOut = true;\r\n  }\r\n}\r\n","import { TIME_PER_DAY, TIME_PER_MONTH, TIME_PER_SEASON, TIME_PER_YEAR } from \"./constants\";\r\nexport interface Season {\r\n  year: number;\r\n  season: 0 | 1 | 2 | 3;\r\n  /**\r\n   * month 1, 2, or 3 in the season.\r\n   */\r\n  month: number;\r\n  /**\r\n   * Percent done with the season total.\r\n   */\r\n  percent: number;\r\n  day: number;\r\n}\r\n\r\nexport function seasonFromTime(time: number): Season {\r\n  const year = Math.floor(time / TIME_PER_YEAR);\r\n  const timeInYear = time % TIME_PER_YEAR;\r\n  const season = Math.floor(timeInYear / TIME_PER_SEASON) as Season[\"season\"];\r\n  const percent = (timeInYear % TIME_PER_SEASON) / TIME_PER_SEASON;\r\n  const month = Math.floor((timeInYear % TIME_PER_SEASON) / TIME_PER_MONTH) + 1;\r\n  const day = Math.floor((timeInYear % TIME_PER_MONTH) / TIME_PER_DAY) + 1;\r\n  return {\r\n    year,\r\n    season,\r\n    percent,\r\n    month,\r\n    day,\r\n  };\r\n}\r\n\r\nexport const SEASON_NAMES = [\"Spring\", \"Summer\", \"Fall\", \"Winter\"];\r\n\r\nexport function seasonDisplay(s: Season) {\r\n  return `${s.year > 0 ? `Year ${s.year}, ` : \"\"}${SEASON_NAMES[s.season]}, Month ${s.month}`;\r\n}\r\n","import { Entity } from \"../entity\";\r\nimport { EventPhotosynthesis, TileEvent, TileEventType } from \"../tile/tileEvent\";\r\nexport class StepStats {\r\n  public events: TileEventLog = {\r\n    \"cell-eat\": [],\r\n    \"cell-transfer-energy\": [],\r\n    evaporation: [],\r\n    photosynthesis: [],\r\n    thaw: [],\r\n    \"collect-sunlight\": [],\r\n    \"grow-fruit\": [],\r\n    oof: [],\r\n  };\r\n\r\n  constructor(public dt: number, public frame: number, public deleted: Entity[] = [], public added: Entity[] = []) {}\r\n\r\n  logEvent(event: TileEvent) {\r\n    this.events[event.type].push(event);\r\n  }\r\n}\r\n\r\nexport type TileEventLog = {\r\n  [K in TileEventType]: TileEvent[];\r\n} & {\r\n  photosynthesis: EventPhotosynthesis[];\r\n};\r\n","export function arrayRange<T = number>(length: number, fill?: T | ((i: number) => T)): T[] {\r\n  return new Array(length).fill(undefined).map((_, i) => {\r\n    if (typeof fill === \"function\") {\r\n      return (fill as any)(i) as T;\r\n    } else if (fill === undefined) {\r\n      return i;\r\n    } else {\r\n      return fill;\r\n    }\r\n  }) as T[];\r\n}\r\n\r\nexport function gridRange<T>(width: number, height: number, fill: (x: number, y: number) => T) {\r\n  return arrayRange(width, (x) => arrayRange(height, (y) => fill(x, y)));\r\n}\r\n","import { Vector2 } from \"three\";\r\nimport { TileGenerator } from \"../core/environment\";\r\nimport { Fountain, Rock } from \"../core/tile\";\r\nimport { Clay, Sand, Silt } from \"../core/tile/soil\";\r\nimport { World } from \"../core/world/world\";\r\nimport { clamp, map, randInt } from \"../math\";\r\n\r\nexport type ScalarField = (pos: Vector2, world: World) => number;\r\n\r\nexport const pointsFilter = (gen: TileGenerator, points: Vector2[]): TileGenerator => {\r\n  return (pos, world) => {\r\n    if (points.find((p) => p.equals(pos)) != null) {\r\n      return gen(pos, world);\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * The first gen takes precedence over later ones.\r\n */\r\nexport const layers = (...gens: TileGenerator[]): TileGenerator => {\r\n  return (pos, world) => {\r\n    for (const g of gens) {\r\n      const tile = g(pos, world);\r\n      if (tile) {\r\n        return tile;\r\n      }\r\n    }\r\n  };\r\n};\r\n\r\nconst mixedSoilRock: TileGenerator = (pos, world) => {\r\n  const { noiseSoil, noiseWater } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const level = noiseSoil.octaveSimplex2(x / 10, y / 10);\r\n  const s = new (level < -0.37 ? Sand : level < 0.37 ? Silt : level < 1 ? Clay : Rock)(pos, world);\r\n  const water = clamp((noiseWater.simplex2(x / 5, y / 5) + 0.2 > 0.4 ? level : 0) * 20, 1, 20);\r\n  s.inventory.add(water, 0);\r\n  return s;\r\n};\r\n\r\nconst Level0: TileGenerator = (pos, world) => {\r\n  const { noiseHeight, noiseWater, noiseRock } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height / 2 - (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 - 16 * noiseHeight.perlin2(10, x / 20 + 10);\r\n  if (y > soilLevel) {\r\n    const rockThreshold = map(y - world.height / 2, 0, world.height / 2, -0.8, 0.3);\r\n    const isRock = noiseRock.simplex2(x / 5, y / 5) < rockThreshold;\r\n    if (isRock) {\r\n      const rock = new Rock(pos, world);\r\n      return rock;\r\n    } else {\r\n      const heightScalar = Math.pow(map(y - world.height / 2, 0, world.height / 2, 0.5, 1), 2);\r\n      const simplexScalar = 0.2;\r\n      // the + at the end makes a *huge* difference\r\n      const simplexValue = noiseWater.simplex2(x * simplexScalar, y * simplexScalar) + 0.15;\r\n\r\n      const isEarlyFountain = simplexValue > 0.9 && y - soilLevel > 8 && y - soilLevel < 13;\r\n      if (isEarlyFountain) {\r\n        return new Fountain(pos, world, 3, 75 + randInt(-10, 10));\r\n      }\r\n\r\n      if (heightScalar * simplexValue > 1 && y - soilLevel > 8) {\r\n        const emitWaterScalar = Math.min(heightScalar * simplexValue, 1);\r\n        return new Fountain(\r\n          pos,\r\n          world,\r\n          Math.round(3 / emitWaterScalar),\r\n          map(y, world.height / 2, world.height, 100, 300) + randInt(-10, 10)\r\n        );\r\n      } else {\r\n        const s = new Silt(pos, world)!;\r\n        const water = Math.round(clamp((simplexValue > 0.4 ? heightScalar : 0) * 10 * 3, 1, 10));\r\n        s.inventory.set(water, 0);\r\n        return s;\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nconst Temperate: TileGenerator = (pos, world) => {\r\n  const { noiseHeight, noiseWater, noiseRock } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height / 2 - (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 - 16 * noiseHeight.perlin2(10, x / 20 + 10);\r\n  if (y > soilLevel) {\r\n    const rockThreshold = map(y - world.height / 2, 0, world.height / 2, -0.7, 0.3);\r\n    const isRock = noiseRock.simplex2(x / 5, y / 5) < rockThreshold;\r\n    if (isRock) {\r\n      const rock = new Rock(pos, world);\r\n      return rock;\r\n    } else {\r\n      const heightScalar = Math.pow(map(y - world.height / 2, 0, world.height / 2, 0.5, 1), 2);\r\n      const simplexScalar = 0.2;\r\n      // the + at the end makes a *huge* difference\r\n      const simplexValue = noiseWater.simplex2(x * simplexScalar, y * simplexScalar) + 0.13;\r\n\r\n      const isFountain = simplexValue > 0.9 && y - soilLevel > 8;\r\n      if (isFountain) {\r\n        return new Fountain(pos, world, 3, map(y, world.height / 2, world.height, 100, 300));\r\n      }\r\n      if (heightScalar * simplexValue > 1 && y - soilLevel > 8) {\r\n        const emitWaterScalar = Math.min(heightScalar * simplexValue, 1);\r\n        return new Fountain(\r\n          pos,\r\n          world,\r\n          Math.round(3 / emitWaterScalar),\r\n          map(y, world.height / 2, world.height, 100, 300)\r\n        );\r\n      } else {\r\n        const s = mixedSoilRock(pos, world)!;\r\n        const water = Math.round(clamp((simplexValue > 0.4 ? heightScalar : 0) * 10, 1, 10));\r\n\r\n        s.inventory.set(water, 0);\r\n        return s;\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nconst Desert: TileGenerator = (pos, world) => {\r\n  const { noiseHeight, noiseRock } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height / 2 - (2 * (noiseHeight.perlin2(0, x / 20) + 1)) / 2 - 3 * noiseHeight.perlin2(10, x / 100 + 10);\r\n  const rockThreshold = map(y, world.height / 2, world.height, -0.8, -0.4);\r\n  const isRock = noiseRock.simplex2(x / 4, y / 4) < rockThreshold;\r\n  if (y > soilLevel) {\r\n    if (isRock) {\r\n      return new Rock(pos, world);\r\n    }\r\n    const s = mixedSoilRock(pos, world)!;\r\n    const water = Math.floor(Math.max(0, map(y, world.height * 0.75, world.height, 1, 9)));\r\n    s.inventory.set(water, 0);\r\n    return s;\r\n  }\r\n};\r\n\r\nconst Rocky: TileGenerator = (pos, world) => {\r\n  const { noiseHeight, noiseRock } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height * 0.55 -\r\n    (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 -\r\n    16 * noiseHeight.perlin2(10, x / 20 + 10) -\r\n    map(x, 0, world.width, 10, -10);\r\n  const rockLevel = y - (6 * (noiseHeight.perlin2(0, x / 25) + 1)) / 2 - 20 * noiseHeight.perlin2(10, x / 150 + 10);\r\n  const rockThreshold = rockLevel < world.height * 0.5 ? -1 : -0.15;\r\n  const isRock = noiseRock.simplex2(x / 10, y / 10) < rockThreshold;\r\n  if (isRock) {\r\n    const rock = new Rock(pos, world);\r\n    return rock;\r\n  } else if (y > soilLevel) {\r\n    const silt = new Silt(pos, world);\r\n    silt.inventory.add(2, 0);\r\n    return silt;\r\n  }\r\n};\r\n\r\nconst Reservoires: TileGenerator = (pos, world) => {\r\n  const { noiseHeight } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height / 2 - (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 - 16 * noiseHeight.perlin2(10, x / 20 + 10);\r\n  // const isRock = Math.abs(noiseRock.simplex2(x / 10, y / 10)) < 0.1;\r\n  const isRockHere = Math.sin(x / 4 + y / 30) ** 2 + Math.cos(y / 4) ** 2 > 1.2;\r\n  const isRockBelow = Math.sin(x / 4 + (y + 2) / 30) ** 2 + Math.cos((y + 2) / 4) ** 2 > 1.2;\r\n\r\n  const isRock = isRockHere && !isRockBelow;\r\n  if (isRock && y + 1 > soilLevel) {\r\n    return new Rock(pos, world);\r\n  }\r\n  if (y > soilLevel) {\r\n    return mixedSoilRock(pos, world);\r\n  }\r\n};\r\n\r\nconst SkySoil: TileGenerator = (pos, world) => {\r\n  const { noiseHeight } = world.generatorContext;\r\n  const { x, y } = pos;\r\n\r\n  const p = 2.5;\r\n  const soilLevel = Math.sin(x / p + y / 12) ** 2 + Math.cos(y / p) ** 2 + noiseHeight.perlin2(x / 4, y / 26);\r\n\r\n  if (soilLevel > 1.2 && y > 80 - soilLevel * 20) {\r\n    const s = new Silt(pos, world);\r\n    s.inventory.add(Math.floor(5 * (soilLevel - 1.1)), 0);\r\n    return s;\r\n  }\r\n\r\n  const soilLevelBase =\r\n    (world.height / 2) * 1.2 -\r\n    (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 -\r\n    16 * noiseHeight.perlin2(10, x / 20 + 10);\r\n  if (y > soilLevelBase) {\r\n    return mixedSoilRock(pos, world);\r\n  }\r\n};\r\n\r\nexport const TileGenerators = { Level0, Temperate, Desert, Rocky, Reservoires, SkySoil };\r\nexport type TileGeneratorName = keyof typeof TileGenerators;\r\n","import { Noise } from \"common/perlin\";\r\n\r\nexport interface GeneratorContext {\r\n  seed: number;\r\n  noiseHeight: Noise;\r\n  noiseRock: Noise;\r\n  noiseWater: Noise;\r\n  noiseSoil: Noise;\r\n}\r\n\r\nfunction modulateSeed(seed: number, key: string) {\r\n  for (const letter of key) {\r\n    seed |= seed << (7 + letter.charCodeAt(0) ** 2);\r\n  }\r\n  return seed;\r\n}\r\n\r\nexport function createGeneratorContext(seed: number): GeneratorContext {\r\n  return {\r\n    seed,\r\n    noiseHeight: new Noise(modulateSeed(seed, \"height\")),\r\n    noiseRock: new Noise(modulateSeed(seed, \"rock\")),\r\n    noiseWater: new Noise(modulateSeed(seed, \"water\")),\r\n    noiseSoil: new Noise(modulateSeed(seed, \"soil\")),\r\n  };\r\n}\r\n","import { randInt, randRound } from \"math\";\r\nimport { PERCENT_DAYLIGHT, SUNLIGHT_DIFFUSION, SUNLIGHT_REINTRODUCTION, TIME_PER_DAY } from \"../constants\";\r\nimport { Air } from \"../tile\";\r\nimport { World } from \"./world\";\r\n/**\r\n * WeatherController is responsible for weather related properties, such as:\r\n *\r\n * Temperature of the environment\r\n * Sunlight\r\n */\r\nexport class WeatherController {\r\n  constructor(public world: World) {}\r\n\r\n  /**\r\n   * 0 to 2pi, where\r\n   * 0 to pi: daytime (time of day - 0 to PERCENT_DAYLIGHT)\r\n   * pi to 2pi: nighttime (PERCENT_DAYLIGHT to 1)\r\n   */\r\n  get sunAngle() {\r\n    const timeOfDay = (this.world.time / TIME_PER_DAY) % 1;\r\n    if (timeOfDay < PERCENT_DAYLIGHT) {\r\n      return (timeOfDay / PERCENT_DAYLIGHT) * Math.PI;\r\n    } else {\r\n      return Math.PI * (1 + (timeOfDay - PERCENT_DAYLIGHT) / (1 - PERCENT_DAYLIGHT));\r\n    }\r\n  }\r\n\r\n  get sunAmount() {\r\n    return (Math.atan(Math.sin(this.sunAngle) * 12) / (Math.PI / 2)) * 0.5 + 0.5;\r\n  }\r\n\r\n  getCurrentTemperature() {\r\n    const { season } = this.world.season;\r\n    return this.world.environment.temperaturePerSeason[season];\r\n  }\r\n\r\n  step(dt: number) {\r\n    this.updateTemperatures();\r\n    this.computeSunlight();\r\n    this.stepWeather(dt);\r\n  }\r\n\r\n  public stepWeather(dt: number) {\r\n    const world = this.world;\r\n    // offset first rain event by a few seconds\r\n    const isRaining =\r\n      (world.time + world.environment.climate.timeBetweenRainfall - 6) % world.environment.climate.timeBetweenRainfall <\r\n      world.environment.climate.rainDuration;\r\n    if (isRaining) {\r\n      // add multiple random droplets\r\n      let numWater = world.environment.climate.waterPerSecond * dt;\r\n      while (numWater > 0) {\r\n        const dropletSize = Math.min(numWater, 1);\r\n        const x = randInt(0, world.width - 1);\r\n        const t = world.tileAt(x, 0);\r\n        if (t instanceof Air) {\r\n          const w = randRound(dropletSize);\r\n          t.inventory.add(w, 0);\r\n          world.numRainWater += w;\r\n        }\r\n        numWater -= 1;\r\n      }\r\n    }\r\n  }\r\n\r\n  public computeSunlight() {\r\n    // step downards from the top; neighbors don't affect the calculation so\r\n    // we don't have buffering problems\r\n    // TODO allow sunlight to go full 45-to-90 degrees\r\n    const sunAngle = this.sunAngle;\r\n    const directionalBias = Math.sin(sunAngle - Math.PI / 2);\r\n    const sunAmount = this.sunAmount;\r\n    for (let y = 0; y <= this.world.height; y++) {\r\n      for (let x = 0; x < this.world.width; x++) {\r\n        const t = this.world.environmentTileAt(x, y);\r\n        if (t instanceof Air) {\r\n          let sunlight = 0;\r\n          if (y === 0) {\r\n            sunlight = 1;\r\n          } else {\r\n            const tileUp = this.world.tileAt(x, y - 1);\r\n            const tileRight = this.world.tileAt(x + 1, y - 1);\r\n            const tileLeft = this.world.tileAt(x - 1, y - 1);\r\n            const upSunlight = tileUp instanceof Air ? tileUp.sunlightCached / sunAmount : tileUp == null ? 1 : 0;\r\n            const rightSunlight =\r\n              tileRight instanceof Air ? tileRight.sunlightCached / sunAmount : tileRight == null ? 1 : 0;\r\n            const leftSunlight =\r\n              tileLeft instanceof Air ? tileLeft.sunlightCached / sunAmount : tileLeft == null ? 1 : 0;\r\n            if (directionalBias > 0) {\r\n              // positive light travels to the right\r\n              sunlight = rightSunlight * directionalBias + upSunlight * (1 - directionalBias);\r\n            } else {\r\n              sunlight = leftSunlight * -directionalBias + upSunlight * (1 - -directionalBias);\r\n            }\r\n            sunlight =\r\n              sunlight * (1 - SUNLIGHT_DIFFUSION) +\r\n              ((upSunlight + rightSunlight + leftSunlight) / 3) * SUNLIGHT_DIFFUSION;\r\n          }\r\n          // have at least a bit\r\n          sunlight = SUNLIGHT_REINTRODUCTION + sunlight * (1 - SUNLIGHT_REINTRODUCTION);\r\n          sunlight *= sunAmount;\r\n          t.sunlightCached = sunlight;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public updateTemperatures() {\r\n    for (const t of this.world.allCells()) {\r\n      t.temperatureFloat = t.nextTemperature;\r\n    }\r\n  }\r\n}\r\n","import { Environment } from \"core/environment\";\r\nimport { EventEmitter } from \"events\";\r\nimport { gridRange } from \"math/arrays\";\r\nimport { TileGenerators } from \"std/tileGenerators\";\r\nimport { Vector2 } from \"three\";\r\nimport devlog from \"../../common/devlog\";\r\nimport shuffle from \"../../math/shuffle\";\r\nimport Genome from \"../cell/genome\";\r\nimport { DIRECTION_VALUES } from \"../directions\";\r\nimport { Entity, isSteppable, step } from \"../entity\";\r\nimport { Player, PlayerSeed } from \"../player/player\";\r\nimport { Season, seasonFromTime } from \"../season\";\r\nimport { Species } from \"../species\";\r\nimport { Air, Cell, Soil, Tile } from \"../tile\";\r\nimport { TileEvent } from \"../tile/tileEvent\";\r\nimport { createGeneratorContext, GeneratorContext } from \"./generatorContext\";\r\nimport { StepStats } from \"./stepStats\";\r\nimport { WeatherController } from \"./weatherController\";\r\n\r\nexport interface WorldOptions {\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nconst optionsDefault: WorldOptions = {\r\n  width: 50,\r\n  height: 100,\r\n};\r\n\r\nexport class World {\r\n  public time: number = 0;\r\n\r\n  public frame: number = 0;\r\n\r\n  public readonly width: number;\r\n\r\n  public readonly height: number;\r\n\r\n  public readonly player: Player;\r\n\r\n  public playerSeed?: PlayerSeed;\r\n\r\n  private events = new EventEmitter();\r\n\r\n  private readonly gridEnvironment: Tile[][];\r\n\r\n  private readonly gridCells: Array<Array<Cell | null>>;\r\n\r\n  private readonly neighborCache: Array<Array<Map<Vector2, Tile>>>;\r\n\r\n  public readonly mpEarners = new Map<Cell, number>();\r\n\r\n  public readonly species: Species;\r\n\r\n  public readonly generatorContext: GeneratorContext;\r\n\r\n  public weather: WeatherController;\r\n\r\n  genome: Genome;\r\n\r\n  get season(): Season {\r\n    return seasonFromTime(this.time);\r\n  }\r\n\r\n  constructor(\r\n    public environment: Environment,\r\n    seed: number,\r\n    species: Species,\r\n    optionsPartial: Partial<WorldOptions> = {}\r\n  ) {\r\n    const options = { ...optionsDefault, ...optionsPartial };\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this.generatorContext = createGeneratorContext(seed);\r\n    this.species = species;\r\n    this.genome = species.genome;\r\n    this.weather = new WeatherController(this);\r\n\r\n    const tileGenerator = typeof environment.fill === \"string\" ? TileGenerators[environment.fill] : environment.fill;\r\n    this.gridEnvironment = gridRange(this.width, this.height, (x, y) => {\r\n      const pos = new Vector2(x, y);\r\n      return tileGenerator(pos, this) || new Air(pos, this);\r\n    });\r\n\r\n    this.gridCells = gridRange(this.width, this.height, () => null);\r\n    this.neighborCache = gridRange(this.width, this.height, (x, y) => this.computeTileNeighbors(x, y));\r\n    this.fillCachedEntities();\r\n\r\n    this.computeSoilDepths();\r\n\r\n    // always drop player on the Soil Air interface\r\n    const start = new Vector2(Math.floor(this.width / 2), Math.floor(this.height / 2));\r\n    const firstNonAir = this.gridEnvironment[start.x].find((t) => !(t instanceof Air));\r\n    if (firstNonAir != null) {\r\n      // if we hit a rock, go onto the Air right above it\r\n      start.y = firstNonAir.isObstacle ? firstNonAir.pos.y - 1 : firstNonAir.pos.y;\r\n    }\r\n\r\n    this.player = new Player(start, this);\r\n    this.playerSeed = new PlayerSeed(start, this, this.player);\r\n\r\n    this.fillCachedEntities();\r\n\r\n    // step all tiles first with 0 timestep to trigger any initial state\r\n    gridRange(this.width, this.height, (x, y) => {\r\n      const tileEnvironment = this.gridEnvironment[x][y];\r\n      tileEnvironment && tileEnvironment.step(0);\r\n\r\n      const tileCell = this.gridCells[x][y];\r\n      tileCell && tileCell.step(0);\r\n    });\r\n    this.weather.step(0);\r\n  }\r\n\r\n  public on(event: \"step\", cb: (action: StepStats) => void): void;\r\n\r\n  public on(event: string, cb: (...args: any[]) => void) {\r\n    this.events.on(event, cb);\r\n  }\r\n\r\n  public off(event: string, cb: (...args: any[]) => void) {\r\n    this.events.off(event, cb);\r\n  }\r\n\r\n  public removePlayerSeed() {\r\n    this.stepStats.deleted.push(this.playerSeed!);\r\n    delete this.playerSeed;\r\n  }\r\n\r\n  public tileAt(v: Vector2): Tile | null;\r\n\r\n  public tileAt(x: number, y: number): Tile | null;\r\n\r\n  public tileAt(xOrVec2: number | Vector2, y?: number): Tile | null {\r\n    let x: number;\r\n    if (xOrVec2 instanceof Vector2) {\r\n      x = xOrVec2.x;\r\n      y = xOrVec2.y;\r\n    } else {\r\n      x = xOrVec2;\r\n      y = y!;\r\n    }\r\n\r\n    if (!this.isValidPosition(x, y)) {\r\n      return null;\r\n    }\r\n    const cell = this.gridCells[x][y];\r\n    if (cell != null) {\r\n      return cell;\r\n    } else {\r\n      return this.gridEnvironment[x][y];\r\n    }\r\n  }\r\n\r\n  public cellAt(v: Vector2): Cell | null;\r\n\r\n  public cellAt(x: number, y: number): Cell | null;\r\n\r\n  public cellAt(x: number | Vector2, y?: number): Cell | null {\r\n    if (x instanceof Vector2) {\r\n      y = x.y;\r\n      x = x.x;\r\n    }\r\n    if (this.isValidPosition(x, y!)) {\r\n      return this.gridCells[x][y!];\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  public environmentTileAt(x: number, y: number): Tile | null {\r\n    if (this.isValidPosition(x, y)) {\r\n      return this.gridEnvironment[x][y];\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Rules for replacement:\r\n  // if tile is environment, clear out the gridCell and set the gridEnvironment.\r\n  // if tile is cell, set gridCell, leave gridEnvironment alone.\r\n  public setTileAt(position: Vector2, tile: Tile) {\r\n    const { x, y } = position;\r\n    if (!this.isValidPosition(x, y)) {\r\n      throw new Error(`invalid position ${x}, ${y} `);\r\n    }\r\n    if (tile instanceof Cell && tile.isReproductive) {\r\n      this.mpEarners.set(tile, 0);\r\n    }\r\n    const oldTile = this.tileAt(x, y)!;\r\n    // if replacing a tile, try redistributing inventory to neighbors\r\n    oldTile.redistributeInventoryToNeighbors();\r\n    if (oldTile.inventory.water !== 0 || oldTile.inventory.sugar !== 0) {\r\n      console.warn(\"lost\", oldTile.inventory, \"resources to building\");\r\n      oldTile.inventory.add(-oldTile.inventory.water, -oldTile.inventory.sugar);\r\n    }\r\n\r\n    const oldCell = this.gridCells[x][y];\r\n    if (oldCell != null) {\r\n      this.stepStats.deleted.push(oldCell);\r\n    }\r\n\r\n    if (tile instanceof Cell) {\r\n      // set gridCell only\r\n      this.gridCells[x][y] = tile;\r\n    } else {\r\n      // hackhack - we should call .die() on gridCells[x][y] but we already have with the oldTile code above\r\n      this.gridCells[x][y] = null;\r\n\r\n      const oldEnvironmentTile = this.gridEnvironment[x][y];\r\n      if (oldEnvironmentTile != null) {\r\n        this.stepStats.deleted.push(oldEnvironmentTile);\r\n      }\r\n      this.gridEnvironment[x][y] = tile;\r\n    }\r\n    this.stepStats.added.push(tile);\r\n    this.handleTileUpdated(position);\r\n  }\r\n\r\n  public maybeRemoveCellAt(position: Vector2): Cell | null {\r\n    const cell = this.cellAt(position.x, position.y);\r\n    if (cell) {\r\n      cell.redistributeInventoryToNeighbors();\r\n      this.gridCells[position.x][position.y] = null;\r\n      this.stepStats.deleted.push(cell);\r\n      cell.isDead = true;\r\n    }\r\n    this.handleTileUpdated(position);\r\n    return cell;\r\n  }\r\n\r\n  public isValidPosition(x: number, y: number) {\r\n    if (x >= this.width || x < 0 || y >= this.height || y < 0) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a map from direction offsets (DIRECTIONS.n, .nw, .ne, etc.) to Tile neighbors occupying that offset.\r\n   */\r\n  public tileNeighbors(pos: Vector2) {\r\n    return this.neighborCache[pos.x][pos.y];\r\n  }\r\n\r\n  private computeTileNeighbors(px: number, py: number) {\r\n    const mapping = new Map<Vector2, Tile>();\r\n    // randomize the neighbor array to reduce aliasing\r\n    const directions = DIRECTION_VALUES_RAND[this.frame % DIRECTION_VALUES_RAND.length];\r\n    directions.forEach((v) => {\r\n      const x = px + v.x;\r\n      const y = py + v.y;\r\n      const tile = this.tileAt(x, y);\r\n      if (tile != null) {\r\n        mapping.set(v, tile);\r\n      }\r\n    });\r\n    return mapping;\r\n  }\r\n  // only use for rendering\r\n  // private cachedRenderableEntities?: Entity[];\r\n  // public renderableEntities() {\r\n  //     if (this.cachedRenderableEntities == null) {\r\n  //         throw new Error(\"accessed renderable entities before filling\");\r\n  //     }\r\n  //     return this.cachedRenderableEntities;\r\n  // }\r\n\r\n  private cachedEntities?: Entity[];\r\n\r\n  public entities() {\r\n    if (this.cachedEntities == null) {\r\n      throw new Error(\"accessed entities before filling\");\r\n    }\r\n    return this.cachedEntities;\r\n  }\r\n\r\n  private handleTileUpdated(pos: Vector2) {\r\n    this.neighborCache[pos.x][pos.y] = this.computeTileNeighbors(pos.x, pos.y);\r\n    for (const dir of DIRECTION_VALUES) {\r\n      const x = pos.x + dir.x;\r\n      const y = pos.y + dir.y;\r\n      if (this.isValidPosition(x, y)) {\r\n        this.neighborCache[x][y] = this.computeTileNeighbors(x, y);\r\n      }\r\n    }\r\n    this.fillCachedEntities();\r\n  }\r\n\r\n  private fillCachedEntities() {\r\n    const newEntities: Entity[] = [];\r\n    // we do this super hacky thing for performance where we only run every other entity in\r\n    // a checkerboard pattern.\r\n    //\r\n    // also, entities can interact with other entities, there is no lock-step buffer state,\r\n    // which means you can get weird artifacts like \"water suddenly moves 20 squares\".\r\n    // to combat this we alternatingly reverse the tile iteration order.\r\n    let x = 0,\r\n      y = 0;\r\n    for (x = 0; x < this.width; x++) {\r\n      for (y = (x + this.frame) % 2; y < this.height; y += 2) {\r\n        // checkerboard\r\n        newEntities.push(this.tileAt(x, y)!);\r\n      }\r\n    }\r\n    for (x = 0; x < this.width; x++) {\r\n      for (y = (x + this.frame + 1) % 2; y < this.height; y += 2) {\r\n        // opposite checkerboard\r\n        newEntities.push(this.tileAt(x, y)!);\r\n      }\r\n    }\r\n    if (this.frame % 4 < 2) {\r\n      newEntities.reverse();\r\n    }\r\n    // add player at the end - this is important since Player is currently the only thing\r\n    // that modifies tiles. You can get into situations where tiles that should be dead\r\n    // are still left-over in the entities cache.\r\n    if (this.playerSeed) {\r\n      newEntities.push(this.playerSeed);\r\n    } else {\r\n      newEntities.push(this.player);\r\n    }\r\n    this.cachedEntities = newEntities;\r\n\r\n    // update renderable entities\r\n    // (() => {\r\n    //     const entities: Entity[] = [this.player];\r\n    //     for (x = 0; x < width; x++) {\r\n    //         for (y = 0; y < height; y++) {\r\n    //             entities.push(this.gridEnvironment[x][y]);\r\n    //             const cellMaybe = this.gridCells[x][y];\r\n    //             if (cellMaybe != null) {\r\n    //                 entities.push(cellMaybe);\r\n    //             }\r\n    //         }\r\n    //     }\r\n    //     this.cachedRenderableEntities = entities;\r\n    // })();\r\n  }\r\n\r\n  private stepStats: StepStats = new StepStats(0, this.frame);\r\n\r\n  public step(dt: number): StepStats {\r\n    const entities = this.entities();\r\n    this.stepStats = new StepStats(dt, this.frame);\r\n    // dear god\r\n    entities.forEach((entity) => {\r\n      if (isSteppable(entity)) {\r\n        step(entity, dt);\r\n      }\r\n    });\r\n    this.weather.step(dt);\r\n    this.frame++;\r\n    this.time += dt;\r\n    this.fillCachedEntities();\r\n    this.events.emit(\"step\", this.stepStats);\r\n    return this.stepStats;\r\n    // this.checkResources();\r\n  }\r\n\r\n  logEvent(event: TileEvent) {\r\n    this.stepStats.logEvent(event);\r\n  }\r\n\r\n  public getLastStepStats() {\r\n    return this.stepStats;\r\n  }\r\n\r\n  numRainWater = 0;\r\n\r\n  numEvaporatedAir = 0;\r\n\r\n  numEvaporatedSoil = 0;\r\n\r\n  public computeSoilDepths() {\r\n    const airPositions = Array.from(this.allEnvironmentTiles())\r\n      .filter((t) => t instanceof Air)\r\n      .map((t) => t.pos);\r\n\r\n    for (const tile of this.bfsIterator(airPositions, this.width * this.height)) {\r\n      if (tile instanceof Soil) {\r\n        let minNeighborDepth = tile.depth;\r\n        for (const [, neighbor] of this.tileNeighbors(tile.pos)) {\r\n          if (neighbor instanceof Air) {\r\n            minNeighborDepth = 0;\r\n          } else if (neighbor instanceof Soil) {\r\n            minNeighborDepth = Math.min(minNeighborDepth, neighbor.depth);\r\n          }\r\n        }\r\n        tile.depth = minNeighborDepth + 1;\r\n      }\r\n    }\r\n  }\r\n\r\n  earnMP(cell: Cell, mpEarned: number) {\r\n    this.mpEarners.set(cell, mpEarned);\r\n  }\r\n\r\n  public checkResources() {\r\n    let totalSugar = 0;\r\n    let totalWater = 0;\r\n    let totalEnergy = 0;\r\n    this.entities().forEach((e) => {\r\n      totalSugar += e.inventory.sugar;\r\n      totalWater += e.inventory.water;\r\n      if (e instanceof Cell) {\r\n        totalEnergy += e.energy;\r\n      }\r\n    });\r\n    devlog(\"sugar\", totalSugar, \"water\", totalWater, \"energy\", totalEnergy);\r\n  }\r\n\r\n  public allCells() {\r\n    const { gridCells, width, height } = this;\r\n    return {\r\n      *[Symbol.iterator]() {\r\n        for (let x = 0; x < width; x++) {\r\n          for (let y = 0; y < height; y++) {\r\n            const g = gridCells[x][y];\r\n            if (g != null) {\r\n              yield g;\r\n            }\r\n          }\r\n        }\r\n      },\r\n    };\r\n  }\r\n\r\n  public allEnvironmentTiles() {\r\n    const self = this;\r\n    return {\r\n      *[Symbol.iterator]() {\r\n        for (const row of self.gridEnvironment) {\r\n          for (const t of row) {\r\n            yield t;\r\n          }\r\n        }\r\n      },\r\n    };\r\n  }\r\n\r\n  allTiles() {\r\n    const { width, height } = this;\r\n    const self = this;\r\n    return {\r\n      *[Symbol.iterator]() {\r\n        for (let x = 0; x < width; x++) {\r\n          for (let y = 0; y < height; y++) {\r\n            const g = self.tileAt(x, y);\r\n            if (g != null) {\r\n              yield g;\r\n            }\r\n          }\r\n        }\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Breadth first search (floodfill) generator\r\n   */\r\n  public bfsIterator(\r\n    start: Vector2 | Vector2[],\r\n    limit: number,\r\n    filter?: (tile: Tile) => boolean,\r\n    heuristic?: (tile: Tile) => number\r\n  ) {\r\n    const self = this;\r\n    const frontier = (Array.isArray(start) ? start : [start]).map((v) => this.tileAt(v)!);\r\n    const processed = new Set<Tile>();\r\n    return {\r\n      *[Symbol.iterator]() {\r\n        while (frontier.length > 0 && processed.size < limit) {\r\n          const tile = frontier.shift();\r\n          if (tile == null) {\r\n            return;\r\n          }\r\n          processed.add(tile);\r\n          yield tile;\r\n          const neighbors = self.tileNeighbors(tile.pos);\r\n          for (const [offset, n] of neighbors) {\r\n            if (\r\n              offset.manhattanLength() === 1 &&\r\n              (filter == null || filter(n)) &&\r\n              frontier.indexOf(n) === -1 &&\r\n              !processed.has(n)\r\n            ) {\r\n              frontier.push(n);\r\n            }\r\n          }\r\n          if (heuristic) {\r\n            frontier.sort((a, b) => heuristic(a) - heuristic(b));\r\n          }\r\n        }\r\n      },\r\n    };\r\n  }\r\n}\r\n\r\nconst DIRECTION_VALUES_RAND = [\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n];\r\n","import { Color, Vector2 } from \"three\";\r\nimport Chromosome from \"../../core/cell/chromosome\";\r\nimport Genome, { CellType } from \"../../core/cell/genome\";\r\nimport {\r\n  GeneEnergyTransfer,\r\n  GeneInventory,\r\n  GeneLiving,\r\n  GeneMetabolism,\r\n  GeneObstacle,\r\n  GenePhotosynthesis,\r\n  GeneScaffolding,\r\n  GeneSeed,\r\n  GeneSoilAbsorption,\r\n} from \"../genes\";\r\n\r\nconst cellTypeTissue = new CellType(\r\n  \"Tissue\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneInventory.level(2), GeneMetabolism.level(2), GeneEnergyTransfer.level(1)),\r\n  {\r\n    texturePosition: new Vector2(1, 1),\r\n    color: new Color(0x30ae25),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeLeaf = new CellType(\r\n  \"Leaf\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(0), GeneObstacle.level(0), GeneInventory.level(2), GenePhotosynthesis.level(1)),\r\n  {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(2, 1),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"water take sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeRoot = new CellType(\r\n  \"Root\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneScaffolding.level(1), GeneInventory.level(3), GeneSoilAbsorption.level(2)),\r\n  {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(3, 1),\r\n  },\r\n  {\r\n    type: \"take\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeSeed = new CellType(\"Seed\", 0, new Chromosome(GeneLiving.level(2), GeneSeed.level(0)), {\r\n  texturePosition: new Vector2(1, 4),\r\n});\r\n\r\nexport const tutorialGenome = new Genome([cellTypeTissue, cellTypeLeaf, cellTypeRoot, cellTypeSeed]);\r\n","import Genome from \"core/cell/genome\";\r\nimport { createSimpleSchema, identifier, list, object, primitive, reference } from \"serializr\";\r\nimport { tutorialGenome } from \"std/genomes/tutorialGenome\";\r\nimport uuid from \"uuid\";\r\nimport { RealizedGene } from \"./cell\";\r\n\r\nexport interface Species {\r\n  genome: Genome;\r\n  id: string;\r\n  name: string;\r\n  freeMutationPoints: number;\r\n  descendants: Species[];\r\n  parent?: Species;\r\n  geneOptions: RealizedGene[];\r\n}\r\n\r\nexport const SpeciesSchema = createSimpleSchema<Species>({\r\n  // TODO fill in\r\n  genome: object(Genome),\r\n  id: identifier(),\r\n  name: primitive(),\r\n  freeMutationPoints: primitive(),\r\n  totalMutationPoints: primitive(),\r\n  geneOptions: list(object(RealizedGene)),\r\n});\r\n// we can't self-reference SpeciesSchema in its instantiation; set it after\r\nSpeciesSchema.props.descendants = list(object(SpeciesSchema));\r\nSpeciesSchema.props.parent = reference(SpeciesSchema);\r\n\r\nexport function newBaseSpecies(name = \"plantum originus\"): Species {\r\n  return {\r\n    id: uuid(),\r\n    genome: tutorialGenome,\r\n    name,\r\n    freeMutationPoints: 0,\r\n    descendants: [],\r\n    geneOptions: [],\r\n  };\r\n}\r\n\r\nexport function lineage(species: Species): Species[] {\r\n  const arr = [];\r\n  arr.push(species);\r\n  for (const s of species.descendants) {\r\n    arr.push(...lineage(s));\r\n  }\r\n  return arr;\r\n}\r\n","import { World } from \"core\";\r\nimport { Tile } from \"core/tile\";\r\n\r\nexport type Visitor = (tiles: Tile[], world: World) => number;\r\n\r\nexport interface Visitors {\r\n  [name: string]: Visitor;\r\n}\r\n\r\nexport function visit(tiles: Tile[], visitors: Visitors): Trial {\r\n  const results: Trial = {};\r\n  for (const [name, visitor] of Object.entries(visitors)) {\r\n    const result = visitor(tiles, tiles[0].world);\r\n    results[name] = result;\r\n  }\r\n  return results;\r\n}\r\n\r\nexport interface Trial {\r\n  [key: string]: number;\r\n}\r\n\r\nexport class Experiment {\r\n  trials: Trial[] = [];\r\n\r\n  constructor(public visitors: Visitors) {}\r\n\r\n  recordDataFor(tiles: Tile[]) {\r\n    const trial = visit(tiles, this.visitors);\r\n    this.trials.push(trial);\r\n  }\r\n\r\n  visitorNames() {\r\n    return Object.keys(this.visitors);\r\n  }\r\n}\r\n\r\nexport class ExperimentSuite {\r\n  constructor(public experiments: Experiment[]) {}\r\n\r\n  recordDataFor(tiles: Tile[]) {\r\n    for (const e of this.experiments) {\r\n      e.recordDataFor(tiles);\r\n    }\r\n  }\r\n}\r\n","import { Environment } from \"core/environment\";\r\nimport { Cell } from \"core/tile\";\r\nimport { Layout, PlotData } from \"plotly.js\";\r\nimport React from \"react\";\r\nimport { standardGenome } from \"std/genomes/standardGenome\";\r\nimport { World } from \"../core\";\r\nimport { newBaseSpecies } from \"../core/species\";\r\nimport { Experiment, Visitors } from \"./experiment\";\r\n\r\nconst allSoilEnvironment: Environment = {\r\n  airEvaporation: 0,\r\n  climate: { rainDuration: 0, timeBetweenRainfall: Infinity, waterPerSecond: 0 },\r\n  fill: (pos, world) => undefined,\r\n  secondsToEvaporate: Infinity,\r\n  floorCo2: 1,\r\n  temperaturePerSeason: [50, 50, 50, 50],\r\n};\r\n\r\nfunction testWorld(width: number, height: number) {\r\n  const world = new World(allSoilEnvironment, 0, newBaseSpecies(), {\r\n    width,\r\n    height,\r\n  });\r\n  const cellTypeTissue = standardGenome.cellTypes[0];\r\n  for (const t of world.allEnvironmentTiles()) {\r\n    const p = t.pos;\r\n    world.setTileAt(p, new Cell(p, world, cellTypeTissue));\r\n  }\r\n  world.cellAt(0, 0)!.inventory.set(100, 0);\r\n  return world;\r\n}\r\nfunction runOneWideAbsolute() {\r\n  const world1 = testWorld(20, 1);\r\n  const visitors: Visitors = {\r\n    time: (t) => t[0].world.time,\r\n  };\r\n  for (const c of world1.allCells()) {\r\n    const pos = c.pos;\r\n    const cell1 = world1.cellAt(pos)!;\r\n    visitors[pos.x] = () => {\r\n      const c1w = cell1.inventory.water;\r\n      return c1w;\r\n    };\r\n  }\r\n  const experiment = new Experiment(visitors);\r\n  console.time(\"run simulation\");\r\n  do {\r\n    if (world1.time % 1 < 0.1) {\r\n      experiment.recordDataFor(Array.from(world1.allCells()));\r\n    }\r\n    world1.step(0.1);\r\n  } while (world1.time <= 10);\r\n  console.timeEnd(\"run simulation\");\r\n  return experiment;\r\n}\r\n\r\nfunction runTwoWideCompare() {\r\n  const world1 = testWorld(20, 1);\r\n  const world2 = testWorld(20, 2);\r\n  const visitors: Visitors = {\r\n    time: (t) => t[0].world.time,\r\n  };\r\n  for (const c of world1.allCells()) {\r\n    const pos = c.pos;\r\n    const cell1 = world1.cellAt(pos)!;\r\n    const cell2 = world2.cellAt(pos)!;\r\n    visitors[pos.x] = () => {\r\n      const c1w = cell1.inventory.water;\r\n      const c2w = cell2.inventory.water;\r\n      // how much faster (or slower) a 2 wide channel goes compared to a one-wide\r\n      return c2w - c1w;\r\n    };\r\n  }\r\n  const experiment = new Experiment(visitors);\r\n  console.time(\"run simulation\");\r\n  do {\r\n    if (world1.time % 1 < 0.1) {\r\n      experiment.recordDataFor(Array.from(world1.allCells()));\r\n    }\r\n    world1.step(0.1);\r\n    world2.step(0.1);\r\n  } while (world1.time <= 10);\r\n  console.timeEnd(\"run simulation\");\r\n  return experiment;\r\n}\r\n\r\nfunction plotStackedBar(experiment: Experiment, divId: string) {\r\n  const data = [];\r\n  for (const trialIndex in experiment.trials) {\r\n    const trial = experiment.trials[trialIndex];\r\n    const x = [];\r\n    const y = [];\r\n    for (const name of experiment.visitorNames()) {\r\n      x.push(name);\r\n      const value = trial[name];\r\n      y.push(value);\r\n    }\r\n    const trace: Partial<PlotData> = {\r\n      x,\r\n      y,\r\n      name: `t=${Number(trialIndex) / 10}`,\r\n      type: \"bar\",\r\n    };\r\n    data.push(trace);\r\n  }\r\n  var layout: Partial<Layout> = { barmode: \"stack\" };\r\n\r\n  const div = document.createElement(\"div\");\r\n  const el = document.getElementById(divId)!;\r\n  el.appendChild(div);\r\n  window.Plotly.newPlot(div, data, layout);\r\n}\r\n\r\nfunction TestDiffusion() {\r\n  React.useEffect(() => {\r\n    var script = document.createElement(\"script\");\r\n    script.src = \"https://cdn.plot.ly/plotly-latest.min.js\";\r\n    script.addEventListener(\"load\", function() {\r\n      const e = runTwoWideCompare();\r\n      plotStackedBar(e, \"water-over-time\");\r\n    });\r\n    script.addEventListener(\"error\", () => {\r\n      const e1 = runOneWideAbsolute();\r\n      console.table(e1.trials);\r\n      const e2 = runTwoWideCompare();\r\n      console.table(e2.trials);\r\n    });\r\n\r\n    document.body.appendChild(script);\r\n  }, []);\r\n\r\n  return (\r\n    <div>\r\n      <h1>Test Diffusion</h1>\r\n      <div id=\"water-over-time\">\r\n        <h2>width 20 world, water from t=0 to t=1 </h2>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default TestDiffusion;\r\n","import { LevelInfo } from \"core/overworld/levelInfo\";\r\nimport { Environment } from \"../core/environment\";\r\n\r\nexport function environmentFromLevelInfo(info: LevelInfo) {\r\n  // const { rainfall, soilType, temperature } = levelInfo;\r\n\r\n  switch (info.height) {\r\n    case 0:\r\n      return Level0;\r\n    case 1:\r\n      return Temperate;\r\n    case 2:\r\n      return Reservoires;\r\n    case 3:\r\n      return Rocky;\r\n    case 4:\r\n      return SkySoil;\r\n    case 5:\r\n    default:\r\n      return Desert;\r\n  }\r\n  // return Reservoires;\r\n}\r\n\r\nexport const Level0: Environment = {\r\n  airEvaporation: 0.2,\r\n  climate: {\r\n    // 9 water/sec\r\n    timeBetweenRainfall: 70,\r\n    rainDuration: 3,\r\n    waterPerSecond: 210,\r\n  },\r\n  secondsToEvaporate: 166,\r\n  floorCo2: 0.85,\r\n  temperaturePerSeason: [48, 56, 52, 43],\r\n  fill: \"Level0\",\r\n};\r\n\r\nexport const Temperate: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    // 8.62 water/sec\r\n    timeBetweenRainfall: 65,\r\n    rainDuration: 2.8,\r\n    waterPerSecond: 200,\r\n  },\r\n  secondsToEvaporate: 166,\r\n  floorCo2: 0.5,\r\n  temperaturePerSeason: [53, 81, 43, 20],\r\n  fill: \"Temperate\",\r\n};\r\n\r\nexport const Reservoires: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    // 12 water/sec (!)\r\n    timeBetweenRainfall: 20,\r\n    rainDuration: 8,\r\n    waterPerSecond: 30,\r\n  },\r\n  secondsToEvaporate: 166,\r\n  floorCo2: 0.5,\r\n  temperaturePerSeason: [53, 75, 43, 25],\r\n  fill: \"Reservoires\",\r\n};\r\n\r\nexport const Rocky: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    // 8.6 water/sec, but much longer apart\r\n    timeBetweenRainfall: 83.333,\r\n    rainDuration: 4,\r\n    waterPerSecond: 180,\r\n  },\r\n  secondsToEvaporate: 33,\r\n  floorCo2: 1,\r\n  temperaturePerSeason: [40, 62, 36, 15],\r\n  fill: \"Rocky\",\r\n};\r\n\r\nexport const SkySoil: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    // 9 water/sec; often, but small rains\r\n    timeBetweenRainfall: 12,\r\n    rainDuration: 6,\r\n    waterPerSecond: 18,\r\n  },\r\n  secondsToEvaporate: 33,\r\n  floorCo2: 1,\r\n  temperaturePerSeason: [18, 62, 36, 15],\r\n  fill: \"SkySoil\",\r\n};\r\n\r\nexport const Desert: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    // 5.57 water/sec (very little!)\r\n    timeBetweenRainfall: 110,\r\n    rainDuration: 6.3333,\r\n    waterPerSecond: 220,\r\n  },\r\n  secondsToEvaporate: 16,\r\n  floorCo2: 0.95,\r\n  temperaturePerSeason: [72, 89, 110, 50],\r\n  fill: \"Desert\",\r\n};\r\n","import characterSrc from \"assets/images/character.png\";\r\nimport classNames from \"classnames\";\r\nimport React from \"react\";\r\nimport \"./Character.scss\";\r\n\r\nfunction Character(props: JSX.IntrinsicElements[\"img\"] & { size?: \"xs\" | \"small\" | \"medium\" | \"large\" }) {\r\n  const { size, className, ...otherProps } = props;\r\n  return <img className={classNames(\"character\", size, className)} alt=\"\" src={characterSrc} {...otherProps} />;\r\n}\r\n\r\nexport default Character;\r\n","import * as React from \"react\";\r\nimport \"./Glow.scss\";\r\n\r\nexport function Glow() {\r\n  return (\r\n    <div className=\"glow\">\r\n      <span />\r\n    </div>\r\n  );\r\n}\r\n","import { Slider } from \"@blueprintjs/core\";\r\nimport fruitSrc from \"assets/images/fruit.png\";\r\nimport classNames from \"classnames\";\r\nimport { PopulationAttempt } from \"game/app\";\r\nimport MP from \"game/ui/common/MP\";\r\nimport { map } from \"math\";\r\nimport * as React from \"react\";\r\nimport { GeneInstance } from \"../../core/cell/geneInstance\";\r\nimport { seasonDisplay, seasonFromTime } from \"../../core/season\";\r\nimport { Cell } from \"../../core/tile\";\r\nimport { GeneFruit, reproducerGetPercentMatured } from \"../../std/genes/GeneReproducer\";\r\nimport { mitoDeath } from \"../audio\";\r\nimport { GameResult } from \"../gameResult\";\r\nimport Character from \"../ui/common/Character\";\r\nimport { Glow } from \"../ui/common/Glow\";\r\nimport \"./GameResultsScreen.scss\";\r\n\r\ninterface GameResultsScreenProps {\r\n  onDone: () => void;\r\n  results: GameResult;\r\n  attempt?: PopulationAttempt;\r\n}\r\n\r\nfunction FruitResult({ fruit, mpEarned }: { fruit: GeneInstance<GeneFruit>; mpEarned: number }) {\r\n  const scale = map(reproducerGetPercentMatured(fruit), 0, 1, 0.2, 1);\r\n  const style = React.useMemo(() => {\r\n    return {\r\n      transform: `scale(${scale})`,\r\n    };\r\n  }, [scale]);\r\n  return (\r\n    <div className=\"fruit-info\">\r\n      <div className=\"fruit-visual\">\r\n        {fruit.state.isMature ? <Glow /> : null}\r\n        <img alt=\"\" src={fruitSrc} style={style} />\r\n      </div>\r\n      {fruit.state.timeMatured != null ? (\r\n        <>\r\n          <span className=\"matured-info success\">\r\n            +<MP amount={mpEarned} />\r\n          </span>\r\n          &nbsp;at {seasonDisplay(seasonFromTime(fruit.state.timeMatured))}, Mutation Points earned: 1\r\n        </>\r\n      ) : (\r\n        <span className=\"matured-info in-progress\">\r\n          {(reproducerGetPercentMatured(fruit) * 100).toFixed(0)}% maturity\r\n        </span>\r\n      )}\r\n      , started at {seasonDisplay(seasonFromTime(fruit.cell.timeMade))}.\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ReproductiveCellResult({ cell, mpEarned }: { cell: Cell; mpEarned: number }) {\r\n  const fruit = cell.findGene(GeneFruit);\r\n  if (fruit != null) {\r\n    return <FruitResult fruit={fruit} mpEarned={mpEarned} />;\r\n  } else {\r\n    return (\r\n      <div>\r\n        {cell.toString()} +<MP amount={mpEarned} />\r\n      </div>\r\n    );\r\n  }\r\n}\r\n\r\nfunction MPEarnerList({ mpEarners, className }: { mpEarners: Map<Cell, number>; className?: string }) {\r\n  if (mpEarners.size > 0) {\r\n    return (\r\n      <div className={classNames(\"mp-earner-list\", className)}>\r\n        <h5>Reproductive Cells</h5>\r\n        <div>\r\n          {Array.from(mpEarners.entries()).map(([cell, mpEarned]) => (\r\n            <ReproductiveCellResult cell={cell} mpEarned={mpEarned} />\r\n          ))}\r\n        </div>\r\n      </div>\r\n    );\r\n  } else {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction VignetteList({ vignettes }: { vignettes?: HTMLCanvasElement[] | undefined }) {\r\n  const [index, setIndex] = React.useState(0);\r\n  if (vignettes && vignettes.length > 0) {\r\n    return (\r\n      <div className=\"vignette-viewer\">\r\n        <Slider\r\n          className=\"slider\"\r\n          value={index}\r\n          min={0}\r\n          stepSize={1}\r\n          max={vignettes.length - 1}\r\n          onChange={setIndex}\r\n          showTrackFill={false}\r\n          labelRenderer={(val) => `Day ${val + 1}`}\r\n        />\r\n        <div className=\"current-vignette\">\r\n          <img src={vignettes[index].toDataURL()} alt=\"\" />\r\n        </div>\r\n      </div>\r\n    );\r\n  } else {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction GameWonScreen({ results }: GameResultsScreenProps) {\r\n  const winDescription =\r\n    Array.from(results.mpEarners.entries()).filter(([c, mp]) => mp > 0).length < 3 ? \"survived\" : \"thrived\";\r\n  return (\r\n    <>\r\n      <div className=\"character-container\">\r\n        <Character size=\"large\" className=\"dance\" />\r\n      </div>\r\n      <h1>You {winDescription}!</h1>\r\n      <h2>{results.mutationPointsPerEpoch} Mutation Points earned.</h2>\r\n      <VignetteList vignettes={results.vignettes} />\r\n      <MPEarnerList mpEarners={results.mpEarners} />\r\n    </>\r\n  );\r\n}\r\n\r\nfunction GameLostScreen({ results }: GameResultsScreenProps) {\r\n  React.useEffect(() => {\r\n    mitoDeath.play();\r\n    return () => {\r\n      mitoDeath.stop();\r\n    };\r\n  }, []);\r\n  return (\r\n    <>\r\n      <div className=\"character-container\">\r\n        <Character className=\"sad\" size=\"large\" />\r\n      </div>\r\n      <h1>\r\n        <i>{results.world.species.name}</i> couldn't survive!\r\n      </h1>\r\n      <div>You survived until {seasonDisplay(results.world.season)}!</div>\r\n      <VignetteList vignettes={results.vignettes} />\r\n      <MPEarnerList mpEarners={results.mpEarners} className=\"dark\" />\r\n    </>\r\n  );\r\n}\r\n\r\nconst GameResultsScreen: React.FC<GameResultsScreenProps> = React.memo((props) => {\r\n  const { onDone, results, attempt } = props;\r\n  const primaryButtonText =\r\n    attempt != null && attempt.sourceHex == null && results.status === \"lost\" ? \"Retry\" : \"Continue\";\r\n  return (\r\n    <div className={`game-results-screen ${results.status}`}>\r\n      <div className=\"game-results-content\">\r\n        {results.status === \"won\" ? <GameWonScreen {...props} /> : <GameLostScreen {...props} />}\r\n        <button className=\"done-button\" onClick={onDone}>\r\n          {primaryButtonText} \r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default GameResultsScreen;\r\n","import { GameResult } from \"game/gameResult\";\r\nimport React from \"react\";\r\nimport { Temperate } from \"std/environments\";\r\nimport { GeneFruit } from \"std/genes/GeneReproducer\";\r\nimport { standardGenome } from \"std/genomes/standardGenome\";\r\nimport { Vector2 } from \"three\";\r\nimport { World } from \"../core\";\r\nimport { newBaseSpecies } from \"../core/species\";\r\nimport { Cell } from \"../core/tile\";\r\nimport GameResultsScreen from \"../game/screens/GameResultsScreen\";\r\n\r\nexport function mockFruit(world: World, percent: number, timeMatured?: number) {\r\n  const cellTypeFruit = standardGenome.cellTypes[4];\r\n  const cell = new Cell(new Vector2(0, 0), world, cellTypeFruit);\r\n  const fruit = cell.findGene(GeneFruit)!;\r\n  fruit.state.energyRecieved = fruit.props.neededResources * percent;\r\n  fruit.state.timeMatured = timeMatured;\r\n  fruit.state.isMature = percent === 1;\r\n  return cell;\r\n}\r\n\r\nexport function TestWinScreen() {\r\n  const world = new World(Temperate, 0, newBaseSpecies());\r\n  const f1 = mockFruit(world, 1, 250);\r\n  const f2 = mockFruit(world, 0.4);\r\n  const f3 = mockFruit(world, 1, 900);\r\n  const mockResults: GameResult = {\r\n    status: \"won\",\r\n    mpEarners: new Map([\r\n      [f1, 3],\r\n      [f2, 0],\r\n      [f3, 3],\r\n    ]),\r\n    mutationPointsPerEpoch: 6,\r\n    world,\r\n  };\r\n  return <GameResultsScreen results={mockResults} onDone={() => {}} />;\r\n}\r\n","import { TIME_PER_DAY } from \"core/constants\";\r\nimport { GameResult } from \"game/gameResult\";\r\nimport React from \"react\";\r\nimport { Temperate } from \"std/environments\";\r\nimport { World } from \"../core\";\r\nimport { newBaseSpecies } from \"../core/species\";\r\nimport GameResultsScreen from \"../game/screens/GameResultsScreen\";\r\nimport { mockFruit } from \"./TestWinScreen\";\r\n\r\nexport function TestLoseScreen() {\r\n  const world = new World(Temperate, 0, newBaseSpecies());\r\n  world.time = TIME_PER_DAY * 4;\r\n  const f1 = mockFruit(world, 0.4);\r\n  world.time = TIME_PER_DAY * 9;\r\n  const f2 = mockFruit(world, 0.3);\r\n  world.time = TIME_PER_DAY * 19;\r\n  const f3 = mockFruit(world, 0.01459);\r\n  const mockResults: GameResult = {\r\n    mpEarners: new Map([\r\n      [f1, 0],\r\n      [f2, 0],\r\n      [f3, 0],\r\n    ]),\r\n    status: \"lost\",\r\n    mutationPointsPerEpoch: 0,\r\n    world,\r\n  };\r\n  return <GameResultsScreen results={mockResults} onDone={() => {}} />;\r\n}\r\n","import React, { useContext } from \"react\";\r\n\r\nexport const MousePositionContext = React.createContext({\r\n  x: window.innerWidth / 2,\r\n  y: window.innerHeight / 2,\r\n});\r\n\r\nfunction useMousePosition() {\r\n  return useContext(MousePositionContext);\r\n}\r\n\r\nexport default useMousePosition;\r\n","import { RealizedGene } from \"core/cell\";\r\nimport { Species } from \"core/species\";\r\nimport { randInt } from \"math\";\r\nimport shuffle from \"math/shuffle\";\r\nimport { GeneDiffuseWater } from \"std/genes/GeneDiffuseWater\";\r\nimport { GenePipes } from \"std/genes/GenePipes\";\r\nimport { GeneTransport } from \"std/genes/GeneTransport\";\r\nimport { AllGenesByName } from \"../../../core/cell/gene\";\r\n\r\nexport function generateRandomGenes(numGenes = 3) {\r\n  // disallow same gene to spawn in one drawing\r\n  const AllGenes = Array.from(AllGenesByName.values());\r\n  shuffle(AllGenes);\r\n  const genes: RealizedGene[] = AllGenes.slice(0, numGenes).map((g) => g.level(randInt(0, g.numLevels - 1)));\r\n  return genes;\r\n}\r\n\r\nexport function populateGeneOptions(species: Species): RealizedGene[] {\r\n  const allGenes = species.genome.getAllGenes();\r\n  const hasTransport = allGenes.some((gene) => gene.gene === GeneTransport);\r\n  const hasPipes = allGenes.some((gene) => gene.gene === GenePipes);\r\n  const hasDiffuseWater = allGenes.some((gene) => gene.gene === GeneDiffuseWater);\r\n\r\n  if (!hasTransport && !hasPipes && !hasDiffuseWater) {\r\n    return [GeneTransport.level(2), GenePipes.level(2), GeneDiffuseWater.level(0)];\r\n  } else {\r\n    return generateRandomGenes(3);\r\n  }\r\n}\r\n","import { HexTile } from \"core/overworld/hexTile\";\r\nimport { lineage, Species } from \"core/species\";\r\nimport { GameResult } from \"game/gameResult\";\r\nimport { populateGeneOptions } from \"game/ui/SpeciesViewer/generateRandomGenes\";\r\nimport produce from \"immer\";\r\nimport React, { useContext } from \"react\";\r\nimport { AppState, PopulationAttempt } from \"./state\";\r\n\r\ntype AppReducerContextType = [AppState, React.Dispatch<AppActions>];\r\n\r\nexport const AppReducerContext = React.createContext<AppReducerContextType>(null!);\r\n\r\nexport function useAppReducer(): AppReducerContextType {\r\n  return useContext(AppReducerContext);\r\n}\r\n\r\nexport function reducer(state: AppState, action: AppActions): AppState {\r\n  if (action == null) {\r\n    console.error(\"can't reduce null action!\", state, action);\r\n    return state;\r\n  }\r\n  switch (action.type) {\r\n    // a dummy trigger on species mutate\r\n    case \"AAUpdateSpecies\":\r\n      return handleUpdateSpecies(state, action);\r\n    case \"AAStartPopulationAttempt\":\r\n      return handleStartPopulationAttempt(state, action);\r\n    case \"AAPopulationAttemptSuccess\":\r\n      return handlePopulationAttemptSuccess(state, action);\r\n    case \"AANextEpoch\":\r\n      return handleNextEpoch(state, action);\r\n    case \"AAGetGameResult\":\r\n      return handleGetGameResult(state, action);\r\n    case \"AAGameResultDone\":\r\n      return handleGameResultDone(state, action);\r\n    case \"AATransitionStart\":\r\n      return handleTransitionStart(state, action);\r\n    case \"AATransitionEnd\":\r\n      // no-op; this must be handled in the middleware\r\n      return state;\r\n    // return handleTransitionEnd(state, action);\r\n  }\r\n}\r\n\r\nexport type AppActions =\r\n  | AAUpdateSpecies\r\n  | AAStartPopulationAttempt\r\n  | AAPopulationAttemptSuccess\r\n  | AANextEpoch\r\n  | AAGetGameResult\r\n  | AAGameResultDone\r\n  | AATransitionStart\r\n  | AATransitionEnd;\r\n\r\nexport interface AAUpdateSpecies {\r\n  type: \"AAUpdateSpecies\";\r\n  species?: Species;\r\n}\r\n\r\nfunction handleUpdateSpecies(state: AppState, action: AAUpdateSpecies): AppState {\r\n  if (action.species) {\r\n    return {\r\n      ...state,\r\n      rootSpecies: action.species,\r\n    };\r\n    // return produce(state, (draft) => {\r\n    //   const newSpecies = action.species!;\r\n    //   findAndSetSpeciesRecursive(draft.rootSpecies, newSpecies);\r\n    // });\r\n  } else {\r\n    return { ...state };\r\n  }\r\n}\r\n\r\nexport interface AAStartPopulationAttempt {\r\n  type: \"AAStartPopulationAttempt\";\r\n  populationAttempt: PopulationAttempt;\r\n}\r\n\r\nfunction handleStartPopulationAttempt(state: AppState, action: AAStartPopulationAttempt): AppState {\r\n  const populationAttempt = action.populationAttempt;\r\n  const { targetHex, sourceHex } = populationAttempt;\r\n\r\n  if (!targetHex.info.visible) {\r\n    return state;\r\n  }\r\n  if (sourceHex != null) {\r\n    if (sourceHex.info.flora == null) {\r\n      console.error(\"sourceHex isn't null but the flora is null\");\r\n      return state;\r\n    }\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    activePopulationAttempt: action.populationAttempt,\r\n  };\r\n}\r\n\r\nexport interface AAFinishLevel {\r\n  type: \"AAFinishLevel\";\r\n  level: HexTile;\r\n  species: Species;\r\n  result: GameResult;\r\n}\r\n\r\nexport interface AAPopulationAttemptSuccess {\r\n  type: \"AAPopulationAttemptSuccess\";\r\n  attempt?: PopulationAttempt;\r\n  results: GameResult;\r\n}\r\n\r\nfunction handlePopulationAttemptSuccess(state: AppState, action: AAPopulationAttemptSuccess): AppState {\r\n  return produce(state, (draft: AppState) => {\r\n    const { attempt = draft.activePopulationAttempt!, results } = action;\r\n    const { settlingSpecies } = attempt;\r\n\r\n    // cannot access target hex directly since it points to the old state, must use the draft\r\n    const targetHex = draft.overWorld.hexAt(attempt.targetHex.i, attempt.targetHex.j)!;\r\n\r\n    const isFirstPlaythrough = attempt.sourceHex == null;\r\n    if (isFirstPlaythrough) {\r\n      gtag(\"event\", \"Beat first playthrough\", { label: \"mp earned\", value: results.mutationPointsPerEpoch });\r\n    }\r\n\r\n    // populate target hex\r\n    let oldSpecies: Species | undefined = undefined;\r\n    if (targetHex.info.flora != null) {\r\n      oldSpecies = targetHex.info.flora.species;\r\n    }\r\n    targetHex.info.flora = {\r\n      species: settlingSpecies,\r\n      mutationPointsPerEpoch: results.mutationPointsPerEpoch,\r\n    };\r\n\r\n    if (oldSpecies) {\r\n      // update old species mutation point pool cache\r\n      oldSpecies.freeMutationPoints = Math.min(\r\n        oldSpecies.freeMutationPoints,\r\n        draft.overWorld.getMaxGenePool(oldSpecies)\r\n      );\r\n    }\r\n\r\n    // bump visibility\r\n    for (const n of draft.overWorld.hexNeighbors(targetHex)) {\r\n      n && (n.info.visible = true);\r\n    }\r\n  });\r\n}\r\n\r\nexport interface AANextEpoch {\r\n  type: \"AANextEpoch\";\r\n}\r\n\r\nfunction handleNextEpoch(state: AppState, action: AANextEpoch): AppState {\r\n  return produce(state, (draft) => {\r\n    // +1 epoch:\r\n    // reset all species pools to max\r\n    for (const species of lineage(draft.rootSpecies)) {\r\n      species.freeMutationPoints = draft.overWorld.getMaxGenePool(species);\r\n      if (species.freeMutationPoints > 0) {\r\n        species.geneOptions = populateGeneOptions(species);\r\n      }\r\n    }\r\n    draft.epoch += 1;\r\n  });\r\n}\r\n\r\nexport interface AAGetGameResult {\r\n  type: \"AAGetGameResult\";\r\n  result: GameResult;\r\n}\r\n\r\nfunction handleGetGameResult(state: AppState, action: AAGetGameResult): AppState {\r\n  // if (state.activePopulationAttempt == null) {\r\n  //   throw new Error(\"activePopulationAttempt shouldn't be null during handleWinLoss\");\r\n  // }\r\n  if (action.result.status === \"won\") {\r\n    state = handlePopulationAttemptSuccess(state, {\r\n      type: \"AAPopulationAttemptSuccess\",\r\n      attempt: state.activePopulationAttempt,\r\n      results: action.result,\r\n    });\r\n  }\r\n  return {\r\n    ...state,\r\n    activeGameResult: action.result,\r\n  };\r\n}\r\n\r\nexport interface AAGameResultDone {\r\n  type: \"AAGameResultDone\";\r\n}\r\n\r\nfunction handleGameResultDone(state: AppState, action: AAGameResultDone): AppState {\r\n  const { activeGameResult } = state;\r\n  const activePopulationAttempt = state.activePopulationAttempt!;\r\n  // lost the tutorial level\r\n  if (activeGameResult?.status === \"lost\" && activePopulationAttempt.sourceHex == null) {\r\n    return {\r\n      ...state,\r\n      activeGameResult: undefined,\r\n      // shallow clone; re-creates the level\r\n      activePopulationAttempt: {\r\n        ...activePopulationAttempt,\r\n      },\r\n    };\r\n  }\r\n  return {\r\n    ...state,\r\n    activePopulationAttempt: undefined,\r\n    activeGameResult: undefined,\r\n  };\r\n}\r\n\r\nexport interface AATransitionStart {\r\n  type: \"AATransitionStart\";\r\n  transition: AppActions;\r\n}\r\n\r\nfunction handleTransitionStart(state: AppState, action: AATransitionStart): AppState {\r\n  return {\r\n    ...state,\r\n    transition: action.transition,\r\n  };\r\n}\r\n\r\nexport interface AATransitionEnd {\r\n  type: \"AATransitionEnd\";\r\n}\r\n","function capitalize(s: String) {\r\n  return s.substr(0, 1).toLocaleUpperCase() + s.substr(1);\r\n}\r\n\r\nexport default capitalize;\r\n","import { randElement, randInt } from \"math\";\r\nimport capitalize from \"./capitalize\";\r\n\r\n// taken from https://github.com/chancejs/chancejs/blob/63db6b8aab83513afa5a8269c8dcde6b300a9cf7/chance.js\r\n\r\nconst NUMBERS = \"0123456789\";\r\nconst CHARS_LOWER = \"abcdefghijklmnopqrstuvwxyz\";\r\nconst CHARS_UPPER = CHARS_LOWER.toUpperCase();\r\n\r\nfunction character(options: any) {\r\n  var symbols = \"!@#$%^&*()[]\",\r\n    letters,\r\n    pool;\r\n\r\n  if (options.casing === \"lower\") {\r\n    letters = CHARS_LOWER;\r\n  } else if (options.casing === \"upper\") {\r\n    letters = CHARS_UPPER;\r\n  } else {\r\n    letters = CHARS_LOWER + CHARS_UPPER;\r\n  }\r\n\r\n  if (options.pool) {\r\n    pool = options.pool;\r\n  } else {\r\n    pool = \"\";\r\n    if (options.alpha) {\r\n      pool += letters;\r\n    }\r\n    if (options.numeric) {\r\n      pool += NUMBERS;\r\n    }\r\n    if (options.symbols) {\r\n      pool += symbols;\r\n    }\r\n    if (!pool) {\r\n      pool = letters + NUMBERS + symbols;\r\n    }\r\n  }\r\n\r\n  return pool.charAt(randInt(0, pool.length - 1));\r\n}\r\n\r\nfunction syllable() {\r\n  let length = randInt(2, 3),\r\n    consonants = \"bcdfghjklmnprstvwz\", // consonants except hard to speak ones\r\n    vowels = \"aeiou\", // vowels\r\n    all = consonants + vowels, // all\r\n    text = \"\",\r\n    chr;\r\n\r\n  // I'm sure there's a more elegant way to do this, but this works\r\n  // decently well.\r\n  for (var i = 0; i < length; i++) {\r\n    if (i === 0) {\r\n      // First character can be anything\r\n      chr = character({ pool: all });\r\n    } else if (consonants.indexOf(chr) === -1) {\r\n      // Last character was a vowel, now we want a consonant\r\n      chr = character({ pool: consonants });\r\n    } else {\r\n      // Last character was a consonant, now we want a vowel\r\n      chr = character({ pool: vowels });\r\n    }\r\n\r\n    text += chr;\r\n  }\r\n\r\n  return text;\r\n}\r\n\r\nfunction word(options?: { syllables?: number; length?: number }) {\r\n  let syllables = options?.syllables || 2,\r\n    text = \"\";\r\n\r\n  if (options?.length) {\r\n    // Either bound word by length\r\n    do {\r\n      text += syllable();\r\n    } while (text.length < options.length);\r\n    text = text.substring(0, options.length);\r\n  } else {\r\n    // Or by number of syllables\r\n    for (var i = 0; i < syllables; i++) {\r\n      text += syllable();\r\n    }\r\n  }\r\n\r\n  return text;\r\n}\r\n\r\nconst LANDSCAPES = [\r\n  \"@ Steppes\",\r\n  \"@ Plains\",\r\n  \"@ Area\",\r\n  \"@ Basin\",\r\n  \"@ Bend\",\r\n  \"@ Beach\",\r\n  \"@ Cape\",\r\n  \"@ Flat\",\r\n  \"@ Ridge\",\r\n  \"@ Summit\",\r\n  \"Mount @\",\r\n  \"@'s Valley\",\r\n  \"@ Hills\",\r\n  \"@ Pinnacle\",\r\n  \"@ Heights\",\r\n];\r\nfunction addRandomLandscape(name: string) {\r\n  const template = randElement(LANDSCAPES);\r\n  return template.replace(\"@\", name);\r\n}\r\n\r\nexport function randomName() {\r\n  return addRandomLandscape(capitalize(word()));\r\n}\r\n","import { Tile } from \"core/tile\";\r\nimport { createSimpleSchema, object } from \"serializr\";\r\nimport { Vector2 } from \"three\";\r\nimport { TileGeneratorName } from \"../std/tileGenerators\";\r\nimport { World } from \"./world/world\";\r\n\r\nexport interface Environment {\r\n  airEvaporation: number;\r\n  climate: {\r\n    timeBetweenRainfall: number;\r\n    rainDuration: number;\r\n    waterPerSecond: number;\r\n  };\r\n  secondsToEvaporate: number;\r\n  floorCo2: number;\r\n  temperaturePerSeason: number[];\r\n  fill: TileGeneratorName | TileGenerator;\r\n}\r\n\r\nexport type TileGenerator = (pos: Vector2, world: World) => Tile | undefined;\r\n\r\nexport const EnvironmentSchema = createSimpleSchema<Environment>({\r\n  climate: object(createSimpleSchema({ \"*\": true })),\r\n  \"*\": true,\r\n});\r\n","import { EnvironmentSchema } from \"core/environment\";\r\nimport { createSimpleSchema, object, primitive, reference } from \"serializr\";\r\nimport { Species, SpeciesSchema } from \"../species\";\r\n\r\nexport interface LevelInfo {\r\n  seed: number;\r\n  height: number; // [-1 to 6], integers only\r\n  temperature: \"cold\" | \"temperate\" | \"hot\";\r\n  rainfall: \"low\" | \"medium\" | \"high\";\r\n  soilType: \"barren\" | \"average\" | \"fertile\";\r\n  // wind: \"low\" | \"medium\" | \"high\";\r\n  visible: boolean;\r\n  flora?: {\r\n    species: Species;\r\n    mutationPointsPerEpoch: number;\r\n  };\r\n}\r\n\r\nexport const LevelInfoSchema = createSimpleSchema<LevelInfo>({\r\n  // \"*\": true,\r\n  seed: primitive(),\r\n  height: primitive(),\r\n  temperature: primitive(),\r\n  rainfall: primitive(),\r\n  soilType: primitive(),\r\n  wind: primitive(),\r\n  visible: primitive(),\r\n  environment: object(EnvironmentSchema),\r\n\r\n  flora: object(\r\n    createSimpleSchema({\r\n      species: reference(SpeciesSchema),\r\n      mutationPointsPerEpoch: primitive(),\r\n      actionPoints: primitive(),\r\n    })\r\n  ),\r\n});\r\n","import { randomName } from \"common/randomName\";\r\nimport { identifier, object, serializable } from \"serializr\";\r\nimport uuid from \"uuid\";\r\nimport { LevelInfo, LevelInfoSchema } from \"./levelInfo\";\r\n\r\nconst C = Math.sqrt(3) / 2;\r\n\r\nexport class HexTile {\r\n  @serializable\r\n  private version = 1;\r\n\r\n  @serializable(identifier())\r\n  private uuid = uuid();\r\n\r\n  @serializable\r\n  private _displayName?: string;\r\n\r\n  public get displayName() {\r\n    // existing saves that don't have a displayName\r\n    // will get one\r\n    if (this._displayName == null) {\r\n      if (this.info.height < 0) {\r\n        this._displayName = \"Deep Water\";\r\n      } else {\r\n        this._displayName = randomName();\r\n      }\r\n    }\r\n    return this._displayName;\r\n  }\r\n\r\n  @serializable(object(LevelInfoSchema))\r\n  info: LevelInfo = {\r\n    seed: Math.random() * Number.MAX_SAFE_INTEGER,\r\n    height: -1,\r\n    rainfall: \"medium\",\r\n    soilType: \"average\",\r\n    temperature: \"temperate\",\r\n    // wind: \"low\",\r\n    visible: false,\r\n  };\r\n\r\n  @serializable\r\n  public i: number;\r\n\r\n  @serializable\r\n  public j: number;\r\n\r\n  // Handle 0 arg constructor from serializr\r\n  constructor(i?: number, j?: number) {\r\n    this.i = i!;\r\n    this.j = j!;\r\n  }\r\n\r\n  get cartesian() {\r\n    const { i, j } = this;\r\n    // simplified version:\r\n    // x = i - 0.5j - 0.5*-(i + j)\r\n    // x = i - 0.5j + 0.5i + 0.5j\r\n    // x = 1.5i\r\n    // y = Cj - C*-(i + j)\r\n    // y = Cj + Ci + Cj\r\n    // y = 2Cj + Ci\r\n    return {\r\n      x: 1.5 * i,\r\n      y: 2 * C * j + C * i,\r\n    };\r\n  }\r\n\r\n  get isHabitable() {\r\n    return this.info.height !== -1;\r\n  }\r\n\r\n  get k() {\r\n    return -(this.i + this.j);\r\n  }\r\n\r\n  get magnitude() {\r\n    return Math.abs(this.i) + Math.abs(this.j) + Math.abs(this.k);\r\n  }\r\n}\r\n","import { map, object, serializable } from \"serializr\";\r\nimport { HexTile } from \"./hexTile\";\r\n\r\nexport class HexStore {\r\n  @serializable(map(object(HexTile)))\r\n  tiles: { [k: string]: HexTile } = {};\r\n\r\n  private hash(i: number, j: number) {\r\n    return `${i},${j}`;\r\n  }\r\n\r\n  get(i: number, j: number): HexTile | undefined {\r\n    return this.tiles[this.hash(i, j)];\r\n  }\r\n\r\n  set(i: number, j: number, tile: HexTile) {\r\n    this.tiles[this.hash(i, j)] = tile;\r\n  }\r\n\r\n  *[Symbol.iterator]() {\r\n    for (const key in this.tiles) {\r\n      yield this.tiles[key];\r\n    }\r\n  }\r\n}\r\n","import { Species } from \"core/species\";\r\nimport { object, reference, serializable } from \"serializr\";\r\nimport SimplexNoise from \"simplex-noise\";\r\nimport { HexStore } from \"./hexStore\";\r\nimport { HexTile } from \"./hexTile\";\r\n\r\nexport class OverWorld {\r\n  @serializable(object(HexStore))\r\n  storage: HexStore;\r\n\r\n  @serializable(reference(HexTile))\r\n  startTile: HexTile;\r\n\r\n  constructor(storage?: HexStore, startTile?: HexTile) {\r\n    this.storage = storage!;\r\n    this.startTile = startTile!;\r\n\r\n    // ensure the start tile is visible\r\n    if (this.startTile) {\r\n      this.startTile.info.visible = true;\r\n    }\r\n  }\r\n\r\n  private static randomHeight(tile: HexTile, noise: SimplexNoise) {\r\n    const { x, y } = tile.cartesian;\r\n    let height = 0;\r\n    height += (noise.noise3D(x / 24, y / 24, 0) - 0.2) * 6;\r\n    height += noise.noise3D(x / 24, y / 24, 1.453) * 6;\r\n    height += noise.noise3D(x / 6, y / 6, 1.453) * 1.5;\r\n    height += 1;\r\n    // info.height += 4 - Math.abs(tile.magnitude * tile.magnitude) * 0.02;\r\n    height -= Math.abs(y * y) * 0.025;\r\n    if (height < 0 && height >= -1) {\r\n      height = 0;\r\n    }\r\n    height = Math.round(Math.max(Math.min(height, 6), -1));\r\n    return height;\r\n  }\r\n\r\n  private static populateLevelInfo(tile: HexTile, noise: SimplexNoise) {\r\n    const { info } = tile;\r\n    info.height = OverWorld.randomHeight(tile, noise);\r\n  }\r\n\r\n  static generateFilledHex(maxDist: number = 20): OverWorld {\r\n    const storage = new HexStore();\r\n    const noise = new SimplexNoise();\r\n    // the rule is: i + j + k = 0\r\n    // abs(i) <= maxDist\r\n    // abs(j) <= maxDist\r\n    // abs(k) <= maxDist\r\n    for (let i = -maxDist; i <= maxDist; i++) {\r\n      for (let j = -maxDist; j <= maxDist; j++) {\r\n        let k = -(i + j);\r\n        if (Math.abs(k) > maxDist) {\r\n          continue;\r\n        }\r\n        const tile = new HexTile(i, j);\r\n        OverWorld.populateLevelInfo(tile, noise);\r\n        storage.set(i, j, tile);\r\n      }\r\n    }\r\n    const startTile = OverWorld.getDefaultStartTile(storage);\r\n    return new OverWorld(storage, startTile);\r\n  }\r\n\r\n  static generateRectangle(width: number = 50, height: number = 25): OverWorld {\r\n    const storage = new HexStore();\r\n    const noise = new SimplexNoise();\r\n    // the rule is: i + j + k = 0\r\n    // abs(i) <= maxDist\r\n    // abs(j) <= maxDist\r\n    // abs(k) <= maxDist\r\n    const maxDist = Math.max(width / 2, height / 2);\r\n\r\n    for (let i = -maxDist; i <= maxDist; i++) {\r\n      for (let j = -maxDist; j <= maxDist; j++) {\r\n        let k = -(i + j);\r\n        if (Math.abs(k) > maxDist) {\r\n          continue;\r\n        }\r\n        const tile = new HexTile(i, j);\r\n        const { x, y } = tile.cartesian;\r\n        if (x < -width / 2 || x > width / 2 || y < -height / 2 || y > height / 2) {\r\n          continue;\r\n        }\r\n\r\n        OverWorld.populateLevelInfo(tile, noise);\r\n        storage.set(i, j, tile);\r\n      }\r\n    }\r\n\r\n    const startTile = OverWorld.getDefaultStartTile(storage);\r\n    return new OverWorld(storage, startTile);\r\n  }\r\n\r\n  static getDefaultStartTile(storage?: HexStore) {\r\n    if (storage == null) {\r\n      return undefined;\r\n    }\r\n    const tiles = Array.from(storage);\r\n    return tiles.filter((t) => t.info.height === 0).sort((t1, t2) => t1.magnitude - t2.magnitude)[0];\r\n  }\r\n\r\n  /**\r\n   * store neighbors at angles [30, 90, 150, 210, 270, 330]\r\n   *\r\n   * 30: (1, 0, -1)\r\n   *\r\n   * 90: (0, 1, -1)\r\n   *\r\n   * 150: (-1, 1, 0)\r\n   *\r\n   * 210: (-1, 0, 1)\r\n   *\r\n   * 270: (0, -1, 1)\r\n   *\r\n   * 330: (1, -1, 0)\r\n   */\r\n  public hexNeighbors(hex: HexTile) {\r\n    const { i, j } = hex;\r\n    const neighbors: (HexTile | undefined)[] = [];\r\n    neighbors[0] = this.storage.get(i + 1, j);\r\n    neighbors[1] = this.storage.get(i, j + 1);\r\n    neighbors[2] = this.storage.get(i - 1, j + 1);\r\n    neighbors[3] = this.storage.get(i - 1, j);\r\n    neighbors[4] = this.storage.get(i, j - 1);\r\n    neighbors[5] = this.storage.get(i + 1, j - 1);\r\n    return neighbors;\r\n  }\r\n\r\n  /**\r\n   * For a given target hex, find the source hexes that\r\n   * can migrate into it.\r\n   */\r\n  public possibleMigrationSources(target: HexTile) {\r\n    const populatedActiveNeighbors = this.hexNeighbors(target).filter((hex) => {\r\n      return hex?.info.flora != null;\r\n    }) as HexTile[];\r\n    if (target.info.flora == null) {\r\n      // if the target is unpopulated, allow any neighbor to migrate into it\r\n      return populatedActiveNeighbors;\r\n    } else {\r\n      // if the target is already populated, disallow \"migration\" from the same source species\r\n      return populatedActiveNeighbors.filter((s) => s != null && s.info.flora!.species !== target.info.flora!.species);\r\n    }\r\n  }\r\n\r\n  public possibleMigrationTargets(source: HexTile) {\r\n    if (source.info.flora == null) {\r\n      console.error(\"can't migrate from a null flora source\");\r\n      return [];\r\n    }\r\n    const unpopulatedNeighbors = this.hexNeighbors(source).filter((hex) => {\r\n      // find neighbors that are either:\r\n      //  unpopulated, or\r\n      //  populated but with a different species\r\n      return hex != null && (hex.info.flora == null || hex.info.flora.species !== source.info.flora!.species);\r\n    }) as HexTile[];\r\n    return unpopulatedNeighbors;\r\n  }\r\n\r\n  public getStartHex() {\r\n    return this.startTile;\r\n  }\r\n\r\n  public hexAt(i: number, j: number) {\r\n    return this.storage.get(i, j);\r\n  }\r\n\r\n  *[Symbol.iterator]() {\r\n    for (const tile of this.storage) {\r\n      yield tile;\r\n    }\r\n  }\r\n\r\n  getMaxGenePool(species: Species) {\r\n    return this.getHexesPopulatedBy(species).reduce(\r\n      (pool, tile) => (pool += tile.info.flora!.mutationPointsPerEpoch),\r\n      0\r\n    );\r\n  }\r\n\r\n  getHexesPopulatedBy(species: Species) {\r\n    const hexes: HexTile[] = [];\r\n    for (const tile of this.storage) {\r\n      const { flora } = tile.info;\r\n      if (flora && flora.species.id === species.id) {\r\n        hexes.push(tile);\r\n      }\r\n    }\r\n    return hexes;\r\n  }\r\n}\r\n","import { GameResult } from \"game/gameResult\";\r\nimport { createSimpleSchema, object, reference } from \"serializr\";\r\nimport { HexTile } from \"../../core/overworld/hexTile\";\r\nimport { OverWorld } from \"../../core/overworld/overWorld\";\r\nimport { Species, SpeciesSchema } from \"../../core/species\";\r\nimport { AppActions } from \"./reducer\";\r\n\r\n/**\r\n * For now, we mutate classes and manually call dummy placeholder\r\n * actions to get a state update.\r\n */\r\nexport interface AppState {\r\n  overWorld: OverWorld;\r\n  /**\r\n   * Determines whether we're in the game or in the overworld.\r\n   *\r\n   * Null activeLevel means we're in overworld.\r\n   * Non-null means we're in-game, or in the game results screen.\r\n   */\r\n  activePopulationAttempt?: PopulationAttempt;\r\n  /**\r\n   * Determines whether to show the game over screen. While non-null,\r\n   * we show a game result screen.\r\n   */\r\n  activeGameResult?: GameResult;\r\n  rootSpecies: Species;\r\n  // species: Record<string, Species>;\r\n  epoch: number;\r\n  transition?: AppActions;\r\n}\r\n\r\nexport interface PopulationAttempt {\r\n  sourceHex?: HexTile;\r\n  targetHex: HexTile;\r\n  settlingSpecies: Species;\r\n}\r\n\r\nexport const PopulationAttemptSchema = createSimpleSchema<PopulationAttempt>({\r\n  sourceHex: reference(HexTile),\r\n  targetHex: reference(HexTile),\r\n  settlingSpecies: reference(SpeciesSchema),\r\n});\r\n\r\nexport const AppStateSchema = createSimpleSchema<AppState>({\r\n  overWorld: object(OverWorld),\r\n  // no active population attempt\r\n  // activePopulationAttempt: object(PopulationAttemptSchema),\r\n  // no activeGameResult\r\n  rootSpecies: object(SpeciesSchema),\r\n  epoch: true,\r\n});\r\n","import localforage from \"localforage\";\r\nimport { deserialize, serialize } from \"serializr\";\r\nimport { AppActions } from \"./reducer\";\r\nimport { AppState, AppStateSchema } from \"./state\";\r\n\r\nconst GAME_DATA_KEY = \"gameData\";\r\n\r\nexport function save(appState: AppState) {\r\n  const json = serialize(AppStateSchema, appState);\r\n  console.log(\"saved json\", json);\r\n  const stringToSave = JSON.stringify(json);\r\n  return localforage.setItem(GAME_DATA_KEY, stringToSave);\r\n}\r\n\r\nexport async function load(): Promise<AppState> {\r\n  const string = await localforage.getItem<string>(GAME_DATA_KEY);\r\n  const json = JSON.parse(string);\r\n  const appState = deserialize(AppStateSchema, json);\r\n  return appState;\r\n}\r\n\r\nexport function resetGame() {\r\n  const confirm = window.confirm(\"Are you sure you want to reset your whole game?\");\r\n  if (confirm) {\r\n    return localforage.removeItem(GAME_DATA_KEY).then(() => {\r\n      window.location.reload();\r\n    });\r\n  } else {\r\n    return Promise.reject();\r\n  }\r\n}\r\n\r\nconst ACTIONS_TO_SAVE_ON: Partial<Record<AppActions[\"type\"], true>> = {\r\n  AAGameResultDone: true,\r\n  AAGetGameResult: true,\r\n  AAUpdateSpecies: true,\r\n  AANextEpoch: true,\r\n  AAPopulationAttemptSuccess: true,\r\n  AAStartPopulationAttempt: true,\r\n};\r\n\r\nexport function saveOnActionMiddleware(reducer: React.Reducer<AppState, AppActions>) {\r\n  return (state: AppState, action: AppActions) => {\r\n    const newState = reducer(state, action);\r\n    if (ACTIONS_TO_SAVE_ON.hasOwnProperty(action.type)) {\r\n      console.log(\"saved from\", action);\r\n      save(newState);\r\n    }\r\n    return newState;\r\n  };\r\n}\r\n","import React from \"react\";\r\nimport classNames from \"classnames\";\r\n\r\nimport \"./Button.scss\";\r\n\r\nexport function Button(props: JSX.IntrinsicElements[\"button\"] & { color?: \"purple\" | \"green\" }) {\r\n  return (\r\n    <button {...props} className={classNames(\"button\", props.className, props.color || \"purple\")}>\r\n      {props.children}\r\n    </button>\r\n  );\r\n}\r\n","import React, { useCallback } from \"react\";\r\nimport { Species } from \"../../../core/species\";\r\nimport Character from \"../common/Character\";\r\nimport MP from \"../common/MP\";\r\nimport \"./SpeciesNode.scss\";\r\n\r\nexport interface SpeciesNodeProps {\r\n  species: Species;\r\n  onMutate: (m: Species) => void;\r\n}\r\n\r\nfunction SpeciesNode({ species, onMutate }: SpeciesNodeProps) {\r\n  const descendants =\r\n    species.descendants.length > 0 ? (\r\n      <div className=\"descendants-container\">\r\n        {species.descendants.map((s, i) => (\r\n          <SpeciesNode key={i} species={s} onMutate={onMutate} />\r\n        ))}\r\n      </div>\r\n    ) : null;\r\n  const handleClick = useCallback(() => {\r\n    onMutate(species);\r\n  }, [onMutate, species]);\r\n  return (\r\n    <div className=\"species-node\">\r\n      {descendants}\r\n      {/* <LookAtMouse zScale={5} onClick={handleClick}> */}\r\n      <div className=\"species-info\" onClick={handleClick}>\r\n        <div className=\"species-info-name\">{species.name}</div>\r\n        <div className=\"species-info-animation\">\r\n          <Character size=\"small\" />\r\n        </div>\r\n        <MP amount={species.freeMutationPoints} />\r\n      </div>\r\n      {/* </LookAtMouse> */}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default SpeciesNode;\r\n","import { useAppReducer } from \"game/app\";\r\nimport React from \"react\";\r\nimport { Species } from \"../../../core/species\";\r\nimport \"./PhylogeneticTree.scss\";\r\nimport SpeciesNode from \"./SpeciesNode\";\r\n\r\ninterface PhylogeneticTreeProps {\r\n  onMutate: (s: Species) => void;\r\n}\r\n\r\nfunction PhylogeneticTree({ onMutate }: PhylogeneticTreeProps) {\r\n  const [{ rootSpecies }] = useAppReducer();\r\n  return (\r\n    <div className=\"phylogenetic-tree\">\r\n      <div className=\"title\">Phylogenetic Tree</div>\r\n      <div className=\"tree-nodes\">\r\n        <SpeciesNode species={rootSpecies} onMutate={onMutate} />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default PhylogeneticTree;\r\n","import { Tooltip } from \"@blueprintjs/core\";\r\nimport classNames from \"classnames\";\r\nimport { lineage } from \"core/species\";\r\nimport { useAppReducer } from \"game/app\";\r\nimport DynamicNumber from \"game/ui/common/DynamicNumber\";\r\nimport React, { useState } from \"react\";\r\nimport { GiSandsOfTime } from \"react-icons/gi\";\r\nimport { HexTile } from \"../../../core/overworld/hexTile\";\r\nimport MP from \"../common/MP\";\r\nimport \"./EpochUI.scss\";\r\n\r\nexport function EpochUI({ onNextEpoch, onFocusHex }: EpochUIProps) {\r\n  const [{ epoch, overWorld, rootSpecies }] = useAppReducer();\r\n  const [transitioning, setTransitioning] = useState(false);\r\n  const handleNextEpoch = React.useCallback(() => {\r\n    setTransitioning(true);\r\n    setTimeout(() => setTransitioning(false), 5000);\r\n    onNextEpoch();\r\n  }, [onNextEpoch]);\r\n\r\n  const speciesProductionEls: JSX.Element[] = [];\r\n  const allSpecies = lineage(rootSpecies);\r\n  for (const species of allSpecies) {\r\n    // const hexes = overWorld.getHexesPopulatedBy(species);\r\n    const pointsPerEpoch = overWorld.getMaxGenePool(species);\r\n    speciesProductionEls.push(\r\n      <div key={species.id}>\r\n        <span className=\"species-name\">{species.name}</span>{\" \"}\r\n        <MP amount={species.freeMutationPoints} total={pointsPerEpoch} />\r\n        {/* over{\" \"} {hexes.length} hexes. */}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const epochButtonTooltipContent = <>Refill mutation points.</>;\r\n  return (\r\n    <div className={classNames(\"epoch-display\", { \"ready-to-advance\": false, transitioning })}>\r\n      <h1 className=\"number\">\r\n        Epoch <DynamicNumber sigFigs={6} value={epoch} speed={0.08} />\r\n      </h1>\r\n      <div className=\"production-overview\">{speciesProductionEls}</div>\r\n\r\n      <Tooltip position=\"left\" content={epochButtonTooltipContent}>\r\n        <button className=\"button-next-epoch\" onClick={handleNextEpoch} disabled={transitioning}>\r\n          <GiSandsOfTime className=\"icon\" />\r\n        </button>\r\n      </Tooltip>\r\n    </div>\r\n  );\r\n}\r\nexport interface EpochUIProps {\r\n  onNextEpoch: () => void;\r\n  onFocusHex: (hex: HexTile) => void;\r\n}\r\n","import { Vector2 } from \"three\";\r\n\r\n// https://github.com/beaugunderson/poisson-disc-sampler/blob/master/poisson-disc-sampler.js\r\nexport function poissonDisc({\r\n  width = 1,\r\n  height = 1,\r\n  radius = 0.1,\r\n  max = 1000,\r\n  initialSample = undefined as [number, number] | undefined,\r\n  rng = Math.random,\r\n}): Vector2[] {\r\n  // maximum number of samples before rejection\r\n  var k = 30;\r\n  var radius2 = radius * radius;\r\n  var R = 3 * radius2;\r\n  var cellSize = radius * Math.SQRT1_2;\r\n\r\n  var gridWidth = Math.ceil(width / cellSize);\r\n  var gridHeight = Math.ceil(height / cellSize);\r\n\r\n  var grid = new Array(gridWidth * gridHeight);\r\n\r\n  var queue: number[][] = [];\r\n  var queueSize = 0;\r\n\r\n  var sampleSize = 0;\r\n\r\n  rng = rng || Math.random;\r\n\r\n  function far(x: number, y: number) {\r\n    var i = (x / cellSize) | 0;\r\n    var j = (y / cellSize) | 0;\r\n\r\n    var i0 = Math.max(i - 2, 0);\r\n    var j0 = Math.max(j - 2, 0);\r\n    var i1 = Math.min(i + 3, gridWidth);\r\n    var j1 = Math.min(j + 3, gridHeight);\r\n\r\n    for (j = j0; j < j1; ++j) {\r\n      var o = j * gridWidth;\r\n\r\n      for (i = i0; i < i1; ++i) {\r\n        var s;\r\n\r\n        if ((s = grid[o + i])) {\r\n          var dx = s[0] - x,\r\n            dy = s[1] - y;\r\n\r\n          if (dx * dx + dy * dy < radius2) {\r\n            return false;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function sample(x: number, y: number) {\r\n    const s = [x, y];\r\n\r\n    queue.push(s);\r\n\r\n    grid[gridWidth * ((y / cellSize) | 0) + ((x / cellSize) | 0)] = s;\r\n\r\n    sampleSize++;\r\n    queueSize++;\r\n\r\n    return s;\r\n  }\r\n\r\n  const sampler = function() {\r\n    if (!sampleSize) {\r\n      if (initialSample != null) {\r\n        return sample(initialSample[0], initialSample[1]);\r\n      } else {\r\n        return sample(rng() * width, rng() * height);\r\n      }\r\n    }\r\n\r\n    // Pick a random existing sample and remove it from the queue.\r\n    while (queueSize) {\r\n      var i = (rng() * queueSize) | 0;\r\n      var s = queue[i];\r\n\r\n      // Make a new candidate between [radius, 2 * radius] from the existing\r\n      // sample.\r\n      for (var j = 0; j < k; ++j) {\r\n        var a = 2 * Math.PI * rng();\r\n        var r = Math.sqrt(rng() * R + radius2);\r\n        var x = s[0] + r * Math.cos(a);\r\n        var y = s[1] + r * Math.sin(a);\r\n\r\n        // Reject candidates that are outside the allowed extent,\r\n        // or closer than 2 * radius to any existing sample.\r\n        if (x >= 0 && x < width && y >= 0 && y < height && far(x, y)) {\r\n          return sample(x, y);\r\n        }\r\n      }\r\n\r\n      queue[i] = queue[--queueSize];\r\n      queue.length = queueSize;\r\n    }\r\n  };\r\n\r\n  const samples: Vector2[] = [];\r\n  for (let i = 0; i < max; i++) {\r\n    const sample = sampler();\r\n    // we can't get any more\r\n    if (sample == null) {\r\n      break;\r\n    }\r\n    samples.push(new Vector2(sample[0], sample[1]));\r\n  }\r\n  return samples;\r\n}\r\n","import { poissonDisc } from \"math/poissonDisc\";\r\nimport { Vector2 } from \"three\";\r\nimport { HexTile } from \"../../../core/overworld/hexTile\";\r\nimport { CameraState } from \"./map/OverWorldMap\";\r\n\r\n/**\r\n * Tiled hexes are not square - they are rectangular, where\r\n * the pointy-to-pointy direction is length 1 and the edge-to-edge\r\n * direction is length sqrt(3) / 2. Since we have flat-topped\r\n * hexes, the Y gets the squish factor.\r\n */\r\nexport const Y_SQUISH_FACTOR = Math.sqrt(3) / 2;\r\n\r\nexport function getClickedHexCoords(canvas: HTMLCanvasElement, camera: CameraState, event: React.MouseEvent) {\r\n  const { scale, dX, dY } = camera;\r\n  const cX = canvas.width / 2 + dX;\r\n  const cY = canvas.height / 2 + dY;\r\n\r\n  const e = event.nativeEvent;\r\n  const pxX = e.offsetX;\r\n  const pxY = e.offsetY;\r\n  const x = (pxX - cX) / scale;\r\n  const y = (pxY - cY) / scale;\r\n  // we now have a fractional cartesian coordinates\r\n  // now we flip the equations:\r\n\r\n  // x = 1.5i\r\n  // i = x / 1.5\r\n\r\n  // y = 2Cj + Ci\r\n  // j = (y - Ci) / (2 * C)\r\n\r\n  const i = x / 1.5;\r\n  const j = (y - Y_SQUISH_FACTOR * i) / (2 * Y_SQUISH_FACTOR);\r\n  const k = -(i + j);\r\n\r\n  return roundCubeCoordinates(i, j, k);\r\n}\r\n\r\nexport function roundCubeCoordinates(i: number, j: number, k: number) {\r\n  var rx = Math.round(i);\r\n  var ry = Math.round(j);\r\n  var rz = Math.round(k);\r\n\r\n  var x_diff = Math.abs(rx - i);\r\n  var y_diff = Math.abs(ry - j);\r\n  var z_diff = Math.abs(rz - k);\r\n\r\n  if (x_diff > y_diff && x_diff > z_diff) {\r\n    rx = -ry - rz;\r\n  } else if (y_diff > z_diff) {\r\n    ry = -rx - rz;\r\n  } else {\r\n    rz = -rx - ry;\r\n  }\r\n  return { i: rx, j: ry, k: rz };\r\n}\r\n\r\nexport function pixelPosition(tile: HexTile, camera: CameraState) {\r\n  const { dX, dY, scale } = camera;\r\n  const { x, y } = tile.cartesian;\r\n\r\n  const cX = window.innerWidth / 2 + dX;\r\n  const cY = window.innerHeight / 2 + dY;\r\n  return [cX + x * scale, cY + y * scale];\r\n}\r\n\r\n/**\r\n * Get the camera state that would center the camera on hex with the given scale.\r\n */\r\nexport function getCameraPositionCenteredOn(hex: HexTile, scale: number) {\r\n  const { x, y } = hex.cartesian;\r\n  const cX = window.innerWidth / 2 - x * scale;\r\n  const cY = window.innerHeight / 2 - y * scale;\r\n\r\n  const dX = cX - window.innerWidth / 2;\r\n  const dY = cY - window.innerHeight / 2;\r\n\r\n  return [dX, dY];\r\n}\r\n\r\nexport const randomPointInHexagon = (() => {\r\n  const vectors = [new Vector2(-1, 0), new Vector2(0.5, Y_SQUISH_FACTOR), new Vector2(0.5, -Y_SQUISH_FACTOR)];\r\n\r\n  return (scale: number) => {\r\n    // adapted from https://stackoverflow.com/a/3241819\r\n    const vIndex = Math.floor(Math.random() * 3);\r\n    const [v1, v2] = [vectors[vIndex], vectors[(vIndex + 1) % 3]];\r\n    const [v1Scale, v2Scale] = [Math.random(), Math.random()];\r\n    const [x, y] = [v1Scale * v1.x + v2Scale * v2.x, v1Scale * v1.y + v2Scale * v2.y];\r\n    return new Vector2(x * scale, y * scale);\r\n  };\r\n})();\r\n\r\nexport const generateNaturalRandomHexagonPoints = (radius: number, dropFirst = false) => {\r\n  const width = 2;\r\n  const height = Y_SQUISH_FACTOR * width;\r\n  // const areaAvailable = width * height;\r\n  // const radius = areaAvailable / maxPoints * 0.5; // technically you could get pretty close with .8; but do 0.5 for some more leeway\r\n  const samples = poissonDisc({ width, height, radius, initialSample: [width / 2, height / 2], max: 10000 });\r\n  const normSamples = samples\r\n    .map((s) => {\r\n      s.x -= width / 2;\r\n      s.y -= height / 2;\r\n      return s;\r\n    })\r\n    .filter((s) => isPointInHexagon(s.x, s.y));\r\n  if (dropFirst) {\r\n    normSamples.shift();\r\n  }\r\n  return normSamples;\r\n};\r\n\r\n/**\r\n * Return true if the point is inside a radius 1 hexagon (width 2, height sqrt(3))\r\n */\r\nexport const isPointInHexagon = (() => {\r\n  const RADIUS = 1;\r\n  const HALF_HEIGHT = RADIUS * Y_SQUISH_FACTOR;\r\n  // based on http://www.playchilla.com/how-to-check-if-a-point-is-inside-a-hexagon\r\n  return (x: number, y: number) => {\r\n    // transform the test point locally and to quadrant 2\r\n    const q2x = Math.abs(x);\r\n    const q2y = Math.abs(y);\r\n    // bounding test (since q2 is in quadrant 2 only 2 tests are needed)\r\n    if (q2x > RADIUS || q2y > HALF_HEIGHT) {\r\n      return false;\r\n    }\r\n    // dot product can be reduced to this due to the hexagon symmetry\r\n    // return HALF_HEIGHT * RADIUS * q2x - RADIUS * q2y >= 0;\r\n    return RADIUS * HALF_HEIGHT - HALF_HEIGHT * q2x - 0.5 * q2y >= 0;\r\n  };\r\n})();\r\n","import React, { useState } from \"react\";\r\n\r\nimport \"./Expand.scss\";\r\nimport classNames from \"classnames\";\r\n\r\ninterface ExpandProps {\r\n  className?: string;\r\n  children: React.ReactNode;\r\n  shrunkElements: React.ReactNode;\r\n}\r\n\r\nfunction Expand({ className, children, shrunkElements }: ExpandProps) {\r\n  const [expanded, setExpanded] = useState(false);\r\n\r\n  const handleExpandClick = () => {\r\n    setExpanded(!expanded);\r\n  };\r\n\r\n  return (\r\n    <div className={classNames(className, \"expand\")}>\r\n      <div className=\"expand-button\" onClick={handleExpandClick}>\r\n        {shrunkElements}\r\n        <div className=\"expand-caret\">{expanded ? \"\" : \"\"}</div>\r\n      </div>\r\n      {expanded ? <div>{children}</div> : null}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default Expand;\r\n","import { Species } from \"core/species\";\r\nimport React from \"react\";\r\nimport { HexTile } from \"../../../../core/overworld/hexTile\";\r\nimport { Button } from \"../../common/Button\";\r\nimport Expand from \"../../common/Expand\";\r\nimport MP from \"../../common/MP\";\r\nimport \"./HexInfo.scss\";\r\n\r\ninterface HexInfo {\r\n  playSpecies: Species;\r\n  tile: HexTile;\r\n  onClickPlay: () => void;\r\n}\r\n\r\nfunction HexInfo({ playSpecies, tile, onClickPlay }: HexInfo) {\r\n  const { height, flora } = tile.info;\r\n\r\n  const playButtonElement =\r\n    height === -1 ? null : (\r\n      <div className=\"play-selector\">\r\n        <Button color=\"green\" className=\"play-button\" onClick={onClickPlay}>\r\n          Play Level\r\n        </Button>\r\n      </div>\r\n    );\r\n\r\n  const body =\r\n    flora != null ? (\r\n      <>\r\n        <p>\r\n          Inhabited by{\" \"}\r\n          <b>\r\n            <i>{flora.species.name}</i>\r\n          </b>\r\n        </p>\r\n        <p>\r\n          <MP amount={flora.mutationPointsPerEpoch} /> per epoch\r\n        </p>\r\n      </>\r\n    ) : tile.isHabitable ? null : (\r\n      <p style={{ color: \"red\" }}>Uninhabitable</p>\r\n    );\r\n\r\n  const stringifyInfo = { ...tile.info };\r\n  delete stringifyInfo.flora;\r\n\r\n  const expand = tile.isHabitable ? (\r\n    <Expand shrunkElements={<div className=\"details\">Details</div>}>\r\n      <pre style={{ fontSize: \"12px\" }}>{JSON.stringify(stringifyInfo, null, 4)}</pre>\r\n    </Expand>\r\n  ) : null;\r\n\r\n  return (\r\n    <div className=\"hex-info-container\">\r\n      <div className=\"header\">{tile.displayName}</div>\r\n      <div className=\"body\">{body}</div>\r\n      {expand}\r\n      {playButtonElement}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default HexInfo;\r\n","import testVignetteUrl from \"assets/images/test-vignette.png\";\r\nimport { sleep } from \"common/promise\";\r\nimport { HexTile } from \"core/overworld/hexTile\";\r\nimport { Species } from \"core/species\";\r\nimport { easeExpIn } from \"d3-ease\";\r\nimport { scaleLinear } from \"d3-scale\";\r\nimport { PopulationAttempt } from \"game/app\";\r\nimport { generateNaturalRandomHexagonPoints, pixelPosition } from \"game/ui/overworld/hexMath\";\r\nimport { clamp, map, sawTooth } from \"math\";\r\nimport Ticker from \"std/ticker\";\r\nimport { Vector2 } from \"three\";\r\nimport { CameraState } from \"./OverWorldMap\";\r\n\r\nconst testVignette = new Image();\r\ntestVignette.src = testVignetteUrl;\r\n\r\nconst COLOR_SCALE_HEIGHT = scaleLinear<string, string>()\r\n  .domain([-1, 0, 1, 5, 6])\r\n  .range([\"rgb(0, 60, 255)\", \"lightblue\", \"yellow\", \"orange\"]);\r\n\r\nexport interface DrawingContext {\r\n  populationAttempt?: PopulationAttempt;\r\n  highlightedHex?: HexTile;\r\n}\r\n\r\nexport default class HexTileSprite {\r\n  private vignettePositions?: Vector2[];\r\n\r\n  private isHovered = false;\r\n\r\n  constructor(public tile: HexTile, public context: DrawingContext) {}\r\n\r\n  public get zIndex() {\r\n    let z = this.tile.cartesian.y;\r\n    if (this.tile.info.flora != null) {\r\n      z += 1000;\r\n    }\r\n    return z;\r\n  }\r\n\r\n  public get isShadowed() {\r\n    if (this.context.highlightedHex != null) {\r\n      return this.context.highlightedHex !== this.tile;\r\n    } else if (this.context.populationAttempt != null) {\r\n      return (\r\n        this.context.populationAttempt.sourceHex !== this.tile && this.context.populationAttempt.targetHex !== this.tile\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This resets every draw.\r\n   */\r\n  setIsHovered() {\r\n    this.isHovered = true;\r\n  }\r\n\r\n  draw(c: CanvasRenderingContext2D, camera: CameraState) {\r\n    const { scale } = camera;\r\n    const [px, py] = pixelPosition(this.tile, camera);\r\n\r\n    c.lineWidth = (1 * scale) / 48;\r\n\r\n    if (this.isShadowed) {\r\n      c.globalAlpha = 0.2;\r\n    } else {\r\n      c.globalAlpha = 1;\r\n    }\r\n    if (this.tile.info.visible || true) {\r\n      // base color\r\n      c.fillStyle = COLOR_SCALE_HEIGHT(this.tile.info.height);\r\n      c.strokeStyle = \"rgb(112, 112, 112)\";\r\n      drawHex(c, px, py, scale);\r\n\r\n      // 0-6 number (can be covered by vignettes)\r\n      if (!this.isHovered) {\r\n        this.drawNumericHeight(c, scale, px, py);\r\n      }\r\n\r\n      // \"active\" pulse\r\n      if (this.tile.info.flora != null) {\r\n        this.drawVignettes(c, this.tile.info.flora.species, px, py, scale);\r\n      }\r\n    } else {\r\n      c.strokeStyle = \"rgb(112, 112, 112)\";\r\n      drawHex(c, px, py, scale, false);\r\n    }\r\n\r\n    // hovered outline\r\n    if (this.isHovered) {\r\n      c.strokeStyle = \"rgb(112, 112, 112)\";\r\n      c.lineWidth = (1 * scale) / 48;\r\n      drawCircle(c, px, py, (scale / 48) * 12, false);\r\n      if (this.tile.info.visible) {\r\n        this.drawNumericHeight(c, scale, px, py);\r\n      }\r\n    }\r\n\r\n    this.isHovered = false;\r\n  }\r\n\r\n  private static easePulse = easeExpIn;\r\n\r\n  public drawActivePulse(c: CanvasRenderingContext2D, scale: number, px: number, py: number) {\r\n    for (let i = 0; i < 10; i++) {\r\n      this.drawPulse(i / 10, c, scale, px, py);\r\n    }\r\n  }\r\n\r\n  private drawPulse(tOffset: number, c: CanvasRenderingContext2D, scale: number, px: number, py: number) {\r\n    const thickness = map(\r\n      HexTileSprite.easePulse(clamp(map(sawTooth(Ticker.now / 6000 + tOffset), 0, 1, -1, 2), -Infinity, 1)),\r\n      0,\r\n      1,\r\n      0,\r\n      20\r\n    );\r\n    c.lineWidth = (thickness * scale) / 48;\r\n    const a = 100 / (thickness * thickness * thickness);\r\n    c.strokeStyle = `rgba(255, 255, 255, ${a})`;\r\n    drawHex(c, px, py, scale + c.lineWidth / 2, false);\r\n  }\r\n\r\n  private drawNumericHeight(c: CanvasRenderingContext2D, scale: number, px: number, py: number) {\r\n    if (this.tile.info.height >= 0) {\r\n      c.font = `${(12 * scale) / 48}px serif`;\r\n      c.textAlign = \"center\";\r\n      c.textBaseline = \"middle\";\r\n      c.fillStyle = \"#666\";\r\n      c.fillText(this.tile.info.height + \"\", px, py, scale);\r\n    }\r\n  }\r\n\r\n  drawVignettes(c: CanvasRenderingContext2D, species: Species, px: number, py: number, scale: number) {\r\n    if (this.vignettePositions == null) {\r\n      const positions = generateNaturalRandomHexagonPoints(0.3, true); //.sort((a, b) => a.y - b.y);\r\n      this.vignettePositions = [];\r\n      const vignettePositions = this.vignettePositions;\r\n      (async function() {\r\n        for (const p of positions) {\r\n          vignettePositions.push(p);\r\n          await sleep(300);\r\n        }\r\n      })();\r\n    }\r\n    const sizeScale = scale / 48 / 2;\r\n    for (const p of this.vignettePositions) {\r\n      c.drawImage(\r\n        testVignette,\r\n        px + p.x * scale - (testVignette.width / 2) * sizeScale,\r\n        py + p.y * scale - testVignette.height * sizeScale,\r\n        testVignette.width * sizeScale,\r\n        testVignette.height * sizeScale\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nfunction drawHex(c: CanvasRenderingContext2D, x: number, y: number, r: number, fill = true) {\r\n  c.beginPath();\r\n  c.moveTo(x + r, y);\r\n  for (let i = 1; i < 6; i++) {\r\n    const angle = (i / 6) * Math.PI * 2;\r\n    c.lineTo(x + Math.cos(angle) * r, y + Math.sin(angle) * r);\r\n  }\r\n  c.closePath();\r\n  if (fill) {\r\n    c.fill();\r\n  }\r\n  c.stroke();\r\n}\r\n\r\nfunction drawCircle(c: CanvasRenderingContext2D, x: number, y: number, r: number, fill = true) {\r\n  c.beginPath();\r\n  c.moveTo(x + r, y);\r\n  c.arc(x, y, r, 0, Math.PI * 2);\r\n  // for (let i = 1; i < 6; i++) {\r\n  //   const angle = (i / 6) * Math.PI * 2;\r\n  //   c.lineTo(x + Math.cos(angle) * r, y + Math.sin(angle) * r);\r\n  // }\r\n  // c.closePath();\r\n  if (fill) {\r\n    c.fill();\r\n  }\r\n  c.stroke();\r\n}\r\n","import React from \"react\";\r\nimport { HexTile } from \"../../../../core/overworld/hexTile\";\r\nimport { pixelPosition } from \"../hexMath\";\r\nimport { CameraState } from \"./OverWorldMap\";\r\nimport \"./OverWorldPopover.scss\";\r\n\r\ninterface OverWorldPopoverProps {\r\n  camera: CameraState;\r\n  tile: HexTile;\r\n  children: React.ReactNode;\r\n}\r\n\r\nfunction OverWorldPopover({ tile, camera, children }: OverWorldPopoverProps) {\r\n  const [px, py] = pixelPosition(tile, camera);\r\n  // this element is put in the center\r\n  const container: React.CSSProperties = {\r\n    left: px + camera.scale * 0.3,\r\n    top: py,\r\n  };\r\n  return (\r\n    <div className=\"overworld-popover\" style={container}>\r\n      <div className=\"overworld-popover-positioner\">{children}</div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default OverWorldPopover;\r\n","import { AppActions, AppReducerContext, PopulationAttempt } from \"game/app\";\r\nimport { lerp } from \"math\";\r\nimport React from \"react\";\r\nimport Ticker from \"std/ticker\";\r\nimport { Vector2 } from \"three\";\r\nimport { HexTile } from \"../../../../core/overworld/hexTile\";\r\nimport { getCameraPositionCenteredOn, getClickedHexCoords, pixelPosition } from \"../hexMath\";\r\nimport HexInfo from \"./HexInfo\";\r\nimport HexTileSprite, { DrawingContext } from \"./hexTileSprite\";\r\nimport \"./OverWorldMap.scss\";\r\nimport OverWorldPopover from \"./OverWorldPopover\";\r\n\r\ninterface OverWorldMapProps {\r\n  // TODO turn this into a trigger, or global state\r\n  focusedHex?: HexTile;\r\n}\r\n\r\nexport interface CameraState {\r\n  /**\r\n   * Multiply cartesian hex coord values by scale to get pixel coordinates.\r\n   * Each hex is drawn with radius `scale`.\r\n   */\r\n\r\n  scale: number;\r\n  /**\r\n   * dX and dY are pure pixel offsets.\r\n   */\r\n  dX: number;\r\n  dY: number;\r\n}\r\n\r\n// function zoomCenteredOn(state: CameraState);\r\n\r\ninterface OverWorldMapState {\r\n  cameraState: CameraState;\r\n  pressedKeys: { [code: string]: boolean };\r\n  populationAttempt?: PopulationAttempt;\r\n  // TODO one of population attempt or highlighted hex can be\r\n  // non-null at a time\r\n  highlightedHex?: HexTile;\r\n  hoveredHex?: HexTile;\r\n  frame: number;\r\n}\r\n\r\nexport class OverWorldMap extends React.PureComponent<OverWorldMapProps, OverWorldMapState> implements DrawingContext {\r\n  static contextType = AppReducerContext;\r\n\r\n  context!: React.ContextType<typeof AppReducerContext>;\r\n\r\n  private hexTileSprites: Map<HexTile, HexTileSprite> = new Map();\r\n\r\n  private canvas: HTMLCanvasElement | null = null;\r\n\r\n  private rafId?: number;\r\n\r\n  get populationAttempt() {\r\n    return this.state.populationAttempt;\r\n  }\r\n\r\n  get highlightedHex() {\r\n    return this.state.highlightedHex;\r\n  }\r\n\r\n  constructor(props: OverWorldMapProps, context: any) {\r\n    super(props, context);\r\n    const scale = 96;\r\n    const [{ overWorld }] = context;\r\n    const [dX, dY] = getCameraPositionCenteredOn(overWorld.getStartHex(), scale);\r\n    this.state = {\r\n      cameraState: { scale, dX, dY },\r\n      pressedKeys: {},\r\n      frame: 0,\r\n    };\r\n    for (const tile of overWorld) {\r\n      const sprite = new HexTileSprite(tile, this);\r\n      this.hexTileSprites.set(tile, sprite);\r\n    }\r\n  }\r\n\r\n  private handleCanvasRef = (ref: HTMLCanvasElement | null) => {\r\n    this.canvas = ref;\r\n    if (ref != null) {\r\n      // Ticker.addAnimation(() => {\r\n      //   if (this.canvas != null) {\r\n      //     this.setState({ frame: this.state.frame + 1 });\r\n      //   }\r\n      //   return this.canvas == null;\r\n      // });\r\n      this.handleResize();\r\n    }\r\n  };\r\n\r\n  private handleCanvasClick = (e: React.MouseEvent) => {\r\n    if (this.state.populationAttempt != null || this.state.highlightedHex != null) {\r\n      this.setState({\r\n        populationAttempt: undefined,\r\n        highlightedHex: undefined,\r\n      });\r\n    } else {\r\n      const coords = getClickedHexCoords(this.canvas!, this.state.cameraState, e);\r\n      const [{ overWorld }] = this.context;\r\n      const clicked = overWorld.hexAt(coords.i, coords.j);\r\n      // simplest check - we clicked on a tile we can see\r\n      if (clicked != null && clicked.info.visible) {\r\n        // if clicked has no flora, migrate into it\r\n        if (clicked.info.flora == null) {\r\n          const target = clicked;\r\n          const source = overWorld.possibleMigrationSources(clicked)[0];\r\n          if (source != null) {\r\n            const populationAttempt: PopulationAttempt = {\r\n              targetHex: target,\r\n              sourceHex: source,\r\n              settlingSpecies: source.info.flora!.species,\r\n            };\r\n            this.setState({ populationAttempt, highlightedHex: undefined });\r\n          } else {\r\n            // TODO add a Popover for when you see a tile but can't reach it with anything\r\n            // this can happen in the future if earthquakes happen and destroy\r\n            // blocks you used to own\r\n          }\r\n        } else {\r\n          // clicked does have flora; just show a highlight\r\n          const highlightedHex = clicked;\r\n          this.setState({ highlightedHex, populationAttempt: undefined });\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private handleCanvasMouseLeave = () => {\r\n    this.setState({\r\n      hoveredHex: undefined,\r\n    });\r\n  };\r\n\r\n  private handleCanvasMouseMove = (e: React.MouseEvent) => {\r\n    const coords = getClickedHexCoords(this.canvas!, this.state.cameraState, e);\r\n    const hex = this.context[0].overWorld.hexAt(coords.i, coords.j);\r\n    this.setState({ hoveredHex: hex });\r\n  };\r\n\r\n  private handleClickPlay = () => {\r\n    const [, dispatch] = this.context;\r\n    const appAction = this.getAppAction();\r\n    if (appAction) {\r\n      dispatch({\r\n        type: \"AATransitionStart\",\r\n        transition: appAction,\r\n      });\r\n    }\r\n  };\r\n\r\n  private getAppAction(): AppActions | undefined {\r\n    if (this.state.populationAttempt != null) {\r\n      return {\r\n        type: \"AAStartPopulationAttempt\",\r\n        populationAttempt: this.state.populationAttempt,\r\n      };\r\n    } else if (this.state.highlightedHex != null) {\r\n      // re-populate the same tile\r\n      const sourceHex = this.state.highlightedHex;\r\n      return {\r\n        type: \"AAStartPopulationAttempt\",\r\n        populationAttempt: {\r\n          sourceHex,\r\n          targetHex: sourceHex,\r\n          settlingSpecies: sourceHex.info.flora!.species,\r\n        },\r\n      };\r\n    }\r\n  }\r\n\r\n  private handleKeyDown = (e: KeyboardEvent) => {\r\n    if (!e.repeat) {\r\n      const newPressedKeys = { ...this.state.pressedKeys, [e.code]: true };\r\n      this.setState({\r\n        pressedKeys: newPressedKeys,\r\n      });\r\n    }\r\n  };\r\n\r\n  private handleKeyUp = (e: KeyboardEvent) => {\r\n    const newPressedKeys = { ...this.state.pressedKeys };\r\n    delete newPressedKeys[e.code];\r\n    this.setState({\r\n      pressedKeys: newPressedKeys,\r\n    });\r\n  };\r\n\r\n  private handleWheel = (e: React.WheelEvent) => {\r\n    const delta = -(e.deltaX + e.deltaY) / 125 / 10;\r\n    const scalar = Math.pow(2, delta);\r\n\r\n    const scale = this.state.cameraState.scale * scalar;\r\n    this.setState({\r\n      cameraState: {\r\n        ...this.state.cameraState,\r\n        scale,\r\n      },\r\n    });\r\n  };\r\n\r\n  private handleResize = () => {\r\n    if (this.canvas != null) {\r\n      this.canvas.width = window.innerWidth;\r\n      this.canvas.height = window.innerHeight;\r\n      this.updateCanvas();\r\n    }\r\n  };\r\n\r\n  private updateCamera = () => {\r\n    const [state] = this.context;\r\n    const { transition } = state;\r\n    if (transition != null) {\r\n      if (transition.type === \"AAStartPopulationAttempt\") {\r\n        // zoom in\r\n        const { targetHex } = transition.populationAttempt;\r\n        const { scale, dX, dY } = this.state.cameraState;\r\n        const nextScale = scale * 1.02;\r\n        const [targetDX, targetDY] = getCameraPositionCenteredOn(targetHex, scale);\r\n        this.setState({\r\n          cameraState: {\r\n            dX: lerp(dX, targetDX, 0.2),\r\n            dY: lerp(dY, targetDY, 0.2),\r\n            scale: nextScale,\r\n          },\r\n        });\r\n      }\r\n    }\r\n    const panSpeed = 20;\r\n    let offset = new Vector2();\r\n    for (const key in this.state.pressedKeys) {\r\n      if (key === \"KeyW\" || key === \"ArrowUp\") {\r\n        offset.y += panSpeed;\r\n      } else if (key === \"KeyS\" || key === \"ArrowDown\") {\r\n        offset.y -= panSpeed;\r\n      } else if (key === \"KeyA\" || key === \"ArrowLeft\") {\r\n        offset.x += panSpeed;\r\n      } else if (key === \"KeyD\" || key === \"ArrowRight\") {\r\n        offset.x -= panSpeed;\r\n      }\r\n    }\r\n    offset.setLength(panSpeed);\r\n\r\n    if (offset.x !== 0 || offset.y !== 0) {\r\n      const cameraState = this.state.cameraState;\r\n\r\n      this.setState({\r\n        cameraState: {\r\n          ...cameraState,\r\n          dX: cameraState.dX + offset.x,\r\n          dY: cameraState.dY + offset.y,\r\n        },\r\n      });\r\n    }\r\n  };\r\n\r\n  private updateCanvas() {\r\n    if (this.canvas != null) {\r\n      const c = this.canvas.getContext(\"2d\")!;\r\n      this.drawMap(c);\r\n      this.drawMigrationArrows(c);\r\n      this.drawPopulationAttempt(c);\r\n    }\r\n  }\r\n\r\n  private drawMap(c: CanvasRenderingContext2D) {\r\n    const { hoveredHex, cameraState } = this.state;\r\n    c.clearRect(0, 0, c.canvas.width, c.canvas.height);\r\n\r\n    if (hoveredHex != null) {\r\n      this.hexTileSprites.get(hoveredHex)!.setIsHovered();\r\n    }\r\n\r\n    const sprites = Array.from(this.hexTileSprites.values());\r\n    sprites.sort((b, a) => {\r\n      return b.zIndex - a.zIndex;\r\n    });\r\n\r\n    for (const sprite of sprites) {\r\n      sprite.draw(c, cameraState);\r\n    }\r\n  }\r\n\r\n  private drawMigrationArrows(c: CanvasRenderingContext2D) {\r\n    const { hoveredHex, populationAttempt } = this.state;\r\n    if (hoveredHex != null && populationAttempt == null) {\r\n      if (hoveredHex.info.flora == null) {\r\n        this.drawPossibleMigrationIntoArrows(c, hoveredHex);\r\n      } else {\r\n        this.drawPossibleMigrationOutOfArrows(c, hoveredHex);\r\n      }\r\n    }\r\n  }\r\n\r\n  private drawPopulationAttempt(c: CanvasRenderingContext2D) {\r\n    const { populationAttempt } = this.state;\r\n    if (populationAttempt != null) {\r\n      this.drawMigrationArrow(c, populationAttempt.sourceHex!, populationAttempt.targetHex);\r\n    }\r\n  }\r\n\r\n  componentDidMount() {\r\n    document.addEventListener(\"keydown\", this.handleKeyDown);\r\n    document.addEventListener(\"keyup\", this.handleKeyUp);\r\n    window.addEventListener(\"resize\", this.handleResize);\r\n    this.rafId = Ticker.addAnimation(this.updateCamera);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    document.removeEventListener(\"keydown\", this.handleKeyDown);\r\n    document.removeEventListener(\"keyup\", this.handleKeyUp);\r\n    window.removeEventListener(\"resize\", this.handleResize);\r\n    Ticker.removeAnimation(this.rafId!);\r\n  }\r\n\r\n  componentDidUpdate(prevProps: OverWorldMapProps) {\r\n    if (prevProps.focusedHex !== this.props.focusedHex && this.props.focusedHex != null) {\r\n      this.focusHex(this.props.focusedHex);\r\n    }\r\n    this.updateCanvas();\r\n  }\r\n\r\n  focusHex(hex: HexTile) {\r\n    let tStart = 0;\r\n    Ticker.addAnimation((t) => {\r\n      if (tStart === 0) {\r\n        tStart = t;\r\n      }\r\n      const dt = t - tStart;\r\n      const [targetX, targetY] = getCameraPositionCenteredOn(hex, this.state.cameraState.scale);\r\n      const dX = this.state.cameraState.dX * 0.5 + targetX * 0.5;\r\n      const dY = this.state.cameraState.dY * 0.5 + targetY * 0.5;\r\n      this.setState({\r\n        cameraState: {\r\n          ...this.state.cameraState,\r\n          dX,\r\n          dY,\r\n        },\r\n      });\r\n      return dt > 1000 || (Math.abs(targetX - dX) < 1e-2 && Math.abs(targetY - dY) < 1e-2);\r\n    });\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      <div className=\"overworld-map-container\">\r\n        <canvas\r\n          tabIndex={-1}\r\n          ref={this.handleCanvasRef}\r\n          onClick={this.handleCanvasClick}\r\n          onMouseLeave={this.handleCanvasMouseLeave}\r\n          onMouseMove={this.handleCanvasMouseMove}\r\n          onWheel={this.handleWheel}\r\n        />\r\n        {this.maybeRenderPopover()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  drawPossibleMigrationIntoArrows(c: CanvasRenderingContext2D, target: HexTile) {\r\n    const [{ overWorld }] = this.context;\r\n    for (const source of overWorld.possibleMigrationSources(target)) {\r\n      this.drawMigrationArrow(c, source, target);\r\n    }\r\n  }\r\n\r\n  drawPossibleMigrationOutOfArrows(c: CanvasRenderingContext2D, source: HexTile) {\r\n    const [{ overWorld }] = this.context;\r\n    for (const target of overWorld.possibleMigrationTargets(source)) {\r\n      this.drawMigrationArrow(c, source, target);\r\n    }\r\n  }\r\n\r\n  public drawMigrationArrow(c: CanvasRenderingContext2D, source: HexTile, target: HexTile) {\r\n    const isShadowed = (() => {\r\n      if (this.highlightedHex != null) {\r\n        return true;\r\n      } else if (this.populationAttempt != null) {\r\n        return source !== this.populationAttempt.sourceHex || target !== this.populationAttempt.targetHex;\r\n      } else {\r\n        return false;\r\n      }\r\n    })();\r\n    if (isShadowed) {\r\n      c.globalAlpha = 0.2;\r\n    } else {\r\n      c.globalAlpha = 1;\r\n    }\r\n    const { scale } = this.state.cameraState;\r\n    c.shadowBlur = (3 * scale) / 48;\r\n    c.shadowOffsetX = (4 * scale) / 48;\r\n    c.shadowOffsetY = (4 * scale) / 48;\r\n    c.shadowColor = \"black\";\r\n    c.strokeStyle = \"white\";\r\n\r\n    c.lineWidth = (3 * scale) / 48;\r\n    c.lineCap = \"round\";\r\n    c.lineJoin = \"round\";\r\n    const targetCenter = new Vector2(...pixelPosition(target, this.state.cameraState));\r\n    const sourceCenter = new Vector2(...pixelPosition(source, this.state.cameraState));\r\n    const arrowStart = sourceCenter.clone().lerp(targetCenter, 0.2);\r\n    const arrowEnd = targetCenter.clone().lerp(sourceCenter, 0.2);\r\n    drawArrow(c, arrowStart.x, arrowStart.y, arrowEnd.x, arrowEnd.y, (10 * scale) / 48);\r\n    c.shadowColor = \"transparent\";\r\n  }\r\n\r\n  maybeRenderPopover() {\r\n    const { cameraState, populationAttempt, highlightedHex } = this.state;\r\n    if (populationAttempt != null) {\r\n      return (\r\n        <OverWorldPopover camera={cameraState} tile={populationAttempt.targetHex}>\r\n          <HexInfo\r\n            playSpecies={populationAttempt.settlingSpecies}\r\n            tile={populationAttempt.targetHex}\r\n            onClickPlay={this.handleClickPlay}\r\n          />\r\n        </OverWorldPopover>\r\n      );\r\n    } else if (highlightedHex != null) {\r\n      return (\r\n        <OverWorldPopover camera={cameraState} tile={highlightedHex}>\r\n          <HexInfo\r\n            playSpecies={highlightedHex.info.flora!.species}\r\n            tile={highlightedHex}\r\n            onClickPlay={this.handleClickPlay}\r\n          />\r\n        </OverWorldPopover>\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nfunction drawArrow(c: CanvasRenderingContext2D, fromx: number, fromy: number, tox: number, toy: number, headlen = 10) {\r\n  c.beginPath();\r\n  var dx = tox - fromx;\r\n  var dy = toy - fromy;\r\n  var angle = Math.atan2(dy, dx);\r\n  c.moveTo(fromx, fromy);\r\n  c.lineTo(tox, toy);\r\n  c.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));\r\n  c.moveTo(tox, toy);\r\n  c.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));\r\n  c.stroke();\r\n}\r\n","export default function configure<T>(obj: T, callback: (obj: T) => void): T {\r\n  callback(obj);\r\n  return obj;\r\n}\r\n","import Chromosome from \"core/cell/chromosome\";\r\nimport { useAppReducer } from \"game/app\";\r\nimport React from \"react\";\r\nimport { IoIosAddCircleOutline } from \"react-icons/io\";\r\nimport { Color, Vector2 } from \"three\";\r\nimport Genome, { CellType } from \"../../../core/cell/genome\";\r\n\r\nexport const AddCellCard: React.FC<{\r\n  genome: Genome;\r\n}> = ({ genome }) => {\r\n  // const [state, setState] = React.useContext(DraggedContext);\r\n  const [, dispatch] = useAppReducer();\r\n  const handleAddCell = React.useCallback(() => {\r\n    const newCellType = new CellType(\r\n      \"Cell \" + (genome.cellTypes.length + 1),\r\n      0,\r\n      new Chromosome(),\r\n      {\r\n        texturePosition: new Vector2(1, 1),\r\n        color: new Color(Math.random(), Math.random(), Math.random()),\r\n      },\r\n      {\r\n        type: \"give\",\r\n        resources: \"water and sugar\",\r\n      }\r\n    );\r\n    genome.cellTypes.push(newCellType);\r\n    dispatch({ type: \"AAUpdateSpecies\" });\r\n  }, [dispatch, genome.cellTypes]);\r\n  return (\r\n    <div className=\"add-cell-card\">\r\n      <div className=\"add-cell\" onClick={handleAddCell}>\r\n        Add Cell\r\n      </div>\r\n      <button onClick={handleAddCell}>\r\n        <IoIosAddCircleOutline />\r\n      </button>\r\n    </div>\r\n  );\r\n};\r\n","export default function lazy<T>(fn: () => T): () => T {\r\n  let cache: T;\r\n  return () => {\r\n    if (cache === undefined) {\r\n      cache = fn();\r\n    }\r\n    return cache;\r\n  };\r\n}\r\n","import spritesheetUrl from \"assets/images/spritesheet.png\";\r\nimport * as THREE from \"three\";\r\nimport lazy from \"../common/lazy\";\r\n\r\nconst spriteSize = 32; // 32x32 sprites\r\nexport let spritesheetLoaded = false;\r\nexport const SPRITESHEET = lazy(() =>\r\n  new THREE.TextureLoader().load(spritesheetUrl, (texture) => {\r\n    texture.magFilter = THREE.NearestFilter;\r\n    texture.flipY = true;\r\n    texture.wrapS = texture.wrapT = THREE.ClampToEdgeWrapping;\r\n    SPRITESHEET().dispatchEvent({ type: \"update\" });\r\n    spritesheetLoaded = true;\r\n  })\r\n);\r\n\r\nexport const cache: { [key: string]: THREE.Texture } = {};\r\n// x, y are spritesheet coordinates, starting top-left and going down/right\r\nexport function textureFromSpritesheet(x: number, y: number, backgroundColor = \"transparent\") {\r\n  x = Math.floor(x);\r\n  y = Math.floor(y);\r\n  const key = `${x},${y}`;\r\n  if (cache[key] == null) {\r\n    const canvas = document.createElement(\"canvas\");\r\n    canvas.width = spriteSize;\r\n    canvas.height = spriteSize;\r\n    const texture = new THREE.Texture(canvas);\r\n    texture.magFilter = THREE.NearestFilter;\r\n    texture.flipY = true;\r\n    texture.wrapS = THREE.RepeatWrapping;\r\n    texture.wrapT = THREE.RepeatWrapping;\r\n    function drawSpriteToCanvas() {\r\n      const image = SPRITESHEET().image;\r\n      const context = canvas.getContext(\"2d\")!;\r\n      context.fillStyle = backgroundColor;\r\n      context.fillRect(0, 0, spriteSize, spriteSize);\r\n      // context.fillStyle = \"white\";\r\n      // flip the image vertically\r\n      context.drawImage(\r\n        image,\r\n        // sx, sy, sWidth, sHeight\r\n        spriteSize * x,\r\n        spriteSize * y,\r\n        spriteSize,\r\n        spriteSize,\r\n        // dx, dy, dWidth, dHeight\r\n        0,\r\n        0,\r\n        spriteSize,\r\n        spriteSize\r\n      );\r\n      texture.needsUpdate = true;\r\n      // devlog(\"updated spritesheet for\", x, y);\r\n    }\r\n    if (spritesheetLoaded) {\r\n      drawSpriteToCanvas();\r\n    } else {\r\n      SPRITESHEET().addEventListener(\"update\", () => {\r\n        drawSpriteToCanvas();\r\n      });\r\n    }\r\n    cache[key] = texture;\r\n  }\r\n  return cache[key];\r\n}\r\n","import classNames from \"classnames\";\r\nimport React from \"react\";\r\nimport { CellType } from \"../../../core/cell/genome\";\r\nimport { textureFromSpritesheet } from \"../../spritesheet\";\r\nimport \"./IconCell.scss\";\r\nimport { ResourceIcon } from \"./ResourceIcon\";\r\n\r\nexport const ActionBarItem: React.FC<React.HTMLProps<HTMLDivElement>> = ({ children, className, ...props }) => {\r\n  return (\r\n    <div className={classNames(\"action-bar-item\", className)} {...props}>\r\n      {children}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst IconCell: React.FC<{ cellType: CellType; showCosts?: boolean; spritesheetLoaded: boolean } & React.HTMLProps<\r\n  HTMLDivElement\r\n>> = ({ children, cellType, spritesheetLoaded, showCosts = false, ...props }) => {\r\n  const { material } = cellType;\r\n  const { costSugar, costWater, timeToBuild } = cellType.chromosome.computeStaticProperties();\r\n  const color = (material.color && material.color.getStyle()) || \"transparent\";\r\n  const texture = textureFromSpritesheet(material.texturePosition.x, material.texturePosition.y, color);\r\n  const style: React.CSSProperties = React.useMemo(() => {\r\n    const image = texture.image;\r\n    const url = (() => {\r\n      if (image != null) {\r\n        if (image instanceof HTMLCanvasElement && spritesheetLoaded) {\r\n          return image.toDataURL();\r\n        } else if (image instanceof Image) {\r\n          return image.src;\r\n        } else {\r\n          throw new Error(\"image is\" + image);\r\n        }\r\n      } else {\r\n        return \"\";\r\n      }\r\n    })();\r\n    const backgroundImage = `url(${url}), linear-gradient(${color}, ${color})`;\r\n    return {\r\n      backgroundImage,\r\n    };\r\n  }, [color, spritesheetLoaded, texture.image]);\r\n\r\n  const costsEl = showCosts ? (\r\n    <div className=\"costs\">\r\n      <div className=\"time-to-build-info\">{timeToBuild} sec</div>\r\n      <div className=\"cost-to-build-info\">\r\n        {costWater}\r\n        <ResourceIcon name=\"water\" />\r\n        {costSugar}\r\n        <ResourceIcon name=\"sugar\" />\r\n      </div>\r\n    </div>\r\n  ) : null;\r\n\r\n  return (\r\n    <ActionBarItem\r\n      {...props}\r\n      className={classNames(\"icon-cell\", { reproducer: cellType.isReproducer() })}\r\n      style={style}\r\n    >\r\n      {children}\r\n      {costsEl}\r\n    </ActionBarItem>\r\n  );\r\n};\r\nexport default IconCell;\r\n","import React from \"react\";\r\nimport { CellInteraction, describeCellInteraction } from \"../../../core/cell/genome\";\r\n\r\nexport const CellInteractionSelector: React.FC<{\r\n  interaction?: CellInteraction;\r\n  setInteraction: (i: CellInteraction | undefined) => void;\r\n}> = React.memo(({ interaction, setInteraction }) => {\r\n  const handleSelect = React.useCallback(\r\n    (event: React.ChangeEvent<HTMLSelectElement>) => {\r\n      const indexOrUndefined = event.target.value;\r\n      if (indexOrUndefined == null) {\r\n        setInteraction(undefined);\r\n        // cellType.interaction = undefined;\r\n      } else {\r\n        setInteraction(possibleInteractions[Number(indexOrUndefined)]);\r\n        // cellType.interaction = possibleInteractions[Number(indexOrUndefined)];\r\n      }\r\n    },\r\n    [setInteraction]\r\n  );\r\n  const selectValue =\r\n    interaction == null\r\n      ? undefined\r\n      : possibleInteractions.findIndex((i) => interaction.resources === i.resources && interaction.type === i.type);\r\n  const interactionEl = (\r\n    // <select className=\"interaction-select\" onChange={handleSelect} value={selectValue}>\r\n    <select className=\"interaction-select\" onChange={handleSelect} defaultValue={String(selectValue)}>\r\n      <option value={undefined}>do nothing</option>\r\n      {possibleInteractions.map((interaction, index) => {\r\n        return (\r\n          <option key={index} value={index}>\r\n            {describeCellInteraction(interaction)}\r\n          </option>\r\n        );\r\n      })}\r\n    </select>\r\n  );\r\n  return <div className=\"interaction-select-container\">Left-click to {interactionEl}.</div>;\r\n});\r\n\r\nconst interactionTypes = [\"give\", \"take\"] as const;\r\nconst resourceTypes = [\"water\", \"sugar\", \"water and sugar\"] as const;\r\nexport const possibleInteractions: CellInteraction[] = interactionTypes.flatMap((type) =>\r\n  resourceTypes.map((resources) => ({\r\n    type,\r\n    resources,\r\n  }))\r\n);\r\npossibleInteractions.push(\r\n  {\r\n    type: \"give\",\r\n    resources: \"water take sugar\",\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"sugar take water\",\r\n  }\r\n);\r\n","import { CellType } from \"core/cell\";\r\nimport Genome from \"core/cell/genome\";\r\n\r\nexport function droppableIdToCell(state: Genome, droppableId: string): CellType | undefined {\r\n  return state.cellTypes.find(({ name }) => name === droppableId);\r\n}\r\n\r\nexport function cellToDroppableId(cell: CellType): string {\r\n  return cell.name;\r\n}\r\n","import { Popover } from \"@blueprintjs/core\";\r\nimport React, { useCallback, useState } from \"react\";\r\nimport { IoMdMore } from \"react-icons/io\";\r\nimport \"./MoreOptionsPopover.scss\";\r\n\r\nconst MoreOptionsPopover: React.FC = ({ children }) => {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const handleMoreClicked = useCallback(() => {\r\n    setIsOpen((open) => !open);\r\n  }, []);\r\n  const handleOuterAction = useCallback(() => {\r\n    setIsOpen(false);\r\n  }, []);\r\n  const popoverContent = (\r\n    <div className=\"more-options\">\r\n      {children}\r\n      <button onClick={handleOuterAction}>Back</button>\r\n    </div>\r\n  );\r\n  return (\r\n    <Popover\r\n      isOpen={isOpen}\r\n      position=\"right\"\r\n      transitionDuration={100}\r\n      content={popoverContent}\r\n      popoverClassName=\"more-options-popover\"\r\n    >\r\n      <IoMdMore className=\"more-options-icon\" onClick={handleMoreClicked} />\r\n    </Popover>\r\n  );\r\n};\r\n\r\nexport default MoreOptionsPopover;\r\n","import classNames from \"classnames\";\r\nimport DynamicNumber from \"game/ui/common/DynamicNumber\";\r\nimport React from \"react\";\r\nimport \"./GeneCost.scss\";\r\n\r\nexport function GeneCost({\r\n  cost,\r\n  className,\r\n  ...props\r\n}: {\r\n  cost: number;\r\n} & React.HTMLAttributes<HTMLSpanElement>) {\r\n  return (\r\n    <span\r\n      {...props}\r\n      className={classNames(\"gene-cost\", className, {\r\n        negative: cost < 0,\r\n      })}\r\n    >\r\n      {cost < 0 ? \"+\" : null}\r\n      <DynamicNumber value={Math.abs(cost)} speed={0.5} />\r\n    </span>\r\n  );\r\n}\r\n","import classNames from \"classnames\";\r\nimport { nf } from \"common/formatters\";\r\nimport { TIME_PER_DAY } from \"core/constants\";\r\nimport { arrayRange } from \"math/arrays\";\r\nimport React from \"react\";\r\nimport { Draggable } from \"react-beautiful-dnd\";\r\nimport { GiElectric } from \"react-icons/gi\";\r\nimport { RealizedGene } from \"../../../core/cell/realizedGene\";\r\nimport { GeneCost } from \"./GeneCost\";\r\nimport \"./RealizedGeneViewer.scss\";\r\n\r\nconst EnergyUpkeep: React.FC<{ upkeep: number }> = ({ upkeep }) => {\r\n  let els: JSX.Element;\r\n  if (upkeep % 1 === 0 && upkeep <= 3) {\r\n    els = (\r\n      <>\r\n        {arrayRange(upkeep).map((i) => (\r\n          <GiElectric key={i} />\r\n        ))}\r\n      </>\r\n    );\r\n  } else {\r\n    els = (\r\n      <>\r\n        {nf(upkeep * 100 * TIME_PER_DAY, 3)}% <GiElectric />\r\n        /day\r\n      </>\r\n    );\r\n  }\r\n  return <div className=\"energy-upkeep\">{els}</div>;\r\n};\r\n\r\nexport const RealizedGeneViewer: React.FC<{\r\n  gene: RealizedGene;\r\n  index: number;\r\n  invalid?: boolean;\r\n  draggable?: boolean;\r\n  view?: \"small\" | \"expanded\";\r\n}> = ({ index, gene, draggable = true, view = \"expanded\", invalid = false }) => {\r\n  const { gene: gd } = gene;\r\n  const cost = gene.getCost();\r\n  const energyUpkeepEl = gene.getStaticProperties().energyUpkeep ? (\r\n    <EnergyUpkeep upkeep={gene.getStaticProperties().energyUpkeep!} />\r\n  ) : null;\r\n  const geneLevelEl =\r\n    gene.level > 0 ? (\r\n      <div className=\"gene-level\">\r\n        {arrayRange(gene.level + 1).map((i) => (\r\n          <></>\r\n        ))}\r\n      </div>\r\n    ) : null;\r\n  const reproducer = gene.getStaticProperties().isReproductive;\r\n  return (\r\n    <Draggable key={gene.uuid} draggableId={`draggable-${gene.uuid}`} index={index} isDragDisabled={!draggable}>\r\n      {(provided, snapshot, rubric) => (\r\n        <div\r\n          ref={provided.innerRef}\r\n          {...provided.draggableProps}\r\n          {...provided.dragHandleProps}\r\n          className={classNames(\"gene\", view, gd.blueprint.name.replace(\" \", \"\"), {\r\n            draggable,\r\n            invalid,\r\n            reproducer,\r\n            provider: cost < 0,\r\n          })}\r\n        >\r\n          <div className=\"gene-header\">\r\n            <GeneCost cost={cost} />\r\n            <h4>\r\n              {gd.blueprint.name} {geneLevelEl}\r\n            </h4>\r\n            {energyUpkeepEl}\r\n          </div>\r\n\r\n          <div className=\"description\">{gd.blueprint.description(gene.getProps(), gene.getStaticProperties())}</div>\r\n        </div>\r\n      )}\r\n    </Draggable>\r\n  );\r\n};\r\n","import { Species } from \"core/species\";\r\nimport React from \"react\";\r\nimport { DragStart } from \"react-beautiful-dnd\";\r\n\r\nexport interface ViewerState {\r\n  view: \"small\" | \"expanded\";\r\n  editable: boolean;\r\n  isDragging: boolean;\r\n  species: Species;\r\n  dragStart?: DragStart;\r\n}\r\n\r\nexport const ViewerContext = React.createContext<ViewerState>({\r\n  view: \"expanded\",\r\n  editable: false,\r\n  isDragging: false,\r\n  species: null!,\r\n});\r\n","import { Tooltip } from \"@blueprintjs/core\";\r\nimport classNames from \"classnames\";\r\nimport { nf } from \"common/formatters\";\r\nimport { TIME_PER_DAY } from \"core/constants\";\r\nimport { useAppReducer } from \"game/app\";\r\nimport React, { useCallback, useContext } from \"react\";\r\nimport { Droppable } from \"react-beautiful-dnd\";\r\nimport { MdDelete } from \"react-icons/md\";\r\nimport Genome, { CellInteraction, CellType } from \"../../../core/cell/genome\";\r\nimport { spritesheetLoaded } from \"../../spritesheet\";\r\nimport DynamicNumber from \"../common/DynamicNumber\";\r\nimport IconCell from \"../common/IconCell\";\r\nimport { CellInteractionSelector } from \"./CellInteractionSelector\";\r\nimport \"./CellTypeViewer.scss\";\r\nimport { cellToDroppableId } from \"./droppableId\";\r\nimport MoreOptionsPopover from \"./MoreOptionsPopover\";\r\nimport { RealizedGeneViewer } from \"./RealizedGeneViewer\";\r\nimport { ViewerContext } from \"./viewerState\";\r\n\r\nexport const CellTypeViewer: React.FC<{\r\n  genome: Genome;\r\n  cellType: CellType;\r\n  editable?: boolean;\r\n}> = ({ genome, cellType, editable = false }) => {\r\n  const { name } = cellType;\r\n  const handleSetInteraction = React.useCallback(\r\n    (i: CellInteraction | undefined) => {\r\n      cellType.interaction = i;\r\n    },\r\n    [cellType.interaction]\r\n  );\r\n  const reproducer = cellType.isReproducer();\r\n\r\n  return (\r\n    <div className={classNames(\"cell-type\", { reproducer })}>\r\n      <div className=\"cell-header\">\r\n        <h2>{name}</h2>\r\n        {editable ? <CellActionsPopover cellType={cellType} genome={genome} /> : null}\r\n      </div>\r\n      <ChromosomeViewer cellType={cellType} />\r\n      <div className=\"cell-footer\">\r\n        <GeneSlots cellType={cellType} />\r\n        <CellInteractionSelector interaction={cellType.interaction} setInteraction={handleSetInteraction} />\r\n        <IconCell cellType={cellType} spritesheetLoaded={spritesheetLoaded} showCosts />\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst GeneSlots: React.FC<{ cellType: CellType }> = ({ cellType }) => {\r\n  const { chromosome } = cellType;\r\n  const chanceForCancer = cellType.getChanceToBecomeCancerous();\r\n  const cancerEl =\r\n    chanceForCancer > 0 ? (\r\n      <div className=\"chance-to-cancer\">\r\n        Cell may become cancerous: {nf(chanceForCancer * 100 * TIME_PER_DAY, 3)}% per day.\r\n      </div>\r\n    ) : (\r\n      undefined\r\n    );\r\n  const isGeneSlotsOver = chromosome.geneSlotsNet() < 0;\r\n  const tooltipContent = (\r\n    <>\r\n      Once you go over on your gene slots, negative effects will start accruing on your cell.\r\n      {cancerEl}\r\n    </>\r\n  );\r\n  return (\r\n    <Tooltip content={tooltipContent} position=\"top\" popoverClassName=\"gene-slots-popover\" hoverOpenDelay={250}>\r\n      <div className=\"gene-slots\">\r\n        Gene Slots:{\" \"}\r\n        <span className={classNames(\"slots-used\", { \"is-over\": isGeneSlotsOver })}>\r\n          <DynamicNumber value={Math.abs(chromosome.geneSlotsNet())} /> {isGeneSlotsOver ? \"over\" : \"under\"}.\r\n        </span>\r\n      </div>\r\n    </Tooltip>\r\n  );\r\n};\r\n\r\nconst ChromosomeViewer = ({ cellType }: { cellType: CellType }) => {\r\n  const viewerState = useContext(ViewerContext);\r\n  const { editable, view, isDragging } = viewerState;\r\n  const { chromosome } = cellType;\r\n  const { genes } = chromosome;\r\n  const empty = genes.length === 0;\r\n\r\n  const duplicateGenes = cellType.getDuplicateGenes();\r\n  const validationEl =\r\n    duplicateGenes.size > 0 ? <div className=\"invalid-alert-text\">Cannot have duplicate genes.</div> : null;\r\n\r\n  return (\r\n    <Droppable key={cellType.name} droppableId={cellToDroppableId(cellType)}>\r\n      {(provided, snapshot) => (\r\n        <div\r\n          {...provided.droppableProps}\r\n          ref={provided.innerRef}\r\n          className={classNames(\"chromosome\", { dragging: isDragging, empty, invalid: duplicateGenes.size > 0 })}\r\n        >\r\n          {validationEl}\r\n          {genes.map((gene, i) => (\r\n            <RealizedGeneViewer\r\n              index={i}\r\n              key={gene.uuid}\r\n              gene={gene}\r\n              draggable={editable}\r\n              view={view}\r\n              invalid={duplicateGenes.has(gene)}\r\n            />\r\n          ))}\r\n          {provided.placeholder}\r\n        </div>\r\n      )}\r\n    </Droppable>\r\n  );\r\n};\r\n\r\nconst CellActionsPopover: React.FC<{\r\n  cellType: CellType;\r\n  genome: Genome;\r\n}> = ({ cellType, genome }) => {\r\n  const [, dispatch] = useAppReducer();\r\n  const deleteCellType = useCallback(() => {\r\n    const index = genome.cellTypes.indexOf(cellType);\r\n    genome.cellTypes.splice(index, 1);\r\n    dispatch({ type: \"AAUpdateSpecies\" });\r\n  }, [cellType, dispatch, genome.cellTypes]);\r\n\r\n  const chromosomeEmpty = cellType.chromosome.isEmpty();\r\n\r\n  return (\r\n    <MoreOptionsPopover>\r\n      <button onClick={deleteCellType} className=\"delete\" disabled={!chromosomeEmpty}>\r\n        <MdDelete />\r\n        {chromosomeEmpty ? \"Delete\" : \"Delete (Remove all genes first)\"}\r\n      </button>\r\n    </MoreOptionsPopover>\r\n  );\r\n};\r\n","import React from \"react\";\r\nimport Genome from \"../../../core/cell/genome\";\r\nimport { AddCellCard } from \"./AddCellCard\";\r\nimport { CellTypeViewer } from \"./CellTypeViewer\";\r\nimport \"./GenomeViewer.scss\";\r\nimport { ViewerContext } from \"./viewerState\";\r\n\r\nconst GenomeViewer: React.FC<{ genome: Genome }> = ({ genome }) => {\r\n  const { editable } = React.useContext(ViewerContext);\r\n  return (\r\n    <div className=\"genome-viewer\">\r\n      {genome.cellTypes.map((c) => (\r\n        <CellTypeViewer key={c.name} cellType={c} editable={editable} genome={genome} />\r\n      ))}\r\n      {editable ? <AddCellCard genome={genome} /> : null}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default GenomeViewer;\r\n","import { RealizedGene } from \"core/cell\";\r\nimport { Species } from \"core/species\";\r\nimport { AppActions } from \"game/app\";\r\nimport { geneDrop } from \"game/audio\";\r\nimport produce from \"immer\";\r\nimport { DropResult, ResponderProvided } from \"react-beautiful-dnd\";\r\nimport { droppableIdToCell } from \"./droppableId\";\r\nimport { populateGeneOptions } from \"./generateRandomGenes\";\r\nimport { ViewerState } from \"./viewerState\";\r\n\r\nexport const ID_TRASH = \"trash\";\r\nexport const ID_GENE_OPTIONS = \"gene-options\";\r\nexport const ID_GENES_UNUSED = \"genes-unused\";\r\n\r\nexport function getDraggedGene(viewerState: ViewerState) {\r\n  const { species, dragStart } = viewerState; //: Species, source: DraggableLocation) {\r\n\r\n  if (dragStart != null) {\r\n    const { droppableId, index } = dragStart.source;\r\n    switch (droppableId) {\r\n      case ID_GENE_OPTIONS:\r\n        return species.geneOptions[index];\r\n      case ID_GENES_UNUSED:\r\n        return species.genome.unusedGenes[index];\r\n      default:\r\n        return droppableIdToCell(species.genome, droppableId)?.chromosome.genes[index];\r\n    }\r\n  }\r\n}\r\n\r\nfunction speciesViewerDragEnd(\r\n  result: DropResult,\r\n  provided: ResponderProvided,\r\n  species: Species,\r\n  dispatch: React.Dispatch<AppActions>\r\n) {\r\n  if (result.destination != null && result.destination.droppableId !== ID_GENE_OPTIONS) {\r\n    geneDrop.play();\r\n    const sourceIndex = result.source.index;\r\n    const { index: destinationIndex, droppableId } = result.destination;\r\n    const newSpecies = produce(species, (draft) => {\r\n      let gene: RealizedGene | undefined;\r\n      let shouldRepopulateGeneOptions = false;\r\n\r\n      if (result.source.droppableId === ID_GENE_OPTIONS) {\r\n        gene = draft.geneOptions[sourceIndex];\r\n\r\n        // delete gene options\r\n        draft.freeMutationPoints -= 1;\r\n        if (draft.freeMutationPoints > 0) {\r\n          shouldRepopulateGeneOptions = true;\r\n        } else {\r\n          draft.geneOptions = [];\r\n        }\r\n      } else if (result.source.droppableId === ID_GENES_UNUSED) {\r\n        gene = draft.genome.unusedGenes.splice(sourceIndex, 1)[0];\r\n      } else {\r\n        // successful drag; move the gene\r\n        const sourceCell = droppableIdToCell(draft.genome, result.source.droppableId);\r\n        // delete and get gene from source cell\r\n        gene = sourceCell?.chromosome.genes.splice(sourceIndex, 1)[0];\r\n      }\r\n\r\n      if (gene != null) {\r\n        if (droppableId === ID_TRASH) {\r\n          // thrown in the trash, do nothing.\r\n        } else if (droppableId === ID_GENES_UNUSED) {\r\n          draft.genome.unusedGenes.splice(destinationIndex, 0, gene);\r\n        } else {\r\n          const destinationCell = droppableIdToCell(draft.genome, droppableId);\r\n          // put gene in destination cell\r\n          destinationCell?.chromosome.genes.splice(destinationIndex, 0, gene);\r\n        }\r\n      }\r\n      if (shouldRepopulateGeneOptions) {\r\n        draft.geneOptions = populateGeneOptions(draft);\r\n      }\r\n    });\r\n    dispatch({\r\n      type: \"AAUpdateSpecies\",\r\n      species: newSpecies,\r\n    });\r\n  }\r\n}\r\n\r\nexport default speciesViewerDragEnd;\r\n","import classNames from \"classnames\";\r\nimport configure from \"common/configure\";\r\nimport { RealizedGene } from \"core/cell\";\r\nimport { lineage, Species } from \"core/species\";\r\nimport { useAppReducer } from \"game/app\";\r\nimport { genePickUp } from \"game/audio\";\r\nimport MP from \"game/ui/common/MP\";\r\nimport React, { useCallback, useState } from \"react\";\r\nimport { BeforeCapture, DragDropContext, Droppable, DropResult, ResponderProvided } from \"react-beautiful-dnd\";\r\nimport { FaArrowsAltV, FaTrash } from \"react-icons/fa\";\r\nimport { TiThMenu } from \"react-icons/ti\";\r\nimport GenomeViewer from \"./GenomeViewer\";\r\nimport { RealizedGeneViewer } from \"./RealizedGeneViewer\";\r\nimport \"./SpeciesViewer.scss\";\r\nimport speciesViewerDragEnd, { ID_GENES_UNUSED, ID_GENE_OPTIONS, ID_TRASH } from \"./speciesViewerDragEnd\";\r\nimport { ViewerContext } from \"./viewerState\";\r\n\r\nconst SpeciesViewer: React.FC<{\r\n  speciesId: string;\r\n  editable?: boolean;\r\n}> = ({ speciesId, editable = false }) => {\r\n  const [isDragging, setIsDragging] = useState(false);\r\n  const [view, setView] = React.useState<\"small\" | \"expanded\">(\"small\");\r\n  const [state, dispatch] = useAppReducer();\r\n  const species = lineage(state.rootSpecies).find((s) => s.id === speciesId)!;\r\n\r\n  const viewerState = React.useMemo(() => ({ species, view, editable, isDragging }), [\r\n    editable,\r\n    isDragging,\r\n    species,\r\n    view,\r\n  ]);\r\n\r\n  const handleDragEnd = useCallback(\r\n    (result: DropResult, provided: ResponderProvided) => {\r\n      console.log(\"onDragEnd\", result, provided);\r\n      setIsDragging(false);\r\n      speciesViewerDragEnd(result, provided, species, dispatch);\r\n    },\r\n    [dispatch, species]\r\n  );\r\n\r\n  const handleBeforeCapture = useCallback((before: BeforeCapture) => {\r\n    setIsDragging(true);\r\n    genePickUp.play();\r\n  }, []);\r\n  const handleViewSmall = useCallback(() => {\r\n    setView(\"small\");\r\n  }, []);\r\n  const handleViewExpanded = useCallback(() => {\r\n    setView(\"expanded\");\r\n  }, []);\r\n\r\n  return (\r\n    <DragDropContext onDragEnd={handleDragEnd} onBeforeCapture={handleBeforeCapture}>\r\n      <ViewerContext.Provider value={viewerState}>\r\n        <div className=\"species-viewer\">\r\n          <div className=\"species-name\">{species.name}</div>\r\n          <div className=\"view-switcher\">\r\n            <TiThMenu onClick={handleViewSmall} className={classNames({ active: view === \"small\" })} />\r\n            <FaArrowsAltV onClick={handleViewExpanded} className={classNames({ active: view === \"expanded\" })} />\r\n          </div>\r\n          {species.freeMutationPoints > 0 && editable ? <MutationChooser species={species} /> : null}\r\n          {isDragging ? <DeleteGeneDroppable /> : null}\r\n          <GenomeViewer genome={species.genome} />\r\n          <UnusedGeneArea genes={species.genome.unusedGenes} />\r\n        </div>\r\n      </ViewerContext.Provider>\r\n    </DragDropContext>\r\n  );\r\n};\r\n\r\nexport default SpeciesViewer;\r\n\r\nconst MutationChooser: React.FC<{ species: Species }> = ({ species }) => {\r\n  const { freeMutationPoints, geneOptions } = species;\r\n  return (\r\n    <div className=\"mutation-chooser\">\r\n      <h1>\r\n        <MP amount={freeMutationPoints} /> mutations available\r\n      </h1>\r\n      <Droppable droppableId={ID_GENE_OPTIONS} isDropDisabled direction=\"horizontal\">\r\n        {(provided, snapshot) => (\r\n          <div className=\"gene-options\" ref={provided.innerRef} {...provided.droppableProps}>\r\n            {geneOptions.map((gene, index) => (\r\n              <RealizedGeneViewer index={index} key={gene.uuid} gene={gene} draggable view=\"expanded\" />\r\n            ))}\r\n            {provided.placeholder}\r\n          </div>\r\n        )}\r\n      </Droppable>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst DeleteGeneDroppable = () => {\r\n  return (\r\n    <Droppable droppableId={ID_TRASH}>\r\n      {(provided, snapshot) => (\r\n        <div\r\n          {...provided.droppableProps}\r\n          ref={provided.innerRef}\r\n          className={classNames(\"trash\", { hovered: snapshot.isDraggingOver, foo: configure(snapshot, console.log) })}\r\n        >\r\n          <FaTrash />\r\n          {/* <RealizedGeneViewer gene={tutorialGenome.cellTypes[0].chromosome.genes[0]} index={0} /> */}\r\n          {provided.placeholder}\r\n        </div>\r\n      )}\r\n    </Droppable>\r\n  );\r\n};\r\n\r\nconst UnusedGeneArea = ({ genes }: { genes: RealizedGene[] }) => {\r\n  const { isDragging, view, editable } = React.useContext(ViewerContext);\r\n  return (\r\n    <div className=\"unused-genes\">\r\n      <h2>Unused {genes.length}/5</h2>\r\n      <Droppable droppableId={ID_GENES_UNUSED} direction=\"horizontal\" isDropDisabled={genes.length >= 5}>\r\n        {(provided, snapshot) => (\r\n          <div\r\n            {...provided.droppableProps}\r\n            ref={provided.innerRef}\r\n            className={classNames(\"unused-genes-droppable\", { dragging: isDragging })}\r\n          >\r\n            {genes.map((gene, index) => (\r\n              <RealizedGeneViewer index={index} key={gene.uuid} gene={gene} draggable={editable} view={view} />\r\n            ))}\r\n            {provided.placeholder}\r\n          </div>\r\n        )}\r\n      </Droppable>\r\n    </div>\r\n  );\r\n};\r\n","import SpeciesViewer from \"./SpeciesViewer\";\r\n\r\nexport default SpeciesViewer;\r\n","import { Overlay } from \"@blueprintjs/core\";\r\nimport classNames from \"classnames\";\r\nimport { sleep } from \"common/promise\";\r\nimport { lineage, Species } from \"core/species\";\r\nimport { useAppReducer } from \"game/app\";\r\nimport { resetGame, save } from \"game/app/saveLoad\";\r\nimport { mitoOverworld } from \"game/audio\";\r\nimport { Button } from \"game/ui/common/Button\";\r\nimport PhylogeneticTree from \"game/ui/overworld/PhylogeneticTree\";\r\nimport React, { useCallback, useEffect, useRef, useState } from \"react\";\r\nimport { GiFamilyTree } from \"react-icons/gi\";\r\nimport { HexTile } from \"../../core/overworld/hexTile\";\r\nimport { EpochUI } from \"../ui/overworld/EpochUI\";\r\nimport { OverWorldMap } from \"../ui/overworld/map/OverWorldMap\";\r\nimport SpeciesViewer from \"../ui/SpeciesViewer\";\r\nimport \"./OverWorldScreen.scss\";\r\n\r\nexport interface OverWorldScreenProps {\r\n  onNextEpoch: () => void;\r\n}\r\n\r\nconst OverWorldScreen = React.memo(({ onNextEpoch }: OverWorldScreenProps) => {\r\n  useEffect(() => {\r\n    mitoOverworld.play();\r\n    return () => {\r\n      mitoOverworld.stop();\r\n    };\r\n  }, []);\r\n\r\n  const [leftPanelOpen, setLeftPanelOpen] = useState(false);\r\n\r\n  useEffect(() => {\r\n    function handleKeyDown(e: KeyboardEvent) {\r\n      if (e.code === \"Tab\") {\r\n        setLeftPanelOpen((open) => !open);\r\n        e.preventDefault();\r\n      }\r\n    }\r\n    document.addEventListener(\"keydown\", handleKeyDown);\r\n    return () => {\r\n      document.removeEventListener(\"keydown\", handleKeyDown);\r\n    };\r\n  }, []);\r\n\r\n  const [viewedSpecies, setViewedSpecies] = useState<string>();\r\n\r\n  const handleStartMutate = useCallback((s: Species) => {\r\n    setViewedSpecies(s.id);\r\n  }, []);\r\n\r\n  const [{ rootSpecies, epoch }] = useAppReducer();\r\n\r\n  const onMountEpoch = useRef(epoch);\r\n\r\n  useEffect(() => {\r\n    if (epoch !== onMountEpoch.current) {\r\n      sleep(4500).then(() => {\r\n        // TODO add a UI to let you mutate multiple species\r\n        const speciesReadyToMutate = lineage(rootSpecies).filter((species) => species.freeMutationPoints > 0);\r\n        setViewedSpecies(speciesReadyToMutate[0].id);\r\n      });\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [epoch]);\r\n\r\n  function maybeRenderPhylogeneticTreePanel() {\r\n    const unusedPoints = lineage(rootSpecies)\r\n      .map((x) => x.freeMutationPoints)\r\n      .reduce((a, b) => a + b);\r\n    const unusedPointsEl = unusedPoints > 0 ? <div className=\"unused-points\">{unusedPoints}</div> : null;\r\n    return (\r\n      <div className={classNames(\"panel-left\", { open: leftPanelOpen })}>\r\n        {leftPanelOpen ? <PhylogeneticTree onMutate={handleStartMutate} /> : null}\r\n        <button className=\"panel-left-handle\" onClick={() => setLeftPanelOpen((open) => !open)}>\r\n          <GiFamilyTree className=\"icon\" />\r\n          {unusedPointsEl}\r\n        </button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const handleSpeciesViewerClose = useCallback(() => {\r\n    setViewedSpecies(undefined);\r\n  }, []);\r\n  const speciesViewerEl = (\r\n    <Overlay isOpen={viewedSpecies != null} onClose={handleSpeciesViewerClose}>\r\n      <div className=\"species-viewer-modal\">\r\n        <button className=\"close\" onClick={handleSpeciesViewerClose}>\r\n          \r\n        </button>\r\n        <SpeciesViewer speciesId={viewedSpecies!} editable />\r\n      </div>\r\n    </Overlay>\r\n  );\r\n\r\n  const [focusedHex, setFocusedHex] = useState<HexTile | undefined>(undefined);\r\n  const handleFocusHex = useCallback((hex: HexTile) => {\r\n    setFocusedHex(hex);\r\n  }, []);\r\n\r\n  const [appState] = useAppReducer();\r\n\r\n  return (\r\n    <div className=\"overworld-screen\">\r\n      <OverWorldMap focusedHex={focusedHex} />\r\n      {maybeRenderPhylogeneticTreePanel()}\r\n      {speciesViewerEl}\r\n      <EpochUI onNextEpoch={onNextEpoch} onFocusHex={handleFocusHex} />\r\n      <div style={{ position: \"absolute\", right: \"10px\", top: \"10px\" }}>\r\n        <Button onClick={() => save(appState)}>Save</Button>\r\n      </div>\r\n      <div style={{ position: \"absolute\", right: \"10px\", top: \"60px\" }}>\r\n        <Button onClick={() => resetGame()}>Reset Game</Button>\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default OverWorldScreen;\r\n","import devlog from \"common/devlog\";\r\nimport { sleep } from \"common/promise\";\r\nimport { OverWorld } from \"core/overworld/overWorld\";\r\nimport { newBaseSpecies } from \"core/species\";\r\nimport React, { useEffect } from \"react\";\r\nimport { AATransitionEnd, AppActions, AppReducerContext, reducer } from \"./reducer\";\r\nimport { load, saveOnActionMiddleware } from \"./saveLoad\";\r\nimport { AppState } from \"./state\";\r\n\r\nexport interface AppStateProviderProps {\r\n  children: React.ReactNode;\r\n  appState: AppState;\r\n}\r\n\r\n// when a TransitionStart action happens, automatically trigger a TransitionEnd\r\n// after millis\r\nexport function autoTransitionEndDispatchMiddleware(dispatch: React.Dispatch<AppActions>, millis = 2000) {\r\n  const newDispatch: React.Dispatch<AppActions> = (action: AppActions) => {\r\n    dispatch(action);\r\n    if (action.type === \"AATransitionStart\") {\r\n      sleep(millis).then(() => {\r\n        dispatch({ type: \"AATransitionEnd\" });\r\n      });\r\n    }\r\n  };\r\n  return newDispatch;\r\n}\r\n\r\nexport function handleTransitionEndMiddleware(\r\n  reducer: React.Reducer<AppState, AppActions>\r\n): React.Reducer<AppState, AppActions> {\r\n  function handleTransitionEnd(state: AppState, action: AATransitionEnd): AppState {\r\n    const { transition, ...stateWithoutTransition } = state;\r\n    if (transition) {\r\n      return reducer(stateWithoutTransition, transition);\r\n    } else {\r\n      devlog(\"handled transition end with no transition specified!\");\r\n      return state;\r\n    }\r\n  }\r\n\r\n  return (state, action) => {\r\n    if (action.type === \"AATransitionEnd\") {\r\n      return handleTransitionEnd(state, action);\r\n    } else {\r\n      return reducer(state, action);\r\n    }\r\n  };\r\n}\r\n\r\nexport function AppStateProvider({ children, appState }: AppStateProviderProps) {\r\n  const reducerWithMiddleware = React.useMemo(() => handleTransitionEndMiddleware(saveOnActionMiddleware(reducer)), []);\r\n  const [state, dispatchRaw] = React.useReducer(reducerWithMiddleware, appState);\r\n  const dispatch = React.useMemo(() => autoTransitionEndDispatchMiddleware(dispatchRaw), []);\r\n  const reducerTuple = React.useMemo(() => [state, dispatch] as [AppState, React.Dispatch<AppActions>], [\r\n    state,\r\n    dispatch,\r\n  ]);\r\n  return <AppReducerContext.Provider value={reducerTuple}>{children}</AppReducerContext.Provider>;\r\n}\r\n\r\nexport const LocalForageStateProvider: React.FC<{ loadingComponent: JSX.Element }> = ({\r\n  children,\r\n  loadingComponent = null,\r\n}) => {\r\n  const [state, setState] = React.useState<AppState | null>(null);\r\n  useEffect(() => {\r\n    load()\r\n      .then((appState) => {\r\n        setState(appState);\r\n        console.log(\"loading\", appState);\r\n      })\r\n      .catch(() => {\r\n        const newGameState = newInitialAppState();\r\n        console.log(\"couldn't load appState from localForage; resetting game\", newGameState);\r\n        setState(newGameState);\r\n      });\r\n  }, []);\r\n\r\n  return state == null ? loadingComponent : <AppStateProvider appState={state}>{children}</AppStateProvider>;\r\n};\r\n\r\nexport function newInitialAppState(): AppState {\r\n  const overWorld = OverWorld.generateRectangle(100, 50);\r\n  const rootSpecies = newBaseSpecies(\"plantum originus\");\r\n  const startHex = overWorld.getStartHex();\r\n  // rootSpecies.freeMutationPoints = 25;\r\n  // const s3 = newBaseSpecies(\"s3\");\r\n  // s3.descendants = [newBaseSpecies(\"ya\"), newBaseSpecies(\"no\"), newBaseSpecies(\"whoa\")];\r\n  // let s: Species;\r\n  // rootSpecies.descendants = [s = newBaseSpecies(\"foo\"), newBaseSpecies(\"bar\"), s3];\r\n  // s.descendants = [newBaseSpecies(\"1\"), newBaseSpecies(\"2\")]\r\n  return {\r\n    overWorld,\r\n    rootSpecies,\r\n    activePopulationAttempt: {\r\n      settlingSpecies: rootSpecies,\r\n      targetHex: startHex,\r\n    },\r\n    epoch: 0,\r\n  };\r\n}\r\n","import { Vector2 } from \"three\";\r\n\r\nexport class Mouse {\r\n  public readonly position = new Vector2();\r\n\r\n  public isPressed = false;\r\n\r\n  public button = -1;\r\n\r\n  constructor(el: HTMLElement) {\r\n    el.addEventListener(\"mousedown\", this.handleMouseDown);\r\n    el.addEventListener(\"mousemove\", this.handleMouseMove);\r\n    el.addEventListener(\"mouseup\", this.handleMouseUp);\r\n  }\r\n\r\n  private handleMouseDown = (event: MouseEvent) => {\r\n    this.isPressed = true;\r\n    this.button = event.button;\r\n    this.handleMouseMove(event);\r\n  };\r\n\r\n  private handleMouseMove = (event: MouseEvent) => {\r\n    this.position.x = event.clientX!;\r\n    this.position.y = event.clientY!;\r\n  };\r\n\r\n  private handleMouseUp = (event: MouseEvent) => {\r\n    this.isPressed = false;\r\n    this.button = -1;\r\n    this.handleMouseMove(event);\r\n  };\r\n}\r\n","import * as React from \"react\";\r\nimport * as THREE from \"three\";\r\n\r\nexport const UI_EVENTS = {\r\n  click: true,\r\n  contextmenu: true,\r\n  dblclick: true,\r\n  mousedown: true,\r\n  mouseup: true,\r\n  mousemove: true,\r\n  touchstart: true,\r\n  touchmove: true,\r\n  touchend: true,\r\n  keyup: true,\r\n  keydown: true,\r\n  keypress: true,\r\n  wheel: true,\r\n};\r\n\r\nexport type UIEventReciever = {\r\n  [E in keyof typeof UI_EVENTS]?: (this: HTMLElement, ev: GlobalEventHandlersEventMap[E]) => void;\r\n  // [E in keyof typeof UI_EVENTS]?: (ev: Event) => void;\r\n};\r\n\r\nexport abstract class ISketch {\r\n  static id?: string;\r\n\r\n  public elements?: JSX.Element[];\r\n\r\n  public events?: UIEventReciever;\r\n\r\n  /**\r\n   * milliseconds since sketch started running.\r\n   */\r\n  public timeElapsed = 0;\r\n\r\n  public frameCount = 0;\r\n\r\n  constructor(public renderer: THREE.WebGLRenderer, public audioContext: SketchAudioContext) {}\r\n\r\n  /**\r\n   * height / width\r\n   */\r\n  get aspectRatio() {\r\n    return this.renderer.domElement.height / this.renderer.domElement.width;\r\n  }\r\n\r\n  get resolution() {\r\n    return new THREE.Vector2(this.renderer.domElement.width, this.renderer.domElement.height);\r\n  }\r\n\r\n  get canvas() {\r\n    return this.renderer.domElement;\r\n  }\r\n\r\n  abstract animate(millisElapsed: number): void;\r\n\r\n  render?(): React.ReactNode;\r\n\r\n  resize?(width: number, height: number): void;\r\n\r\n  destroy?(): void;\r\n}\r\n\r\nexport interface SketchAudioContext extends AudioContext {\r\n  gain: GainNode;\r\n}\r\n","import { Scene } from \"three\";\r\nimport { Mito } from \"../mito/mito\";\r\nexport abstract class Renderer<T> {\r\n  constructor(public target: T, public scene: Scene, public mito: Mito) {}\r\n\r\n  abstract update(): void;\r\n\r\n  abstract destroy(): void;\r\n}\r\n","// hack - to work with vscode-glsl-literal\r\nconst glsl = (x: TemplateStringsArray) => x[0];\r\n\r\nexport default glsl;\r\n","import { BufferAttribute, BufferGeometry, Color, DynamicDrawUsage, Points, ShaderMaterial, Texture } from \"three\";\r\nimport glsl from \"./glsl\";\r\n\r\nexport class CommittablePoints extends Points {\r\n  public geometry: BufferGeometry;\r\n\r\n  public material: ResourcePointsMaterial;\r\n\r\n  static newGeometry(size: number) {\r\n    const geometry = new BufferGeometry();\r\n    const positions = new Float32Array(size * 3);\r\n    const rotations = new Float32Array(size);\r\n    const sizes = new Float32Array(size);\r\n    const alphas = new Float32Array(size);\r\n    geometry.setAttribute(\"position\", new BufferAttribute(positions, 3).setUsage(DynamicDrawUsage));\r\n    geometry.setAttribute(\"rotation\", new BufferAttribute(rotations, 1).setUsage(DynamicDrawUsage));\r\n    geometry.setAttribute(\"size\", new BufferAttribute(sizes, 1).setUsage(DynamicDrawUsage));\r\n    geometry.setAttribute(\"alpha\", new BufferAttribute(alphas, 1).setUsage(DynamicDrawUsage));\r\n    return geometry;\r\n  }\r\n\r\n  constructor(size: number, public params: CommittablePointsParameters) {\r\n    super();\r\n    this.geometry = CommittablePoints.newGeometry(size);\r\n    this.material = new ResourcePointsMaterial(params);\r\n    this.frustumCulled = false;\r\n  }\r\n\r\n  private index = 0;\r\n\r\n  startFrame() {\r\n    this.index = 0;\r\n  }\r\n\r\n  commit(x: number, y: number, z: number, size: number, alpha: number, r?: number) {\r\n    this.geometry.attributes.position.setXYZ(this.index, x, y, z);\r\n    this.geometry.attributes.size.setX(this.index, size);\r\n    this.geometry.attributes.alpha.setX(this.index, alpha);\r\n    if (r != null) {\r\n      this.geometry.attributes.rotation.setX(this.index, r);\r\n    }\r\n    this.index++;\r\n  }\r\n\r\n  endFrame() {\r\n    const positions = this.geometry.attributes.position as BufferAttribute;\r\n    positions.needsUpdate = true;\r\n    const sizes = this.geometry.attributes.size as BufferAttribute;\r\n    sizes.needsUpdate = true;\r\n    const rotations = this.geometry.attributes.rotation as BufferAttribute;\r\n    rotations.needsUpdate = true;\r\n    const alphas = this.geometry.attributes.alpha as BufferAttribute;\r\n    alphas.needsUpdate = true;\r\n    this.geometry.setDrawRange(0, this.index);\r\n  }\r\n}\r\n\r\nexport interface CommittablePointsParameters {\r\n  opacity: number;\r\n  color: Color;\r\n  size: number;\r\n  map?: Texture;\r\n}\r\n\r\nclass ResourcePointsMaterial extends ShaderMaterial {\r\n  public map: Texture | undefined;\r\n\r\n  constructor(public params: CommittablePointsParameters) {\r\n    super({\r\n      uniforms: {\r\n        opacity: { value: params.opacity },\r\n        sizeGlobal: { value: params.size },\r\n        color: { value: params.color },\r\n        // you have to put it here too\r\n        map: { value: params.map },\r\n      },\r\n      vertexShader,\r\n      fragmentShader,\r\n      depthTest: false,\r\n      transparent: true,\r\n    } as any);\r\n\r\n    // OH MY GOD you can do this. You have to do this *AFTER* the super call!\r\n    // This hooks into threejs WebGLProgram's built-in properties that hooks up\r\n    // various named textures to glsl variables and #DEFINEs.\r\n    this.map = params.map;\r\n  }\r\n}\r\n\r\nconst vertexShader = glsl`\r\nattribute float size;\r\nattribute float rotation;\r\nattribute float alpha;\r\nuniform float sizeGlobal;\r\n\r\nvarying float vAlpha;\r\nvarying float vRotation;\r\n\r\nvoid main() {\r\n  vRotation = rotation;\r\n  vAlpha = alpha;\r\n  vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\r\n  gl_PointSize = size * sizeGlobal * -projectionMatrix[1].y;\r\n  gl_Position = projectionMatrix * mvPosition;\r\n}\r\n`;\r\n\r\nconst fragmentShader = glsl`\r\nuniform vec3 color;\r\nuniform sampler2D texture;\r\nuniform float opacity;\r\n\r\nvarying float vRotation;\r\nvarying float vAlpha;\r\n\r\n#ifdef USE_MAP\r\n  uniform mat3 uvTransform;\r\n  uniform sampler2D map;\r\n#endif\r\n\r\nvec2 rotateAround ( in vec2 v, in vec2 center, in float angle ) {\r\n\r\n  float c = cos( angle );\r\n  float s = sin( angle );\r\n\r\n  float x = v.x - center.x;\r\n  float y = v.y - center.y;\r\n\r\n  vec2 r = vec2(x * c - y * s + center.x, x * s + y * c + center.y);\r\n\r\n  return r;\r\n}\r\n\r\nfloat zeroToOne(float x) {\r\n    return step(0., x) * (1. - step(1., x));\r\n}\r\n\r\nfloat inSquare(vec2 v) {\r\n  float xMult = zeroToOne(v.x);\r\n  float yMult = zeroToOne(v.y);\r\n  return xMult * yMult;\r\n}\r\n\r\nvoid main() {\r\n  gl_FragColor = vec4( color, 1. );\r\n  float alpha = vAlpha;\r\n\r\n  #ifdef USE_MAP\r\n    vec2 uv = gl_PointCoord;\r\n\r\n    // flip vRotation to account for flipped y viewport\r\n    uv = rotateAround(uv, vec2(0.5), -vRotation); //, vec2(0.), vec2(1.));\r\n\r\n    // if we're out of the UV clamped edge, set alpha to 0\r\n    alpha *= inSquare(uv);\r\n\r\n    vec4 mapTexel = texture2D( map, uv );\r\n    gl_FragColor *= mapTexelToLinear( mapTexel );\r\n  #endif\r\n  gl_FragColor.a *= opacity * alpha;\r\n}\r\n`;\r\n","import { CommittablePoints, CommittablePointsParameters } from \"./committablePoints\";\r\n\r\ninterface PointState<S> {\r\n  r?: number;\r\n  time: number;\r\n  size: number;\r\n  alpha: number;\r\n  x: number;\r\n  y: number;\r\n  z: number;\r\n  info: S;\r\n}\r\n\r\nexport class FireAndForgetPoints<S = any> extends CommittablePoints {\r\n  private state: Set<PointState<S>> = new Set();\r\n\r\n  constructor(public lifeFn: (s: PointState<S>, dt: number) => undefined | false, params: CommittablePointsParameters) {\r\n    super(10000, params);\r\n  }\r\n\r\n  fire(s: PointState<S>) {\r\n    this.state.add(s);\r\n  }\r\n\r\n  update(dt: number) {\r\n    const toRemove: PointState<S>[] = [];\r\n    for (const p of this.state) {\r\n      p.time += dt;\r\n      const nextState = this.lifeFn(p, dt);\r\n      if (nextState === false) {\r\n        toRemove.push(p);\r\n      }\r\n    }\r\n    for (const p of toRemove) {\r\n      this.state.delete(p);\r\n    }\r\n  }\r\n\r\n  commitAll() {\r\n    this.startFrame();\r\n    for (const p of this.state) {\r\n      this.commit(p.x, p.y, p.z, p.size, p.alpha, p.r);\r\n    }\r\n    this.endFrame();\r\n  }\r\n}\r\n","import { TileEvent } from \"core/tile/tileEvent\";\r\nimport { Renderer } from \"../Renderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\n\r\nexport abstract class EventRenderer<T extends TileEvent> extends Renderer<T[]> {\r\n  constructor(public eventName: T[\"type\"], public worldRenderer: WorldRenderer) {\r\n    super([], worldRenderer.scene, worldRenderer.mito);\r\n  }\r\n\r\n  abstract handle(event: T): void;\r\n\r\n  update() {\r\n    this.target = this.worldRenderer.target.getLastStepStats().events[this.eventName] as T[];\r\n  }\r\n}\r\n","import { TileEvent } from \"core/tile/tileEvent\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRenderer } from \"./eventRenderer\";\r\n\r\nexport abstract class EventRendererFFPoints<T extends TileEvent> extends EventRenderer<T> {\r\n  constructor(public eventName: T[\"type\"], public worldRenderer: WorldRenderer, public ffPoints: FireAndForgetPoints) {\r\n    super(eventName, worldRenderer);\r\n    this.scene.add(this.ffPoints);\r\n  }\r\n\r\n  abstract handle(event: T): void;\r\n\r\n  update() {\r\n    super.update();\r\n    this.ffPoints.update(1 / 30);\r\n    for (const event of this.target) {\r\n      this.handle(event);\r\n    }\r\n    this.ffPoints.commitAll();\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.ffPoints);\r\n  }\r\n}\r\n","import { EventCellEat } from \"core/tile/tileEvent\";\r\nimport { distScalar, eatBuffer } from \"game/audio\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { Audio, Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { InstancedTileRenderer } from \"../tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventCellEatRenderer extends EventRendererFFPoints<EventCellEat> {\r\n  static makePoints() {\r\n    const duration = 0.6;\r\n    return new FireAndForgetPoints(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const x = s.time / duration;\r\n        s.size = 4 * (x - x * x);\r\n      },\r\n      {\r\n        color: new Color(\"yellow\"),\r\n        opacity: 0.8,\r\n        size: 200,\r\n        map: textureFromSpritesheet(1, 3, \"transparent\"),\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"cell-eat\", target, EventCellEatRenderer.makePoints());\r\n  }\r\n\r\n  private audio = (() => {\r\n    const audio = new Audio(this.mito.audioListener);\r\n    audio.loop = true;\r\n    audio.setVolume(0);\r\n    eatBuffer.then((buffer) => {\r\n      audio.setBuffer(buffer);\r\n      audio.play();\r\n      audio.setDetune(600);\r\n    });\r\n    return audio;\r\n  })();\r\n\r\n  handle(event: EventCellEat) {\r\n    const { who } = event;\r\n    const baseVolume = 0.04;\r\n    const volume = distScalar(who, this.mito.world.player) * baseVolume;\r\n    if (volume > this.audio.gain.gain.value) {\r\n      this.audio.gain.gain.setValueAtTime(volume, 0);\r\n      this.audio.gain.gain.cancelScheduledValues(this.audio.context.currentTime + 1);\r\n      this.audio.gain.gain.setTargetAtTime(0, this.audio.context.currentTime + 1, 0.1);\r\n    }\r\n    const tileRenderer = this.worldRenderer.renderers.get(who) as InstancedTileRenderer | null;\r\n    const activeSugar = tileRenderer?.inventoryRenderer?.getActiveSugar();\r\n    const dX = activeSugar?.x ?? 0;\r\n    const dY = activeSugar?.y ?? 0;\r\n    this.ffPoints.fire({\r\n      x: who.pos.x + dX,\r\n      y: who.pos.y + dY,\r\n      z: 1,\r\n      size: 1,\r\n      alpha: 1,\r\n      info: event,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","import { EventCellTransferEnergy } from \"core/tile/tileEvent\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { map } from \"math\";\r\nimport { Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventCellTransferEnergyRenderer extends EventRendererFFPoints<EventCellTransferEnergy> {\r\n  static makePoints() {\r\n    const duration = 0.5;\r\n    return new FireAndForgetPoints<EventCellTransferEnergy>(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n        const size = 4 * (t - t * t);\r\n\r\n        const { from, to } = s.info;\r\n        const { x, y } = from.pos.clone().lerp(to.pos, map(t, 0, 1, 0.45, 0.55));\r\n        // const x = (from.pos.x + to.pos.x) / 2;\r\n        // const y = (from.pos.y + to.pos.y) / 2;\r\n        s.x = x;\r\n        s.y = y;\r\n        s.size = size;\r\n      },\r\n      {\r\n        color: new Color(\"yellow\"),\r\n        opacity: 0.8,\r\n        size: 350,\r\n        map: textureFromSpritesheet(2, 3, \"transparent\"),\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"cell-transfer-energy\", target, EventCellTransferEnergyRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventCellTransferEnergy) {\r\n    const { from, to } = event;\r\n    const r = Math.atan2(to.pos.y - from.pos.y, to.pos.x - from.pos.x);\r\n\r\n    this.ffPoints.fire({\r\n      x: event.from.pos.x,\r\n      y: event.from.pos.y,\r\n      r,\r\n      z: 1,\r\n      size: 0.1,\r\n      alpha: 1,\r\n      info: event,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","import { clamp } from \"math\";\r\n\r\nexport function mirrored(f: (t: number) => number) {\r\n  // https://bl.ocks.org/mbostock/3145795\r\n  return (t: number) => (t < 0.5 ? f(2 * t) : f(2 - 2 * t));\r\n}\r\n\r\nexport function reversed(f: (t: number) => number) {\r\n  return (t: number) => f(1 - t);\r\n}\r\n\r\n/**\r\n * t - t^2, scaled between 0-1\r\n * 0 = 0\r\n * 0.5 = 1\r\n * 1 = 0\r\n */\r\nexport function polyUpDown(t: number) {\r\n  return 4 * (t - t * t);\r\n}\r\n\r\nexport function smoothstep(t: number) {\r\n  t = clamp(t, 0, 1);\r\n  return t * t * (3 - 2 * t);\r\n}\r\n\r\n/**\r\n * (t^2-t^3) scaled to 0 and 1\r\n * 0 = 0\r\n * ...smooth upwards curve\r\n * 2/3 = 1\r\n * ...sharper downards curve\r\n * 1 = 0\r\n */\r\nexport function polyLateUpDown(t: number) {\r\n  return clamp((27 / 4) * (t * t - t * t * t), 0, 1);\r\n}\r\n\r\nexport const polyEarlyUpDown = reversed(polyLateUpDown);\r\n","import { EventCollectSunlight } from \"core/tile/tileEvent\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { clamp, randElement, randFloat } from \"math\";\r\nimport { polyEarlyUpDown } from \"math/easing\";\r\nimport { Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { InstancedTileRenderer } from \"../tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRenderer } from \"./eventRenderer\";\r\n\r\nexport default class EventCollectSunlightRenderer extends EventRenderer<EventCollectSunlight> {\r\n  // private lightRays: LightRays;\r\n  private ffPoints: FireAndForgetPoints;\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"collect-sunlight\", target);\r\n    // this.lightRays = new LightRays();\r\n    // this.scene.add(this.lightRays.lineSegments);\r\n    const duration = 0.5;\r\n    // t.magFilter = LinearFilter;\r\n    this.ffPoints = new FireAndForgetPoints(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = clamp(s.time / duration, 0, 1);\r\n        s.alpha = polyEarlyUpDown(t);\r\n        s.size = polyEarlyUpDown(t);\r\n      },\r\n      {\r\n        color: new Color(\"white\"),\r\n        opacity: 0.8,\r\n        size: 35,\r\n        map: textureFromSpritesheet(0, 4),\r\n      }\r\n    );\r\n    this.scene.add(this.ffPoints);\r\n  }\r\n\r\n  handle(event: EventCollectSunlight) {\r\n    let { numSunlight, leaf, point } = event;\r\n    while (numSunlight > 0) {\r\n      // if numSunlight is 0.5, only show half the sunlight events\r\n      if (numSunlight < 1 && numSunlight < Math.random()) {\r\n        return;\r\n      }\r\n\r\n      let x = point == null ? leaf.pos.x + (Math.random() - 0.5) * 0.05 : point.x + randFloat(-0.1, 0.1);\r\n      let y = point == null ? leaf.pos.y + (Math.random() - 0.5) * 0.05 : point.y + randFloat(-0.1, 0.1);\r\n      const itr = this.worldRenderer.renderers.get(leaf) as InstancedTileRenderer;\r\n      if (itr) {\r\n        const randWaterPosition = itr.inventoryRenderer ? randElement(itr.inventoryRenderer.waters) : undefined;\r\n        x += randWaterPosition?.x ?? 0;\r\n        y += randWaterPosition?.y ?? 0;\r\n      }\r\n      this.ffPoints.fire({\r\n        x,\r\n        y,\r\n        z: 10,\r\n        size: 0,\r\n        alpha: 0,\r\n        info: 0,\r\n        // stagger with the shouldUpdate of Tile so they look more continuous\r\n        // time: Math.random() * (1 / 10),\r\n        time: 0,\r\n      });\r\n      numSunlight--;\r\n    }\r\n  }\r\n\r\n  update() {\r\n    super.update();\r\n    this.ffPoints.update(1 / 30);\r\n    for (const event of this.target) {\r\n      this.handle(event);\r\n    }\r\n    // this.lightRays.update(1 / 30);\r\n    this.ffPoints.commitAll();\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.ffPoints);\r\n    // this.scene.remove(this.lightRays.lineSegments);\r\n  }\r\n}\r\n","import Ticker from \"std/ticker\";\r\nimport { Color, Scene, Vector2 } from \"three\";\r\nimport { Inventory } from \"../../core/inventory\";\r\nimport { map } from \"../../math\";\r\nimport { Mito } from \"../mito/mito\";\r\nimport { textureFromSpritesheet } from \"../spritesheet\";\r\nimport { CommittablePoints, CommittablePointsParameters } from \"./committablePoints\";\r\nimport { Renderer } from \"./Renderer\";\r\n\r\n// default\r\nconst graphics = {\r\n  particlesPerWater: 1,\r\n  particleSize: 45,\r\n  particleRepelStrength: 0.003,\r\n};\r\n\r\n// woooow\r\n// const graphics = {\r\n//   particlesPerWater: 10,\r\n//   particleSize: 25,\r\n//   particleRepelStrength: 0.0005,\r\n// };\r\n\r\nexport const WATER_POINTS_PARAMS: CommittablePointsParameters = {\r\n  color: new Color(\"rgb(9, 12, 255)\"),\r\n  size: graphics.particleSize,\r\n  opacity: 0.75,\r\n};\r\n\r\nexport const SUGAR_POINTS_PARAMS: CommittablePointsParameters = {\r\n  color: new Color(\"yellow\"),\r\n  size: 85,\r\n  opacity: 0.9,\r\n  map: textureFromSpritesheet(2, 2, \"transparent\"),\r\n};\r\n\r\nexport class InventoryPoints {\r\n  public waters = new CommittablePoints(10000, WATER_POINTS_PARAMS);\r\n\r\n  public sugars = new CommittablePoints(10000, SUGAR_POINTS_PARAMS);\r\n\r\n  public startFrame() {\r\n    this.waters.startFrame();\r\n    this.sugars.startFrame();\r\n  }\r\n\r\n  public endFrame() {\r\n    this.waters.endFrame();\r\n    this.sugars.endFrame();\r\n  }\r\n}\r\n\r\n// we represent Resources as dots of certain colors.\r\nexport class InventoryRenderer extends Renderer<Inventory> {\r\n  public animationOffset = 0;\r\n\r\n  public waters: Vector2[] = [];\r\n\r\n  public sugars: Vector2[] = [];\r\n\r\n  private activeSugar?: Vector2;\r\n\r\n  private stableWater?: Vector2;\r\n\r\n  constructor(target: Inventory, scene: Scene, mito: Mito, public particlePoints: InventoryPoints) {\r\n    super(target, scene, mito);\r\n    target.on(\"get\", this.handleGetResources);\r\n    target.on(\"give\", this.handleGiveResources);\r\n    target.on(\"add\", this.handleAddResources);\r\n\r\n    this.updateSugarAndWaterParticles();\r\n  }\r\n\r\n  private handleGetResources = (giver: Inventory) => {\r\n    this.updateSugarAndWaterParticles(giver);\r\n  };\r\n\r\n  private verifyArrayLengths() {\r\n    if (this.waters.length !== Math.ceil(this.target.water * graphics.particlesPerWater)) {\r\n      throw new Error(\r\n        \"water array lengths mismatch: \" + this.waters.length + \" should be \" + Math.ceil(this.target.water)\r\n      );\r\n    }\r\n    if (this.sugars.length !== Math.ceil(this.target.sugar)) {\r\n      throw new Error(\r\n        \"sugar array lengths mismatch: \" + this.sugars.length + \" should be \" + Math.ceil(this.target.sugar)\r\n      );\r\n    }\r\n  }\r\n\r\n  private handleGiveResources = () => {\r\n    this.updateSugarAndWaterParticles();\r\n  };\r\n\r\n  private handleAddResources = (water: number, sugar: number) => {\r\n    this.updateSugarAndWaterParticles();\r\n  };\r\n\r\n  private updateSugarAndWaterParticles(giver?: Inventory) {\r\n    this.updateParticlesArray(this.waters, this.target.water * graphics.particlesPerWater, giver);\r\n    this.updateParticlesArray(this.sugars, this.target.sugar, giver);\r\n    this.verifyArrayLengths();\r\n  }\r\n\r\n  private updateParticlesArray(particles: Vector2[], resource: number, giver?: Inventory) {\r\n    const wantedParticles = Math.ceil(resource);\r\n    while (particles.length < wantedParticles) {\r\n      // // see if we can find the giver's InventoryRenderer\r\n      // if (giver != null) {\r\n      //   const carrier = giver.carrier;\r\n      //   const carrierRenderer = this.mito.worldRenderer.getOrCreateRenderer(carrier as any);\r\n      //   if (carrierRenderer instanceof InstancedTileRenderer) {\r\n      //     const carrierInventoryRenderer = carrierRenderer.inventoryRenderer;\r\n      //     const\r\n      //   }\r\n      const v = giver != null ? giver.carrier.pos.clone().sub(this.target.carrier.pos) : newParticle();\r\n      v.x += (Math.random() - 0.5) * 0.1;\r\n      v.y += (Math.random() - 0.5) * 0.1;\r\n      particles.push(v);\r\n    }\r\n    if (particles.length > wantedParticles) {\r\n      // delete from the start - makes soil water feel\r\n      // more dynamic since every small movement shows an animation\r\n      // particles.splice(0, particles.length - wantedParticles);\r\n\r\n      // delete from the end:\r\n      // otherwise going from 2.1 -> 2 water looks broken\r\n      // (the size 0.1 water suddenly becomes the size 1 water)\r\n      // makes soil water feel much more static\r\n      particles.splice(wantedParticles);\r\n    }\r\n    if (particles.length !== wantedParticles) {\r\n      throw new Error(\"array lengths mismatch: \" + particles.length + \" should be \" + wantedParticles);\r\n    }\r\n    return particles;\r\n  }\r\n\r\n  private commitParticles(particles: CommittablePoints, resource: number, resourceArray: Vector2[]) {\r\n    // this.verifyArrayLengths();\r\n    const numFullSizedParticles = Math.floor(resource);\r\n    for (let i = 0; i < numFullSizedParticles; i++) {\r\n      const p = resourceArray[i];\r\n      particles.commit(p.x + this.target.carrier.pos.x, p.y + this.target.carrier.pos.y, 10, 1, 1);\r\n    }\r\n    const fract = resource - numFullSizedParticles;\r\n    if (fract > 0) {\r\n      const p = resourceArray[resourceArray.length - 1];\r\n      particles.commit(\r\n        p.x + this.target.carrier.pos.x,\r\n        p.y + this.target.carrier.pos.y,\r\n        10,\r\n        map(Math.sqrt(fract), 0, 1, 0.2, 1),\r\n        1\r\n      );\r\n    }\r\n  }\r\n\r\n  private simulateResourcePositions() {\r\n    const numWaters = this.waters.length;\r\n    const numResources = numWaters + this.sugars.length;\r\n    for (let i = 0; i < numResources; i++) {\r\n      const resource = i < numWaters ? this.waters[i] : this.sugars[i - numWaters];\r\n      let vx = 0,\r\n        vy = 0;\r\n\r\n      const angle = Ticker.now / 3000 + this.animationOffset;\r\n      vx += Math.cos(angle) * 0.02;\r\n\r\n      const goTowardsCenterStrength = 0.1 + resource.length() * 0.1;\r\n      vx += -resource.x * goTowardsCenterStrength;\r\n      vy += -resource.y * goTowardsCenterStrength;\r\n\r\n      // vx += -((r.x * 2) ** 1) * 0.2;\r\n      // vy += -((r.y * 2) ** 3) * 0.1;\r\n      const player = this.mito.world.player;\r\n      if (player.pos.equals(this.target.carrier.pos)) {\r\n        const playerX = player.posFloat.x - player.pos.x;\r\n        const playerY = player.posFloat.y - player.pos.y;\r\n        const offsetX = resource.x - playerX;\r\n        const offsetY = resource.y - playerY;\r\n        const mag2 = offsetX * offsetX + offsetY * offsetY;\r\n        const avoidPlayerStrength = Math.max(Math.min(map(mag2, 0, 1, 3, -5), 3), 0);\r\n        const accelerationX = offsetX * avoidPlayerStrength * 0.2;\r\n        const accelerationY = offsetY * avoidPlayerStrength * 0.2;\r\n        vx += accelerationX;\r\n        vy += accelerationY;\r\n      }\r\n      for (let j = 0; j < numResources; j++) {\r\n        const otherResource = j < numWaters ? this.waters[j] : this.sugars[j - numWaters];\r\n        if (resource === otherResource) {\r\n          break;\r\n        }\r\n        const dx = resource.x - otherResource.x;\r\n        const dy = resource.y - otherResource.y;\r\n        const lengthSq = dx * dx + dy * dy;\r\n        if (lengthSq > 0) {\r\n          // is the other resource a fractional resource\r\n          // true if j is at the last index of the waters, and there is a fractional water,\r\n          // or if j is at the last index of the sugars, and there is a fractional sugar\r\n          const fraction = j < numWaters ? this.target.water % 1 : this.target.sugar % 1;\r\n          const isAtLastResourceOfType = j === numWaters || j === numResources;\r\n          const isOtherResourceFractional = isAtLastResourceOfType && fraction !== 0;\r\n          let strength = graphics.particleRepelStrength / lengthSq; // + graphics.particleRepelStrength / Math.sqrt(lengthSq);\r\n          if (isOtherResourceFractional) {\r\n            strength *= fraction;\r\n          }\r\n          vx += dx * strength;\r\n          vy += dy * strength;\r\n        }\r\n      }\r\n      resource.x += vx;\r\n      resource.y += vy;\r\n      // r.x *= 0.9;\r\n    }\r\n  }\r\n\r\n  update() {\r\n    this.simulateResourcePositions();\r\n    this.commitParticles(this.particlePoints.waters, this.target.water * graphics.particlesPerWater, this.waters);\r\n    this.commitParticles(this.particlePoints.sugars, this.target.sugar, this.sugars);\r\n    this.activeSugar = this.sugars[this.sugars.length - 1];\r\n    this.stableWater = this.waters[0];\r\n  }\r\n\r\n  destroy() {\r\n    this.target.off(\"get\", this.handleGetResources);\r\n    this.target.off(\"give\", this.handleGiveResources);\r\n    this.target.off(\"add\", this.handleAddResources);\r\n  }\r\n\r\n  /**\r\n   * Stores the position of the fractional sugar in the last update.\r\n   * This is used by other renderers to position e.g. eat effects directly\r\n   * on the particle.\r\n   */\r\n  public getActiveSugar() {\r\n    return this.activeSugar;\r\n  }\r\n\r\n  /**\r\n   * See getActiveSugar(), but this returns the \"oldest\" water.\r\n   */\r\n  public getStableWater() {\r\n    return this.stableWater;\r\n  }\r\n}\r\n\r\nfunction newParticle() {\r\n  return new Vector2((Math.random() - 0.5) * 0.01, (Math.random() - 0.5) * 0.01);\r\n}\r\n","import { EventEvaporation } from \"core/tile/tileEvent\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { WATER_POINTS_PARAMS } from \"../InventoryRenderer\";\r\nimport { InstancedTileRenderer } from \"../tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventEvaporationRenderer extends EventRendererFFPoints<EventEvaporation> {\r\n  static makePoints() {\r\n    const duration = 1.5;\r\n    return new FireAndForgetPoints<EventEvaporation>(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n        const size = 1 + t;\r\n        const alpha = 1 - t;\r\n\r\n        s.x += Math.sin(t * 12) * 0.01;\r\n        s.y -= 0.01;\r\n        s.alpha = alpha;\r\n        s.size = size;\r\n      },\r\n      { ...WATER_POINTS_PARAMS }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"evaporation\", target, EventEvaporationRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventEvaporation) {\r\n    if (event.tile.darkness >= 1) {\r\n      return;\r\n    }\r\n    const tileRenderer = this.worldRenderer.renderers.get(event.tile) as InstancedTileRenderer | null;\r\n    const stableWater = tileRenderer?.inventoryRenderer?.getStableWater();\r\n    const dX = stableWater?.x ?? 0;\r\n    const dY = stableWater?.y ?? 0;\r\n    this.ffPoints.fire({\r\n      x: event.tile.pos.x + dX,\r\n      y: event.tile.pos.y + dY,\r\n      z: 1,\r\n      size: 1,\r\n      alpha: 1,\r\n      info: event,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","import { EventGrowFruit } from \"core/tile/tileEvent\";\r\nimport { easeCubicIn } from \"d3-ease\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { map } from \"math\";\r\nimport { polyUpDown, smoothstep } from \"math/easing\";\r\nimport { Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventGrowFruitRenderer extends EventRendererFFPoints<EventGrowFruit> {\r\n  static makePoints() {\r\n    const duration = 1.2;\r\n    // const duration = 25;\r\n    return new FireAndForgetPoints(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n\r\n        const { cell, a0 } = s.info;\r\n        const dist = map(easeCubicIn(t), 0, 1, 0.7, 0.2);\r\n        const angle = map(smoothstep(t), 0, 1, 0, Math.PI * 0.0) + a0;\r\n        const size = Math.sqrt(polyUpDown(t));\r\n        s.x = cell.pos.x + Math.cos(angle) * dist;\r\n        s.y = cell.pos.y + Math.sin(angle) * dist;\r\n        s.size = size;\r\n        s.r = angle;\r\n      },\r\n      {\r\n        size: 80,\r\n        opacity: 1,\r\n        color: new Color(\"white\"),\r\n        map: textureFromSpritesheet(0, 5),\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"grow-fruit\", target, EventGrowFruitRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventGrowFruit) {\r\n    const { cell } = event;\r\n\r\n    this.ffPoints.fire({\r\n      x: cell.pos.x,\r\n      y: cell.pos.y,\r\n      z: 1,\r\n      alpha: 1,\r\n      info: { ...event, a0: Math.random() * Math.PI * 2 },\r\n      size: 0,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","import { EventPhotosynthesis } from \"core/tile/tileEvent\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { polyUpDown } from \"math/easing\";\r\nimport { Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { InstancedTileRenderer } from \"../tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventPhotosynthesisRenderer extends EventRendererFFPoints<EventPhotosynthesis> {\r\n  static makePoints() {\r\n    const duration = 0.5;\r\n    return new FireAndForgetPoints<EventPhotosynthesis>(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n\r\n        s.alpha = polyUpDown(t) ** (1 / 4);\r\n        s.size = ((1 - t) ** 1 / 2) * 2 * s.info.sugarMade;\r\n        s.r = t * s.time;\r\n      },\r\n      {\r\n        color: new Color(\"yellow\"),\r\n        opacity: 0.95,\r\n        size: 200,\r\n        map: textureFromSpritesheet(3, 3),\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"photosynthesis\", target, EventPhotosynthesisRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventPhotosynthesis) {\r\n    const tileRenderer = this.worldRenderer.renderers.get(event.cell) as InstancedTileRenderer | null;\r\n    const stableWater = tileRenderer?.inventoryRenderer?.getStableWater();\r\n    const dX = stableWater?.x ?? 0;\r\n    const dY = stableWater?.y ?? 0;\r\n    this.ffPoints.fire({\r\n      x: event.cell.pos.x + dX,\r\n      y: event.cell.pos.y + dY,\r\n      z: 1,\r\n      size: 1,\r\n      alpha: 1,\r\n      info: event,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","import { CancerEffect } from \"core/cell/cellEffect\";\r\nimport { clamp, lerp, randFloat } from \"math\";\r\nimport { Color, DoubleSide, Mesh, MeshBasicMaterial, PlaneBufferGeometry, RingBufferGeometry, Scene } from \"three\";\r\nimport { Cell, CellEffect, FreezeEffect } from \"../../../core/tile\";\r\nimport Mito from \"../../mito/mito\";\r\nimport { textureFromSpritesheet } from \"../../spritesheet\";\r\nimport { Renderer } from \"../Renderer\";\r\n\r\nexport class CellEffectsRenderer extends Renderer<Cell> {\r\n  private renderers: Renderer<CellEffect>[] = [];\r\n\r\n  update() {\r\n    // account for if target has more effects\r\n    let index;\r\n    for (index = 0; index < this.target.effects.length; index++) {\r\n      const effect = this.target.effects[index];\r\n      const renderer = this.renderers[index];\r\n      if (renderer == null) {\r\n        this.renderers[index] = createEffectRenderer(effect, this.scene, this.mito);\r\n      } else if (effect !== renderer.target) {\r\n        // delete and add new renderer\r\n        renderer.destroy();\r\n        this.renderers[index] = createEffectRenderer(effect, this.scene, this.mito);\r\n      }\r\n    }\r\n    // delete extraneous effects\r\n    for (; index < this.renderers.length; index++) {\r\n      const renderer = this.renderers[index];\r\n      renderer.destroy();\r\n    }\r\n\r\n    for (const r of this.renderers) {\r\n      r.update();\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const r of this.renderers) {\r\n      r.destroy();\r\n    }\r\n  }\r\n}\r\n\r\nfunction createEffectRenderer<T extends CellEffect>(effect: T, scene: Scene, mito: Mito): Renderer<CellEffect> {\r\n  if (effect instanceof FreezeEffect) {\r\n    return new FreezeEffectRenderer(effect, scene, mito);\r\n  } else if (effect instanceof CancerEffect) {\r\n    return new CancerEffectRenderer(effect, scene, mito);\r\n  } else {\r\n    throw new Error(\"effect renderer not defined for\" + effect);\r\n  }\r\n}\r\n\r\n// export const FREEZE_BLUE = new Color(\"#1E90FF\").lerp(new Color(0), 0.5);\r\nexport const FREEZE_BLUE = new Color(\"lightblue\");\r\n\r\nclass FreezeEffectRenderer extends Renderer<FreezeEffect> {\r\n  static newMesh = (() => {\r\n    const g = new PlaneBufferGeometry(1, 1);\r\n    const material = new MeshBasicMaterial({\r\n      map: textureFromSpritesheet(1, 2),\r\n      side: DoubleSide,\r\n      color: FREEZE_BLUE,\r\n      transparent: true,\r\n      opacity: 0.5,\r\n    });\r\n    const mesh = new Mesh(g, material);\r\n    return () => mesh.clone();\r\n  })();\r\n\r\n  private mesh: Mesh;\r\n\r\n  constructor(target: FreezeEffect, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    this.mesh = FreezeEffectRenderer.newMesh();\r\n    scene.add(this.mesh);\r\n    this.mesh.scale.set(0.01, 0.01, 1);\r\n  }\r\n\r\n  update() {\r\n    const percentFrozen = this.target.percentFrozen;\r\n    const s = percentFrozen ** 0.5;\r\n    this.mesh.scale.x = lerp(this.mesh.scale.x, s, 0.2);\r\n    this.mesh.scale.y = lerp(this.mesh.scale.y, s, 0.2);\r\n    const cell = this.target.cell;\r\n    const pos = cell.pos;\r\n    this.mesh.position.set(pos.x, pos.y + cell.droopY, 2);\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.mesh);\r\n  }\r\n}\r\n\r\nclass CancerEffectRenderer extends Renderer<CancerEffect> {\r\n  static newMesh = (() => {\r\n    // const g = new PlaneBufferGeometry(1, 1);\r\n    const g = new RingBufferGeometry(0.1, 0.5, 20, 20);\r\n    const material = new MeshBasicMaterial({\r\n      map: textureFromSpritesheet(0, 1),\r\n      side: DoubleSide,\r\n      color: new Color(0xbe29ec),\r\n    });\r\n    const mesh = new Mesh(g, material);\r\n    mesh.position.z = 3;\r\n    return () => mesh.clone();\r\n  })();\r\n\r\n  private mesh: Mesh;\r\n\r\n  private lastTimeToDuplicate: number;\r\n\r\n  constructor(target: CancerEffect, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    this.mesh = CancerEffectRenderer.newMesh();\r\n    scene.add(this.mesh);\r\n    this.mesh.scale.set(0.01, 0.01, 1);\r\n    this.lastTimeToDuplicate = this.target.timeToDuplicate;\r\n  }\r\n\r\n  update() {\r\n    const { timeToDuplicate, secondsPerDuplication } = this.target;\r\n    const s = clamp((1 - timeToDuplicate / secondsPerDuplication) ** 0.5, 0.05, 1);\r\n    this.mesh.scale.x = lerp(this.mesh.scale.x, s, 0.2);\r\n    this.mesh.scale.y = lerp(this.mesh.scale.y, s, 0.2);\r\n    const cell = this.target.cell;\r\n    let pos = cell.pos;\r\n    const isBeingTreated = timeToDuplicate > this.lastTimeToDuplicate;\r\n    if (isBeingTreated) {\r\n      pos = pos.clone();\r\n      pos.x += randFloat(-0.1, 0.1);\r\n      pos.y += randFloat(-0.1, 0.1);\r\n    }\r\n    this.mesh.position.set(pos.x, pos.y + cell.droopY, 2);\r\n    this.lastTimeToDuplicate = timeToDuplicate;\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.mesh);\r\n  }\r\n}\r\n","import { EventThawIce } from \"core/tile/tileEvent\";\r\nimport { easeSinOut } from \"d3-ease\";\r\nimport { map } from \"math\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { FREEZE_BLUE } from \"../tile/CellEffectsRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventThawIceRenderer extends EventRendererFFPoints<EventThawIce> {\r\n  static makePoints() {\r\n    const duration = 0.6;\r\n    return new FireAndForgetPoints(\r\n      (s, dt) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n        const { dx, dy } = s.info;\r\n        s.x += dx * dt;\r\n        s.y += dy * dt;\r\n        s.alpha = t < 0.75 ? 1 : easeSinOut(map(t, 0.75, 1, 1, 0));\r\n      },\r\n      {\r\n        size: 40,\r\n        opacity: 0.5,\r\n        color: FREEZE_BLUE,\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"thaw\", target, EventThawIceRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventThawIce) {\r\n    const { where } = event;\r\n\r\n    for (let i = 0; i < 4; i++) {\r\n      const angle = Math.random() * Math.PI * 2;\r\n      const speed = 1;\r\n      const dx = Math.cos(angle) * speed;\r\n      const dy = Math.sin(angle) * speed;\r\n      this.ffPoints.fire({\r\n        x: where.pos.x,\r\n        y: where.pos.y,\r\n        z: 1,\r\n        alpha: 1,\r\n        info: { dx, dy },\r\n        size: map(Math.random(), 0, 1, 0.5, 1.5),\r\n        time: 0,\r\n        r: angle,\r\n      });\r\n    }\r\n  }\r\n}\r\n","import { TileEvent, TileEventType } from \"../../../core/tile/tileEvent\";\r\nimport { Renderer } from \"../Renderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport EventCellEatRenderer from \"./eventCellEatRenderer\";\r\nimport EventCellTransferEnergyRenderer from \"./eventCellTransferEnergyRenderer\";\r\nimport EventCollectSunlightRenderer from \"./eventCollectSunlightRenderer\";\r\nimport EventEvaporationRenderer from \"./eventEvaporationRenderer\";\r\nimport EventGrowFruitRenderer from \"./eventGrowFruitRenderer\";\r\nimport EventPhotosynthesisRenderer from \"./eventPhotosynthesisRenderer\";\r\nimport { EventRenderer } from \"./eventRenderer\";\r\nimport EventThawIceRenderer from \"./eventThawIceRenderer\";\r\n\r\nexport class EventLogRenderer extends Renderer<WorldRenderer> {\r\n  private singleEventRenderers = {\r\n    \"cell-eat\": new EventCellEatRenderer(this.target),\r\n    \"cell-transfer-energy\": new EventCellTransferEnergyRenderer(this.target),\r\n    evaporation: new EventEvaporationRenderer(this.target),\r\n    photosynthesis: new EventPhotosynthesisRenderer(this.target),\r\n    thaw: new EventThawIceRenderer(this.target),\r\n    \"collect-sunlight\": new EventCollectSunlightRenderer(this.target),\r\n    \"grow-fruit\": new EventGrowFruitRenderer(this.target),\r\n  } as { [K in TileEventType]?: EventRenderer<Extract<TileEvent, { type: K }>> };\r\n\r\n  constructor(worldRenderer: WorldRenderer) {\r\n    super(worldRenderer, worldRenderer.scene, worldRenderer.mito);\r\n  }\r\n\r\n  update() {\r\n    const events = this.target.target.getLastStepStats().events;\r\n    let eventName: TileEventType;\r\n    for (eventName in events) {\r\n      const renderer = this.singleEventRenderers[eventName];\r\n      if (renderer != null) {\r\n        renderer.update();\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const renderer of Object.values(this.singleEventRenderers)) {\r\n      if (renderer != null) {\r\n        renderer.destroy();\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { params } from \"game/params\";\r\n\r\n// when you press one, the other one gets removed from the keyMap\r\nconst OPPOSITE_KEYS: Record<string, string> = {\r\n  KeyS: \"KeyW\",\r\n  KeyW: \"KeyS\",\r\n  KeyA: \"KeyD\",\r\n  KeyD: \"KeyA\",\r\n};\r\n\r\n/**\r\n * Singleton that listens to key events on window.\r\n */\r\nexport const Keyboard = new (class Keyboard {\r\n  readonly keyMap = new Set<string>();\r\n\r\n  constructor() {\r\n    window.addEventListener(\"blur\", this.handleBlur);\r\n    window.addEventListener(\"keydown\", this.handleKeyDown);\r\n    window.addEventListener(\"keyup\", this.handleKeyUp);\r\n  }\r\n\r\n  private handleBlur = () => {\r\n    this.keyMap.clear();\r\n  };\r\n\r\n  private handleKeyDown = (event: KeyboardEvent) => {\r\n    const code = event.code;\r\n    this.keyMap.add(code);\r\n    if (event.code in OPPOSITE_KEYS) {\r\n      this.keyMap.delete(OPPOSITE_KEYS[code]);\r\n    }\r\n    if (code === \"KeyH\") {\r\n      params.hud = !params.hud;\r\n    }\r\n    if (code === \"Period\") {\r\n      params.showFPS = !params.showFPS;\r\n    }\r\n    if (code === \"Slash\") {\r\n      params.showGodUI = !params.showGodUI;\r\n    }\r\n    const isOpeningDevtoolsOnChrome =\r\n      (code === \"KeyI\" && event.shiftKey && event.ctrlKey) || (code === \"KeyI\" && event.altKey && event.metaKey);\r\n    if (!isOpeningDevtoolsOnChrome) {\r\n      event.preventDefault();\r\n      return false;\r\n    }\r\n  };\r\n\r\n  private handleKeyUp = (event: KeyboardEvent) => {\r\n    this.keyMap.delete(event.code);\r\n  };\r\n})();\r\n\r\nexport default Keyboard;\r\n","import { CancerEffect } from \"core/cell\";\r\nimport { FreezeEffect, Tile } from \"core/tile\";\r\nimport { Vector2 } from \"three\";\r\nimport { CellArgs } from \"../cell/cell\";\r\nimport { CellType } from \"../cell/genome\";\r\n\r\nexport interface ActionMove {\r\n  type: \"move\";\r\n  dir: Vector2;\r\n}\r\n\r\nexport interface ActionBuild {\r\n  type: \"build\";\r\n  cellType: CellType;\r\n  args?: CellArgs;\r\n  position: Vector2;\r\n}\r\n\r\nexport interface ActionDeconstruct {\r\n  type: \"deconstruct\";\r\n  position: Vector2;\r\n  force?: boolean;\r\n}\r\n\r\n/**\r\n * Instantaneously drop some amount of water and sugar.\r\n */\r\nexport interface ActionDrop {\r\n  type: \"drop\";\r\n  water: number;\r\n  sugar: number;\r\n  target: Tile;\r\n  continuous?: boolean;\r\n}\r\n\r\nexport interface ActionPickup {\r\n  type: \"pickup\";\r\n\r\n  /**\r\n   * Rate of sugar pickup per second.\r\n   */\r\n  water: number;\r\n\r\n  /**\r\n   * Rate of sugar pickup per second.\r\n   */\r\n  sugar: number;\r\n\r\n  target: Tile;\r\n  continuous?: boolean;\r\n}\r\n\r\nexport interface ActionMultiple {\r\n  type: \"multiple\";\r\n  actions: Action[];\r\n}\r\n\r\nexport interface ActionLong<T extends Action = Action> {\r\n  type: \"long\";\r\n  elapsed: number;\r\n  duration: number;\r\n  effect: T;\r\n}\r\n\r\nexport interface ActionThaw {\r\n  type: \"thaw\";\r\n  target: FreezeEffect;\r\n}\r\n\r\nexport interface ActionRemoveCancer {\r\n  type: \"remove-cancer\";\r\n  target: CancerEffect;\r\n}\r\n\r\nexport type Action =\r\n  | ActionMove\r\n  | ActionBuild\r\n  | ActionDeconstruct\r\n  | ActionDrop\r\n  | ActionLong<any>\r\n  | ActionMultiple\r\n  | ActionPickup\r\n  | ActionThaw\r\n  | ActionRemoveCancer;\r\n\r\n/**\r\n * A continuous action should be re-set every frame while holding the mouse button.\r\n */\r\nexport function isContinuous(action: Action) {\r\n  if (action.type === \"pickup\" || action.type === \"drop\") {\r\n    return !!action.continuous;\r\n  } else if (action.type === \"remove-cancer\" || action.type === \"thaw\") {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n","import { lerp, lerp2 } from \"math\";\r\nimport { arrayRange } from \"math/arrays\";\r\nimport {\r\n  CircleBufferGeometry,\r\n  DoubleSide,\r\n  Geometry,\r\n  Line,\r\n  LineBasicMaterial,\r\n  Mesh,\r\n  MeshBasicMaterial,\r\n  Object3D,\r\n  Vector2,\r\n} from \"three\";\r\n\r\nexport const playerBrown = 0x8f673f;\r\nexport const playerTeal = 0x5eb780;\r\n\r\nconst baseMesh = (() => {\r\n  const geometry = new CircleBufferGeometry(0.07, 20);\r\n  const material = new MeshBasicMaterial({\r\n    color: playerTeal,\r\n    // color: ,\r\n    side: DoubleSide,\r\n  });\r\n  const mesh = new Mesh(geometry, material);\r\n  return mesh;\r\n})();\r\n\r\nclass Node {\r\n  constructor(public pos: Vector2, public vel: Vector2 = new Vector2(0, 0), public scale = 1) {}\r\n}\r\n/**\r\n * For now: A thick line that branches out into 3 nodes.\r\n *\r\n * Should have a physics-y feel to it (maybe bones?)\r\n * Be UV-able\r\n */\r\nclass NeuronMesh extends Object3D {\r\n  // const geom = new LineGeometry();\r\n  // geom.setPositions([0, 0, 0, 1, 0, 0]);\r\n  // geom.setColors([1, 1, 1, 1, 0, 0]);\r\n  // const mat = new LineMaterial({\r\n  //   color: 0xffffff,\r\n  //   linewidth: 5,\r\n  //   vertexColors: VertexColors,\r\n  //   dashed: false,\r\n  // });\r\n  // mat.resolution.set(window.innerWidth, window.innerHeight);\r\n\r\n  // const line = new Line2(geom, mat);\r\n  // line.computeLineDistances();\r\n  // line.scale.set(1, 1, 1);\r\n  // return line;\r\n\r\n  public nodes: Node[] = [];\r\n\r\n  public meshes: Mesh[] = [];\r\n\r\n  public line: Line;\r\n\r\n  constructor(numNodes: number) {\r\n    super();\r\n    this.nodes = arrayRange(numNodes).map((i) => {\r\n      return new Node(new Vector2(i / numNodes, 0));\r\n    });\r\n    this.meshes = this.nodes.map((n) => {\r\n      const m = baseMesh.clone();\r\n      m.position.set(n.pos.x, n.pos.y, m.position.z);\r\n      return m;\r\n    });\r\n    this.add(...this.meshes);\r\n    const lineGeo = new Geometry();\r\n    lineGeo.vertices.push(...this.meshes.map((m) => m.position));\r\n    this.line = new Line(\r\n      lineGeo,\r\n      new LineBasicMaterial({\r\n        color: playerTeal,\r\n      })\r\n    );\r\n    this.add(this.line);\r\n    // const r1 = new Mesh(\r\n    //   new PlaneBufferGeometry(0.7, 0.1).translate(0.35, 0, 0),\r\n    //   new MeshBasicMaterial({ side: DoubleSide, color: 0x8f673f })\r\n    // );\r\n    // const branchLeft = new Mesh(\r\n    //   new PlaneBufferGeometry(0.3, 0.05).translate(0.15, 0, 0),\r\n    //   new MeshBasicMaterial({ side: DoubleSide, color: 0x5eb780 })\r\n    // );\r\n    // branchLeft.position.set(0.35, 0, 0);\r\n    // const branchCenter = branchLeft.clone();\r\n    // const branchRight = branchLeft.clone();\r\n    // branchLeft.rotation.z = -Math.PI / 3;\r\n    // branchRight.rotation.z = Math.PI / 3;\r\n\r\n    // r1.add(branchLeft, branchCenter, branchRight);\r\n    // this.add(r1);\r\n\r\n    // const gui = new GUI();\r\n    // gui.add(this, \"pullForceScalar\", 0, 100);\r\n    // gui.add(this, \"towardsTargetForce\", 0, 100);\r\n    // gui.add(this, \"dragForceScalar\", -100, -0);\r\n  }\r\n\r\n  public handleInteracted() {\r\n    const last = this.nodes[this.nodes.length - 1];\r\n    last.scale = 2.1;\r\n  }\r\n\r\n  private pullForceScalar = 10;\r\n\r\n  private towardsTargetForce = 5;\r\n\r\n  private dragForceScalar = -3;\r\n\r\n  update(dt: number, target: Vector2) {\r\n    // node 0 is always tied to 0, 0\r\n    // node n is tied directly at target\r\n    // intermediate nodes move towards their targets\r\n    // const first = this.nodes[0];\r\n    const last = this.nodes[this.nodes.length - 1];\r\n    lerp2(last.pos, target, 0.5);\r\n    let force = new Vector2();\r\n    for (let i = 1; i < this.nodes.length - 1; i++) {\r\n      force.set(0, 0);\r\n\r\n      const node = this.nodes[i];\r\n      const prev = this.nodes[i - 1];\r\n      const next = this.nodes[i + 1];\r\n\r\n      // prev force\r\n      force.add(this.pullForce(node, prev, this.pullForceScalar));\r\n      force.add(this.pullForce(node, next, this.pullForceScalar));\r\n      force.add(this.goTowardsTargetForce(node, target, i / (this.nodes.length - 1), this.towardsTargetForce));\r\n      force.add(this.dragForce(node, this.dragForceScalar));\r\n\r\n      node.scale = lerp(node.scale, next.scale, 0.5);\r\n\r\n      node.vel.add(force.multiplyScalar(dt));\r\n    }\r\n\r\n    this.nodes.forEach((node, i) => {\r\n      node.pos.x += node.vel.x * dt;\r\n      node.pos.y += node.vel.y * dt;\r\n      const mesh = this.meshes[i];\r\n      mesh.position.set(node.pos.x, node.pos.y, mesh.position.z);\r\n      mesh.scale.set(node.scale, node.scale, 1);\r\n    });\r\n    last.scale = lerp(last.scale, 1, 0.5);\r\n    (this.line.geometry as Geometry).verticesNeedUpdate = true;\r\n  }\r\n\r\n  goTowardsTargetForce = (() => {\r\n    const offset = new Vector2();\r\n    return (node: Node, target: Vector2, percent: number, pow: number) => {\r\n      offset\r\n        .copy(target)\r\n        .multiplyScalar(percent)\r\n        .sub(node.pos);\r\n      return offset.multiplyScalar(pow);\r\n    };\r\n  })();\r\n\r\n  dragForce = (() => {\r\n    const drag = new Vector2();\r\n    return (node: Node, pow: number) => {\r\n      drag.copy(node.vel).multiplyScalar(pow);\r\n      return drag;\r\n    };\r\n  })();\r\n\r\n  private pullForce = (() => {\r\n    const offset = new Vector2();\r\n    return (node: Node, other: Node, pow: number) => {\r\n      offset.copy(node.pos).sub(other.pos);\r\n      return offset.multiplyScalar(-pow);\r\n    };\r\n  })();\r\n}\r\n\r\nexport default NeuronMesh;\r\n","import Ticker from \"std/ticker\";\r\n\r\nexport type Animation = (t: number, dt: number) => boolean;\r\n\r\nexport class AnimationController {\r\n  public animation?: Animation;\r\n\r\n  timeStarted?: number;\r\n\r\n  timeLastUpdated?: number;\r\n\r\n  set(a: Animation) {\r\n    this.animation = a;\r\n    this.timeLastUpdated = this.timeStarted = Ticker.now / 1000;\r\n  }\r\n\r\n  update() {\r\n    if (this.animation != null && this.timeStarted != null && this.timeLastUpdated != null) {\r\n      const now = Ticker.now / 1000;\r\n      const t = now - this.timeStarted;\r\n      const dt = now - this.timeLastUpdated;\r\n      const ended = this.animation(t, dt);\r\n      this.timeLastUpdated = now;\r\n      if (ended) {\r\n        this.animation = undefined;\r\n        this.timeStarted = undefined;\r\n        this.timeLastUpdated = undefined;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Sequence animations after each other.\r\n */\r\nexport function chain(...animations: Animation[]): Animation {\r\n  let numEnded = 0;\r\n  let lastStarted = 0;\r\n  return (t, dt) => {\r\n    const currAnimation = animations[numEnded];\r\n    const ended = currAnimation(t - lastStarted, dt);\r\n    if (ended) {\r\n      numEnded++;\r\n      lastStarted = t;\r\n    }\r\n    return numEnded >= animations.length;\r\n  };\r\n}\r\n\r\n/**\r\n * Do both animations at once; end when first one ends.\r\n */\r\nexport function also(firstAnim: Animation, secondAnim: Animation): Animation {\r\n  let secondEnded = false;\r\n  return (t, dt) => {\r\n    const firstEnded = firstAnim(t, dt);\r\n    if (!secondEnded) {\r\n      secondEnded = secondAnim(t, dt);\r\n    }\r\n\r\n    return firstEnded;\r\n  };\r\n}\r\n\r\nexport function animPause(time: number): Animation {\r\n  return (t) => {\r\n    return t > time;\r\n  };\r\n}\r\n","import { sleep } from \"common/promise\";\r\nimport { EventOof } from \"core/tile/tileEvent\";\r\nimport { easeSinInOut } from \"d3-ease\";\r\nimport Keyboard from \"game/input/keyboard\";\r\nimport { Color, DoubleSide, Mesh, MeshBasicMaterial, PlaneBufferGeometry, Scene, Vector2 } from \"three\";\r\nimport { Player } from \"../../core\";\r\nimport { Action, ActionBuild, ActionLong, isContinuous } from \"../../core/player/action\";\r\nimport { Tile } from \"../../core/tile\";\r\nimport { clamp, lerp2, map, randFloat } from \"../../math\";\r\nimport { build, deconstruct, dropSugar, dropWater, footsteps, interactSound, moveBumped, sticky } from \"../audio\";\r\nimport { Mito } from \"../mito/mito\";\r\nimport { textureFromSpritesheet } from \"../spritesheet\";\r\nimport NeuronMesh from \"./neuronMesh\";\r\nimport { Renderer } from \"./Renderer\";\r\nimport { also, Animation, AnimationController, animPause, chain } from \"./tile/Animation\";\r\n\r\nexport class PlayerRenderer extends Renderer<Player> {\r\n  public mesh: Mesh;\r\n\r\n  public neuronMesh = new NeuronMesh(8);\r\n\r\n  protected animation = new AnimationController();\r\n\r\n  constructor(target: Player, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    this.mesh = newMesh();\r\n    this.mesh.name = \"Player Mesh\";\r\n    lerp2(this.mesh.position, this.target.pos, 1);\r\n    this.mesh.position.z = 2;\r\n    this.mesh.add(this.neuronMesh);\r\n\r\n    // wait a bit so the player doesn't pop out behind the seed\r\n    sleep(300).then(() => {\r\n      this.scene.add(this.mesh);\r\n    });\r\n\r\n    // TODO unregister these!\r\n    this.target.on(\"start-long-action\", this.handleStartLongAction);\r\n    this.target.on(\"action\", this.handleAction);\r\n    this.target.on(\"action-fail\", this.handlePlayerActionFail);\r\n  }\r\n\r\n  handleStartLongAction = (action: ActionLong) => {\r\n    if (action.effect.type === \"build\") {\r\n      this.animation.set(this.buildReproducerAnimation(action as ActionLong<ActionBuild>));\r\n    }\r\n  };\r\n\r\n  handleAction = (action: Action) => {\r\n    if (action.type === \"pickup\") {\r\n      this.neuronMesh.handleInteracted();\r\n      interactSound.fade(0.5, 0.0, 200);\r\n      interactSound.rate(randFloat(0.8, 1.5));\r\n    } else if (action.type === \"drop\") {\r\n      if (action.sugar > 0) {\r\n        dropSugar.play();\r\n        dropSugar.rate(randFloat(0.8, 1.2));\r\n      }\r\n      if (action.water > 0) {\r\n        if (!dropWater.playing()) {\r\n          const id = dropWater.play();\r\n          dropWater.fade(0.2, 0, 400, id);\r\n          dropWater.rate(randFloat(0.8, 1.5));\r\n        }\r\n      }\r\n    } else if (action.type === \"build\") {\r\n      const id = build.play();\r\n      build.rate(randFloat(0.5, 1.0), id);\r\n    } else if (action.type === \"deconstruct\") {\r\n      const id = deconstruct.play();\r\n      deconstruct.rate(randFloat(0.9, 1.1), id);\r\n    } else if (action.type === \"move\") {\r\n      footsteps.fade(0.1, 0, 50);\r\n      footsteps.rate(randFloat(0.8, 1.5));\r\n    }\r\n  };\r\n\r\n  handlePlayerActionFail = (action: Action, message?: string) => {\r\n    if (action.type === \"move\") {\r\n      if (!moveBumped.playing()) {\r\n        moveBumped.play();\r\n        moveBumped.rate(randFloat(0.8, 1.2));\r\n      }\r\n    }\r\n    if (message == null) {\r\n      if (action.type === \"pickup\" && this.target.inventory.isMaxed()) {\r\n        message = \"Inventory full!\";\r\n      }\r\n      // else if (action.type === \"drop\" && action.target && action.target.inventory.isMaxed()) {\r\n      //   message = `${action.target.displayName} inventory full!`;\r\n      // }\r\n    }\r\n\r\n    if (message != null) {\r\n      if (isContinuous(action)) {\r\n        // only show an error if it's not the exact same error that already exists\r\n        if (this.mito.invalidAction?.message !== message) {\r\n          this.mito.showInvalidAction({ message });\r\n        }\r\n      } else {\r\n        this.mito.showInvalidAction({ message });\r\n      }\r\n    }\r\n  };\r\n\r\n  private prevHighlightedTile?: Tile;\r\n\r\n  update() {\r\n    const pos = this.target.droopPosFloat().clone();\r\n\r\n    const oof = this.target.world.getLastStepStats().events.oof[0] as EventOof;\r\n    if (oof) {\r\n      this.mito.addFloatingText(pos, \"oof\");\r\n    }\r\n\r\n    this.mesh.position.set(pos.x, pos.y, 2);\r\n\r\n    const dt = 1 / 60;\r\n    const isUsingShift = Keyboard.keyMap.has(\"ShiftLeft\");\r\n    const isInteract = (this.mito.controls?.wouldLeftClickInteract() ?? false) && !isUsingShift;\r\n    const highlight = this.mito.highlightedTile;\r\n    const neuronMeshTarget = isInteract ? highlight!.pos.clone().sub(pos) : ZERO;\r\n    if (this.prevHighlightedTile !== highlight) {\r\n      const id = sticky.play();\r\n      sticky.rate(randFloat(0.9, 1.1), id);\r\n      sticky.volume(randFloat(0.8, 1), id);\r\n    }\r\n    this.neuronMesh.update(isInteract ? dt * 10 : dt * 5, neuronMeshTarget);\r\n    this.prevHighlightedTile = highlight;\r\n    // this.neuronMesh.visible = this.mito.getHighlightedTile() instanceof Cell;\r\n\r\n    // pos.x += Math.cos(Ticker.now / 1000) * 0.04;\r\n    // pos.y += Math.sin(Ticker.now / 400) * 0.08;\r\n    // lerp2(this.mesh.position, pos, 0.5);\r\n\r\n    this.animation.update();\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.mesh);\r\n  }\r\n\r\n  buildReproducerAnimation(actionLong: ActionLong<ActionBuild>): Animation {\r\n    const animWaitForCameraZoomIn = animPause(0.5);\r\n    let w = 0;\r\n    const animShakeDuration = 1.5;\r\n    const animShake: Animation = (t, dt) => {\r\n      const tNorm = t / animShakeDuration;\r\n      // const pow = clamp(polyBiasUpDown(tNorm), 0, 1);\r\n      const pow = clamp(tNorm, 0, 1);\r\n      const shakeFrequency = 9 * Math.sqrt(pow);\r\n      const shakeAmplitude = 0.15 * pow ** 1.5;\r\n      w += dt * Math.PI * 2 * shakeFrequency;\r\n      this.mesh.position.x += Math.sin(w) * shakeAmplitude;\r\n      return tNorm > 1;\r\n    };\r\n    const animPulse: Animation = (t) => {\r\n      const tNorm = t / 0.25;\r\n      const s = map(clamp(4 * (tNorm - tNorm * tNorm), 0, 1), 0, 1, 1, 1.5);\r\n      this.mesh.scale.set(s, s, 1);\r\n      return t > tNorm;\r\n    };\r\n    const animSendCopy = this.animSendCopy(actionLong.effect.position);\r\n    const animWaitEnd = animPause(0.5);\r\n\r\n    const focusCamera: Animation = () => {\r\n      this.mito.suggestCamera({\r\n        center: this.target.posFloat,\r\n        zoom: 3,\r\n      });\r\n      return false;\r\n    };\r\n\r\n    return also(chain(animWaitForCameraZoomIn, animShake, also(animSendCopy, animPulse), animWaitEnd), focusCamera);\r\n  }\r\n\r\n  animSendCopy(target: Vector2): Animation {\r\n    const copy = newMesh();\r\n    copy.scale.x = this.mesh.scale.x * 1;\r\n    copy.scale.y = this.mesh.scale.y * 1;\r\n    copy.position.z = this.mesh.position.z - 0.01;\r\n    this.scene.add(copy);\r\n    const animDuplicate: Animation = (t) => {\r\n      const tNorm = t / 0.5;\r\n      const dX = easeSinInOut(tNorm) * 0.5;\r\n      this.mesh.position.x -= dX;\r\n      lerp2(copy.position, this.target.droopPosFloat(), 1);\r\n      copy.position.x += dX;\r\n      return tNorm > 1;\r\n    };\r\n    const animStayLeft: Animation = (t) => {\r\n      this.mesh.position.x -= 0.5;\r\n      return false;\r\n    };\r\n    const animReturnOriginal: Animation = (t) => {\r\n      const tNorm = t / 0.5;\r\n      const dX = easeSinInOut(1 - tNorm) * 0.5;\r\n      this.mesh.position.x -= dX;\r\n      return tNorm > 1;\r\n    };\r\n    const animShrinkAndMove: Animation = (t, dt) => {\r\n      const tNorm = t / 1.2;\r\n      // lerp2(copy.position, this.mesh.position, 1);\r\n      lerp2(copy.position, target, 0.1);\r\n      // lerp2(copy.position, target, easeExpOut(tNorm));\r\n      // lerp2(copy.scale, { x: this.mesh.scale.x, y: this.mesh.scale.y }, 1);\r\n      // lerp2(copy.scale, { x: this.mesh.scale.x * 0.2, y: this.mesh.scale.y * 0.2 }, easeSinInOut(tNorm));\r\n      lerp2(copy.scale, { x: this.mesh.scale.x * 0.2, y: this.mesh.scale.y * 0.2 }, 0.1);\r\n      return tNorm > 1;\r\n    };\r\n    const animShrinkToZeroAndRemove: Animation = (t) => {\r\n      const tNorm = t / 0.5;\r\n      lerp2(copy.scale, { x: this.mesh.scale.x * 0.2, y: this.mesh.scale.y * 0.2 }, 1);\r\n      lerp2(copy.scale, { x: 0, y: 0 }, easeSinInOut(tNorm));\r\n\r\n      const ended = tNorm > 1;\r\n      if (ended) {\r\n        this.scene.remove(copy);\r\n      }\r\n      return ended;\r\n    };\r\n    return chain(\r\n      animDuplicate,\r\n      also(animPause(0.5), animStayLeft),\r\n      also(animShrinkAndMove, animReturnOriginal),\r\n      animShrinkToZeroAndRemove\r\n    );\r\n  }\r\n}\r\n\r\nfunction newMesh() {\r\n  const m = new Mesh(\r\n    new PlaneBufferGeometry(0.75, 0.75),\r\n    new MeshBasicMaterial({\r\n      transparent: true,\r\n      // depthWrite: false,\r\n      // depthTest: false,\r\n      map: textureFromSpritesheet(3, 2, \"transparent\"),\r\n      color: new Color(\"white\"),\r\n      side: DoubleSide,\r\n    })\r\n  );\r\n  m.renderOrder = 9;\r\n  return m;\r\n}\r\n\r\nconst ZERO = new Vector2();\r\n","import { easeBounceOut, easeQuadOut } from \"d3-ease\";\r\nimport { polyUpDown } from \"math/easing\";\r\nimport Ticker from \"std/ticker\";\r\nimport { Color, DoubleSide, Mesh, MeshBasicMaterial, PlaneBufferGeometry, Scene } from \"three\";\r\nimport { PlayerSeed } from \"../../core\";\r\nimport { MaterialInfo } from \"../../core/cell/materialInfo\";\r\nimport { lerp, map } from \"../../math\";\r\nimport { fruitPoof, introBounce } from \"../audio\";\r\nimport { Mito } from \"../mito/mito\";\r\nimport { textureFromSpritesheet } from \"../spritesheet\";\r\nimport { Renderer } from \"./Renderer\";\r\nimport { also, Animation, AnimationController, animPause, chain } from \"./tile/Animation\";\r\n\r\nexport class PlayerSeedRenderer extends Renderer<PlayerSeed> {\r\n  public mesh: Mesh;\r\n\r\n  protected animation = new AnimationController();\r\n\r\n  constructor(target: PlayerSeed, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    const reproducerCellType = target.world.genome.cellTypes.find(\r\n      (cellType) => cellType.chromosome.computeStaticProperties().isReproductive\r\n    )!;\r\n    const material = reproducerCellType.material;\r\n    this.mesh = newMesh(material);\r\n    this.mesh.name = \"Player Seed Mesh\";\r\n    this.mito.scenePlayerSeed.add(this.mesh);\r\n    this.animation.set(chain(this.fallInAnimation(), animPause(2), this.wiggleAnimationForever()));\r\n    // this.animation.set(this.wiggleAnimationForever());\r\n  }\r\n\r\n  update() {\r\n    const pos = this.target.posFloat.clone();\r\n    this.mesh.rotation.set(0, 0, 0);\r\n    this.mesh.position.set(pos.x, pos.y, 11);\r\n    this.animation.update();\r\n  }\r\n\r\n  destroy() {\r\n    this.animation.set(\r\n      chain(this.popOutAnimation(), () => {\r\n        this.scene.remove(this.mesh);\r\n        return true;\r\n      })\r\n    );\r\n    Ticker.addAnimation((t) => {\r\n      this.animation.update();\r\n      if (this.animation.animation == null) {\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n\r\n  public popOutAnimation(): Animation {\r\n    const growBigDuration = 0.5;\r\n    const finalScale = 7.0;\r\n    const growBig: Animation = (t) => {\r\n      const tNorm = t / growBigDuration;\r\n      this.mesh.scale.setScalar(lerp(1, finalScale, easeQuadOut(tNorm)));\r\n      // (this.mesh.material as MeshBasicMaterial).opacity = lerp(1, 0.5, tNorm);\r\n      return tNorm > 1;\r\n    };\r\n    const stayBig: Animation = (t) => {\r\n      this.mesh.scale.setScalar(finalScale);\r\n      return t > 1;\r\n    };\r\n    const fadeOut: Animation = (t) => {\r\n      const tNorm = t / 0.2;\r\n      (this.mesh.material as MeshBasicMaterial).opacity = lerp(1, 0, tNorm);\r\n      return tNorm > 1;\r\n    };\r\n    return chain(\r\n      also(growBig, () => {\r\n        fruitPoof.play();\r\n        return true;\r\n      }),\r\n      stayBig,\r\n      fadeOut\r\n    );\r\n  }\r\n\r\n  public fallInAnimation(): Animation {\r\n    const startY = 12;\r\n    const startPosition: Animation = (t) => {\r\n      this.mesh.position.y -= startY;\r\n      return false;\r\n    };\r\n    const duration = 2;\r\n    const anim: Animation = (t) => {\r\n      const tNorm = t / duration;\r\n      this.mesh.position.y -= lerp(startY, 0, easeBounceOut(tNorm));\r\n      return tNorm > 1;\r\n    };\r\n    return chain(\r\n      also(animPause(1), startPosition),\r\n      also(anim, () => {\r\n        introBounce.play();\r\n        return true;\r\n      })\r\n    );\r\n  }\r\n\r\n  public wiggleAnimationForever(): Animation {\r\n    const wiggleDuration = 1;\r\n    const waitDuration = 2;\r\n    return (t) => {\r\n      const tBounded = t % (wiggleDuration + waitDuration);\r\n      if (tBounded < wiggleDuration) {\r\n        const tNorm = tBounded / wiggleDuration;\r\n        const zRot = Math.sin(map(Math.sin(tNorm * Math.PI * 4), -1, 1, -Math.PI / 6, Math.PI / 6)) * polyUpDown(tNorm);\r\n        // this.mesh.rotation.set(0, 0, zRot);\r\n        this.mesh.position.y -= Math.abs(zRot * 1);\r\n      }\r\n      return false;\r\n    };\r\n  }\r\n}\r\n\r\nfunction newMesh(material: MaterialInfo) {\r\n  const m = new Mesh(\r\n    new PlaneBufferGeometry(1, 1),\r\n    new MeshBasicMaterial({\r\n      transparent: true,\r\n      // depthWrite: false,\r\n      // depthTest: false,\r\n      map: textureFromSpritesheet(material.texturePosition.x, material.texturePosition.y),\r\n      color: material.color ?? new Color(\"white\"),\r\n      side: DoubleSide,\r\n    })\r\n  );\r\n  m.renderOrder = 9;\r\n  return m;\r\n}\r\n","/**\r\n * A Proxy that makes every .get() into a method that, upon invocation,\r\n * calls the corresponding method name in its backing array with the arguments.\r\n * Returns void.\r\n */\r\nexport function arrayProxy<T>(values: T[]) {\r\n  return new Proxy(\r\n    {},\r\n    {\r\n      get: (target, p: keyof T) => {\r\n        const v0 = values[0];\r\n        if (v0 != null && typeof v0[p] === \"function\") {\r\n          return function(...args: any[]) {\r\n            for (const t of values) {\r\n              const method = t[p];\r\n              if (typeof method === \"function\") {\r\n                method.apply(t, args);\r\n              }\r\n            }\r\n          };\r\n        } else {\r\n          return NO_OP;\r\n        }\r\n      },\r\n    }\r\n  ) as T;\r\n}\r\n\r\nconst NO_OP = () => {};\r\n","import { Gene } from \"core/cell/gene\";\r\nimport { GeneInstance } from \"core/cell/geneInstance\";\r\nimport { Renderer } from \"../Renderer\";\r\nimport { InstancedTileRenderer } from \"./InstancedTileRenderer\";\r\n\r\nexport abstract class GeneRenderer<G extends Gene = Gene> extends Renderer<GeneInstance<G>> {\r\n  constructor(t: GeneInstance<G>, public tileRenderer: InstancedTileRenderer) {\r\n    super(t, tileRenderer.scene, tileRenderer.mito);\r\n    this.init();\r\n  }\r\n\r\n  init() {}\r\n\r\n  abstract hover?(): void;\r\n}\r\n","import { BufferGeometry, Float32BufferAttribute, Line, LineBasicMaterial, Vector3 } from \"three\";\r\n\r\nconst lineGeometry = (() => {\r\n  const g = new BufferGeometry();\r\n  g.setAttribute(\"position\", new Float32BufferAttribute([0, 0, 0, 0, 1, 0], 3));\r\n  return g;\r\n})();\r\n\r\nexport default function makeLine(dir: Vector3, origin: Vector3, length: number, color: number) {\r\n  // copied from https://github.com/mrdoob/js/blob/master/src/helpers/ArrowHelper.js\r\n  const line = new Line(lineGeometry, new LineBasicMaterial({ color: color }));\r\n  line.position.copy(origin);\r\n  // dir is assumed to be normalized\r\n  if (dir.y > 0.99999) {\r\n    line.quaternion.set(0, 0, 0, 1);\r\n  } else if (dir.y < -0.99999) {\r\n    line.quaternion.set(1, 0, 0, 0);\r\n  } else {\r\n    const axis = new Vector3(dir.z, 0, -dir.x).normalize();\r\n    const radians = Math.acos(dir.y);\r\n    line.quaternion.setFromAxisAngle(axis, radians);\r\n  }\r\n  line.scale.set(1, Math.max(0, length), 1);\r\n  line.position.z = 0.1;\r\n  line.updateMatrix();\r\n  line.matrixAutoUpdate = false;\r\n  return line;\r\n}\r\n","import configure from \"common/configure\";\r\nimport { blopBuffer, distScalar } from \"game/audio\";\r\nimport { GenePhotosynthesis } from \"std/genes/GenePhotosynthesis\";\r\nimport { Audio, Object3D, Vector2, Vector3 } from \"three\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport makeLine from \"./makeLine\";\r\nexport class GenePhotosynthesisRenderer extends GeneRenderer<GenePhotosynthesis> {\r\n  private audio = this.tileRenderer.worldRenderer.renderResources\r\n    ? configure(new Audio(this.mito.audioListener), (audio) => {\r\n        blopBuffer.then((buffer) => audio.setBuffer(buffer));\r\n      })\r\n    : undefined;\r\n\r\n  private lastAudioValueTracker = 0;\r\n\r\n  private neighborLines = new Object3D();\r\n\r\n  update() {\r\n    // audio\r\n    const newAudioValueTracker = this.target.state.totalSugarProduced;\r\n    if (newAudioValueTracker > this.lastAudioValueTracker) {\r\n      const baseVolume = this.target.state.sugarConverted * this.target.state.sugarConverted;\r\n      const volume = distScalar(this.target.cell, this.mito.world.player) * baseVolume;\r\n      this.audio?.setVolume(volume);\r\n      // this.audio.setRefDistance(2);\r\n      // play blop sound\r\n      this.audio?.play();\r\n      this.tileRenderer.animation.set(this.tileRenderer.growPulseAnimation());\r\n    }\r\n    this.lastAudioValueTracker = newAudioValueTracker;\r\n    if (this.neighborLines.parent != null) {\r\n      this.scene.remove(this.neighborLines);\r\n    }\r\n  }\r\n\r\n  hover() {\r\n    this.scene.add(this.neighborLines);\r\n    this.neighborLines.position.set(this.tileRenderer.target.pos.x, this.tileRenderer.target.pos.y, 1);\r\n    const lines: Vector2[] = this.target.state.activeNeighbors;\r\n    if (lines.length !== this.neighborLines.children.length) {\r\n      // redo neighbor lines\r\n      this.neighborLines.remove(...this.neighborLines.children);\r\n      lines.forEach((dir) => {\r\n        const length = dir.length() - 0.25;\r\n        const arrowDir = new Vector3(dir.x, dir.y, 0).normalize();\r\n        const line = makeLine(arrowDir, new Vector3(), length, color);\r\n        this.neighborLines.add(line);\r\n      });\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.neighborLines);\r\n    this.audio?.disconnect();\r\n  }\r\n}\r\n\r\nconst color = 0xffc90e;\r\n","import { CellType, GeneInstance } from \"core/cell\";\r\nimport { Directions, DIRECTIONS } from \"core/directions\";\r\nimport Keyboard from \"game/input/keyboard\";\r\nimport { WorldDOMElement } from \"game/mito/WorldDOMElement\";\r\nimport React, { useCallback } from \"react\";\r\nimport { IoIosClose } from \"react-icons/io\";\r\nimport { GenePipes } from \"std/genes/GenePipes\";\r\nimport { BoxBufferGeometry, DoubleSide, Mesh, MeshBasicMaterial } from \"three\";\r\nimport \"./GenePipesRenderer.scss\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\n\r\nconst geom = new BoxBufferGeometry(0.2, 0.1);\r\n\r\nconst materialMap = new Map<CellType, MeshBasicMaterial>();\r\nfunction getPipeMaterial(cellType: CellType) {\r\n  if (!materialMap.has(cellType)) {\r\n    const color = cellType.material.color?.getHex() ?? 0xffffff;\r\n    materialMap.set(\r\n      cellType,\r\n      new MeshBasicMaterial({\r\n        color,\r\n        side: DoubleSide,\r\n      })\r\n    );\r\n  }\r\n  return materialMap.get(cellType);\r\n}\r\n\r\nexport class GenePipesRenderer extends GeneRenderer<GenePipes> {\r\n  public meshes: Partial<Record<Directions, Mesh>> = {};\r\n\r\n  private argsEditor?: WorldDOMElement;\r\n\r\n  update() {\r\n    const { connections } = this.target.state;\r\n    let direction: Directions;\r\n    for (direction in this.target.state.connections) {\r\n      if (connections[direction] && this.meshes[direction] == null) {\r\n        this.addMesh(direction);\r\n      } else if (!connections[direction] && this.meshes[direction] != null) {\r\n        this.removeMesh(direction);\r\n      }\r\n    }\r\n\r\n    if (this.tileRenderer.worldRenderer.renderResources) {\r\n      this.updateArgsEditor();\r\n    }\r\n  }\r\n\r\n  private addMesh(directionName: Directions) {\r\n    const mesh = (this.meshes[directionName] = new Mesh(geom, getPipeMaterial(this.target.cell.type)));\r\n    const direction = DIRECTIONS[directionName];\r\n    mesh.position.x = this.target.cell.pos.x + direction.x * 0.4;\r\n    mesh.position.y = this.target.cell.pos.y + direction.y * 0.4;\r\n    mesh.position.z = 2;\r\n    mesh.rotation.z = direction.angle();\r\n    this.scene.add(mesh);\r\n  }\r\n\r\n  private removeMesh(directionName: Directions) {\r\n    const mesh = this.meshes[directionName]!;\r\n    delete this.meshes[directionName];\r\n    this.scene.remove(mesh);\r\n  }\r\n\r\n  updateArgsEditor() {\r\n    const shouldShowArgsEditor = Keyboard.keyMap.has(\"ShiftLeft\") && this.mito.getTileAtScreen() === this.target.cell;\r\n    if (shouldShowArgsEditor && this.argsEditor == null) {\r\n      this.argsEditor = this.mito.addWorldDOMElement(this.positionFn, this.renderFn);\r\n    } else if (!shouldShowArgsEditor && this.argsEditor != null) {\r\n      this.mito.removeWorldDOMElement(this.argsEditor);\r\n      this.argsEditor = undefined;\r\n    }\r\n  }\r\n\r\n  private positionFn = () => this.target.cell;\r\n\r\n  private renderFn = () => {\r\n    return <PipesEditor gene={this.target} />;\r\n  };\r\n\r\n  hover() {}\r\n\r\n  destroy() {\r\n    if (this.argsEditor) {\r\n      this.mito.removeWorldDOMElement(this.argsEditor);\r\n    }\r\n  }\r\n}\r\n\r\nconst PipesEditor: React.FC<{ gene: GeneInstance<GenePipes> }> = ({ gene }) => {\r\n  const connections = gene.state.connections;\r\n  const setDirN = useCallback(() => {\r\n    connections.n = !connections.n;\r\n  }, [connections.n]);\r\n\r\n  const setDirS = useCallback(() => {\r\n    connections.s = !connections.s;\r\n  }, [connections.s]);\r\n\r\n  const setDirE = useCallback(() => {\r\n    connections.e = !connections.e;\r\n  }, [connections.e]);\r\n\r\n  const setDirW = useCallback(() => {\r\n    connections.w = !connections.w;\r\n  }, [connections.w]);\r\n\r\n  const clearDirections = useCallback(() => {\r\n    let name: Directions;\r\n    for (name in connections) {\r\n      connections[name] = false;\r\n    }\r\n  }, [connections]);\r\n\r\n  return (\r\n    <div className=\"pipes-editor\">\r\n      <div className=\"zone-n\" onClick={setDirN}></div>\r\n      <div className=\"zone-w\" onClick={setDirW}></div>\r\n      <div className=\"zone-center\" onClick={clearDirections}>\r\n        <IoIosClose />\r\n      </div>\r\n      <div className=\"zone-e\" onClick={setDirE}></div>\r\n      <div className=\"zone-s\" onClick={setDirS}></div>\r\n    </div>\r\n  );\r\n};\r\n","import { Gene } from \"core/cell/gene\";\r\nimport { map } from \"math\";\r\nimport React from \"react\";\r\nimport { reproducerGetPercentMatured, ReproducerState } from \"std/genes/GeneReproducer\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport \"./GeneReproducerRenderer.scss\";\r\n\r\nexport class GeneReproducerRenderer extends GeneRenderer<Gene<ReproducerState, any>> {\r\n  percentMatureElement = this.tileRenderer.worldRenderer.renderResources\r\n    ? this.mito.addWorldDOMElement(\r\n        () => this.target.cell,\r\n        () => {\r\n          const matured = reproducerGetPercentMatured(this.target);\r\n          return <div className=\"reproducer-percent-mature\">{(matured * 100).toFixed(1)}%</div>;\r\n        }\r\n      )\r\n    : null;\r\n\r\n  hover() {}\r\n\r\n  update() {\r\n    this.updateScale();\r\n  }\r\n\r\n  updateScale() {\r\n    const scale = map(reproducerGetPercentMatured(this.target), 0, 1, 0.2, 1);\r\n    this.tileRenderer.scale.set(scale, scale, 1);\r\n  }\r\n\r\n  //   super.update();\r\n  // if (this.target.age - this.lastEmitAge > 0.5) {\r\n  //   const angle = Math.random() * Math.PI * 2;\r\n  //   const speed = 0.1;\r\n  //   const dx = Math.cos(angle) * speed;\r\n  //   const dy = Math.sin(angle) * speed;\r\n  //   fruitSparkle.fire({\r\n  //     x: this.target.pos.x,\r\n  //     y: this.target.pos.y,\r\n  //     z: 1,\r\n  //     alpha: 1,\r\n  //     info: { dx, dy },\r\n  //     size: 1,\r\n  //     time: 0,\r\n  //     // r: angle,\r\n  //   });\r\n  //   this.lastEmitAge = this.target.age;\r\n  // }\r\n  // }\r\n\r\n  destroy() {\r\n    if (this.percentMatureElement) {\r\n      this.mito.removeWorldDOMElement(this.percentMatureElement);\r\n    }\r\n  }\r\n}\r\n","import { distScalar, suckWaterBuffer } from \"game/audio\";\r\nimport { GeneSoilAbsorption } from \"std/genes\";\r\nimport { Audio, Color, Object3D, Vector2, Vector3 } from \"three\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport makeLine from \"./makeLine\";\r\nexport class GeneSoilAbsorptionRenderer extends GeneRenderer<GeneSoilAbsorption> {\r\n  private audio = (() => {\r\n    const audio = new Audio(this.mito.audioListener);\r\n    suckWaterBuffer.then((buffer) => audio.setBuffer(buffer));\r\n    return audio;\r\n  })();\r\n\r\n  private lastAudioValueTracker = 0;\r\n\r\n  private neighborLines = new Object3D();\r\n\r\n  update() {\r\n    const newAudioValueTracker = this.target.state.totalSucked;\r\n    if (newAudioValueTracker !== this.lastAudioValueTracker) {\r\n      // const baseVolume = this.target.waterTransferAmount / (2 + this.target.waterTransferAmount);\r\n      const baseVolume = 1;\r\n      const volume = distScalar(this.target.cell, this.mito.world.player) * baseVolume;\r\n      this.audio.setVolume(volume);\r\n      if (this.audio.source != null) {\r\n        this.audio.stop();\r\n      }\r\n      this.audio.play();\r\n      this.tileRenderer.animation.set(this.tileRenderer.growPulseAnimation());\r\n    }\r\n    this.lastAudioValueTracker = newAudioValueTracker;\r\n    if (this.neighborLines.parent != null) {\r\n      this.scene.remove(this.neighborLines);\r\n    }\r\n  }\r\n\r\n  hover() {\r\n    this.scene.add(this.neighborLines);\r\n    this.neighborLines.position.set(this.tileRenderer.target.pos.x, this.tileRenderer.target.pos.y, 1);\r\n    const lines: Vector2[] = this.target.state.activeNeighbors;\r\n    if (lines.length !== this.neighborLines.children.length) {\r\n      // redo neighbor lines\r\n      this.neighborLines.remove(...this.neighborLines.children);\r\n      lines.forEach((dir) => {\r\n        const length = dir.length() - 0.25;\r\n        const arrowDir = new Vector3(dir.x, dir.y, 0).normalize();\r\n        const line = makeLine(arrowDir, new Vector3(), length, color);\r\n        this.neighborLines.add(line);\r\n      });\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.neighborLines);\r\n    this.audio.disconnect();\r\n  }\r\n}\r\nconst color = new Color(\"rgb(9, 12, 255)\").getHex();\r\n","import { GeneInstance } from \"core/cell\";\r\nimport { easeCubicOut, easeExpOut } from \"d3-ease\";\r\nimport Keyboard from \"game/input/keyboard\";\r\nimport { WorldDOMElement } from \"game/mito/WorldDOMElement\";\r\nimport { randFloat, roundToNearest } from \"math\";\r\nimport React, { useCallback, useEffect, useState } from \"react\";\r\nimport { GeneTransport } from \"std/genes/GeneTransport\";\r\nimport { ArrowHelper, Vector2, Vector3 } from \"three\";\r\nimport { Animation } from \"./Animation\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport \"./GeneTransportRenderer.scss\";\r\n\r\nexport class GeneTransportRenderer extends GeneRenderer<GeneTransport> {\r\n  private arrow!: ArrowHelper;\r\n\r\n  private origin!: Vector2;\r\n\r\n  private lastDir = new Vector2(0, 0);\r\n\r\n  private argsEditor?: WorldDOMElement;\r\n\r\n  update() {\r\n    this.updateArrow();\r\n    this.updateArrowPosition();\r\n    if (this.tileRenderer.worldRenderer.renderResources) {\r\n      this.updateArgsEditor();\r\n    }\r\n\r\n    if (this.target.state.didJustTransport) {\r\n      this.tileRenderer.animation.set(this.arrowMoveAnimation());\r\n    }\r\n  }\r\n\r\n  updateArgsEditor() {\r\n    const shouldShowArgsEditor = Keyboard.keyMap.has(\"ShiftLeft\") && this.mito.getTileAtScreen() === this.target.cell;\r\n    if (shouldShowArgsEditor && this.argsEditor == null) {\r\n      this.argsEditor = this.mito.addWorldDOMElement(this.positionFn, this.renderFn);\r\n    } else if (!shouldShowArgsEditor && this.argsEditor != null) {\r\n      this.mito.removeWorldDOMElement(this.argsEditor);\r\n      this.argsEditor = undefined;\r\n    }\r\n  }\r\n\r\n  private positionFn = () => this.target.cell;\r\n\r\n  private renderFn = () => {\r\n    return <TransportEditor gene={this.target} />;\r\n  };\r\n\r\n  updateArrow() {\r\n    const dir = this.target.cell.args!.direction!;\r\n    if (!dir.equals(this.lastDir)) {\r\n      if (this.arrow != null) {\r\n        this.arrow.parent!.remove(this.arrow);\r\n      }\r\n      // const length = target.dir.length() - 0.25;\r\n      const length = 0.5;\r\n      const arrowDir = dir.clone().normalize();\r\n      this.origin = arrowDir.clone().multiplyScalar(-length / 2);\r\n      this.arrow = new ArrowHelper(\r\n        new Vector3(arrowDir.x, arrowDir.y, 0),\r\n        new Vector3(this.origin.x, this.origin.y, 2),\r\n        length,\r\n        0xffffff,\r\n        0.1,\r\n        0.1\r\n      );\r\n      this.scene.add(this.arrow);\r\n      this.lastDir.copy(dir);\r\n      this.tileRenderer.animation.set(this.arrowSetAnimation());\r\n    }\r\n  }\r\n\r\n  updateArrowPosition({ x, y }: { x: number; y: number } = this.origin) {\r\n    this.arrow.position.set(this.target.cell.pos.x + x, this.target.cell.pos.y + this.target.cell.droopY + y, 2);\r\n  }\r\n\r\n  arrowMoveAnimation(): Animation {\r\n    const duration = 0.25;\r\n    const len = this.origin.length();\r\n    const start = this.origin.clone().setLength(len * 1.1);\r\n    const target = this.origin.clone().setLength(len * 0.5);\r\n    return (t) => {\r\n      const tNorm = t / duration;\r\n      this.updateArrowPosition(start.clone().lerp(target, easeExpOut(tNorm)));\r\n      return tNorm >= 1;\r\n    };\r\n  }\r\n\r\n  arrowSetAnimation(): Animation {\r\n    const duration = 0.2;\r\n    return (t) => {\r\n      const tNorm = t / duration;\r\n      const vibrationAmount = easeCubicOut(1 - tNorm) * 0.1;\r\n      this.updateArrowPosition({\r\n        x: randFloat(-vibrationAmount, vibrationAmount),\r\n        y: randFloat(-vibrationAmount, vibrationAmount),\r\n      });\r\n      // const scale = clamp(map(tNorm, 0, 1, 2, 1), 1, 2);\r\n      // this.arrow.scale.set(scale, scale, 1);\r\n      return tNorm >= 1;\r\n    };\r\n  }\r\n\r\n  hover() {}\r\n\r\n  destroy() {\r\n    this.scene.remove(this.arrow);\r\n    if (this.argsEditor) {\r\n      this.mito.removeWorldDOMElement(this.argsEditor);\r\n    }\r\n  }\r\n}\r\n\r\nconst TransportEditor: React.FC<{ gene: GeneInstance<GeneTransport> }> = ({ gene }) => {\r\n  const setDirN = useCallback(() => {\r\n    gene.cell.args?.direction?.set(0, -1);\r\n  }, [gene.cell.args]);\r\n\r\n  const setDirS = useCallback(() => {\r\n    gene.cell.args?.direction?.set(0, 1);\r\n  }, [gene.cell.args]);\r\n\r\n  const setDirE = useCallback(() => {\r\n    gene.cell.args?.direction?.set(1, 0);\r\n  }, [gene.cell.args]);\r\n\r\n  const setDirW = useCallback(() => {\r\n    gene.cell.args?.direction?.set(-1, 0);\r\n  }, [gene.cell.args]);\r\n\r\n  const [wantedDirection, addEvent] = useWantedDirection();\r\n  useEffect(() => {\r\n    if (wantedDirection) {\r\n      gene.cell.args?.direction?.copy(wantedDirection);\r\n    }\r\n  }, [gene.cell.args, wantedDirection]);\r\n  const handleMouseMove = useCallback(\r\n    (event: React.MouseEvent) => {\r\n      if (event.buttons !== 0) {\r\n        console.log(gene.cell.toString(), event.movementX, event.movementY);\r\n        addEvent(event);\r\n      }\r\n    },\r\n    [addEvent, gene.cell]\r\n  );\r\n\r\n  return (\r\n    <div className=\"directional-push-editor\" onMouseMove={handleMouseMove}>\r\n      <div className=\"zone-n\" onClick={setDirN}></div>\r\n      <div className=\"zone-w\" onClick={setDirW}></div>\r\n      <div className=\"zone-center\" />\r\n      <div className=\"zone-e\" onClick={setDirE}></div>\r\n      <div className=\"zone-s\" onClick={setDirS}></div>\r\n    </div>\r\n  );\r\n};\r\n\r\nfunction useWantedDirection() {\r\n  const [latestMovements, setLatestMovements] = useState<Vector2[]>([]);\r\n\r\n  const addEvent = useCallback((event: React.MouseEvent) => {\r\n    const { movementX, movementY } = event;\r\n    const movement = new Vector2(movementX, movementY);\r\n    setLatestMovements((latestMovements) => [movement, ...latestMovements]);\r\n  }, []);\r\n\r\n  let wantedDirection: Vector2 | undefined;\r\n\r\n  const totalMovement = latestMovements.reduce((a, b) => a.add(b), new Vector2());\r\n  // only make a decision once total movement is large enough\r\n  if (totalMovement.lengthSq() > 12 * 12) {\r\n    const angle = totalMovement.angle();\r\n    const nearestAngle90 = roundToNearest(angle, Math.PI / 2);\r\n    wantedDirection = new Vector2(Math.round(Math.cos(nearestAngle90)), Math.round(Math.sin(nearestAngle90)));\r\n  }\r\n  return [wantedDirection, addEvent] as const;\r\n}\r\n","import { arrayProxy } from \"common/arrayProxy\";\r\nimport { GeneInstance } from \"core/cell/geneInstance\";\r\nimport { Temperature } from \"core/temperature\";\r\nimport { Air, Cell, DeadCell, Fountain, GrowingCell, Rock, Tile } from \"core/tile\";\r\nimport { BarrenLand } from \"core/tile/BarrenLand\";\r\nimport { Clay, Sand, Silt } from \"core/tile/soil\";\r\nimport { easeCubic } from \"d3-ease\";\r\nimport Mito from \"game/mito/mito\";\r\nimport { clamp, lerp, lerp2, map } from \"math\";\r\nimport { reversed } from \"math/easing\";\r\nimport { GeneFruit, GenePhotosynthesis, GenePipes, GeneSeed, GeneSoilAbsorption, GeneTransport } from \"std/genes\";\r\nimport { Color, Scene, Vector2, Vector3 } from \"three\";\r\nimport { Constructor } from \"typings/constructor\";\r\nimport { MaterialInfo } from \"../../../core/cell/materialInfo\";\r\nimport { InventoryRenderer } from \"../InventoryRenderer\";\r\nimport { Renderer } from \"../Renderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { Animation, AnimationController } from \"./Animation\";\r\nimport { CellEffectsRenderer } from \"./CellEffectsRenderer\";\r\nimport { GenePhotosynthesisRenderer } from \"./GenePhotosynthesisRenderer\";\r\nimport { GenePipesRenderer } from \"./GenePipesRenderer\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport { GeneReproducerRenderer } from \"./GeneReproducerRenderer\";\r\nimport { GeneSoilAbsorptionRenderer } from \"./GeneSoilAbsorptionRenderer\";\r\nimport { GeneTransportRenderer } from \"./GeneTransportRenderer\";\r\nimport TileBatcher, { BatchInstance } from \"./tileBatcher\";\r\n\r\nexport class InstancedTileRenderer<T extends Tile = Tile> extends Renderer<T> {\r\n  public static readonly TEMPERATURE_COLORS = {\r\n    [Temperature.Scorching]: new Color(\"orange\"),\r\n    [Temperature.Hot]: new Color(\"orange\").lerp(new Color(\"white\"), 0.5),\r\n    [Temperature.Mild]: new Color(\"white\"),\r\n    [Temperature.Cold]: new Color(\"lightblue\").lerp(new Color(\"white\"), 0.5),\r\n    [Temperature.Freezing]: new Color(\"rgb(43, 34, 126)\"),\r\n  } as Record<Temperature, Color>;\r\n\r\n  private static readonly ONE = Object.freeze(new Vector2(1, 1));\r\n\r\n  public inventoryRenderer?: InventoryRenderer;\r\n\r\n  private originalColor: Color;\r\n\r\n  private cellEffectsRenderer?: CellEffectsRenderer;\r\n\r\n  private geneRenderer?: GeneRenderer;\r\n\r\n  animation = new AnimationController();\r\n\r\n  scale = new Vector3(1, 1, 1);\r\n\r\n  private color = new Color();\r\n\r\n  private instance: BatchInstance;\r\n\r\n  worldRenderer: WorldRenderer;\r\n\r\n  get materialInfo() {\r\n    return getMaterialInfo(this.target);\r\n  }\r\n\r\n  constructor(target: T, scene: Scene, mito: Mito, batchMesh: TileBatcher, worldRenderer: WorldRenderer) {\r\n    super(target, scene, mito);\r\n    this.worldRenderer = worldRenderer;\r\n    this.instance = batchMesh.getBatchInstance(target);\r\n    if (this.target instanceof GrowingCell) {\r\n      this.scale.set(0.01, 0.01, 1);\r\n    }\r\n\r\n    this.originalColor = (this.materialInfo.color || WHITE).clone();\r\n    if (worldRenderer.inventoryPoints) {\r\n      this.inventoryRenderer = new InventoryRenderer(\r\n        this.target.inventory,\r\n        this.scene,\r\n        this.mito,\r\n        worldRenderer.inventoryPoints\r\n      );\r\n      this.inventoryRenderer.animationOffset = (this.target.pos.x + this.target.pos.y) / 2;\r\n    }\r\n    if (this.target instanceof Cell) {\r\n      // if it takes no time to build, start it off small just for show\r\n      if (this.target.timeToBuild <= 0) {\r\n        this.scale.set(0.01, 0.01, 1);\r\n      }\r\n      this.cellEffectsRenderer = new CellEffectsRenderer(this.target, this.scene, this.mito);\r\n      this.geneRenderer = arrayProxy(\r\n        this.target.geneInstances.map((g) => this.createGeneRendererFor(g)!).filter((g) => g != null)\r\n      );\r\n    }\r\n\r\n    if (this.target.darkness < 1) {\r\n      this.commit();\r\n    }\r\n  }\r\n\r\n  private createGeneRendererFor(inst: GeneInstance<any>): GeneRenderer<any> | undefined {\r\n    if (inst.isType(GeneSoilAbsorption)) {\r\n      return new GeneSoilAbsorptionRenderer(inst, this);\r\n    } else if (inst.isType(GenePhotosynthesis)) {\r\n      return new GenePhotosynthesisRenderer(inst, this);\r\n    } else if (inst.isType(GeneTransport)) {\r\n      return new GeneTransportRenderer(inst, this);\r\n    } else if (inst.isType(GeneFruit) || inst.isType(GeneSeed)) {\r\n      return new GeneReproducerRenderer(inst, this);\r\n    } else if (inst.isType(GenePipes)) {\r\n      return new GenePipesRenderer(inst, this);\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  commit() {\r\n    if (this.target instanceof GrowingCell) {\r\n      const { start, pos } = this.target;\r\n      const p = start.clone().lerp(pos, 0.5);\r\n      const t1Pos = pos;\r\n      const t = this.scale.x;\r\n      lerp2(p, t1Pos, t);\r\n      this.instance.commitCenter(p.x, p.y, 1);\r\n    } else if (this.target instanceof Cell) {\r\n      this.instance.commitCenter(this.target.pos.x, this.target.pos.y + this.target.droopY, 1);\r\n    } else {\r\n      const z = this.target instanceof Air ? -10 : 0;\r\n      this.instance.commitCenter(this.target.pos.x, this.target.pos.y, z);\r\n    }\r\n    this.instance.commitTexturePosition(this.materialInfo.texturePosition);\r\n    this.instance.commitColor(this.color);\r\n    this.instance.commitTemperature(this.target.temperatureFloat);\r\n    // const dist = this.target.pos.distanceTo(this.mito.world.player.pos);\r\n    // const timeAlive = this.target.age;\r\n    // const alpha = clamp(easeCubicIn(timeAlive * 3 - dist), 0, 1);\r\n    // this.instance.commitAlpha(alpha);\r\n    this.instance.commitScale(this.scale);\r\n  }\r\n\r\n  update() {\r\n    if (this.target.darkness < 1) {\r\n      this.updateScale();\r\n      this.updateColor();\r\n\r\n      this.updateInventory();\r\n      this.maybeUpdateCellEffectsRenderer();\r\n\r\n      if (this.geneRenderer) {\r\n        this.geneRenderer.update();\r\n      }\r\n\r\n      this.animation.update();\r\n      this.commit();\r\n    }\r\n  }\r\n\r\n  maybeUpdateCellEffectsRenderer() {\r\n    if (this.cellEffectsRenderer != null) {\r\n      this.cellEffectsRenderer.update();\r\n    }\r\n  }\r\n\r\n  updateInventory() {\r\n    // will not render without an update\r\n    this.inventoryRenderer?.update();\r\n  }\r\n\r\n  updateScale() {\r\n    if (this.target instanceof GrowingCell) {\r\n      const s = map(this.target.percentGrown, 0, 1, 0.1, 1);\r\n      lerp2(this.scale, { x: s, y: s }, 0.5);\r\n    } else if (this.target instanceof Cell && this.target.isReproductive) {\r\n      // Do nothing; GeneRenderer sets scale for you\r\n    } else {\r\n      lerp2(this.scale, InstancedTileRenderer.ONE, 0.1);\r\n    }\r\n  }\r\n\r\n  updateColor() {\r\n    const lightAmount = this.target.lightAmount();\r\n    if (this.target instanceof Air) {\r\n      const colorIndex = Math.max(0, map(this.target.co2(), 1 / 6, 1.001, 0, AIR_COLORSCALE.length - 1));\r\n      const startColorIndex = Math.floor(colorIndex);\r\n      const startColor = AIR_COLORSCALE[startColorIndex];\r\n      this.originalColor = startColor.clone();\r\n      if (startColorIndex !== AIR_COLORSCALE.length - 1) {\r\n        const alpha = colorIndex - startColorIndex;\r\n        const endColorIndex = startColorIndex + 1;\r\n        const endColor = AIR_COLORSCALE[endColorIndex];\r\n        this.originalColor.lerp(endColor, alpha);\r\n      }\r\n    }\r\n    this.color.copy(this.originalColor);\r\n    if (this.target instanceof Cell && this.target.energy < 0.5) {\r\n      const amountBlack = map(this.target.energy, 0, 0.5, 1, 0);\r\n      this.color.lerp(BLACK, amountBlack);\r\n    }\r\n\r\n    this.lerpColorTemperature(this.color);\r\n    // darkness overlay\r\n    this.color.lerp(BLACK, map(lightAmount, 0, 1, 0.8, 0));\r\n  }\r\n\r\n  private temperatureColor: Color = InstancedTileRenderer.TEMPERATURE_COLORS[Temperature.Mild];\r\n\r\n  private currentLerp = 0;\r\n\r\n  private lerpColorTemperature(color: Color) {\r\n    const { temperature } = this.target;\r\n    let tColor = InstancedTileRenderer.TEMPERATURE_COLORS[temperature];\r\n    if (tColor !== this.temperatureColor) {\r\n      this.currentLerp = 0;\r\n    }\r\n    const targetLerp = temperature === Temperature.Mild ? 0 : 0.25;\r\n    this.temperatureColor = tColor;\r\n    this.currentLerp = lerp(this.currentLerp, targetLerp, 0.1);\r\n    color.lerp(this.temperatureColor, this.currentLerp);\r\n  }\r\n\r\n  updateHover() {\r\n    this.geneRenderer?.hover?.();\r\n  }\r\n\r\n  growPulseAnimation(): Animation {\r\n    const duration = 0.5 * (this.target instanceof Cell ? this.target.tempo : 1);\r\n    const ease = reversed(easeCubic);\r\n    return (t) => {\r\n      const tNorm = clamp(t / duration, 0, 1);\r\n      const scale = map(ease(tNorm), 0, 1, 1, 1.3);\r\n      this.scale.setScalar(scale);\r\n      return tNorm >= 1;\r\n    };\r\n  }\r\n\r\n  hasActiveNeighbors(\r\n    t: any\r\n  ): t is {\r\n    activeNeighbors: Vector2[];\r\n  } {\r\n    return Array.isArray(t.activeNeighbors);\r\n  }\r\n\r\n  destroy() {\r\n    this.instance.destroy();\r\n    // this.scene.remove(this.mesh);\r\n    this.inventoryRenderer?.destroy();\r\n    this.cellEffectsRenderer?.destroy();\r\n    this.geneRenderer?.destroy();\r\n  }\r\n}\r\n\r\nconst materialInfoMapping = (() => {\r\n  const materials = new Map<Constructor<Tile>, MaterialInfo>();\r\n  materials.set(Air, {\r\n    texturePosition: new Vector2(0, 3),\r\n    color: new Color(\"white\"),\r\n  });\r\n  const siltColor = new Color(\"rgb(112, 89, 44)\");\r\n  materials.set(Sand, {\r\n    texturePosition: new Vector2(1, 0),\r\n    color: new Color(\"rgb(223, 220, 231)\").multiplyScalar(1 / 1.2),\r\n  });\r\n  materials.set(Silt, {\r\n    texturePosition: new Vector2(1, 0),\r\n    color: siltColor,\r\n  });\r\n  materials.set(Clay, {\r\n    texturePosition: new Vector2(1, 0),\r\n    color: siltColor.clone().multiplyScalar(1 / 1.5),\r\n  });\r\n  materials.set(BarrenLand, {\r\n    texturePosition: new Vector2(4, 0),\r\n    color: new Color(\"rgb(193, 159, 92)\"),\r\n  });\r\n  materials.set(Fountain, {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(2, 0),\r\n  });\r\n  materials.set(Rock, {\r\n    texturePosition: new Vector2(3, 0),\r\n    color: new Color(\"rgb(63, 77, 84)\"),\r\n  });\r\n  materials.set(DeadCell, {\r\n    texturePosition: new Vector2(0, 1),\r\n    color: new Color(\"rgb(128, 128, 128)\"),\r\n  });\r\n  return materials;\r\n})();\r\n\r\nexport function getMaterialInfo(tile: Tile): MaterialInfo {\r\n  if (tile instanceof GrowingCell) {\r\n    return getMaterialInfo(tile.completedCell);\r\n  } else if (tile instanceof Cell) {\r\n    return tile.type.material;\r\n  } else {\r\n    return materialInfoMapping.get(tile.constructor as Constructor<Tile>)!;\r\n  }\r\n}\r\n\r\nconst AIR_COLORSCALE = [\r\n  new Color(\"hsl(67, 31%, 25%)\"),\r\n  new Color(\"hsl(180, 31%, 76%)\"),\r\n  new Color(\"hsl(213, 63%, 58%)\"),\r\n];\r\n\r\nconst WHITE = new Color(1, 1, 1);\r\nconst BLACK = new Color(0, 0, 0);\r\n","import { World } from \"core\";\r\nimport { Cell, Tile } from \"core/tile\";\r\nimport { SPRITESHEET } from \"game/spritesheet\";\r\nimport {\r\n  Color,\r\n  DoubleSide,\r\n  DynamicDrawUsage,\r\n  InstancedBufferAttribute,\r\n  InstancedBufferGeometry,\r\n  Mesh,\r\n  PlaneBufferGeometry,\r\n  RawShaderMaterial,\r\n  Vector2,\r\n  Vector3,\r\n} from \"three\";\r\nimport glsl from \"../glsl\";\r\n\r\nconst vertexShader = glsl`\r\nprecision mediump float;\r\n\r\n// the vertex shader's main goals are:\r\n// 1. set gl_Position to a clip-coordinate\r\n// 2. pass varyings along to fragment shader.\r\n// you can accept two types of inputs:\r\n//   'attribute' variables, which change per vertex\r\n//   'uniform' variables, which are constant for a given draw context.\r\n// WebGL thankfully hooks up a bunch of attributes and uniforms, see https://threejs.org/docs/index.html#api/en/renderers/webgl/WebGLProgram\r\n// see also my explorations: https://codesandbox.io/s/reactthreejstemplate-lwvhu\r\n\r\n\r\n// Comes from WebGLProgram\r\nuniform mat4 modelViewMatrix;\r\nuniform mat4 projectionMatrix;\r\n\r\n// Comes from threejs Geometry\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\nattribute vec2 uv;\r\n\r\n// attributes we provide\r\n// these are constant per instance\r\nattribute vec3 centers;\r\nattribute vec3 scales;\r\nattribute vec3 colors;\r\nattribute vec2 texturePositions;\r\nattribute float alphas;\r\nattribute float temperatures;\r\n\r\n// things we pass onto fragment\r\nvarying vec3 vTileCenter;\r\nvarying vec3 vColor;\r\nvarying vec2 vUv;\r\nvarying vec2 vTexturePosition;\r\nvarying float vAlpha;\r\nvarying float vTemperature;\r\n\r\n// based on https://github.com/mrdoob/three.js/blob/master/examples/webgl_buffergeometry_instancing_billboards.html\r\nvoid main() {\r\n  vTileCenter = centers;\r\n  vColor = colors;\r\n  vUv = uv;\r\n  vTexturePosition = texturePositions;\r\n  vAlpha = alphas;\r\n  vTemperature = temperatures;\r\n\r\n  vec4 mvPosition = modelViewMatrix * vec4(centers, 1.);\r\n  mvPosition.xyz += position * scales;\r\n  // mvPosition.xyz += position;\r\n  gl_Position = projectionMatrix * mvPosition;\r\n}\r\n`;\r\n\r\nconst fragmentShader = glsl`\r\n// for the fragment shader, the main goal is to set gl_FragColor. Its inputs are\r\n//   'varying' variables from the vertex shader, interpolated along the triangle\r\n//   'uniform' variables\r\nprecision mediump float;\r\n\r\n// these should match the corresponding section in the vertexShader exactly\r\nvarying vec3 vTileCenter;\r\nvarying vec3 vColor;\r\nvarying vec2 vUv;\r\nvarying vec2 vTexturePosition;\r\nvarying float vAlpha;\r\nvarying float vTemperature;\r\n\r\nconst vec2 spritesheetSize = vec2(256., 256.);\r\nuniform sampler2D spriteSheet;\r\n\r\nfloat myRound(float x) {\r\n  return sign(x) * floor(abs(x) + 0.5);\r\n}\r\n\r\nfloat random(float x) {\r\n  return fract(sin(x * .43));\r\n}\r\n\r\nvec3 applyTemperature(vec3 color) {\r\n  return color;\r\n\r\n  // TODO add heat, maybe rework this to look better\r\n\r\n  // vec3 colorFreezing = vec3(12., 54., 89.) / 255.;\r\n  // vec3 colorCold = vec3(214., 235., 242.) / 255.;\r\n  // float amtFreezing = (1. - step(0., vTemperature));\r\n  // float amtCold = (1. - step(32., vTemperature)) * step(0., vTemperature);\r\n  // return mix(mix(color, colorCold, amtCold * 0.5), colorFreezing, amtFreezing * 0.5);\r\n}\r\n\r\n// uv - [0,1]x[0,1] - our local sprite (16x16) UV coords\r\n// texturePosition - the grid x/y where our sprite lives in our texture. NOTE:\r\n// for texturePosition, top-left is 0, 0 (Y is image coordinates)\r\n// textureSize - the pixel width/height of the full spritesheet\r\n// returns: a UV coordinate for this sprite, relative to the full spritesheet\r\nvec2 getCorrectUv(vec2 uv, vec2 texturePosition, vec2 textureSize) {\r\n  vec2 spriteSheetPxStart = texturePosition * vec2(32.);\r\n  spriteSheetPxStart.y = textureSize.y - spriteSheetPxStart.y - 32.;\r\n  vec2 spriteSheetUv = spriteSheetPxStart + uv * vec2(32.);\r\n  vec2 minUv = spriteSheetPxStart + vec2(1.);\r\n  vec2 maxUv = spriteSheetPxStart + vec2(32. - 1.);\r\n  return clamp(spriteSheetUv / textureSize, minUv / textureSize, maxUv / textureSize);\r\n}\r\n\r\nvoid main() {\r\n  vec2 correctUv = getCorrectUv(vUv, vTexturePosition, spritesheetSize);\r\n  vec4 textureColor = texture2D(spriteSheet, correctUv);\r\n  gl_FragColor = vec4(applyTemperature(textureColor.rgb * vColor), textureColor.a * vAlpha);\r\n}\r\n`;\r\n\r\nfunction newTileShaderMaterial() {\r\n  return new RawShaderMaterial({\r\n    uniforms: {\r\n      spriteSheet: { value: SPRITESHEET() },\r\n    },\r\n    transparent: true,\r\n    vertexShader,\r\n    fragmentShader,\r\n    side: DoubleSide,\r\n  });\r\n}\r\n\r\nfunction newTileBatcherGeometry() {\r\n  const referenceGeometry = new PlaneBufferGeometry(1, 1);\r\n  const geometry = new InstancedBufferGeometry();\r\n  // this copies:\r\n  // [0, 2, 1, 2, 3, 1]\r\n  // index has a specific and somewhat cryptic data storage format\r\n  // it's a flattened array of size three elements\r\n  // each three adjacent numbers gets interpreted as one triangle\r\n  // each individual number's value is an *index* into a \"virtual\r\n  // vertex array\" that's defined the attributes array.\r\n  geometry.index = referenceGeometry.index;\r\n  // this copies:\r\n  // position: BufferAttribute, 4 items, size 3\r\n  // normal: BufferAttribute, 4 items, size 3\r\n  // uv: BufferAttribute, 4 items, size 2\r\n  geometry.attributes = referenceGeometry.attributes;\r\n  return geometry;\r\n}\r\n\r\nclass TileBatcher {\r\n  private geometry = newTileBatcherGeometry();\r\n\r\n  public readonly maxTiles = this.world.height * this.world.width * 2;\r\n\r\n  centers = this.attr(3);\r\n\r\n  colors = this.attr(3);\r\n\r\n  scales = this.attr(3);\r\n\r\n  texturePositions = this.attr(2);\r\n\r\n  alphas = this.attr(1, 1);\r\n\r\n  temperatures = this.attr(1, 1);\r\n\r\n  private attr(dim: number, fill = 0) {\r\n    const attr = new InstancedBufferAttribute(new Float32Array(this.maxTiles * dim).fill(fill), dim, false, 1);\r\n    attr.setUsage(DynamicDrawUsage);\r\n    return attr;\r\n  }\r\n\r\n  public readonly mesh: Mesh;\r\n\r\n  constructor(public world: World) {\r\n    this.mesh = new Mesh(this.geometry, newTileShaderMaterial());\r\n    this.mesh.name = \"TileBatcher Mesh\";\r\n    this.mesh.frustumCulled = false;\r\n    this.mesh.matrixAutoUpdate = false;\r\n    this.mesh.updateMatrixWorld();\r\n\r\n    for (const prop in this) {\r\n      const v = this[prop];\r\n      if (v instanceof InstancedBufferAttribute) {\r\n        this.geometry.setAttribute(prop, v);\r\n      }\r\n    }\r\n  }\r\n\r\n  private instances = new Map<string, BatchInstance>();\r\n\r\n  // getInstance(layer: number, pos: Vector2) {\r\n  getBatchInstance(tile: Tile) {\r\n    const pos = tile.pos;\r\n    const layer = tile instanceof Cell ? 1 : 0;\r\n    const layerOffset = (layer * this.maxTiles) / 2;\r\n    const positionOffset = pos.y * this.world.width + pos.x;\r\n    const index = layerOffset + positionOffset;\r\n    if (!Number.isInteger(index)) {\r\n      console.error(\"index \" + index + \" is not integer!\");\r\n    }\r\n    const key = String(index);\r\n    if (!this.instances.has(key)) {\r\n      this.instances.set(key, new BatchInstance(this, index));\r\n    }\r\n    const instance = this.instances.get(key)!;\r\n    instance.checkout(tile);\r\n    return instance;\r\n  }\r\n\r\n  endFrame() {\r\n    for (const prop in this) {\r\n      const v = this[prop];\r\n      if (v instanceof InstancedBufferAttribute) {\r\n        v.needsUpdate = true;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nconst BLACK = new Color(0, 0, 0);\r\nconst ZERO = new Vector3(0, 0, 0);\r\nexport class BatchInstance {\r\n  public readonly batcher: TileBatcher;\r\n\r\n  public readonly index: number;\r\n\r\n  private static numInUse = 0;\r\n\r\n  private owner?: object;\r\n\r\n  constructor(batcher: TileBatcher, index: number) {\r\n    this.batcher = batcher;\r\n    this.index = index;\r\n  }\r\n\r\n  checkout(owner: object) {\r\n    if (this.owner != null) {\r\n      // throw new Error(\"Checking out instance that's already in use!\" + this.index);\r\n      console.warn(\"Checking out instance that's already in use!\", this.index, owner);\r\n    }\r\n    this.owner = owner;\r\n    BatchInstance.numInUse++;\r\n  }\r\n\r\n  commitColor(color: Color) {\r\n    if (!this.owner) {\r\n      console.error(\"freed tileBatcher still in use!\");\r\n    }\r\n    this.batcher.colors.setXYZ(this.index, color.r, color.g, color.b);\r\n  }\r\n\r\n  commitTemperature(temperature: number) {\r\n    if (!this.owner) {\r\n      console.error(\"freed tileBatcher still in use!\");\r\n    }\r\n    this.batcher.temperatures.setX(this.index, temperature);\r\n  }\r\n\r\n  commitCenter(x: number, y: number, z: number) {\r\n    if (!this.owner) {\r\n      console.error(\"freed tileBatcher still in use!\");\r\n    }\r\n    this.batcher.centers.setXYZ(this.index, x, y, z);\r\n  }\r\n\r\n  commitScale(scale: Vector3) {\r\n    if (!this.owner) {\r\n      console.error(\"freed tileBatcher still in use!\");\r\n    }\r\n    this.batcher.scales.setXYZ(this.index, scale.x, scale.y, scale.z);\r\n  }\r\n\r\n  commitTexturePosition(pos: Vector2) {\r\n    this.batcher.texturePositions.setXY(this.index, pos.x, pos.y);\r\n  }\r\n\r\n  commitAlpha(alpha: number) {\r\n    this.batcher.alphas.setX(this.index, alpha);\r\n  }\r\n\r\n  destroy() {\r\n    this.commitColor(BLACK);\r\n    this.commitScale(ZERO);\r\n    this.owner = undefined;\r\n    BatchInstance.numInUse--;\r\n  }\r\n}\r\n\r\nexport default TileBatcher;\r\n","import { createSelector } from \"reselect\";\r\nimport { Scene } from \"three\";\r\nimport { Entity, Player, PlayerSeed, StepStats, World } from \"../../core\";\r\nimport { Tile } from \"../../core/tile\";\r\nimport Mito from \"../mito/mito\";\r\nimport { EventLogRenderer } from \"./events/eventLogRenderer\";\r\nimport { InventoryPoints } from \"./InventoryRenderer\";\r\nimport { PlayerRenderer } from \"./PlayerRenderer\";\r\nimport { PlayerSeedRenderer } from \"./PlayerSeedRenderer\";\r\nimport { Renderer } from \"./Renderer\";\r\nimport { InstancedTileRenderer } from \"./tile/InstancedTileRenderer\";\r\nimport TileBatcher from \"./tile/tileBatcher\";\r\n\r\nexport class WorldRenderer extends Renderer<World> {\r\n  public renderers = new Map<Entity, Renderer<Entity>>();\r\n\r\n  public readonly tileBatcher: TileBatcher;\r\n\r\n  // private lightEmitter: LightEmitter;\r\n  public eventLogRenderer?: EventLogRenderer;\r\n\r\n  public inventoryPoints?: InventoryPoints;\r\n\r\n  constructor(target: World, scene: Scene, mito: Mito, public renderResources = true) {\r\n    super(target, scene, mito);\r\n\r\n    // must be added before all particles\r\n    this.tileBatcher = new TileBatcher(this.target);\r\n    scene.add(this.tileBatcher.mesh);\r\n\r\n    this.inventoryPoints = new InventoryPoints();\r\n    scene.add(this.inventoryPoints.waters);\r\n    scene.add(this.inventoryPoints.sugars);\r\n    this.eventLogRenderer = new EventLogRenderer(this);\r\n    if (renderResources) {\r\n    }\r\n    // this.lightEmitter = new LightEmitter(this);\r\n  }\r\n\r\n  public getOrCreateRenderer(entity: Entity) {\r\n    const renderer = this.renderers.get(entity);\r\n    if (renderer == null) {\r\n      const created = this.createRendererFor(entity);\r\n      if (created) {\r\n        this.renderers.set(entity, created);\r\n        return created;\r\n      }\r\n    } else {\r\n      return renderer;\r\n    }\r\n  }\r\n\r\n  public createRendererFor<E extends Entity>(object: E): Renderer<Entity> | null {\r\n    if (object instanceof Player) {\r\n      return new PlayerRenderer(object, this.scene, this.mito);\r\n    } else if (object instanceof PlayerSeed) {\r\n      return new PlayerSeedRenderer(object, this.scene, this.mito);\r\n    } else if (object instanceof Tile) {\r\n      return new InstancedTileRenderer(object, this.scene, this.mito, this.tileBatcher, this);\r\n    } else {\r\n      console.error(`Couldn't find renderer for`, object);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private deleteDeadEntityRenderers = createSelector(\r\n    (stats: StepStats) => stats,\r\n    (stats) => {\r\n      const deletedEntities = stats.deleted;\r\n\r\n      for (const e of deletedEntities) {\r\n        const renderer = this.renderers.get(e);\r\n        if (renderer == null) {\r\n          console.warn(`Couldn't find renderer for ${e}!`);\r\n          continue;\r\n        }\r\n        renderer.destroy();\r\n        this.renderers.delete(e);\r\n      }\r\n    }\r\n  );\r\n\r\n  update(): void {\r\n    this.deleteDeadEntityRenderers(this.target.getLastStepStats());\r\n    // this.lightEmitter.update(1 / 30);\r\n\r\n    // careful - event log renderers rely on state from other renderers (e.g. position\r\n    // of water particle as it's evaporating) that requires it to update before others\r\n    if (this.eventLogRenderer) {\r\n      this.eventLogRenderer.update();\r\n    }\r\n\r\n    this.inventoryPoints?.startFrame();\r\n    this.target.entities().forEach((entity) => {\r\n      const renderer = this.getOrCreateRenderer(entity);\r\n      renderer?.update();\r\n    });\r\n    this.inventoryPoints?.endFrame();\r\n    this.tileBatcher.endFrame();\r\n  }\r\n\r\n  destroy(): void {\r\n    throw new Error(\"Method not implemented.\");\r\n  }\r\n}\r\n","import { TIME_PER_DAY } from \"core/constants\";\r\nimport { Tile } from \"core/tile\";\r\nimport Mito from \"game/mito/mito\";\r\nimport { WorldRenderer } from \"game/renderers/WorldRenderer\";\r\nimport { map } from \"math\";\r\n// import { createRendererFor } from \"sketches/mito/renderers/WorldRenderer\";\r\nimport { OrthographicCamera, Scene, Vector2, WebGLRenderTarget } from \"three\";\r\n\r\n/**\r\n * A Vignette is a visual snapshot of a plant at a specific stage of growth. It's actually\r\n * just an image.\r\n *\r\n * You can control:\r\n *   How big the vignette is.\r\n */\r\nclass VignetteCapturer {\r\n  static renderTarget = new WebGLRenderTarget(1024, 1024);\r\n\r\n  static rtBuffer = new Uint8Array(VignetteCapturer.renderTarget.width * VignetteCapturer.renderTarget.height * 4);\r\n\r\n  static rtCanvas = (() => {\r\n    const c = document.createElement(\"canvas\");\r\n    c.width = VignetteCapturer.renderTarget.width;\r\n    c.height = VignetteCapturer.renderTarget.height;\r\n    return c;\r\n  })();\r\n\r\n  private lastCaptureTime: number = 0;\r\n\r\n  public constructor(public readonly mito: Mito, public pxPerTile = 32, public captureInterval = TIME_PER_DAY) {}\r\n\r\n  isTimeForNewCapture() {\r\n    return this.mito.world.time - this.lastCaptureTime > this.captureInterval;\r\n  }\r\n\r\n  capture() {\r\n    const { renderTarget, rtBuffer, rtCanvas } = VignetteCapturer;\r\n    this.lastCaptureTime = this.mito.world.time;\r\n\r\n    // Cells that form the vignette:\r\n    const picturesqueCells = Array.from(this.mito.world.allCells());\r\n    // .filter(\r\n    //   (t) => t.pos.y < t.world.height / 2 && !(t instanceof GrowingCell)\r\n    // );\r\n\r\n    const [minBounds, maxBounds] = this.getBounds(picturesqueCells);\r\n\r\n    // add all renderers to a scene\r\n    const scene = new Scene();\r\n    const worldRenderer = new WorldRenderer(this.mito.world, scene, this.mito, false);\r\n    const picturesqueRenderers = picturesqueCells.map((c) => {\r\n      const renderer = worldRenderer.createRendererFor(c);\r\n      renderer?.update();\r\n      return renderer;\r\n    });\r\n\r\n    worldRenderer.tileBatcher.endFrame();\r\n\r\n    // webgl render to a renderTarget\r\n    const camera = this.cameraEncompassingBounds([minBounds, maxBounds]);\r\n    const { renderer } = this.mito;\r\n    renderer.setRenderTarget(renderTarget);\r\n    renderer.clear(true, true, true);\r\n    renderer.render(scene, camera);\r\n    renderer.setRenderTarget(null);\r\n\r\n    // buffer will now contain [r1, g1, b1, a1, r2, g2, b2, a2, ...]\r\n    renderer.readRenderTargetPixels(renderTarget, 0, 0, renderTarget.width, renderTarget.height, rtBuffer);\r\n\r\n    // copy buffer pixels into the full resolution canvas\r\n    const context = rtCanvas.getContext(\"2d\")!;\r\n    const imageData: ImageData = context.createImageData(rtCanvas.width, rtCanvas.height);\r\n    const imageBuffer = imageData.data;\r\n    for (let i = 0; i < rtBuffer.length; i++) {\r\n      imageBuffer[i] = rtBuffer[i];\r\n    }\r\n    context.putImageData(imageData, 0, 0);\r\n\r\n    const boundsWidth = maxBounds.x - minBounds.x;\r\n    const boundsHeight = maxBounds.y - minBounds.y;\r\n    const maxDimension = Math.max(boundsWidth, boundsHeight);\r\n\r\n    const roiWidth = map(boundsWidth, 0, maxDimension, 0, 1024);\r\n    const roiHeight = map(boundsHeight, 0, maxDimension, 0, 1024);\r\n    const roiTopLeft = new Vector2(512 - roiWidth / 2, 512 - roiHeight / 2);\r\n\r\n    const dest = document.createElement(\"canvas\");\r\n    dest.width = Math.ceil(boundsWidth * this.pxPerTile);\r\n    dest.height = Math.ceil(boundsHeight * this.pxPerTile);\r\n    const destContext = dest.getContext(\"2d\")!;\r\n    destContext.drawImage(rtCanvas, roiTopLeft.x, roiTopLeft.y, roiWidth, roiHeight, 0, 0, dest.width, dest.height);\r\n\r\n    const img = new Image();\r\n    img.src = dest.toDataURL();\r\n    // debug\r\n    // document.body.appendChild(img);\r\n\r\n    picturesqueRenderers.forEach((t) => {\r\n      t?.destroy();\r\n    });\r\n    return dest;\r\n  }\r\n\r\n  getBounds(tiles: Tile[]): [Vector2, Vector2] {\r\n    const min = new Vector2();\r\n    const max = new Vector2();\r\n    if (tiles[0] != null) {\r\n      min.copy(tiles[0].pos);\r\n      max.copy(tiles[0].pos);\r\n    }\r\n    for (const t of tiles) {\r\n      min.min(t.pos);\r\n      max.max(t.pos);\r\n    }\r\n    // .pos is the center; pad to the edges of each tile\r\n    min.subScalar(0.5);\r\n    max.addScalar(0.5);\r\n    return [min, max];\r\n  }\r\n\r\n  private cameraEncompassingBounds([min, max]: [Vector2, Vector2]) {\r\n    const center = min.clone().lerp(max, 0.5);\r\n\r\n    const width = max.x - min.x;\r\n    const height = max.y - min.y;\r\n\r\n    // now that we know the bounding box, we want the camera to fit that bounding\r\n    // box perfectly while maintaining the aspect ratio of the renderTarget.\r\n    const largerDim = Math.max(width, height);\r\n    const camera = new OrthographicCamera(\r\n      center.x - largerDim / 2,\r\n      center.x + largerDim / 2,\r\n      center.y + largerDim / 2,\r\n      center.y - largerDim / 2,\r\n      -100,\r\n      100\r\n    );\r\n    return camera;\r\n  }\r\n}\r\n\r\nexport default VignetteCapturer;\r\n","import { Cell } from \"../core/tile\";\r\nimport { World } from \"../core/world/world\";\r\nimport Mito from \"./mito/mito\";\r\n\r\nexport interface GameResult {\r\n  status: \"won\" | \"lost\";\r\n  mpEarners: Map<Cell, number>;\r\n  /**\r\n   * Computed - sum of mpEarners.\r\n   */\r\n  mutationPointsPerEpoch: number;\r\n  world: World;\r\n  vignettes?: HTMLCanvasElement[];\r\n}\r\n\r\nexport function maybeGetGameResult(mito: Mito): GameResult | null {\r\n  const { world } = mito;\r\n  let anyCellsAlive = false || world.playerSeed != null;\r\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n  for (const cell of world.allCells()) {\r\n    anyCellsAlive = true;\r\n    break;\r\n  }\r\n  // const isStandingOnDeadCell = this.tileAt(this.player.pos.x, this.player.pos.y) instanceof DeadCell;\r\n  // const isTimePastOneYear = this.time >= TIME_PER_YEAR;\r\n  // const shouldGameEnd = isStandingOnDeadCell;\r\n  const shouldGameEnd = !anyCellsAlive;\r\n  if (!shouldGameEnd) {\r\n    return null;\r\n  }\r\n\r\n  // make a decision\r\n  return getDecidedGameResult(mito);\r\n}\r\n\r\nexport function getDecidedGameResult(mito: Mito): GameResult {\r\n  const { world, vignettes } = mito;\r\n  const matureEarners = Array.from(world.mpEarners.entries()).filter(([f, mpEarned]) => mpEarned > 0);\r\n  const shouldWin = matureEarners.length > 0;\r\n\r\n  return {\r\n    mpEarners: world.mpEarners,\r\n    mutationPointsPerEpoch: matureEarners.map(([, mp]) => mp).reduce((a, b) => a + b, 0),\r\n    status: shouldWin ? \"won\" : \"lost\",\r\n    vignettes,\r\n    world,\r\n  };\r\n}\r\n","import { DIRECTIONS } from \"../../core/directions\";\r\nimport { Action, ActionMove } from \"../../core/player/action\";\r\n\r\nexport const ACTION_CONTINUOUS_KEYMAP: { [key: string]: Action } = {\r\n  // Space: {\r\n  //   type: \"pickup\",\r\n  //   sugar: 30,\r\n  //   water: 30,\r\n  // },\r\n};\r\n\r\nexport const ACTION_INSTANT_KEYMAP: { [key: string]: Action } = {\r\n  // KeyQ: {\r\n  //   type: \"drop\",\r\n  //   sugar: 0,\r\n  //   water: 5,\r\n  // },\r\n  // KeyE: {\r\n  //   type: \"drop\",\r\n  //   sugar: 1,\r\n  //   water: 0,\r\n  // },\r\n};\r\n\r\nexport const MOVEMENT_KEYS: { [key: string]: ActionMove } = {\r\n  KeyW: {\r\n    type: \"move\",\r\n    dir: DIRECTIONS.n,\r\n  },\r\n  KeyA: {\r\n    type: \"move\",\r\n    dir: DIRECTIONS.w,\r\n  },\r\n  KeyS: {\r\n    type: \"move\",\r\n    dir: DIRECTIONS.s,\r\n  },\r\n  KeyD: {\r\n    type: \"move\",\r\n    dir: DIRECTIONS.e,\r\n  },\r\n};\r\n\r\nexport const MOVEMENTS = Object.keys(MOVEMENT_KEYS).map((key) => MOVEMENT_KEYS[key]);\r\n","import { Cell } from \"core/cell\";\r\nimport { ActionMove, isContinuous } from \"core/player/action\";\r\nimport { Vector2 } from \"three\";\r\nimport { Mito } from \"../mito/mito\";\r\nimport Keyboard from \"./keyboard\";\r\nimport { ACTION_CONTINUOUS_KEYMAP, ACTION_INSTANT_KEYMAP, MOVEMENT_KEYS } from \"./keymap\";\r\n\r\nexport interface ControlScheme {\r\n  animate(ms: number): void;\r\n\r\n  destroy(): void;\r\n\r\n  wouldLeftClickInteract(): boolean;\r\n}\r\n\r\nexport class PlayerControlScheme implements ControlScheme {\r\n  public constructor(public mito: Mito) {\r\n    window.addEventListener(\"keydown\", this.handleKeyDown);\r\n    window.addEventListener(\"mousedown\", this.handleMouseDown);\r\n  }\r\n\r\n  destroy() {\r\n    window.removeEventListener(\"keydown\", this.handleKeyDown);\r\n    window.removeEventListener(\"mousedown\", this.handleMouseDown);\r\n  }\r\n\r\n  handleMouseDown = (event: MouseEvent) => {\r\n    // control inspectedCell on click\r\n    if (event.target === this.mito.canvas) {\r\n      if (this.mito.isPaused) {\r\n        if (event.button === 0) {\r\n          this.mito.pausedInspectedTile = this.mito.getTileAtScreen();\r\n        } else if (event.button === 2) {\r\n          this.mito.pausedInspectedTile = undefined;\r\n        }\r\n        return;\r\n      }\r\n      if (this.mito.inspectedCell != null) {\r\n        this.mito.inspectedCell = undefined;\r\n        return;\r\n      }\r\n      if (event.button === 0) {\r\n        this.leftClick();\r\n      } else if (event.button === 2) {\r\n        this.rightClick();\r\n      }\r\n    }\r\n  };\r\n\r\n  animate(_ms: number) {\r\n    const { mito } = this;\r\n    // keyboard actions\r\n    const moveAction = this.keysToMovement(Keyboard.keyMap);\r\n    if (moveAction) {\r\n      mito.world.player.setAction(moveAction);\r\n    }\r\n    for (const key of Keyboard.keyMap) {\r\n      if (ACTION_CONTINUOUS_KEYMAP[key]) {\r\n        mito.world.player.setAction(ACTION_CONTINUOUS_KEYMAP[key]);\r\n      }\r\n    }\r\n\r\n    // mouse actions\r\n    switch (this.mito.mouse.button) {\r\n      case 0:\r\n        this.leftClickHold();\r\n        break;\r\n    }\r\n  }\r\n\r\n  handleKeyDown = (event: KeyboardEvent) => {\r\n    const { mito } = this;\r\n    const code = event.code;\r\n    if (!event.repeat) {\r\n      if (code === \"Space\") {\r\n        mito.isPaused = !mito.isPaused;\r\n        return;\r\n      }\r\n      if (ACTION_INSTANT_KEYMAP[code]) {\r\n        mito.world.player.setAction(ACTION_INSTANT_KEYMAP[code]);\r\n      } else if (mito.inspectedCell != null && code === \"Escape\") {\r\n        mito.inspectedCell = undefined;\r\n      }\r\n    }\r\n    mito.toolBar.keyDown(event);\r\n  };\r\n\r\n  public keysToMovement(keys: Set<string>): ActionMove | null {\r\n    const dir = new Vector2();\r\n    for (const key of keys) {\r\n      if (MOVEMENT_KEYS[key]) {\r\n        dir.add(MOVEMENT_KEYS[key].dir);\r\n      }\r\n    }\r\n    if (dir.x === 0 && dir.y === 0) {\r\n      return null;\r\n    } else {\r\n      return {\r\n        type: \"move\",\r\n        dir,\r\n      };\r\n    }\r\n  }\r\n\r\n  public leftClick() {\r\n    // no-op for left-clicking\r\n    const { mito } = this;\r\n    const target = mito.highlightedTile;\r\n    if (target == null) {\r\n      return;\r\n    }\r\n    const action = mito.toolBar.leftClick(target);\r\n    if (action != null && !isContinuous(action)) {\r\n      mito.world.player.setAction(action);\r\n    }\r\n  }\r\n\r\n  public rightClick() {\r\n    const tile = this.mito.highlightedTile;\r\n    if (tile == null) {\r\n      return;\r\n    }\r\n    if (tile instanceof Cell) {\r\n      // HACK stop movement\r\n      Keyboard.keyMap.delete(\"KeyW\");\r\n      Keyboard.keyMap.delete(\"KeyS\");\r\n      Keyboard.keyMap.delete(\"KeyA\");\r\n      Keyboard.keyMap.delete(\"KeyD\");\r\n      this.mito.inspectedCell = tile;\r\n    }\r\n  }\r\n\r\n  public leftClickHold() {\r\n    const { mito } = this;\r\n    const target = mito.highlightedTile;\r\n    if (target == null) {\r\n      return;\r\n    }\r\n    const action = mito.toolBar.leftClick(target);\r\n    if (action != null && isContinuous(action)) {\r\n      mito.world.player.setAction(action);\r\n    }\r\n  }\r\n\r\n  public wouldLeftClickInteract() {\r\n    const { mito } = this;\r\n    const tile = mito.highlightedTile;\r\n    // return tile != null && mito.actionBar.leftClick(tile)?.type === \"interact\";\r\n    const type = tile && mito.toolBar.leftClick(tile)?.type;\r\n    return type === \"pickup\" || type === \"drop\";\r\n  }\r\n}\r\n\r\nexport class PlayerSeedControlScheme implements ControlScheme {\r\n  handleKeyDown = (event: KeyboardEvent) => {\r\n    if (event.code === \"Space\") {\r\n      this.popOut();\r\n    }\r\n  };\r\n\r\n  constructor(public mito: Mito) {\r\n    window.addEventListener(\"keydown\", this.handleKeyDown);\r\n  }\r\n\r\n  destroy() {\r\n    window.removeEventListener(\"keydown\", this.handleKeyDown);\r\n  }\r\n\r\n  animate(_ms: number): void {\r\n    if (this.mito.mouse.button === 0) {\r\n      this.handleLeftClick();\r\n    }\r\n  }\r\n\r\n  public popOut() {\r\n    if (this.mito.world.playerSeed && this.mito.world.time > 3) {\r\n      this.mito.world.playerSeed!.popOut();\r\n      this.mito.controls = new PlayerControlScheme(this.mito);\r\n    }\r\n  }\r\n\r\n  public handleLeftClick(): void {\r\n    if (this.mito.highlightedPosition) {\r\n      const clickedPos = this.mito.highlightedPosition.round();\r\n      if (this.mito.world.playerSeed!.pos.distanceTo(clickedPos) < 0.5) {\r\n        this.popOut();\r\n      }\r\n    }\r\n  }\r\n\r\n  public wouldLeftClickInteract() {\r\n    return false;\r\n  }\r\n}\r\n","import { CellType } from \"core/cell\";\r\nimport { CellArgs } from \"../../core/cell/cell\";\r\nimport { isInteractable } from \"../../core/interactable\";\r\nimport { Action, ActionBuild } from \"../../core/player/action\";\r\nimport { Tile } from \"../../core/tile\";\r\nimport Mito from \"../mito/mito\";\r\n\r\nexport class ToolBar {\r\n  static DIGIT_KEYS = [\"Digit1\", \"Digit2\", \"Digit3\", \"Digit4\", \"Digit5\", \"Digit6\", \"Digit7\", \"Digit8\"];\r\n\r\n  tools: Record<string, Tool> = {\r\n    KeyQ: TOOL_INTERACT,\r\n  };\r\n\r\n  public currentKey: string = \"KeyQ\";\r\n\r\n  constructor(public mito: Mito) {\r\n    const validCellTypes = mito.world.genome.cellTypes.filter((c) => c.getDuplicateGenes().size === 0);\r\n    for (const index in validCellTypes) {\r\n      const cellType = validCellTypes[index];\r\n      if (cellType.getDuplicateGenes().size === 0) {\r\n        const digitKey = ToolBar.DIGIT_KEYS[index];\r\n        this.tools[digitKey] = makeToolToBuildCellType(cellType);\r\n      }\r\n    }\r\n  }\r\n\r\n  isInteract() {\r\n    return this.currentTool === TOOL_INTERACT;\r\n  }\r\n\r\n  leftClick(target: Tile): Action | undefined {\r\n    return this.currentTool.leftClick(target);\r\n  }\r\n\r\n  rightClick(target: Tile): Action | undefined {\r\n    return this.currentTool.rightClick(target);\r\n  }\r\n\r\n  get currentTool() {\r\n    return this.tools[this.currentKey];\r\n  }\r\n\r\n  setKey(key: string) {\r\n    if (key in this.tools) {\r\n      const lastKey = this.currentKey;\r\n\r\n      // if you tap the same cellType twice, modify the args direction\r\n      if (key === lastKey) {\r\n        this.currentTool.nextConfiguration?.();\r\n      }\r\n      this.currentKey = key;\r\n    }\r\n  }\r\n\r\n  keyDown(event: KeyboardEvent) {\r\n    if (event.code === \"Escape\" && this.currentKey !== \"KeyQ\") {\r\n      this.setKey(\"KeyQ\");\r\n    } else if (this.shouldCapture(event)) {\r\n      this.setKey(event.code);\r\n    }\r\n  }\r\n\r\n  shouldCapture(event: KeyboardEvent) {\r\n    return !event.repeat && event.code in this.tools;\r\n  }\r\n}\r\n\r\nexport type Tool = ToolInteract | ToolBuild;\r\n\r\ninterface ToolBase {\r\n  name: string;\r\n  leftClick: (tile: Tile) => Action | undefined;\r\n  rightClick: (tile: Tile) => Action | undefined;\r\n  nextConfiguration?(): void;\r\n}\r\n\r\nexport interface ToolInteract extends ToolBase {\r\n  type: \"interact\";\r\n}\r\n\r\nexport interface ToolBuild extends ToolBase {\r\n  type: \"build\";\r\n  cellType: CellType;\r\n}\r\n\r\nconst TOOL_INTERACT: ToolInteract = {\r\n  name: \"Interact\",\r\n  type: \"interact\",\r\n  leftClick: (target: Tile): Action | undefined => (isInteractable(target) ? target.interact(null!) : undefined),\r\n  rightClick: (target: Tile): Action | undefined => ({\r\n    type: \"deconstruct\",\r\n    position: target.pos,\r\n  }),\r\n};\r\n\r\nfunction makeToolToBuildCellType(cellType: CellType): ToolBuild {\r\n  return {\r\n    name: cellType.name,\r\n    type: \"build\",\r\n    cellType,\r\n    leftClick(target: Tile) {\r\n      let args: CellArgs | undefined;\r\n      if (cellType.args) {\r\n        args = { ...cellType.args };\r\n      }\r\n\r\n      const action: ActionBuild = {\r\n        type: \"build\",\r\n        cellType,\r\n        position: target.pos.clone(),\r\n        args,\r\n      };\r\n      return action;\r\n    },\r\n    rightClick(tile: Tile) {\r\n      return undefined;\r\n    },\r\n    nextConfiguration() {\r\n      cellType.rotateArgDirection();\r\n    },\r\n  };\r\n}\r\n\r\n// function maybeDeconstructAction(tile: Tile): ActionDeconstruct | undefined {\r\n//   if (tile instanceof Cell && tile.isReproductive) {\r\n//     return undefined; // disallow deleting reproductive cells\r\n//   }\r\n//   return {\r\n//     type: \"deconstruct\",\r\n//     position: tile.pos,\r\n//   };\r\n// }\r\n","import classNames from \"classnames\";\r\nimport React, { useRef } from \"react\";\r\nimport { Vector2 } from \"three\";\r\nimport uuid from \"uuid\";\r\nimport { Tile } from \"../../core/tile\";\r\nimport { Mito } from \"./mito\";\r\n\r\nexport class WorldDOMElement {\r\n  uuid = uuid();\r\n\r\n  constructor(\r\n    public mito: Mito,\r\n    public positionFn: () => Vector2 | Tile | null,\r\n    public renderFn: () => React.ReactNode\r\n  ) {}\r\n\r\n  render() {\r\n    const posOrTile = this.positionFn();\r\n    if (posOrTile == null) {\r\n      return null;\r\n    }\r\n    let style: React.CSSProperties;\r\n    if (posOrTile instanceof Vector2) {\r\n      const pos = posOrTile;\r\n      const pixelPosition = this.mito.worldToScreen(pos);\r\n      const left = pixelPosition.x;\r\n      const top = pixelPosition.y;\r\n      style = {\r\n        left,\r\n        top,\r\n      };\r\n    } else {\r\n      const tile = posOrTile;\r\n      const worldTopLeft = tile.pos.clone().addScalar(-0.5);\r\n      const worldBottomRight = tile.pos.clone().addScalar(0.5);\r\n      const pixelTopLeft = this.mito.worldToScreen(worldTopLeft);\r\n      const pixelBottomRight = this.mito.worldToScreen(worldBottomRight);\r\n      const left = pixelTopLeft.x;\r\n      const top = pixelTopLeft.y;\r\n      const width = pixelBottomRight.x - left;\r\n      const height = pixelBottomRight.y - top;\r\n      style = {\r\n        left,\r\n        top,\r\n        width,\r\n        height,\r\n      };\r\n    }\r\n    return (\r\n      <div key={this.uuid} style={style}>\r\n        {this.renderFn()}\r\n      </div>\r\n    );\r\n  }\r\n}\r\n\r\nexport const WorldDOMComponent: React.FC<{\r\n  className?: string;\r\n  mito: Mito;\r\n  positionFn: () => Vector2 | Tile | null;\r\n}> = ({ className, children, mito, positionFn }) => {\r\n  const id = useRef(uuid());\r\n\r\n  const posOrTile = positionFn();\r\n  if (posOrTile == null) {\r\n    return null;\r\n  }\r\n  let style: React.CSSProperties;\r\n  if (posOrTile instanceof Vector2) {\r\n    const pos = posOrTile;\r\n    const pixelPosition = mito.worldToScreen(pos);\r\n    const left = pixelPosition.x;\r\n    const top = pixelPosition.y;\r\n    style = {\r\n      left,\r\n      top,\r\n    };\r\n  } else {\r\n    const tile = posOrTile;\r\n    const worldTopLeft = tile.pos.clone().addScalar(-0.5);\r\n    const worldBottomRight = tile.pos.clone().addScalar(0.5);\r\n    const pixelTopLeft = mito.worldToScreen(worldTopLeft);\r\n    const pixelBottomRight = mito.worldToScreen(worldBottomRight);\r\n    const left = pixelTopLeft.x;\r\n    const top = pixelTopLeft.y;\r\n    const width = pixelBottomRight.x - left;\r\n    const height = pixelBottomRight.y - top;\r\n    style = {\r\n      left,\r\n      top,\r\n      width,\r\n      height,\r\n    };\r\n  }\r\n\r\n  return (\r\n    <div key={id.current} style={style} className={classNames(\"world-dom-component\", className)}>\r\n      {children}\r\n    </div>\r\n  );\r\n};\r\n","import React from \"react\";\r\nimport Ticker from \"std/ticker\";\r\n\r\nexport class Animate extends React.Component<{\r\n  a: (time: number) => void;\r\n}> {\r\n  private rafid?: number;\r\n\r\n  private animate = (time: number) => {\r\n    this.props.a(time / 1000);\r\n  };\r\n\r\n  render() {\r\n    return null;\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.rafid = Ticker.addAnimation(this.animate);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    if (this.rafid) {\r\n      Ticker.removeAnimation(this.rafid);\r\n    }\r\n  }\r\n}\r\n","import * as React from \"react\";\r\n\r\ninterface SceneObjectProps {\r\n  object: THREE.Object3D;\r\n  parent: THREE.Object3D;\r\n  // children?: SceneObject[];\r\n}\r\nexport class SceneObject extends React.PureComponent<SceneObjectProps, {}> {\r\n  // render() {\r\n  //     if (this.props.children) {\r\n  //         return <>\r\n  //             {\r\n  //                 this.props.children.map((child) => React.cloneElement(child, { parent: this.props.object }))\r\n  //             }\r\n  //         </>;\r\n  //     }\r\n  // }\r\n\r\n  render() {\r\n    return null;\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.props.parent.add(this.props.object);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.props.parent.remove(this.props.object);\r\n  }\r\n}\r\n","import * as React from \"react\";\r\nimport { Color, DoubleSide, Mesh, MeshBasicMaterial, PlaneBufferGeometry } from \"three\";\r\nimport { CellType } from \"../../../core/cell/genome\";\r\nimport { textureFromSpritesheet } from \"../../spritesheet\";\r\nimport { SceneObject } from \"./sceneObject\";\r\n\r\nexport const BUILD_BLUEPRINT = (() => {\r\n  const geometry = new PlaneBufferGeometry(1, 1);\r\n  const material = new MeshBasicMaterial({\r\n    side: DoubleSide,\r\n    color: 0xffffff,\r\n    transparent: true,\r\n    opacity: 0.5,\r\n  });\r\n  const mesh = new Mesh(geometry, material);\r\n  mesh.name = \"Build Blueprint\";\r\n  mesh.position.z = 1;\r\n  return mesh;\r\n})();\r\n\r\nexport interface BuildBlueprintProps {\r\n  x: number;\r\n  y: number;\r\n  cellType: CellType;\r\n  scene: THREE.Scene;\r\n}\r\n\r\nexport const BuildBlueprint: React.FC<BuildBlueprintProps> = ({ x, y, cellType, scene }) => {\r\n  const object = React.useMemo(() => BUILD_BLUEPRINT.clone(), []);\r\n\r\n  React.useEffect(() => {\r\n    object.position.x = x;\r\n    object.position.y = y;\r\n  }, [object.position.x, object.position.y, x, y]);\r\n\r\n  React.useEffect(() => {\r\n    const { material } = cellType;\r\n    const { color, texturePosition } = material;\r\n    const texture = textureFromSpritesheet(texturePosition.x, texturePosition.y);\r\n    const mat = object.material as MeshBasicMaterial;\r\n    mat.map = texture;\r\n    mat.color.set(color || new Color(1, 1, 1));\r\n    mat.needsUpdate = true;\r\n  }, [cellType, object.material]);\r\n\r\n  return <SceneObject object={object} parent={scene} />;\r\n};\r\n","import * as React from \"react\";\r\nimport * as THREE from \"three\";\r\nimport lazy from \"../../../common/lazy\";\r\nimport { SceneObject } from \"./sceneObject\";\r\n\r\nexport const POINT_HIGHLIGHT = lazy(() => {\r\n  const geometry = new THREE.CircleBufferGeometry(0.1, 20);\r\n  const material = new THREE.MeshBasicMaterial({\r\n    color: 0xffffff,\r\n    transparent: true,\r\n    opacity: 0.75,\r\n    side: THREE.DoubleSide,\r\n  });\r\n  const mesh = new THREE.Mesh(geometry, material);\r\n  mesh.position.z = 10;\r\n  return mesh;\r\n  // const edgesGeometry = new THREE.EdgesGeometry(geometry, 1); // or WireframeGeometry( geometry )\r\n  // const material = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.75 });\r\n  // const lineSegments = new THREE.LineSegments(edgesGeometry, material);\r\n  // lineSegments.position.z = 10;\r\n  // return lineSegments;\r\n});\r\n\r\nexport interface PointHighlightProps {\r\n  x: number;\r\n  y: number;\r\n  z?: number;\r\n  scene: THREE.Scene;\r\n}\r\n\r\nexport class PointHighlight extends React.PureComponent<PointHighlightProps, {}> {\r\n  private object = POINT_HIGHLIGHT().clone();\r\n\r\n  render() {\r\n    this.object.position.x = this.props.x;\r\n    this.object.position.y = this.props.y;\r\n    return (\r\n      <>\r\n        {/* <Animate a={((t) => this.object.scale.setScalar(Math.sin(t * 3.7) * 0.04 + 0.94))} /> */}\r\n        <SceneObject object={this.object} parent={this.props.scene} />\r\n      </>\r\n    );\r\n  }\r\n}\r\n","import * as React from \"react\";\r\nimport * as THREE from \"three\";\r\nimport lazy from \"../../../common/lazy\";\r\nimport { Animate } from \"./Animate\";\r\nimport { SceneObject } from \"./sceneObject\";\r\n\r\nexport const TILE_HIGHLIGHT = lazy(() => {\r\n  const geometry = new THREE.PlaneBufferGeometry(1, 1);\r\n  const edgesGeometry = new THREE.EdgesGeometry(geometry, 1); // or WireframeGeometry( geometry )\r\n  const material = new THREE.LineBasicMaterial({\r\n    color: 0xffffff,\r\n    transparent: true,\r\n    opacity: 0.75,\r\n  });\r\n  const lineSegments = new THREE.LineSegments(edgesGeometry, material);\r\n  lineSegments.position.z = 10;\r\n  return lineSegments;\r\n});\r\n\r\nexport interface TileHighlightProps {\r\n  x: number;\r\n  y: number;\r\n  scene: THREE.Scene;\r\n}\r\n\r\nexport class TileHighlight extends React.PureComponent<TileHighlightProps, {}> {\r\n  private object = TILE_HIGHLIGHT().clone();\r\n\r\n  render() {\r\n    this.object.position.x = this.props.x;\r\n    this.object.position.y = this.props.y;\r\n    return (\r\n      <>\r\n        <Animate a={(t) => this.object.scale.setScalar(Math.sin(t * 3.7) * 0.04 + 0.94)} />\r\n        <SceneObject object={this.object} parent={this.props.scene} />\r\n      </>\r\n    );\r\n  }\r\n}\r\n","import { World } from \"../core\";\r\nimport { Tile } from \"../core/tile\";\r\n\r\nexport function findBuildCandidateTiles(world: World, predicate?: (tile: Tile) => boolean) {\r\n  const entityPredicate: (tile: Tile) => boolean = (t) => world.player.isWalkable(t);\r\n  const candidates: Set<Tile> = new Set();\r\n  for (const entity of world.entities()) {\r\n    if (entity instanceof Tile && entityPredicate(entity)) {\r\n      for (const [, neighbor] of world.tileNeighbors(entity.pos)) {\r\n        if (world.player.canBuildAt(neighbor)) {\r\n          if (predicate == null) {\r\n            candidates.add(neighbor);\r\n          } else if (predicate(neighbor)) {\r\n            candidates.add(neighbor);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return candidates;\r\n}\r\n","import classNames from \"classnames\";\r\nimport Keyboard from \"game/input/keyboard\";\r\nimport { WorldDOMComponent } from \"game/mito/WorldDOMElement\";\r\nimport { BuildBlueprint, PointHighlight, TileHighlight } from \"game/renderers/r3\";\r\nimport * as React from \"react\";\r\nimport { findBuildCandidateTiles } from \"std/worldUtils\";\r\nimport { Tile } from \"../../../core/tile\";\r\nimport Mito from \"../../mito/mito\";\r\nimport \"./Hover.scss\";\r\n\r\ninterface HoverProps {\r\n  mito: Mito;\r\n}\r\n\r\nexport class Hover extends React.Component<HoverProps> {\r\n  get scene() {\r\n    return this.props.mito.scene;\r\n  }\r\n\r\n  public render() {\r\n    const isTakingLongAction = this.props.mito.world.player.isTakingLongAction();\r\n    const isUsingShift = Keyboard.keyMap.has(\"ShiftLeft\");\r\n    if (isTakingLongAction || isUsingShift) {\r\n      return null;\r\n    }\r\n    let { highlightedPosition, highlightedTile } = this.props.mito;\r\n    if (this.props.mito.isPaused) {\r\n      highlightedTile = this.props.mito.getTileAtScreen();\r\n    }\r\n    return (\r\n      <>\r\n        {highlightedPosition ? (\r\n          <PointHighlight x={highlightedPosition.x} y={highlightedPosition.y} scene={this.scene} />\r\n        ) : null}\r\n        {this.maybeRenderBuildBlueprint(highlightedTile)}\r\n        {this.maybeRenderTileHighlight(highlightedTile)}\r\n        {this.maybeRenderTutorialBuildHighlights(highlightedTile)}\r\n        {/* {this.maybeRenderPath()} */}\r\n      </>\r\n    );\r\n  }\r\n\r\n  public maybeRenderTileHighlight(tile?: Tile) {\r\n    if (tile == null) {\r\n      return;\r\n    }\r\n    const { mito } = this.props;\r\n    const leftClickType = mito.toolBar.leftClick(tile)?.type;\r\n    const showBuildBlueprint = leftClickType === \"pickup\" || leftClickType === \"drop\";\r\n    const tileHighlight = showBuildBlueprint ? (\r\n      <TileHighlight x={tile.pos.x} y={tile.pos.y} scene={this.props.mito.scene} />\r\n    ) : null;\r\n    return tileHighlight;\r\n  }\r\n\r\n  public maybeRenderBuildBlueprint(tile?: Tile) {\r\n    const { mito } = this.props;\r\n    if (tile == null || mito.isPaused) {\r\n      return;\r\n    }\r\n    const action = mito.toolBar.leftClick(tile);\r\n    if (action != null && action.type === \"build\") {\r\n      const isBuildValid = mito.world.player.canBuildAt(tile);\r\n      return (\r\n        <>\r\n          <WorldDOMComponent\r\n            className={classNames(\"build-drop-shadow\", { valid: isBuildValid })}\r\n            mito={mito}\r\n            positionFn={() => tile}\r\n          ></WorldDOMComponent>\r\n          <BuildBlueprint x={tile.pos.x} y={tile.pos.y} cellType={action.cellType} scene={this.props.mito.scene} />\r\n        </>\r\n      );\r\n    }\r\n  }\r\n\r\n  maybeRenderTutorialBuildHighlights(tile?: Tile) {\r\n    const { mito } = this.props;\r\n    if (tile == null || mito.isPaused || !mito.isFirstPlaythrough) {\r\n      return;\r\n    }\r\n    const action = mito.toolBar.leftClick(tile);\r\n    if (action != null && action.type === \"build\") {\r\n      const buildCandidateHighlights: JSX.Element[] = [];\r\n      for (const candidate of findBuildCandidateTiles(this.props.mito.world)) {\r\n        buildCandidateHighlights.push(\r\n          <TileHighlight\r\n            key={candidate.pos.x + \",\" + candidate.pos.y}\r\n            x={candidate.pos.x}\r\n            y={candidate.pos.y}\r\n            scene={this.scene}\r\n          />\r\n        );\r\n      }\r\n      return buildCandidateHighlights;\r\n    }\r\n  }\r\n}\r\n","import classNames from \"classnames\";\r\nimport * as React from \"react\";\r\n\r\ninterface HotkeyButtonProps extends React.HTMLProps<HTMLDivElement> {\r\n  hotkey: string;\r\n}\r\n\r\nexport function HotkeyButton({ hotkey, className, onClick, ...restProps }: HotkeyButtonProps) {\r\n  const handleClick = (e: React.MouseEvent<HTMLDivElement>) => {\r\n    onClick && onClick(e);\r\n    ensureCanvasFocus(e);\r\n  };\r\n  return (\r\n    <div className={classNames(\"mito-hud-button\", className)} onClick={handleClick} {...restProps}>\r\n      <span className=\"mito-hud-button-hotkey\">{hotkey}</span>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ensureCanvasFocus(e: React.SyntheticEvent<any>) {\r\n  e.preventDefault();\r\n  const canvas = document.getElementsByTagName(\"canvas\")[0];\r\n  canvas.focus();\r\n}\r\n","import classNames from \"classnames\";\r\nimport DynamicNumber from \"game/ui/common/DynamicNumber\";\r\nimport * as React from \"react\";\r\nimport { ResourceIcon } from \"../common/ResourceIcon\";\r\nimport \"./InventoryBar.scss\";\r\n\r\nexport const InventoryBar: React.FC<{\r\n  water: number;\r\n  sugar: number;\r\n  capacity: number;\r\n  format: \"text\" | \"icons\";\r\n  colored?: boolean;\r\n  capacityBasedWidth?: boolean;\r\n  className?: string;\r\n}> = React.memo(({ water, sugar, capacity, className, colored = true, format, capacityBasedWidth }) => {\r\n  if (capacity === 0) {\r\n    return null;\r\n  }\r\n  const waterPercent = water / capacity;\r\n  const sugarPercent = sugar / capacity;\r\n  const emptyPercent = 1 - (water + sugar) / capacity;\r\n  const waterStyles: React.CSSProperties = {\r\n    width: `${waterPercent * 100}%`,\r\n  };\r\n  const sugarStyles: React.CSSProperties = {\r\n    width: `${sugarPercent * 100}%`,\r\n  };\r\n  const emptyStyles: React.CSSProperties = {\r\n    width: `${emptyPercent * 100}%`,\r\n  };\r\n  const textElements =\r\n    format === \"text\" ? (\r\n      <>\r\n        <span className=\"text water\">\r\n          <DynamicNumber speed={0.5} value={water} /> water\r\n        </span>\r\n        &nbsp;\r\n        <span className=\"text sugar\">\r\n          <DynamicNumber speed={0.5} value={sugar} /> sugar\r\n        </span>\r\n      </>\r\n    ) : (\r\n      <>\r\n        {water > 0 || (water === 0 && sugar === 0) ? (\r\n          <span className=\"text water\">\r\n            {sugar > 0 ? <ResourceIcon name=\"water\" /> : null} <DynamicNumber speed={0.5} value={water} />\r\n          </span>\r\n        ) : null}\r\n        {sugar > 0 ? (\r\n          <span className=\"text sugar\">\r\n            <ResourceIcon name=\"sugar\" /> <DynamicNumber speed={0.5} value={sugar} />\r\n          </span>\r\n        ) : null}\r\n      </>\r\n    );\r\n\r\n  const barStyles: React.CSSProperties = {\r\n    width: capacityBasedWidth ? 10 * capacity : undefined,\r\n  };\r\n\r\n  return (\r\n    <div className={classNames(\"inventory-bar-container\", className)}>\r\n      <div className=\"inventory-bar\" style={barStyles}>\r\n        <div style={waterStyles} className=\"bar-water\"></div>\r\n        <div style={sugarStyles} className=\"bar-sugar\"></div>\r\n        <div style={emptyStyles} className=\"bar-empty\"></div>\r\n        {capacityBasedWidth ? <div className=\"markers\" /> : null}\r\n      </div>\r\n      <div className={classNames(\"inventory-text\", { colored })}>{textElements}</div>\r\n    </div>\r\n  );\r\n});\r\n","import { Tooltip } from \"@blueprintjs/core\";\r\nimport { Temperature, temperatureFor } from \"core/temperature\";\r\nimport { Tile } from \"core/tile\";\r\nimport { map } from \"math\";\r\nimport * as React from \"react\";\r\nimport \"./TemperatureGauge.scss\";\r\n\r\nconst COLOR_FOR_TEMPERATURE: Record<Temperature, string> = {\r\n  Freezing: \"darkblue\",\r\n  Cold: \"lightblue\",\r\n  Mild: \"lightgray\",\r\n  Hot: \"orange\",\r\n  Scorching: \"red\",\r\n};\r\n\r\nconst TemperatureGauge: React.FC<{ tile: Tile }> = ({ tile }) => {\r\n  const size = 30;\r\n\r\n  const temperatureScaleElements: JSX.Element[] = [];\r\n  for (let tempBarLow = 0; tempBarLow < 32 * 3; tempBarLow += 32 / 3) {\r\n    const tempBarHigh = tempBarLow + 32 / 3;\r\n    const tempBarMid = (tempBarLow + tempBarHigh) / 2;\r\n    const midAngle = map(tempBarMid, 0, 96, -210, 30);\r\n    const div = (\r\n      <div\r\n        key={midAngle}\r\n        className=\"temperature-scale\"\r\n        style={{\r\n          transform: `rotate(${midAngle}deg)`,\r\n          borderRight: `${size / 4}px solid ${COLOR_FOR_TEMPERATURE[temperatureFor(tempBarMid)]}`,\r\n        }}\r\n      />\r\n    );\r\n    temperatureScaleElements.push(div);\r\n  }\r\n\r\n  const tempAngle = map(tile.temperatureFloat, 0, 96, -210, 30);\r\n  return (\r\n    <Tooltip\r\n      content={\r\n        <>\r\n          <b>Temperature</b> seeps into your Cells from the outside.\r\n        </>\r\n      }\r\n    >\r\n      <div className=\"temperature-gauge\">\r\n        <div style={{ width: size, height: size }}>\r\n          {temperatureScaleElements}\r\n          <div className=\"temperature-pointer\" style={{ transform: `rotate(${tempAngle}deg)` }}></div>\r\n          <div className=\"temperature-label\">{tile.temperatureFloat.toFixed(0)}</div>\r\n        </div>\r\n      </div>\r\n    </Tooltip>\r\n  );\r\n};\r\n\r\nexport default TemperatureGauge;\r\n","/* eslint-disable jsx-a11y/accessible-emoji */\r\nimport { Tooltip } from \"@blueprintjs/core\";\r\nimport { nf } from \"common/formatters\";\r\nimport {\r\n  CancerEffect,\r\n  Cell,\r\n  CellEffectConstructor,\r\n  describeCellInteraction,\r\n  FreezeEffect,\r\n  Gene,\r\n  GeneInstance,\r\n  GrowingCell,\r\n} from \"core/cell\";\r\nimport { Air, Fountain, Soil, Tile } from \"core/tile\";\r\nimport Keyboard from \"game/input/keyboard\";\r\nimport * as React from \"react\";\r\nimport {\r\n  GeneFruit,\r\n  GeneLiving,\r\n  GeneOsmosis,\r\n  GenePhotosynthesis,\r\n  GeneSeed,\r\n  GeneSoilAbsorption,\r\n  PhotosynthesisState,\r\n  ReproducerState,\r\n  SoilAbsorptionState,\r\n} from \"std/genes\";\r\nimport { InventoryBar } from \"./InventoryBar\";\r\nimport TemperatureGauge from \"./TemperatureGauge\";\r\nimport \"./TileDetails.scss\";\r\n\r\ninterface TileDetailsProps {\r\n  tile?: Tile;\r\n}\r\n\r\nfunction formatSeconds(seconds: number, fractionDigits = 1) {\r\n  return `${Math.max(0, seconds).toFixed(fractionDigits)}s`;\r\n}\r\n\r\nexport class TileDetails extends React.Component<TileDetailsProps> {\r\n  public render() {\r\n    const { tile } = this.props;\r\n    if (!tile) {\r\n      return null;\r\n    }\r\n    return (\r\n      <div className=\"tile-details\">\r\n        {this.tileInfo(tile)}\r\n        {this.cellInfo(tile)}\r\n        {this.growingCellInfo(tile)}\r\n        {this.airInfo(tile)}\r\n        {this.soilInfo(tile)}\r\n        {this.fountainInfo(tile)}\r\n        {this.interactInfo(tile)}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private interactInfo(tile: Tile) {\r\n    if (tile instanceof Cell) {\r\n      const leftClickEl =\r\n        tile.type.interaction != null ? (\r\n          <div className=\"interact-info first\">Left click - {describeCellInteraction(tile.type.interaction)}.</div>\r\n        ) : null;\r\n      return (\r\n        <div className=\"interact-infos\">\r\n          {leftClickEl}\r\n          <div className=\"interact-info\">Right click - more options.</div>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  private cellInfo(tile: Tile) {\r\n    if (tile instanceof Cell) {\r\n      const living = tile.findGene(GeneLiving);\r\n      const secondsPerUpkeep = living?.props.secondsPerUpkeep;\r\n      const secondsRemaining = secondsPerUpkeep != null ? tile.energy * secondsPerUpkeep : null;\r\n      const secondsRemainingEl = secondsRemaining ? <>({Math.floor(secondsRemaining)} seconds remaining)</> : null;\r\n      const energyEl = (\r\n        <Tooltip content={\"Energy keeps your cell alive, and is used for cell operations.\"}>\r\n          <div className=\"info-energy\">\r\n            &nbsp;{nf(tile.energy * 100, 3)}% Energy {secondsRemainingEl}\r\n          </div>\r\n        </Tooltip>\r\n      );\r\n      return (\r\n        <>\r\n          {energyEl}\r\n          {Keyboard.keyMap.has(\"ShiftLeft\") ? <>Alive for {Math.floor(tile.age)} seconds.</> : null}\r\n          {tile.droopY * 200 > 1 ? <div className=\"info-cell\">{(tile.droopY * 200).toFixed(0)}% droop</div> : null}\r\n          {this.cellEffects(tile)}\r\n          {this.geneInfos(tile)}\r\n        </>\r\n      );\r\n    }\r\n  }\r\n\r\n  private geneInfos(cell: Cell) {\r\n    return (\r\n      <>\r\n        {cell.geneInstances.map((gene, index) => {\r\n          if (gene.isType(GeneSoilAbsorption)) {\r\n            return <React.Fragment key={index}>{this.soilAbsorptionInfo(gene.state)}</React.Fragment>;\r\n          } else if (gene.isType(GenePhotosynthesis)) {\r\n            return <React.Fragment key={index}>{this.photosynthesisInfo(gene.state)}</React.Fragment>;\r\n          } else if (gene.isType(GeneFruit) || gene.isType(GeneSeed)) {\r\n            return <React.Fragment key={index}>{this.reproducerInfo(gene)}</React.Fragment>;\r\n          } else if (gene.isType(GeneOsmosis)) {\r\n            return <React.Fragment key={index}>{this.osmosisInfo(gene.state)}</React.Fragment>;\r\n          } else {\r\n            return null;\r\n          }\r\n        })}\r\n      </>\r\n    );\r\n  }\r\n\r\n  private soilAbsorptionInfo(state: SoilAbsorptionState) {\r\n    return (\r\n      <div className=\"info-root\">\r\n        <div>Absorbs in {formatSeconds(state.cooldown)}.</div>\r\n        <div>{state.totalSucked.toFixed(1)} total water absorbed so far.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private osmosisInfo({ isOsmosising }: any) {\r\n    return isOsmosising ? <div className=\"info-osmosis\">Osmotic</div> : null;\r\n  }\r\n\r\n  private photosynthesisInfo(state: PhotosynthesisState) {\r\n    return (\r\n      <div className=\"info-leaf\">\r\n        <div>{(state.averageChancePerSecond * 100).toFixed(1)}% chance to photosynthesize per second.</div>\r\n        <div>{(1 / state.averageConversionRate).toFixed(2)} water per sugar.</div>\r\n        <div>{state.totalSugarProduced.toFixed(2)} total sugar produced so far.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private reproducerInfo(instance: GeneInstance<Gene<ReproducerState, any>>) {\r\n    const { state, props } = instance;\r\n    return (\r\n      <div>\r\n        {nf(state.energyRecieved, 3)}/{props.neededEnergy} energy absorbed.\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private airInfo(tile: Tile) {\r\n    if (tile instanceof Air) {\r\n      return (\r\n        <div className=\"info-air\">\r\n          <Tooltip content={\"Sunlight increases photosynthesis rate, and is affected by shadowing.\"}>\r\n            <div> {nf(tile.sunlight() * 100, 2)}%</div>\r\n          </Tooltip>\r\n          {/* <Tooltip content=\"Air quality \">\r\n            <div>\r\n              <GiDustCloud /> {nf((1 - tile.co2()) * 100, 2)}%\r\n            </div>\r\n          </Tooltip> */}\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  private soilInfo(tile: Tile) {\r\n    if (tile instanceof Soil) {\r\n      return (\r\n        <div className=\"info-soil\">\r\n          <Tooltip\r\n            content={\r\n              \"Deeper soil restricts water movement, is harder to see through, and is less affected by the outside temperature.\"\r\n            }\r\n          >\r\n            <div>Depth {tile.depth}.</div>\r\n          </Tooltip>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  private fountainInfo(tile: Tile) {\r\n    if (tile instanceof Fountain) {\r\n      return (\r\n        <div className=\"info-fountain\">\r\n          <div>{formatSeconds(tile.cooldown)} until next water.</div>\r\n          <div>{tile.waterRemaining} water left.</div>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  private tileInfo(tile: Tile) {\r\n    return (\r\n      <div className=\"info-tile\">\r\n        <div className=\"info-tile-row\">\r\n          <div className=\"info-tile-name\">{tile.displayName}</div>\r\n          <TemperatureGauge tile={tile} />\r\n          <Tooltip content=\"Inventory is how much water and sugar this Tile can hold.\">\r\n            <InventoryBar\r\n              water={tile.inventory.water}\r\n              sugar={tile.inventory.sugar}\r\n              capacity={tile.inventory.capacity}\r\n              format=\"icons\"\r\n              colored={false}\r\n              capacityBasedWidth\r\n            />\r\n          </Tooltip>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private cellEffects(cell: Cell) {\r\n    const { effects } = cell;\r\n    if (effects.length > 0) {\r\n      const descriptors = effects\r\n        .map((e) => {\r\n          const name = (e.constructor as CellEffectConstructor).displayName;\r\n          if (e instanceof FreezeEffect) {\r\n            return `${nf(e.percentFrozen * 100, 2)}% ${name}!`;\r\n          } else if (e instanceof CancerEffect) {\r\n            return `${name}! ${nf(e.timeToDuplicate, 2)}s until spread.`;\r\n          } else {\r\n            return name;\r\n          }\r\n        })\r\n        .join(\", \");\r\n      return <div className=\"info-cell-effects\">{descriptors}</div>;\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private growingCellInfo(tile: Tile) {\r\n    if (tile instanceof GrowingCell) {\r\n      return <div className=\"info-growing-cell\">{nf(tile.percentGrown * 100, 2)}% grown.</div>;\r\n    }\r\n  }\r\n}\r\n","import { Player } from \"core\";\r\nimport { Cell } from \"core/tile\";\r\nimport { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport \"./CellInspector.scss\";\r\n\r\nexport const CellInspector: React.FC<{\r\n  cell: Cell;\r\n  player: Player;\r\n  onDone: () => void;\r\n}> = ({ cell, player, onDone }) => {\r\n  return (\r\n    <>\r\n      <div className=\"cell-inspector left\">\r\n        {/* <div>\r\n          <h3>{cell.displayName}</h3>\r\n        </div> */}\r\n        <div className=\"buttons\">\r\n          <div className=\"resources\">\r\n            <div className=\"resource-row\">\r\n              <button\r\n                disabled={player.inventory.water === 0}\r\n                onMouseUpCapture={(e) => {\r\n                  player.inventory.give(cell.inventory, cell.inventory.space(), 0);\r\n                  e.preventDefault();\r\n                  e.stopPropagation();\r\n                  onDone();\r\n                }}\r\n              >\r\n                Give&nbsp;\r\n                <ResourceIcon name=\"water\" />\r\n              </button>\r\n              <button\r\n                disabled={cell.inventory.water === 0}\r\n                onMouseUpCapture={(e) => {\r\n                  cell.inventory.give(player.inventory, cell.inventory.water, 0);\r\n                  e.preventDefault();\r\n                  e.stopPropagation();\r\n                  onDone();\r\n                }}\r\n              >\r\n                Take&nbsp;\r\n                <ResourceIcon name=\"water\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"resource-row\">\r\n              <button\r\n                disabled={player.inventory.sugar === 0}\r\n                onMouseUpCapture={(e) => {\r\n                  player.inventory.give(cell.inventory, 0, cell.inventory.space());\r\n                  e.preventDefault();\r\n                  e.stopPropagation();\r\n                  onDone();\r\n                }}\r\n              >\r\n                Give&nbsp;\r\n                <ResourceIcon name=\"sugar\" />\r\n              </button>\r\n              <button\r\n                disabled={cell.inventory.sugar === 0}\r\n                onMouseUpCapture={(e) => {\r\n                  cell.inventory.give(player.inventory, 0, cell.inventory.sugar);\r\n                  e.preventDefault();\r\n                  e.stopPropagation();\r\n                  onDone();\r\n                }}\r\n              >\r\n                Take&nbsp;\r\n                <ResourceIcon name=\"sugar\" />\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <div className=\"cell-inspector right\">\r\n        <button className=\"deconstruct\" onClick={() => player.setAction({ type: \"deconstruct\", position: cell.pos })}>\r\n          Deconstruct\r\n        </button>\r\n      </div>\r\n    </>\r\n  );\r\n};\r\n","import { Overlay, Tab, Tabs } from \"@blueprintjs/core\";\r\nimport { getDecidedGameResult } from \"game/gameResult\";\r\nimport React from \"react\";\r\nimport { FaArrowLeft } from \"react-icons/fa\";\r\nimport { GoGear } from \"react-icons/go\";\r\nimport \"./GameMenu.scss\";\r\nimport { HUDProps, useHotkey } from \"./HUD\";\r\n\r\nexport const GameMenu: React.FC<HUDProps> = ({ mito }) => {\r\n  const [isOpen, setIsOpen] = React.useState(false);\r\n  const handleOverlayClose = React.useCallback(() => {\r\n    setIsOpen(false);\r\n  }, []);\r\n  const handleGameMenuToggleClick = React.useCallback(() => {\r\n    setIsOpen(true);\r\n  }, []);\r\n  const toggleMenu = React.useCallback(() => setIsOpen((open) => !open), []);\r\n  const handleAbandonPlant = React.useCallback(() => {\r\n    mito.onWinLoss(getDecidedGameResult(mito));\r\n  }, [mito]);\r\n  useHotkey(\"Escape\", toggleMenu);\r\n\r\n  const menuPanel = (\r\n    <div>\r\n      <div className=\"option abandon\" onClick={handleAbandonPlant}>\r\n        Abandon Plant\r\n      </div>\r\n    </div>\r\n  );\r\n  if (mito.isFirstPlaythrough) {\r\n    return null;\r\n  }\r\n  return (\r\n    <>\r\n      <button className=\"game-menu-toggle game-options-button\" onClick={handleGameMenuToggleClick}>\r\n        <GoGear />\r\n      </button>\r\n      <Overlay\r\n        isOpen={isOpen}\r\n        onClose={handleOverlayClose}\r\n        canEscapeKeyClose={false}\r\n        canOutsideClickClose={false}\r\n        className=\"bp3-dark\"\r\n        backdropClassName=\"game-menu-backdrop\"\r\n      >\r\n        <div className=\"game-menu\">\r\n          <Tabs defaultSelectedTabId=\"menu\">\r\n            <div className=\"esc\" onClick={handleOverlayClose}>\r\n              <FaArrowLeft />\r\n            </div>\r\n            <Tab id=\"menu\" title=\"Menu\" panel={menuPanel} />\r\n            {/* <Tab id=\"attr\" title=\"Attribution\" panel={<Attribution />} /> */}\r\n          </Tabs>\r\n        </div>\r\n      </Overlay>\r\n    </>\r\n  );\r\n};\r\n\r\nconst Attribution = () => {\r\n  return (\r\n    <div className=\"attribution\">\r\n      <p>\r\n        In-game Tileset:{\" \"}\r\n        <a href=\"http://kenney.nl/assets?s=roguelike\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n          Kenney.nl Roguelike Assets\r\n        </a>\r\n      </p>\r\n      <p>\r\n        Photosynthesis pop sound:{\" \"}\r\n        <a href=\"http://soundbible.com/2067-Blop.html\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n          Blop by Mark DiAngelo\r\n        </a>{\" \"}\r\n        (<a href=\"https://creativecommons.org/licenses/by/3.0/us/\">CC BY 3.0 US</a>)\r\n      </p>\r\n      <p>\r\n        Fruit icon:{\" \"}\r\n        <a href=\"https://www.freepik.com/free-vector/fruits-set-pixel-icons_1001072.htm\">Designed by Freepik</a>\r\n      </p>\r\n      <p>\r\n        Part of 7drl 2018:{\" \"}\r\n        <a href=\"http://7drl.org/\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n          http://7drl.org/\r\n        </a>\r\n      </p>\r\n    </div>\r\n  );\r\n};\r\n","import classNames from \"classnames\";\r\nimport { WorldDOMComponent } from \"game/mito/WorldDOMElement\";\r\nimport { Button } from \"game/ui/common/Button\";\r\nimport * as React from \"react\";\r\nimport { DragDropContext } from \"react-beautiful-dnd\";\r\nimport { getDecidedGameResult } from \"../../../gameResult\";\r\nimport { PlayerSeedControlScheme } from \"../../../input/ControlScheme\";\r\nimport Mito from \"../../../mito/mito\";\r\nimport SpeciesViewer from \"../../SpeciesViewer\";\r\nimport { HotkeyButton } from \"../HotkeyButton\";\r\nimport { InventoryBar } from \"../InventoryBar\";\r\nimport { TileDetails } from \"../TileDetails\";\r\nimport { CellInspector } from \"./CellInspector\";\r\nimport { GameMenu } from \"./GameMenu\";\r\nimport \"./HUD.scss\";\r\nimport { InvalidActionMessage } from \"./InvalidActionMessage\";\r\nimport { PausedTileDetailsPopover } from \"./PausedTileDetailsPopover\";\r\nimport SeasonsTracker from \"./SeasonsTracker\";\r\nimport { ToolBarUI } from \"./ToolBarUI\";\r\nimport { Tutorial } from \"./Tutorial\";\r\n\r\nexport interface HUDProps {\r\n  mito: Mito;\r\n}\r\n\r\nexport interface HUDState {\r\n  traitsPanelOpen: boolean;\r\n  genomeViewerOpen: boolean;\r\n}\r\n\r\nexport class HUD extends React.Component<HUDProps, HUDState> {\r\n  state: HUDState = {\r\n    traitsPanelOpen: true,\r\n    genomeViewerOpen: false,\r\n  };\r\n\r\n  get mito() {\r\n    return this.props.mito;\r\n  }\r\n\r\n  get world() {\r\n    return this.mito.world;\r\n  }\r\n\r\n  get player() {\r\n    return this.world.player;\r\n  }\r\n\r\n  get inventory() {\r\n    return this.player.inventory;\r\n  }\r\n\r\n  componentDidMount() {\r\n    window.addEventListener(\"keydown\", this.handleKeyDown);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    window.removeEventListener(\"keydown\", this.handleKeyDown);\r\n  }\r\n\r\n  private handleKeyDown = (e: KeyboardEvent) => {\r\n    if (e.code === \"Tab\") {\r\n      this.setState({\r\n        genomeViewerOpen: !this.state.genomeViewerOpen,\r\n      });\r\n    }\r\n  };\r\n\r\n  public render() {\r\n    const isMaxed = this.inventory.isMaxed();\r\n    const isMaxedEl = <div className={`mito-inventory-maxed${isMaxed ? \" is-maxed\" : \"\"}`}>maxed</div>;\r\n    const showPlayerHUD = this.world.playerSeed == null;\r\n    const isFirstPlaythrough = this.mito.isFirstPlaythrough;\r\n    return (\r\n      <>\r\n        {!isFirstPlaythrough ? <div className=\"hex-title\">{this.mito.attempt.targetHex.displayName}</div> : null}\r\n        <div className={classNames(\"hud-top-center\")}>\r\n          <SeasonsTracker\r\n            time={this.world.time}\r\n            season={this.world.season}\r\n            temperature={this.world.weather.getCurrentTemperature()}\r\n          />\r\n        </div>\r\n        {this.maybeRenderMenu()}\r\n        {this.maybeRenderSpeciesViewer()}\r\n        {this.maybeRenderCollectButton()}\r\n        {this.maybeRenderWinShine()}\r\n        {this.maybeRenderGerminateButton()}\r\n        {this.maybeRenderPausedUI()}\r\n        {this.maybeRenderInvalidAction()}\r\n        {this.maybeRenderTutorial()}\r\n        <div className={classNames(\"hud-bottom-right\", { hidden: !showPlayerHUD })}>\r\n          {this.mito.isPaused ? (\r\n            this.mito.pausedInspectedTile ? null : (\r\n              <TileDetails tile={this.mito.getTileAtScreen()} />\r\n            )\r\n          ) : (\r\n            <TileDetails tile={this.mito.highlightedTile} />\r\n          )}\r\n          <div className=\"player-inventory-container\">\r\n            {isMaxedEl}\r\n            <InventoryBar\r\n              water={this.inventory.water}\r\n              sugar={this.inventory.sugar}\r\n              capacity={this.inventory.capacity}\r\n              format=\"icons\"\r\n              className=\"player-inventory-bar\"\r\n            />\r\n          </div>\r\n          <ToolBarUI bar={this.mito.toolBar} />\r\n        </div>\r\n        {this.maybeRenderCellInspector()}\r\n      </>\r\n    );\r\n  }\r\n\r\n  private positionFn = () => {\r\n    return this.mito.inspectedCell ?? null;\r\n  };\r\n\r\n  maybeRenderMenu() {\r\n    if (!this.mito.isFirstPlaythrough) {\r\n      return <GameMenu {...this.props} />;\r\n    }\r\n  }\r\n\r\n  maybeRenderCellInspector() {\r\n    const cell = this.mito.inspectedCell;\r\n    if (cell != null) {\r\n      return (\r\n        // <ReactModal\r\n        //   isOpen\r\n        //   ariaHideApp={false}\r\n        //   shouldCloseOnEsc\r\n        //   shouldCloseOnOverlayClick\r\n        //   onRequestClose={() => {\r\n        //     this.mito.inspectedCell = undefined;\r\n        //   }}\r\n        // >\r\n        <WorldDOMComponent mito={this.mito} positionFn={this.positionFn}>\r\n          <CellInspector cell={cell} player={this.player} onDone={this.handleCellInspectorDone} />\r\n        </WorldDOMComponent>\r\n      );\r\n    }\r\n  }\r\n\r\n  private handleCellInspectorDone = () => {\r\n    this.mito.inspectedCell = undefined;\r\n  };\r\n\r\n  maybeRenderInvalidAction() {\r\n    const invalidAction = this.mito.invalidAction;\r\n    if (invalidAction != null) {\r\n      return <InvalidActionMessage invalidAction={invalidAction} />;\r\n    }\r\n  }\r\n\r\n  maybeRenderGerminateButton() {\r\n    const showSeedHUD = this.world.playerSeed != null;\r\n    const popOutFn = () => {\r\n      const { controls } = this.mito;\r\n      if (controls instanceof PlayerSeedControlScheme) {\r\n        controls.popOut();\r\n      }\r\n    };\r\n    if (showSeedHUD) {\r\n      return (\r\n        <div className=\"hud-germinate\" onClick={popOutFn}>\r\n          <p>Germinate</p>\r\n          <HotkeyButton hotkey=\"Space\" onClick={popOutFn} />\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  maybeRenderCollectButton() {\r\n    const result = getDecidedGameResult(this.mito);\r\n    if (result.status === \"won\") {\r\n      return (\r\n        <div className=\"hud-right-of-time\">\r\n          <Button color=\"purple\" onClick={() => this.mito.onWinLoss(result)}>\r\n            Win (+ {result.mutationPointsPerEpoch} MP per epoch)\r\n          </Button>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  maybeRenderWinShine() {\r\n    const result = getDecidedGameResult(this.mito);\r\n    if (result.status === \"won\") {\r\n      return <div className=\"win-shine\"></div>;\r\n    }\r\n  }\r\n\r\n  maybeRenderSpeciesViewer() {\r\n    if (this.state.genomeViewerOpen) {\r\n      return (\r\n        <div className=\"hud-top\">\r\n          <DragDropContext onDragEnd={this.handleDragEnd}>\r\n            <SpeciesViewer speciesId={this.mito.world.species.id} />\r\n          </DragDropContext>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  maybeRenderPausedUI() {\r\n    if (this.mito.isPaused) {\r\n      const pausedInspectedTile = this.mito.pausedInspectedTile;\r\n      const mouseInstructions =\r\n        pausedInspectedTile == null ? (\r\n          <div className=\"mouse-position\" style={{ left: this.mito.mouse.position.x, top: this.mito.mouse.position.y }}>\r\n            <span className=\"click-to-inspect\">{pausedInspectedTile == null ? \"Click to inspect.\" : null}</span>\r\n          </div>\r\n        ) : null;\r\n      const popover =\r\n        pausedInspectedTile != null ? <PausedTileDetailsPopover mito={this.mito} tile={pausedInspectedTile} /> : null;\r\n\r\n      return (\r\n        <>\r\n          <div className=\"paused\">Paused</div>\r\n          {mouseInstructions}\r\n          {popover}\r\n        </>\r\n      );\r\n    }\r\n  }\r\n\r\n  maybeRenderTutorial() {\r\n    const showPlayerHUD = this.world.playerSeed == null;\r\n    if (this.mito.isFirstPlaythrough && showPlayerHUD) {\r\n      return <Tutorial {...this.props} />;\r\n    }\r\n  }\r\n\r\n  // no-op\r\n  private handleDragEnd = () => {};\r\n}\r\n\r\nexport function useHotkey(key: string, action: (event: KeyboardEvent) => void) {\r\n  React.useEffect(() => {\r\n    const cb = (event: KeyboardEvent) => {\r\n      if (key === event.code) {\r\n        action(event);\r\n      }\r\n    };\r\n    window.addEventListener(\"keyup\", cb);\r\n    return () => {\r\n      window.removeEventListener(\"keyup\", cb);\r\n    };\r\n  }, [action, key]);\r\n}\r\n","import * as React from \"react\";\r\nimport uuid from \"uuid\";\r\nexport const InvalidActionMessage: React.FC<{\r\n  invalidAction: {\r\n    message: string;\r\n  };\r\n}> = React.memo(({ invalidAction }) => {\r\n  // get new id on every render (aka reference equal invalidAction)\r\n  // to trigger animation each time\r\n  const id = uuid();\r\n  return (\r\n    <div className=\"hud-below-center\">\r\n      <div className=\"invalid-action\" key={id}>\r\n        {invalidAction.message}\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n","import { Popover } from \"@blueprintjs/core\";\r\nimport { Tile } from \"core/tile\";\r\nimport { WorldDOMComponent } from \"game/mito/WorldDOMElement\";\r\nimport React from \"react\";\r\nimport Mito from \"../../../mito/mito\";\r\nimport { TileDetails } from \"../TileDetails\";\r\n\r\nexport const PausedTileDetailsPopover = ({ mito, tile }: { mito: Mito; tile: Tile }) => {\r\n  const positionFn = React.useCallback(() => tile, [tile]);\r\n  return (\r\n    <WorldDOMComponent mito={mito} positionFn={positionFn} className=\"paused-popover\">\r\n      <Popover\r\n        content={<TileDetails key={tile.toString()} tile={tile} />}\r\n        usePortal={false}\r\n        autoFocus={false}\r\n        isOpen\r\n        minimal\r\n      >\r\n        <span />\r\n      </Popover>\r\n    </WorldDOMComponent>\r\n  );\r\n};\r\n","import { Tooltip } from \"@blueprintjs/core\";\r\nimport classNames from \"classnames\";\r\nimport { Temperature, temperatureFor } from \"core/temperature\";\r\nimport * as React from \"react\";\r\nimport { Season, SEASON_NAMES } from \"../../../../core\";\r\nimport \"./SeasonsTracker.scss\";\r\n\r\nconst temperatureTooltipContentMap = {\r\n  [Temperature.Freezing]: <>Cells may freeze! Cells operate 50% slower, you walk 50% slower.</>,\r\n  [Temperature.Cold]: <>Cells operate 33% slower, you walk 33% slower.</>,\r\n  [Temperature.Mild]: null,\r\n  [Temperature.Hot]: <>Cells operate 25% faster, you walk 25% faster.</>,\r\n  [Temperature.Scorching]: <>Cells evaporate water! Cells operate 50% faster, you walk 50% faster.</>,\r\n};\r\n\r\nconst timeTooltipContent = (\r\n  <>\r\n    There are sixty seconds per day.\r\n    <br />\r\n    <br />\r\n    There are three days per month.\r\n  </>\r\n);\r\n\r\nexport default function SeasonsTracker({\r\n  time,\r\n  season,\r\n  temperature,\r\n}: {\r\n  time: number;\r\n  season: Season;\r\n  temperature: number;\r\n}) {\r\n  const temperatureName = temperatureFor(temperature);\r\n  const temperatureTooltipContent = temperatureTooltipContentMap[temperatureName];\r\n  const temperatureElement =\r\n    temperatureTooltipContent != null ? (\r\n      <Tooltip content={temperatureTooltipContent}>\r\n        <div className={classNames(\"temperature-label\", temperatureName)}>\r\n          {temperature.toFixed(0)} - {temperatureName}\r\n        </div>\r\n      </Tooltip>\r\n    ) : (\r\n      <div className={classNames(\"temperature-label\", temperatureName)}>{temperature.toFixed(0)}</div>\r\n    );\r\n  return (\r\n    <div className=\"seasons-tracker\">\r\n      <div className=\"season-display\">\r\n        {season.year > 0 ? <>Year {season.year + 1}, </> : null}\r\n        {SEASON_NAMES[season.season]}, Month {season.month}\r\n        <br />\r\n        Day {season.day}\r\n        <br />\r\n        {temperatureElement}\r\n      </div>\r\n      <Tooltip content={timeTooltipContent}>\r\n        <div className=\"time\">{formatTime(time)}</div>\r\n      </Tooltip>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction formatTime(t: number) {\r\n  return new Date(1000 * t).toISOString().substr(14, 5);\r\n}\r\n","import classNames from \"classnames\";\r\nimport Keyboard from \"game/input/keyboard\";\r\nimport { spritesheetLoaded } from \"game/spritesheet\";\r\nimport IconCell, { ActionBarItem } from \"game/ui/common/IconCell\";\r\nimport * as React from \"react\";\r\nimport { Vector2 } from \"three\";\r\nimport { Tool, ToolBar, ToolBuild } from \"../../../input/toolBar\";\r\nimport { HotkeyButton } from \"../HotkeyButton\";\r\nimport \"./ToolBarUI.scss\";\r\n\r\nexport const ToolBarUI: React.FC<{ bar: ToolBar }> = ({ bar }) => {\r\n  const keys = Object.keys(bar.tools);\r\n  return (\r\n    <div className=\"tool-bar\">\r\n      <div className=\"tool-bar-items\">\r\n        {keys.map((code) => {\r\n          return (\r\n            <ToolBarItem key={code} bar={bar} code={code} selected={bar.currentKey === code} tool={bar.tools[code]} />\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst ToolBarItem: React.FC<{ bar: ToolBar; code: string; selected: boolean; tool: Tool }> = ({\r\n  bar,\r\n  code,\r\n  selected,\r\n  tool,\r\n}) => {\r\n  const onClick = React.useCallback(() => {\r\n    bar.setKey(code);\r\n  }, [bar, code]);\r\n\r\n  const itemIcon =\r\n    tool.type === \"interact\" ? (\r\n      <ActionBarItem onClick={onClick} className=\"interact-tool-icon\">\r\n        {tool.name}\r\n      </ActionBarItem>\r\n    ) : (\r\n      <ToolBuildIcon onClick={onClick} tool={tool} spritesheetLoaded={spritesheetLoaded} />\r\n    );\r\n\r\n  const hotkey = code.charAt(code.length - 1);\r\n  return (\r\n    <div className={classNames(\"tool-bar-item\", { selected })}>\r\n      {itemIcon}\r\n      <HotkeyButton className=\"mito-hud-build-item\" hotkey={hotkey} onClick={onClick} />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport interface CellBarItemProps {\r\n  onClick: () => void;\r\n  spritesheetLoaded: boolean;\r\n  tool: ToolBuild;\r\n}\r\n\r\nconst ToolBuildIcon: React.FC<CellBarItemProps> = ({ onClick, spritesheetLoaded, tool }) => {\r\n  const argsChildren: JSX.Element[] = [];\r\n  const type = tool.cellType;\r\n  if (type.args && type.args.direction) {\r\n    argsChildren.push(<TransportDirArrow key={argsChildren.length} dir={type.args.direction} />);\r\n  }\r\n  return (\r\n    <IconCell\r\n      onClick={onClick}\r\n      cellType={type}\r\n      spritesheetLoaded={spritesheetLoaded}\r\n      showCosts={Keyboard.keyMap.has(\"ShiftLeft\")}\r\n    >\r\n      {type.name}\r\n      {argsChildren}\r\n    </IconCell>\r\n  );\r\n};\r\n\r\nconst TransportDirArrow: React.FC<{ dir: Vector2 }> = ({ dir }) => {\r\n  return <div className=\"transport-dir-arrow\" style={{ transform: `rotate(${dir.angle()}rad)` }}></div>;\r\n};\r\n","import classNames from \"classnames\";\r\nimport { Player, StepStats } from \"core\";\r\nimport { Cell } from \"core/cell\";\r\nimport { Action } from \"core/player/action\";\r\nimport { EventPhotosynthesis } from \"core/tile/tileEvent\";\r\nimport Mito from \"game/mito/mito\";\r\nimport * as React from \"react\";\r\nimport { GeneSeed } from \"std/genes\";\r\nimport { HUDProps } from \".\";\r\nimport { HotkeyButton } from \"../HotkeyButton\";\r\nimport \"./Tutorial.scss\";\r\n\r\nexport const Tutorial = ({ mito }: HUDProps) => {\r\n  const [activeIndex, setActiveIndex] = React.useState(0);\r\n  const handleDone = React.useCallback(\r\n    (index) => {\r\n      if (index === activeIndex) {\r\n        setActiveIndex((i) => i + 1);\r\n      }\r\n    },\r\n    [activeIndex]\r\n  );\r\n  return (\r\n    <div className=\"hud-left\">\r\n      {tutorialSteps.map((Step, index) => (\r\n        <TutorialStepContainer\r\n          mito={mito}\r\n          active={activeIndex === index}\r\n          Step={Step}\r\n          index={index}\r\n          isFirst={index === 0}\r\n          onDone={handleDone}\r\n          key={index}\r\n        />\r\n      ))}\r\n    </div>\r\n  );\r\n};\r\n\r\nfunction useCountActions(player: Player, predicate: (action: Action) => boolean) {\r\n  const [count, setCount] = React.useState(0);\r\n  React.useEffect(() => {\r\n    const cb = (action: Action) => {\r\n      if (predicate(action)) {\r\n        setCount((c) => c + 1);\r\n      }\r\n    };\r\n    player.on(\"action\", cb);\r\n    return () => {\r\n      player.off(\"action\", cb);\r\n    };\r\n  });\r\n  return count;\r\n}\r\n\r\nfunction useCountActionTarget(player: Player, predicate: (a: Action) => boolean, target: number) {\r\n  const count = useCountActions(player, predicate);\r\n  return count / target;\r\n}\r\n\r\ninterface TutorialStepProps {\r\n  player: Player;\r\n  setPercentDone: (percent: number) => void;\r\n  active: boolean;\r\n}\r\n\r\nconst build = (name: string) => {\r\n  return (action: Action) => action.type === \"build\" && action.cellType.name === name;\r\n};\r\n\r\nconst tutorialSteps: Array<React.FC<TutorialStepProps>> = [\r\n  ({ player, setPercentDone }) => {\r\n    setPercentDone(useCountActionTarget(player, (action) => action.type === \"move\", 120));\r\n    return (\r\n      <>\r\n        Move - <HotkeyButton hotkey=\"W\" />\r\n        <HotkeyButton hotkey=\"A\" />\r\n        <HotkeyButton hotkey=\"S\" />\r\n        <HotkeyButton hotkey=\"D\" />\r\n      </>\r\n    );\r\n  },\r\n  ({ player, setPercentDone }) => {\r\n    setPercentDone(useCountActionTarget(player, build(\"Tissue\"), 3));\r\n    return (\r\n      <>\r\n        Grow Tissue - <HotkeyButton hotkey=\"1\" />, click.{\" \"}\r\n      </>\r\n    );\r\n  },\r\n  ({ player, setPercentDone }) => {\r\n    setPercentDone(useCountActionTarget(player, build(\"Root\"), 4));\r\n    return (\r\n      <>\r\n        Grow Roots - <HotkeyButton hotkey=\"3\" />, click Soil.\r\n      </>\r\n    );\r\n  },\r\n  ({ player, setPercentDone }) => {\r\n    setPercentDone(\r\n      useCountActionTarget(\r\n        player,\r\n        (action) => action.type === \"pickup\" && action.target instanceof Cell && action.target.displayName === \"Root\",\r\n        16\r\n      )\r\n    );\r\n    return (\r\n      <>\r\n        Take water from Roots - <HotkeyButton hotkey=\"Q\" />, click Root.\r\n      </>\r\n    );\r\n  },\r\n  ({ player, setPercentDone }) => {\r\n    setPercentDone(useCountActionTarget(player, build(\"Leaf\"), 4));\r\n    return (\r\n      <>\r\n        Grow Leaves - <HotkeyButton hotkey=\"2\" />, click Air.\r\n      </>\r\n    );\r\n  },\r\n  ({ player, setPercentDone }) => {\r\n    setPercentDone(\r\n      useCountActionTarget(\r\n        player,\r\n        (action) => action.type === \"drop\" && action.target instanceof Cell && action.target.displayName === \"Leaf\",\r\n        16\r\n      )\r\n    );\r\n    return (\r\n      <>\r\n        Put water in Leaf - <HotkeyButton hotkey=\"Q\" />, click Leaf.\r\n      </>\r\n    );\r\n  },\r\n  ({ player, setPercentDone }) => {\r\n    const [sugarMade, setSugarMade] = React.useState(0);\r\n    React.useEffect(() => {\r\n      const cb = (stats: StepStats) => {\r\n        const sugarMade = stats.events.photosynthesis.reduce(\r\n          (sum, event: EventPhotosynthesis) => event.sugarMade + sum,\r\n          0\r\n        );\r\n        setSugarMade((s) => s + sugarMade);\r\n      };\r\n      player.world.on(\"step\", cb);\r\n      return () => {\r\n        player.world.off(\"step\", cb);\r\n      };\r\n    }, [player.world]);\r\n    setPercentDone(sugarMade / 4);\r\n    return <>Wait for Photosynthesis.</>;\r\n  },\r\n  ({ player, setPercentDone }) => {\r\n    setPercentDone(useCountActionTarget(player, build(\"Seed\"), 1));\r\n    return (\r\n      <>\r\n        Grow Seed - <HotkeyButton hotkey=\"4\" />, click.\r\n      </>\r\n    );\r\n  },\r\n  ({ player, setPercentDone, active }) => {\r\n    setPercentDone(\r\n      useCountActionTarget(\r\n        player,\r\n        (action) =>\r\n          active && action.type === \"drop\" && action.target instanceof Cell && action.target.displayName === \"Tissue\",\r\n        7\r\n      )\r\n    );\r\n    return (\r\n      <>\r\n        Feed Tissue - <HotkeyButton hotkey=\"Q\" />, click Tissue.\r\n      </>\r\n    );\r\n  },\r\n  ({ player, setPercentDone }) => {\r\n    const percentDone =\r\n      (Array.from(player.world.mpEarners.keys())[0]?.findGene(GeneSeed)?.state.energyRecieved ?? 0) / 100;\r\n    setPercentDone(percentDone);\r\n    return <>Get seed to 100 energy.</>;\r\n  },\r\n];\r\n\r\nconst TutorialStepContainer: React.FC<{\r\n  mito: Mito;\r\n  index: number;\r\n  active: boolean;\r\n  isFirst: boolean;\r\n  Step: React.FC<TutorialStepProps>;\r\n  onDone: (index: number) => void;\r\n}> = ({ mito, active, index, isFirst, Step, onDone }) => {\r\n  const [percentDoneRaw, setPercentDone] = React.useState(0);\r\n  const percentDone = Math.min(percentDoneRaw, 1);\r\n  const isDone = percentDone >= 1;\r\n\r\n  React.useEffect(() => {\r\n    if (isDone) {\r\n      onDone(index);\r\n    }\r\n  }, [active, index, isDone, onDone]);\r\n\r\n  const percentCss = `${(percentDone * 100).toFixed(1)}%`;\r\n  const style: React.CSSProperties = {\r\n    // background: `linear-gradient(to right, ${filled}, ${filled} ${percentCss}, transparent ${percentCss}, transparent)`,\r\n    width: percentCss,\r\n  };\r\n\r\n  // kill animation in the WASD tutorial\r\n  if (isFirst) {\r\n    style.transition = \"unset\";\r\n  }\r\n\r\n  return (\r\n    <div className={classNames(\"instruction\", { active, first: isFirst, done: isDone })}>\r\n      <div className=\"background-fill\" style={style} />\r\n      <Step player={mito.world.player} setPercentDone={setPercentDone} active={active} />\r\n    </div>\r\n  );\r\n};\r\n","import { nf } from \"common/formatters\";\r\nimport React, { memo, useRef } from \"react\";\r\nimport { World } from \"../../../core\";\r\nimport { TIME_PER_SEASON } from \"../../../core/constants\";\r\nimport { GenePhotosynthesis, GeneSoilAbsorption } from \"../../../std/genes\";\r\nimport { ResourceIcon } from \"../common/ResourceIcon\";\r\n\r\n// time is just used for re-rendering\r\nconst PlantStats: React.FC<{ world: World; time: number }> = memo(({ world, time }) => {\r\n  const lastTime = useRef(0);\r\n  const lastTotalEnergy = useRef(0);\r\n  const dt = time - lastTime.current;\r\n\r\n  let numWater = 0;\r\n  let numSugar = 0;\r\n  let totalEnergy = 0;\r\n  let numCells = 0;\r\n  let totalWaterAbsorbed = 0;\r\n  let totalSugarProduced = 0;\r\n  for (const cell of world.allCells()) {\r\n    numWater += cell.inventory.water;\r\n    numSugar += cell.inventory.sugar;\r\n    totalEnergy += cell.energy;\r\n    numCells++;\r\n    const soilAbsorb = cell.findGene(GeneSoilAbsorption);\r\n    if (soilAbsorb) {\r\n      totalWaterAbsorbed += soilAbsorb.state.totalSucked;\r\n    }\r\n    const photosynthesis = cell.findGene(GenePhotosynthesis);\r\n    if (photosynthesis) {\r\n      totalSugarProduced += photosynthesis.state.totalSugarProduced;\r\n    }\r\n  }\r\n  const energyUsed = lastTotalEnergy.current - totalEnergy;\r\n  const energyUsePerSecond = energyUsed / dt;\r\n  const energyUsePerSeason = energyUsePerSecond * TIME_PER_SEASON;\r\n  const sugarUsePerSeason = energyUsePerSeason;\r\n  const timeUntilStarvation = totalEnergy / energyUsePerSecond;\r\n  const averageWaterPerSeason = (totalWaterAbsorbed / world.time) * TIME_PER_SEASON;\r\n  const averageSugarPerSeason = (totalSugarProduced / world.time) * TIME_PER_SEASON;\r\n\r\n  lastTotalEnergy.current = totalEnergy;\r\n  lastTime.current = time;\r\n\r\n  return (\r\n    <div className=\"plant-stats\" style={{ margin: \"10px 0\", textAlign: \"left\" }}>\r\n      <div>\r\n        {nf(numWater, 3)} <ResourceIcon name=\"water\" />,{nf(numSugar, 3)} <ResourceIcon name=\"sugar\" />\r\n      </div>\r\n      <div>Water per season: {nf(averageWaterPerSeason, 3)}</div>\r\n      <div>Sugar per season: {nf(averageSugarPerSeason, 3)}</div>\r\n      <div>Total energy: {nf(totalEnergy, 4)}</div>\r\n      <div>Average energy: {nf((totalEnergy / numCells) * 100, 2)}%</div>\r\n      <div>Sugar use per season: {nf(sugarUsePerSeason, 3)}</div>\r\n      <div>Time until starvation: {nf(timeUntilStarvation, 3)} seconds.</div>\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default PlantStats;\r\n","import { Button } from \"game/ui/common/Button\";\r\nimport * as React from \"react\";\r\nimport Keyboard from \"../../input/keyboard\";\r\nimport Mito from \"../../mito/mito\";\r\nimport { ResourceIcon } from \"../common/ResourceIcon\";\r\nimport PlantStats from \"./PlantStats\";\r\n\r\nconst Debug: React.FC<{ mito: Mito }> = ({ mito }) => {\r\n  const doWin = React.useCallback(() => {\r\n    mito.onWinLoss({\r\n      mpEarners: mito.world.mpEarners,\r\n      world: mito.world,\r\n      status: \"won\",\r\n      mutationPointsPerEpoch: 1,\r\n      vignettes: mito.vignettes,\r\n    });\r\n  }, [mito]);\r\n\r\n  const doLose = React.useCallback(() => {\r\n    mito.onWinLoss({\r\n      mpEarners: mito.world.mpEarners,\r\n      world: mito.world,\r\n      status: \"lost\",\r\n      mutationPointsPerEpoch: 0,\r\n      vignettes: mito.vignettes,\r\n    });\r\n  }, [mito]);\r\n\r\n  const plusWater = React.useCallback(() => {\r\n    mito.world.player.inventory.add(5, 0);\r\n  }, [mito.world.player.inventory]);\r\n\r\n  const plusSugar = React.useCallback(() => {\r\n    mito.world.player.inventory.add(0, 5);\r\n  }, [mito.world.player.inventory]);\r\n\r\n  return (\r\n    <div style={{ position: \"absolute\", bottom: 0, left: 0, background: \"white\" }}>\r\n      <div style={{ display: \"flex\" }}>\r\n        <Button color=\"green\" onClick={doWin}>\r\n          Win\r\n        </Button>\r\n        <Button color=\"green\" onClick={doLose}>\r\n          Lose\r\n        </Button>\r\n      </div>\r\n      <div style={{ display: \"flex\" }}>\r\n        <Button onClick={plusWater}>\r\n          +5 <ResourceIcon name=\"water\" />\r\n        </Button>\r\n        <Button onClick={plusSugar}>\r\n          +5 <ResourceIcon name=\"sugar\" />\r\n        </Button>\r\n      </div>\r\n      <PlantStats world={mito.world} time={Math.floor(mito.world.time)} />\r\n      <div>\r\n        <div>Rainwater: {mito.world.numRainWater}</div>\r\n        <div>Evaporated Air: {mito.world.numEvaporatedAir}</div>\r\n        <div>Evaporated Soil: {mito.world.numEvaporatedSoil}</div>\r\n      </div>\r\n      <div style={{ background: \"white\" }}>{Array.from(Keyboard.keyMap.values()).join(\", \")}</div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Debug;\r\n","import { FunctionNode, Node, NodeBuilder, TempNode, UVNode } from \"three/examples/jsm/nodes/Nodes\";\r\n\r\nexport class OvalNode extends TempNode {\r\n  private uv = new UVNode();\r\n\r\n  // VERY IMPORTANT TO TRIM WHITESPACE because THREE's internal regex is whitespace sensitive\r\n  static ovalOutFn = new FunctionNode(\r\n    `\r\nfloat ovalOut(vec2 vUv, float time) {\r\n    return clamp((time - length(vUv - vec2(0.5))) * 15., 0.0, 1.0);\r\n}`.trim()\r\n  );\r\n\r\n  constructor(public time: Node) {\r\n    super(\"f\");\r\n  }\r\n\r\n  generate(builder: NodeBuilder, output: string) {\r\n    const fn = builder.include(OvalNode.ovalOutFn);\r\n    return builder.format(\r\n      fn + \"( \" + this.uv.build(builder, \"v2\") + \", \" + this.time.build(builder, \"f\") + \" )\",\r\n      this.getType(builder),\r\n      output\r\n    );\r\n  }\r\n}\r\n","import devlog from \"common/devlog\";\r\nimport { sleep } from \"common/promise\";\r\nimport { CancerEffect, FreezeEffect } from \"core/cell\";\r\nimport { easeSinIn } from \"d3-ease\";\r\nimport { PopulationAttempt } from \"game/app\";\r\nimport { Mouse } from \"game/input/mouse\";\r\nimport { ISketch, SketchAudioContext } from \"game/screens/sketch/sketch\";\r\nimport * as React from \"react\";\r\nimport Stats from \"stats.js\";\r\nimport { environmentFromLevelInfo } from \"std/environments\";\r\nimport VignetteCapturer from \"std/vignette\";\r\nimport * as THREE from \"three\";\r\nimport { OrthographicCamera, PerspectiveCamera, Scene, Vector2, Vector3, WebGLRenderer } from \"three\";\r\nimport { OrbitControls } from \"three/examples/jsm/controls/OrbitControls\";\r\nimport * as Nodes from \"three/examples/jsm/nodes/Nodes\";\r\nimport configure from \"../../common/configure\";\r\nimport { World } from \"../../core\";\r\nimport { Cell, Tile } from \"../../core/tile\";\r\nimport { clamp, lerp, lerp2, map, toVector2 } from \"../../math/index\";\r\nimport { drums, hookUpAudio, strings, whoosh } from \"../audio\";\r\nimport { GameResult, maybeGetGameResult } from \"../gameResult\";\r\nimport { ControlScheme, PlayerSeedControlScheme } from \"../input/ControlScheme\";\r\nimport { ToolBar } from \"../input/toolBar\";\r\nimport { params } from \"../params\";\r\nimport { InstancedTileRenderer } from \"../renderers/tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../renderers/WorldRenderer\";\r\nimport { Hover, HUD } from \"../ui/ingame\";\r\nimport Debug from \"../ui/ingame/Debug\";\r\nimport { CameraState } from \"./cameraState\";\r\nimport { logRenderInfo } from \"./logRenderInfo\";\r\nimport \"./mito.scss\";\r\nimport { OvalNode } from \"./ovalNode\";\r\nimport { perfDebugThreeObjects } from \"./perfDebugThreeObjects\";\r\nimport { WorldDOMElement } from \"./WorldDOMElement\";\r\n\r\nexport class Mito extends ISketch {\r\n  static id = \"mito\";\r\n\r\n  public readonly world: World;\r\n\r\n  public readonly toolBar: ToolBar;\r\n\r\n  public readonly scene = configure(new Scene(), (s) => {\r\n    s.background = new THREE.Color(\"black\");\r\n  });\r\n\r\n  public readonly scenePlayerSeed = new Scene();\r\n\r\n  private readonly camera = new OrthographicCamera(0, 0, 0, 0, -100, 100);\r\n\r\n  public mouse = new Mouse(this.canvas);\r\n\r\n  public readonly audioListener = new THREE.AudioListener();\r\n\r\n  public highlightedTile?: Tile;\r\n\r\n  public highlightedPosition?: Vector2;\r\n\r\n  private _inspectedCell?: Cell;\r\n\r\n  public get inspectedCell() {\r\n    return this._inspectedCell;\r\n  }\r\n\r\n  public set inspectedCell(c: Cell | undefined) {\r\n    if (params.showGodUI) {\r\n      console.trace(\"set inspectedCell to\", c);\r\n    }\r\n    this._inspectedCell = c;\r\n  }\r\n\r\n  get isFirstPlaythrough() {\r\n    return this.attempt.sourceHex == null;\r\n  }\r\n\r\n  public readonly worldRenderer: WorldRenderer;\r\n\r\n  private vignetteCapturer = new VignetteCapturer(this);\r\n\r\n  public vignettes: HTMLCanvasElement[] = [];\r\n\r\n  private hackCamera?: PerspectiveCamera;\r\n\r\n  private orbitControls?: OrbitControls;\r\n\r\n  private suggestedCamera?: CameraState;\r\n\r\n  private userZoom: number;\r\n\r\n  private _controls?: ControlScheme;\r\n\r\n  public get controls() {\r\n    return this._controls;\r\n  }\r\n\r\n  public set controls(controls: ControlScheme | undefined) {\r\n    if (this._controls != null) {\r\n      this._controls.destroy();\r\n    }\r\n    this._controls = controls;\r\n  }\r\n\r\n  public nodeFrame = new Nodes.NodeFrame(0);\r\n\r\n  public nodePost: Nodes.NodePostProcessing;\r\n\r\n  public ovalOutTime: Nodes.FloatNode;\r\n\r\n  public stats = new Stats();\r\n\r\n  public isPaused = false;\r\n\r\n  public pausedInspectedTile?: Tile;\r\n\r\n  constructor(\r\n    renderer: WebGLRenderer,\r\n    context: SketchAudioContext,\r\n    public attempt: PopulationAttempt,\r\n    public onWinLoss: (result: GameResult) => void\r\n  ) {\r\n    super(renderer, context);\r\n    this.renderer.autoClear = false;\r\n    this.nodePost = new Nodes.NodePostProcessing(renderer);\r\n    this.ovalOutTime = new Nodes.FloatNode(0);\r\n    const noiseNode = new Nodes.MathNode(\r\n      new Nodes.ScreenNode(),\r\n      new OvalNode(this.ovalOutTime),\r\n      this.ovalOutTime,\r\n      Nodes.MathNode.MIN\r\n    );\r\n    this.nodePost.output = noiseNode as any;\r\n    const { info } = attempt.targetHex;\r\n    this.world = new World(environmentFromLevelInfo(info), info.seed, attempt.settlingSpecies);\r\n\r\n    this.camera.position.z = 10;\r\n    this.camera.lookAt(0, 0, 0);\r\n    this.camera.position.x = this.world.player.pos.x;\r\n    this.camera.position.y = this.world.player.pos.y;\r\n    this.camera.zoom = this.userZoom = 1.5;\r\n    this.camera.add(this.audioListener);\r\n\r\n    // this.hackCamera = new PerspectiveCamera(60, this.canvas.height / this.canvas.width);\r\n\r\n    if (this.hackCamera != null) {\r\n      // this.hackCamera.position.copy(this.camera.position);\r\n      // this.hackCamera.lookAt(0, 0, 0);\r\n      this.orbitControls = new OrbitControls(this.hackCamera, this.canvas);\r\n      this.scene.add(new THREE.AxesHelper(25));\r\n    }\r\n\r\n    this.worldRenderer = new WorldRenderer(this.world, this.scene, this);\r\n\r\n    hookUpAudio(this.audioContext);\r\n    this.updateAmbientAudio();\r\n    this.attachWindowEvents();\r\n\r\n    this.toolBar = new ToolBar(this);\r\n    // this.actionBar = new SwitchableBar(new CellBar(this), new InteractBar(this));\r\n    // this.actionBar = new AltHeldBar(this);\r\n    // this.controls = new ControlScheme(this);\r\n    this.controls = new PlayerSeedControlScheme(this);\r\n  }\r\n\r\n  public events = {\r\n    wheel: (e: WheelEvent) => {\r\n      const delta = -(e.deltaX + e.deltaY) / 125 / 20;\r\n      const currZoom = this.userZoom;\r\n      const scalar = Math.pow(2, delta);\r\n      const newZoom = clamp(currZoom * scalar, 1, 3);\r\n      this.userZoom = newZoom;\r\n    },\r\n  };\r\n\r\n  private handleBeforeUnload = () => {\r\n    return true;\r\n  };\r\n\r\n  private handleContextMenu = (e: MouseEvent) => {\r\n    e.preventDefault();\r\n    return false;\r\n  };\r\n\r\n  private attachWindowEvents() {\r\n    window.onbeforeunload = this.handleBeforeUnload;\r\n    window.addEventListener(\"contextmenu\", this.handleContextMenu);\r\n    (window as any).mito = this;\r\n    (window as any).THREE = THREE;\r\n  }\r\n\r\n  destroy() {\r\n    // settings controls to undefined calls destroy on controls\r\n    window.removeEventListener(\"contextmenu\", this.handleContextMenu);\r\n    this.controls = undefined;\r\n    window.onbeforeunload = null;\r\n  }\r\n\r\n  public render() {\r\n    if (!params.hud) {\r\n      return null;\r\n    }\r\n    const worldDomElementComponents: React.ReactNode[] = [];\r\n    for (const e of this.worldDomElements) {\r\n      worldDomElementComponents.push(e.render());\r\n    }\r\n    const showPlayerHUD = this.world.playerSeed == null;\r\n    return (\r\n      <>\r\n        <HUD mito={this} />\r\n        {showPlayerHUD ? <Hover mito={this} /> : null}\r\n        <div className=\"world-dom-components\">{worldDomElementComponents}</div>\r\n        {params.showGodUI ? <Debug mito={this} /> : null}\r\n        {params.showFPS ? <WindowFPS mito={this} /> : null}\r\n      </>\r\n    );\r\n  }\r\n\r\n  public updateAmbientAudio() {\r\n    const yPos = this.world.player.pos.y;\r\n    const drumVolume = map(yPos, this.world.height / 2, this.world.height, 0, 0.5);\r\n    const stringsVolume = map(yPos, this.world.height / 2, 0, 0, 0.5);\r\n    drums.gain.gain.value = Math.max(0, drumVolume);\r\n    strings.gain.gain.value = Math.max(0, stringsVolume);\r\n  }\r\n\r\n  public worldStep(dt: number) {\r\n    this.world.step(dt);\r\n\r\n    const gameResult = maybeGetGameResult(this);\r\n    if (gameResult != null) {\r\n      this.onWinLoss(gameResult);\r\n    }\r\n\r\n    this.updateAmbientAudio();\r\n  }\r\n\r\n  private getCameraNormCoordinates(clientX: number, clientY: number) {\r\n    return new THREE.Vector2((clientX / this.canvas.width) * 2 - 1, (-clientY / this.canvas.height) * 2 + 1);\r\n  }\r\n\r\n  public readonly PLAYER_TETHER_DISTANCE = 0.9;\r\n\r\n  public getPlayerInfluenceVector(clientX = this.mouse.position.x, clientY = this.mouse.position.y) {\r\n    const cursorWorld = this.getWorldCoordinates(clientX, clientY);\r\n\r\n    const offset = new Vector2(cursorWorld.x, cursorWorld.y).sub(this.world.player.posFloat);\r\n    offset.clampLength(0, this.PLAYER_TETHER_DISTANCE);\r\n    return offset;\r\n  }\r\n\r\n  public getWorldCoordinates(clientX: number, clientY: number) {\r\n    const cursorCameraNorm = this.getCameraNormCoordinates(clientX, clientY);\r\n    return toVector2(new Vector3(cursorCameraNorm.x, cursorCameraNorm.y, 0).unproject(this.camera));\r\n  }\r\n\r\n  public getTileAtScreen(clientX: number = this.mouse.position.x, clientY: number = this.mouse.position.y) {\r\n    const coords = this.getWorldCoordinates(clientX, clientY);\r\n    coords.round();\r\n\r\n    const tile = this.world.tileAt(coords.x, coords.y);\r\n    if (tile != null && tile.lightAmount() > 0) {\r\n      return tile;\r\n    }\r\n  }\r\n\r\n  private computeHighlightedPosition() {\r\n    if (this.inspectedCell) {\r\n      return this.inspectedCell.pos;\r\n    }\r\n    const offset = this.getPlayerInfluenceVector();\r\n    const { x, y } = this.world.player.posFloat;\r\n\r\n    offset.x += x;\r\n    offset.y += y;\r\n    return offset;\r\n  }\r\n\r\n  private computeHighlightedTile() {\r\n    const p = this.computeHighlightedPosition();\r\n    p.round();\r\n\r\n    const tile = this.world.tileAt(p.x, p.y);\r\n    if (tile != null && tile.lightAmount() > 0) {\r\n      return tile;\r\n    }\r\n  }\r\n\r\n  worldToScreen(world: Vector2) {\r\n    const screen = new Vector3(world.x, world.y, 0);\r\n    screen.project(this.camera); // `camera` is a THREE.PerspectiveCamera\r\n\r\n    screen.x = Math.round((0.5 + screen.x / 2) * this.canvas.width);\r\n    screen.y = Math.round((0.5 - screen.y / 2) * this.canvas.height);\r\n\r\n    return screen;\r\n  }\r\n\r\n  private worldDomElements = new Set<WorldDOMElement>();\r\n\r\n  addWorldDOMElement(positionFn: () => THREE.Vector2 | Tile, renderFn: () => React.ReactNode): WorldDOMElement {\r\n    const e = new WorldDOMElement(this, positionFn, renderFn);\r\n    this.worldDomElements.add(e);\r\n    return e;\r\n  }\r\n\r\n  removeWorldDOMElement(worldDomElement: WorldDOMElement) {\r\n    this.worldDomElements.delete(worldDomElement);\r\n  }\r\n\r\n  async addFloatingText(position: Vector2 | Tile, text: React.ReactNode) {\r\n    const element = this.addWorldDOMElement(\r\n      () => position,\r\n      () => <div className=\"floating-text\">{text}</div>\r\n    );\r\n    await sleep(1000);\r\n    this.removeWorldDOMElement(element);\r\n  }\r\n\r\n  invalidAction?: { message: string };\r\n\r\n  async showInvalidAction(invalidAction: { message: string }) {\r\n    this.invalidAction = invalidAction;\r\n    await sleep(3000);\r\n    if (this.invalidAction === invalidAction) {\r\n      this.invalidAction = undefined;\r\n    }\r\n  }\r\n\r\n  public animate(millisDelta: number) {\r\n    this.stats.end();\r\n    this.stats.begin();\r\n    this.controls?.animate(millisDelta);\r\n\r\n    const c = this.inspectedCell;\r\n    if (c != null) {\r\n      if (c.isDead || c.findEffectOfType(CancerEffect) || c.findEffectOfType(FreezeEffect)) {\r\n        this.inspectedCell = undefined;\r\n      }\r\n      if (this.world.player.getAction() != null) {\r\n        this.inspectedCell = undefined;\r\n      }\r\n    }\r\n\r\n    // cap out at 1/3rd of a second in one frame (about 10 frames)\r\n    const dt = Math.min(millisDelta / 1000, 1 / 3);\r\n    if (!this.isPaused) {\r\n      this.worldStep(dt);\r\n      this.worldRenderer.update();\r\n      this.updateCamera(this.suggestedCamera || this.defaultCameraState());\r\n      this.pausedInspectedTile = undefined;\r\n\r\n      this.highlightedPosition = this.computeHighlightedPosition();\r\n      this.highlightedTile = this.computeHighlightedTile();\r\n      if (this.highlightedTile != null) {\r\n        (this.worldRenderer.getOrCreateRenderer(this.highlightedTile) as InstancedTileRenderer).updateHover();\r\n      }\r\n    }\r\n\r\n    if (this.vignetteCapturer.isTimeForNewCapture()) {\r\n      const v = this.vignetteCapturer.capture();\r\n      devlog(\"captured\", v);\r\n      this.vignettes.push(v);\r\n    }\r\n\r\n    this.suggestedCamera = undefined;\r\n\r\n    if (this.hackCamera != null) {\r\n      this.renderer.render(this.scene, this.hackCamera);\r\n    } else {\r\n      const ovalOutStart = 3.5;\r\n      // did trigger this frame?\r\n      if (this.world.time - dt < ovalOutStart && this.world.time > ovalOutStart) {\r\n        whoosh.play();\r\n      }\r\n      this.ovalOutTime.value = easeSinIn(clamp((this.world.time - ovalOutStart) / 1.5, 0, 1));\r\n      this.nodeFrame.update(millisDelta / 1000);\r\n\r\n      // render everything as per norm\r\n      this.renderer.clear();\r\n      this.nodePost.render(this.scene, this.camera, this.nodeFrame);\r\n\r\n      // render the player seed on top, after PostProcessing, so it's always there\r\n      this.renderer.clearDepth();\r\n      this.renderer.render(this.scenePlayerSeed, this.camera);\r\n    }\r\n    if (params.debugPerf && this.frameCount % 100 === 0) {\r\n      perfDebugThreeObjects(this);\r\n      logRenderInfo(this.renderer);\r\n    }\r\n  }\r\n\r\n  defaultCameraState(): CameraState {\r\n    if (this.world.playerSeed == null) {\r\n      const mouseNorm = this.getCameraNormCoordinates(this.mouse.position.x, this.mouse.position.y);\r\n\r\n      const cameraTarget = this.world.player.droopPosFloat().clone();\r\n      cameraTarget.x += mouseNorm.x / 2;\r\n      cameraTarget.y -= mouseNorm.y / 2;\r\n\r\n      return {\r\n        center: cameraTarget,\r\n        zoom: this.userZoom,\r\n      };\r\n    } else {\r\n      return {\r\n        center: this.world.playerSeed.pos,\r\n        zoom: this.userZoom,\r\n      };\r\n    }\r\n  }\r\n\r\n  updateCamera(targetState: CameraState) {\r\n    const { center, zoom } = targetState;\r\n    lerp2(this.camera.position, center, 0.2);\r\n    if (Math.abs(this.camera.zoom - zoom) > 0.001) {\r\n      this.camera.zoom = lerp(this.camera.zoom, targetState.zoom, 0.1);\r\n      this.camera.updateProjectionMatrix();\r\n    }\r\n  }\r\n\r\n  suggestCamera(suggestedCamera: CameraState) {\r\n    this.suggestedCamera = suggestedCamera;\r\n  }\r\n\r\n  public resize(w: number, h: number) {\r\n    const aspect = h / w;\r\n    // at zoom 1, we see 12 pixels up and 12 pixels down\r\n    const cameraHeight = 12;\r\n    this.camera.left = -cameraHeight / aspect;\r\n    this.camera.right = cameraHeight / aspect;\r\n    this.camera.top = -cameraHeight;\r\n    this.camera.bottom = cameraHeight;\r\n    // this.camera.position.z = 1;\r\n    // this.camera.lookAt(new Vector3(0, 0, 0));\r\n    this.camera.updateProjectionMatrix();\r\n    this.nodePost.setSize(w, h);\r\n  }\r\n}\r\n\r\nexport default Mito;\r\n\r\nconst WindowFPS: React.FC<{ mito: Mito }> = ({ mito }) => {\r\n  React.useEffect(() => {\r\n    document.body.appendChild(mito.stats.dom);\r\n    return () => {\r\n      document.body.removeChild(mito.stats.dom);\r\n    };\r\n  }, [mito.stats.dom]);\r\n\r\n  return null;\r\n};\r\n","import { WebGLRenderer } from \"three\";\r\n\r\nexport function logRenderInfo(renderer: WebGLRenderer) {\r\n  console.log(`Geometries in memory: ${renderer.info.memory.geometries}\r\nTextures in memory: ${renderer.info.memory.textures}\r\nNumber of Programs: ${renderer.info.programs!.length}\r\n# Render Calls: ${renderer.info.render.calls}\r\n# Render Lines: ${renderer.info.render.lines}\r\n# Render Points: ${renderer.info.render.points}\r\n# Render Tris: ${renderer.info.render.triangles}\r\n`);\r\n}\r\n","import { Mito } from \"./mito\";\r\n\r\nexport function perfDebugThreeObjects(mito: Mito) {\r\n  // count how many have autoUpdate enabled\r\n  let yes = 0,\r\n    no = 0;\r\n  mito.scene.traverse((o) => {\r\n    if (o.matrixAutoUpdate) {\r\n      yes++;\r\n    } else {\r\n      no++;\r\n    }\r\n  });\r\n  console.log(\"matrixAutoUpdate: yes\", yes, \", no\", no);\r\n  // count how many Objects of each type there are\r\n  const s = new Map();\r\n  mito.scene.traverse((o) => {\r\n    const k = s.get(o.name || o.constructor.name) || [];\r\n    s.set(o.name || o.constructor.name, k);\r\n    k.push(o);\r\n  });\r\n  console.log(s);\r\n}\r\n","import classnames from \"classnames\";\r\nimport { params } from \"game/params\";\r\nimport { Howler } from \"howler\";\r\nimport * as React from \"react\";\r\nimport { FaVolumeOff, FaVolumeUp } from \"react-icons/fa\";\r\nimport Ticker from \"std/ticker\";\r\nimport * as THREE from \"three\";\r\nimport Mito from \"../../mito/mito\";\r\nimport { ISketch, SketchAudioContext, UI_EVENTS } from \"./sketch\";\r\nimport \"./SketchComponent.scss\";\r\n\r\nexport interface ISketchComponentProps extends React.DOMAttributes<HTMLDivElement> {\r\n  eventsOnBody?: boolean;\r\n  errorElement?: JSX.Element;\r\n  otherArgs?: any[];\r\n}\r\n\r\nexport interface SketchSuccess {\r\n  type: \"success\";\r\n  sketch: ISketch;\r\n}\r\n\r\nexport interface SketchError {\r\n  type: \"error\";\r\n  error: Error;\r\n}\r\n\r\nexport interface SketchLoading {\r\n  type: \"loading\";\r\n}\r\n\r\nexport type SketchStatus = SketchSuccess | SketchError | SketchLoading;\r\n\r\n// Expects sketch to be setup but not init. SketchSuccessComponent is responsible for:\r\n//      firing resize events\r\n//      attaching ui event listeners\r\n//      keeping focus on the canvas\r\ninterface SketchSuccessComponentProps {\r\n  sketch: ISketch;\r\n  eventsOnBody?: boolean;\r\n}\r\n\r\ninterface SketchSuccessComponentState {\r\n  frameCount: number;\r\n  volumeEnabled: boolean;\r\n}\r\n\r\nclass SketchSuccessComponent extends React.PureComponent<SketchSuccessComponentProps, SketchSuccessComponentState> {\r\n  private frameId?: number;\r\n\r\n  private lastTimestamp = 0;\r\n\r\n  private stop = false;\r\n\r\n  constructor(props: SketchSuccessComponentProps) {\r\n    super(props);\r\n    this.state = {\r\n      frameCount: props.sketch.frameCount,\r\n      volumeEnabled: JSON.parse(window.localStorage.getItem(\"sketch-volumeEnabled\") || \"true\"),\r\n    };\r\n  }\r\n\r\n  public shouldPlayAudio() {\r\n    return this.state.volumeEnabled && document.visibilityState === \"visible\" && document.hasFocus();\r\n  }\r\n\r\n  public syncAudioContext() {\r\n    const { audioContext } = this.props.sketch;\r\n    if (audioContext != null) {\r\n      // this.userVolume.gain.value = this.state.volumeEnabled ? 1 : 0;\r\n      if (this.shouldPlayAudio() && audioContext.state === \"suspended\") {\r\n        audioContext.resume();\r\n      } else if (!this.shouldPlayAudio() && audioContext.state === \"running\") {\r\n        audioContext.suspend();\r\n      }\r\n    }\r\n  }\r\n\r\n  componentDidMount() {\r\n    window.addEventListener(\"resize\", this.handleWindowResize);\r\n    document.addEventListener(\"visibilitychange\", this.handleVisibilityChange);\r\n    this.handleWindowResize();\r\n\r\n    // canvas setup\r\n    const canvas = this.props.sketch.renderer.domElement;\r\n    canvas.tabIndex = 1;\r\n    (Object.keys(UI_EVENTS) as Array<keyof typeof UI_EVENTS>).forEach((eventName) => {\r\n      if (this.props.sketch.events != null) {\r\n        const callback = this.props.sketch.events[eventName] as EventListener;\r\n        if (callback != null) {\r\n          if (this.props.eventsOnBody) {\r\n            document.body.addEventListener(eventName, callback);\r\n          } else {\r\n            canvas.addEventListener(eventName, callback);\r\n          }\r\n        }\r\n      }\r\n    });\r\n    // prevent scrolling the viewport\r\n    // $canvas.on(\"touchmove\", (event) => {\r\n    //     event.preventDefault();\r\n    // });\r\n\r\n    this.frameId = Ticker.addAnimation(this.loop);\r\n  }\r\n\r\n  render() {\r\n    const sketchElementsWithKey: React.ReactNode[] = [];\r\n    if (this.props.sketch.render != null) {\r\n      sketchElementsWithKey.push(this.props.sketch.render());\r\n    }\r\n    if (this.props.sketch.elements != null) {\r\n      sketchElementsWithKey.push(...this.props.sketch.elements);\r\n    }\r\n    return (\r\n      <div className=\"sketch-elements\">\r\n        {/* {sketchElementsWithKey} */}\r\n        {sketchElementsWithKey.map((el, idx) => {\r\n          if (React.isValidElement(el)) {\r\n            return React.cloneElement(el, { key: idx });\r\n          } else {\r\n            return el;\r\n          }\r\n        })}\r\n        {this.renderVolumeButton()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderVolumeButton() {\r\n    if (params.hud) {\r\n      const { volumeEnabled } = this.state;\r\n      return (\r\n        <button className=\"user-volume game-options-button\" onClick={this.handleVolumeButtonClick}>\r\n          {volumeEnabled ? <FaVolumeUp /> : <FaVolumeOff />}\r\n        </button>\r\n      );\r\n    }\r\n  }\r\n\r\n  private handleVolumeButtonClick = () => {\r\n    const volumeEnabled = !this.state.volumeEnabled;\r\n    this.setState({ volumeEnabled });\r\n    window.localStorage.setItem(\"sketch-volumeEnabled\", JSON.stringify(volumeEnabled));\r\n  };\r\n\r\n  componentWillUnmount() {\r\n    this.stop = true;\r\n\r\n    if (this.props.sketch.destroy) {\r\n      this.props.sketch.destroy();\r\n    }\r\n    if (this.frameId != null) {\r\n      Ticker.removeAnimation(this.frameId);\r\n    }\r\n    this.props.sketch.renderer.dispose();\r\n    window.removeEventListener(\"resize\", this.handleWindowResize);\r\n    document.removeEventListener(\"visibilitychange\", this.handleVisibilityChange);\r\n\r\n    const canvas = this.props.sketch.canvas;\r\n    (Object.keys(UI_EVENTS) as Array<keyof typeof UI_EVENTS>).forEach((eventName) => {\r\n      if (this.props.sketch.events != null) {\r\n        const callback = this.props.sketch.events[eventName] as EventListener;\r\n        if (callback != null) {\r\n          if (this.props.eventsOnBody) {\r\n            document.body.removeEventListener(eventName, callback);\r\n          } else {\r\n            canvas.removeEventListener(eventName, callback);\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private loop = (timestamp: number) => {\r\n    const millisElapsed = timestamp - this.lastTimestamp;\r\n    this.lastTimestamp = timestamp;\r\n    this.props.sketch.frameCount++;\r\n    this.props.sketch.timeElapsed = timestamp;\r\n    this.syncAudioContext();\r\n    try {\r\n      this.props.sketch.animate(millisElapsed);\r\n    } catch (e) {\r\n      console.error(e);\r\n    }\r\n\r\n    // careful - sketch.animate() might have triggered a whole React update loop\r\n    // and made this component unmount.\r\n    if (!this.stop) {\r\n      // force new render()\r\n      this.setState({\r\n        frameCount: this.props.sketch.frameCount,\r\n      });\r\n    } else {\r\n      Ticker.removeAnimation(this.frameId!);\r\n    }\r\n  };\r\n\r\n  private handleWindowResize = () => {\r\n    const { renderer } = this.props.sketch;\r\n    this.updateRendererCanvasToMatchParent(renderer);\r\n    if (this.props.sketch.resize != null) {\r\n      this.props.sketch.resize(renderer.domElement.width, renderer.domElement.height);\r\n    }\r\n  };\r\n\r\n  private handleVisibilityChange = () => {\r\n    this.syncAudioContext();\r\n  };\r\n\r\n  private updateRendererCanvasToMatchParent(renderer: THREE.WebGLRenderer) {\r\n    const parent = renderer.domElement.parentElement;\r\n    if (parent != null) {\r\n      renderer.setSize(parent.clientWidth, parent.clientHeight);\r\n    }\r\n  }\r\n}\r\n\r\nexport interface ISketchComponentState {\r\n  status: SketchStatus;\r\n}\r\n\r\nexport class SketchComponent extends React.PureComponent<ISketchComponentProps, ISketchComponentState> {\r\n  public state: ISketchComponentState = {\r\n    status: { type: \"loading\" },\r\n  };\r\n\r\n  // private renderer?: THREE.WebGLRenderer;\r\n  private audioContext?: SketchAudioContext;\r\n\r\n  private userVolume?: GainNode;\r\n\r\n  private handleContainerRef = (ref: HTMLDivElement | null) => {\r\n    if (ref != null) {\r\n      try {\r\n        // create dependencies, setup sketch, and move to success state\r\n        // we are responsible for live-updating the global user volume.\r\n        // const AudioContextConstructor: typeof AudioContext =\r\n        //   (window as any).AudioContext || (window as any).webkitAudioContext;\r\n        // const audioContext = (this.audioContext = new AudioContextConstructor() as SketchAudioContext);\r\n        const audioContext = (this.audioContext = Howler.ctx as SketchAudioContext);\r\n        (THREE.AudioContext as any).setContext(audioContext);\r\n        this.userVolume = audioContext.createGain();\r\n        this.userVolume.gain.setValueAtTime(0.8, 0);\r\n        this.userVolume.connect(Howler.masterGain);\r\n        const audioContextGain = (audioContext.gain = audioContext.createGain());\r\n        audioContextGain.connect(this.userVolume);\r\n\r\n        const renderer = new THREE.WebGLRenderer({\r\n          alpha: true,\r\n          preserveDrawingBuffer: true,\r\n          antialias: true,\r\n        });\r\n        renderer.debug.checkShaderErrors = true;\r\n        ref.appendChild(renderer.domElement);\r\n\r\n        const [attempt, onWinLoss] = this.props.otherArgs || [];\r\n        const sketch = new Mito(renderer, this.audioContext, attempt as any, onWinLoss as any);\r\n        this.setState({ status: { type: \"success\", sketch: sketch } });\r\n      } catch (e) {\r\n        this.setState({ status: { type: \"error\", error: e } });\r\n        console.error(e);\r\n      }\r\n    } else {\r\n      if (this.state.status.type === \"success\") {\r\n        this.state.status.sketch.canvas.remove();\r\n      }\r\n      this.userVolume?.disconnect();\r\n      this.setState({ status: { type: \"loading\" } });\r\n    }\r\n  };\r\n\r\n  public render() {\r\n    const { otherArgs, eventsOnBody, errorElement, ...containerProps } = this.props;\r\n    const className = classnames(\"sketch-component\", this.state.status.type);\r\n    return (\r\n      <div {...containerProps} className={className} ref={this.handleContainerRef}>\r\n        {this.renderSketchOrStatus()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderSketchOrStatus() {\r\n    const { status } = this.state;\r\n    if (status.type === \"success\") {\r\n      // key on id to not destroy and re-create the component somehow\r\n      return <SketchSuccessComponent sketch={status.sketch} eventsOnBody={this.props.eventsOnBody} />;\r\n    } else if (status.type === \"error\") {\r\n      const errorElement = this.props.errorElement || this.renderDefaultErrorElement(status.error.message);\r\n      return errorElement;\r\n    } else if (status.type === \"loading\") {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private renderDefaultErrorElement(message: string) {\r\n    return (\r\n      <p className=\"sketch-error\">\r\n        Oops - something went wrong! Make sure you're using Chrome, or are on your desktop.\r\n        <pre>{message}</pre>\r\n      </p>\r\n    );\r\n  }\r\n}\r\n","import { SketchComponent } from \"game/screens/sketch/SketchComponent\";\r\nimport * as React from \"react\";\r\nimport \"./MitoScreen.scss\";\r\n\r\nexport interface ISketchRouteProps {\r\n  otherArgs?: any[];\r\n}\r\n\r\nexport default class MitoScreen extends React.PureComponent<ISketchRouteProps, {}> {\r\n  public render() {\r\n    return (\r\n      <div className=\"full-page-sketch\" ref={this.handleDivRef}>\r\n        <SketchComponent otherArgs={this.props.otherArgs} />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private handleDivRef = (div: HTMLDivElement | null) => {\r\n    if (div != null) {\r\n      // this.requestFullscreen(div);\r\n    } else {\r\n      this.exitFullscreen();\r\n    }\r\n  };\r\n\r\n  private exitFullscreen() {\r\n    if (document.webkitExitFullscreen) {\r\n      document.webkitExitFullscreen();\r\n    } else if (document.mozCancelFullScreen) {\r\n      document.mozCancelFullScreen();\r\n    }\r\n  }\r\n}\r\n","import { Button } from \"game/ui/common/Button\";\r\nimport Character from \"game/ui/common/Character\";\r\nimport React, { useEffect } from \"react\";\r\nimport { FaDiscord } from \"react-icons/fa\";\r\nimport \"./StartScreen.scss\";\r\n\r\nconst StartScreen: React.FC<{ onStart: () => void }> = React.memo(({ onStart }) => {\r\n  // useEffect(() => {\r\n  //   mitoStartScreen.play();\r\n  //   return () => {\r\n  //     mitoStartScreen.stop();\r\n  //   };\r\n  // }, []);\r\n  useEffect(() => {\r\n    const listenForEnter = (event: KeyboardEvent) => {\r\n      if (event.code === \"Enter\" || event.code === \"Space\") {\r\n        onStart();\r\n      }\r\n    };\r\n    window.addEventListener(\"keydown\", listenForEnter);\r\n    return () => {\r\n      window.removeEventListener(\"keydown\", listenForEnter);\r\n    };\r\n  }, [onStart]);\r\n\r\n  return (\r\n    <div className=\"start-screen\">\r\n      <h1>\r\n        Mito\r\n        <Character size=\"small\" className=\"mito-i\" />\r\n      </h1>\r\n      <div className=\"bottom-area\">\r\n        <Button color=\"green\" onClick={onStart}>\r\n          Start Game\r\n        </Button>\r\n        <a className=\"discord\" rel=\"noopener noreferrer\" target=\"_blank\" href=\"http://discord.gg/N8wWwPX\">\r\n          <FaDiscord />\r\n        </a>\r\n      </div>\r\n      <div className=\"game-version\">v0.8.0-dev</div>\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default StartScreen;\r\n","import { MousePositionContext } from \"common/useMousePosition\";\r\nimport { GameResult } from \"game/gameResult\";\r\nimport OverWorldScreen from \"game/screens/OverWorldScreen\";\r\nimport { Button } from \"game/ui/common/Button\";\r\nimport React, { memo, useRef } from \"react\";\r\nimport { FaDiscord } from \"react-icons/fa\";\r\nimport { CSSTransition } from \"react-transition-group\";\r\nimport { createSelector } from \"reselect\";\r\nimport { serialize } from \"serializr\";\r\nimport { LocalForageStateProvider } from \"../app/AppStateProvider\";\r\nimport { AppReducerContext, useAppReducer } from \"../app/reducer\";\r\nimport { AppState, AppStateSchema } from \"../app/state\";\r\nimport \"./App.scss\";\r\nimport GameResultsScreen from \"./GameResultsScreen\";\r\nimport MitoScreen from \"./MitoScreen\";\r\nimport StartScreen from \"./StartScreen\";\r\n\r\ninterface AppComponentState {\r\n  mousePosition: { x: number; y: number };\r\n  showStartScreen: boolean;\r\n  error?: Error;\r\n}\r\n\r\nclass AppComponent extends React.PureComponent<{}, AppComponentState> {\r\n  static contextType = AppReducerContext;\r\n\r\n  context!: React.ContextType<typeof AppReducerContext>;\r\n\r\n  constructor(props: {}, context: any) {\r\n    super(props, context);\r\n    this.state = {\r\n      mousePosition: { x: window.innerWidth / 2, y: window.innerHeight / 2 },\r\n      showStartScreen: true,\r\n      error: undefined,\r\n    };\r\n  }\r\n\r\n  handleMousePosition = (e: MouseEvent) => {\r\n    this.setState({\r\n      mousePosition: { x: e.clientX, y: e.clientY },\r\n    });\r\n  };\r\n\r\n  componentDidMount() {\r\n    document.addEventListener(\"mousemove\", this.handleMousePosition);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    document.removeEventListener(\"mousemove\", this.handleMousePosition);\r\n  }\r\n\r\n  static getDerivedStateFromError(error: Error) {\r\n    return { error };\r\n  }\r\n\r\n  // componentDidCatch(error: Error) {\r\n  //   this.setState({\r\n  //     error,\r\n  //   });\r\n  // }\r\n\r\n  handleNextEpoch = () => {\r\n    const [, dispatch] = this.context;\r\n    dispatch({ type: \"AANextEpoch\" });\r\n  };\r\n\r\n  handleWinLoss = (result: GameResult) => {\r\n    const [, dispatch] = this.context;\r\n    dispatch({\r\n      type: \"AATransitionStart\",\r\n      transition: {\r\n        type: \"AAGetGameResult\",\r\n        result,\r\n      },\r\n    });\r\n  };\r\n\r\n  handleResultsDone = () => {\r\n    const [, dispatch] = this.context;\r\n    dispatch({\r\n      type: \"AATransitionStart\",\r\n      transition: {\r\n        type: \"AAGameResultDone\",\r\n      },\r\n    });\r\n  };\r\n\r\n  handleCloseStartScreen = () => this.setState({ showStartScreen: false });\r\n\r\n  render() {\r\n    const [state] = this.context;\r\n\r\n    const appContent = this.state.error ? (\r\n      <AppError error={this.state.error} appState={state} />\r\n    ) : (\r\n      <>\r\n        <AppScreen show={this.state.showStartScreen}>\r\n          <StartScreen onStart={this.handleCloseStartScreen} />\r\n        </AppScreen>\r\n        <AppScreen show={state.activePopulationAttempt == null && !this.state.showStartScreen}>\r\n          <OverWorldScreen onNextEpoch={this.handleNextEpoch} />\r\n        </AppScreen>\r\n        <AppScreen show={state.activePopulationAttempt != null && state.activeGameResult == null}>\r\n          <MitoScreen otherArgs={this.otherArgsSelector(state)} />\r\n        </AppScreen>\r\n        <AppScreen show={state.activeGameResult != null}>\r\n          {state.activeGameResult ? (\r\n            <GameResultsScreen\r\n              attempt={state.activePopulationAttempt}\r\n              results={state.activeGameResult}\r\n              onDone={this.handleResultsDone}\r\n            />\r\n          ) : (\r\n            // HACK AppScreen *needs* one element; I think there's one single tick where\r\n            // AppScreen is still rendering its children even when it shouldn't.\r\n            <div></div>\r\n          )}\r\n        </AppScreen>\r\n      </>\r\n    );\r\n\r\n    return (\r\n      <MousePositionContext.Provider value={this.state.mousePosition}>\r\n        <div className=\"App\">{appContent}</div>\r\n      </MousePositionContext.Provider>\r\n    );\r\n  }\r\n\r\n  private otherArgsSelector = createSelector(\r\n    (s: AppState) => s.activePopulationAttempt,\r\n    (activePopulationAttempt) => [activePopulationAttempt, this.handleWinLoss]\r\n  );\r\n}\r\n\r\nconst AppError = React.memo(({ error, appState }: { error: Error; appState: AppState }) => {\r\n  const appStateJson = serialize(AppStateSchema, appState);\r\n  const errorRef = useRef<HTMLTextAreaElement>(null);\r\n  const errorReport = {\r\n    error: {\r\n      name: error.name,\r\n      message: error.message,\r\n      stack: error.stack,\r\n    },\r\n    time: new Date(),\r\n    appState: appStateJson,\r\n  };\r\n  const handleClick = () => {\r\n    const el = errorRef.current;\r\n    if (el) {\r\n      el.select();\r\n      document.execCommand(\"copy\");\r\n    }\r\n  };\r\n  return (\r\n    <div className=\"app-error\">\r\n      {/* eslint-disable-next-line jsx-a11y/accessible-emoji */}\r\n      <h1>Mito has crashed! </h1>\r\n      <div className=\"bottom\">\r\n        <p>Please report this to the dev team.</p>\r\n        <div className=\"instructions\">\r\n          <Button className=\"copy\" onClick={handleClick}>\r\n            Copy Error Report\r\n          </Button>\r\n          <span className=\"arrow-right\"></span>\r\n          <a className=\"discord\" rel=\"noopener noreferrer\" target=\"_blank\" href=\"http://discord.gg/N8wWwPX\">\r\n            <FaDiscord />\r\n          </a>\r\n        </div>\r\n      </div>\r\n      <textarea ref={errorRef} className=\"error-textarea\" value={JSON.stringify(errorReport, null, 2)} readOnly />\r\n    </div>\r\n  );\r\n});\r\n\r\nconst AppScreen: React.FC<{ show: boolean; children?: JSX.Element }> = memo(({ show, children }) => {\r\n  const [state] = useAppReducer();\r\n  return (\r\n    <CSSTransition\r\n      in={show && state.transition == null}\r\n      timeout={2000}\r\n      mountOnEnter\r\n      unmountOnExit\r\n      classNames=\"fade-to-black\"\r\n    >\r\n      {children}\r\n    </CSSTransition>\r\n  );\r\n});\r\n\r\nconst App = () => (\r\n  <LocalForageStateProvider loadingComponent={<div>Loading...</div>}>\r\n    <AppComponent />\r\n  </LocalForageStateProvider>\r\n);\r\n\r\nexport default App;\r\n","import { Environment } from \"core/environment\";\r\nimport { Layout, PlotData } from \"plotly.js\";\r\nimport React from \"react\";\r\nimport { World } from \"../core\";\r\nimport { newBaseSpecies } from \"../core/species\";\r\nimport { Air, Fountain, Rock, Soil } from \"../core/tile\";\r\nimport { Desert, Rocky, Temperate } from \"../std/environments\";\r\nimport { findBuildCandidateTiles } from \"../std/worldUtils\";\r\nimport { Experiment, ExperimentSuite } from \"./experiment\";\r\n\r\nfunction runTests(environment: Environment, id: string) {\r\n  console.log(\"running\");\r\n  const suite = new ExperimentSuite([\r\n    new Experiment({\r\n      countAir: (t) => t.filter((tile) => tile.constructor === Air).length,\r\n    }),\r\n    new Experiment({\r\n      countSoil: (t) => t.filter((tile) => tile.constructor === Soil).length,\r\n    }),\r\n    new Experiment({\r\n      countRock: (t) => t.filter((tile) => tile.constructor === Rock).length,\r\n    }),\r\n    new Experiment({\r\n      countFountain: (t) => t.filter((tile) => tile.constructor === Fountain).length,\r\n    }),\r\n    new Experiment({\r\n      playerY: (_, w) => w.player.pos.y,\r\n    }),\r\n    new Experiment({\r\n      startAdjacentWaters: (_, w) => {\r\n        const adjacentTiles = findBuildCandidateTiles(w, (t) => t instanceof Soil);\r\n        let water = 0;\r\n        for (const t of adjacentTiles) {\r\n          water += t.inventory.water;\r\n        }\r\n        return water;\r\n      },\r\n    }),\r\n    new Experiment({\r\n      countWaters: (t) => {\r\n        return t.reduce((w, tile) => w + tile.inventory.water, 0);\r\n      },\r\n    }),\r\n  ]);\r\n  for (let i = 0; i < 20; i++) {\r\n    console.time(\"trial \" + i);\r\n    const world = new World(environment, i, newBaseSpecies());\r\n    suite.recordDataFor(Array.from(world.allEnvironmentTiles()));\r\n    console.timeEnd(\"trial \" + i);\r\n  }\r\n\r\n  plotStackedBar(suite.experiments.slice(0, 4), id);\r\n\r\n  for (const e of suite.experiments) {\r\n    plotHistogram(e, id);\r\n  }\r\n}\r\n\r\nfunction plotStackedBar(experiments: Experiment[], divId: string) {\r\n  const data = [];\r\n  const names = experiments.map((e) => e.visitorNames().join(\"\"));\r\n  for (const idx in names) {\r\n    const name = names[idx];\r\n    const x = [];\r\n    const y = [];\r\n    for (let i = 0; i < experiments[0].trials.length; i++) {\r\n      x.push(i);\r\n\r\n      const e = experiments[idx];\r\n      const trial = e.trials[i];\r\n      const value = trial[name];\r\n      y.push(value);\r\n    }\r\n    const trace: Partial<PlotData> = {\r\n      x,\r\n      y,\r\n      name,\r\n      type: \"bar\",\r\n    };\r\n    data.push(trace);\r\n  }\r\n  var layout: Partial<Layout> = { barmode: \"stack\" };\r\n\r\n  const div = document.createElement(\"div\");\r\n  const el = document.getElementById(divId)!;\r\n  el.appendChild(div);\r\n  window.Plotly.newPlot(div, data, layout);\r\n}\r\n\r\nfunction plotHistogram(stats: Experiment, divId: string) {\r\n  const data = [];\r\n  const layout: Partial<Layout> = {};\r\n\r\n  for (const name of stats.visitorNames()) {\r\n    var trace: Partial<PlotData> = {\r\n      x: stats.trials.map((t) => t[name]),\r\n      type: \"histogram\",\r\n      name: name,\r\n    };\r\n    data.push(trace);\r\n\r\n    layout.title = {\r\n      text: name,\r\n    };\r\n  }\r\n  const div = document.createElement(\"div\");\r\n  const el = document.getElementById(divId)!;\r\n  el.appendChild(div);\r\n  div.style.height = \"240px\";\r\n  div.style.width = \"320px\";\r\n  div.style.display = \"inline-block\";\r\n  window.Plotly.newPlot(div, data, layout);\r\n}\r\n\r\nfunction TestStats() {\r\n  React.useEffect(() => {\r\n    var script = document.createElement(\"script\");\r\n    script.src = \"https://cdn.plot.ly/plotly-latest.min.js\";\r\n    script.addEventListener(\"load\", function() {\r\n      runTests(Temperate, \"temperate\");\r\n      runTests(Rocky, \"rocky\");\r\n      runTests(Desert, \"desert\");\r\n    });\r\n\r\n    document.body.appendChild(script);\r\n  }, []);\r\n\r\n  return (\r\n    <div>\r\n      <h1>Experiments</h1>\r\n      <div id=\"temperate\">\r\n        <h2>Temperate</h2>\r\n      </div>\r\n      <div id=\"rocky\">\r\n        <h2>Rocky</h2>\r\n      </div>\r\n      <div id=\"desert\">\r\n        <h2>Desert</h2>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default TestStats;\r\n","import React from \"react\";\r\nimport { Link, Route, RouteComponentProps, Switch } from \"react-router-dom\";\r\nimport TestDiffusion from \"tests/TestDiffusion\";\r\nimport { TestLoseScreen } from \"tests/TestLoseScreen\";\r\nimport { TestWinScreen } from \"tests/TestWinScreen\";\r\nimport App from \"./game/screens/App\";\r\nimport \"./index.scss\";\r\nimport TestStats from \"./tests/TestStats\";\r\n\r\nexport default () => (\r\n  <Switch>\r\n    <Route path=\"/test-lose\">\r\n      <TestLoseScreen />\r\n    </Route>\r\n    <Route path=\"/test-win\">\r\n      <TestWinScreen />\r\n    </Route>\r\n    <Route path=\"/test-stats\">\r\n      <TestStats />\r\n    </Route>\r\n    <Route path=\"/test-diffusion\">\r\n      <TestDiffusion />\r\n    </Route>\r\n    <Route exact path=\"/\">\r\n      <App />\r\n    </Route>\r\n    <Route path=\"*\" component={Page404} />\r\n  </Switch>\r\n);\r\n\r\nconst Page404: React.FC<RouteComponentProps> = () => {\r\n  return (\r\n    <div>\r\n      <h1>Unknown page</h1>\r\n      <Link to=\"/\">Back to main screen</Link>\r\n    </div>\r\n  );\r\n};\r\n","import { createModelSchema, primitive } from \"serializr\";\r\nimport { Color, Vector2 } from \"three\";\r\ncreateModelSchema(Color, {\r\n  r: primitive(),\r\n  g: primitive(),\r\n  b: primitive(),\r\n});\r\ncreateModelSchema(Vector2, {\r\n  x: primitive(),\r\n  y: primitive(),\r\n});\r\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === \"localhost\" ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === \"[::1]\" ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(/^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/)\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === \"production\" && \"serviceWorker\" in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL((process as { env: { [key: string]: string } }).env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener(\"load\", () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            \"This web app is being served cache-first by a service \" +\n              \"worker. To learn more, visit https://bit.ly/CRA-PWA\"\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then((registration) => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === \"installed\") {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                \"New content is available and will be used when all \" +\n                  \"tabs for this page are closed. See https://bit.ly/CRA-PWA.\"\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log(\"Content is cached for offline use.\");\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch((error) => {\n      console.error(\"Error during service worker registration:\", error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then((response) => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get(\"content-type\");\n      if (response.status === 404 || (contentType != null && contentType.indexOf(\"javascript\") === -1)) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then((registration) => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\"No internet connection found. App is running in offline mode.\");\n    });\n}\n\nexport function unregister() {\n  if (\"serviceWorker\" in navigator) {\n    navigator.serviceWorker.ready.then((registration) => {\n      registration.unregister();\n    });\n  }\n}\n","// import \"@blueprintjs/icons/lib/css/blueprint.css\";\r\nimport React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport { HashRouter } from \"react-router-dom\";\r\nimport Routes from \"Routes\";\r\nimport \"./addThreeJsModelSchemas\";\r\nimport \"./index.scss\";\r\nimport * as serviceWorker from \"./serviceWorker\";\r\nfunction requireAll(r: any) {\r\n  r.keys().forEach(r);\r\n}\r\nrequireAll((require as any).context(\"./std/genes/\", true, /Gene.*\\.tsx?$/));\r\n\r\nReactDOM.render(\r\n  <HashRouter>\r\n    <Routes />\r\n  </HashRouter>,\r\n\r\n  document.getElementById(\"root\")\r\n);\r\n\r\n// If you want your app to work offline and load faster, you can change\r\n// unregister() to register() below. Note this comes with some pitfalls.\r\n// Learn more about service workers: https://bit.ly/CRA-PWA\r\nserviceWorker.unregister();\r\n"],"sourceRoot":""}