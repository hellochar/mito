{"version":3,"sources":["math/random.ts","math/index.ts","core/tile/fountain.ts","core/tile/index.ts","core/constants.ts","std/genes/index.ts","common/plantNames.ts","core/cell/gene.ts","game/audio.ts","core/cell/genome.ts","std/ticker.ts","std/genes/GN.tsx","core/inventory.ts","core/cell/cell.ts","core/directions.ts","std/genes/GeneReproducer.tsx","core/tile/soil.ts","common/formatters.ts","core/cell/chromosome.ts","core/temperature.ts","game/ui/common/DynamicNumber.tsx","core/tile/tile.ts","std/genes/GenePhotosynthesis.tsx","game/ui/common/MP.tsx","std/genes/GeneObstacle.tsx","core/cell/cellEffect.ts","core/entity.ts","common/mapRecord.ts","core/cell/realizedGene.ts","core/tile/canPullResources.ts","math/shuffle.ts","std/genes/GeneDirectionalPush.tsx","common/perlin.ts","core/cell/deadCell.ts","std/genes/GeneAttractsSugar.tsx","std/genes/GeneCannotFreeze.tsx","core/cell/growingCell.ts","core/tile/rock.ts","core/cell/geneInstance.ts","core/tile/air.ts","core/cell/materialInfo.ts","core/interactable.ts","common/devlog.ts","std/genes/GeneAttractsWater.tsx","std/genes/GeneEnergyTransfer.tsx","std/genes/GeneInventory.tsx","std/genes/GeneLiving.tsx","std/genes/GeneMetabolism.tsx","std/genes/GeneSoilAbsorption.tsx","std/genes/GeneVascular.tsx","assets/audio/Blop-Mark_DiAngelo-79054334.mp3","assets/audio/build.mp3","assets/audio/build_complete.mp3","assets/audio/deconstruct.mp3","assets/audio/drop_water.mp3","assets/audio/eating.mp3","assets/audio/footsteps.wav","assets/audio/fruit-popOpen.mp3","assets/audio/impactSoft_medium_003.mp3","assets/audio/interact.mp3","assets/audio/intro-bounce.mp3","assets/audio/mito-base.mp3","assets/audio/mito-drums.mp3","assets/audio/mito-overworld.mp3","assets/audio/mito-start.mp3","assets/audio/mito-strings.mp3","assets/audio/mitodeath.mp3","assets/audio/sticky.mp3","assets/audio/suckwater.wav","assets/audio/whoosh.mp3","assets/images/fruit.png","assets/images/character.png","assets/images/test-vignette.png","assets/images/spritesheet.png","assets/images/sugar.png","assets/images/water.png","std/genes sync /Gene.*/.tsx?$","std/genes/GeneDiffuseSugar.tsx","std/genes/GeneDiffuseWater.tsx","std/genes/GenePushWater.tsx","std/genomes/standardGenome.ts","common/promise.ts","core/player/player.ts","core/season.ts","core/world/stepStats.ts","math/arrays.ts","std/tileGenerators.ts","core/world/generatorContext.ts","core/world/weatherController.ts","core/world/world.ts","std/genomes/tutorialGenome.ts","core/species.ts","tests/experiment.ts","tests/TestDiffusion.tsx","std/environments.ts","game/ui/common/Character.tsx","game/ui/common/Glow.tsx","game/screens/GameResultsScreen.tsx","tests/TestWinScreen.tsx","tests/TestLoseScreen.tsx","common/useMousePosition.ts","game/ui/GenomeViewer/generateRandomGenes.tsx","game/app/reducer.ts","core/environment.ts","core/overworld/levelInfo.ts","core/overworld/hexTile.ts","core/overworld/hexStore.ts","core/overworld/overWorld.ts","game/app/state.ts","game/app/saveLoad.ts","game/ui/common/Button.tsx","game/ui/common/LookAtMouse.tsx","game/ui/overworld/SpeciesNode.tsx","game/ui/overworld/PhylogeneticTree.tsx","game/ui/overworld/EpochUI.tsx","math/poissonDisc.ts","game/ui/overworld/hexMath.ts","game/ui/common/Expand.tsx","game/ui/overworld/map/HexInfo.tsx","game/ui/overworld/map/hexTileSprite.ts","game/ui/overworld/map/OverWorldPopover.tsx","game/ui/overworld/map/OverWorldMap.tsx","game/ui/GenomeViewer/AddCellCard.tsx","common/lazy.ts","game/spritesheet.ts","game/ui/common/IconCell.tsx","game/ui/GenomeViewer/CellInteractionSelector.tsx","game/ui/GenomeViewer/DragInfo.tsx","game/ui/GenomeViewer/GeneCost.tsx","game/ui/GenomeViewer/GeneViewer.tsx","game/ui/GenomeViewer/CellTypeViewer.tsx","game/ui/GenomeViewer/index.ts","game/ui/GenomeViewer/GenomeViewer.tsx","game/screens/SpeciesViewer.tsx","game/screens/OverWorldScreen.tsx","game/app/AppStateProvider.tsx","game/params.ts","game/input/mouse.ts","game/screens/sketch/sketch.ts","game/renderers/Renderer.tsx","game/renderers/glsl.ts","game/renderers/committablePoints.ts","game/renderers/fireAndForgetPoints.ts","game/renderers/events/eventRenderer.ts","game/renderers/events/eventRendererFFPoints.ts","game/renderers/events/eventCellEatRenderer.ts","game/renderers/events/eventCellTransferEnergyRenderer.ts","math/easing.ts","game/renderers/events/eventCollectSunlightRenderer.ts","game/renderers/InventoryRenderer.tsx","game/renderers/events/eventEvaporationRenderer.ts","game/renderers/events/eventGrowFruitRenderer.ts","game/renderers/events/eventPhotosynthesisRenderer.ts","game/renderers/tile/CellEffectsRenderer.tsx","game/renderers/events/eventThawIceRenderer.ts","game/renderers/events/eventLogRenderer.ts","game/renderers/neuronMesh.ts","game/renderers/tile/Animation.tsx","game/renderers/PlayerRenderer.tsx","game/renderers/PlayerSeedRenderer.tsx","common/arrayProxy.ts","game/renderers/tile/GeneRenderer.tsx","game/renderers/tile/GeneDirectionalPushRenderer.tsx","game/renderers/tile/makeLine.ts","game/renderers/tile/GenePhotosynthesisRenderer.tsx","game/renderers/tile/GeneReproducerRenderer.tsx","game/renderers/tile/GeneSoilAbsorptionRenderer.tsx","game/renderers/tile/InstancedTileRenderer.tsx","game/renderers/tile/tileBatcher.ts","game/renderers/WorldRenderer.tsx","std/vignette.ts","game/gameResult.ts","game/input/keyboard.ts","game/input/keymap.ts","game/input/ControlScheme.tsx","game/input/toolBar.ts","game/mito/WorldDOMElement.tsx","game/tutorial/Animate.tsx","game/tutorial/sceneObject.tsx","game/tutorial/tileHighlight.tsx","game/tutorial/buildBlueprint.tsx","game/tutorial/PointHighlight.tsx","game/ui/ingame/Hover.tsx","game/ui/ingame/HotkeyButton.tsx","game/ui/common/ResourceIcon.tsx","game/ui/ingame/InventoryBar.tsx","game/ui/ingame/TemperatureInfo.tsx","game/ui/ingame/TileDetails.tsx","game/ui/ingame/hud/CellInspector.tsx","game/ui/ingame/hud/SeasonsTracker.tsx","game/ui/ingame/hud/ToolBarUI.tsx","game/ui/ingame/hud/HUD.tsx","game/ui/ingame/PlantStats.tsx","game/ui/ingame/Debug.tsx","game/ui/ingame/Instructions.tsx","game/mito/ovalNode.ts","game/mito/mito.tsx","common/configure.ts","game/mito/logRenderInfo.tsx","game/mito/perfDebugThreeObjects.ts","game/screens/sketch/SketchComponent.tsx","game/screens/MitoScreen.tsx","game/screens/StartScreen.tsx","game/screens/App.tsx","tests/TestStats.tsx","std/worldUtils.ts","Routes.tsx","addThreeJsModelSchemas.ts","serviceWorker.ts","index.tsx"],"names":["randFloat","min","max","Math","random","randInt","inclusiveMin","inclusiveMax","floor","lerp","a","b","x","lerp2","v","t","l","y","map","xStart","xStop","yStart","yStop","clamp","sampleArray","length","randRound","ix","fx","mod","m","sawTooth","Fountain","pos","world","secondsPerWater","waterRemaining","displayName","isObstacle","cooldown","dt","this","inventory","space","add","silt","Silt","clone","give","water","sugar","maybeRemoveCellAt","setTileAt","PLAYER_BASE_SPEED","PLAYER_MAX_RESOURCES","PLAYER_STARTING_WATER","PLAYER_STARTING_SUGAR","PLAYER_INTERACT_EXCHANGE_SPEED","TIME_PER_YEAR","TIME_PER_SEASON","TIME_PER_MONTH","TIME_PER_DAY","PERCENT_DAYLIGHT","CELL_BUILD_TIME","CELL_DROOP","TISSUE_INVENTORY_CAPACITY","LEAF_REACTION_TIME","SUNLIGHT_REINTRODUCTION","SUNLIGHT_DIFFUSION","Gene","blueprint","initialStateFn","stepFn","shouldStepFn","level","RealizedGene","initialState","step","shouldStep","defaultShouldStepFn","gene","name","exists","AllGenesByName","has","newName","plantNames","console","warn","set","Map","defaultProperties","cantFreeze","isReproductive","inventoryCapacity","diffusionWater","diffusionSugar","timeToBuild","isDirectional","mito","strings","drums","mitoDeath","Howl","src","mitoDeathMp3","autoplay","loop","volume","mitoOverworld","mitoStartScreenMp3","mitoOverworldMp3","footsteps","footstepsSrc","interactSound","interactSoundSrc","introBounce","introBounceSrc","whoosh","whooshSrc","fruitPoof","fruitPoofSrc","build","buildSoundSrc","buildComplete","buildCompleteSrc","deconstruct","deconstructSoundSrc","sticky","stickySoundSrc","dropSugar","impactSoftMedium003Src","dropWater","dropWaterSrc","loader","THREE","loadAudioPromise","Promise","resolve","reject","load","audioBuffer","xhr","err","devlog","blopBuffer","blopSrc","suckWaterBuffer","suckWaterSrc","eatBuffer","eatingSoundSrc","hookUpAudio","ctx","numDone","oneMoreLoaded","audio","currentTime","gain","connect","makeUnitFromAudioAsset","mitoBaseSrc","oncanplaythrough","value","mitoStringsSrc","mitoDrumsSrc","sourceElement","type","substr","source","document","createElement","srcs","appendChild","createMediaElementSource","createGain","distScalar","player","dist","distanceToSquared","interactSpeedMap","interactionSpeed","interaction","resources","CellInteractionSchema","createSimpleSchema","CellType","serializable","object","Chromosome","MaterialInfoSchema","geneSlots","chromosome","material","args","mergeStaticProperties","direction","Vector2","rotateAround","PI","setLength","round","Genome","list","cellTypes","unusedGenes","describeCellInteraction","Ticker","tickerId","tickers","_time","tickerLoop","time","toDelete","id","f","push","Number","removeAnimation","requestAnimationFrame","fn","start","GN","props","className","fpref","Inventory","capacity","carrier","events","validate","other","amountWater","amountSugar","Error","spaceNeeded","spaceAvailable","change","emit","EventEmitter","on","off","newWater","newSugar","hasInventory","obj","Cell","energy","darkness","nextTemperature","droopY","effects","geneInstances","staticProperties","isDead","dir","isFractional","lengthManhattan","error","temperatureFloat","newGeneInstances","n","tempo","effect","constructor","stacks","findEffectOfType","FreezeEffect","attachTo","find","e","isInteractable","action","interact","target","continuous","DeadCell","g","isType","tileNeighbors","stepDroop","height","equals","posFloat","die","forEach","neighbors","neighborTemperatures","Array","from","values","chanceToFreeze","temperature","Temperature","Cold","addEffect","waterToLose","chanceEvaporate","Hot","logEvent","tile","below","get","DIRECTIONS","s","belowLeft","sw","belowRight","se","left","w","right","above","aboveLeft","nw","aboveRight","ne","droopAmount","cell","Rock","Soil","springNeighborCells","filter","reduce","sum","Tile","DIRECTION_VALUES","Object","keys","o","GeneFruit","make","levelCosts","levelProps","mpEarned","neededResources","secondsToMature","static","description","reproducerDescription","isMature","committedResources","instance","reproducerStep","GeneSeed","amount","state","oneSecondCommitMax","wantedWater","wantedSugar","resourcesUsed","commitResources","isNowMature","reproducerGetPercentMatured","timeMatured","earnMP","r","depth","stepEvaporation","secondsToEvaporate","environment","evaporationChance","waterToEvaporate","numEvaporatedSoil","diffusionRate","saturation","freeWater","fallAmount","lowerNeighbor","tileAt","canPullResources","waterToGive","Sand","depthDiffusionFactor","Clay","cache","nf","maximumSignificantDigits","minimumSignificantDigits","key","Intl","NumberFormat","undefined","useGrouping","format","genes","GeneLiving","GeneInventory","finalProps","entries","getStaticProperties","k","newInstance","getCost","c","geneSlotsAdded","geneSlotsUsed","temperatureFor","Freezing","Mild","Scorching","currentTemperature","averageTemperature","DynamicNumber","speed","sigFigs","React","useState","setV","useEffect","addAnimation","abs","Infinity","dtSinceLastStepped","timeMade","weather","getCurrentTemperature","sqrt","giveCandidates","isEmpty","shuffle","i","neighbor","isMaxed","splice","stepDarkness","stepDiffusion","stepTemperature","stepGravity","_dt","minDarkness","darknessFromNeighbor","darknessContrib","diffuseWater","diffuseSugar","giver","difference","diffusionAmount","GenePhotosynthesis","reactionChancePerSecond","totalSugarProduced","averageConversionRate","averageChancePerSecond","sugarConverted","activeNeighbors","numAir","Air","maybePhotosynthesize","air","sunlight","waterToConvert","ambientChancePerSecond","leaf","numSunlight","chancePerSecond","MP","total","classNames","GeneObstacle","CellEffect","onAttached","index","indexOf","secondsToDie","percentFrozen","chunkCooldown","where","onFrozenChanged","StopStep","remove","age","CancerEffect","secondsPerDuplication","timeToDuplicate","canBuildAt","attemptBuild","cellType","position","isSteppable","sDt","mapRecord","out","val","custom","setLevel","arr","isArray","newLevel","GeneInstance","getProps","receiver","hasAncestry","areCells","areSoils","isAirToSoil","array","temporaryValue","randomIndex","currentIndex","GeneDirectionalPush","secondsPerPush","didJustTransport","forwardTile","backwardTile","waterToTransport","sugarToTransport","Grad","z","grad3","p","F2","G2","G3","Noise","seed","perm","gradP","octaveNum","octaveFalloff","octaveMatrix2","cos","sin","xin","yin","i1","j1","j","x0","y0","x1","y1","x2","y2","gi0","gi1","gi2","t0","t1","t2","dot2","scalar","simplex2","newX","newY","zin","k1","i2","j2","k2","z0","z1","z2","x3","y3","z3","gi3","t3","dot3","simplex3","X","Y","n00","n01","n10","n11","u","fade","Z","n000","n001","n010","n011","n100","n101","n110","n111","GeneAttractsSugar","secondsPerPull","GeneCannotFreeze","chromosomeGrowingCell","GrowingCell","completedCell","cellTypeGrowingCell","percentMatured","timeToMaturity","silent","copy","play","rate","maybeNewState","sunlightCached","_co2","computeCo2","base","floorCo2","scaleX","offset","noiseCo2","perlin3","width","stepDiffusionCheap","tryDiffuse","airEvaporation","numEvaporatedAir","color","Color","texturePosition","message","GeneAttractsWater","GeneEnergyTransfer","differenceThreshold","ENERGY_GIVE_RATE","manhattanDistanceTo","maybeGiveEnergy","energyToGive","to","_","secondsPerUpkeep","GeneMetabolism","energyPerSugar","EAT_ENERGY_PER_SECOND","maxEnergyToEat","hunger","getMaxEnergyToEat","sugarToEat","gotEnergy","who","stepEatSugar","GeneSoilAbsorption","secondsPerAbsorb","totalSucked","doneOnce","absorbWater","GeneVascular","vascularNeighbors","module","exports","webpackContext","req","webpackContextResolve","__webpack_require__","code","GeneDiffuseSugar","GeneDiffuseWater","GenePushWater","cellTypeTissue","cellTypeLeaf","cellTypeRoot","cellTypeTransport","cellTypeFruit","standardGenome","sleep","millis","setTimeout","Player","baseSpeed","currentTile","getMovespeedMultiplier","actions","duration","elapsed","bfsIterator","isWalkable","needWater","needSugar","event","cb","nearestWalkableCell","findNearestWalkableCell","successful","attemptAction","_attemptAction","log","attemptMove","attemptDeconstruct","attemptDrop","attemptPickup","attemptMultiple","attemptLong","attemptThaw","nextPos","isValidPosition","cellAt","getBuildError","matureCell","tryConstructingNewCell","force","refund","waterToDrop","sugarToDrop","inv","multiple","allSuccess","thaw","PlayerSeed","poppedOut","velY","removePlayerSeed","genome","growingCell","distanceTo","then","seasonFromTime","year","timeInYear","season","percent","month","day","SEASON_NAMES","seasonDisplay","StepStats","frame","deleted","added","evaporation","photosynthesis","oof","arrayRange","fill","gridRange","mixedSoilRock","generatorContext","noiseSoil","noiseWater","octaveSimplex2","TileGenerators","Level0","noiseHeight","noiseRock","soilLevel","perlin2","rockThreshold","heightScalar","pow","simplexValue","emitWaterScalar","Temperate","Desert","isRock","Rocky","Reservoires","isRockHere","isRockBelow","SkySoil","modulateSeed","letter","charCodeAt","createGeneratorContext","WeatherController","temperaturePerSeason","updateTemperatures","computeSunlight","stepWeather","climate","timeBetweenRainfall","rainDuration","numWater","waterPerSecond","dropletSize","numRainWater","sunAngle","directionalBias","sunAmount","environmentTileAt","tileUp","tileRight","tileLeft","upSunlight","rightSunlight","leftSunlight","allCells","timeOfDay","atan","optionsDefault","World","species","optionsPartial","playerSeed","gridEnvironment","gridCells","neighborCache","mpEarners","cachedEntities","stepStats","options","tileGenerator","computeTileNeighbors","fillCachedEntities","computeSoilDepths","firstNonAir","tileEnvironment","tileCell","xOrVec2","oldTile","redistributeInventoryToNeighbors","oldCell","oldEnvironmentTile","handleTileUpdated","px","py","mapping","DIRECTION_VALUES_RAND","newEntities","reverse","entities","entity","airPositions","allEnvironmentTiles","minNeighborDepth","totalSugar","totalWater","totalEnergy","Symbol","iterator","self","row","return","limit","heuristic","frontier","processed","Set","size","shift","manhattanLength","sort","slice","cellTypeSeed","tutorialGenome","SpeciesSchema","identifier","primitive","freeMutationPoints","totalMutationPoints","geneOptions","newBaseSpecies","uuid","descendants","lineage","parent","reference","Experiment","visitors","trials","tiles","trial","results","result","visitor","visit","ExperimentSuite","experiments","recordDataFor","allSoilEnvironment","testWorld","runTwoWideCompare","world1","world2","cell1","cell2","c1w","experiment","timeEnd","TestDiffusion","script","addEventListener","divId","data","trialIndex","visitorNames","trace","div","getElementById","window","Plotly","newPlot","barmode","plotStackedBar","e1","runOneWideAbsolute","table","e2","body","Character","otherProps","alt","characterSrc","Glow","FruitResult","fruit","scale","style","transform","fruitSrc","toFixed","ReproductiveCellResult","findGene","toString","MPEarnerList","GameWonScreen","winDescription","mutationPointsPerEpoch","vignettes","toDataURL","GameLostScreen","stop","GameResultsScreen","onDone","status","onClick","mockFruit","TestWinScreen","f1","f2","f3","mockResults","TestLoseScreen","MousePositionContext","createContext","innerWidth","innerHeight","useMousePosition","useContext","generateRandomGenes","numGenes","AllGenes","randomGene","AppReducerContext","useAppReducer","reducer","populationAttempt","targetHex","sourceHex","info","visible","flora","activePopulationAttempt","handleStartPopulationAttempt","handlePopulationAttemptSuccess","rootSpecies","epoch","handleNextEpoch","attempt","activeGameResult","handleGetGameResult","handleGameResultDone","transition","handleTransitionStart","settlingSpecies","oldSpecies","overWorld","getMaxGenePool","hexNeighbors","EnvironmentSchema","LevelInfoSchema","rainfall","soilType","wind","actionPoints","C","HexTile","MAX_SAFE_INTEGER","HexStore","hash","OverWorld","storage","startTile","hex","populatedActiveNeighbors","pool","noise","cartesian","noise3D","randomHeight","maxDist","SimplexNoise","populateLevelInfo","getDefaultStartTile","magnitude","AppStateSchema","save","appState","json","serialize","stringToSave","JSON","stringify","localforage","setItem","getItem","string","parse","deserialize","ACTIONS_TO_SAVE_ON","AAGameResultDone","AAGetGameResult","AAUpdateSpecies","AANextEpoch","AAPopulationAttemptSuccess","AAStartPopulationAttempt","Button","children","LookAtMouse","mouse","useBoundingclientrectRef","ref","displayBlock","zScale","restProps","useMemo","midX","midY","top","ox","oy","rotY","rotX","SpeciesNode","onMutate","handleClick","useCallback","PhylogeneticTree","EpochUI","onNextEpoch","onFocusHex","transitioning","setTransitioning","disabled","poissonDisc","radius","initialSample","rng","radius2","R","cellSize","SQRT1_2","gridWidth","ceil","gridHeight","grid","queue","queueSize","sampleSize","far","i0","j0","dx","dy","sample","sampler","samples","Y_SQUISH_FACTOR","getClickedHexCoords","canvas","camera","dX","dY","cX","cY","nativeEvent","offsetX","offsetY","rx","ry","rz","x_diff","y_diff","z_diff","roundCubeCoordinates","pixelPosition","getCameraPositionCenteredOn","vectors","isPointInHexagon","HALF_HEIGHT","q2x","q2y","Expand","shrunkElements","expanded","setExpanded","HexInfo","playSpecies","onClickPlay","playButtonElement","header","isHabitable","stringifyInfo","expand","fontSize","testVignette","Image","testVignetteUrl","COLOR_SCALE_HEIGHT","scaleLinear","domain","range","HexTileSprite","context","vignettePositions","isHovered","lineWidth","isShadowed","globalAlpha","fillStyle","strokeStyle","drawHex","drawNumericHeight","drawVignettes","beginPath","moveTo","arc","stroke","drawCircle","drawPulse","tOffset","thickness","easePulse","now","font","textAlign","textBaseline","fillText","positions","dropFirst","normSamples","generateNaturalRandomHexagonPoints","sizeScale","drawImage","highlightedHex","angle","lineTo","closePath","easeExpIn","OverWorldPopover","container","OverWorldMap","hexTileSprites","rafId","handleCanvasRef","setState","handleResize","handleCanvasClick","coords","cameraState","clicked","hexAt","possibleMigrationSources","handleCanvasMouseLeave","hoveredHex","handleCanvasMouseMove","handleClickPlay","dispatch","appAction","getAppAction","handleKeyDown","repeat","newPressedKeys","pressedKeys","handleKeyUp","handleWheel","delta","deltaX","deltaY","updateCanvas","updateCamera","nextScale","targetDX","targetDY","getStartHex","sprite","getContext","drawMap","drawMigrationArrows","drawPopulationAttempt","clearRect","setIsHovered","sprites","zIndex","draw","drawPossibleMigrationIntoArrows","drawPossibleMigrationOutOfArrows","drawMigrationArrow","removeEventListener","prevProps","focusedHex","focusHex","tStart","targetX","targetY","tabIndex","onMouseLeave","onMouseMove","maybeRenderPopover","possibleMigrationTargets","shadowBlur","shadowOffsetX","shadowOffsetY","shadowColor","lineCap","lineJoin","targetCenter","sourceCenter","arrowStart","arrowEnd","fromx","fromy","tox","toy","headlen","atan2","drawArrow","PureComponent","contextType","AddCellCard","handleAddCell","newCellType","basic","lazy","spritesheetLoaded","SPRITESHEET","spritesheetUrl","texture","magFilter","flipY","wrapS","wrapT","dispatchEvent","textureFromSpritesheet","backgroundColor","drawSpriteToCanvas","image","fillRect","needsUpdate","ActionBarItem","IconCell","getStyle","url","HTMLCanvasElement","backgroundImage","CellInteractionSelector","memo","setInteraction","handleSelect","indexOrUndefined","possibleInteractions","selectValue","findIndex","interactionEl","onChange","resourceTypes","flatMap","DraggedContext","GeneCost","cost","negative","GeneViewer","gd","handleDragStart","dataTransfer","setData","dragged","draggable","view","replace","onDragStart","CellTypeViewer","handleDrop","preventDefault","leavingCellType","handleDragOver","dropEffect","handleSetInteraction","geneSlotsNet","onDragOver","onDrop","GenomeViewer","tuple","handleViewSmall","handleViewExpanded","Provider","dragging","active","SpeciesViewer","MutationChooser","geneEl","geneOption","OverWorldScreen","leftPanelOpen","setLeftPanelOpen","open","genomeViewerSpecies","setGenomeViewerSpecies","handleStartMutate","closeGenomeViewer","setFocusedHex","handleFocusHex","unusedPoints","unusedPointsEl","maybeRenderPhylogeneticTreePanel","ariaHideApp","isOpen","shouldCloseOnEsc","shouldCloseOnOverlayClick","onRequestClose","confirm","removeItem","location","reload","handleTransitionEndMiddleware","stateWithoutTransition","handleTransitionEnd","AppStateProvider","reducerWithMiddleware","newState","hasOwnProperty","useReducer","dispatchRaw","newDispatch","autoTransitionEndDispatchMiddleware","reducerTuple","LocalForageStateProvider","loadingComponent","catch","newGameState","generateRectangle","startHex","newInitialAppState","PARAMS_DEFAULT","hud","showGodUI","debugPerf","debug","process","params","search","urlHashParams","assign","nonDefaultParams","stringified","updateParamsHash","Mouse","el","isPressed","button","handleMouseDown","handleMouseMove","clientX","clientY","handleMouseUp","UI_EVENTS","click","contextmenu","dblclick","mousedown","mouseup","mousemove","touchstart","touchmove","touchend","keyup","keydown","keypress","wheel","ISketch","renderer","audioContext","elements","timeElapsed","frameCount","domElement","Renderer","scene","glsl","CommittablePoints","geometry","newGeometry","ResourcePointsMaterial","frustumCulled","BufferGeometry","Float32Array","rotations","sizes","alphas","setAttribute","BufferAttribute","setUsage","DynamicDrawUsage","alpha","attributes","setXYZ","setX","rotation","setDrawRange","Points","uniforms","opacity","sizeGlobal","vertexShader","fragmentShader","depthTest","transparent","ShaderMaterial","FireAndForgetPoints","lifeFn","toRemove","delete","startFrame","commit","endFrame","EventRenderer","eventName","worldRenderer","getLastStepStats","EventRendererFFPoints","ffPoints","update","handle","commitAll","EventCellEatRenderer","makePoints","Audio","audioListener","setVolume","buffer","setBuffer","setDetune","setValueAtTime","cancelScheduledValues","setTargetAtTime","tileRenderer","renderers","activeSugar","inventoryRenderer","getActiveSugar","fire","EventCellTransferEnergyRenderer","reversed","polyUpDown","polyEarlyUpDown","EventCollectSunlightRenderer","point","graphics","InventoryRenderer","animationOffset","waters","sugars","stableWater","handleGetResources","updateSugarAndWaterParticles","handleGiveResources","handleAddResources","WaterParticles","SugarParticles","updateParticlesArray","verifyArrayLengths","particles","resource","wantedParticles","sub","resourceArray","numFullSizedParticles","fract","numWaters","numResources","vx","vy","goTowardsCenterStrength","playerX","playerY","mag2","avoidPlayerStrength","lengthSq","strength","simulateResourcePositions","commitParticles","EventEvaporationRenderer","getStableWater","EventGrowFruitRenderer","a0","easeCubicIn","EventPhotosynthesisRenderer","CellEffectsRenderer","createEffectRenderer","destroy","FreezeEffectRenderer","CancerEffectRenderer","FREEZE_BLUE","mesh","newMesh","PlaneBufferGeometry","MeshBasicMaterial","side","DoubleSide","Mesh","RingBufferGeometry","EventThawIceRenderer","easeSinOut","EventLogRenderer","singleEventRenderers","baseMesh","CircleBufferGeometry","Node","vel","NeuronMesh","numNodes","nodes","meshes","line","pullForceScalar","towardsTargetForce","dragForceScalar","goTowardsTargetForce","node","multiplyScalar","dragForce","drag","pullForce","lineGeo","Geometry","vertices","Line","LineBasicMaterial","last","prev","next","verticesNeedUpdate","Object3D","AnimationController","animation","timeStarted","timeLastUpdated","ended","chain","animations","numEnded","lastStarted","currAnimation","also","firstAnim","secondAnim","secondEnded","firstEnded","animPause","PlayerRenderer","neuronMesh","handleStartLongAction","buildReproducerAnimation","handleAction","handleInteracted","prevHighlightedTile","droopPosFloat","addFloatingText","isInteract","controls","wouldLeftClickInteract","highlight","getHighlightedTile","neuronMeshTarget","ZERO","actionLong","animWaitForCameraZoomIn","animSendCopy","animWaitEnd","tNorm","shakeFrequency","shakeAmplitude","suggestCamera","center","zoom","easeSinInOut","renderOrder","PlayerSeedRenderer","scenePlayerSeed","fallInAnimation","wiggleAnimationForever","popOutAnimation","setScalar","easeQuadOut","easeBounceOut","tBounded","zRot","NO_OP","GeneRenderer","tr","init","GeneDirectionalPushRenderer","arrow","origin","lastDir","updateArrow","updateArrowPosition","arrowMoveAnimation","arrowDir","normalize","ArrowHelper","Vector3","len","easeExpOut","lineGeometry","Float32BufferAttribute","makeLine","quaternion","axis","radians","acos","setFromAxisAngle","updateMatrix","matrixAutoUpdate","GenePhotosynthesisRenderer","lastAudioValueTracker","neighborLines","newAudioValueTracker","baseVolume","growPulseAnimation","lines","disconnect","GeneReproducerRenderer","percentMatureElement","renderResources","addWorldDOMElement","matured","updateScale","removeWorldDOMElement","GeneSoilAbsorptionRenderer","getHex","InstancedTileRenderer","batchMesh","originalColor","cellEffectsRenderer","geneRenderer","temperatureColor","TEMPERATURE_COLORS","currentLerp","getBatchInstance","materialInfo","WHITE","createGeneRendererFor","Proxy","v0","method","apply","getMaterialInfo","materialInfoMapping","inst","t1Pos","commitCenter","commitTexturePosition","commitColor","commitScale","updateColor","updateInventory","maybeUpdateCellEffectsRenderer","ONE","lightAmount","colorIndex","co2","AIR_COLORSCALE","startColorIndex","startColor","endColor","lerpColorTemperature","tColor","targetLerp","hover","ease","easeCubic","freeze","materials","siltColor","TileShaderMaterial","RawShaderMaterial","spriteSheet","TileBatcher","maxTiles","centers","InstancedBufferAttribute","colors","scales","texturePositions","instances","updateMatrixWorld","referenceGeometry","InstancedBufferGeometry","isInteger","String","BatchInstance","checkout","BLACK","batcher","owner","numInUse","setXY","WorldRenderer","tileBatcher","eventLogRenderer","deleteDeadEntityRenderers","createSelector","stats","deletedEntities","created","createRendererFor","getOrCreateRenderer","VignetteCapturer","pxPerTile","captureInterval","lastCaptureTime","renderTarget","rtBuffer","rtCanvas","picturesqueCells","getBounds","minBounds","maxBounds","Scene","picturesqueRenderers","cameraEncompassingBounds","setRenderTarget","clear","render","readRenderTargetPixels","imageData","createImageData","imageBuffer","putImageData","boundsWidth","boundsHeight","maxDimension","roiWidth","roiHeight","roiTopLeft","dest","img","subScalar","addScalar","largerDim","OrthographicCamera","WebGLRenderTarget","Uint8Array","getDecidedGameResult","matureEarners","shouldWin","OPPOSITE_KEYS","KeyS","KeyW","KeyA","KeyD","Keyboard","keyMap","handleBlur","shiftKey","ctrlKey","altKey","metaKey","ACTION_CONTINUOUS_KEYMAP","ACTION_INSTANT_KEYMAP","MOVEMENT_KEYS","PlayerControlScheme","inspectedCell","leftClick","rightClick","maybeToggleInstructions","setAction","toolBar","keyDown","_ms","instructionsOpen","moveAction","keysToMovement","leftClickHold","isActionContinuous","PlayerSeedControlScheme","popOut","handleLeftClick","clickedPos","getHighlightPosition","ToolBar","tools","KeyQ","TOOL_INTERACT","currentKey","digitKey","DIGIT_KEYS","makeToolToBuildCellType","currentTool","nextConfiguration","setKey","shouldCapture","rotateArgDirection","WorldDOMElement","positionFn","renderFn","posOrTile","worldToScreen","worldTopLeft","worldBottomRight","pixelTopLeft","pixelBottomRight","WorldDOMComponent","useRef","current","Animate","rafid","animate","Component","SceneObject","TILE_HIGHLIGHT","edgesGeometry","lineSegments","TileHighlight","BUILD_BLUEPRINT","BuildBlueprint","mat","POINT_HIGHLIGHT","PointHighlight","Hover","isTakingLongAction","highlightedTile","highlightedPosition","maybeRenderBuildBlueprint","maybeRenderTileHighlight","leftClickType","isBuildValid","valid","HotkeyButton","hotkey","getElementsByTagName","focus","ensureCanvasFocus","ResourceIcon","sugarSrc","waterSrc","InventoryBar","colored","capacityBasedWidth","sugarPercent","emptyPercent","waterStyles","sugarStyles","emptyStyles","textElements","barStyles","COLOR_FOR_TEMPERATURE","TemperatureInfo","temperatureScaleElements","tempBarLow","tempBarMid","midAngle","borderRight","tempAngle","formatSeconds","seconds","fractionDigits","TileDetails","tileInfo","cellInfo","growingCellInfo","airInfo","soilInfo","fountainInfo","interactInfo","leftClickEl","secondsRemaining","cellEffects","geneInfos","soilAbsorptionInfo","photosynthesisInfo","reproducerInfo","descriptors","join","CellInspector","onClickCapture","stopPropagation","SeasonsTracker","Date","toISOString","ToolBarUI","bar","selected","tool","ToolBarItem","itemIcon","charAt","ToolBuildIcon","argsChildren","TransportDirArrow","HUD","traitsPanelOpen","genomeViewerOpen","tutorialRef","isFinished","isMaxedEl","showPlayerHUD","classnames","hidden","maybeRenderGenomeViewer","maybeRenderCollectButton","maybeRenderGerminateButton","maybeRenderInvalidAction","maybeRenderCellInspector","invalidAction","InvalidActionMessage","popOutFn","onWinLoss","PlantStats","lastTime","lastTotalEnergy","numSugar","numCells","totalWaterAbsorbed","soilAbsorb","energyUsePerSecond","sugarUsePerSeason","timeUntilStarvation","averageWaterPerSeason","averageSugarPerSeason","margin","Debug","doWin","doLose","bottom","background","display","Instructions","renderCredit","href","rel","OvalNode","uv","UVNode","builder","output","include","ovalOutFn","getType","TempNode","FunctionNode","trim","Mito","callback","_inspectedCell","vignetteCapturer","hackCamera","orbitControls","suggestedCamera","userZoom","_controls","nodeFrame","Nodes","nodePost","ovalOutTime","newZoom","handlePlayerActionFail","showInvalidAction","buildError","handleBeforeUnload","handleContextMenu","PLAYER_TETHER_DISTANCE","worldDomElements","autoClear","noiseNode","MIN","environmentFromLevelInfo","lookAt","OrbitControls","updateAmbientAudio","attachWindowEvents","onbeforeunload","worldDomElementComponents","yPos","drumVolume","stringsVolume","gameResult","anyCellsAlive","maybeGetGameResult","cursorCameraNorm","getCameraNormCoordinates","cursorWorld","unproject","clampLength","getPlayerInfluenceVector","screen","project","worldDomElement","text","element","millisDelta","worldStep","updateHover","isTimeForNewCapture","capture","defaultCameraState","easeSinIn","clearDepth","yes","no","traverse","perfDebugThreeObjects","memory","geometries","textures","programs","calls","points","triangles","mouseNorm","cameraTarget","targetState","updateProjectionMatrix","h","aspect","setSize","SketchSuccessComponent","frameId","lastTimestamp","handleVolumeButtonClick","volumeEnabled","localStorage","timestamp","millisElapsed","sketch","syncAudioContext","handleWindowResize","updateRendererCanvasToMatchParent","resize","handleVisibilityChange","visibilityState","hasFocus","shouldPlayAudio","resume","suspend","eventsOnBody","sketchElementsWithKey","idx","renderVolumeButton","dispose","parentElement","clientWidth","clientHeight","SketchComponent","userVolume","handleContainerRef","Howler","setContext","masterGain","preserveDrawingBuffer","antialias","checkShaderErrors","otherArgs","containerProps","errorElement","renderSketchOrStatus","renderDefaultErrorElement","MitoScreen","handleDivRef","exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","StartScreen","onStart","listenForEnter","AppComponent","handleMousePosition","mousePosition","handleWinLoss","handleResultsDone","otherArgsSelector","showStartScreen","show","AppScreen","CSSTransition","in","timeout","mountOnEnter","unmountOnExit","App","runTests","suite","countAir","countSoil","countRock","countFountain","startAdjacentWaters","adjacentTiles","predicate","candidates","findBuildCandidateTiles","countWaters","names","plotHistogram","layout","title","TestStats","Page404","createModelSchema","Boolean","hostname","match","require","ReactDOM","path","exact","component","navigator","serviceWorker","ready","registration","unregister"],"mappings":"oGAuBO,SAASA,EAAUC,EAAaC,GACrC,OAAOC,KAAKC,UAAYF,EAAMD,GAAOA,EAGhC,SAASI,EAAQC,EAAsBC,GAC5C,OAAOJ,KAAKK,MAAMR,EAAUM,EAAcC,EAAe,IC1BpD,SAASE,EAAKC,EAAWC,EAAWC,GACzC,OAAOF,GAAKC,EAAID,GAAKE,EAGhB,SAASC,EAAMC,EAA6BC,EAA6BC,GAC9EF,EAAEF,EAAIE,EAAEF,GAAK,EAAII,GAAKD,EAAEH,EAAII,EAC5BF,EAAEG,EAAIH,EAAEG,GAAK,EAAID,GAAKD,EAAEE,EAAID,EAGvB,SAASE,EAAIN,EAAWO,EAAgBC,EAAeC,EAAgBC,GAC5E,OAAOb,EAAKY,EAAQC,GAAQV,EAAIO,IAAWC,EAAQD,IAG9C,SAASI,EAAMX,EAAWX,EAAaC,GAC5C,OAAOU,EAAIX,EAAMA,EAAMW,EAAIV,EAAMA,EAAMU,EAGlC,SAASY,EAAed,GAC7B,OAAOA,EAAEP,KAAKK,MAAML,KAAKC,SAAWM,EAAEe,SAWjC,SAASC,EAAUd,GACxB,IAAMe,EAAKxB,KAAKK,MAAMI,GAChBgB,EAAKhB,EAAIe,EACf,OAAOA,GAAMxB,KAAKC,SAAWwB,EAAK,EAAI,GAIjC,SAASC,EAAId,EAAWe,GAC7B,OAASf,EAAIe,EAAKA,GAAKA,EASlB,SAASC,EAASnB,GACvB,OAAOiB,EAAIjB,EAAG,GAjDhB,mT,wHCGaoB,EAAb,YAOE,WAAYC,EAAcC,EAAqBC,EAAgCC,GAAyB,IAAD,8BACrG,4CAAMH,EAAKC,KADkCC,kBAAwD,EAAxBC,iBAAwB,EANvGC,YAAc,WAMyF,EAJvGC,YAAa,EAI0F,EAFhGC,SAAW,EAEqF,EAPzG,wEAWaC,GACT,OAAOA,EAAK,KAZhB,2BAeOA,GAKH,GAJA,4DAAWA,GACPC,KAAKF,SAAW,IAClBE,KAAKF,UAAYC,GAEfC,KAAKC,UAAUC,QAAU,GAAKF,KAAKF,UAAY,GAAKE,KAAKL,eAAiB,EAI5E,GAFAK,KAAKC,UAAUE,IAAI,EAAG,GACtBH,KAAKL,gBAAkB,EACnBK,KAAKL,eAAiB,EACxBK,KAAKF,SAAWE,KAAKN,oBAChB,CACL,IAAMU,EAAO,IAAIC,IAAKL,KAAKR,IAAIc,QAASN,KAAKP,OAC7CO,KAAKC,UAAUM,KAAKH,EAAKH,UAAWD,KAAKC,UAAUO,MAAOR,KAAKC,UAAUQ,OAGzET,KAAKP,MAAMiB,kBAAkBV,KAAKR,KAClCQ,KAAKP,MAAMkB,UAAUX,KAAKR,IAAKY,QAhCvC,GAA8BC,K,wBCH9B,mU,8BCAA,giBAUO,IAAMO,EAAoB,IACpBC,EAAuB,IACvBC,EAAwB,GACxBC,EAAwB,GAExBC,EAAiC,GASjCC,EAAgB,KAChBC,EAAkBD,EAAgB,EAClCE,EAAiBD,EAAkB,EACnCE,EAAeD,EAAiB,EAUhCE,EAAmB,GAKnBC,EAAkB,EAMlBC,EAAa,IAgBbC,EAA4B,EAK5BC,EAAqB,GAErBC,EAA0B,IAE1BC,EAAqB,G,+BCzElC,wc,uDCAe,GACb,iBACA,QACA,kBACA,oBACA,kBACA,oBACA,eACA,eACA,oBACA,eACA,oBACA,oBACA,gBACA,mBACA,sBACA,wBACA,kBACA,uBACA,iBACA,iBACA,WACA,eACA,iBACA,yBACA,qBACA,qBACA,yBACA,eACA,yBACA,yBACA,yBACA,qBACA,eACA,yBACA,SACA,qBACA,YACA,WACA,YACA,eACA,kBACA,oBACA,gBACA,gBACA,qBACA,SACA,eACA,eACA,oBACA,oBACA,eACA,iBACA,iBACA,wBACA,eACA,oBACA,eACA,eACA,eACA,oBACA,eACA,eACA,eACA,iBACA,oBACA,iBACA,wBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,WACA,0BACA,oBACA,kBACA,QACA,sBACA,qBACA,iBACA,sBACA,iBACA,qBACA,kBACA,oBACA,uBACA,kBACA,0BACA,4BACA,mBACA,mBACA,QACA,iBACA,eACA,QACA,iBACA,iBACA,sBACA,mBACA,iBACA,kBACA,kBACA,oBACA,mBACA,gBACA,oBACA,qBACA,oBACA,wBACA,wBACA,wBACA,aACA,wBACA,oBACA,qBACA,uBACA,gBACA,gBACA,0BACA,iBACA,2BACA,oBACA,mBACA,SACA,kBACA,kBACA,kBACA,kBACA,eACA,kBACA,kBACA,qBACA,2BACA,KACA,2BACA,mBACA,uBACA,SACA,oBACA,wBACA,qBACA,oBACA,oBACA,sBACA,oBACA,sBACA,oBACA,sBACA,oBACA,oBACA,gBACA,gBACA,iBACA,iBACA,YACA,4BACA,kBACA,oBACA,yBACA,yBACA,kBACA,oBACA,YACA,qBACA,iBACA,iBACA,iBACA,iBACA,oBACA,oBACA,iBACA,oBACA,iBACA,oBACA,iBACA,wBACA,gBACA,wBACA,kBACA,kBACA,SACA,sBACA,mBACA,mBACA,kBACA,sBACA,sBACA,gBACA,iBACA,iBACA,mBACA,SACA,iBACA,iBACA,iBACA,eACA,eACA,mBACA,mBACA,gBACA,gBACA,kBACA,iBACA,mBACA,sBACA,qBACA,mBACA,eACA,cACA,uBACA,kBACA,WACA,kBACA,kBACA,kBACA,aACA,mBACA,YACA,cACA,oBACA,qBACA,oBACA,oBACA,oBACA,qBACA,uBACA,6BACA,sBACA,yBACA,qBACA,cACA,qBACA,sBACA,oBACA,uBACA,oBACA,QACA,eACA,sBACA,iBACA,oBACA,qBACA,qBACA,oBACA,cACA,uBACA,cACA,mBACA,qBACA,qBACA,sBACA,sBACA,sBACA,sBACA,sBACA,sBACA,oBACA,WACA,sBACA,kBACA,uBACA,oBACA,QACA,iBACA,iBACA,iBACA,mBACA,oBACA,yBACA,oBACA,0BACA,oBACA,iBACA,mBACA,aACA,kBACA,kBACA,kBACA,iBACA,iBACA,kBACA,kBACA,iBACA,kBACA,WACA,kBACA,sBACA,iBACA,oBACA,0BACA,OACA,eACA,oBACA,kBACA,cACA,eACA,eACA,oBACA,gBACA,mBACA,iBACA,YACA,mBACA,wBACA,uBACA,sBACA,kBACA,sBACA,aACA,mBACA,qBACA,qBACA,cACA,uBACA,uBACA,mBACA,kBACA,SACA,qBACA,qBACA,sBACA,mBACA,kBACA,sBACA,yBACA,qBACA,mBACA,gBACA,kBACA,sBACA,eACA,mBACA,sBACA,gBACA,qBACA,oBACA,sBACA,iBACA,kBACA,qBACA,YACA,SACA,mBACA,qBACA,cACA,sBACA,eACA,uBACA,sBACA,OACA,eACA,cACA,mBACA,eACA,eACA,qBACA,eACA,mBACA,mBACA,mBACA,mBACA,qBACA,iBACA,gBACA,kBACA,mBACA,mBACA,mBACA,WACA,sBACA,qBACA,uBACA,YACA,oBACA,0BACA,oBACA,yBACA,qBACA,sBACA,sBACA,yBACA,qBACA,oBACA,qBACA,iBACA,iBACA,qBACA,sBACA,eACA,QACA,cACA,aACA,qBACA,2BACA,gBACA,sBACA,sBACA,sBACA,aACA,uBACA,qBACA,oBACA,iBACA,qBACA,oBACA,iBACA,iBACA,oBACA,oBACA,oBACA,mBACA,qBACA,uBACA,UACA,oBACA,qBACA,gBACA,mBACA,mBACA,gBACA,sBACA,qBACA,gBACA,gBACA,oBACA,gBACA,mBACA,mBACA,qBACA,kBACA,mBACA,gBACA,mBACA,oBACA,kBACA,oBACA,kBACA,eACA,mBACA,SACA,mBACA,iBACA,mBACA,mBACA,mBACA,mBACA,qBACA,mBACA,QACA,SACA,gBACA,mBACA,gBACA,oBACA,oBACA,oBACA,qBACA,wBACA,mBACA,uBACA,WACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,qBACA,uBACA,yBACA,oBACA,oBACA,uBACA,kBACA,uBACA,uBACA,wBACA,wBACA,kBACA,qBACA,UACA,eACA,eACA,mBACA,gBACA,wBACA,mBACA,sBACA,WACA,0BACA,mBACA,mBACA,UACA,mBACA,sBACA,oBACA,oBACA,oBACA,gBACA,QACA,qBACA,qBACA,gBACA,SACA,sBACA,uBACA,uBACA,sBACA,iBACA,eACA,mBACA,iBACA,sBACA,sBACA,oBACA,oBACA,oBACA,OACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,uBACA,wBACA,qBACA,oBACA,uBACA,qBACA,kBACA,iBACA,cACA,sBACA,sBACA,yBACA,yBACA,yBACA,2BACA,oBACA,sBACA,oBACA,wBACA,oBACA,YACA,SACA,oBACA,oBACA,yBACA,oBACA,gBACA,0BACA,oBACA,0BACA,gBACA,qBACA,oBACA,oBACA,oBACA,yBACA,uBACA,uBACA,qBACA,oBACA,kBACA,kBACA,oBACA,WACA,oBACA,wBACA,kBACA,uBACA,oBACA,oBACA,0BACA,oBACA,cACA,qBACA,sBACA,uBACA,uBACA,0BACA,oBACA,kBACA,kBACA,kBACA,mBACA,kBACA,kBACA,mBACA,kBACA,kBACA,oBACA,oBACA,iBACA,kBACA,kBACA,gBACA,kBACA,gBACA,gBACA,mBACA,mBACA,kBACA,SACA,kBACA,kBACA,YACA,wBACA,wBACA,wBACA,qBACA,oBACA,gBACA,oBACA,sBACA,sBACA,mBACA,WACA,qBACA,kBACA,0BACA,wBACA,UACA,0BACA,kBACA,WACA,uBACA,0BACA,QACA,cACA,sBACA,sBACA,yBACA,oBACA,uBACA,sBACA,sBACA,uBACA,SACA,iBACA,iBACA,iBACA,qBACA,sBACA,oBACA,YACA,qBACA,uBACA,sBACA,oBACA,oBACA,uBACA,oBACA,uBACA,sBACA,sBACA,sBACA,QACA,eACA,mBACA,gBACA,gBACA,qBACA,uBACA,oBACA,oBACA,cACA,oBACA,oBACA,iBACA,sBACA,mBACA,0BACA,yBACA,oBACA,WACA,uBACA,yBACA,oBACA,qBACA,qBACA,mBACA,mBACA,qBACA,YACA,uBACA,2BACA,oB,6HC5qBK,IAAMC,EAAb,WACE,WACkBC,EACAC,EACAC,EACAC,GACf,yBAJeH,YAIhB,KAHgBC,iBAGhB,KAFgBC,SAEhB,KADgBC,eALpB,kDAQQC,GACJ,OAAO,IAAIC,IAAalC,KAAMiC,MATlC,4BAaIJ,EACAM,EACAC,GAEC,IADDC,EACA,uDADqCC,EAE/BR,EACoB,oBAAjBK,EAA+BA,EAA4C,iCAAYA,IAC1FI,EAAO,IAAIX,EAAKC,EAAWC,EAAgBM,EAAMC,GAC/CG,EAASD,EAAKV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AAI,EAAG,GACjB,IAAIA,EAAK,EAAG,EAAG,GACf,IAAIA,GAAM,EAAG,EAAG,GAChB,IAAIA,EAAK,EAAG,GAAI,GAChB,IAAIA,GAAM,EAAG,GAAI,GACjB,IAAIA,EAAK,EAAG,EAAG,GACf,IAAIA,EAAK,GAAI,EAAG,GAChB,IAAIA,EAAK,EAAG,GAAI,GAChB,IAAIA,EAAK,GAAI,GAAI,IAGbG,EAAI,CACR,IACA,IACA,IACA,GACA,GACA,GACA,IACA,GACA,IACA,GACA,GACA,GACA,IACA,IACA,EACA,IACA,IACA,GACA,IACA,GACA,GACA,IACA,EACA,GACA,GACA,IACA,GACA,GACA,GACA,IACA,EACA,IACA,IACA,IACA,IACA,GACA,EACA,GACA,IACA,GACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,GACA,IACA,IACA,GACA,GACA,IACA,GACA,IACA,IACA,IACA,IACA,GACA,IACA,GACA,IACA,GACA,IACA,IACA,GACA,GACA,IACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,GACA,IACA,IACA,IACA,GACA,GACA,GACA,GACA,IACA,EACA,IACA,GACA,GACA,IACA,GACA,IACA,IACA,IACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,EACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,EACA,IACA,GACA,IACA,IACA,IACA,IACA,GACA,GACA,IACA,IACA,IACA,GACA,IACA,GACA,GACA,GACA,GACA,IACA,IACA,GACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,EACA,GACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,GACA,IACA,EACA,IACA,GACA,GACA,IACA,GACA,GACA,IACA,IACA,GACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,I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","file":"static/js/main.8b9fb011.chunk.js","sourcesContent":["import * as THREE from \"three\";\r\n\r\n/**\r\n * Return a Vector2 that's uniformly randomly chosen from the perimeter\r\n * of the rectangle given by min and max.\r\n */\r\nexport function randomRectPerimeter(min: THREE.Vector2, max: THREE.Vector2): THREE.Vector2 {\r\n  const width = max.x - min.x;\r\n  const height = max.y - min.y;\r\n  let x: number;\r\n  let y: number;\r\n  if (Math.random() * (width + height) < width) {\r\n    // we've chosen the top or bottom line\r\n    x = randFloat(min.x, max.x);\r\n    y = Math.random() < 0.5 ? min.y : max.y;\r\n  } else {\r\n    // we've chosen the left or right line\r\n    x = Math.random() < 0.5 ? min.x : max.x;\r\n    y = randFloat(min.y, max.y);\r\n  }\r\n  return new THREE.Vector2(x, y);\r\n}\r\n\r\nexport function randFloat(min: number, max: number) {\r\n  return Math.random() * (max - min) + min;\r\n}\r\n\r\nexport function randInt(inclusiveMin: number, inclusiveMax: number) {\r\n  return Math.floor(randFloat(inclusiveMin, inclusiveMax + 1));\r\n}\r\n","export * from \"./random\";\r\n\r\nexport function lerp(a: number, b: number, x: number) {\r\n  return a + (b - a) * x;\r\n}\r\n\r\nexport function lerp2(v: { x: number; y: number }, t: { x: number; y: number }, l: number) {\r\n  v.x = v.x * (1 - l) + t.x * l;\r\n  v.y = v.y * (1 - l) + t.y * l;\r\n}\r\n\r\nexport function map(x: number, xStart: number, xStop: number, yStart: number, yStop: number) {\r\n  return lerp(yStart, yStop, (x - xStart) / (xStop - xStart));\r\n}\r\n\r\nexport function clamp(x: number, min: number, max: number) {\r\n  return x < min ? min : x > max ? max : x;\r\n}\r\n\r\nexport function sampleArray<T>(a: T[]) {\r\n  return a[Math.floor(Math.random() * a.length)];\r\n}\r\n\r\nexport function triangleWaveApprox(t: number) {\r\n  return (8 / (Math.PI * Math.PI)) * (Math.sin(t) - (1 / 9) * Math.sin(3 * t) + (1 / 25) * Math.sin(5 * t));\r\n}\r\n\r\n/**\r\n * Get a random integer between floor(x) and ceil(x) such that, over many iterations,\r\n * randRound(x) gives an average of x.\r\n */\r\nexport function randRound(x: number) {\r\n  const ix = Math.floor(x);\r\n  const fx = x - ix;\r\n  return ix + (Math.random() < fx ? 1 : 0);\r\n}\r\n\r\n// mod account for negatives\r\nexport function mod(t: number, m: number) {\r\n  return ((t % m) + m) % m;\r\n}\r\n\r\n// perfect triangle wave that goes from [0, 1, 0] in x = [0, 1, 2]\r\nexport function mirroredRepeat(x: number) {\r\n  return (1 - (Math.abs(mod(x * 2, 4) - 2) - 1)) / 2;\r\n}\r\n\r\n// goes [0, 1] every integer\r\nexport function sawTooth(x: number) {\r\n  return mod(x, 1);\r\n}\r\n\r\nexport function logistic(x: number) {\r\n  if (x < -6) {\r\n    return 0;\r\n  } else if (x > 6) {\r\n    return 1;\r\n  }\r\n  return 1 / (1 + Math.exp(-x));\r\n}\r\n","import { Vector2 } from \"three\";\r\nimport { World } from \"../world/world\";\r\nimport { Silt } from \"./soil\";\r\nexport class Fountain extends Silt {\r\n  displayName = \"Fountain\";\r\n\r\n  isObstacle = true;\r\n\r\n  public cooldown = 0;\r\n\r\n  constructor(pos: Vector2, world: World, public secondsPerWater: number, public waterRemaining: number) {\r\n    super(pos, world);\r\n  }\r\n\r\n  shouldStep(dt: number) {\r\n    return dt > 0.1;\r\n  }\r\n\r\n  step(dt: number) {\r\n    super.step(dt);\r\n    if (this.cooldown > 0) {\r\n      this.cooldown -= dt;\r\n    }\r\n    if (this.inventory.space() > 1 && this.cooldown <= 0 && this.waterRemaining > 0) {\r\n      // just constantly give yourself water\r\n      this.inventory.add(1, 0);\r\n      this.waterRemaining -= 1;\r\n      if (this.waterRemaining > 0) {\r\n        this.cooldown = this.secondsPerWater;\r\n      } else {\r\n        const silt = new Silt(this.pos.clone(), this.world);\r\n        this.inventory.give(silt.inventory, this.inventory.water, this.inventory.sugar);\r\n\r\n        // replace self with a silt\r\n        this.world.maybeRemoveCellAt(this.pos);\r\n        this.world.setTileAt(this.pos, silt);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Cell } from \"../cell/cell\";\r\nimport { DeadCell } from \"../cell/deadCell\";\r\nimport { GrowingCell } from \"../cell/growingCell\";\r\nimport { Air } from \"./air\";\r\nimport { Fountain } from \"./fountain\";\r\nimport { Rock } from \"./rock\";\r\nimport { Soil } from \"./soil\";\r\nimport { Tile } from \"./tile\";\r\n\r\nexport { CellEffect, FreezeEffect } from \"../cell/cellEffect\";\r\nexport { Air, DeadCell, Fountain, Rock, Soil, Tile, Cell, GrowingCell };\r\n","/**\r\n * In Mito, our standard units of measurement are:\r\n *\r\n * Distance - tiles.\r\n * Time - seconds.\r\n */\r\n\r\n/**\r\n * How many tiles per second the Player moves.\r\n */\r\nexport const PLAYER_BASE_SPEED = 4.2;\r\nexport const PLAYER_MAX_RESOURCES = 100;\r\nexport const PLAYER_STARTING_WATER = 25;\r\nexport const PLAYER_STARTING_SUGAR = 50;\r\n\r\nexport const PLAYER_INTERACT_EXCHANGE_SPEED = 30;\r\n/**\r\n * How fast the Player moves from standing on Transport.\r\n */\r\nexport const PLAYER_MOVED_BY_TRANSPORT_SPEED = 0.3;\r\n\r\n/**\r\n * Number of realtime seconds in a game year.\r\n */\r\nexport const TIME_PER_YEAR = 60 * 36; // 60 seconds * 36 minutes = 1800 seconds\r\nexport const TIME_PER_SEASON = TIME_PER_YEAR / 4; // 480 seconds per season (9 minutes)\r\nexport const TIME_PER_MONTH = TIME_PER_SEASON / 3; // 180 seconds per month (3 minutes)\r\nexport const TIME_PER_DAY = TIME_PER_MONTH / 3; // 60 seconds per day (1 minute)\r\n\r\n/**\r\n * The day is further split into a \"daytime\" and a \"nighttime\". Sunlight\r\n * angles from -90 to +90 over the course of the day. This percentage says\r\n * how much of a full day is filled with sun.\r\n *\r\n * We keep it daytime as much as possible because daytime is more fun; nighttime\r\n * is just a time-keeping convenience, and a way to reset the sun angle.\r\n */\r\nexport const PERCENT_DAYLIGHT = 0.9; // 45 second days, 5 second nights\r\n\r\n/**\r\n * How many seconds it takes to build a Cell.\r\n */\r\nexport const CELL_BUILD_TIME = 1.0;\r\n\r\n/**\r\n * How many tiles per frame a cell will freefall in the Air. Unscaled\r\n * by time.\r\n */\r\nexport const CELL_DROOP = 0.13;\r\n\r\n/**\r\n * In a two Cell system with one Water, this water will diffuse, on average, after this many seconds.\r\n * Divide this by 8 to get an idea of how \"fast\" a single water will move on a fully filled out Tissue plane.\r\n */\r\nexport const CELL_DIFFUSION_WATER_TIME = 16.6667;\r\n\r\n/**\r\n * See CELL_DIFFUSION_WATER_TIME explanation.\r\n */\r\nexport const CELL_DIFFUSION_SUGAR_TIME = 16.6667;\r\n\r\n/**\r\n * Max inventory capacity of Tissue, Transports, and Roots.\r\n */\r\nexport const TISSUE_INVENTORY_CAPACITY = 6;\r\n\r\n/**\r\n * On average, for each Air tile adjacent to each Leaf, water will be converted to sugar after this many seconds.\r\n */\r\nexport const LEAF_REACTION_TIME = 40;\r\n\r\nexport const SUNLIGHT_REINTRODUCTION = 0.15;\r\n\r\nexport const SUNLIGHT_DIFFUSION = 0.0;\r\n","export * from \"./GeneAttractsSugar\";\r\nexport * from \"./GeneAttractsWater\";\r\nexport * from \"./GeneCannotFreeze\";\r\nexport * from \"./GeneEnergyTransfer\";\r\nexport * from \"./GeneInventory\";\r\nexport * from \"./GeneLiving\";\r\nexport * from \"./GeneMetabolism\";\r\nexport * from \"./GenePhotosynthesis\";\r\nexport * from \"./GeneSoilAbsorption\";\r\nexport * from \"./GeneVascular\";\r\n","export default [\r\n  \"Pentzia incana\",\r\n  \"Alnus\",\r\n  \"Alnus glutinosa\",\r\n  \"Ilex verticillata\",\r\n  \"Alnus glutinosa\",\r\n  \"Ilex verticillata\",\r\n  \"Alnus incana\",\r\n  \"Alnus incana\",\r\n  \"Ilex verticillata\",\r\n  \"Alnus incana\",\r\n  \"Alnus rhombifolia\",\r\n  \"Ilex verticillata\",\r\n  \"Prunus dulcis\",\r\n  \"Ambrosia trifida\",\r\n  \"Apocynum cannabinum\",\r\n  \"Brugmansia suaveolens\",\r\n  \"Malus domestica\",\r\n  \"Rhanterium epapposum\",\r\n  \"Cornus florida\",\r\n  \"Cornus florida\",\r\n  \"Fraxinus\",\r\n  \"Acer negundo\",\r\n  \"Fraxinus nigra\",\r\n  \"Fraxinus quadrangulata\",\r\n  \"Fraxinus americana\",\r\n  \"Fraxinus excelsior\",\r\n  \"Fraxinus pennsylvanica\",\r\n  \"Acer negundo\",\r\n  \"Fraxinus pennsylvanica\",\r\n  \"Fraxinus pennsylvanica\",\r\n  \"Fraxinus pennsylvanica\",\r\n  \"Fraxinus americana\",\r\n  \"Acer negundo\",\r\n  \"Fraxinus pennsylvanica\",\r\n  \"Azolla\",\r\n  \"Azolla caroliniana\",\r\n  \"Adansonia\",\r\n  \"Fabaceae\",\r\n  \"Phaseolus\",\r\n  \"Ilex decidua\",\r\n  \"Veratrum viride\",\r\n  \"Solanum dulcamara\",\r\n  \"Daucus carota\",\r\n  \"Daucus carota\",\r\n  \"Strelitzia reginae\",\r\n  \"Betula\",\r\n  \"Betula lenta\",\r\n  \"Betula nigra\",\r\n  \"Betula papyrifera\",\r\n  \"Betula papyrifera\",\r\n  \"Betula lenta\",\r\n  \"Betula pendula\",\r\n  \"Betula pendula\",\r\n  \"Betula alleghaniensis\",\r\n  \"Betula lenta\",\r\n  \"Betula papyrifera\",\r\n  \"Betula nigra\",\r\n  \"Betula nigra\",\r\n  \"Betula lenta\",\r\n  \"Betula papyrifera\",\r\n  \"Betula lenta\",\r\n  \"Betula lenta\",\r\n  \"Betula nigra\",\r\n  \"Betula pendula\",\r\n  \"Betula papyrifera\",\r\n  \"Betula pendula\",\r\n  \"Betula alleghaniensis\",\r\n  \"Barbarea vulgaris\",\r\n  \"Cardamine bulbosa\",\r\n  \"Cardamine hirsuta\",\r\n  \"Cardamine hirsuta\",\r\n  \"Solanum dulcamara\",\r\n  \"Solanum dulcamara\",\r\n  \"Ambrosia\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Artemisia trifida\",\r\n  \"Helenium amarum\",\r\n  \"Rubus\",\r\n  \"Rubus pensilvanicus\",\r\n  \"Rubus occidentalis\",\r\n  \"Rubus hispidus\",\r\n  \"Rubus pensilvanicus\",\r\n  \"Rubus hispidus\",\r\n  \"Rubus occidentalis\",\r\n  \"Rudbeckia hirta\",\r\n  \"Rudbeckia fulgida\",\r\n  \"Viburnum prunifolium\",\r\n  \"Rudbeckia hirta\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Hyacinthoides non-scripta\",\r\n  \"Allium caeruleum\",\r\n  \"Maclura pomifera\",\r\n  \"Buxus\",\r\n  \"Cornus florida\",\r\n  \"Acer negundo\",\r\n  \"Buxus\",\r\n  \"Cornus florida\",\r\n  \"Cornus florida\",\r\n  \"Solanum carolinense\",\r\n  \"Encelia farinosa\",\r\n  \"Plantago major\",\r\n  \"Rudbeckia hirta\",\r\n  \"Rudbeckia hirta\",\r\n  \"Rudbeckia triloba\",\r\n  \"Ambrosia trifida\",\r\n  \"Ajuga reptans\",\r\n  \"Asclepias syriaca\",\r\n  \"Asclepias tuberosa\",\r\n  \"Brassica oleracea\",\r\n  \"Symplocarpus foetidus\",\r\n  \"Symplocarpus foetidus\",\r\n  \"Symplocarpus foetidus\",\r\n  \"Lysichiton\",\r\n  \"Symplocarpus foetidus\",\r\n  \"Platanus racemosa\",\r\n  \"Asclepias tuberosa\",\r\n  \"Phytolacca americana\",\r\n  \"Daucus carota\",\r\n  \"Daucus carota\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Plantago major\",\r\n  \"Lyonothamnus floribundus\",\r\n  \"Polygala calcarea\",\r\n  \"Sinapis arvensis\",\r\n  \"Prunus\",\r\n  \"Prunus serotina\",\r\n  \"Prunus serotina\",\r\n  \"Prunus serotina\",\r\n  \"Prunus serotina\",\r\n  \"Prunus avium\",\r\n  \"Prunus serotina\",\r\n  \"Prunus serotina\",\r\n  \"Asclepias tuberosa\",\r\n  \"Dendranthema grandiflora\",\r\n  \"vi\",\r\n  \"Chrysanthemum morifolium\",\r\n  \"Cinnamomum verum\",\r\n  \"Phytolacca americana\",\r\n  \"Coffea\",\r\n  \"Corydalis flavula\",\r\n  \"Symplocarpus foetidus\",\r\n  \"Aquilegia vulgaris\",\r\n  \"Sonchus oleraceus\",\r\n  \"Rudbeckia fulgida\",\r\n  \"Rudbeckia laciniata\",\r\n  \"Rudbeckia fulgida\",\r\n  \"Rudbeckia laciniata\",\r\n  \"Rudbeckia fulgida\",\r\n  \"Rudbeckia laciniata\",\r\n  \"Rudbeckia triloba\",\r\n  \"Rudbeckia triloba\",\r\n  \"Cornus amomum\",\r\n  \"Cornus amomum\",\r\n  \"Cornus florida\",\r\n  \"Cornus florida\",\r\n  \"Corydalis\",\r\n  \"Corydalis chelidoniifolia\",\r\n  \"Corydalis aurea\",\r\n  \"Corydalis flavula\",\r\n  \"Corydalis sempervirens\",\r\n  \"Corydalis sempervirens\",\r\n  \"Corydalis lutea\",\r\n  \"Corydalis flavula\",\r\n  \"Gossypium\",\r\n  \"Rorippa sylvestris\",\r\n  \"Barbarea verna\",\r\n  \"Barbarea verna\",\r\n  \"Barbarea verna\",\r\n  \"Barbarea verna\",\r\n  \"Cardamine bulbosa\",\r\n  \"Cardamine hirsuta\",\r\n  \"Barbarea verna\",\r\n  \"Cardamine hirsuta\",\r\n  \"Barbarea verna\",\r\n  \"Cardamine bulbosa\",\r\n  \"Barbarea verna\",\r\n  \"Cardamine concatenata\",\r\n  \"Daucus carota\",\r\n  \"Cardamine concatenata\",\r\n  \"Rudbeckia hirta\",\r\n  \"Bellis perennis\",\r\n  \"Lamium\",\r\n  \"Lamium amplexicaule\",\r\n  \"Lamium purpureum\",\r\n  \"Lamium maculatum\",\r\n  \"Veratrum viride\",\r\n  \"Clematis virginiana\",\r\n  \"Clematis virginiana\",\r\n  \"Daucus carota\",\r\n  \"Rubus hispidus\",\r\n  \"Rubus hispidus\",\r\n  \"Sonchus arvensis\",\r\n  \"Cornus\",\r\n  \"Cornus florida\",\r\n  \"Cornus florida\",\r\n  \"Cornus florida\",\r\n  \"Cornus kousa\",\r\n  \"Cornus kousa\",\r\n  \"Moringa oleifera\",\r\n  \"Cornus nuttallii\",\r\n  \"Cornus amomum\",\r\n  \"Cornus amomum\",\r\n  \"Veratrum viride\",\r\n  \"Solanum nigrum\",\r\n  \"Durio zibethinus\",\r\n  \"Durio testudinarius\",\r\n  \"Durio grandiflorus\",\r\n  \"Durio kutejensis\",\r\n  \"Durio dulcis\",\r\n  \"Ilex glabra\",\r\n  \"Cattleya schroederae\",\r\n  \"Veratrum viride\",\r\n  \"Sambucus\",\r\n  \"Lupinus elegans\",\r\n  \"Dillenia indica\",\r\n  \"Rudbeckia hirta\",\r\n  \"Eucalyptus\",\r\n  \"Vaccinium ovatum\",\r\n  \"Encalypta\",\r\n  \"Amphipappus\",\r\n  \"Achillea ptarmica\",\r\n  \"Azolla caroliniana\",\r\n  \"Solanum dulcamara\",\r\n  \"Solanum dulcamara\",\r\n  \"Solanum dulcamara\",\r\n  \"Foeniculum vulgare\",\r\n  \"Nephrolepis exaltata\",\r\n  \"Polystichum acrostichoides\",\r\n  \"Polypodium scouleri\",\r\n  \"Nephrolepis obliterata\",\r\n  \"Azolla caroliniana\",\r\n  \"Polystichum\",\r\n  \"Azolla caroliniana\",\r\n  \"Polystichum munitum\",\r\n  \"Ilex verticillata\",\r\n  \"Tanacetum parthenium\",\r\n  \"Myosotis arvensis\",\r\n  \"Ficus\",\r\n  \"Ficus carica\",\r\n  \"Linum usitatissimum\",\r\n  \"Phormium tenax\",\r\n  \"Phormium colensoi\",\r\n  \"Asclepias tuberosa\",\r\n  \"Digitalis purpurea\",\r\n  \"Corydalis flavula\",\r\n  \"Ilex glabra\",\r\n  \"Phytolacca americana\",\r\n  \"Allium moly\",\r\n  \"Allium canadense\",\r\n  \"Alliaria petiolata\",\r\n  \"Alliaria petiolata\",\r\n  \"Veronica chamaedrys\",\r\n  \"Hesperis matronalis\",\r\n  \"Hesperis matronalis\",\r\n  \"Hesperis matronalis\",\r\n  \"Hesperis matronalis\",\r\n  \"Hesperis matronalis\",\r\n  \"Tanacetum vulgare\",\r\n  \"Laburnum\",\r\n  \"Rudbeckia laciniata\",\r\n  \"Rudbeckia hirta\",\r\n  \"Achillea millefolium\",\r\n  \"Achillea ptarmica\",\r\n  \"Vitis\",\r\n  \"Solanum opacum\",\r\n  \"Rubus hispidus\",\r\n  \"Rubus hispidus\",\r\n  \"Sonchus arvensis\",\r\n  \"Curcuma domestica\",\r\n  \"Corydalis sempervirens\",\r\n  \"Corydalis flavula\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Artemisia trifida\",\r\n  \"Plantago major\",\r\n  \"Maclura pomifera\",\r\n  \"Helleborus\",\r\n  \"Veratrum viride\",\r\n  \"Veratrum viride\",\r\n  \"Veratrum nigrum\",\r\n  \"Veratrum album\",\r\n  \"Veratrum album\",\r\n  \"Veratrum viride\",\r\n  \"Veratrum viride\",\r\n  \"Veratrum album\",\r\n  \"Veratrum viride\",\r\n  \"Cannabis\",\r\n  \"Cannabis sativa\",\r\n  \"Apocynum cannabinum\",\r\n  \"Plantago major\",\r\n  \"Barbarea vulgaris\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Ilex\",\r\n  \"Ilex decidua\",\r\n  \"Ilex verticillata\",\r\n  \"Ilex aquifolium\",\r\n  \"Ilex glabra\",\r\n  \"Ilex decidua\",\r\n  \"Ilex decidua\",\r\n  \"Ilex verticillata\",\r\n  \"Lunaria annua\",\r\n  \"Ambrosia trifida\",\r\n  \"Solanum nigrum\",\r\n  \"Vaccinium\",\r\n  \"Vaccinium ovatum\",\r\n  \"Vaccinium parvifolium\",\r\n  \"Sempervivum tectorum\",\r\n  \"Apocynum cannabinum\",\r\n  \"Cannabis indica\",\r\n  \"Asclepias incarnata\",\r\n  \"Castilleja\",\r\n  \"Castilleja mutis\",\r\n  \"Asclepias tuberosa\",\r\n  \"Asclepias tuberosa\",\r\n  \"Ilex glabra\",\r\n  \"Phytolacca americana\",\r\n  \"Acacia estrophiolata\",\r\n  \"Coincya monensis\",\r\n  \"Veratrum viride\",\r\n  \"Hedera\",\r\n  \"Alliaria petiolata\",\r\n  \"Alliaria petiolata\",\r\n  \"Jasminum officinale\",\r\n  \"Ludisia discolor\",\r\n  \"Juncus kraussii\",\r\n  \"Adenanthos obovatus\",\r\n  \"Amelanchier canadensis\",\r\n  \"Rorippa sylvestris\",\r\n  \"Ptisana salicina\",\r\n  \"Cornus amomum\",\r\n  \"Veronica bullii\",\r\n  \"Reynoutria japonica\",\r\n  \"Cornus kousa\",\r\n  \"Pueraria montana\",\r\n  \"Pomaderris kumeraho\",\r\n  \"Daucus carota\",\r\n  \"Asparagus setaceus\",\r\n  \"Alchemilla mollis\",\r\n  \"Cardamine pratensis\",\r\n  \"Plantago major\",\r\n  \"Phoenicophorium\",\r\n  \"Magnolia splendens\",\r\n  \"Lavandula\",\r\n  \"Allium\",\r\n  \"Lilium catesbaei\",\r\n  \"Agapanthus praecox\",\r\n  \"Allium moly\",\r\n  \"Hesperis matronalis\",\r\n  \"Helianthella\",\r\n  \"Erigeron cavernensis\",\r\n  \"Clematis virginiana\",\r\n  \"Acer\",\r\n  \"Acer negundo\",\r\n  \"Acer nigrum\",\r\n  \"Acer saccharinum\",\r\n  \"Acer negundo\",\r\n  \"Acer negundo\",\r\n  \"Acer pensylvanicum\",\r\n  \"Acer negundo\",\r\n  \"Acer saccharinum\",\r\n  \"Acer saccharinum\",\r\n  \"Acer saccharinum\",\r\n  \"Acer saccharinum\",\r\n  \"Acer pensylvanicum\",\r\n  \"Acer saccharum\",\r\n  \"Acer barbatum\",\r\n  \"Acer leucoderme\",\r\n  \"Acer saccharinum\",\r\n  \"Acer saccharinum\",\r\n  \"Acer saccharinum\",\r\n  \"Prosopis\",\r\n  \"Prosopis glandulosa\",\r\n  \"Prosopis pubescens\",\r\n  \"Achillea millefolium\",\r\n  \"Asclepias\",\r\n  \"Sonchus oleraceus\",\r\n  \"Asclepias amplexicaulis\",\r\n  \"Asclepias syriaca\",\r\n  \"Asclepias verticillata\",\r\n  \"Asclepias tuberosa\",\r\n  \"Asclepias incarnata\",\r\n  \"Asclepias incarnata\",\r\n  \"Asclepias verticillata\",\r\n  \"Asclepias tuberosa\",\r\n  \"Sonchus oleraceus\",\r\n  \"Acer pensylvanicum\",\r\n  \"Solanum nigrum\",\r\n  \"Solanum opacum\",\r\n  \"Azolla caroliniana\",\r\n  \"Hesperis matronalis\",\r\n  \"Betula lenta\",\r\n  \"Morus\",\r\n  \"Morus rubra\",\r\n  \"Morus alba\",\r\n  \"Epacris longiflora\",\r\n  \"Asplenium flabellifolium\",\r\n  \"Urtica dioica\",\r\n  \"Solanum carolinense\",\r\n  \"Solanum carolinense\",\r\n  \"Solanum carolinense\",\r\n  \"Hylocereus\",\r\n  \"Phytolacca americana\",\r\n  \"Solanum americanum\",\r\n  \"Solanum dulcamara\",\r\n  \"Solanum nigrum\",\r\n  \"Solanum americanum\",\r\n  \"Solanum dulcamara\",\r\n  \"Solanum nigrum\",\r\n  \"Solanum nigrum\",\r\n  \"Solanum dulcamara\",\r\n  \"Solanum dulcamara\",\r\n  \"Solanum dulcamara\",\r\n  \"Trillium cernuum\",\r\n  \"Botrychium boreale\",\r\n  \"Achillea millefolium\",\r\n  \"Quercus\",\r\n  \"Quercus douglasii\",\r\n  \"Quercus macrocarpa\",\r\n  \"Quercus rubra\",\r\n  \"Quercus velutina\",\r\n  \"Quercus velutina\",\r\n  \"Quercus robur\",\r\n  \"Quercus canariensis\",\r\n  \"Quercus macrocarpa\",\r\n  \"Quercus rubra\",\r\n  \"Quercus robur\",\r\n  \"Quercus palustris\",\r\n  \"Quercus rubra\",\r\n  \"Quercus coccinea\",\r\n  \"Quercus coccinea\",\r\n  \"Quercus macrocarpa\",\r\n  \"Quercus petraea\",\r\n  \"Quercus coccinea\",\r\n  \"Quercus rubra\",\r\n  \"Quercus velutina\",\r\n  \"Quercus palustris\",\r\n  \"Quercus bicolor\",\r\n  \"Quercus palustris\",\r\n  \"Quercus bicolor\",\r\n  \"Quercus alba\",\r\n  \"Quercus velutina\",\r\n  \"Allium\",\r\n  \"Allium giganteum\",\r\n  \"Allium cernuum\",\r\n  \"Allium canadense\",\r\n  \"Allium canadense\",\r\n  \"Maclura pomifera\",\r\n  \"Maclura pomifera\",\r\n  \"Asclepias tuberosa\",\r\n  \"Maclura pomifera\",\r\n  \"Salix\",\r\n  \"Cornus\",\r\n  \"Cornus amomum\",\r\n  \"Pastinaca sativa\",\r\n  \"Daucus carota\",\r\n  \"Achillea ptarmica\",\r\n  \"Achillea ptarmica\",\r\n  \"Achillea ptarmica\",\r\n  \"Alliaria petiolata\",\r\n  \"Cardamine concatenata\",\r\n  \"Euphorbia peplus\",\r\n  \"Phytolacca americana\",\r\n  \"Platanus\",\r\n  \"Plantago major\",\r\n  \"Plantago major\",\r\n  \"Plantago major\",\r\n  \"Plantago major\",\r\n  \"Plantago major\",\r\n  \"Plantago major\",\r\n  \"Asclepias tuberosa\",\r\n  \"Phytolacca americana\",\r\n  \"Toxicodendron radicans\",\r\n  \"Solanum dulcamara\",\r\n  \"Solanum dulcamara\",\r\n  \"Phytolacca americana\",\r\n  \"Veratrum viride\",\r\n  \"Phytolacca americana\",\r\n  \"Phytolacca americana\",\r\n  \"Symplocarpus foetidus\",\r\n  \"Symplocarpus foetidus\",\r\n  \"Veratrum viride\",\r\n  \"Alliaria petiolata\",\r\n  \"Populus\",\r\n  \"Papaveraceae\",\r\n  \"Ilex decidua\",\r\n  \"Primula vulgaris\",\r\n  \"Daucus carota\",\r\n  \"Anthriscus sylvestris\",\r\n  \"Quercus velutina\",\r\n  \"Solanum carolinense\",\r\n  \"Ambrosia\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Ambrosia trifida\",\r\n  \"Ambrosia trifida\",\r\n  \"Senecio\",\r\n  \"Senecio jacobaea\",\r\n  \"Senecio erucifolius\",\r\n  \"Senecio aquaticus\",\r\n  \"Senecio squalidus\",\r\n  \"Senecio cineraria\",\r\n  \"Daucus carota\",\r\n  \"Rubus\",\r\n  \"Rubus occidentalis\",\r\n  \"Rubus occidentalis\",\r\n  \"Cornus amomum\",\r\n  \"Cercis\",\r\n  \"Cercis siliquastrum\",\r\n  \"Phytolacca americana\",\r\n  \"Phytolacca americana\",\r\n  \"Apocynum cannabinum\",\r\n  \"Plantago major\",\r\n  \"Oryza sativa\",\r\n  \"Oryza glaberrima\",\r\n  \"Plantago major\",\r\n  \"Hesperis matronalis\",\r\n  \"Hesperis matronalis\",\r\n  \"Barbarea vulgaris\",\r\n  \"Barbarea vulgaris\",\r\n  \"Barbarea vulgaris\",\r\n  \"Rosa\",\r\n  \"Rosa multiflora\",\r\n  \"Rosa virginiana\",\r\n  \"Rosa virginiana\",\r\n  \"Rosa multiflora\",\r\n  \"Rosa virginiana\",\r\n  \"Rosa multiflora\",\r\n  \"Rosa virginiana\",\r\n  \"Achillea millefolium\",\r\n  \"Amelanchier alnifolia\",\r\n  \"Alliaria petiolata\",\r\n  \"Solanum dulcamara\",\r\n  \"Phytolacca americana\",\r\n  \"Rubus occidentalis\",\r\n  \"Corydalis aurea\",\r\n  \"Barbarea verna\",\r\n  \"Amelanchier\",\r\n  \"Amelanchier arborea\",\r\n  \"Amelanchier arborea\",\r\n  \"Amelanchier canadensis\",\r\n  \"Amelanchier canadensis\",\r\n  \"Amelanchier canadensis\",\r\n  \"Oncosiphon suffruticosum\",\r\n  \"Asclepias syriaca\",\r\n  \"Asclepias incarnata\",\r\n  \"Asclepias syriaca\",\r\n  \"Symplocarpus foetidus\",\r\n  \"Solanum dulcamara\",\r\n  \"Galanthus\",\r\n  \"Oxalis\",\r\n  \"Veronica arvensis\",\r\n  \"Veronica arvensis\",\r\n  \"Nardostachys jatamansi\",\r\n  \"Betula papyrifera\",\r\n  \"Cornus amomum\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Allium cristophii\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Arbutus unedo\",\r\n  \"Asclepias tuberosa\",\r\n  \"Asclepias syriaca\",\r\n  \"Achillea ptarmica\",\r\n  \"Achillea ptarmica\",\r\n  \"Amelanchier canadensis\",\r\n  \"Achillea millefolium\",\r\n  \"Viburnum prunifolium\",\r\n  \"Asclepias tuberosa\",\r\n  \"Asclepias syriaca\",\r\n  \"Ipomoea batatas\",\r\n  \"Ipomoea batatas\",\r\n  \"Sonchus oleraceus\",\r\n  \"Platanus\",\r\n  \"Platanus racemosa\",\r\n  \"Platanus occidentalis\",\r\n  \"Heritiera fomes\",\r\n  \"Excoecaria agallocha\",\r\n  \"Tanacetum vulgare\",\r\n  \"Achillea ptarmica\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Camellia sinensis\",\r\n  \"Ilex glabra\",\r\n  \"Rubus occidentalis\",\r\n  \"Rudbeckia laciniata\",\r\n  \"Achillea millefolium\",\r\n  \"Achillea millefolium\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Sonchus oleraceus\",\r\n  \"Cirsium arvense\",\r\n  \"Cirsium arvense\",\r\n  \"Cirsium arvense\",\r\n  \"Sonchus arvensis\",\r\n  \"Cirsium arvense\",\r\n  \"Cirsium arvense\",\r\n  \"Sonchus arvensis\",\r\n  \"Cirsium arvense\",\r\n  \"Cirsium arvense\",\r\n  \"Sonchus oleraceus\",\r\n  \"Sonchus oleraceus\",\r\n  \"Carduus nutans\",\r\n  \"Cirsium arvense\",\r\n  \"Cirsium arvense\",\r\n  \"Sonchus asper\",\r\n  \"Cirsium arvense\",\r\n  \"Sonchus asper\",\r\n  \"Sonchus asper\",\r\n  \"Sonchus arvensis\",\r\n  \"Sonchus arvensis\",\r\n  \"Cirsium arvense\",\r\n  \"Thymus\",\r\n  \"Thymus vulgaris\",\r\n  \"Veratrum viride\",\r\n  \"Nicotiana\",\r\n  \"Cardamine concatenata\",\r\n  \"Cardamine concatenata\",\r\n  \"Cardamine concatenata\",\r\n  \"Impatiens capensis\",\r\n  \"Impatiens pallida\",\r\n  \"Mimosa pudica\",\r\n  \"Cardamine hirsuta\",\r\n  \"Clematis virginiana\",\r\n  \"Solanum carolinense\",\r\n  \"Nicotiana glauca\",\r\n  \"Trillium\",\r\n  \"Asclepias tuberosa\",\r\n  \"Ocimum santalum\",\r\n  \"Hedyscepe canterburyana\",\r\n  \"Cyperus alternifolius\",\r\n  \"Vanilla\",\r\n  \"Koelreuteria paniculata\",\r\n  \"Mucuna pruriens\",\r\n  \"Viburnum\",\r\n  \"Viburnum prunifolium\",\r\n  \"Viburnum rhytidophyllum\",\r\n  \"Viola\",\r\n  \"Saintpaulia\",\r\n  \"Hesperis matronalis\",\r\n  \"Hesperis matronalis\",\r\n  \"Erythronium dens-canis\",\r\n  \"Solanum dulcamara\",\r\n  \"Scorzonera hispanica\",\r\n  \"Clematis virginiana\",\r\n  \"Clematis virginiana\",\r\n  \"Dracunculus vulgaris\",\r\n  \"Acacia\",\r\n  \"Acacia ammobia\",\r\n  \"Plantago major\",\r\n  \"Plantago major\",\r\n  \"Asclepias tuberosa\",\r\n  \"Apocynum cannabinum\",\r\n  \"Asclepias syriaca\",\r\n  \"Lambertia\",\r\n  \"Lambertia echinata\",\r\n  \"Lambertia ericifolia\",\r\n  \"Lambertia fairallii\",\r\n  \"Lambertia formosa\",\r\n  \"Lambertia formosa\",\r\n  \"Lambertia ilicifolia\",\r\n  \"Lambertia inermis\",\r\n  \"Lambertia multiflora\",\r\n  \"Lambertia orbifolia\",\r\n  \"Lambertia rariflora\",\r\n  \"Clematis virginiana\",\r\n  \"Salix\",\r\n  \"Salix exigua\",\r\n  \"Salix gooddingii\",\r\n  \"Cornus amomum\",\r\n  \"Cornus amomum\",\r\n  \"Asclepias tuberosa\",\r\n  \"Rubus phoenicolasius\",\r\n  \"Ilex verticillata\",\r\n  \"Ilex verticillata\",\r\n  \"Ilex glabra\",\r\n  \"Ilex verticillata\",\r\n  \"Barbarea vulgaris\",\r\n  \"Barbarea verna\",\r\n  \"Clematis virginiana\",\r\n  \"Argyreia nervosa\",\r\n  \"Ambrosia artemisiifolia\",\r\n  \"Corydalis sempervirens\",\r\n  \"Barbarea vulgaris\",\r\n  \"Achillea\",\r\n  \"Achillea millefolium\",\r\n  \"Achillea filipendulina\",\r\n  \"Achillea ptarmica\",\r\n  \"Achillea tomentosa\",\r\n  \"Rorippa sylvestris\",\r\n  \"Cladrastis lutea\",\r\n  \"Maclura pomifera\",\r\n  \"Echinacea paradoxa\",\r\n  \"Dioscorea\",\r\n  \"Camellia yunnanensis\",\r\n  \"Brachystegia spiciformis\",\r\n  \"Curcuma zedoaria\",\r\n];\r\n","import plantNames from \"common/plantNames\";\r\nimport { sampleArray } from \"math\";\r\nimport { CELL_BUILD_TIME } from \"../constants\";\r\nimport { Cell } from \"./cell\";\r\nimport { GeneInstance } from \"./geneInstance\";\r\nimport { RealizedGene } from \"./realizedGene\";\r\n\r\nexport class Gene<S = any, K extends string = any> {\r\n  private constructor(\r\n    public readonly blueprint: GeneBlueprint<K>,\r\n    public readonly initialStateFn: GeneInitialStateFn<S, K>,\r\n    public readonly stepFn: GeneStepFn<S, K>,\r\n    public readonly shouldStepFn: GeneShouldStepFn<S, K>\r\n  ) {}\r\n\r\n  level(level: number): RealizedGene<Gene<S, K>> {\r\n    return new RealizedGene(this, level);\r\n  }\r\n\r\n  static make<S = any, K extends string = string>(\r\n    blueprint: GeneBlueprint<K>,\r\n    initialState: GeneInitialStateFn<S, K> | S,\r\n    step: GeneStepFn<S, K>,\r\n    shouldStep: GeneShouldStepFn<S, K> = defaultShouldStepFn\r\n  ) {\r\n    const initialStateFn =\r\n      typeof initialState === \"function\" ? (initialState as GeneInitialStateFn<S, K>) : () => ({ ...initialState });\r\n    const gene = new Gene(blueprint, initialStateFn, step, shouldStep);\r\n    const { name } = gene.blueprint;\r\n    const exists = AllGenesByName.has(name);\r\n    if (exists) {\r\n      const newName = name + \" \" + sampleArray(plantNames);\r\n      console.warn(\"A gene named\", name, \"already exists! Renaming this one to\", newName);\r\n      gene.blueprint.name = newName;\r\n    }\r\n    AllGenesByName.set(gene.blueprint.name, (gene as unknown) as Gene);\r\n    return gene;\r\n  }\r\n}\r\n\r\nexport const AllGenesByName: Map<string, Gene> = new Map();\r\n\r\nexport const defaultProperties: GeneStaticProperties = {\r\n  cantFreeze: false,\r\n  isReproductive: false,\r\n  isObstacle: false,\r\n  inventoryCapacity: 0,\r\n  diffusionWater: 0,\r\n  diffusionSugar: 0,\r\n  timeToBuild: CELL_BUILD_TIME,\r\n  isDirectional: false,\r\n};\r\n\r\nexport type GeneStaticProperties = {\r\n  cantFreeze: boolean;\r\n  isReproductive: boolean;\r\n  isDirectional: boolean;\r\n  isObstacle: boolean;\r\n  inventoryCapacity: number;\r\n  diffusionWater: number;\r\n  diffusionSugar: number;\r\n  timeToBuild: number;\r\n  [k: string]: number | boolean;\r\n};\r\n\r\nexport type RealizedProps<K extends string> = Record<K, number>;\r\n\r\nexport type PropBlueprint<K extends string> = Record<K, number | number[]>;\r\n\r\nexport interface GeneBlueprint<K extends string> {\r\n  name: string;\r\n  description: (props: RealizedProps<K>, sProps: Partial<GeneStaticProperties>) => React.ReactNode;\r\n  levelCosts: number[];\r\n  levelProps: PropBlueprint<K>;\r\n  static?: GeneStaticPropertiesBlueprint;\r\n  requirements?: Gene[];\r\n}\r\n\r\nexport type GeneStaticPropertiesBlueprint = {\r\n  [K in keyof GeneStaticProperties]?: GeneStaticProperties[K] | Array<GeneStaticProperties[K]>;\r\n};\r\n\r\n// export type GeneInitialStateFn<S, K extends string> = (instance: GeneInstance<Gene<S, K>>) => S;\r\nexport type GeneInitialStateFn<S, K extends string> = (gene: Gene<S, K>, props: RealizedProps<K>, cell: Cell) => S;\r\n\r\nexport type GeneStepFn<S, K extends string> = (dt: number, instance: GeneInstance<Gene<S, K>>) => S | void;\r\n\r\nexport type GeneShouldStepFn<S, K extends string> = (dt: number, instance: GeneInstance<Gene<S, K>>) => boolean;\r\n\r\nexport const defaultShouldStepFn: GeneShouldStepFn<any, any> = (dt) => {\r\n  return true;\r\n};\r\n","import blopSrc from \"assets/audio/Blop-Mark_DiAngelo-79054334.mp3\";\r\nimport buildSoundSrc from \"assets/audio/build.mp3\";\r\nimport buildCompleteSrc from \"assets/audio/build_complete.mp3\";\r\nimport deconstructSoundSrc from \"assets/audio/deconstruct.mp3\";\r\nimport dropWaterSrc from \"assets/audio/drop_water.mp3\";\r\nimport eatingSoundSrc from \"assets/audio/eating.mp3\";\r\nimport footstepsSrc from \"assets/audio/footsteps.wav\";\r\nimport fruitPoofSrc from \"assets/audio/fruit-popOpen.mp3\";\r\nimport impactSoftMedium003Src from \"assets/audio/impactSoft_medium_003.mp3\";\r\nimport interactSoundSrc from \"assets/audio/interact.mp3\";\r\nimport introBounceSrc from \"assets/audio/intro-bounce.mp3\";\r\nimport mitoBaseSrc from \"assets/audio/mito-base.mp3\";\r\nimport mitoDrumsSrc from \"assets/audio/mito-drums.mp3\";\r\nimport mitoOverworldMp3 from \"assets/audio/mito-overworld.mp3\";\r\nimport mitoStartScreenMp3 from \"assets/audio/mito-start.mp3\";\r\nimport mitoStringsSrc from \"assets/audio/mito-strings.mp3\";\r\nimport mitoDeathMp3 from \"assets/audio/mitodeath.mp3\";\r\nimport stickySoundSrc from \"assets/audio/sticky.mp3\";\r\nimport suckWaterSrc from \"assets/audio/suckwater.wav\";\r\nimport whooshSrc from \"assets/audio/whoosh.mp3\";\r\nimport { SketchAudioContext } from \"game/screens/sketch/sketch\";\r\nimport { Howl } from \"howler\";\r\nimport * as THREE from \"three\";\r\nimport devlog from \"../common/devlog\";\r\nimport { Player } from \"../core\";\r\nimport { Tile } from \"../core/tile\";\r\n\r\nexport let mito: AudioUnit;\r\nexport let strings: AudioUnit;\r\nexport let drums: AudioUnit;\r\n\r\nexport const mitoDeath = new Howl({\r\n  src: mitoDeathMp3,\r\n  autoplay: false,\r\n  loop: true,\r\n  volume: 1,\r\n});\r\n\r\nexport const mitoStartScreen = new Howl({\r\n  src: mitoStartScreenMp3,\r\n  autoplay: false,\r\n  loop: true,\r\n  volume: 0.3,\r\n});\r\n\r\nexport const mitoOverworld = new Howl({\r\n  src: mitoOverworldMp3,\r\n  autoplay: false,\r\n  loop: true,\r\n  volume: 0.15,\r\n});\r\n\r\nexport const footsteps = new Howl({\r\n  src: [footstepsSrc],\r\n  autoplay: true,\r\n  loop: true,\r\n  volume: 0,\r\n});\r\n\r\nexport const interactSound = new Howl({\r\n  src: [interactSoundSrc],\r\n  autoplay: true,\r\n  loop: true,\r\n  volume: 0,\r\n});\r\n\r\nexport const introBounce = new Howl({\r\n  src: introBounceSrc,\r\n  volume: 0.5,\r\n});\r\n\r\nexport const whoosh = new Howl({\r\n  src: whooshSrc,\r\n  volume: 0.2,\r\n});\r\n\r\nexport const fruitPoof = new Howl({\r\n  src: fruitPoofSrc,\r\n  volume: 0.3,\r\n});\r\n\r\nexport const build = new Howl({\r\n  src: [buildSoundSrc],\r\n  volume: 0.1,\r\n});\r\n\r\nexport const buildComplete = new Howl({\r\n  src: [buildCompleteSrc],\r\n  volume: 0.5,\r\n});\r\n\r\nexport const deconstruct = new Howl({\r\n  src: [deconstructSoundSrc],\r\n  volume: 0.5,\r\n});\r\n\r\nexport const sticky = new Howl({\r\n  src: [stickySoundSrc],\r\n});\r\n\r\nexport const dropSugar = new Howl({\r\n  src: [impactSoftMedium003Src],\r\n  volume: 1,\r\n});\r\n\r\nexport const dropWater = new Howl({\r\n  src: [dropWaterSrc],\r\n});\r\n\r\nconst loader = new THREE.AudioLoader();\r\nfunction loadAudioPromise(src: string) {\r\n  return new Promise<AudioBuffer>((resolve, reject) => {\r\n    loader.load(\r\n      src,\r\n      (audioBuffer) => {\r\n        resolve(audioBuffer);\r\n      },\r\n      (xhr: ProgressEvent) => {\r\n        // devlog((xhr.loaded / xhr.total * 100) + '% loaded');\r\n      },\r\n      (err: any) => {\r\n        devlog(\"An error happened\");\r\n        reject(err);\r\n      }\r\n    );\r\n  });\r\n}\r\nexport const blopBuffer = loadAudioPromise(blopSrc);\r\nexport const suckWaterBuffer = loadAudioPromise(suckWaterSrc);\r\nexport const eatBuffer = loadAudioPromise(eatingSoundSrc);\r\n\r\nexport function hookUpAudio(ctx: SketchAudioContext) {\r\n  let numDone = 0;\r\n  function oneMoreLoaded() {\r\n    numDone++;\r\n    if (numDone === 3) {\r\n      mito.audio.currentTime = 0;\r\n      strings.audio.currentTime = 0;\r\n      drums.audio.currentTime = 0;\r\n      mito.gain.connect(ctx.gain);\r\n      strings.gain.connect(ctx.gain);\r\n      drums.gain.connect(ctx.gain);\r\n    }\r\n  }\r\n  mito = makeUnitFromAudioAsset(ctx, mitoBaseSrc);\r\n  mito.audio.oncanplaythrough = oneMoreLoaded;\r\n  mito.gain.gain.value = 0.5;\r\n\r\n  strings = makeUnitFromAudioAsset(ctx, mitoStringsSrc);\r\n  strings.audio.oncanplaythrough = oneMoreLoaded;\r\n  strings.gain.gain.value = 0.0;\r\n\r\n  drums = makeUnitFromAudioAsset(ctx, mitoDrumsSrc);\r\n  drums.audio.oncanplaythrough = oneMoreLoaded;\r\n  drums.gain.gain.value = 0.0;\r\n}\r\n\r\nfunction sourceElement(src: string) {\r\n  const type = src.substr(src.length - 3);\r\n  const source = document.createElement(\"source\");\r\n  source.src = src;\r\n  source.type = `audio/${type}`;\r\n  return source;\r\n}\r\n\r\nfunction makeUnitFromAudioAsset(ctx: SketchAudioContext, ...srcs: string[]): AudioUnit {\r\n  const audio = document.createElement(\"audio\");\r\n  audio.autoplay = true;\r\n  audio.loop = true;\r\n  for (const src of srcs) {\r\n    audio.appendChild(sourceElement(src));\r\n  }\r\n  // audio.appendChild(sourceElement(assetName, \"mp3\"));\r\n  // audio.appendChild(sourceElement(assetName, \"wav\"));\r\n  const source = ctx.createMediaElementSource(audio);\r\n  const gain = ctx.createGain();\r\n  source.connect(gain);\r\n  return { audio, gain };\r\n}\r\n\r\ninterface AudioUnit {\r\n  gain: GainNode;\r\n  audio: HTMLAudioElement;\r\n}\r\n\r\nexport function distScalar(source: Tile, player: Player) {\r\n  const dist = source.pos.distanceToSquared(player.pos);\r\n  const scalar = Math.min(1, 1 / (1 + dist / 25));\r\n  return scalar;\r\n}\r\n","import { createSimpleSchema, list, object, serializable } from \"serializr\";\r\nimport { Vector2 } from \"three\";\r\nimport { CellArgs } from \"./cell\";\r\nimport Chromosome from \"./chromosome\";\r\nimport { MaterialInfo, MaterialInfoSchema } from \"./materialInfo\";\r\nimport { RealizedGene } from \"./realizedGene\";\r\n\r\nexport interface CellInteraction {\r\n  type: \"give\" | \"take\";\r\n  resources: \"water\" | \"sugar\" | \"water and sugar\" | \"water take sugar\" | \"sugar take water\";\r\n}\r\n\r\nconst interactSpeedMap: Record<string, InteractSpeed> = {\r\n  \"give water\": \"instant\",\r\n  \"give sugar\": \"instant\", // mostly for Tissue\r\n  \"give water and sugar\": \"continuous\", // mostly for Seed\r\n  \"give water take sugar\": \"continuous\", // mostly for Leaf\r\n  \"give sugar take water\": \"instant\",\r\n  \"take water\": \"continuous\",\r\n  \"take sugar\": \"continuous\",\r\n  \"take water and sugar\": \"continuous\", // mostly for Root\r\n};\r\n\r\nexport type InteractSpeed = \"instant\" | \"continuous\";\r\n\r\nexport function interactionSpeed(interaction: CellInteraction): InteractSpeed {\r\n  const { resources, type } = interaction;\r\n  const name = `${type} ${resources}`;\r\n  return interactSpeedMap[name] ?? \"instant\";\r\n}\r\n\r\nconst CellInteractionSchema = createSimpleSchema({\r\n  \"*\": true,\r\n});\r\n\r\nexport class CellType {\r\n  @serializable\r\n  public name: string;\r\n\r\n  @serializable\r\n  public geneSlots: number;\r\n\r\n  @serializable(object(Chromosome))\r\n  public chromosome: Chromosome;\r\n\r\n  @serializable(object(MaterialInfoSchema))\r\n  public material: MaterialInfo;\r\n\r\n  @serializable(object(CellInteractionSchema))\r\n  public interaction?: CellInteraction;\r\n\r\n  public args?: CellArgs;\r\n\r\n  // all params optional because serializr might call this with 0 args\r\n  constructor(\r\n    name?: string,\r\n    geneSlots?: number,\r\n    chromosome?: Chromosome,\r\n    material?: MaterialInfo,\r\n    interaction?: CellInteraction\r\n  ) {\r\n    this.name = name!;\r\n    this.geneSlots = geneSlots!;\r\n    this.chromosome = chromosome!;\r\n    this.material = material!;\r\n    this.interaction = interaction;\r\n    if (chromosome?.mergeStaticProperties().isDirectional) {\r\n      this.args = {\r\n        direction: new Vector2(0, -1),\r\n      };\r\n    }\r\n  }\r\n\r\n  rotateArgDirection() {\r\n    const direction = this.args?.direction;\r\n    direction\r\n      ?.rotateAround(new Vector2(), -Math.PI / 4)\r\n      .setLength(1)\r\n      .round();\r\n  }\r\n}\r\n\r\nexport default class Genome {\r\n  @serializable(list(object(CellType)))\r\n  public cellTypes: CellType[];\r\n\r\n  @serializable(list(object(RealizedGene)))\r\n  public unusedGenes: RealizedGene[];\r\n\r\n  constructor(cellTypes?: CellType[], unusedGenes?: RealizedGene[]) {\r\n    this.cellTypes = cellTypes!;\r\n    this.unusedGenes = unusedGenes!;\r\n  }\r\n}\r\n\r\nexport function describeCellInteraction({ resources, type }: CellInteraction) {\r\n  return `${type} ${resources}`;\r\n}\r\n","export type TickerCallback = (time: number) => boolean | void;\r\nclass TickerClass {\r\n  private tickerId = 1;\r\n\r\n  private tickers: Record<number, TickerCallback> = {};\r\n\r\n  private _time = 0;\r\n\r\n  get now() {\r\n    return this._time;\r\n  }\r\n\r\n  tickerLoop = (time: number) => {\r\n    this._time = time;\r\n    const toDelete: number[] = [];\r\n    for (const id in this.tickers) {\r\n      const f = this.tickers[id];\r\n      const shouldDelete = f(time);\r\n      if (shouldDelete === true) {\r\n        toDelete.push(Number(id));\r\n      }\r\n    }\r\n    for (const id of toDelete) {\r\n      this.removeAnimation(id);\r\n    }\r\n    requestAnimationFrame(this.tickerLoop);\r\n  };\r\n\r\n  /**\r\n   * Return true to kill the ticker.\r\n   */\r\n  public addAnimation(fn: TickerCallback) {\r\n    const id = this.tickerId++;\r\n    this.tickers[id] = fn;\r\n    return id;\r\n  }\r\n\r\n  public removeAnimation(id: number) {\r\n    return delete this.tickers[id];\r\n  }\r\n\r\n  public start() {\r\n    requestAnimationFrame(this.tickerLoop);\r\n  }\r\n}\r\n\r\nconst Ticker = new TickerClass();\r\nTicker.start();\r\n\r\nexport default Ticker;\r\n","import DynamicNumber, { DynamicNumberProps } from \"game/ui/common/DynamicNumber\";\r\nimport React from \"react\";\r\n\r\nconst GN: React.FC<DynamicNumberProps> = (props) => {\r\n  return (\r\n    <span className=\"gn\">\r\n      <DynamicNumber {...props} />\r\n    </span>\r\n  );\r\n};\r\n\r\nexport default GN;\r\n","import { EventEmitter } from \"events\";\r\nimport { Vector2 } from \"three\";\r\n\r\n// floating point rounding error fix\r\n// without: 0.8 - 0.1 = 0.7000000000000001\r\n// with: fpref(0.8 - 0.1) = 0.7\r\nfunction fpref(x: number) {\r\n  return Math.round(x * 1e12) / 1e12;\r\n}\r\n\r\ninterface HasPosition {\r\n  pos: Vector2;\r\n}\r\n\r\nexport class Inventory {\r\n  constructor(\r\n    public capacity: number,\r\n    public carrier: HasPosition,\r\n    public water: number = 0,\r\n    public sugar: number = 0\r\n  ) {\r\n    this.validate();\r\n  }\r\n\r\n  // public exchange(other: Inventory, giveWater: number, giveSugar: number, getWater: number, getSugar: number) {\r\n  //     giveWater = Math.min(giveWater, this.water);\r\n  //     giveSugar = Math.min(giveSugar, this.sugar);\r\n  //     getWater = Math.min(getWater, other.water);\r\n  //     getSugar = Math.min(getWater, other.sugar);\r\n\r\n  //     // positive = give this amount\r\n  //     // negative = other gives this amount\r\n  //     const wantedExchangedWater = giveWater - getWater;\r\n  //     const wantedExchangedSugar = giveSugar - getSugar;\r\n\r\n  //     const mySpace = fpref(this.space() + wantedExchangedSugar + wantedExchangedWater);\r\n  //     const otherSpace = fpref(other.space() - wantedExchangedSugar - wantedExchangedWater);\r\n\r\n  //     // const mySpace = fpref(this.capacity + giveWater + giveSugar - this.water - this.sugar);\r\n\r\n  //     // const otherSpace = fpref(other.capacity - other.water - other.sugar)\r\n\r\n  //     // const mySpaceNeeded = fpref(getWater + getSugar);\r\n  //     // const otherSpaceNeeded = fpref(giveWater + giveSugar);\r\n\r\n  //     // if (mySpace < mySpaceNeeded) {\r\n  //     //     // e.g. space = 2, needed = 4\r\n  //     //     // only get half\r\n  //     //     const weightedRatio = mySpace / mySpaceNeeded;\r\n  //     //     getWater = getWater * mySpace / mySpaceNeeded;\r\n  //     //     getSugar = getSugar * mySpace / mySpaceNeeded;\r\n  //     // }\r\n\r\n  //     // if (otherSpace < otherSpaceNeeded) {\r\n  //     //     giveWater = giveWater / otherSpace;\r\n  //     //     giveSugar = giveSugar / otherSpace;\r\n  //     // }\r\n  // }\r\n\r\n  public isEmpty() {\r\n    return this.water === 0 && this.sugar === 0;\r\n  }\r\n\r\n  public give(other: Inventory, amountWater: number, amountSugar: number) {\r\n    if (other === this) {\r\n      throw new Error(\"shouldn't give to self\");\r\n    }\r\n    if (amountWater === 0 && amountSugar === 0) {\r\n      return { water: 0, sugar: 0 };\r\n    }\r\n    // to check:\r\n    // 1) we have enough water and sugar\r\n    //      if we don't, cap water and sugar to the amount available\r\n    // 2) other has enough space\r\n    //      if it doesn't, scale down to the amount that is available\r\n    // 3) if negative, check how much you can take from other\r\n    let water = amountWater > 0 ? Math.min(amountWater, this.water) : -Math.min(-amountWater, other.water);\r\n    let sugar = amountSugar > 0 ? Math.min(amountSugar, this.sugar) : -Math.min(-amountSugar, other.sugar);\r\n\r\n    const spaceNeeded = fpref(water + sugar);\r\n    const spaceAvailable = other.space();\r\n    if (spaceNeeded > spaceAvailable) {\r\n      // scale down the amount to give\r\n      // give less than capacity\r\n      water = Math.floor((water / spaceNeeded) * spaceAvailable);\r\n      sugar = Math.floor((sugar / spaceNeeded) * spaceAvailable);\r\n    }\r\n    if (water !== 0 || sugar !== 0) {\r\n      this.change(-water, -sugar);\r\n      other.change(water, sugar);\r\n      if (this.events) {\r\n        this.events.emit(\"give\", other, water, sugar);\r\n      }\r\n      if (other.events) {\r\n        other.events.emit(\"get\", this, water, sugar);\r\n      }\r\n    }\r\n    return { water, sugar };\r\n  }\r\n\r\n  private events?: EventEmitter;\r\n\r\n  public on(name: \"give\" | \"get\" | \"add\", fn: (...args: any[]) => void) {\r\n    this.events = this.events || new EventEmitter();\r\n    this.events.on(name, fn);\r\n  }\r\n\r\n  public off(name: \"give\" | \"get\" | \"add\", fn: (...args: any[]) => any) {\r\n    this.events = this.events || new EventEmitter();\r\n    this.events.off(name, fn);\r\n  }\r\n\r\n  /**\r\n   * Set resources to an exact value; usually used in tile generation.\r\n   */\r\n  public set(water: number, sugar: number) {\r\n    this.water = 0;\r\n    this.sugar = 0;\r\n    this.add(water, sugar);\r\n  }\r\n\r\n  public add(water: number, sugar: number) {\r\n    const spaceNeeded = fpref(water + sugar);\r\n    const spaceAvailable = this.space();\r\n    if (spaceNeeded > spaceAvailable) {\r\n      // scale down the amount to give\r\n      water = (water / spaceNeeded) * spaceAvailable;\r\n      sugar = (sugar / spaceNeeded) * spaceAvailable;\r\n    }\r\n    this.change(water, sugar);\r\n    if (this.events) {\r\n      this.events.emit(\"add\", water, sugar);\r\n    }\r\n  }\r\n\r\n  private change(water: number, sugar: number) {\r\n    const newWater = fpref(this.water + water);\r\n    const newSugar = fpref(this.sugar + sugar);\r\n    this.validate(newWater, newSugar);\r\n    this.water = newWater;\r\n    this.sugar = newSugar;\r\n\r\n    // fixup if needed\r\n    if (this.water < 0) {\r\n      this.water = 0;\r\n    }\r\n    if (this.sugar < 0) {\r\n      this.sugar = 0;\r\n    }\r\n    if (this.water + this.sugar > this.capacity) {\r\n      if (this.water > this.sugar) {\r\n        this.water = this.capacity - this.sugar;\r\n      } else {\r\n        this.sugar = this.capacity - this.water;\r\n      }\r\n    }\r\n  }\r\n\r\n  public space() {\r\n    const { capacity, water, sugar } = this;\r\n    return fpref(capacity - water - sugar);\r\n  }\r\n\r\n  public isMaxed() {\r\n    return this.space() < 1;\r\n  }\r\n\r\n  validate(water: number = this.water, sugar: number = this.sugar) {\r\n    const { capacity } = this;\r\n    if (water < 0) {\r\n      console.warn(`water < 0: ${water}`);\r\n      // throw new Error(`water < 0: ${water}`);\r\n    }\r\n    if (sugar < 0) {\r\n      console.warn(`sugar < 0: ${sugar}`);\r\n      // throw new Error(`sugar < 0: ${sugar}`);\r\n    }\r\n    if (water + sugar > capacity) {\r\n      console.warn(`bad inventory: ${water} water + ${sugar} > ${capacity} max`);\r\n      // throw new Error(`bad inventory: ${water} water + ${sugar} > ${capacity} max`);\r\n    }\r\n  }\r\n}\r\n\r\nexport interface HasInventory {\r\n  inventory: Inventory;\r\n}\r\n\r\nexport function hasInventory<T>(obj?: T): obj is HasInventory & T {\r\n  return obj != null && (obj as any).inventory instanceof Inventory;\r\n}\r\n","import { Player } from \"core\";\r\nimport { Inventory } from \"core/inventory\";\r\nimport { Action } from \"core/player/action\";\r\nimport { Vector2 } from \"three\";\r\nimport { CELL_DROOP } from \"../constants\";\r\nimport { DIRECTIONS } from \"../directions\";\r\nimport { step } from \"../entity\";\r\nimport { Interactable, isInteractable } from \"../interactable\";\r\nimport { nextTemperature, Temperature } from \"../temperature\";\r\nimport { Rock } from \"../tile/rock\";\r\nimport { Soil } from \"../tile/soil\";\r\nimport { Tile } from \"../tile/tile\";\r\nimport { World } from \"../world/world\";\r\nimport { CellEffect, CellEffectConstructor, FreezeEffect } from \"./cellEffect\";\r\nimport Chromosome from \"./chromosome\";\r\nimport { DeadCell } from \"./deadCell\";\r\nimport { Gene, GeneStaticProperties } from \"./gene\";\r\nimport { GeneInstance } from \"./geneInstance\";\r\nimport { CellType, interactionSpeed } from \"./genome\";\r\n\r\nexport interface CellArgs {\r\n  direction?: Vector2;\r\n}\r\n\r\nexport class Cell extends Tile implements Interactable {\r\n  get displayName() {\r\n    return this.type.name;\r\n  }\r\n\r\n  set displayName(n: string) {}\r\n\r\n  public energy = 1;\r\n\r\n  public darkness = 0;\r\n\r\n  public nextTemperature: number;\r\n\r\n  // offset [-0.5, 0.5] means you're still \"inside\" this cell, going out of it will break you\r\n  // public offset = new Vector2();\r\n  public droopY = 0;\r\n\r\n  public effects: CellEffect[] = [];\r\n\r\n  public chromosome: Chromosome;\r\n\r\n  public geneInstances: GeneInstance<Gene<any, string>>[];\r\n\r\n  public inventory: Inventory;\r\n\r\n  public readonly staticProperties: GeneStaticProperties;\r\n\r\n  get isObstacle() {\r\n    return this.staticProperties.isObstacle;\r\n  }\r\n\r\n  get isReproductive() {\r\n    return this.staticProperties.isReproductive;\r\n  }\r\n\r\n  get diffusionWater() {\r\n    return this.staticProperties.diffusionWater;\r\n  }\r\n\r\n  get diffusionSugar() {\r\n    return this.staticProperties.diffusionSugar;\r\n  }\r\n\r\n  get timeToBuild() {\r\n    return this.staticProperties.timeToBuild;\r\n  }\r\n\r\n  constructor(\r\n    pos: Vector2,\r\n    world: World,\r\n    public type: CellType,\r\n    public args: CellArgs = { direction: new Vector2(0, -1) }\r\n  ) {\r\n    super(pos, world);\r\n    this.chromosome = type.chromosome;\r\n    this.staticProperties = this.chromosome.mergeStaticProperties();\r\n    const { inventoryCapacity, isDirectional } = this.staticProperties;\r\n    this.inventory = new Inventory(inventoryCapacity, this);\r\n    if (isDirectional) {\r\n      const dir = args?.direction?.clone() ?? new Vector2(1, 0);\r\n      if (isFractional(dir.x) || isFractional(dir.y)) {\r\n        throw new Error(\"build transport with fractional dir \" + dir.x + \", \" + dir.y);\r\n      }\r\n      if (dir.lengthManhattan() < 1 || dir.lengthManhattan() > 3) {\r\n        console.error(\"bad dir length\", dir);\r\n      }\r\n    }\r\n    this.temperatureFloat = 48;\r\n    this.nextTemperature = this.temperatureFloat;\r\n\r\n    this.geneInstances = this.chromosome.newGeneInstances(this);\r\n  }\r\n\r\n  protected get tempo() {\r\n    if (this.temperatureFloat <= 0) {\r\n      // 50% slower - 1 / 2;\r\n      return 1 / 2;\r\n    } else if (this.temperatureFloat <= 32) {\r\n      // 33% slower - 2 / (2 / 3) = 3\r\n      return 2 / 3;\r\n    } else if (this.temperatureFloat <= 64) {\r\n      return 1;\r\n    } else if (this.temperatureFloat <= 96) {\r\n      // 25% faster\r\n      return 1.25;\r\n    } else {\r\n      // 50% faster\r\n      return 1.5;\r\n    }\r\n  }\r\n\r\n  public getMovespeedMultiplier() {\r\n    return this.tempo;\r\n  }\r\n\r\n  get darknessContrib() {\r\n    return 0;\r\n  }\r\n\r\n  addEffect(effect: CellEffect) {\r\n    const stacks = (effect.constructor as CellEffectConstructor).stacks;\r\n    if (!stacks) {\r\n      // exit early if we found another one and we don't stack\r\n      if (this.findEffectOfType(effect.constructor as CellEffectConstructor) != null) {\r\n        return;\r\n      }\r\n    }\r\n    if (this.staticProperties.cantFreeze && effect instanceof FreezeEffect) {\r\n      return;\r\n    }\r\n    effect.attachTo(this);\r\n    this.effects.push(effect);\r\n  }\r\n\r\n  findEffectOfType(type: CellEffectConstructor) {\r\n    return this.effects.find((e) => e.constructor === type);\r\n  }\r\n\r\n  interact(source: Player) {\r\n    for (const e of this.effects) {\r\n      if (isInteractable(e)) {\r\n        const action = e.interact(source);\r\n        if (action != null) {\r\n          return action;\r\n        }\r\n      }\r\n    }\r\n    // Cell interaction\r\n    const { interaction } = this.type;\r\n    if (interaction != null) {\r\n      const [water, sugar] = (() => {\r\n        switch (interaction.resources) {\r\n          case \"water\":\r\n            return [1, 0];\r\n          case \"sugar\":\r\n            return [0, 1];\r\n          case \"water and sugar\":\r\n            return [1, 1];\r\n          case \"sugar take water\":\r\n            return [-1, 1];\r\n          case \"water take sugar\":\r\n            return [1, -1];\r\n        }\r\n      })();\r\n      const action: Action = {\r\n        type: interaction.type === \"give\" ? \"drop\" : \"pickup\",\r\n        water,\r\n        sugar,\r\n        target: this,\r\n        continuous: interactionSpeed(interaction) === \"continuous\",\r\n      };\r\n      return action;\r\n    }\r\n  }\r\n\r\n  public isDead = false;\r\n\r\n  die() {\r\n    this.world.setTileAt(this.pos, new DeadCell(this.pos, this.world));\r\n  }\r\n\r\n  shouldStep(dt: number) {\r\n    return dt > 0.1;\r\n  }\r\n\r\n  findGene<G extends Gene>(gene: G): GeneInstance<G> | undefined {\r\n    return this.geneInstances.find((g) => g.isType(gene)) as GeneInstance<G>;\r\n  }\r\n\r\n  step(dt: number) {\r\n    // diffusion, darkness, gravity\r\n    super.step(dt);\r\n\r\n    const tileNeighbors = this.world.tileNeighbors(this.pos);\r\n    this.stepDroop(tileNeighbors, dt);\r\n\r\n    if (this.droopY > 0.5) {\r\n      if (this.pos.y < this.world.height - 1) {\r\n        // make the player ride the train!\r\n        if (this.world.player.pos.equals(this.pos)) {\r\n          this.world.player.posFloat.y += 1;\r\n        }\r\n        this.world.maybeRemoveCellAt(this.pos);\r\n        this.pos.y += 1;\r\n        this.droopY -= 1;\r\n        this.world.setTileAt(this.pos, this);\r\n      } else {\r\n        this.droopY = 0.5;\r\n      }\r\n    }\r\n\r\n    if (this.energy <= 0) {\r\n      this.die();\r\n    } else {\r\n      // cell effects and genes scale according to tempo\r\n      dt = this.tempo * dt;\r\n\r\n      // step all cell effects (e.g.freezing)\r\n      for (const effect of this.effects) {\r\n        effect.step(dt);\r\n      }\r\n\r\n      // step all genes\r\n      this.geneInstances.forEach((g) => step(g, dt));\r\n    }\r\n  }\r\n\r\n  stepTemperature(dt: number) {\r\n    const neighbors = this.world.tileNeighbors(this.pos);\r\n    const neighborTemperatures = Array.from(neighbors.values()).map((t) => t.temperatureFloat);\r\n    this.nextTemperature = nextTemperature(this.temperatureFloat, neighborTemperatures, dt);\r\n    // if we're cold, try to naturally heat ourselves\r\n    if (this.temperatureFloat <= 32) {\r\n      const chanceToFreeze = (this.temperature === Temperature.Cold ? 0.03 : 0.3) * dt;\r\n      if (Math.random() < chanceToFreeze) {\r\n        this.addEffect(new FreezeEffect());\r\n      }\r\n    } else if (this.temperatureFloat >= 64) {\r\n      const waterToLose = Math.min(this.inventory.water, 1);\r\n      const chanceEvaporate = waterToLose * (this.temperature === Temperature.Hot ? 0.003 : 0.3);\r\n      if (Math.random() < chanceEvaporate * dt) {\r\n        this.inventory.add(-waterToLose, 0);\r\n        this.world.logEvent({\r\n          type: \"evaporation\",\r\n          tile: this,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  stepDroop(tileNeighbors: Map<Vector2, Tile>, dt: number) {\r\n    const below = tileNeighbors.get(DIRECTIONS.s)!;\r\n    const belowLeft = tileNeighbors.get(DIRECTIONS.sw)!;\r\n    const belowRight = tileNeighbors.get(DIRECTIONS.se)!;\r\n    const left = tileNeighbors.get(DIRECTIONS.w)!;\r\n    const right = tileNeighbors.get(DIRECTIONS.e)!;\r\n    const above = tileNeighbors.get(DIRECTIONS.n)!;\r\n    const aboveLeft = tileNeighbors.get(DIRECTIONS.nw)!;\r\n    const aboveRight = tileNeighbors.get(DIRECTIONS.ne)!;\r\n    const droopAmount = CELL_DROOP;\r\n    this.droopY += droopAmount;\r\n    if (this.energy < 0.5) {\r\n      this.droopY += droopAmount;\r\n    }\r\n    for (const cell of [below, belowLeft, belowRight]) {\r\n      if (cell instanceof Rock || cell instanceof Soil) {\r\n        this.droopY = Math.min(this.droopY, 0);\r\n        return;\r\n      } else if (cell instanceof Cell) {\r\n        this.droopY = Math.min(this.droopY, cell.droopY);\r\n        return;\r\n      }\r\n    }\r\n    const springNeighborCells = [aboveLeft, above, aboveRight, left, right, this].filter(\r\n      (n) => n instanceof Cell\r\n    ) as Cell[];\r\n    // TODO tighten springs scaled by dt\r\n    this.droopY = springNeighborCells.reduce((sum, n) => sum + n.droopY, 0) / springNeighborCells.length;\r\n  }\r\n\r\n  stepDarkness(neighbors: Map<Vector2, Tile>) {\r\n    return 0;\r\n  }\r\n}\r\n\r\nfunction isFractional(x: number) {\r\n  return x % 1 !== 0;\r\n}\r\n","import { Vector2 } from \"three\";\r\n\r\nexport const DIRECTIONS = {\r\n  nw: new Vector2(-1, -1),\r\n  w: new Vector2(-1, 0),\r\n  sw: new Vector2(-1, +1),\r\n  n: new Vector2(0, -1),\r\n  // new Vector2( 0,  0),\r\n  s: new Vector2(0, +1),\r\n  ne: new Vector2(+1, -1),\r\n  e: new Vector2(+1, 0),\r\n  se: new Vector2(+1, +1),\r\n};\r\n\r\nexport type Directions = keyof typeof DIRECTIONS;\r\n\r\nexport const DIRECTION_NAMES = Object.keys(DIRECTIONS) as Directions[];\r\nexport const DIRECTION_VALUES: Vector2[] = DIRECTION_NAMES.map((o) => DIRECTIONS[o]);\r\n","import { Inventory } from \"core/inventory\";\r\nimport MP from \"game/ui/common/MP\";\r\nimport { clamp } from \"math\";\r\nimport React from \"react\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport { GeneInstance } from \"../../core/cell/geneInstance\";\r\nimport { TIME_PER_MONTH } from \"../../core/constants\";\r\n\r\nexport interface ReproducerState {\r\n  timeMatured?: number;\r\n  isMature: boolean;\r\n  committedResources: Inventory;\r\n}\r\n\r\nexport const GeneFruit = Gene.make<ReproducerState>(\r\n  {\r\n    name: \"Fruit\",\r\n    levelCosts: [10, 15, 20, 25, 30],\r\n    levelProps: {\r\n      mpEarned: [3, 4, 5, 6, 7],\r\n      neededResources: 500,\r\n      secondsToMature: 2 * TIME_PER_MONTH,\r\n    },\r\n    static: {\r\n      isReproductive: true,\r\n      // TODO fix this to be a \"set to 0\"\r\n      timeToBuild: -1,\r\n    },\r\n    description: reproducerDescription,\r\n  },\r\n  (gene, props, cell) => ({\r\n    isMature: false,\r\n    committedResources: new Inventory(props.neededResources, cell),\r\n  }),\r\n  (dt, instance) => {\r\n    reproducerStep(dt, instance);\r\n  }\r\n);\r\n\r\nexport type GeneFruit = typeof GeneFruit;\r\n\r\nexport const GeneSeed = Gene.make<ReproducerState>(\r\n  {\r\n    name: \"Seed\",\r\n    levelCosts: [6, 8, 10, 12, 14],\r\n    levelProps: {\r\n      mpEarned: [0.5, 0.75, 1, 1.25, 1.5],\r\n      neededResources: 100,\r\n      secondsToMature: 30,\r\n    },\r\n    static: {\r\n      isReproductive: true,\r\n      timeToBuild: -1,\r\n    },\r\n    description: reproducerDescription,\r\n  },\r\n  (gene, props, cell) => ({\r\n    isMature: false,\r\n    committedResources: new Inventory(props.neededResources, cell),\r\n  }),\r\n  (dt, instance) => {\r\n    reproducerStep(dt, instance);\r\n  }\r\n);\r\n\r\nexport type GeneSeed = typeof GeneSeed;\r\n\r\nfunction reproducerDescription({ mpEarned, neededResources, secondsToMature }: Record<string, number>) {\r\n  return (\r\n    <>\r\n      <p>Reproducer.</p>\r\n      <p>\r\n        Consumes {neededResources / 2} Water and {neededResources / 2} Sugar on this Cell to reach Maturity.{\" \"}\r\n      </p>\r\n      <p>\r\n        On Maturity,{\" \"}\r\n        <b>\r\n          achieve <span className=\"reproduction\">Survival</span>\r\n        </b>{\" \"}\r\n        and earn <MP amount={mpEarned} />.\r\n      </p>\r\n      <p>With constant feeding, Fruit can mature in {secondsToMature} seconds.</p>\r\n    </>\r\n  );\r\n}\r\n\r\nfunction reproducerStep(dt: number, instance: GeneInstance<Gene<ReproducerState, string>>) {\r\n  const {\r\n    cell,\r\n    state,\r\n    props: { mpEarned, neededResources, secondsToMature },\r\n  } = instance;\r\n  const { committedResources, isMature } = state;\r\n  if (!isMature) {\r\n    commitResources(dt, cell, committedResources, neededResources, secondsToMature);\r\n    const isNowMature = reproducerGetPercentMatured(instance) === 1;\r\n    if (isNowMature) {\r\n      state.isMature = isNowMature;\r\n      state.timeMatured = cell.world.time;\r\n      instance.earnMP(cell, mpEarned);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Return whether the reproducer is now mature.\r\n */\r\nfunction commitResources(\r\n  dt: number,\r\n  cell: Cell,\r\n  inventory: Inventory,\r\n  neededResources: number,\r\n  secondsToMature: number\r\n) {\r\n  const oneSecondCommitMax = neededResources / secondsToMature;\r\n  const wantedWater = clamp(neededResources / 2 - inventory.water, 0, oneSecondCommitMax * dt);\r\n  const wantedSugar = clamp(neededResources / 2 - inventory.sugar, 0, oneSecondCommitMax * dt);\r\n  const { water, sugar } = cell.inventory.give(inventory, wantedWater, wantedSugar);\r\n  if (water + sugar > 0) {\r\n    cell.world.logEvent({\r\n      type: \"grow-fruit\",\r\n      cell,\r\n      resourcesUsed: water + sugar,\r\n    });\r\n  }\r\n}\r\n\r\nexport function reproducerGetPercentMatured(g: GeneInstance<Gene<ReproducerState, any>>) {\r\n  const r = g.state.committedResources;\r\n  // add 1 buffer for fp errors\r\n  return clamp((r.sugar + r.water) / (r.capacity - 1), 0, 1);\r\n}\r\n","import { Interactable } from \"core/interactable\";\r\nimport { Inventory } from \"core/inventory\";\r\nimport { Action } from \"core/player/action\";\r\nimport { canPullResources } from \"core/tile/canPullResources\";\r\nimport { Tile } from \"core/tile/tile\";\r\nimport { clamp, map, randRound } from \"math/index\";\r\nexport abstract class Soil extends Tile implements Interactable {\r\n  /**\r\n   * Soil will aggressively hold onto water below saturation;\r\n   * after saturation, water is easily moved by forces diffusion or gravity.\r\n   */\r\n  abstract get saturation(): number;\r\n\r\n  /**\r\n   * How far away is this soil from the nearest Air?\r\n   */\r\n  public depth = 1000;\r\n\r\n  isObstacle = false;\r\n\r\n  get depthDiffusionFactor() {\r\n    // make water move slower in deeper soil. Every depth 10, slow down gravity and fallAmount by this much\r\n    return 1 + (this.depth - 1) / 10;\r\n    // return 1;\r\n  }\r\n\r\n  interact(): Action {\r\n    return {\r\n      type: \"pickup\",\r\n      water: 0.1,\r\n      sugar: 0.1,\r\n      target: this,\r\n      continuous: true,\r\n    };\r\n  }\r\n\r\n  shouldStep(dt: number) {\r\n    // test this out\r\n    return dt > 0.2;\r\n  }\r\n\r\n  step(dt: number) {\r\n    super.step(dt);\r\n    this.stepEvaporation(dt);\r\n  }\r\n\r\n  stepEvaporation(dt: number) {\r\n    const { secondsToEvaporate } = this.world.environment;\r\n    const water = this.inventory.water;\r\n    const evaporationChance = (water / secondsToEvaporate) * clamp(map(this.depth, 1, 8, 1, 0), 0, 1);\r\n    if (Math.random() < evaporationChance * dt) {\r\n      const waterToEvaporate = Math.min(water, 1);\r\n      this.inventory.add(-waterToEvaporate, 0);\r\n      this.world.logEvent({ type: \"evaporation\", tile: this });\r\n      this.world.numEvaporatedSoil += waterToEvaporate;\r\n    }\r\n  }\r\n\r\n  diffuseWater(tile: Tile, dt: number, diffusionRate?: number) {\r\n    if (this.pos.y < tile.pos.y) {\r\n      // test: don't diffuse upwards\r\n      return;\r\n    }\r\n    if (tile instanceof Soil && tile.inventory.water <= tile.saturation) {\r\n      return;\r\n    }\r\n    return super.diffuseWater(tile, dt, diffusionRate);\r\n  }\r\n\r\n  stepGravity(dt: number) {\r\n    const freeWater = this.inventory.water - this.saturation;\r\n    if (freeWater > 0) {\r\n      const fallAmount = this.fallAmount * dt;\r\n      const lowerNeighbor = this.world.tileAt(this.pos.x, this.pos.y + 1);\r\n      // if (fallAmount > 0 && this.age % Math.floor(1 / fallAmount) < 1) {\r\n      //   if (hasInventory(lowerNeighbor) && canPullResources(lowerNeighbor, this)) {\r\n      //     this.inventory.give(lowerNeighbor.inventory, 1, 0);\r\n      //   }\r\n      // }\r\n      if (fallAmount > 0 && lowerNeighbor != null && canPullResources(lowerNeighbor, this)) {\r\n        const waterToGive = Math.min(randRound(fallAmount), freeWater);\r\n        this.inventory.give(lowerNeighbor.inventory, waterToGive, 0);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport class Sand extends Soil {\r\n  displayName = \"Sand\";\r\n\r\n  get diffusionWater() {\r\n    return 1 / (3 * this.depthDiffusionFactor);\r\n  }\r\n\r\n  get saturation() {\r\n    return 0;\r\n  }\r\n\r\n  get fallAmount() {\r\n    return 1.5 / this.depthDiffusionFactor;\r\n  }\r\n\r\n  public inventory = new Inventory(20, this);\r\n}\r\n\r\nexport class Silt extends Soil {\r\n  displayName = \"Silt\";\r\n\r\n  get diffusionWater() {\r\n    return 1 / (12 * this.depthDiffusionFactor);\r\n  }\r\n\r\n  get saturation() {\r\n    return 2;\r\n  }\r\n\r\n  get fallAmount() {\r\n    return 0.2 / this.depthDiffusionFactor;\r\n  }\r\n\r\n  public inventory = new Inventory(10, this);\r\n}\r\n\r\nexport class Clay extends Soil {\r\n  displayName = \"Clay\";\r\n\r\n  get diffusionWater() {\r\n    return 1 / (100 * this.depthDiffusionFactor);\r\n  }\r\n\r\n  get saturation() {\r\n    return 5;\r\n  }\r\n\r\n  get fallAmount() {\r\n    return 0.05 / this.depthDiffusionFactor;\r\n  }\r\n\r\n  public inventory = new Inventory(10, this);\r\n}\r\n","const cache: Map<string, Intl.NumberFormat> = new Map();\r\nexport function nf(n: number, maximumSignificantDigits: number = 3, minimumSignificantDigits?: number) {\r\n  const key = `${minimumSignificantDigits},${maximumSignificantDigits}`;\r\n  if (!cache.has(key)) {\r\n    cache.set(\r\n      key,\r\n      new Intl.NumberFormat(undefined, {\r\n        maximumSignificantDigits,\r\n        minimumSignificantDigits,\r\n        useGrouping: true,\r\n      })\r\n    );\r\n  }\r\n  return cache.get(key)!.format(n);\r\n}\r\n","import { list, object, serializable } from \"serializr\";\r\nimport { GeneInventory, GeneLiving } from \"std/genes\";\r\nimport { Cell } from \"../tile\";\r\nimport { defaultProperties, Gene } from \"./gene\";\r\nimport { RealizedGene } from \"./realizedGene\";\r\n\r\nexport default class Chromosome {\r\n  static basic(): Chromosome {\r\n    return new Chromosome(GeneLiving.level(2), GeneInventory.level(2));\r\n  }\r\n\r\n  @serializable(list(object(RealizedGene)))\r\n  public genes: RealizedGene[];\r\n\r\n  constructor(...genes: RealizedGene[]) {\r\n    this.genes = genes;\r\n  }\r\n\r\n  /**\r\n   * Booleans overwrite each other; numbers add together.\r\n   */\r\n  public mergeStaticProperties() {\r\n    const finalProps = { ...defaultProperties };\r\n    for (const g of this.genes) {\r\n      // TODO beware of clobbering\r\n      for (const [k, v] of Object.entries(g.getStaticProperties())) {\r\n        if (typeof v === \"boolean\") {\r\n          finalProps[k] = v;\r\n        } else if (typeof v === \"number\") {\r\n          finalProps[k] = (finalProps[k] as number) + v;\r\n        }\r\n      }\r\n      // Object.assign(finalProps, g.getStaticProperties());\r\n    }\r\n    return finalProps;\r\n  }\r\n\r\n  newGeneInstances(cell: Cell) {\r\n    return this.genes.map((g) => g.newInstance(cell));\r\n  }\r\n\r\n  has(gene: Gene): boolean {\r\n    return this.genes.find((r) => r.gene === gene) != null;\r\n  }\r\n\r\n  geneSlotsUsed() {\r\n    return this.genes\r\n      .map((g) => g.getCost())\r\n      .filter((c) => c >= 0)\r\n      .reduce((a, b) => a + b, 0);\r\n  }\r\n\r\n  geneSlotsAdded() {\r\n    return (\r\n      this.genes\r\n        .map((g) => g.getCost())\r\n        .filter((c) => c < 0)\r\n        .reduce((a, b) => a + b, 0) * -1\r\n    );\r\n  }\r\n\r\n  geneSlotsNet(): number {\r\n    return this.geneSlotsAdded() - this.geneSlotsUsed();\r\n  }\r\n}\r\n","import { lerp } from \"math\";\r\n\r\nexport enum Temperature {\r\n  Scorching = \"Scorching\",\r\n  Hot = \"Hot\",\r\n  Mild = \"Mild\",\r\n  Cold = \"Cold\",\r\n  Freezing = \"Freezing\",\r\n}\r\n\r\nexport function temperatureFor(t: number) {\r\n  if (t <= 0) {\r\n    return Temperature.Freezing;\r\n  } else if (t <= 32) {\r\n    return Temperature.Cold;\r\n  } else if (t <= 64) {\r\n    return Temperature.Mild;\r\n  } else if (t <= 96) {\r\n    return Temperature.Hot;\r\n  } else {\r\n    return Temperature.Scorching;\r\n  }\r\n}\r\n\r\nexport function nextTemperature(currentTemperature: number, neighborTemperatures: number[], dt: number): number {\r\n  let averageTemperature = currentTemperature;\r\n  for (const temp of neighborTemperatures) {\r\n    averageTemperature += temp;\r\n  }\r\n  averageTemperature /= neighborTemperatures.length + 1;\r\n  // TODO maybe use proper dt-scaling lerp\r\n  return lerp(currentTemperature, averageTemperature, Math.min(6 * dt, 1));\r\n}\r\n","import React from \"react\";\r\nimport Ticker from \"std/ticker\";\r\nimport { nf } from \"../../../common/formatters\";\r\n\r\nexport interface DynamicNumberProps {\r\n  value: number;\r\n  speed?: number;\r\n  sigFigs?: number;\r\n}\r\n\r\nfunction DynamicNumber({ value, speed = 0.5, sigFigs = 3 }: DynamicNumberProps) {\r\n  const [v, setV] = React.useState(value);\r\n\r\n  React.useEffect(() => {\r\n    const id = Ticker.addAnimation(() => {\r\n      setV((v) => {\r\n        if (Math.abs(v - value) < 5e-3) {\r\n          Ticker.removeAnimation(id);\r\n          return value;\r\n        } else {\r\n          return v * (1 - speed) + value * speed;\r\n        }\r\n      });\r\n    });\r\n    return () => {\r\n      Ticker.removeAnimation(id);\r\n    };\r\n  }, [value, speed]);\r\n\r\n  return <>{nf(v, sigFigs)}</>;\r\n}\r\n\r\nexport default DynamicNumber;\r\n","import shuffle from \"math/shuffle\";\r\nimport { Vector2 } from \"three\";\r\nimport { map, randRound } from \"../../math/index\";\r\nimport { Steppable } from \"../entity\";\r\nimport { HasInventory, Inventory } from \"../inventory\";\r\nimport { Temperature, temperatureFor } from \"../temperature\";\r\nimport { World } from \"../world/world\";\r\nimport { canPullResources } from \"./canPullResources\";\r\n\r\nexport abstract class Tile implements Steppable, HasInventory {\r\n  displayName = \"Tile\";\r\n\r\n  static fallAmount = 0;\r\n\r\n  public abstract get isObstacle(): boolean;\r\n\r\n  public darkness = Infinity;\r\n\r\n  public temperatureFloat: number;\r\n\r\n  public dtSinceLastStepped = 0;\r\n\r\n  public abstract inventory: Inventory;\r\n\r\n  // public lightIntersection?: Intersection;\r\n  get temperature(): Temperature {\r\n    return temperatureFor(this.temperatureFloat);\r\n  }\r\n\r\n  get diffusionWater(): number {\r\n    return (this.constructor as any).diffusionWater;\r\n  }\r\n\r\n  get diffusionSugar(): number {\r\n    return (this.constructor as any).diffusionSugar;\r\n  }\r\n\r\n  get fallAmount(): number {\r\n    return (this.constructor as any).fallAmount;\r\n  }\r\n\r\n  get darknessContrib(): number {\r\n    const contrib = Math.max(\r\n      0.2\r\n      // map(this.pos.y, this.world.height / 2, this.world.height, params.soilDarknessBase, 1)\r\n    );\r\n    return contrib;\r\n  }\r\n\r\n  public readonly timeMade: number;\r\n\r\n  public pos: Vector2;\r\n\r\n  public get age() {\r\n    return this.world.time - this.timeMade;\r\n  }\r\n\r\n  public constructor(pos: Vector2, public readonly world: World) {\r\n    this.pos = pos.clone();\r\n    if (world == null) {\r\n      throw new Error(\"null world!\");\r\n    }\r\n    this.timeMade = world.time;\r\n    this.temperatureFloat = this.world.weather.getCurrentTemperature();\r\n  }\r\n\r\n  abstract shouldStep(dt: number): boolean;\r\n\r\n  public lightAmount() {\r\n    return Math.sqrt(Math.min(Math.max(map(1 - this.darkness, 0, 1, 0, 1), 0), 1));\r\n  }\r\n\r\n  /**\r\n   * Redistribute this tile's inventory to nearby tiles if possible, usually\r\n   * in preparation for removing this tile.\r\n   */\r\n  public redistributeInventoryToNeighbors() {\r\n    if (this.inventory.water > 0 || this.inventory.sugar > 0) {\r\n      // push resources to nearby tiles\r\n      const neighbors = this.world.tileNeighbors(this.pos);\r\n      const giveCandidates = Array.from(neighbors.values()).filter((n) => canPullResources(n, this));\r\n      while (!this.inventory.isEmpty() && giveCandidates.length > 0) {\r\n        shuffle(giveCandidates);\r\n        for (let i = 0; i < giveCandidates.length; i++) {\r\n          const neighbor = giveCandidates[i];\r\n          // give 1 to this neighbor\r\n          this.inventory.give(neighbor.inventory, 1, 1);\r\n          // delete this neighbor from candidates to give\r\n          if (neighbor.inventory.isMaxed()) {\r\n            giveCandidates.splice(i, 1);\r\n          }\r\n          if (this.inventory.isEmpty()) {\r\n            // we're all done\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // test tiles diffusing water around on same-type tiles\r\n  public step(dt: number) {\r\n    const neighbors = this.world.tileNeighbors(this.pos);\r\n    this.stepDarkness(neighbors);\r\n    this.stepDiffusion(neighbors, dt);\r\n    this.stepTemperature(dt);\r\n    this.stepGravity(dt);\r\n  }\r\n\r\n  stepTemperature(_dt: number) {\r\n    this.temperatureFloat = this.world.weather.getCurrentTemperature();\r\n  }\r\n\r\n  stepDarkness(neighbors: Map<Vector2, Tile>) {\r\n    let minDarkness = this.darkness;\r\n    for (const [, t] of neighbors) {\r\n      const darknessFromNeighbor = t.darkness + t.darknessContrib;\r\n      minDarkness = Math.min(minDarkness, darknessFromNeighbor);\r\n    }\r\n    this.darkness = minDarkness;\r\n  }\r\n\r\n  stepDiffusion(neighbors: Map<Vector2, Tile>, dt: number) {\r\n    for (const tile of neighbors.values()) {\r\n      if (!canPullResources(this, tile)) {\r\n        continue;\r\n      }\r\n      // take water from neighbors that have more water than you\r\n      if (this.diffusionWater != null) {\r\n        if (tile.inventory.water > this.inventory.water) {\r\n          this.diffuseWater(tile, dt);\r\n        }\r\n      }\r\n      if (this.diffusionSugar != null) {\r\n        if (tile.inventory.sugar > this.inventory.sugar) {\r\n          this.diffuseSugar(tile, dt);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  diffuseWater(giver: Tile, dt: number, diffusionRate = this.diffusionWater) {\r\n    // Diffusion equation by finite difference: the purpose of this equation is to eventually\r\n    // equalize the amount of water between me and giver. The two questions are how long\r\n    // does it take, and what function does it follow to get there? These are generally\r\n    // defined by the diffusionWater variable. At these low numbers we can assume\r\n    // near linearity.\r\n    const difference = giver.inventory.water - this.inventory.water;\r\n    if (difference > 1) {\r\n      const diffusionAmount = Math.min(difference * diffusionRate * dt, difference / 2);\r\n      giver.inventory.give(this.inventory, randRound(diffusionAmount), 0);\r\n    }\r\n  }\r\n\r\n  diffuseSugar(giver: Tile, dt: number) {\r\n    const difference = giver.inventory.sugar - this.inventory.sugar;\r\n    if (difference > 1) {\r\n      const diffusionAmount = Math.min(difference * this.diffusionSugar * dt, difference / 2);\r\n      // sugar diffuses continuously\r\n      giver.inventory.give(this.inventory, 0, randRound(diffusionAmount));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Give to your lower neighbor.\r\n   */\r\n  stepGravity(dt: number) {\r\n    const fallAmount = this.fallAmount * dt;\r\n    const lowerNeighbor = this.world.tileAt(this.pos.x, this.pos.y + 1);\r\n    // if (fallAmount > 0 && this.age % Math.floor(1 / fallAmount) < 1) {\r\n    //   if (hasInventory(lowerNeighbor) && canPullResources(lowerNeighbor, this)) {\r\n    //     this.inventory.give(lowerNeighbor.inventory, 1, 0);\r\n    //   }\r\n    // }\r\n    if (fallAmount > 0 && lowerNeighbor != null && canPullResources(lowerNeighbor, this)) {\r\n      this.inventory.give(lowerNeighbor.inventory, randRound(fallAmount), 0);\r\n    }\r\n  }\r\n\r\n  toString() {\r\n    return this.displayName + \"(\" + this.pos.x + \",\" + this.pos.y + \")\";\r\n  }\r\n}\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Vector2 } from \"three\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport { Air } from \"../../core/tile/air\";\r\n\r\nexport interface PhotosynthesisState {\r\n  totalSugarProduced: number;\r\n  averageConversionRate: number;\r\n  averageChancePerSecond: number;\r\n  sugarConverted: number;\r\n  activeNeighbors: Vector2[];\r\n}\r\n\r\nexport const GenePhotosynthesis = Gene.make<PhotosynthesisState>(\r\n  {\r\n    name: \"Photosynthesis\",\r\n    levelCosts: [3, 6, 9, 12, 15],\r\n    levelProps: {\r\n      reactionChancePerSecond: [0.00625, 0.0125, 0.025, 0.05, 0.1],\r\n    },\r\n    description: ({ reactionChancePerSecond }) => (\r\n      <>\r\n        Each neighboring Air provides a <GN value={reactionChancePerSecond * 100} sigFigs={3} />% chance per second,\r\n        scaled with sunlight, to convert up to 2 Water into 1 Sugar.\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    totalSugarProduced: 0,\r\n    averageConversionRate: 0,\r\n    averageChancePerSecond: 0,\r\n    sugarConverted: 0,\r\n    activeNeighbors: [],\r\n  },\r\n  (dt, { cell, state, props: { reactionChancePerSecond } }) => {\r\n    state.averageConversionRate = 0;\r\n    state.averageChancePerSecond = 0;\r\n    state.sugarConverted = 0;\r\n    state.activeNeighbors = [];\r\n\r\n    const neighbors = cell.world.tileNeighbors(cell.pos);\r\n    let numAir = 0;\r\n    for (const [dir, tile] of neighbors) {\r\n      if (tile instanceof Air) {\r\n        state.activeNeighbors.push(dir);\r\n        numAir += 1;\r\n        maybePhotosynthesize(dt, tile, cell, reactionChancePerSecond, state);\r\n      }\r\n    }\r\n    if (numAir > 0) {\r\n      state.averageConversionRate /= numAir;\r\n      // this.averageSpeed /= numAir;\r\n    }\r\n  }\r\n);\r\nexport type GenePhotosynthesis = typeof GenePhotosynthesis;\r\n\r\nfunction maybePhotosynthesize(\r\n  dt: number,\r\n  air: Air,\r\n  cell: Cell,\r\n  reactionChancePerSecond: number,\r\n  state: PhotosynthesisState\r\n) {\r\n  const sunlight = air.sunlight();\r\n\r\n  // gives much less sugar lower down\r\n  // const conversionRate = air.co2();\r\n\r\n  const conversionRate = 0.5;\r\n  state.averageConversionRate += conversionRate;\r\n  // in prime conditions:\r\n  //      our rate of conversion is speed * params.leafReactionRate\r\n  //      we get 1 sugar at 1/efficiencyRatio (> 1) water\r\n  // if we have less than 1/efficiencyRatio water\r\n  //      our rate of conversion scales down proportionally\r\n  //      on conversion, we use up all the available water and get the corresponding amount of sugar\r\n  const bestEfficiencyWater = 1 / conversionRate;\r\n  const waterToConvert = Math.min(cell.inventory.water, bestEfficiencyWater);\r\n\r\n  const ambientChancePerSecond = reactionChancePerSecond * sunlight;\r\n  // this.sunlightCollected += chance * dt;\r\n  cell.world.logEvent({\r\n    type: \"collect-sunlight\",\r\n    leaf: cell,\r\n    air,\r\n    // the renderer creates one dot per sunlight unit.\r\n    // 0.025 normalizes chancePerSecond (which is 0.025 for photosynthesis 3),\r\n    // * 20 means photosynthesis 3 gets 20 dots per second (this is the new player experience)\r\n    numSunlight: (ambientChancePerSecond / 0.025) * dt * 20,\r\n  });\r\n\r\n  // let intersectionChancePerSecond = 0;\r\n  // if (cell.world.occluderManager.getIntersection(cell) != null) {\r\n  //   intersectionChancePerSecond = reactionChancePerSecond * sunlight * 5;\r\n  //   const p = cell.lightIntersection.point;\r\n  //   cell.world.logEvent({\r\n  //     type: \"collect-sunlight\",\r\n  //     leaf: cell,\r\n  //     air,\r\n  //     // the renderer creates one dot per sunlight unit.\r\n  //     // 0.025 normalizes chancePerSecond (which is 0.025 for photosynthesis 3),\r\n  //     // * 20 means photosynthesis 3 gets 20 dots per second (this is the new player experience)\r\n  //     numSunlight: (intersectionChancePerSecond / 0.025) * dt * 20,\r\n  //     point: new Vector2(p.x, p.y),\r\n  //   });\r\n  // }\r\n  // let chancePerSecond = ambientChancePerSecond + intersectionChancePerSecond; // * (waterToConvert / bestEfficiencyWater);\r\n\r\n  const chancePerSecond = ambientChancePerSecond;\r\n\r\n  state.averageChancePerSecond += chancePerSecond;\r\n\r\n  if (Math.random() < chancePerSecond * dt && waterToConvert > 0) {\r\n    const sugarConverted = waterToConvert * conversionRate;\r\n    cell.inventory.add(-waterToConvert, sugarConverted);\r\n    state.sugarConverted += sugarConverted;\r\n    state.totalSugarProduced += sugarConverted;\r\n    cell.world.logEvent({\r\n      type: \"photosynthesis\",\r\n      cell,\r\n      amount: sugarConverted,\r\n    });\r\n  }\r\n}\r\n","import classNames from \"classnames\";\r\nimport React from \"react\";\r\nimport { GiDna1 } from \"react-icons/gi\";\r\nimport DynamicNumber from \"./DynamicNumber\";\r\nimport \"./MP.scss\";\r\n\r\nexport type MPProps = JSX.IntrinsicElements[\"div\"] & {\r\n  amount: number;\r\n  total?: number;\r\n};\r\n\r\nfunction MP({ amount, total, ...props }: MPProps) {\r\n  return (\r\n    <span {...props} className={classNames(\"mp\", props.className)}>\r\n      <DynamicNumber speed={0.5} sigFigs={5} value={amount} />\r\n      {total != null ? <>/{total}</> : null}\r\n      <GiDna1 className=\"mp-icon\" />\r\n    </span>\r\n  );\r\n}\r\n\r\nexport default MP;\r\n","import React from \"react\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nexport const GeneObstacle = Gene.make(\r\n  {\r\n    name: \"Obstacle\",\r\n    levelCosts: [-4],\r\n    levelProps: {},\r\n    static: {\r\n      isObstacle: true,\r\n    },\r\n    description: () => <>You may not walk on this Cell.</>,\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneObstacle = typeof GeneObstacle;\r\n","import { Player } from \"core\";\r\nimport { ActionThaw } from \"core/player/action\";\r\nimport { Constructor } from \"../../typings/constructor\";\r\nimport { TIME_PER_DAY } from \"../constants\";\r\nimport { StopStep } from \"../entity\";\r\nimport { Interactable } from \"../interactable\";\r\nimport { Temperature } from \"../temperature\";\r\nimport { Cell } from \"./cell\";\r\nexport abstract class CellEffect {\r\n  private timeMade!: number;\r\n\r\n  public cell!: Cell;\r\n\r\n  get age() {\r\n    return this.cell.world.time - this.timeMade;\r\n  }\r\n\r\n  attachTo(cell: Cell) {\r\n    this.cell = cell;\r\n    this.timeMade = this.cell.world.time;\r\n    this.onAttached();\r\n  }\r\n\r\n  onAttached() {}\r\n\r\n  /**\r\n   * Return whether to step the next behavior in the chain\r\n   */\r\n  abstract step(dt: number): void;\r\n\r\n  remove() {\r\n    const index = this.cell.effects.indexOf(this);\r\n    this.cell.effects.splice(index, 1);\r\n  }\r\n}\r\n\r\nexport interface CellEffectConstructor extends Constructor<CellEffect> {\r\n  displayName: string;\r\n  stacks?: boolean;\r\n}\r\nexport class FreezeEffect extends CellEffect implements Interactable {\r\n  static displayName = \"Frozen\";\r\n\r\n  static stacks = false;\r\n\r\n  public readonly secondsToDie = TIME_PER_DAY;\r\n\r\n  public percentFrozen = 0.25;\r\n\r\n  chunkCooldown = 0;\r\n\r\n  get timeUntilDeath() {\r\n    return this.secondsToDie - this.age;\r\n  }\r\n\r\n  interact(source: Player): ActionThaw {\r\n    return {\r\n      type: \"thaw\",\r\n      target: this,\r\n    };\r\n  }\r\n\r\n  thaw(_dt: number) {\r\n    if (this.chunkCooldown <= 0) {\r\n      this.chunkCooldown += 0.5;\r\n      this.percentFrozen -= (15 / this.secondsToDie) * 0.5;\r\n      if (this.percentFrozen < 0.02) {\r\n        this.percentFrozen = 0;\r\n      }\r\n      this.cell.world.logEvent({\r\n        type: \"thaw\",\r\n        where: this.cell,\r\n      });\r\n    }\r\n    // this.percentFrozen -= (20 / this.secondsToDie) * dt;\r\n    this.onFrozenChanged();\r\n  }\r\n\r\n  step(dt: number) {\r\n    if (this.chunkCooldown > 0) {\r\n      this.chunkCooldown -= dt;\r\n    }\r\n    if (this.cell.temperature === Temperature.Cold) {\r\n      this.percentFrozen += (1 / this.secondsToDie) * dt;\r\n    } else if (this.cell.temperature === Temperature.Freezing) {\r\n      this.percentFrozen += (10 / this.secondsToDie) * dt;\r\n    } else {\r\n      // this.percentFrozen -= (10 / this.secondsToDie) * dt;\r\n    }\r\n    this.onFrozenChanged();\r\n    this.cell.energy -= dt / this.secondsToDie;\r\n    throw new StopStep();\r\n  }\r\n\r\n  onAttached() {\r\n    this.cell.energy -= 0.2;\r\n  }\r\n\r\n  onFrozenChanged() {\r\n    if (this.percentFrozen > 1) {\r\n      this.cell.die();\r\n    } else if (this.percentFrozen <= 0) {\r\n      this.remove();\r\n    }\r\n  }\r\n}\r\n\r\nexport class CancerEffect extends CellEffect {\r\n  static displayName = \"Cancerous\";\r\n\r\n  static stacks = false;\r\n\r\n  public secondsPerDuplication = 5;\r\n\r\n  public timeToDuplicate = 5;\r\n\r\n  step(dt: number): void {\r\n    this.timeToDuplicate -= dt;\r\n    if (this.timeToDuplicate < 0) {\r\n      const world = this.cell.world;\r\n      const neighbors = world.tileNeighbors(this.cell.pos);\r\n      for (const [, tile] of neighbors) {\r\n        if (tile instanceof Cell && !tile.findEffectOfType(CancerEffect)) {\r\n          tile.addEffect(new CancerEffect());\r\n          break;\r\n        } else if (tile.world.player.canBuildAt(tile)) {\r\n          // const cell = new Cell(tile.pos, world, this.cell.type, this.cell.args);\r\n          const completed = tile.world.player.attemptBuild(\r\n            {\r\n              type: \"build\",\r\n              cellType: this.cell.type,\r\n              position: tile.pos,\r\n              args: this.cell.args,\r\n            },\r\n            dt\r\n          );\r\n          if (completed) {\r\n            break;\r\n          }\r\n          // const cell = new constructor(tile.pos, world, this.cell.type, this.cell.args);\r\n          // cell.addEffect(new CancerEffect());\r\n          // world.setTileAt(tile.pos, cell);\r\n          break;\r\n        }\r\n      }\r\n      this.timeToDuplicate += this.secondsPerDuplication;\r\n    }\r\n  }\r\n}\r\n","import { Player, PlayerSeed } from \"./player/player\";\r\nimport { Tile } from \"./tile\";\r\n\r\nexport type Entity = Tile | Player | PlayerSeed;\r\n\r\nexport interface Steppable {\r\n  dtSinceLastStepped: number;\r\n  shouldStep(dt: number): boolean;\r\n  step(dt: number): void;\r\n}\r\n\r\nexport class StopStep extends Error {}\r\n\r\nexport function isSteppable(obj: any): obj is Steppable {\r\n  return typeof obj.step === \"function\";\r\n}\r\n\r\nexport function step(s: Steppable, dt: number) {\r\n  const sDt = s.dtSinceLastStepped + dt;\r\n  if (s.shouldStep(sDt)) {\r\n    try {\r\n      s.step(sDt);\r\n    } catch (e) {\r\n      if (e instanceof StopStep) {\r\n        // no-op for exiting early\r\n      } else {\r\n        throw e;\r\n      }\r\n    } finally {\r\n      s.dtSinceLastStepped = 0;\r\n    }\r\n  } else {\r\n    s.dtSinceLastStepped = sDt;\r\n  }\r\n}\r\n","export default function mapRecord<O, R>(obj: O, fn: (val: O[keyof O], key: keyof O) => R): Record<keyof O, R> {\r\n  const out = {} as Record<keyof O, R>;\r\n  let key: keyof O;\r\n  for (key in obj) {\r\n    const val = obj[key];\r\n    out[key] = fn(val, key);\r\n  }\r\n  return out;\r\n}\r\n","import mapRecord from \"common/mapRecord\";\r\nimport { clamp } from \"math\";\r\nimport { custom, serializable } from \"serializr\";\r\nimport { Cell } from \"../tile\";\r\nimport { AllGenesByName, Gene, GeneStaticProperties } from \"./gene\";\r\nimport { GeneInstance } from \"./geneInstance\";\r\n\r\nfunction serializeGeneIntoName(gene: Gene): string {\r\n  return gene.blueprint.name;\r\n}\r\n\r\nfunction deserializeGeneFromName(name: string): Gene {\r\n  return AllGenesByName.get(name)!;\r\n}\r\n\r\nexport class RealizedGene<G extends Gene = Gene> {\r\n  @serializable(custom(serializeGeneIntoName, deserializeGeneFromName))\r\n  public gene: G;\r\n\r\n  @serializable\r\n  public level!: number;\r\n\r\n  public constructor(gene?: G, level?: number) {\r\n    this.gene = gene!;\r\n    if (level != null) {\r\n      this.setLevel(level);\r\n    }\r\n  }\r\n\r\n  getStaticProperties() {\r\n    const staticBlueprint = this.gene.blueprint.static || {};\r\n    return mapRecord(staticBlueprint, (arr) => (Array.isArray(arr) ? arr[this.level] : arr)) as Partial<\r\n      GeneStaticProperties\r\n    >;\r\n  }\r\n\r\n  public getProps() {\r\n    return mapRecord(this.gene.blueprint.levelProps, (val) => (typeof val === \"number\" ? val : val[this.level]));\r\n  }\r\n\r\n  public getCost() {\r\n    return this.gene.blueprint.levelCosts[this.level];\r\n  }\r\n\r\n  setLevel(newLevel: number): void {\r\n    this.level = clamp(newLevel, 0, this.gene.blueprint.levelCosts.length);\r\n  }\r\n\r\n  public newInstance(cell: Cell): GeneInstance<G> {\r\n    return new GeneInstance(this.gene, this.getProps(), cell);\r\n  }\r\n}\r\n","import { Air, Cell, Soil } from \".\";\r\nimport { HasInventory } from \"../inventory\";\r\n\r\nexport function canPullResources(receiver: HasInventory, giver: HasInventory): boolean {\r\n  // allow direct ancestors/child relationships to exchange resources with each other (e.g. Soil and Fountain)\r\n  const hasAncestry = receiver instanceof giver.constructor || giver instanceof receiver.constructor;\r\n\r\n  // allow all Cells to give to each other\r\n  const areCells = receiver instanceof Cell && giver instanceof Cell;\r\n\r\n  const areSoils = receiver instanceof Soil && giver instanceof Soil;\r\n\r\n  // specifically allow air to give to soil\r\n  const isAirToSoil = receiver instanceof Soil && giver instanceof Air;\r\n\r\n  return hasAncestry || areSoils || areCells || isAirToSoil;\r\n}\r\n","export default function shuffle<T>(array: T[]) {\r\n  let currentIndex = array.length,\r\n    temporaryValue,\r\n    randomIndex;\r\n  // While there remain elements to shuffle...\r\n  while (0 !== currentIndex) {\r\n    // Pick a remaining element...\r\n    randomIndex = Math.floor(Math.random() * currentIndex);\r\n    currentIndex -= 1;\r\n    // And swap it with the current element.\r\n    temporaryValue = array[currentIndex];\r\n    array[currentIndex] = array[randomIndex];\r\n    array[randomIndex] = temporaryValue;\r\n  }\r\n  return array;\r\n}\r\n","import { randFloat } from \"math\";\r\nimport React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneDirectionalPush = Gene.make(\r\n  {\r\n    name: \" Directional Push\",\r\n    levelCosts: [2, 3, 4, 5, 6],\r\n    levelProps: {\r\n      secondsPerPush: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerPush }) => (\r\n      <>\r\n        <b>Directional.</b>\r\n        <br />\r\n        Every <GN value={secondsPerPush} sigFigs={2} /> seconds, directionally pull 1 Water and 1 Sugar from behind into\r\n        this Cell, and also push 1 Water and 1 Sugar into the directed Cell.\r\n      </>\r\n    ),\r\n    static: {\r\n      isDirectional: true,\r\n    },\r\n  },\r\n  (gene, { secondsPerPush }) => ({\r\n    didJustTransport: false,\r\n    cooldown: randFloat(0, secondsPerPush),\r\n  }),\r\n  (dt, { cell, state, props: { secondsPerPush } }) => {\r\n    state.didJustTransport = false;\r\n    if (state.cooldown <= 0) {\r\n      state.cooldown += secondsPerPush;\r\n      const forwardTile = cell.world.tileAt(cell.pos.x + cell.args!.direction!.x, cell.pos.y + cell.args!.direction!.y);\r\n      if (forwardTile instanceof Cell) {\r\n        state.didJustTransport = push(cell, forwardTile, 1, 1);\r\n      }\r\n\r\n      const backwardTile = cell.world.tileAt(\r\n        cell.pos.x - cell.args!.direction!.x,\r\n        cell.pos.y - cell.args!.direction!.y\r\n      );\r\n      if (backwardTile instanceof Cell) {\r\n        state.didJustTransport = state.didJustTransport || push(backwardTile, cell, 1, 1);\r\n      }\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneDirectionalPush = typeof GeneDirectionalPush;\r\n\r\nfunction push(cell: Cell, target: Cell, waterToTransport: number, sugarToTransport: number) {\r\n  const { water, sugar } = cell.inventory.give(target.inventory, waterToTransport, sugarToTransport);\r\n  return water > 0 || sugar > 0;\r\n}\r\n","// copy-pasted from https://raw.githubusercontent.com/josephg/noisejs/master/perlin.js\r\n// tslint:disable\r\n\r\n/*\r\n * A speed-improved perlin and simplex noise algorithms for 2D.\r\n *\r\n * Based on example code by Stefan Gustavson (stegu@itn.liu.se).\r\n * Optimisations by Peter Eastman (peastman@drizzle.stanford.edu).\r\n * Better rank ordering method by Stefan Gustavson in 2012.\r\n * Converted to Javascript by Joseph Gentle.\r\n *\r\n * Version 2012-03-09\r\n *\r\n * This code was placed in the public domain by its original author,\r\n * Stefan Gustavson. You may use it as you see fit, but\r\n * attribution is appreciated.\r\n *\r\n */\r\n\r\nclass Grad {\r\n  constructor(public x: number, public y: number, public z: number) {}\r\n\r\n  dot2(x: number, y: number) {\r\n    return this.x * x + this.y * y;\r\n  }\r\n\r\n  dot3(x: number, y: number, z: number) {\r\n    return this.x * x + this.y * y + this.z * z;\r\n  }\r\n}\r\n\r\nconst grad3 = [\r\n  new Grad(1, 1, 0),\r\n  new Grad(-1, 1, 0),\r\n  new Grad(1, -1, 0),\r\n  new Grad(-1, -1, 0),\r\n  new Grad(1, 0, 1),\r\n  new Grad(-1, 0, 1),\r\n  new Grad(1, 0, -1),\r\n  new Grad(-1, 0, -1),\r\n  new Grad(0, 1, 1),\r\n  new Grad(0, -1, 1),\r\n  new Grad(0, 1, -1),\r\n  new Grad(0, -1, -1),\r\n];\r\n\r\nconst p = [\r\n  151,\r\n  160,\r\n  137,\r\n  91,\r\n  90,\r\n  15,\r\n  131,\r\n  13,\r\n  201,\r\n  95,\r\n  96,\r\n  53,\r\n  194,\r\n  233,\r\n  7,\r\n  225,\r\n  140,\r\n  36,\r\n  103,\r\n  30,\r\n  69,\r\n  142,\r\n  8,\r\n  99,\r\n  37,\r\n  240,\r\n  21,\r\n  10,\r\n  23,\r\n  190,\r\n  6,\r\n  148,\r\n  247,\r\n  120,\r\n  234,\r\n  75,\r\n  0,\r\n  26,\r\n  197,\r\n  62,\r\n  94,\r\n  252,\r\n  219,\r\n  203,\r\n  117,\r\n  35,\r\n  11,\r\n  32,\r\n  57,\r\n  177,\r\n  33,\r\n  88,\r\n  237,\r\n  149,\r\n  56,\r\n  87,\r\n  174,\r\n  20,\r\n  125,\r\n  136,\r\n  171,\r\n  168,\r\n  68,\r\n  175,\r\n  74,\r\n  165,\r\n  71,\r\n  134,\r\n  139,\r\n  48,\r\n  27,\r\n  166,\r\n  77,\r\n  146,\r\n  158,\r\n  231,\r\n  83,\r\n  111,\r\n  229,\r\n  122,\r\n  60,\r\n  211,\r\n  133,\r\n  230,\r\n  220,\r\n  105,\r\n  92,\r\n  41,\r\n  55,\r\n  46,\r\n  245,\r\n  40,\r\n  244,\r\n  102,\r\n  143,\r\n  54,\r\n  65,\r\n  25,\r\n  63,\r\n  161,\r\n  1,\r\n  216,\r\n  80,\r\n  73,\r\n  209,\r\n  76,\r\n  132,\r\n  187,\r\n  208,\r\n  89,\r\n  18,\r\n  169,\r\n  200,\r\n  196,\r\n  135,\r\n  130,\r\n  116,\r\n  188,\r\n  159,\r\n  86,\r\n  164,\r\n  100,\r\n  109,\r\n  198,\r\n  173,\r\n  186,\r\n  3,\r\n  64,\r\n  52,\r\n  217,\r\n  226,\r\n  250,\r\n  124,\r\n  123,\r\n  5,\r\n  202,\r\n  38,\r\n  147,\r\n  118,\r\n  126,\r\n  255,\r\n  82,\r\n  85,\r\n  212,\r\n  207,\r\n  206,\r\n  59,\r\n  227,\r\n  47,\r\n  16,\r\n  58,\r\n  17,\r\n  182,\r\n  189,\r\n  28,\r\n  42,\r\n  223,\r\n  183,\r\n  170,\r\n  213,\r\n  119,\r\n  248,\r\n  152,\r\n  2,\r\n  44,\r\n  154,\r\n  163,\r\n  70,\r\n  221,\r\n  153,\r\n  101,\r\n  155,\r\n  167,\r\n  43,\r\n  172,\r\n  9,\r\n  129,\r\n  22,\r\n  39,\r\n  253,\r\n  19,\r\n  98,\r\n  108,\r\n  110,\r\n  79,\r\n  113,\r\n  224,\r\n  232,\r\n  178,\r\n  185,\r\n  112,\r\n  104,\r\n  218,\r\n  246,\r\n  97,\r\n  228,\r\n  251,\r\n  34,\r\n  242,\r\n  193,\r\n  238,\r\n  210,\r\n  144,\r\n  12,\r\n  191,\r\n  179,\r\n  162,\r\n  241,\r\n  81,\r\n  51,\r\n  145,\r\n  235,\r\n  249,\r\n  14,\r\n  239,\r\n  107,\r\n  49,\r\n  192,\r\n  214,\r\n  31,\r\n  181,\r\n  199,\r\n  106,\r\n  157,\r\n  184,\r\n  84,\r\n  204,\r\n  176,\r\n  115,\r\n  121,\r\n  50,\r\n  45,\r\n  127,\r\n  4,\r\n  150,\r\n  254,\r\n  138,\r\n  236,\r\n  205,\r\n  93,\r\n  222,\r\n  114,\r\n  67,\r\n  29,\r\n  24,\r\n  72,\r\n  243,\r\n  141,\r\n  128,\r\n  195,\r\n  78,\r\n  66,\r\n  215,\r\n  61,\r\n  156,\r\n  180,\r\n];\r\n\r\n/*\r\nfor(const i=0; i<256; i++) {\r\nperm[i] = perm[i + 256] = p[i];\r\ngradP[i] = gradP[i + 256] = grad3[perm[i] % 12];\r\n}*/\r\n\r\n// Skewing and unskewing factors for 2, 3, and 4 dimensions\r\nconst F2 = 0.5 * (Math.sqrt(3) - 1);\r\nconst G2 = (3 - Math.sqrt(3)) / 6;\r\n\r\nconst F3 = 1 / 3;\r\nconst G3 = 1 / 6;\r\n\r\nexport class Noise {\r\n  // To remove the need for index wrapping, double the permutation table length\r\n  public perm = new Array(512);\n\r\n  public gradP = new Array(512);\r\n\r\n  public octaveNum = 6;\n\r\n  public octaveFalloff = 0.5;\n\r\n  // rotate by 1 radians (~57 deg), scale by 2\r\n  public octaveMatrix2 = [Math.cos(1) * 2, -Math.sin(1) * 2, Math.sin(1) * 2, Math.cos(1) * 2];\r\n\r\n  // This isn't a very good seeding function, but it works ok. It supports 2^16\r\n  // different seed values. Write something better if you need more seeds.\r\n  public seed(seed: number) {\r\n    if (seed > 0 && seed < 1) {\r\n      // Scale the seed out\r\n      seed *= 65536;\r\n    }\r\n\r\n    seed = Math.floor(seed);\r\n    if (seed < 256) {\r\n      seed |= seed << 8;\r\n    }\r\n\r\n    for (let i = 0; i < 256; i++) {\r\n      let v;\r\n      if (i & 1) {\r\n        v = p[i] ^ (seed & 255);\r\n      } else {\r\n        v = p[i] ^ ((seed >> 8) & 255);\r\n      }\r\n\r\n      this.perm[i] = this.perm[i + 256] = v;\r\n      this.gradP[i] = this.gradP[i + 256] = grad3[v % 12];\r\n    }\r\n  }\r\n\r\n  constructor(seed: number = Math.random() * 2147483647) {\r\n    this.seed(seed);\r\n  }\r\n\r\n  // 2D simplex noise\r\n  public simplex2(xin: number, yin: number) {\r\n    let n0, n1, n2; // Noise contributions from the three corners\r\n    // Skew the input space to determine which simplex cell we're in\r\n    const s = (xin + yin) * F2; // Hairy factor for 2D\r\n    let i = Math.floor(xin + s);\r\n    let j = Math.floor(yin + s);\r\n    const t = (i + j) * G2;\r\n    let x0 = xin - i + t; // The x,y distances from the cell origin, unskewed.\r\n    let y0 = yin - j + t;\r\n    // For the 2D case, the simplex shape is an equilateral triangle.\r\n    // Determine which simplex we are in.\r\n    let i1, j1; // Offsets for second (middle) corner of simplex in (i,j) coords\r\n    if (x0 > y0) {\r\n      // lower triangle, XY order: (0,0)->(1,0)->(1,1)\r\n      i1 = 1;\r\n      j1 = 0;\r\n    } else {\r\n      // upper triangle, YX order: (0,0)->(0,1)->(1,1)\r\n      i1 = 0;\r\n      j1 = 1;\r\n    }\r\n    // A step of (1,0) in (i,j) means a step of (1-c,-c) in (x,y), and\r\n    // a step of (0,1) in (i,j) means a step of (-c,1-c) in (x,y), where\r\n    // c = (3-sqrt(3))/6\r\n    const x1 = x0 - i1 + G2; // Offsets for middle corner in (x,y) unskewed coords\r\n    const y1 = y0 - j1 + G2;\r\n    const x2 = x0 - 1 + 2 * G2; // Offsets for last corner in (x,y) unskewed coords\r\n    const y2 = y0 - 1 + 2 * G2;\r\n    // Work out the hashed gradient indices of the three simplex corners\r\n    i &= 255;\r\n    j &= 255;\r\n    const gi0 = this.gradP[i + this.perm[j]];\r\n    const gi1 = this.gradP[i + i1 + this.perm[j + j1]];\r\n    const gi2 = this.gradP[i + 1 + this.perm[j + 1]];\r\n    // Calculate the contribution from the three corners\r\n    let t0 = 0.5 - x0 * x0 - y0 * y0;\r\n    if (t0 < 0) {\r\n      n0 = 0;\r\n    } else {\r\n      t0 *= t0;\r\n      n0 = t0 * t0 * gi0.dot2(x0, y0); // (x,y) of grad3 used for 2D gradient\r\n    }\r\n    let t1 = 0.5 - x1 * x1 - y1 * y1;\r\n    if (t1 < 0) {\r\n      n1 = 0;\r\n    } else {\r\n      t1 *= t1;\r\n      n1 = t1 * t1 * gi1.dot2(x1, y1);\r\n    }\r\n    let t2 = 0.5 - x2 * x2 - y2 * y2;\r\n    if (t2 < 0) {\r\n      n2 = 0;\r\n    } else {\r\n      t2 *= t2;\r\n      n2 = t2 * t2 * gi2.dot2(x2, y2);\r\n    }\r\n    // Add contributions from each corner to get the final noise value.\r\n    // The result is scaled to return values in the interval [-1,1].\r\n    return 70 * (n0 + n1 + n2);\r\n  }\r\n\r\n  public octaveSimplex2(xin: number, yin: number, octaveNum = this.octaveNum, octaveFalloff = this.octaveFalloff) {\r\n    let sum = 0;\r\n    let x = xin;\r\n    let y = yin;\r\n    let scalar = 1;\r\n    for (let i = 0; i < octaveNum; i++) {\r\n      sum += this.simplex2(x, y) * scalar;\r\n      const newX = x * this.octaveMatrix2[0] + y * this.octaveMatrix2[1];\r\n      const newY = x * this.octaveMatrix2[2] + y * this.octaveMatrix2[3];\r\n      x = newX;\r\n      y = newY;\r\n      scalar *= octaveFalloff;\r\n    }\r\n    return sum;\r\n  }\r\n\r\n  // 3D simplex noise\r\n  public simplex3(xin: number, yin: number, zin: number) {\r\n    let n0, n1, n2, n3; // Noise contributions from the four corners\r\n\r\n    // Skew the input space to determine which simplex cell we're in\r\n    const s = (xin + yin + zin) * F3; // Hairy factor for 2D\r\n    let i = Math.floor(xin + s);\r\n    let j = Math.floor(yin + s);\r\n    let k = Math.floor(zin + s);\r\n\r\n    const t = (i + j + k) * G3;\r\n    const x0 = xin - i + t; // The x,y distances from the cell origin, unskewed.\r\n    const y0 = yin - j + t;\r\n    const z0 = zin - k + t;\r\n\r\n    // For the 3D case, the simplex shape is a slightly irregular tetrahedron.\r\n    // Determine which simplex we are in.\r\n    let i1, j1, k1; // Offsets for second corner of simplex in (i,j,k) coords\r\n    let i2, j2, k2; // Offsets for third corner of simplex in (i,j,k) coords\r\n    if (x0 >= y0) {\r\n      if (y0 >= z0) {\r\n        i1 = 1;\r\n        j1 = 0;\r\n        k1 = 0;\r\n        i2 = 1;\r\n        j2 = 1;\r\n        k2 = 0;\r\n      } else if (x0 >= z0) {\r\n        i1 = 1;\r\n        j1 = 0;\r\n        k1 = 0;\r\n        i2 = 1;\r\n        j2 = 0;\r\n        k2 = 1;\r\n      } else {\r\n        i1 = 0;\r\n        j1 = 0;\r\n        k1 = 1;\r\n        i2 = 1;\r\n        j2 = 0;\r\n        k2 = 1;\r\n      }\r\n    } else {\r\n      if (y0 < z0) {\r\n        i1 = 0;\r\n        j1 = 0;\r\n        k1 = 1;\r\n        i2 = 0;\r\n        j2 = 1;\r\n        k2 = 1;\r\n      } else if (x0 < z0) {\r\n        i1 = 0;\r\n        j1 = 1;\r\n        k1 = 0;\r\n        i2 = 0;\r\n        j2 = 1;\r\n        k2 = 1;\r\n      } else {\r\n        i1 = 0;\r\n        j1 = 1;\r\n        k1 = 0;\r\n        i2 = 1;\r\n        j2 = 1;\r\n        k2 = 0;\r\n      }\r\n    }\r\n    // A step of (1,0,0) in (i,j,k) means a step of (1-c,-c,-c) in (x,y,z),\r\n    // a step of (0,1,0) in (i,j,k) means a step of (-c,1-c,-c) in (x,y,z), and\r\n    // a step of (0,0,1) in (i,j,k) means a step of (-c,-c,1-c) in (x,y,z), where\r\n    // c = 1/6.\r\n    const x1 = x0 - i1 + G3; // Offsets for second corner\r\n    const y1 = y0 - j1 + G3;\r\n    const z1 = z0 - k1 + G3;\r\n\r\n    let x2 = x0 - i2 + 2 * G3; // Offsets for third corner\r\n    let y2 = y0 - j2 + 2 * G3;\r\n    let z2 = z0 - k2 + 2 * G3;\r\n\r\n    let x3 = x0 - 1 + 3 * G3; // Offsets for fourth corner\r\n    let y3 = y0 - 1 + 3 * G3;\r\n    let z3 = z0 - 1 + 3 * G3;\r\n\r\n    // Work out the hashed gradient indices of the four simplex corners\r\n    i &= 255;\r\n    j &= 255;\r\n    k &= 255;\r\n    const { gradP, perm } = this;\r\n    let gi0 = gradP[i + perm[j + perm[k]]];\r\n    let gi1 = gradP[i + i1 + perm[j + j1 + perm[k + k1]]];\r\n    let gi2 = gradP[i + i2 + perm[j + j2 + perm[k + k2]]];\r\n    let gi3 = gradP[i + 1 + perm[j + 1 + perm[k + 1]]];\r\n\r\n    // Calculate the contribution from the four corners\r\n    let t0 = 0.6 - x0 * x0 - y0 * y0 - z0 * z0;\r\n    if (t0 < 0) {\r\n      n0 = 0;\r\n    } else {\r\n      t0 *= t0;\r\n      n0 = t0 * t0 * gi0.dot3(x0, y0, z0); // (x,y) of grad3 used for 2D gradient\r\n    }\r\n    let t1 = 0.6 - x1 * x1 - y1 * y1 - z1 * z1;\r\n    if (t1 < 0) {\r\n      n1 = 0;\r\n    } else {\r\n      t1 *= t1;\r\n      n1 = t1 * t1 * gi1.dot3(x1, y1, z1);\r\n    }\r\n    let t2 = 0.6 - x2 * x2 - y2 * y2 - z2 * z2;\r\n    if (t2 < 0) {\r\n      n2 = 0;\r\n    } else {\r\n      t2 *= t2;\r\n      n2 = t2 * t2 * gi2.dot3(x2, y2, z2);\r\n    }\r\n    let t3 = 0.6 - x3 * x3 - y3 * y3 - z3 * z3;\r\n    if (t3 < 0) {\r\n      n3 = 0;\r\n    } else {\r\n      t3 *= t3;\r\n      n3 = t3 * t3 * gi3.dot3(x3, y3, z3);\r\n    }\r\n    // Add contributions from each corner to get the final noise value.\r\n    // The result is scaled to return values in the interval [-1,1].\r\n    return 32 * (n0 + n1 + n2 + n3);\r\n  }\r\n\r\n  public octaveSimplex3(\r\n    xin: number,\r\n    yin: number,\r\n    zin: number,\r\n    octaveNum = this.octaveNum,\r\n    octaveFalloff = this.octaveFalloff\r\n  ) {\r\n    let sum = 0;\r\n    let x = xin;\r\n    let y = yin;\r\n    let z = zin;\r\n    let scalar = 1;\r\n    for (let i = 0; i < octaveNum; i++) {\r\n      sum += this.simplex3(x, y, z) * scalar;\r\n      x *= 2;\r\n      y *= 2;\r\n      z *= 2;\r\n      scalar *= octaveFalloff;\r\n    }\r\n    return sum;\r\n  }\r\n\r\n  // ##### Perlin noise stuff\r\n\r\n  public fade(t: number) {\r\n    return t * t * t * (t * (t * 6 - 15) + 10);\r\n  }\r\n\r\n  public lerp(a: number, b: number, t: number) {\r\n    return (1 - t) * a + t * b;\r\n  }\r\n\r\n  // 2D Perlin Noise\r\n  public perlin2(x: number, y: number) {\r\n    // Find unit grid cell containing point\r\n    let X = Math.floor(x),\r\n      Y = Math.floor(y);\r\n    // Get relative xy coordinates of point within that cell\r\n    x = x - X;\r\n    y = y - Y;\r\n    // Wrap the integer cells at 255 (smaller integer period can be introduced here)\r\n    X = X & 255;\r\n    Y = Y & 255;\r\n\r\n    const { gradP, perm } = this;\r\n    // Calculate noise contributions from each of the four corners\r\n    let n00 = gradP[X + perm[Y]].dot2(x, y);\r\n    let n01 = gradP[X + perm[Y + 1]].dot2(x, y - 1);\r\n    let n10 = gradP[X + 1 + perm[Y]].dot2(x - 1, y);\r\n    let n11 = gradP[X + 1 + perm[Y + 1]].dot2(x - 1, y - 1);\r\n\r\n    // Compute the fade curve value for x\r\n    let u = this.fade(x);\r\n\r\n    // Interpolate the four results\r\n    return this.lerp(this.lerp(n00, n10, u), this.lerp(n01, n11, u), this.fade(y));\r\n  }\r\n\r\n  // 3D Perlin Noise\r\n  public perlin3(x: number, y: number, z: number) {\r\n    const { gradP, perm } = this;\r\n    // Find unit grid cell containing point\r\n    let X = Math.floor(x),\r\n      Y = Math.floor(y),\r\n      Z = Math.floor(z);\r\n    // Get relative xyz coordinates of point within that cell\r\n    x = x - X;\r\n    y = y - Y;\r\n    z = z - Z;\r\n    // Wrap the integer cells at 255 (smaller integer period can be introduced here)\r\n    X = X & 255;\r\n    Y = Y & 255;\r\n    Z = Z & 255;\r\n\r\n    // Calculate noise contributions from each of the eight corners\r\n    let n000 = gradP[X + perm[Y + perm[Z]]].dot3(x, y, z);\r\n    let n001 = gradP[X + perm[Y + perm[Z + 1]]].dot3(x, y, z - 1);\r\n    let n010 = gradP[X + perm[Y + 1 + perm[Z]]].dot3(x, y - 1, z);\r\n    let n011 = gradP[X + perm[Y + 1 + perm[Z + 1]]].dot3(x, y - 1, z - 1);\r\n    let n100 = gradP[X + 1 + perm[Y + perm[Z]]].dot3(x - 1, y, z);\r\n    let n101 = gradP[X + 1 + perm[Y + perm[Z + 1]]].dot3(x - 1, y, z - 1);\r\n    let n110 = gradP[X + 1 + perm[Y + 1 + perm[Z]]].dot3(x - 1, y - 1, z);\r\n    let n111 = gradP[X + 1 + perm[Y + 1 + perm[Z + 1]]].dot3(x - 1, y - 1, z - 1);\r\n\r\n    // Compute the fade curve value for x, y, z\r\n    let u = this.fade(x);\r\n    let v = this.fade(y);\r\n    let w = this.fade(z);\r\n\r\n    // Interpolate\r\n    return this.lerp(\r\n      this.lerp(this.lerp(n000, n100, u), this.lerp(n001, n101, u), w),\r\n      this.lerp(this.lerp(n010, n110, u), this.lerp(n011, n111, u), w),\r\n      v\r\n    );\r\n  }\r\n}\r\n","import { Inventory } from \"../inventory\";\r\nimport { Tile } from \"../tile/tile\";\r\nexport class DeadCell extends Tile {\r\n  displayName = \"Dead Cell\";\r\n\r\n  isObstacle = false;\r\n\r\n  inventory = new Inventory(0, this);\r\n\r\n  shouldStep(dt: number) {\r\n    return dt > 0.3;\r\n  }\r\n}\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneAttractsSugar = Gene.make(\r\n  {\r\n    name: \"Attracts Sugar\",\r\n    levelCosts: [1, 2, 3, 4, 5],\r\n    levelProps: {\r\n      secondsPerPull: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerPull }) => (\r\n      <>\r\n        Every <GN value={secondsPerPull} sigFigs={2} /> seconds, take 1 sugar from any neighboring Cell.\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    cooldown: 0,\r\n  },\r\n  (dt, { cell, state, props: { secondsPerPull } }) => {\r\n    const neighbors = cell.world.tileNeighbors(cell.pos);\r\n    if (state.cooldown <= 0) {\r\n      for (const [, tile] of neighbors) {\r\n        // pull water from nearby sources\r\n        if (tile instanceof Cell) {\r\n          const { water } = tile.inventory.give(cell.inventory, 0, 1);\r\n          if (water > 0) {\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      state.cooldown += secondsPerPull;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneAttractsSugar = typeof GeneAttractsSugar;\r\n","import { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneCannotFreeze = Gene.make(\r\n  {\r\n    name: \"Cannot Freeze\",\r\n    levelCosts: [7],\r\n    levelProps: {},\r\n    static: {\r\n      cantFreeze: true,\r\n    },\r\n    description: () => null,\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\n","import { buildComplete } from \"game/audio\";\r\nimport { randFloat } from \"math\";\r\nimport { Vector2 } from \"three\";\r\nimport { GeneLiving } from \"../../std/genes\";\r\nimport { GeneObstacle } from \"../../std/genes/GeneObstacle\";\r\nimport { World } from \"../world/world\";\r\nimport { Cell } from \"./cell\";\r\nimport Chromosome from \"./chromosome\";\r\nimport { CellType } from \"./genome\";\r\n\r\nconst chromosomeGrowingCell = new Chromosome(GeneLiving.level(2), GeneObstacle.level(0));\r\n\r\nexport class GrowingCell extends Cell {\r\n  public percentMatured = 0;\r\n\r\n  public timeToMaturity: number;\r\n\r\n  silent?: boolean;\r\n\r\n  constructor(pos: Vector2, world: World, public completedCell: Cell, public start: Vector2) {\r\n    super(pos, world, cellTypeGrowingCell);\r\n    this.timeToMaturity = completedCell.type.chromosome.mergeStaticProperties().timeToBuild;\r\n  }\r\n\r\n  step(dt: number) {\r\n    super.step(dt);\r\n    this.percentMatured += (this.tempo * dt) / this.timeToMaturity;\r\n    this.completedCell.pos.copy(this.pos);\r\n    if (this.percentMatured >= 1) {\r\n      this.world.maybeRemoveCellAt(this.pos);\r\n      this.completedCell.energy = this.energy;\r\n      for (const effect of this.effects) {\r\n        this.completedCell.addEffect(effect);\r\n      }\r\n      this.world.setTileAt(this.pos, this.completedCell);\r\n      if (!this.silent) {\r\n        const id = buildComplete.play();\r\n        buildComplete.rate(id, randFloat(0.5, 1));\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nconst cellTypeGrowingCell = new CellType(\"Growing Cell\", 0, chromosomeGrowingCell);\r\n","import { Inventory } from \"../inventory\";\r\nimport { Tile } from \"./tile\";\r\nexport class Rock extends Tile {\r\n  displayName = \"Rock\";\r\n\r\n  isObstacle = true;\r\n\r\n  inventory = new Inventory(0, this);\r\n\r\n  get darknessContrib() {\r\n    return 1;\r\n  }\r\n\r\n  shouldStep(dt: number) {\r\n    return dt > 0.3;\r\n  }\r\n}\r\n","import { Steppable } from \"../entity\";\r\nimport { Cell } from \"../tile\";\r\nimport { Gene, RealizedProps } from \"./gene\";\r\n\r\ntype GeneState<G extends Gene> = G extends Gene<infer S, any> ? S : never;\r\n\r\ntype GenePropNames<G extends Gene> = G extends Gene<any, infer K> ? K : never;\r\n\r\nexport class GeneInstance<G extends Gene, S = GeneState<G>, K extends string = GenePropNames<G>> implements Steppable {\r\n  public dtSinceLastStepped = 0;\r\n\r\n  public state: S;\r\n\r\n  public get blueprint() {\r\n    return this.gene.blueprint;\r\n  }\r\n\r\n  constructor(public gene: G, public props: RealizedProps<K>, public cell: Cell) {\r\n    this.state = gene.initialStateFn(gene, props, cell);\r\n  }\r\n\r\n  public isType<S, K extends string>(gene: Gene<S, K>): this is GeneInstance<Gene<S, K>> {\r\n    return this.gene === gene;\r\n  }\r\n\r\n  shouldStep(dt: number): boolean {\r\n    return this.gene.shouldStepFn(dt, this);\r\n  }\r\n\r\n  step(dt: number) {\r\n    const maybeNewState = this.gene.stepFn(dt, this);\r\n    if (maybeNewState !== undefined) {\r\n      this.state = maybeNewState;\r\n    }\r\n  }\r\n\r\n  earnMP(cell: Cell, mpEarned: number) {\r\n    cell.world.earnMP(cell, mpEarned);\r\n  }\r\n}\r\n","import { Interactable } from \"core/interactable\";\r\nimport { Action } from \"core/player/action\";\r\nimport { Vector2 } from \"three\";\r\nimport { Noise } from \"../../common/perlin\";\r\nimport { map } from \"../../math/index\";\r\nimport { Inventory } from \"../inventory\";\r\nimport { World } from \"../world/world\";\r\nimport { canPullResources } from \"./canPullResources\";\r\nimport { Tile } from \"./tile\";\r\nexport class Air extends Tile implements Interactable {\r\n  displayName = \"Air\";\r\n\r\n  static fallAmount = 30;\r\n\r\n  static diffusionWater = 1.5;\r\n\r\n  public sunlightCached: number = 1;\r\n\r\n  public _co2: number;\r\n\r\n  public inventory = new Inventory(6, this);\r\n\r\n  isObstacle = false;\r\n\r\n  public constructor(public pos: Vector2, world: World) {\r\n    super(pos, world);\r\n    this.darkness = 0;\r\n    this._co2 = this.computeCo2();\r\n  }\r\n\r\n  interact(): Action {\r\n    return {\r\n      type: \"pickup\",\r\n      water: 0.1,\r\n      sugar: 0.1,\r\n      target: this,\r\n      continuous: true,\r\n    };\r\n  }\r\n\r\n  // Careful - this affects gravity speed\r\n  shouldStep(dt: number) {\r\n    // if (!this.inventory.isEmpty()) {\r\n    return dt > 0.06667;\r\n    // } else {\r\n    //   return super.shouldStep(dt);\r\n    // }\r\n  }\r\n\r\n  private computeCo2() {\r\n    const base = map(this.pos.y, this.world.height / 2, 0, this.world.environment.floorCo2, 1.15);\r\n    const scaleX = Math.max(1, map(this.pos.y, this.world.height / 2, 0, 4, 9));\r\n    // const offset = noiseCo2.perlin3(94.2321 - this.pos.x / scaleX, 3221 - this.pos.y / 2.5, world.time / 5 + 93.1) * 0.2;\r\n    const time = this.world == null ? 0 : this.world.time;\r\n    const offset =\r\n      noiseCo2.perlin3(\r\n        94.231 + (this.pos.x - this.world.width / 2) / scaleX,\r\n        2312 + this.pos.y / 8,\r\n        time / 1000 + 93.1\r\n      ) * 0.25;\r\n    return Math.max(Math.min(base + offset, 1), Math.min(0.4, this.world.environment.floorCo2 * 0.75));\r\n  }\r\n\r\n  public lightAmount() {\r\n    return this.sunlight();\r\n  }\r\n\r\n  step(dt: number) {\r\n    // we do NOT call super, to avoid stepping darkness and diffusion.\r\n    this.stepGravity(dt);\r\n    const tileBelow = this.world.tileAt(this.pos.x, this.pos.y + 1);\r\n    if (!(tileBelow instanceof Air)) {\r\n      this.stepDiffusionCheap(dt);\r\n    }\r\n    this.stepEvaporation(dt);\r\n    this.stepTemperature(dt);\r\n    this._co2 = this.computeCo2();\r\n  }\r\n\r\n  stepDiffusionCheap(dt: number) {\r\n    // only take water from left and right\r\n    const left = this.world.tileAt(this.pos.x - 1, this.pos.y);\r\n    const right = this.world.tileAt(this.pos.x + 1, this.pos.y);\r\n    // randomize order to remove directional bias\r\n    if (Math.random() < 0.5) {\r\n      this.tryDiffuse(left, dt);\r\n      this.tryDiffuse(right, dt);\r\n    } else {\r\n      this.tryDiffuse(right, dt);\r\n      this.tryDiffuse(left, dt);\r\n    }\r\n  }\r\n\r\n  tryDiffuse(t: Tile | null, dt: number) {\r\n    if (t != null && canPullResources(this, t)) {\r\n      if (t.inventory.water < this.inventory.water) {\r\n        t.diffuseWater(this, dt);\r\n        // this.diffuseWater(t, dt);\r\n      }\r\n    }\r\n  }\r\n\r\n  stepEvaporation(dt: number) {\r\n    if (Math.random() < this.world.environment.airEvaporation * this.inventory.water * dt) {\r\n      this.world.numEvaporatedAir += 1;\r\n      this.inventory.add(-1, 0);\r\n      this.world.logEvent({ type: \"evaporation\", tile: this });\r\n    }\r\n  }\r\n\r\n  public co2() {\r\n    return this._co2;\r\n  }\r\n\r\n  public sunlight() {\r\n    return this.sunlightCached;\r\n  }\r\n}\r\nconst noiseCo2 = new Noise();\r\n","import { createSimpleSchema, object } from \"serializr\";\r\nimport { Color, Vector2 } from \"three\";\r\n\r\nexport interface MaterialInfo {\r\n  /**\r\n   * If unspecified, means white but respect transparency\r\n   */\r\n  color?: Color;\r\n\r\n  texturePosition: Vector2;\r\n}\r\n\r\nexport const MaterialInfoSchema = createSimpleSchema({\r\n  color: object(Color),\r\n  texturePosition: object(Vector2),\r\n});\r\n","import { Action } from \"./player/action\";\r\nimport { Player } from \"./player/player\";\r\n\r\n/**\r\n * This thing can be interacted with by the player.\r\n */\r\nexport interface Interactable {\r\n  /**\r\n   * What action, if any, the player should take when\r\n   * interacted on by the player.\r\n   */\r\n  interact(source: Player): Action | undefined;\r\n}\r\n\r\nexport function isInteractable<T>(e: T): e is Interactable & T {\r\n  return typeof (e as any).interact === \"function\";\r\n}\r\n","export default function devlog(message?: any, ...optionalParams: any[]) {\r\n  if (process.env.NODE_ENV === \"development\") {\r\n    console.log(message, ...optionalParams);\r\n  }\r\n}\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneAttractsWater = Gene.make(\r\n  {\r\n    name: \"Attracts Water\",\r\n    levelCosts: [1, 2, 3, 4, 5],\r\n    levelProps: {\r\n      secondsPerPull: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerPull }) => (\r\n      <>\r\n        Every <GN value={secondsPerPull} sigFigs={2} /> seconds, take 1 Water from any neighboring Cell.\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    cooldown: 0,\r\n  },\r\n  (dt, { cell, state, props: { secondsPerPull } }) => {\r\n    const neighbors = cell.world.tileNeighbors(cell.pos);\r\n    if (state.cooldown <= 0) {\r\n      for (const [, tile] of neighbors) {\r\n        // pull water from nearby sources\r\n        if (tile instanceof Cell) {\r\n          // tile.inventory.give(cell.inventory, randRound(LEAF_WATER_INTAKE_PER_SECOND * dt), 0);\r\n          const { water } = tile.inventory.give(cell.inventory, 1, 0);\r\n          if (water > 0) {\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      state.cooldown += secondsPerPull;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneAttractsWater = typeof GeneAttractsWater;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneEnergyTransfer = Gene.make(\r\n  {\r\n    name: \"Energy Transfer\",\r\n    levelCosts: [1, 3, 4, 5, 7],\r\n    levelProps: {\r\n      differenceThreshold: [0.08, 0.04, 0.02, 0.01, 0.005],\r\n    },\r\n    description: ({ differenceThreshold }) => (\r\n      <>\r\n        <p>\r\n          Give energy to neighboring Cells until they're within <GN value={differenceThreshold * 100} sigFigs={3} />%\r\n          energy difference of this Cell.\r\n        </p>\r\n        <p>Gives up to {ENERGY_GIVE_RATE * 100}% energy per second.</p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  (dt, { cell, props: { differenceThreshold } }) => {\r\n    const tileNeighbors = cell.world.tileNeighbors(cell.pos);\r\n    for (const [, neighbor] of tileNeighbors) {\r\n      if (neighbor.pos.manhattanDistanceTo(cell.pos) > 1 || !(neighbor instanceof Cell)) continue;\r\n      maybeGiveEnergy(dt, cell, neighbor, differenceThreshold);\r\n    }\r\n  }\r\n);\r\n\r\nconst ENERGY_GIVE_RATE = 0.25;\r\n\r\nfunction maybeGiveEnergy(dt: number, cell: Cell, neighbor: Cell, differenceThreshold: number) {\r\n  const difference = cell.energy - neighbor.energy;\r\n  if (difference > differenceThreshold) {\r\n    const energyToGive = Math.min(difference - differenceThreshold, ENERGY_GIVE_RATE * dt);\r\n    // safe method but lower upper bound on equalization rate\r\n    // energyTransfer = Math.floor((neighbor.energy - this.energy) / energeticNeighbors.length);\r\n\r\n    // this may be unstable w/o double buffering\r\n    cell.energy -= energyToGive;\r\n    neighbor.energy += energyToGive;\r\n    cell.world.logEvent({ type: \"cell-transfer-energy\", from: cell, to: neighbor, amount: energyToGive });\r\n  }\r\n}\r\n\r\nexport type GeneEnergyTransfer = typeof GeneEnergyTransfer;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nexport const GeneInventory = Gene.make(\r\n  {\r\n    name: \"Inventory\",\r\n    levelCosts: [1, 2, 3, 4, 5],\r\n    levelProps: {},\r\n    static: {\r\n      inventoryCapacity: [2, 3, 5, 8, 11],\r\n    },\r\n    description: (_, { inventoryCapacity }) => (\r\n      <>\r\n        Capacity <GN value={inventoryCapacity!} />.\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneInventory = typeof GeneInventory;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nexport const GeneLiving = Gene.make(\r\n  {\r\n    name: \"Living\",\r\n    levelCosts: [-6, -8, -10, -12, -15],\r\n    levelProps: {\r\n      secondsPerUpkeep: [720, 600, 480, 240, 120],\r\n    },\r\n    description: ({ secondsPerUpkeep }) => (\r\n      <>\r\n        Burns 100% energy every <GN value={secondsPerUpkeep} /> seconds.\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  (dt, { cell, props: { secondsPerUpkeep } }) => {\r\n    cell.energy -= (1 / secondsPerUpkeep) * dt;\r\n  }\r\n);\r\nexport type GeneLiving = typeof GeneLiving;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneMetabolism = Gene.make(\r\n  {\r\n    name: \"Metabolism\",\r\n    levelCosts: [0, 1, 3, 6, 10],\r\n    levelProps: {\r\n      energyPerSugar: [0.25, 0.5, 1, 1.5, 2],\r\n    },\r\n    description: ({ energyPerSugar }) => (\r\n      <>\r\n        <p>\r\n          Convert 1 Sugar into <GN value={energyPerSugar * 100} sigFigs={3} />% energy.\r\n        </p>\r\n        <p>Starts below 95% energy. Restores {EAT_ENERGY_PER_SECOND * 100}% energy per second.</p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  (dt, { cell, props: { energyPerSugar } }) => {\r\n    let maxEnergyToEat = getMaxEnergyToEat(cell, dt);\r\n    // eat from self\r\n    if (maxEnergyToEat > 0) {\r\n      // if this number goes up, we become less energy efficient\r\n      // if this number goes down, we are more energy efficient\r\n      maxEnergyToEat -= stepEatSugar(cell, maxEnergyToEat, energyPerSugar);\r\n    }\r\n  }\r\n);\r\nexport type GeneMetabolism = typeof GeneMetabolism;\r\n\r\nconst EAT_ENERGY_PER_SECOND = 0.25;\r\n\r\nfunction getMaxEnergyToEat(cell: Cell, dt: number) {\r\n  const hunger = 1 - cell.energy;\r\n  if (hunger < 0.05) {\r\n    return 0;\r\n  }\r\n  return Math.min(hunger, EAT_ENERGY_PER_SECOND * dt);\r\n}\r\n\r\nfunction stepEatSugar(cell: Cell, maxEnergyToEat: number, energyPerSugar: number): number {\r\n  const sugarToEat = Math.min(maxEnergyToEat / energyPerSugar, cell.inventory.sugar);\r\n  // eat if we're hungry\r\n  if (sugarToEat > 0) {\r\n    cell.inventory.add(0, -sugarToEat);\r\n    const gotEnergy = sugarToEat * energyPerSugar;\r\n    cell.energy += gotEnergy;\r\n    if (gotEnergy > 0) {\r\n      cell.world.logEvent({ type: \"cell-eat\", who: cell });\r\n    }\r\n    return gotEnergy;\r\n  }\r\n  return 0;\r\n}\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Vector2 } from \"three\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\nimport { Soil } from \"../../core/tile/soil\";\r\n\r\nexport interface SoilAbsorptionState {\r\n  cooldown: number;\r\n  totalSucked: number;\r\n  activeNeighbors: Vector2[];\r\n}\r\n\r\nexport const GeneSoilAbsorption = Gene.make<SoilAbsorptionState>(\r\n  {\r\n    name: \"Soil Absorption\",\r\n    levelCosts: [4, 6, 8, 10, 12],\r\n    levelProps: {\r\n      secondsPerAbsorb: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerAbsorb }) => (\r\n      <>\r\n        Absorb 1 water every <GN value={secondsPerAbsorb} /> seconds from neighboring Soil.\r\n      </>\r\n    ),\r\n  },\r\n  { cooldown: 0, totalSucked: 0, activeNeighbors: [] },\r\n  (dt, { cell, state, props: { secondsPerAbsorb } }) => {\r\n    if (state.cooldown <= 0) {\r\n      state.activeNeighbors = [];\r\n      state.totalSucked += absorbWater(state.activeNeighbors, cell);\r\n      state.cooldown += secondsPerAbsorb;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GeneSoilAbsorption = typeof GeneSoilAbsorption;\r\n\r\nfunction absorbWater(activeNeighbors: Vector2[], cell: Cell) {\r\n  const neighbors = cell.world.tileNeighbors(cell.pos);\r\n  let doneOnce = false;\r\n  let totalSucked = 0;\r\n  for (const [dir, tile] of neighbors) {\r\n    if (tile instanceof Soil) {\r\n      activeNeighbors.push(dir);\r\n      if (!doneOnce) {\r\n        const { water } = tile.inventory.give(cell.inventory, 1, 0);\r\n        totalSucked += water;\r\n        if (water > 0) {\r\n          doneOnce = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return totalSucked;\r\n}\r\n","import { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n/**\r\n * Vascular cells will connect to other neighboring Vascular cells.\r\n * Water in a Vascular cell will do two things:\r\n * a) Adhesion - Water will be pulled into this Cell.\r\n * b) Cohesion - Water will move to be near other Water.\r\n */\r\nexport const GeneVascular = Gene.make(\r\n  {\r\n    name: \"Vascular\",\r\n    levelCosts: [1, 2, 3, 5, 8],\r\n    levelProps: {\r\n      diffusionRate: [0.01, 0.05, 0.1, 0.2, 0.4],\r\n    },\r\n    description: ({ diffusionRate }) => `Diffuses water to other Vascular cells with rate ${diffusionRate}.`,\r\n  },\r\n  {},\r\n  (dt, { cell, props: { diffusionRate } }) => {\r\n    const neighbors = Array.from(cell.world.tileNeighbors(cell.pos).values());\r\n    const vascularNeighbors = neighbors.filter((t) => t instanceof Cell && t.chromosome.has(GeneVascular));\r\n    for (const n of vascularNeighbors) {\r\n      cell.diffuseWater(n, dt, diffusionRate);\r\n    }\r\n  }\r\n);\r\nexport type GeneVascular = typeof GeneVascular;\r\n","module.exports = __webpack_public_path__ + \"static/media/Blop-Mark_DiAngelo-79054334.627c0e8b.mp3\";","module.exports = __webpack_public_path__ + \"static/media/build.0e2001c4.mp3\";","module.exports = __webpack_public_path__ + \"static/media/build_complete.9af6ac71.mp3\";","module.exports = __webpack_public_path__ + \"static/media/deconstruct.e5356177.mp3\";","module.exports = __webpack_public_path__ + \"static/media/drop_water.7ab1e6f0.mp3\";","module.exports = __webpack_public_path__ + \"static/media/eating.e78fa644.mp3\";","module.exports = __webpack_public_path__ + \"static/media/footsteps.636605b0.wav\";","module.exports = __webpack_public_path__ + \"static/media/fruit-popOpen.5991698f.mp3\";","module.exports = __webpack_public_path__ + \"static/media/impactSoft_medium_003.b8698323.mp3\";","module.exports = __webpack_public_path__ + \"static/media/interact.848e9d20.mp3\";","module.exports = __webpack_public_path__ + \"static/media/intro-bounce.6e8ea313.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-base.28ee2cbb.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-drums.1c82b4f4.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-overworld.62281b29.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-start.473c2a0e.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mito-strings.9f30639c.mp3\";","module.exports = __webpack_public_path__ + \"static/media/mitodeath.207c4872.mp3\";","module.exports = __webpack_public_path__ + \"static/media/sticky.6d27b20f.mp3\";","module.exports = __webpack_public_path__ + \"static/media/suckwater.b0fe81fa.wav\";","module.exports = __webpack_public_path__ + \"static/media/whoosh.fde62e78.mp3\";","module.exports = __webpack_public_path__ + \"static/media/fruit.e136487f.png\";","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAQCAYAAADJViUEAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAAsTAAALEwEAmpwYAAACC2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOlJlc29sdXRpb25Vbml0PjI8L3RpZmY6UmVzb2x1dGlvblVuaXQ+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgICAgIDx0aWZmOlBob3RvbWV0cmljSW50ZXJwcmV0YXRpb24+MjwvdGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KD0UqkwAAAM1JREFUKBVjYBgowIjL4v50+/8wucKZB7GqwxCEadJSkYfpZbh25yGYjW4IimaQRpimSbL8cM15jz+C2SBDkA1ggqtAYiBrBAmj82FK4TbDbF2qowSWe/vxLUwNgzC/MJgdfeUe2Asw27HajKwRpAudDzMVq2aYJCGaepr5JSH+hfkRZjOMD5OHicMDDCSAHmgwRSAaPbBAYhjOBpmehQhokBowH91WkDiKzSABWAqztHUEccHg+OH9YBoWRVBhTM0wCZghID66JpgaimgAWfxCZhIsrg0AAAAASUVORK5CYII=\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAsCAYAAABloJjNAAAFJklEQVRIS62We2xTVRzHv+e2ty0bfa223VMjMEjWTXyuBmOIsCiYIGCMRpYoiSYIGjSOmGE0gCSogcnDR0biwIQoCmqmLg4msP2xBLYYQmCj4GOKjLmue/Tlut3b3mPOvbT3di2tiTt/9fZ3ft/+fp/z7e9cgv+wpt4nFD7A9Bkl+bbn3SDshqriA/hDyJmTX7B7JSVn25XCZkOQ6YjdKyla2sEfzl0d25u1Qi0zzyflFJJKrv+VQZKLaYaguBs0le4DFteUQppWFS9wfujIzS1ZEKQEaa+5k9RGHhG7V1CcPZFiVrOoBPuqpuTn1/qNuPDQ3dCdU+PskJK5GS2roiqzo2230R19elnw7YUC6p8cJ2L34xQtP8pMtWJZGXZ13kFPBubKAkvMUTQOJABJpfBBtQFdgQI5XmcLYfmjg2nYMhhuPeaha0qikKZFtEcd+PqPsTSGa+c58ExFFJFoHB3RIuxceym7IO2x9BFvuJoJPuscg5MXcWCoGK3XxnG4JiZXtP6CCUxwc+kwAiKPowEH3n26nyRzszC0fH8maFl1KmiFw12IZYnr6IuK2HVZYbi1UkCN3Yjjo0WwOubgvrgfdfbQD6Q2/ETSGWnl0nPmhq5J+56OUbMcX2oN45fYNJqv8fLzhnIB1UWFOBUoTDFcZgltIQ9GmjIEaY/lC+INr2MtP1UcAp+I45uwC8cHRrFrnmKbRp9Bbnl9RRDBSYq2sENmmMxNa5n2WPzEG3YzwRfcAbh5EbsGS9F6fQKt90zKgqt7FYZvlg/BL/Jo8TuTDOXcTIY9ls9PBy3rToessDsLsFS6AV9UwHs+heEbCwR47Ca0jtlhsZvwgOTHcluYdVafnWGPZVtX1La9Y0xhyHx2ZVLAx38qgi9XCPAUFSLp0+XWEBPcTrzhHdkYniLecJ1sG/cECiHiSKgEx34fxUcLFdtsumSUW95YMYbxGPBt2Il31sgM5dyZDIeJN1zMBF90j8AlMyzDsZ9HcGKFiFW9JllUYXgDIyKPT/2uJEM5NwtDc/OZkHUD86G1yISH8TcuRwQ0XVVaZqvlfg5t43bMtRpRiwDqbMGDxBt5KTvDXuuezoi14aebDB+zhXA1No39A4oPN98u4AYpQTyujDPGeJkt0kRqQ1syGfZaL5La0F2s5eddo7Dp4zg4UY6vfgvgiEexTf15xTY6HYd6xwi+DLmxY/VFQm/mZrTMvmCCz7lGYdfHsX+oGMfPj0Bv06VaZoKvlg7LMbbYfzkVzHYFnO4op4yh2WbEEoxgU7+UNm2a79XjZNCKArMBkxEhtyDtMTdX91o2SII6/xoqRTT9qjB8/U4Be/8ygiY0t0TD0C3Hl3z0VftKqTSl3iGckcN3ixWGzDqE50BFNX6lcTh3y/MbnZTXMItHJOjNXApTYlKCrkB9ziuYrULtrZe3Qs+HZTQtwcCBCmpLMwWInoDGVYaEI6CaO4dU7S+jUiyRaokzcZjJMFeFGT8wv9FFeZvKJIPZPxJ0hWpcilFwc9RzYI7gDOrz7FfoOVCWZhNi5EA1rx7EQEA1viQ8ARVVhtARQOPL2a9wwVsuqp+r9RmFrkBlkohR6LTMpik4oxpn1bKqU9Nm1k+5ijHU2saogzStsZGBg5TLlzqS9t+efYaV29w0jdEUBWe6tc+oCBBl+MiLxgGi3hCY/Qq105Z9rm6uoJqXYuUtXGO7mfv7Nl7PPb6q9mbOw5zTZmueebhoZzHVMpnJiCYAol4xuJJP8P9W+C+xZd+qpRkU/AAAAABJRU5ErkJggg==\"","module.exports = \"data:image/png;base64,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\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wwdEQIkKFbu2wAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAA0UlEQVRYw2NgGAUjHTCSovjYTIb/xKizSifeXKZBGQK4fGppwEeUoccvfCI6ZAZXCMB8TqxPSQWwkEEOicERAkT7XL4Glf+wheKQGPAQYCFJNZk+HtTlAAtFcY1D3cePqOUAPz/fUAsBYuMahzp8Ph7aJSEpcTtkSkK85QDMxzCfEutjdH1Dtz1AbK1IyMfY4n7whMCzW/txSj7Y7/ifGi0ifG3EwR0CDAwMDFJqjvRrFX/+8GpgywFeATGq+WzI1AVMuIKdXtHBhCvYCUUHtQAAj7ZTZKkXht4AAAAASUVORK5CYII=\"","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wwdECsv+gDCjwAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAR0lEQVRYw2P8//8/w0ACJoYBBqMOYEEXkBY9TNNE8fS1LeNoFIw6YNQBow4YdcCoA0YdMOqAUQeMOmDUAYPKAYyjfcMR7wAAvzUKOwLggbEAAAAASUVORK5CYII=\"","var map = {\n\t\"./GeneAttractsSugar.tsx\": 67,\n\t\"./GeneAttractsWater.tsx\": 84,\n\t\"./GeneCannotFreeze.tsx\": 68,\n\t\"./GeneDiffuseSugar.tsx\": 203,\n\t\"./GeneDiffuseWater.tsx\": 204,\n\t\"./GeneDirectionalPush.tsx\": 59,\n\t\"./GeneEnergyTransfer.tsx\": 85,\n\t\"./GeneInventory.tsx\": 86,\n\t\"./GeneLiving.tsx\": 87,\n\t\"./GeneMetabolism.tsx\": 88,\n\t\"./GeneObstacle.tsx\": 47,\n\t\"./GenePhotosynthesis.tsx\": 45,\n\t\"./GenePushWater.tsx\": 205,\n\t\"./GeneReproducer.tsx\": 30,\n\t\"./GeneSoilAbsorption.tsx\": 89,\n\t\"./GeneVascular.tsx\": 90\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 202;","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneDiffuseSugar = Gene.make(\r\n  {\r\n    name: \"Diffuse Sugar\",\r\n    levelCosts: [0, 1, 2, 3, 5],\r\n    static: {\r\n      diffusionSugar: [0.01, 0.02, 0.04, 0.08, 0.16],\r\n    },\r\n    levelProps: {},\r\n    description: (props, { diffusionSugar }) => (\r\n      <>\r\n        <p>Give sugar to neighboring Cells with less.</p>\r\n        <p>\r\n          On average, give 1 sugar every <GN value={1 / diffusionSugar!} sigFigs={3} /> seconds.\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneDiffuseSugar = typeof GeneDiffuseSugar;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GeneDiffuseWater = Gene.make(\r\n  {\r\n    name: \"Diffuse Water\",\r\n    levelCosts: [0, 1, 2, 3, 5],\r\n    static: {\r\n      diffusionWater: [0.01, 0.02, 0.04, 0.08, 0.16],\r\n    },\r\n    levelProps: {},\r\n    description: (props, { diffusionWater }) => (\r\n      <>\r\n        <p>Give water to neighboring Cells with less.</p>\r\n        <p>\r\n          On average, give 1 water every <GN value={1 / diffusionWater!} sigFigs={3} /> seconds.\r\n        </p>\r\n      </>\r\n    ),\r\n  },\r\n  {},\r\n  () => {}\r\n);\r\nexport type GeneDiffuseWater = typeof GeneDiffuseWater;\r\n","import React from \"react\";\r\nimport GN from \"std/genes/GN\";\r\nimport { Cell } from \"../../core/cell/cell\";\r\nimport { Gene } from \"../../core/cell/gene\";\r\n\r\nexport const GenePushWater = Gene.make(\r\n  {\r\n    name: \"Push Water\",\r\n    levelCosts: [1, 2, 3, 4, 5],\r\n    levelProps: {\r\n      secondsPerPull: [20, 10, 5, 3, 2],\r\n    },\r\n    description: ({ secondsPerPull }) => (\r\n      <>\r\n        Every <GN value={secondsPerPull} sigFigs={2} /> seconds, push 1 water from this Cell to each neighboring Cell.\r\n      </>\r\n    ),\r\n  },\r\n  {\r\n    cooldown: 0,\r\n  },\r\n  (dt, { cell, state, props: { secondsPerPull } }) => {\r\n    const neighbors = cell.world.tileNeighbors(cell.pos);\r\n    if (state.cooldown <= 0) {\r\n      for (const [, tile] of neighbors) {\r\n        // push water to nearby sources\r\n        if (tile instanceof Cell) {\r\n          // tile.inventory.give(cell.inventory, randRound(LEAF_WATER_INTAKE_PER_SECOND * dt), 0);\r\n          cell.inventory.give(tile.inventory, 1, 0);\r\n          // if (water > 0) {\r\n          //   break;\r\n          // }\r\n        }\r\n      }\r\n      state.cooldown += secondsPerPull;\r\n    }\r\n    state.cooldown -= dt;\r\n  }\r\n);\r\nexport type GenePushWater = typeof GenePushWater;\r\n","import { Color, Vector2 } from \"three\";\r\nimport Chromosome from \"../../core/cell/chromosome\";\r\nimport Genome, { CellType } from \"../../core/cell/genome\";\r\nimport {\r\n  GeneAttractsWater,\r\n  GeneEnergyTransfer,\r\n  GeneInventory,\r\n  GeneLiving,\r\n  GeneMetabolism,\r\n  GeneSoilAbsorption,\r\n} from \"../genes\";\r\nimport { GeneAttractsSugar } from \"../genes/GeneAttractsSugar\";\r\nimport { GeneCannotFreeze } from \"../genes/GeneCannotFreeze\";\r\nimport { GeneDirectionalPush } from \"../genes/GeneDirectionalPush\";\r\nimport { GeneObstacle } from \"../genes/GeneObstacle\";\r\nimport { GenePhotosynthesis } from \"../genes/GenePhotosynthesis\";\r\nimport { GeneFruit } from \"../genes/GeneReproducer\";\r\n\r\nconst cellTypeTissue = new CellType(\r\n  \"Tissue\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneInventory.level(3), GeneMetabolism.level(2), GeneEnergyTransfer.level(1)),\r\n  {\r\n    texturePosition: new Vector2(1, 1),\r\n    color: new Color(0x30ae25),\r\n  },\r\n  {\r\n    type: \"take\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeLeaf = new CellType(\r\n  \"Leaf\",\r\n  0,\r\n  new Chromosome(\r\n    GeneLiving.level(2),\r\n    GeneInventory.level(3),\r\n    GeneObstacle.level(0),\r\n    GenePhotosynthesis.level(1),\r\n    GeneAttractsWater.level(3)\r\n  ),\r\n  {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(2, 1),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"water take sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeRoot = new CellType(\r\n  \"Root\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneInventory.level(4), GeneObstacle.level(0), GeneSoilAbsorption.level(2)),\r\n  {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(3, 1),\r\n  },\r\n  {\r\n    type: \"take\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeTransport = new CellType(\r\n  \"Transport\",\r\n  0,\r\n  new Chromosome(\r\n    GeneLiving.level(3),\r\n    GeneInventory.level(3),\r\n    GeneDirectionalPush.level(2),\r\n    GeneEnergyTransfer.level(2)\r\n  ),\r\n  {\r\n    texturePosition: new Vector2(1, 1),\r\n    color: new Color(0x30ae25),\r\n  },\r\n  {\r\n    type: \"take\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeFruit = new CellType(\r\n  \"Fruit\",\r\n  0,\r\n  new Chromosome(\r\n    GeneLiving.level(2),\r\n    GeneInventory.level(0),\r\n    GeneObstacle.level(0),\r\n    GeneCannotFreeze.level(0),\r\n    GeneFruit.level(0),\r\n    GeneAttractsSugar.level(1),\r\n    GeneAttractsWater.level(1)\r\n  ),\r\n  {\r\n    texturePosition: new Vector2(0, 2),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nexport const standardGenome = new Genome([\r\n  cellTypeTissue,\r\n  cellTypeLeaf,\r\n  cellTypeRoot,\r\n  cellTypeTransport,\r\n  cellTypeFruit,\r\n]);\r\n","export function sleep(millis: number) {\r\n  return new Promise((r) => {\r\n    setTimeout(r, millis);\r\n  });\r\n}\r\n","import { sleep } from \"common/promise\";\r\nimport { EventEmitter } from \"events\";\r\nimport { Vector2 } from \"three\";\r\nimport { CellArgs } from \"../cell/cell\";\r\nimport { CellType } from \"../cell/genome\";\r\nimport {\r\n  PLAYER_BASE_SPEED,\r\n  PLAYER_INTERACT_EXCHANGE_SPEED,\r\n  PLAYER_MAX_RESOURCES,\r\n  PLAYER_STARTING_SUGAR,\r\n  PLAYER_STARTING_WATER,\r\n} from \"../constants\";\r\nimport { Steppable } from \"../entity\";\r\nimport { Inventory } from \"../inventory\";\r\nimport { Air, Cell, FreezeEffect, GrowingCell, Tile } from \"../tile\";\r\nimport { World } from \"../world/world\";\r\nimport {\r\n  Action,\r\n  ActionBuild,\r\n  ActionDeconstruct,\r\n  ActionDrop,\r\n  ActionLong,\r\n  ActionMove,\r\n  ActionMultiple,\r\n  ActionPickup,\r\n  ActionThaw,\r\n} from \"./action\";\r\n\r\nconst waterCost = 1;\r\nconst sugarCost = 1;\r\n\r\nexport class Player implements Steppable {\r\n  public inventory = new Inventory(PLAYER_MAX_RESOURCES, this, PLAYER_STARTING_WATER, PLAYER_STARTING_SUGAR);\r\n\r\n  private action?: Action;\r\n\r\n  private events = new EventEmitter();\r\n\r\n  public baseSpeed: number;\r\n\r\n  public dtSinceLastStepped = 0;\r\n\r\n  public get speed() {\r\n    const t = this.currentTile();\r\n    return this.baseSpeed * (t instanceof Cell ? t.getMovespeedMultiplier() : 1);\r\n  }\r\n\r\n  get pos() {\r\n    return this.posFloat.clone().round();\r\n  }\r\n\r\n  public constructor(public posFloat: Vector2, public world: World) {\r\n    this.baseSpeed = PLAYER_BASE_SPEED;\r\n  }\r\n\r\n  shouldStep() {\r\n    return true;\r\n  }\r\n\r\n  public setAction(action: Action) {\r\n    if (this.action != null) {\r\n      if (this.action.type === \"long\") {\r\n        // don't allow anything to happen during long actions.\r\n        return;\r\n      } else {\r\n        this.action = {\r\n          type: \"multiple\",\r\n          actions: [this.action, action],\r\n        };\r\n      }\r\n    } else {\r\n      if (action.type === \"build\" && action.cellType.chromosome.mergeStaticProperties().isReproductive) {\r\n        this.action = {\r\n          type: \"long\",\r\n          duration: 4.5,\r\n          effect: action,\r\n          elapsed: 0,\r\n        };\r\n      } else {\r\n        this.action = action;\r\n      }\r\n    }\r\n  }\r\n\r\n  public getAction() {\r\n    return this.action;\r\n  }\r\n\r\n  public droopY() {\r\n    const tile = this.world.tileAt(this.pos.x, this.pos.y);\r\n    if (tile instanceof Cell) {\r\n      return tile.droopY;\r\n    } else {\r\n      return 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get this player's position taking into\r\n   * account the droop of the cell it's on.\r\n   */\r\n  public droopPosFloat() {\r\n    const droopY = this.droopY();\r\n    if (droopY !== 0) {\r\n      const t = this.posFloat.clone();\r\n      t.y += droopY;\r\n      return t;\r\n    }\r\n    return this.posFloat;\r\n  }\r\n\r\n  public currentTile() {\r\n    return this.world.tileAt(this.pos)!;\r\n  }\r\n\r\n  public findNearestWalkableCell() {\r\n    for (const tile of this.world.bfsIterator(this.pos, this.world.width * this.world.height)) {\r\n      if (this.isWalkable(tile)) {\r\n        return tile;\r\n      }\r\n    }\r\n  }\r\n\r\n  getBuildError(): \"water\" | \"sugar\" | \"water and sugar\" | undefined {\r\n    const needWater = this.inventory.water < waterCost;\r\n    const needSugar = this.inventory.sugar < sugarCost;\r\n\r\n    if (needWater && needSugar) {\r\n      return \"water and sugar\";\r\n    } else if (needWater && !needSugar) {\r\n      return \"water\";\r\n    } else if (needSugar && !needWater) {\r\n      return \"sugar\";\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  public on(event: \"action\", cb: (action: Action) => void): void;\r\n\r\n  public on(event: \"action-fail\", cb: (action: Action) => void): void;\r\n\r\n  public on(event: \"start-long-action\", cb: (action: ActionLong) => void): void;\r\n\r\n  public on(event: string, cb: (...args: any[]) => void) {\r\n    this.events.on(event, cb);\r\n  }\r\n\r\n  public step(dt: number) {\r\n    // this.maybeMoveWithTransports(dt);\r\n    if (!this.isWalkable(this.currentTile())) {\r\n      const nearestWalkableCell = this.findNearestWalkableCell();\r\n      if (nearestWalkableCell != null) {\r\n        this.world.logEvent({\r\n          type: \"oof\",\r\n          from: this.posFloat,\r\n          to: nearestWalkableCell,\r\n        });\r\n        this.posFloat.copy(nearestWalkableCell.pos);\r\n      }\r\n    }\r\n    if (this.action != null) {\r\n      const successful = this.attemptAction(this.action, dt);\r\n      if (this.action.type === \"long\") {\r\n        if (successful) {\r\n          this.action = undefined;\r\n        }\r\n      } else {\r\n        this.action = undefined;\r\n      }\r\n    }\r\n  }\r\n\r\n  public attemptAction(action: Action, dt: number): boolean {\r\n    const successful = this._attemptAction(action, dt);\r\n    console.log(action);\r\n    if (successful) {\r\n      this.events.emit(\"action\", action);\r\n    } else {\r\n      this.events.emit(\"action-fail\", action);\r\n    }\r\n    return successful;\r\n  }\r\n\r\n  private _attemptAction(action: Action, dt: number): boolean {\r\n    switch (action.type) {\r\n      case \"move\":\r\n        return this.attemptMove(action, dt);\r\n      case \"build\":\r\n        return this.attemptBuild(action, dt);\r\n      case \"deconstruct\":\r\n        return this.attemptDeconstruct(action, dt);\r\n      case \"drop\":\r\n        return this.attemptDrop(action, dt);\r\n      case \"pickup\":\r\n        return this.attemptPickup(action, dt);\r\n      case \"multiple\":\r\n        return this.attemptMultiple(action, dt);\r\n      case \"long\":\r\n        return this.attemptLong(action, dt);\r\n      case \"thaw\":\r\n        return this.attemptThaw(action, dt);\r\n    }\r\n  }\r\n\r\n  public isWalkable(pos: Tile): pos is Cell;\r\n\r\n  public isWalkable(pos: Vector2): boolean;\r\n\r\n  public isWalkable(pos: Tile | Vector2) {\r\n    const tile = pos instanceof Vector2 ? this.world.tileAt(Math.round(pos.x), Math.round(pos.y)) : pos;\r\n    if (!(tile instanceof Cell) || tile.isObstacle) {\r\n      // can't move!\r\n      return false;\r\n    }\r\n    if (tile instanceof Cell) {\r\n      return tile.findEffectOfType(FreezeEffect) == null;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public canBuildAt(tile: Tile | null): tile is Tile {\r\n    if (tile == null) {\r\n      return false;\r\n    } else if (tile instanceof Cell) {\r\n      return false;\r\n    } else {\r\n      return !tile.isObstacle;\r\n    }\r\n  }\r\n\r\n  isTakingLongAction() {\r\n    return this.action != null && this.action.type === \"long\";\r\n  }\r\n\r\n  public attemptMove(action: ActionMove, dt: number) {\r\n    const nextPos = this.posFloat.clone().add(action.dir.clone().setLength(this.speed * dt));\r\n    if (this.isWalkable(nextPos)) {\r\n      // const t = this.currentTile();\r\n      // if (t instanceof Cell) {\r\n      //   if (t.temperature < 40) {\r\n      //     t.nextTemperature += 0.2;\r\n      //   }\r\n      //   else if (t.temperature > 60) {\r\n      //     t.nextTemperature -= 0.2;\r\n      //   }\r\n      // }\r\n      // do the move\r\n      this.posFloat.copy(nextPos);\r\n      // this._pos = this.posFloat.clone().round();\r\n      // this.autopickup();\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public attemptStill(_dt: number) {\r\n    // this.autopickup();\r\n    return true;\r\n  }\r\n\r\n  // private autopickup() {\r\n  //   // autopickup resources in the position as possible\r\n  //   const cell = this.currentTile();\r\n  //   if (hasInventory(cell)) {\r\n  //     const inv = cell.inventory;\r\n  //     inv.give(this.inventory, this.suckWater ? inv.water : 0, this.suckSugar ? inv.sugar : 0);\r\n  //   }\r\n  // }\r\n  public tryConstructingNewCell(position: Vector2, cellType: CellType, args?: CellArgs) {\r\n    position = position.clone();\r\n    if (!this.world.isValidPosition(position.x, position.y)) {\r\n      // out of bounds/out of map\r\n      return;\r\n    }\r\n    // disallow building over existing cells\r\n    if (this.world.cellAt(position) != null) {\r\n      return;\r\n    }\r\n    if (this.getBuildError() == null) {\r\n      this.inventory.add(-waterCost, -sugarCost);\r\n      const newTile = new Cell(position, this.world, cellType, args);\r\n      return newTile;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  public attemptBuild(action: ActionBuild, dt: number) {\r\n    if (!this.canBuildAt(this.world.tileAt(action.position))) {\r\n      return false;\r\n    }\r\n    const existingCell = this.world.cellAt(action.position.x, action.position.y);\r\n    if (existingCell != null) {\r\n      // don't allow building over\r\n      return false;\r\n    }\r\n    const matureCell = this.tryConstructingNewCell(action.position, action.cellType, action.args);\r\n    if (matureCell == null) {\r\n      return false;\r\n    }\r\n\r\n    let cell: Cell;\r\n    if (action.cellType.chromosome.mergeStaticProperties().timeToBuild) {\r\n      // special - drop a sugar when you grow, to cover for the sugar\r\n      // this.attemptDrop(\r\n      //   {\r\n      //     type: \"drop\",\r\n      //     sugar: 1 / dt,\r\n      //     water: 0,\r\n      //   },\r\n      //   dt\r\n      // );\r\n      cell = new GrowingCell(action.position, this.world, matureCell, this.currentTile().pos);\r\n      // this.inventory.give(cell.inventory, 0, 1);\r\n    } else {\r\n      cell = matureCell;\r\n    }\r\n    cell.droopY = this.droopY();\r\n    this.world.setTileAt(action.position, cell);\r\n    return true;\r\n  }\r\n\r\n  public attemptDeconstruct(action: ActionDeconstruct, _dt: number): boolean {\r\n    if (!action.position.equals(this.pos) || action.force) {\r\n      const cell = this.world.maybeRemoveCellAt(action.position);\r\n      if (cell != null) {\r\n        // refund the resources back\r\n        const refund = cell.energy;\r\n        this.inventory.add(refund * waterCost, refund * sugarCost);\r\n\r\n        // maybeRemoveCellAt has already tried redistributing inventory to neighbors,\r\n        // but if it couldn't do that, as a last ditch, give resources directly to\r\n        // the player\r\n        cell.inventory.give(this.inventory, cell.inventory.water, cell.inventory.sugar);\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public attemptDrop(action: ActionDrop, dt: number) {\r\n    // drop as much as you can onto the current tile\r\n    const target = action.target;\r\n    let { water: waterToDrop, sugar: sugarToDrop } = action;\r\n    if (action.continuous) {\r\n      waterToDrop *= PLAYER_INTERACT_EXCHANGE_SPEED * dt;\r\n      sugarToDrop *= PLAYER_INTERACT_EXCHANGE_SPEED * dt;\r\n    }\r\n\r\n    const { water, sugar } = this.inventory.give(target.inventory, waterToDrop, sugarToDrop);\r\n    return water > 0 || sugar > 0;\r\n  }\r\n\r\n  public attemptPickup(action: ActionPickup, dt: number) {\r\n    const target = action.target;\r\n    const inv = target.inventory;\r\n\r\n    let { water: waterToDrop, sugar: sugarToDrop } = action;\r\n    if (action.continuous) {\r\n      waterToDrop *= PLAYER_INTERACT_EXCHANGE_SPEED * dt;\r\n      sugarToDrop *= PLAYER_INTERACT_EXCHANGE_SPEED * dt;\r\n    }\r\n    const { water, sugar } = inv.give(this.inventory, waterToDrop, sugarToDrop);\r\n    return water > 0 || sugar > 0;\r\n  }\r\n\r\n  public attemptMultiple(multiple: ActionMultiple, dt: number) {\r\n    let allSuccess = true;\r\n    for (const action of multiple.actions) {\r\n      allSuccess = this.attemptAction(action, dt) && allSuccess;\r\n    }\r\n    return allSuccess;\r\n  }\r\n\r\n  public attemptLong(action: ActionLong, dt: number) {\r\n    if (action.elapsed === 0) {\r\n      this.events.emit(\"start-long-action\", action);\r\n    }\r\n    action.elapsed += dt;\r\n    if (action.elapsed > action.duration) {\r\n      this.attemptAction(action.effect, dt);\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public attemptThaw(action: ActionThaw, dt: number) {\r\n    const { target } = action;\r\n    target.thaw(dt);\r\n    return true;\r\n  }\r\n}\r\n\r\nexport class PlayerSeed implements Steppable {\r\n  public readonly inventory = new Inventory(0, this);\r\n\r\n  public dtSinceLastStepped = 0;\r\n\r\n  private poppedOut = false;\r\n\r\n  public constructor(public posFloat: Vector2, public world: World, public player: Player) {}\r\n\r\n  shouldStep(): boolean {\r\n    return true;\r\n  }\r\n\r\n  get pos() {\r\n    return this.posFloat.clone().round();\r\n  }\r\n\r\n  step(dt: number): void {\r\n    const pos = this.pos;\r\n    const tileBelow = this.world.tileAt(pos.x, pos.y + 1);\r\n    if (tileBelow instanceof Air) {\r\n      // can keep going\r\n      const velY = Math.min(20 * dt, 1);\r\n      this.posFloat.y += velY;\r\n    } else {\r\n    }\r\n    this.player.posFloat.copy(this.posFloat);\r\n    if (this.poppedOut) {\r\n      this.world.removePlayerSeed();\r\n    }\r\n  }\r\n\r\n  popOut() {\r\n    const start = this.pos;\r\n    const c = new Cell(start, this.world, this.world.genome.cellTypes[0]);\r\n    const growingCell = new GrowingCell(start, this.world, c, start);\r\n    growingCell.silent = true;\r\n    this.world.setTileAt(start, growingCell);\r\n    Array.from(\r\n      this.world.bfsIterator(\r\n        start,\r\n        30,\r\n        (t) => !t.isObstacle && t.pos.distanceTo(start) < 2.5,\r\n        (t) => t.pos.distanceTo(start)\r\n      )\r\n    ).forEach((tile, i) => {\r\n      sleep(300).then(() => {\r\n        const cell = new Cell(tile.pos, this.world, this.world.genome.cellTypes[0]);\r\n        // const growingCell = new GrowingCell(tile.pos, this.world, cell, start);\r\n        this.world.setTileAt(tile.pos, cell);\r\n      });\r\n    });\r\n    this.poppedOut = true;\r\n  }\r\n}\r\n","import { TIME_PER_DAY, TIME_PER_MONTH, TIME_PER_SEASON, TIME_PER_YEAR } from \"./constants\";\r\nexport interface Season {\r\n  year: number;\r\n  season: 0 | 1 | 2 | 3;\r\n  /**\r\n   * month 1, 2, or 3 in the season.\r\n   */\r\n  month: number;\r\n  /**\r\n   * Percent done with the season total.\r\n   */\r\n  percent: number;\r\n  day: number;\r\n}\r\n\r\nexport function seasonFromTime(time: number): Season {\r\n  const year = Math.floor(time / TIME_PER_YEAR);\r\n  const timeInYear = time % TIME_PER_YEAR;\r\n  const season = Math.floor(timeInYear / TIME_PER_SEASON) as Season[\"season\"];\r\n  const percent = (timeInYear % TIME_PER_SEASON) / TIME_PER_SEASON;\r\n  const month = Math.floor((timeInYear % TIME_PER_SEASON) / TIME_PER_MONTH) + 1;\r\n  const day = Math.floor((timeInYear % TIME_PER_MONTH) / TIME_PER_DAY) + 1;\r\n  return {\r\n    year,\r\n    season,\r\n    percent,\r\n    month,\r\n    day,\r\n  };\r\n}\r\n\r\nexport const SEASON_NAMES = [\"Spring\", \"Summer\", \"Fall\", \"Winter\"];\r\n\r\nexport function seasonDisplay(s: Season) {\r\n  return `${s.year > 0 ? `Year ${s.year}, ` : \"\"}${SEASON_NAMES[s.season]}, Month ${s.month}`;\r\n}\r\n","import { Entity } from \"../entity\";\r\nimport { TileEvent, TileEventType } from \"../tile/tileEvent\";\r\nexport class StepStats {\r\n  public events: TileEventLog = {\r\n    \"cell-eat\": [],\r\n    \"cell-transfer-energy\": [],\r\n    evaporation: [],\r\n    photosynthesis: [],\r\n    thaw: [],\r\n    \"collect-sunlight\": [],\r\n    \"grow-fruit\": [],\r\n    oof: [],\r\n  };\r\n\r\n  constructor(public dt: number, public frame: number, public deleted: Entity[] = [], public added: Entity[] = []) {}\r\n\r\n  logEvent(event: TileEvent) {\r\n    this.events[event.type].push(event);\r\n  }\r\n}\r\n\r\nexport type TileEventLog = {\r\n  [K in TileEventType]: TileEvent[];\r\n};\r\n","export function arrayRange<T = number>(length: number, fill?: T | ((i: number) => T)): T[] {\r\n  return new Array(length).fill(undefined).map((_, i) => {\r\n    if (typeof fill === \"function\") {\r\n      return (fill as any)(i) as T;\r\n    } else if (fill === undefined) {\r\n      return i;\r\n    } else {\r\n      return fill;\r\n    }\r\n  }) as T[];\r\n}\r\n\r\nexport function gridRange<T>(width: number, height: number, fill: (x: number, y: number) => T) {\r\n  return arrayRange(width, (x) => arrayRange(height, (y) => fill(x, y)));\r\n}\r\n","import { Vector2 } from \"three\";\r\nimport { TileGenerator } from \"../core/environment\";\r\nimport { Fountain, Rock } from \"../core/tile\";\r\nimport { Clay, Sand, Silt } from \"../core/tile/soil\";\r\nimport { World } from \"../core/world/world\";\r\nimport { clamp, map, randInt } from \"../math\";\r\n\r\nexport type ScalarField = (pos: Vector2, world: World) => number;\r\n\r\nexport const pointsFilter = (gen: TileGenerator, points: Vector2[]): TileGenerator => {\r\n  return (pos, world) => {\r\n    if (points.find((p) => p.equals(pos)) != null) {\r\n      return gen(pos, world);\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * The first gen takes precedence over later ones.\r\n */\r\nexport const layers = (...gens: TileGenerator[]): TileGenerator => {\r\n  return (pos, world) => {\r\n    for (const g of gens) {\r\n      const tile = g(pos, world);\r\n      if (tile) {\r\n        return tile;\r\n      }\r\n    }\r\n  };\r\n};\r\n\r\nconst mixedSoilRock: TileGenerator = (pos, world) => {\r\n  const { noiseSoil, noiseWater } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const level = noiseSoil.octaveSimplex2(x / 10, y / 10);\r\n  const s = new (level < -0.37 ? Sand : level < 0.37 ? Silt : level < 1 ? Clay : Rock)(pos, world);\r\n  const water = clamp((noiseWater.simplex2(x / 5, y / 5) + 0.2 > 0.4 ? level : 0) * 20, 1, 20);\r\n  s.inventory.add(water, 0);\r\n  return s;\r\n};\r\n\r\nconst Level0: TileGenerator = (pos, world) => {\r\n  const { noiseHeight, noiseWater, noiseRock } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height / 2 - (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 - 16 * noiseHeight.perlin2(10, x / 20 + 10);\r\n  if (y > soilLevel) {\r\n    const rockThreshold = map(y - world.height / 2, 0, world.height / 2, -0.8, 0.3);\r\n    const isRock = noiseRock.simplex2(x / 5, y / 5) < rockThreshold;\r\n    if (isRock) {\r\n      const rock = new Rock(pos, world);\r\n      return rock;\r\n    } else {\r\n      const heightScalar = Math.pow(map(y - world.height / 2, 0, world.height / 2, 0.5, 1), 2);\r\n      const simplexScalar = 0.2;\r\n      // the + at the end makes a *huge* difference\r\n      const simplexValue = noiseWater.simplex2(x * simplexScalar, y * simplexScalar) + 0.2;\r\n\r\n      const isFountain = simplexValue > 0.8 && y - soilLevel > 5;\r\n      if (isFountain) {\r\n        return new Fountain(pos, world, 3, map(y, world.height / 2, world.height, 100, 300) + randInt(-10, 10));\r\n      }\r\n\r\n      if (heightScalar * simplexValue > 1) {\r\n        const emitWaterScalar = Math.min(heightScalar * simplexValue, 1);\r\n        return new Fountain(\r\n          pos,\r\n          world,\r\n          Math.round(3 / emitWaterScalar),\r\n          map(y, world.height / 2, world.height, 100, 300) + randInt(-10, 10)\r\n        );\r\n      } else {\r\n        const s = new Silt(pos, world)!;\r\n        const water = Math.round(clamp((simplexValue > 0.4 ? heightScalar : 0) * 10 * 3, 1, 10));\r\n        s.inventory.set(water, 0);\r\n        return s;\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nconst Temperate: TileGenerator = (pos, world) => {\r\n  const { noiseHeight, noiseWater, noiseRock } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height / 2 - (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 - 16 * noiseHeight.perlin2(10, x / 20 + 10);\r\n  if (y > soilLevel) {\r\n    const rockThreshold = map(y - world.height / 2, 0, world.height / 2, -0.7, 0.3);\r\n    const isRock = noiseRock.simplex2(x / 5, y / 5) < rockThreshold;\r\n    if (isRock) {\r\n      const rock = new Rock(pos, world);\r\n      return rock;\r\n    } else {\r\n      const heightScalar = Math.pow(map(y - world.height / 2, 0, world.height / 2, 0.5, 1), 2);\r\n      const simplexScalar = 0.2;\r\n      // the + at the end makes a *huge* difference\r\n      const simplexValue = noiseWater.simplex2(x * simplexScalar, y * simplexScalar) + 0.2;\r\n\r\n      const isFountain = simplexValue > 1 && y - soilLevel > 5;\r\n      if (isFountain) {\r\n        return new Fountain(pos, world, 3, map(y, world.height / 2, world.height, 100, 300));\r\n      }\r\n      if (heightScalar * simplexValue > 1) {\r\n        const emitWaterScalar = Math.min(heightScalar * simplexValue, 1);\r\n        return new Fountain(\r\n          pos,\r\n          world,\r\n          Math.round(3 / emitWaterScalar),\r\n          map(y, world.height / 2, world.height, 100, 300)\r\n        );\r\n      } else {\r\n        const s = mixedSoilRock(pos, world)!;\r\n        const water = Math.round(clamp((simplexValue > 0.4 ? heightScalar : 0) * 10, 1, 10));\r\n\r\n        s.inventory.set(water, 0);\r\n        return s;\r\n      }\r\n    }\r\n  }\r\n};\r\n\r\nconst Desert: TileGenerator = (pos, world) => {\r\n  const { noiseHeight, noiseRock } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height / 2 - (2 * (noiseHeight.perlin2(0, x / 20) + 1)) / 2 - 3 * noiseHeight.perlin2(10, x / 100 + 10);\r\n  const rockThreshold = map(y, world.height / 2, world.height, -0.8, -0.4);\r\n  const isRock = noiseRock.simplex2(x / 4, y / 4) < rockThreshold;\r\n  if (y > soilLevel) {\r\n    if (isRock) {\r\n      return new Rock(pos, world);\r\n    }\r\n    const s = mixedSoilRock(pos, world)!;\r\n    const water = Math.floor(Math.max(0, map(y, world.height * 0.75, world.height, 1, 9)));\r\n    s.inventory.set(water, 0);\r\n    return s;\r\n  }\r\n};\r\n\r\nconst Rocky: TileGenerator = (pos, world) => {\r\n  const { noiseHeight, noiseRock } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height * 0.55 -\r\n    (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 -\r\n    16 * noiseHeight.perlin2(10, x / 20 + 10) -\r\n    map(x, 0, world.width, 10, -10);\r\n  const rockLevel = y - (6 * (noiseHeight.perlin2(0, x / 25) + 1)) / 2 - 20 * noiseHeight.perlin2(10, x / 150 + 10);\r\n  const rockThreshold = rockLevel < world.height * 0.5 ? -1 : -0.15;\r\n  const isRock = noiseRock.simplex2(x / 10, y / 10) < rockThreshold;\r\n  if (isRock) {\r\n    const rock = new Rock(pos, world);\r\n    return rock;\r\n  } else if (y > soilLevel) {\r\n    const silt = new Silt(pos, world);\r\n    silt.inventory.add(2, 0);\r\n    return silt;\r\n  }\r\n};\r\n\r\nconst Reservoires: TileGenerator = (pos, world) => {\r\n  const { noiseHeight } = world.generatorContext;\r\n  const { x, y } = pos;\r\n  const soilLevel =\r\n    world.height / 2 - (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 - 16 * noiseHeight.perlin2(10, x / 20 + 10);\r\n  // const isRock = Math.abs(noiseRock.simplex2(x / 10, y / 10)) < 0.1;\r\n  const isRockHere = Math.sin(x / 4 + y / 30) ** 2 + Math.cos(y / 4) ** 2 > 1.2;\r\n  const isRockBelow = Math.sin(x / 4 + (y + 2) / 30) ** 2 + Math.cos((y + 2) / 4) ** 2 > 1.2;\r\n\r\n  const isRock = isRockHere && !isRockBelow;\r\n  if (isRock && y + 1 > soilLevel) {\r\n    return new Rock(pos, world);\r\n  }\r\n  if (y > soilLevel) {\r\n    return mixedSoilRock(pos, world);\r\n  }\r\n};\r\n\r\nconst SkySoil: TileGenerator = (pos, world) => {\r\n  const { noiseHeight } = world.generatorContext;\r\n  const { x, y } = pos;\r\n\r\n  const p = 2.5;\r\n  const soilLevel = Math.sin(x / p + y / 12) ** 2 + Math.cos(y / p) ** 2 + noiseHeight.perlin2(x / 4, y / 26);\r\n\r\n  if (soilLevel > 1.2 && y > 80 - soilLevel * 20) {\r\n    const s = new Silt(pos, world);\r\n    s.inventory.add(Math.floor(5 * (soilLevel - 1.1)), 0);\r\n    return s;\r\n  }\r\n\r\n  const soilLevelBase =\r\n    (world.height / 2) * 1.2 -\r\n    (4 * (noiseHeight.perlin2(0, x / 5) + 1)) / 2 -\r\n    16 * noiseHeight.perlin2(10, x / 20 + 10);\r\n  if (y > soilLevelBase) {\r\n    return mixedSoilRock(pos, world);\r\n  }\r\n};\r\n\r\nexport const TileGenerators = { Level0, Temperate, Desert, Rocky, Reservoires, SkySoil };\r\nexport type TileGeneratorName = keyof typeof TileGenerators;\r\n","import { Noise } from \"common/perlin\";\r\n\r\nexport interface GeneratorContext {\r\n  seed: number;\r\n  noiseHeight: Noise;\r\n  noiseRock: Noise;\r\n  noiseWater: Noise;\r\n  noiseSoil: Noise;\r\n}\r\n\r\nfunction modulateSeed(seed: number, key: string) {\r\n  for (const letter of key) {\r\n    seed |= seed << (7 + letter.charCodeAt(0) ** 2);\r\n  }\r\n  return seed;\r\n}\r\n\r\nexport function createGeneratorContext(seed: number): GeneratorContext {\r\n  return {\r\n    seed,\r\n    noiseHeight: new Noise(modulateSeed(seed, \"height\")),\r\n    noiseRock: new Noise(modulateSeed(seed, \"rock\")),\r\n    noiseWater: new Noise(modulateSeed(seed, \"water\")),\r\n    noiseSoil: new Noise(modulateSeed(seed, \"soil\")),\r\n  };\r\n}\r\n","import { randInt, randRound } from \"math\";\r\nimport { PERCENT_DAYLIGHT, SUNLIGHT_DIFFUSION, SUNLIGHT_REINTRODUCTION, TIME_PER_DAY } from \"../constants\";\r\nimport { Air } from \"../tile\";\r\nimport { World } from \"./world\";\r\n/**\r\n * WeatherController is responsible for weather related properties, such as:\r\n *\r\n * Temperature of the environment\r\n * Sunlight\r\n */\r\nexport class WeatherController {\r\n  constructor(public world: World) {}\r\n\r\n  /**\r\n   * 0 to 2pi, where\r\n   * 0 to pi: daytime (time of day - 0 to PERCENT_DAYLIGHT)\r\n   * pi to 2pi: nighttime (PERCENT_DAYLIGHT to 1)\r\n   */\r\n  get sunAngle() {\r\n    const timeOfDay = (this.world.time / TIME_PER_DAY) % 1;\r\n    if (timeOfDay < PERCENT_DAYLIGHT) {\r\n      return (timeOfDay / PERCENT_DAYLIGHT) * Math.PI;\r\n    } else {\r\n      return Math.PI * (1 + (timeOfDay - PERCENT_DAYLIGHT) / (1 - PERCENT_DAYLIGHT));\r\n    }\r\n  }\r\n\r\n  get sunAmount() {\r\n    return (Math.atan(Math.sin(this.sunAngle) * 12) / (Math.PI / 2)) * 0.5 + 0.5;\r\n  }\r\n\r\n  getCurrentTemperature() {\r\n    const { season } = this.world.season;\r\n    return this.world.environment.temperaturePerSeason[season];\r\n  }\r\n\r\n  step(dt: number) {\r\n    this.updateTemperatures();\r\n    this.computeSunlight();\r\n    this.stepWeather(dt);\r\n  }\r\n\r\n  public stepWeather(dt: number) {\r\n    const world = this.world;\r\n    // offset first rain event by a few seconds\r\n    const isRaining =\r\n      (world.time + world.environment.climate.timeBetweenRainfall - 6) % world.environment.climate.timeBetweenRainfall <\r\n      world.environment.climate.rainDuration;\r\n    if (isRaining) {\r\n      // add multiple random droplets\r\n      let numWater = world.environment.climate.waterPerSecond * dt;\r\n      while (numWater > 0) {\r\n        const dropletSize = Math.min(numWater, 1);\r\n        const x = randInt(0, world.width - 1);\r\n        const t = world.tileAt(x, 0);\r\n        if (t instanceof Air) {\r\n          const w = randRound(dropletSize);\r\n          t.inventory.add(w, 0);\r\n          world.numRainWater += w;\r\n        }\r\n        numWater -= 1;\r\n      }\r\n    }\r\n  }\r\n\r\n  public computeSunlight() {\r\n    // step downards from the top; neighbors don't affect the calculation so\r\n    // we don't have buffering problems\r\n    // TODO allow sunlight to go full 45-to-90 degrees\r\n    const sunAngle = this.sunAngle;\r\n    const directionalBias = Math.sin(sunAngle - Math.PI / 2);\r\n    const sunAmount = this.sunAmount;\r\n    for (let y = 0; y <= this.world.height; y++) {\r\n      for (let x = 0; x < this.world.width; x++) {\r\n        const t = this.world.environmentTileAt(x, y);\r\n        if (t instanceof Air) {\r\n          let sunlight = 0;\r\n          if (y === 0) {\r\n            sunlight = 1;\r\n          } else {\r\n            const tileUp = this.world.tileAt(x, y - 1);\r\n            const tileRight = this.world.tileAt(x + 1, y - 1);\r\n            const tileLeft = this.world.tileAt(x - 1, y - 1);\r\n            const upSunlight = tileUp instanceof Air ? tileUp.sunlightCached / sunAmount : tileUp == null ? 1 : 0;\r\n            const rightSunlight =\r\n              tileRight instanceof Air ? tileRight.sunlightCached / sunAmount : tileRight == null ? 1 : 0;\r\n            const leftSunlight =\r\n              tileLeft instanceof Air ? tileLeft.sunlightCached / sunAmount : tileLeft == null ? 1 : 0;\r\n            if (directionalBias > 0) {\r\n              // positive light travels to the right\r\n              sunlight = rightSunlight * directionalBias + upSunlight * (1 - directionalBias);\r\n            } else {\r\n              sunlight = leftSunlight * -directionalBias + upSunlight * (1 - -directionalBias);\r\n            }\r\n            sunlight =\r\n              sunlight * (1 - SUNLIGHT_DIFFUSION) +\r\n              ((upSunlight + rightSunlight + leftSunlight) / 3) * SUNLIGHT_DIFFUSION;\r\n          }\r\n          // have at least a bit\r\n          sunlight = SUNLIGHT_REINTRODUCTION + sunlight * (1 - SUNLIGHT_REINTRODUCTION);\r\n          sunlight *= sunAmount;\r\n          t.sunlightCached = sunlight;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public updateTemperatures() {\r\n    for (const t of this.world.allCells()) {\r\n      t.temperatureFloat = t.nextTemperature;\r\n    }\r\n  }\r\n}\r\n","import { Environment } from \"core/environment\";\r\nimport { gridRange } from \"math/arrays\";\r\nimport { TileGenerators } from \"std/tileGenerators\";\r\nimport { Vector2 } from \"three\";\r\nimport devlog from \"../../common/devlog\";\r\nimport shuffle from \"../../math/shuffle\";\r\nimport Genome from \"../cell/genome\";\r\nimport { DIRECTION_VALUES } from \"../directions\";\r\nimport { Entity, isSteppable, step } from \"../entity\";\r\nimport { hasInventory } from \"../inventory\";\r\nimport { Player, PlayerSeed } from \"../player/player\";\r\nimport { Season, seasonFromTime } from \"../season\";\r\nimport { Species } from \"../species\";\r\nimport { Air, Cell, Soil, Tile } from \"../tile\";\r\nimport { TileEvent } from \"../tile/tileEvent\";\r\nimport { createGeneratorContext, GeneratorContext } from \"./generatorContext\";\r\nimport { StepStats } from \"./stepStats\";\r\nimport { WeatherController } from \"./weatherController\";\r\n\r\nexport interface WorldOptions {\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nconst optionsDefault: WorldOptions = {\r\n  width: 50,\r\n  height: 100,\r\n};\r\n\r\nexport class World {\r\n  public time: number = 0;\r\n\r\n  public frame: number = 0;\r\n\r\n  public readonly width: number;\r\n\r\n  public readonly height: number;\r\n\r\n  public readonly player: Player;\r\n\r\n  public playerSeed?: PlayerSeed;\r\n\r\n  private readonly gridEnvironment: Tile[][];\r\n\r\n  private readonly gridCells: Array<Array<Cell | null>>;\r\n\r\n  private readonly neighborCache: Array<Array<Map<Vector2, Tile>>>;\r\n\r\n  public readonly mpEarners = new Map<Cell, number>();\r\n\r\n  public readonly species: Species;\r\n\r\n  public readonly generatorContext: GeneratorContext;\r\n\r\n  public weather: WeatherController;\r\n\r\n  genome: Genome;\r\n\r\n  get season(): Season {\r\n    return seasonFromTime(this.time);\r\n  }\r\n\r\n  constructor(\r\n    public environment: Environment,\r\n    seed: number,\r\n    species: Species,\r\n    optionsPartial: Partial<WorldOptions> = {}\r\n  ) {\r\n    const options = { ...optionsDefault, ...optionsPartial };\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this.generatorContext = createGeneratorContext(seed);\r\n    this.species = species;\r\n    this.genome = species.genome;\r\n    this.weather = new WeatherController(this);\r\n\r\n    const tileGenerator = typeof environment.fill === \"string\" ? TileGenerators[environment.fill] : environment.fill;\r\n    this.gridEnvironment = gridRange(this.width, this.height, (x, y) => {\r\n      const pos = new Vector2(x, y);\r\n      return tileGenerator(pos, this) || new Air(pos, this);\r\n    });\r\n\r\n    this.gridCells = gridRange(this.width, this.height, () => null);\r\n    this.neighborCache = gridRange(this.width, this.height, (x, y) => this.computeTileNeighbors(x, y));\r\n    this.fillCachedEntities();\r\n\r\n    this.computeSoilDepths();\r\n\r\n    // always drop player on the Soil Air interface\r\n    const start = new Vector2(Math.floor(this.width / 2), Math.floor(this.height / 2));\r\n    const firstNonAir = this.gridEnvironment[start.x].find((t) => !(t instanceof Air));\r\n    if (firstNonAir != null) {\r\n      // if we hit a rock, go onto the Air right above it\r\n      start.y = firstNonAir.isObstacle ? firstNonAir.pos.y - 1 : firstNonAir.pos.y;\r\n    }\r\n\r\n    this.player = new Player(start, this);\r\n    this.playerSeed = new PlayerSeed(start, this, this.player);\r\n\r\n    this.fillCachedEntities();\r\n\r\n    // step all tiles first with 0 timestep to trigger any initial state\r\n    gridRange(this.width, this.height, (x, y) => {\r\n      const tileEnvironment = this.gridEnvironment[x][y];\r\n      tileEnvironment && tileEnvironment.step(0);\r\n\r\n      const tileCell = this.gridCells[x][y];\r\n      tileCell && tileCell.step(0);\r\n    });\r\n    this.weather.step(0);\r\n  }\r\n\r\n  public removePlayerSeed() {\r\n    this.stepStats.deleted.push(this.playerSeed!);\r\n    delete this.playerSeed;\r\n  }\r\n\r\n  public tileAt(v: Vector2): Tile | null;\r\n\r\n  public tileAt(x: number, y: number): Tile | null;\r\n\r\n  public tileAt(xOrVec2: number | Vector2, y?: number): Tile | null {\r\n    let x: number;\r\n    if (xOrVec2 instanceof Vector2) {\r\n      x = xOrVec2.x;\r\n      y = xOrVec2.y;\r\n    } else {\r\n      x = xOrVec2;\r\n      y = y!;\r\n    }\r\n\r\n    if (!this.isValidPosition(x, y)) {\r\n      return null;\r\n    }\r\n    const cell = this.gridCells[x][y];\r\n    if (cell != null) {\r\n      return cell;\r\n    } else {\r\n      return this.gridEnvironment[x][y];\r\n    }\r\n  }\r\n\r\n  public cellAt(v: Vector2): Cell | null;\r\n\r\n  public cellAt(x: number, y: number): Cell | null;\r\n\r\n  public cellAt(x: number | Vector2, y?: number): Cell | null {\r\n    if (x instanceof Vector2) {\r\n      y = x.y;\r\n      x = x.x;\r\n    }\r\n    if (this.isValidPosition(x, y!)) {\r\n      return this.gridCells[x][y!];\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  public environmentTileAt(x: number, y: number): Tile | null {\r\n    if (this.isValidPosition(x, y)) {\r\n      return this.gridEnvironment[x][y];\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Rules for replacement:\r\n  // if tile is environment, clear out the gridCell and set the gridEnvironment.\r\n  // if tile is cell, set gridCell, leave gridEnvironment alone.\r\n  public setTileAt(position: Vector2, tile: Tile) {\r\n    const { x, y } = position;\r\n    if (!this.isValidPosition(x, y)) {\r\n      throw new Error(`invalid position ${x}, ${y} `);\r\n    }\r\n    if (tile instanceof Cell && tile.isReproductive) {\r\n      this.mpEarners.set(tile, 0);\r\n    }\r\n    const oldTile = this.tileAt(x, y)!;\r\n    // if replacing a tile with inventory, try giving resources to neighbors of the same type\r\n    if (hasInventory(oldTile)) {\r\n      // // give resources if available to the new tile\r\n      // if (hasInventory(tile) && canPullResources(tile, oldTile)) {\r\n      //   oldTile.inventory.give(tile.inventory, oldTile.inventory.water, oldTile.inventory.sugar);\r\n      // }\r\n      oldTile.redistributeInventoryToNeighbors();\r\n      if (oldTile.inventory.water !== 0 || oldTile.inventory.sugar !== 0) {\r\n        console.warn(\"lost\", oldTile.inventory, \"resources to building\");\r\n        oldTile.inventory.add(-oldTile.inventory.water, -oldTile.inventory.sugar);\r\n      }\r\n    }\r\n\r\n    const oldCell = this.gridCells[x][y];\r\n    if (oldCell != null) {\r\n      this.stepStats.deleted.push(oldCell);\r\n    }\r\n\r\n    if (tile instanceof Cell) {\r\n      // set gridCell only\r\n      this.gridCells[x][y] = tile;\r\n    } else {\r\n      // hackhack - we should call .die() on gridCells[x][y] but we already have with the oldTile code above\r\n      this.gridCells[x][y] = null;\r\n\r\n      const oldEnvironmentTile = this.gridEnvironment[x][y];\r\n      if (oldEnvironmentTile != null) {\r\n        this.stepStats.deleted.push(oldEnvironmentTile);\r\n      }\r\n      this.gridEnvironment[x][y] = tile;\r\n    }\r\n    this.stepStats.added.push(tile);\r\n    this.handleTileUpdated(position);\r\n  }\r\n\r\n  public maybeRemoveCellAt(position: Vector2): Cell | null {\r\n    const cell = this.cellAt(position.x, position.y);\r\n    if (cell) {\r\n      cell.redistributeInventoryToNeighbors();\r\n      this.gridCells[position.x][position.y] = null;\r\n      this.stepStats.deleted.push(cell);\r\n      cell.isDead = true;\r\n    }\r\n    this.handleTileUpdated(position);\r\n    return cell;\r\n  }\r\n\r\n  public isValidPosition(x: number, y: number) {\r\n    if (x >= this.width || x < 0 || y >= this.height || y < 0) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a map from direction offsets (DIRECTIONS.n, .nw, .ne, etc.) to Tile neighbors occupying that offset.\r\n   */\r\n  public tileNeighbors(pos: Vector2) {\r\n    return this.neighborCache[pos.x][pos.y];\r\n  }\r\n\r\n  private computeTileNeighbors(px: number, py: number) {\r\n    const mapping = new Map<Vector2, Tile>();\r\n    // randomize the neighbor array to reduce aliasing\r\n    const directions = DIRECTION_VALUES_RAND[this.frame % DIRECTION_VALUES_RAND.length];\r\n    directions.forEach((v) => {\r\n      const x = px + v.x;\r\n      const y = py + v.y;\r\n      const tile = this.tileAt(x, y);\r\n      if (tile != null) {\r\n        mapping.set(v, tile);\r\n      }\r\n    });\r\n    return mapping;\r\n  }\r\n  // only use for rendering\r\n  // private cachedRenderableEntities?: Entity[];\r\n  // public renderableEntities() {\r\n  //     if (this.cachedRenderableEntities == null) {\r\n  //         throw new Error(\"accessed renderable entities before filling\");\r\n  //     }\r\n  //     return this.cachedRenderableEntities;\r\n  // }\r\n\r\n  private cachedEntities?: Entity[];\r\n\r\n  public entities() {\r\n    if (this.cachedEntities == null) {\r\n      throw new Error(\"accessed entities before filling\");\r\n    }\r\n    return this.cachedEntities;\r\n  }\r\n\r\n  private handleTileUpdated(pos: Vector2) {\r\n    this.neighborCache[pos.x][pos.y] = this.computeTileNeighbors(pos.x, pos.y);\r\n    for (const dir of DIRECTION_VALUES) {\r\n      const x = pos.x + dir.x;\r\n      const y = pos.y + dir.y;\r\n      if (this.isValidPosition(x, y)) {\r\n        this.neighborCache[x][y] = this.computeTileNeighbors(x, y);\r\n      }\r\n    }\r\n    this.fillCachedEntities();\r\n  }\r\n\r\n  private fillCachedEntities() {\r\n    const newEntities: Entity[] = [];\r\n    // we do this super hacky thing for performance where we only run every other entity in\r\n    // a checkerboard pattern.\r\n    //\r\n    // also, entities can interact with other entities, there is no lock-step buffer state,\r\n    // which means you can get weird artifacts like \"water suddenly moves 20 squares\".\r\n    // to combat this we alternatingly reverse the tile iteration order.\r\n    let x = 0,\r\n      y = 0;\r\n    for (x = 0; x < this.width; x++) {\r\n      for (y = (x + this.frame) % 2; y < this.height; y += 2) {\r\n        // checkerboard\r\n        newEntities.push(this.tileAt(x, y)!);\r\n      }\r\n    }\r\n    for (x = 0; x < this.width; x++) {\r\n      for (y = (x + this.frame + 1) % 2; y < this.height; y += 2) {\r\n        // opposite checkerboard\r\n        newEntities.push(this.tileAt(x, y)!);\r\n      }\r\n    }\r\n    if (this.frame % 4 < 2) {\r\n      newEntities.reverse();\r\n    }\r\n    // add player at the end - this is important since Player is currently the only thing\r\n    // that modifies tiles. You can get into situations where tiles that should be dead\r\n    // are still left-over in the entities cache.\r\n    if (this.playerSeed) {\r\n      newEntities.push(this.playerSeed);\r\n    } else {\r\n      newEntities.push(this.player);\r\n    }\r\n    this.cachedEntities = newEntities;\r\n\r\n    // update renderable entities\r\n    // (() => {\r\n    //     const entities: Entity[] = [this.player];\r\n    //     for (x = 0; x < width; x++) {\r\n    //         for (y = 0; y < height; y++) {\r\n    //             entities.push(this.gridEnvironment[x][y]);\r\n    //             const cellMaybe = this.gridCells[x][y];\r\n    //             if (cellMaybe != null) {\r\n    //                 entities.push(cellMaybe);\r\n    //             }\r\n    //         }\r\n    //     }\r\n    //     this.cachedRenderableEntities = entities;\r\n    // })();\r\n  }\r\n\r\n  private stepStats: StepStats = new StepStats(0, this.frame);\r\n\r\n  public step(dt: number): StepStats {\r\n    const entities = this.entities();\r\n    this.stepStats = new StepStats(dt, this.frame);\r\n    // dear god\r\n    entities.forEach((entity) => {\r\n      if (isSteppable(entity)) {\r\n        step(entity, dt);\r\n      }\r\n    });\r\n    this.weather.step(dt);\r\n    this.frame++;\r\n    this.time += dt;\r\n    this.fillCachedEntities();\r\n    return this.stepStats;\r\n    // this.checkResources();\r\n  }\r\n\r\n  logEvent(event: TileEvent) {\r\n    this.stepStats.logEvent(event);\r\n  }\r\n\r\n  public getLastStepStats() {\r\n    return this.stepStats;\r\n  }\r\n\r\n  numRainWater = 0;\r\n\r\n  numEvaporatedAir = 0;\r\n\r\n  numEvaporatedSoil = 0;\r\n\r\n  public computeSoilDepths() {\r\n    const airPositions = Array.from(this.allEnvironmentTiles())\r\n      .filter((t) => t instanceof Air)\r\n      .map((t) => t.pos);\r\n\r\n    for (const tile of this.bfsIterator(airPositions, this.width * this.height)) {\r\n      if (tile instanceof Soil) {\r\n        let minNeighborDepth = tile.depth;\r\n        for (const [, neighbor] of this.tileNeighbors(tile.pos)) {\r\n          if (neighbor instanceof Air) {\r\n            minNeighborDepth = 0;\r\n          } else if (neighbor instanceof Soil) {\r\n            minNeighborDepth = Math.min(minNeighborDepth, neighbor.depth);\r\n          }\r\n        }\r\n        tile.depth = minNeighborDepth + 1;\r\n      }\r\n    }\r\n  }\r\n\r\n  earnMP(cell: Cell, mpEarned: number) {\r\n    this.mpEarners.set(cell, mpEarned);\r\n  }\r\n\r\n  public checkResources() {\r\n    let totalSugar = 0;\r\n    let totalWater = 0;\r\n    let totalEnergy = 0;\r\n    this.entities().forEach((e) => {\r\n      if (hasInventory(e)) {\r\n        totalSugar += e.inventory.sugar;\r\n        totalWater += e.inventory.water;\r\n      }\r\n      if (e instanceof Cell) {\r\n        totalEnergy += e.energy;\r\n      }\r\n    });\r\n    devlog(\"sugar\", totalSugar, \"water\", totalWater, \"energy\", totalEnergy);\r\n  }\r\n\r\n  public allCells() {\r\n    const { gridCells, width, height } = this;\r\n    return {\r\n      *[Symbol.iterator]() {\r\n        for (let x = 0; x < width; x++) {\r\n          for (let y = 0; y < height; y++) {\r\n            const g = gridCells[x][y];\r\n            if (g != null) {\r\n              yield g;\r\n            }\r\n          }\r\n        }\r\n      },\r\n    };\r\n  }\r\n\r\n  public allEnvironmentTiles() {\r\n    const self = this;\r\n    return {\r\n      *[Symbol.iterator]() {\r\n        for (const row of self.gridEnvironment) {\r\n          for (const t of row) {\r\n            yield t;\r\n          }\r\n        }\r\n      },\r\n    };\r\n  }\r\n\r\n  allTiles() {\r\n    const { width, height } = this;\r\n    const self = this;\r\n    return {\r\n      *[Symbol.iterator]() {\r\n        for (let x = 0; x < width; x++) {\r\n          for (let y = 0; y < height; y++) {\r\n            const g = self.tileAt(x, y);\r\n            if (g != null) {\r\n              yield g;\r\n            }\r\n          }\r\n        }\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Breadth first search (floodfill) generator\r\n   */\r\n  public bfsIterator(\r\n    start: Vector2 | Vector2[],\r\n    limit: number,\r\n    filter?: (tile: Tile) => boolean,\r\n    heuristic?: (tile: Tile) => number\r\n  ) {\r\n    const self = this;\r\n    const frontier = (Array.isArray(start) ? start : [start]).map((v) => this.tileAt(v)!);\r\n    const processed = new Set<Tile>();\r\n    return {\r\n      *[Symbol.iterator]() {\r\n        while (frontier.length > 0 && processed.size < limit) {\r\n          const tile = frontier.shift();\r\n          if (tile == null) {\r\n            return;\r\n          }\r\n          processed.add(tile);\r\n          yield tile;\r\n          const neighbors = self.tileNeighbors(tile.pos);\r\n          for (const [offset, n] of neighbors) {\r\n            if (\r\n              offset.manhattanLength() === 1 &&\r\n              (filter == null || filter(n)) &&\r\n              frontier.indexOf(n) === -1 &&\r\n              !processed.has(n)\r\n            ) {\r\n              frontier.push(n);\r\n            }\r\n          }\r\n          if (heuristic) {\r\n            frontier.sort((a, b) => heuristic(a) - heuristic(b));\r\n          }\r\n        }\r\n      },\r\n    };\r\n  }\r\n}\r\n\r\nconst DIRECTION_VALUES_RAND = [\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n  shuffle(DIRECTION_VALUES.slice()),\r\n];\r\n","import { GeneDirectionalPush } from \"std/genes/GeneDirectionalPush\";\r\nimport { Color, Vector2 } from \"three\";\r\nimport Chromosome from \"../../core/cell/chromosome\";\r\nimport Genome, { CellType } from \"../../core/cell/genome\";\r\nimport { GeneEnergyTransfer, GeneInventory, GeneLiving, GeneMetabolism, GeneSoilAbsorption } from \"../genes\";\r\nimport { GeneObstacle } from \"../genes/GeneObstacle\";\r\nimport { GenePhotosynthesis } from \"../genes/GenePhotosynthesis\";\r\nimport { GeneSeed } from \"../genes/GeneReproducer\";\r\n\r\nconst cellTypeTissue = new CellType(\r\n  \"Tissue\",\r\n  0,\r\n  new Chromosome(\r\n    GeneLiving.level(2),\r\n    GeneInventory.level(3),\r\n    GeneMetabolism.level(2),\r\n    GeneEnergyTransfer.level(1),\r\n    GeneDirectionalPush.level(3)\r\n  ),\r\n  {\r\n    texturePosition: new Vector2(1, 1),\r\n    color: new Color(0x30ae25),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeLeaf = new CellType(\r\n  \"Leaf\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneInventory.level(3), GeneObstacle.level(0), GenePhotosynthesis.level(1)),\r\n  {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(2, 1),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"water take sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeRoot = new CellType(\r\n  \"Root\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneInventory.level(4), GeneObstacle.level(0), GeneSoilAbsorption.level(2)),\r\n  {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(3, 1),\r\n  },\r\n  {\r\n    type: \"take\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nconst cellTypeSeed = new CellType(\r\n  \"Seed\",\r\n  0,\r\n  new Chromosome(GeneLiving.level(2), GeneInventory.level(3), GeneObstacle.level(0), GeneSeed.level(2)),\r\n  {\r\n    texturePosition: new Vector2(1, 4),\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"water and sugar\",\r\n  }\r\n);\r\n\r\nexport const tutorialGenome = new Genome([cellTypeTissue, cellTypeLeaf, cellTypeRoot, cellTypeSeed]);\r\n","import Genome from \"core/cell/genome\";\r\nimport { createSimpleSchema, identifier, list, object, primitive, reference } from \"serializr\";\r\nimport { tutorialGenome } from \"std/genomes/tutorialGenome\";\r\nimport uuid from \"uuid\";\r\nimport { RealizedGene } from \"./cell\";\r\n\r\nexport interface Species {\r\n  genome: Genome;\r\n  id: string;\r\n  name: string;\r\n  freeMutationPoints: number;\r\n  totalMutationPoints: number;\r\n  descendants: Species[];\r\n  parent?: Species;\r\n  geneOptions: RealizedGene[];\r\n}\r\n\r\nexport const SpeciesSchema = createSimpleSchema<Species>({\r\n  // TODO fill in\r\n  genome: object(Genome),\r\n  id: identifier(),\r\n  name: primitive(),\r\n  freeMutationPoints: primitive(),\r\n  totalMutationPoints: primitive(),\r\n  geneOptions: list(object(RealizedGene)),\r\n});\r\n// we can't self-reference SpeciesSchema in its instantiation; set it after\r\nSpeciesSchema.props.descendants = list(object(SpeciesSchema));\r\nSpeciesSchema.props.parent = reference(SpeciesSchema);\r\n\r\nexport function newBaseSpecies(name = \"plantum originus\"): Species {\r\n  return {\r\n    id: uuid(),\r\n    genome: tutorialGenome,\r\n    name,\r\n    freeMutationPoints: 0,\r\n    totalMutationPoints: 0,\r\n    descendants: [],\r\n    geneOptions: [],\r\n  };\r\n}\r\n\r\nexport function lineage(species: Species): Species[] {\r\n  const arr = [];\r\n  arr.push(species);\r\n  for (const s of species.descendants) {\r\n    arr.push(...lineage(s));\r\n  }\r\n  return arr;\r\n}\r\n","import { World } from \"core\";\r\nimport { Tile } from \"core/tile\";\r\n\r\nexport type Visitor = (tiles: Tile[], world: World) => number;\r\n\r\nexport interface Visitors {\r\n  [name: string]: Visitor;\r\n}\r\n\r\nexport function visit(tiles: Tile[], visitors: Visitors): Trial {\r\n  const results: Trial = {};\r\n  for (const [name, visitor] of Object.entries(visitors)) {\r\n    const result = visitor(tiles, tiles[0].world);\r\n    results[name] = result;\r\n  }\r\n  return results;\r\n}\r\n\r\nexport interface Trial {\r\n  [key: string]: number;\r\n}\r\n\r\nexport class Experiment {\r\n  trials: Trial[] = [];\r\n\r\n  constructor(public visitors: Visitors) {}\r\n\r\n  recordDataFor(tiles: Tile[]) {\r\n    const trial = visit(tiles, this.visitors);\r\n    this.trials.push(trial);\r\n  }\r\n\r\n  visitorNames() {\r\n    return Object.keys(this.visitors);\r\n  }\r\n}\r\n\r\nexport class ExperimentSuite {\r\n  constructor(public experiments: Experiment[]) {}\r\n\r\n  recordDataFor(tiles: Tile[]) {\r\n    for (const e of this.experiments) {\r\n      e.recordDataFor(tiles);\r\n    }\r\n  }\r\n}\r\n","import { Environment } from \"core/environment\";\r\nimport { Cell } from \"core/tile\";\r\nimport { Layout, PlotData } from \"plotly.js\";\r\nimport React from \"react\";\r\nimport { standardGenome } from \"std/genomes/standardGenome\";\r\nimport { World } from \"../core\";\r\nimport { newBaseSpecies } from \"../core/species\";\r\nimport { Experiment, Visitors } from \"./experiment\";\r\n\r\nconst allSoilEnvironment: Environment = {\r\n  airEvaporation: 0,\r\n  climate: { rainDuration: 0, timeBetweenRainfall: Infinity, waterPerSecond: 0 },\r\n  fill: (pos, world) => undefined,\r\n  secondsToEvaporate: Infinity,\r\n  floorCo2: 1,\r\n  temperaturePerSeason: [50, 50, 50, 50],\r\n};\r\n\r\nfunction testWorld(width: number, height: number) {\r\n  const world = new World(allSoilEnvironment, 0, newBaseSpecies(), {\r\n    width,\r\n    height,\r\n  });\r\n  const cellTypeTissue = standardGenome.cellTypes[0];\r\n  for (const t of world.allEnvironmentTiles()) {\r\n    const p = t.pos;\r\n    world.setTileAt(p, new Cell(p, world, cellTypeTissue));\r\n  }\r\n  world.cellAt(0, 0)!.inventory.set(100, 0);\r\n  return world;\r\n}\r\nfunction runOneWideAbsolute() {\r\n  const world1 = testWorld(20, 1);\r\n  const visitors: Visitors = {\r\n    time: (t) => t[0].world.time,\r\n  };\r\n  for (const c of world1.allCells()) {\r\n    const pos = c.pos;\r\n    const cell1 = world1.cellAt(pos)!;\r\n    visitors[pos.x] = () => {\r\n      const c1w = cell1.inventory.water;\r\n      return c1w;\r\n    };\r\n  }\r\n  const experiment = new Experiment(visitors);\r\n  console.time(\"run simulation\");\r\n  do {\r\n    if (world1.time % 1 < 0.1) {\r\n      experiment.recordDataFor(Array.from(world1.allCells()));\r\n    }\r\n    world1.step(0.1);\r\n  } while (world1.time <= 10);\r\n  console.timeEnd(\"run simulation\");\r\n  return experiment;\r\n}\r\n\r\nfunction runTwoWideCompare() {\r\n  const world1 = testWorld(20, 1);\r\n  const world2 = testWorld(20, 2);\r\n  const visitors: Visitors = {\r\n    time: (t) => t[0].world.time,\r\n  };\r\n  for (const c of world1.allCells()) {\r\n    const pos = c.pos;\r\n    const cell1 = world1.cellAt(pos)!;\r\n    const cell2 = world2.cellAt(pos)!;\r\n    visitors[pos.x] = () => {\r\n      const c1w = cell1.inventory.water;\r\n      const c2w = cell2.inventory.water;\r\n      // how much faster (or slower) a 2 wide channel goes compared to a one-wide\r\n      return c2w - c1w;\r\n    };\r\n  }\r\n  const experiment = new Experiment(visitors);\r\n  console.time(\"run simulation\");\r\n  do {\r\n    if (world1.time % 1 < 0.1) {\r\n      experiment.recordDataFor(Array.from(world1.allCells()));\r\n    }\r\n    world1.step(0.1);\r\n    world2.step(0.1);\r\n  } while (world1.time <= 10);\r\n  console.timeEnd(\"run simulation\");\r\n  return experiment;\r\n}\r\n\r\nfunction plotStackedBar(experiment: Experiment, divId: string) {\r\n  const data = [];\r\n  for (const trialIndex in experiment.trials) {\r\n    const trial = experiment.trials[trialIndex];\r\n    const x = [];\r\n    const y = [];\r\n    for (const name of experiment.visitorNames()) {\r\n      x.push(name);\r\n      const value = trial[name];\r\n      y.push(value);\r\n    }\r\n    const trace: Partial<PlotData> = {\r\n      x,\r\n      y,\r\n      name: `t=${Number(trialIndex) / 10}`,\r\n      type: \"bar\",\r\n    };\r\n    data.push(trace);\r\n  }\r\n  var layout: Partial<Layout> = { barmode: \"stack\" };\r\n\r\n  const div = document.createElement(\"div\");\r\n  const el = document.getElementById(divId)!;\r\n  el.appendChild(div);\r\n  window.Plotly.newPlot(div, data, layout);\r\n}\r\n\r\nfunction TestDiffusion() {\r\n  React.useEffect(() => {\r\n    var script = document.createElement(\"script\");\r\n    script.src = \"https://cdn.plot.ly/plotly-latest.min.js\";\r\n    script.addEventListener(\"load\", function() {\r\n      const e = runTwoWideCompare();\r\n      plotStackedBar(e, \"water-over-time\");\r\n    });\r\n    script.addEventListener(\"error\", () => {\r\n      const e1 = runOneWideAbsolute();\r\n      console.table(e1.trials);\r\n      const e2 = runTwoWideCompare();\r\n      console.table(e2.trials);\r\n    });\r\n\r\n    document.body.appendChild(script);\r\n  }, []);\r\n\r\n  return (\r\n    <div>\r\n      <h1>Test Diffusion</h1>\r\n      <div id=\"water-over-time\">\r\n        <h2>width 20 world, water from t=0 to t=1 </h2>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default TestDiffusion;\r\n","import { LevelInfo } from \"core/overworld/levelInfo\";\r\nimport { Environment } from \"../core/environment\";\r\n\r\nexport function environmentFromLevelInfo(info: LevelInfo) {\r\n  // const { rainfall, soilType, temperature } = levelInfo;\r\n\r\n  switch (info.height) {\r\n    case 0:\r\n      return Level0;\r\n    case 1:\r\n      return Temperate;\r\n    case 2:\r\n      return Reservoires;\r\n    case 3:\r\n      return Rocky;\r\n    case 4:\r\n      return SkySoil;\r\n    case 5:\r\n    default:\r\n      return Desert;\r\n  }\r\n  // return Reservoires;\r\n}\r\n\r\nexport const Level0: Environment = {\r\n  airEvaporation: 0.2,\r\n  climate: {\r\n    timeBetweenRainfall: 40,\r\n    rainDuration: 3,\r\n    waterPerSecond: 200,\r\n  },\r\n  secondsToEvaporate: 166,\r\n  floorCo2: 0.85,\r\n  temperaturePerSeason: [51, 56, 52, 43],\r\n  fill: \"Level0\",\r\n};\r\n\r\nexport const Temperate: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    timeBetweenRainfall: 40,\r\n    rainDuration: 2,\r\n    waterPerSecond: 100,\r\n  },\r\n  secondsToEvaporate: 166,\r\n  floorCo2: 0.5,\r\n  temperaturePerSeason: [53, 75, 43, 25],\r\n  fill: \"Temperate\",\r\n};\r\n\r\nexport const Reservoires: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    timeBetweenRainfall: 30,\r\n    rainDuration: 8,\r\n    waterPerSecond: 20,\r\n  },\r\n  secondsToEvaporate: 166,\r\n  floorCo2: 0.5,\r\n  temperaturePerSeason: [53, 75, 43, 25],\r\n  fill: \"Reservoires\",\r\n};\r\n\r\nexport const Rocky: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    timeBetweenRainfall: 83.333,\r\n    rainDuration: 4,\r\n    waterPerSecond: 90,\r\n  },\r\n  secondsToEvaporate: 33,\r\n  floorCo2: 1,\r\n  temperaturePerSeason: [40, 62, 36, 15],\r\n  fill: \"Rocky\",\r\n};\r\n\r\nexport const SkySoil: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    timeBetweenRainfall: 83.333,\r\n    rainDuration: 4,\r\n    waterPerSecond: 90,\r\n  },\r\n  secondsToEvaporate: 33,\r\n  floorCo2: 1,\r\n  temperaturePerSeason: [27, 62, 36, 15],\r\n  fill: \"SkySoil\",\r\n};\r\n\r\nexport const Desert: Environment = {\r\n  airEvaporation: 0.3,\r\n  climate: {\r\n    rainDuration: 7.3333,\r\n    timeBetweenRainfall: 110,\r\n    waterPerSecond: 240,\r\n  },\r\n  secondsToEvaporate: 16,\r\n  floorCo2: 0.95,\r\n  temperaturePerSeason: [69, 84, 98, 24],\r\n  fill: \"Desert\",\r\n};\r\n","import characterSrc from \"assets/images/character.png\";\r\nimport classNames from \"classnames\";\r\nimport React from \"react\";\r\nimport \"./Character.scss\";\r\n\r\nfunction Character(props: JSX.IntrinsicElements[\"img\"] & { size?: \"xs\" | \"small\" | \"medium\" | \"large\" }) {\r\n  const { size, className, ...otherProps } = props;\r\n  return <img className={classNames(\"character\", size, className)} alt=\"\" src={characterSrc} {...otherProps} />;\r\n}\r\n\r\nexport default Character;\r\n","import * as React from \"react\";\r\nimport \"./Glow.scss\";\r\n\r\nexport function Glow() {\r\n  return (\r\n    <div className=\"glow\">\r\n      <span />\r\n    </div>\r\n  );\r\n}\r\n","import fruitSrc from \"assets/images/fruit.png\";\r\nimport classNames from \"classnames\";\r\nimport MP from \"game/ui/common/MP\";\r\nimport { map } from \"math\";\r\nimport * as React from \"react\";\r\nimport { GeneInstance } from \"../../core/cell/geneInstance\";\r\nimport { seasonDisplay, seasonFromTime } from \"../../core/season\";\r\nimport { Cell } from \"../../core/tile\";\r\nimport { GeneFruit, reproducerGetPercentMatured } from \"../../std/genes/GeneReproducer\";\r\nimport { mitoDeath } from \"../audio\";\r\nimport { GameResult } from \"../gameResult\";\r\nimport Character from \"../ui/common/Character\";\r\nimport { Glow } from \"../ui/common/Glow\";\r\nimport \"./GameResultsScreen.scss\";\r\n\r\ninterface GameResultsScreenProps {\r\n  onDone: () => void;\r\n  results: GameResult;\r\n}\r\n\r\nfunction FruitResult({ fruit, mpEarned }: { fruit: GeneInstance<GeneFruit>; mpEarned: number }) {\r\n  const scale = map(reproducerGetPercentMatured(fruit), 0, 1, 0.2, 1);\r\n  const style = React.useMemo(() => {\r\n    return {\r\n      transform: `scale(${scale})`,\r\n    };\r\n  }, [scale]);\r\n  return (\r\n    <div className=\"fruit-info\">\r\n      <div className=\"fruit-visual\">\r\n        {fruit.state.isMature ? <Glow /> : null}\r\n        <img alt=\"\" src={fruitSrc} style={style} />\r\n      </div>\r\n      {fruit.state.timeMatured != null ? (\r\n        <>\r\n          <span className=\"matured-info success\">\r\n            +<MP amount={mpEarned} />\r\n          </span>\r\n          &nbsp;at {seasonDisplay(seasonFromTime(fruit.state.timeMatured))}, Mutation Points earned: 1\r\n        </>\r\n      ) : (\r\n        <span className=\"matured-info in-progress\">\r\n          {(reproducerGetPercentMatured(fruit) * 100).toFixed(0)}% maturity\r\n        </span>\r\n      )}\r\n      , started at {seasonDisplay(seasonFromTime(fruit.cell.timeMade))}.\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ReproductiveCellResult({ cell, mpEarned }: { cell: Cell; mpEarned: number }) {\r\n  const fruit = cell.findGene(GeneFruit);\r\n  if (fruit != null) {\r\n    return <FruitResult fruit={fruit} mpEarned={mpEarned} />;\r\n  } else {\r\n    return (\r\n      <div>\r\n        {cell.toString()} +<MP amount={mpEarned} />\r\n      </div>\r\n    );\r\n  }\r\n}\r\n\r\nfunction MPEarnerList({ results, className }: { results: GameResult; className?: string }) {\r\n  return (\r\n    <div className={classNames(\"mp-earner-list\", className)}>\r\n      <h5>Reproductive Cells</h5>\r\n      <div>\r\n        {Array.from(results.mpEarners.entries()).map(([cell, mpEarned]) => (\r\n          <ReproductiveCellResult cell={cell} mpEarned={mpEarned} />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction GameWonScreen({ results }: GameResultsScreenProps) {\r\n  const winDescription =\r\n    Array.from(results.mpEarners.entries()).filter(([c, mp]) => mp > 0).length < 3 ? \"survived\" : \"thrived\";\r\n  return (\r\n    <>\r\n      <div className=\"character-container\">\r\n        <Character size=\"large\" className=\"dance\" />\r\n      </div>\r\n      <h1>You {winDescription}!</h1>\r\n      <h2>{results.mutationPointsPerEpoch} Mutation Points earned.</h2>\r\n      <div className=\"vignettes\">\r\n        {results.vignettes?.map((v) => (\r\n          <img src={v.toDataURL()} alt=\"\" />\r\n        ))}\r\n      </div>\r\n      <MPEarnerList results={results} />\r\n    </>\r\n  );\r\n}\r\n\r\nfunction GameLostScreen({ results }: GameResultsScreenProps) {\r\n  React.useEffect(() => {\r\n    mitoDeath.play();\r\n    return () => {\r\n      mitoDeath.stop();\r\n    };\r\n  }, []);\r\n  return (\r\n    <>\r\n      <div className=\"character-container\">\r\n        <Character className=\"sad\" size=\"large\" />\r\n      </div>\r\n      <h1>\r\n        <i>{results.world.species.name}</i> couldn't survive!\r\n      </h1>\r\n      <div>You survived until {seasonDisplay(results.world.season)}!</div>\r\n      <div className=\"vignettes\">\r\n        {results.vignettes?.map((v) => (\r\n          <img src={v.toDataURL()} alt=\"\" />\r\n        ))}\r\n      </div>\r\n      <MPEarnerList results={results} className=\"dark\" />\r\n    </>\r\n  );\r\n}\r\n\r\nexport default function GameResultsScreen({ onDone, results }: GameResultsScreenProps) {\r\n  return (\r\n    <div className={`game-results-screen ${results.status}`}>\r\n      <div className=\"game-results-content\">\r\n        {results.status === \"won\" ? (\r\n          <GameWonScreen onDone={onDone} results={results} />\r\n        ) : (\r\n          <GameLostScreen onDone={onDone} results={results} />\r\n        )}\r\n        <button className=\"done-button\" onClick={onDone}>\r\n          Continue \r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { GameResult } from \"game/gameResult\";\r\nimport React from \"react\";\r\nimport { Temperate } from \"std/environments\";\r\nimport { GeneFruit } from \"std/genes/GeneReproducer\";\r\nimport { standardGenome } from \"std/genomes/standardGenome\";\r\nimport { Vector2 } from \"three\";\r\nimport { World } from \"../core\";\r\nimport { newBaseSpecies } from \"../core/species\";\r\nimport { Cell } from \"../core/tile\";\r\nimport GameResultsScreen from \"../game/screens/GameResultsScreen\";\r\n\r\nexport function mockFruit(world: World, percent: number, timeMatured?: number) {\r\n  const cellTypeFruit = standardGenome.cellTypes[4];\r\n  const cell = new Cell(new Vector2(0, 0), world, cellTypeFruit);\r\n  const fruit = cell.findGene(GeneFruit)!;\r\n  fruit.state.committedResources.add(\r\n    (fruit.props.neededResources * percent) / 2,\r\n    (fruit.props.neededResources * percent) / 2\r\n  );\r\n  fruit.state.timeMatured = timeMatured;\r\n  fruit.state.isMature = percent === 1;\r\n  return cell;\r\n}\r\n\r\nexport function TestWinScreen() {\r\n  const world = new World(Temperate, 0, newBaseSpecies());\r\n  const f1 = mockFruit(world, 1, 250);\r\n  const f2 = mockFruit(world, 0.4);\r\n  const f3 = mockFruit(world, 1, 900);\r\n  const mockResults: GameResult = {\r\n    status: \"won\",\r\n    mpEarners: new Map([\r\n      [f1, 3],\r\n      [f2, 0],\r\n      [f3, 3],\r\n    ]),\r\n    mutationPointsPerEpoch: 6,\r\n    world,\r\n  };\r\n  return <GameResultsScreen results={mockResults} onDone={() => {}} />;\r\n}\r\n","import { TIME_PER_DAY } from \"core/constants\";\r\nimport { GameResult } from \"game/gameResult\";\r\nimport React from \"react\";\r\nimport { Temperate } from \"std/environments\";\r\nimport { World } from \"../core\";\r\nimport { newBaseSpecies } from \"../core/species\";\r\nimport GameResultsScreen from \"../game/screens/GameResultsScreen\";\r\nimport { mockFruit } from \"./TestWinScreen\";\r\n\r\nexport function TestLoseScreen() {\r\n  const world = new World(Temperate, 0, newBaseSpecies());\r\n  world.time = TIME_PER_DAY * 4;\r\n  const f1 = mockFruit(world, 0.4);\r\n  world.time = TIME_PER_DAY * 9;\r\n  const f2 = mockFruit(world, 0.3);\r\n  world.time = TIME_PER_DAY * 19;\r\n  const f3 = mockFruit(world, 0.01459);\r\n  const mockResults: GameResult = {\r\n    mpEarners: new Map([\r\n      [f1, 0],\r\n      [f2, 0],\r\n      [f3, 0],\r\n    ]),\r\n    status: \"lost\",\r\n    mutationPointsPerEpoch: 0,\r\n    world,\r\n  };\r\n  return <GameResultsScreen results={mockResults} onDone={() => {}} />;\r\n}\r\n","import React, { useContext } from \"react\";\r\n\r\nexport const MousePositionContext = React.createContext({\r\n  x: window.innerWidth / 2,\r\n  y: window.innerHeight / 2,\r\n});\r\n\r\nfunction useMousePosition() {\r\n  return useContext(MousePositionContext);\r\n}\r\n\r\nexport default useMousePosition;\r\n","import { randInt } from \"math\";\r\nimport { arrayRange } from \"math/arrays\";\r\nimport { AllGenesByName } from \"../../../core/cell/gene\";\r\n\r\nexport function generateRandomGenes(numGenes = 20) {\r\n  const AllGenes = Array.from(AllGenesByName.values());\r\n  return arrayRange(numGenes).map(() => {\r\n    const randomGene = AllGenes[randInt(0, AllGenes.length - 1)];\r\n    return randomGene.level(randInt(0, randomGene.blueprint.levelCosts.length - 1));\r\n  });\r\n}\r\n","import { HexTile } from \"core/overworld/hexTile\";\r\nimport { lineage, Species } from \"core/species\";\r\nimport { GameResult } from \"game/gameResult\";\r\nimport { generateRandomGenes } from \"game/ui/GenomeViewer/generateRandomGenes\";\r\nimport React, { useContext } from \"react\";\r\nimport { AppState, PopulationAttempt } from \"./state\";\r\n\r\ntype AppReducerContextType = [AppState, React.Dispatch<AppActions>];\r\n\r\nexport const AppReducerContext = React.createContext<AppReducerContextType>(null!);\r\n\r\nexport function useAppReducer(): AppReducerContextType {\r\n  return useContext(AppReducerContext);\r\n}\r\n\r\nexport function reducer(state: AppState, action: AppActions): AppState {\r\n  switch (action.type) {\r\n    case \"AAUpdateSpecies\":\r\n      return {\r\n        ...state,\r\n        // species: {\r\n        //   ...state.species,\r\n        //   [action.species.id]: action.species,\r\n        // },\r\n      };\r\n    case \"AAStartPopulationAttempt\":\r\n      return handleStartPopulationAttempt(state, action);\r\n    case \"AAPopulationAttemptSuccess\":\r\n      return handlePopulationAttemptSuccess(state, action);\r\n    case \"AANextEpoch\":\r\n      return handleNextEpoch(state, action);\r\n    case \"AAGetGameResult\":\r\n      return handleGetGameResult(state, action);\r\n    case \"AAGameResultDone\":\r\n      return handleGameResultDone(state, action);\r\n    case \"AATransitionStart\":\r\n      return handleTransitionStart(state, action);\r\n    case \"AATransitionEnd\":\r\n      // no-op; this must be handled in the middleware\r\n      return state;\r\n    // return handleTransitionEnd(state, action);\r\n  }\r\n}\r\n\r\nexport type AppActions =\r\n  | AAUpdateSpecies\r\n  | AAStartPopulationAttempt\r\n  | AAPopulationAttemptSuccess\r\n  | AANextEpoch\r\n  | AAGetGameResult\r\n  | AAGameResultDone\r\n  | AATransitionStart\r\n  | AATransitionEnd;\r\n\r\nexport interface AAUpdateSpecies {\r\n  type: \"AAUpdateSpecies\";\r\n  species: Species;\r\n}\r\n\r\nexport interface AAStartPopulationAttempt {\r\n  type: \"AAStartPopulationAttempt\";\r\n  populationAttempt: PopulationAttempt;\r\n}\r\n\r\nfunction handleStartPopulationAttempt(state: AppState, action: AAStartPopulationAttempt): AppState {\r\n  const populationAttempt = action.populationAttempt;\r\n  const { targetHex, sourceHex } = populationAttempt;\r\n\r\n  if (!targetHex.info.visible) {\r\n    return state;\r\n  }\r\n  if (sourceHex != null) {\r\n    if (sourceHex.info.flora == null) {\r\n      console.error(\"sourceHex isn't null but the flora is null\");\r\n      return state;\r\n    }\r\n  }\r\n\r\n  return {\r\n    ...state,\r\n    activePopulationAttempt: action.populationAttempt,\r\n  };\r\n}\r\n\r\nexport interface AAFinishLevel {\r\n  type: \"AAFinishLevel\";\r\n  level: HexTile;\r\n  species: Species;\r\n  result: GameResult;\r\n}\r\n\r\nexport interface AAPopulationAttemptSuccess {\r\n  type: \"AAPopulationAttemptSuccess\";\r\n  attempt?: PopulationAttempt;\r\n  results: GameResult;\r\n}\r\n\r\nfunction handlePopulationAttemptSuccess(state: AppState, action: AAPopulationAttemptSuccess): AppState {\r\n  const { attempt = state.activePopulationAttempt!, results } = action;\r\n  const { targetHex, settlingSpecies } = attempt;\r\n\r\n  // populate target hex\r\n  let oldSpecies: Species | undefined = undefined;\r\n  if (targetHex.info.flora != null) {\r\n    oldSpecies = targetHex.info.flora.species;\r\n  }\r\n  targetHex.info.flora = {\r\n    species: settlingSpecies,\r\n    mutationPointsPerEpoch: results.mutationPointsPerEpoch,\r\n  };\r\n  settlingSpecies.totalMutationPoints = state.overWorld.getMaxGenePool(settlingSpecies);\r\n  settlingSpecies.geneOptions.push(...generateRandomGenes(3));\r\n  if (oldSpecies) {\r\n    // update old species mutation point pool cache\r\n    oldSpecies.totalMutationPoints = state.overWorld.getMaxGenePool(oldSpecies);\r\n  }\r\n\r\n  // bump visibility\r\n  for (const n of state.overWorld.hexNeighbors(targetHex)) {\r\n    n && (n.info.visible = true);\r\n  }\r\n\r\n  // things we changed:\r\n  // sourceHex\r\n  // targetHex\r\n  // oldSpecies\r\n  // settlingSpecies\r\n  // targetHex.neighbors\r\n  return { ...state };\r\n}\r\n\r\nexport interface AANextEpoch {\r\n  type: \"AANextEpoch\";\r\n}\r\n\r\nfunction handleNextEpoch(state: AppState, action: AANextEpoch): AppState {\r\n  // +1 epoch:\r\n  // reset all species pools to max\r\n  for (const species of lineage(state.rootSpecies)) {\r\n    species.freeMutationPoints = species.totalMutationPoints;\r\n  }\r\n  return {\r\n    ...state,\r\n    epoch: state.epoch + 1,\r\n  };\r\n}\r\n\r\nexport interface AAGetGameResult {\r\n  type: \"AAGetGameResult\";\r\n  result: GameResult;\r\n}\r\n\r\nfunction handleGetGameResult(state: AppState, action: AAGetGameResult): AppState {\r\n  // if (state.activePopulationAttempt == null) {\r\n  //   throw new Error(\"activePopulationAttempt shouldn't be null during handleWinLoss\");\r\n  // }\r\n  if (action.result.status === \"won\") {\r\n    state = handlePopulationAttemptSuccess(state, {\r\n      type: \"AAPopulationAttemptSuccess\",\r\n      attempt: state.activePopulationAttempt,\r\n      results: action.result,\r\n    });\r\n  }\r\n  return {\r\n    ...state,\r\n    activeGameResult: action.result,\r\n  };\r\n}\r\n\r\nexport interface AAGameResultDone {\r\n  type: \"AAGameResultDone\";\r\n}\r\n\r\nfunction handleGameResultDone(state: AppState, action: AAGameResultDone): AppState {\r\n  return {\r\n    ...state,\r\n    activePopulationAttempt: undefined,\r\n    activeGameResult: undefined,\r\n  };\r\n}\r\n\r\nexport interface AATransitionStart {\r\n  type: \"AATransitionStart\";\r\n  transition: AppActions;\r\n}\r\n\r\nfunction handleTransitionStart(state: AppState, action: AATransitionStart): AppState {\r\n  return {\r\n    ...state,\r\n    transition: action.transition,\r\n  };\r\n}\r\n\r\nexport interface AATransitionEnd {\r\n  type: \"AATransitionEnd\";\r\n}\r\n","import { Tile } from \"core/tile\";\r\nimport { createSimpleSchema, object } from \"serializr\";\r\nimport { Vector2 } from \"three\";\r\nimport { World } from \".\";\r\nimport { TileGeneratorName } from \"../std/tileGenerators\";\r\n\r\nexport interface Environment {\r\n  airEvaporation: number;\r\n  climate: {\r\n    timeBetweenRainfall: number;\r\n    rainDuration: number;\r\n    waterPerSecond: number;\r\n  };\r\n  secondsToEvaporate: number;\r\n  floorCo2: number;\r\n  temperaturePerSeason: number[];\r\n  fill: TileGeneratorName | TileGenerator;\r\n}\r\n\r\nexport type TileGenerator = (pos: Vector2, world: World) => Tile | undefined;\r\n\r\nexport const EnvironmentSchema = createSimpleSchema<Environment>({\r\n  climate: object(createSimpleSchema({ \"*\": true })),\r\n  \"*\": true,\r\n});\r\n","import { EnvironmentSchema } from \"core/environment\";\r\nimport { createSimpleSchema, object, primitive, reference } from \"serializr\";\r\nimport { Species, SpeciesSchema } from \"../species\";\r\n\r\nexport interface LevelInfo {\r\n  seed: number;\r\n  height: number; // [-1 to 6], integers only\r\n  temperature: \"cold\" | \"temperate\" | \"hot\";\r\n  rainfall: \"low\" | \"medium\" | \"high\";\r\n  soilType: \"barren\" | \"average\" | \"fertile\";\r\n  // wind: \"low\" | \"medium\" | \"high\";\r\n  visible: boolean;\r\n  flora?: {\r\n    species: Species;\r\n    mutationPointsPerEpoch: number;\r\n  };\r\n}\r\n\r\nexport const LevelInfoSchema = createSimpleSchema<LevelInfo>({\r\n  // \"*\": true,\r\n  seed: primitive(),\r\n  height: primitive(),\r\n  temperature: primitive(),\r\n  rainfall: primitive(),\r\n  soilType: primitive(),\r\n  wind: primitive(),\r\n  visible: primitive(),\r\n  environment: object(EnvironmentSchema),\r\n\r\n  flora: object(\r\n    createSimpleSchema({\r\n      species: reference(SpeciesSchema),\r\n      mutationPointsPerEpoch: primitive(),\r\n      actionPoints: primitive(),\r\n    })\r\n  ),\r\n});\r\n","import { identifier, object, serializable } from \"serializr\";\r\nimport uuid from \"uuid\";\r\nimport { LevelInfo, LevelInfoSchema } from \"./levelInfo\";\r\n\r\nconst C = Math.sqrt(3) / 2;\r\n\r\nexport class HexTile {\r\n  @serializable(identifier())\r\n  private uuid = uuid();\r\n\r\n  @serializable(object(LevelInfoSchema))\r\n  info: LevelInfo = {\r\n    seed: Math.random() * Number.MAX_SAFE_INTEGER,\r\n    height: 0,\r\n    rainfall: \"medium\",\r\n    soilType: \"average\",\r\n    temperature: \"temperate\",\r\n    // wind: \"low\",\r\n    visible: false,\r\n  };\r\n\r\n  @serializable\r\n  public i: number;\r\n\r\n  @serializable\r\n  public j: number;\r\n\r\n  // Handle 0 arg constructor from serializr\r\n  constructor(i?: number, j?: number) {\r\n    this.i = i!;\r\n    this.j = j!;\r\n  }\r\n\r\n  get cartesian() {\r\n    const { i, j } = this;\r\n    // simplified version:\r\n    // x = i - 0.5j - 0.5*-(i + j)\r\n    // x = i - 0.5j + 0.5i + 0.5j\r\n    // x = 1.5i\r\n    // y = Cj - C*-(i + j)\r\n    // y = Cj + Ci + Cj\r\n    // y = 2Cj + Ci\r\n    return {\r\n      x: 1.5 * i,\r\n      y: 2 * C * j + C * i,\r\n    };\r\n  }\r\n\r\n  get isHabitable() {\r\n    return this.info.height !== -1;\r\n  }\r\n\r\n  get k() {\r\n    return -(this.i + this.j);\r\n  }\r\n\r\n  get magnitude() {\r\n    return Math.abs(this.i) + Math.abs(this.j) + Math.abs(this.k);\r\n  }\r\n}\r\n","import { map, object, serializable } from \"serializr\";\r\nimport { HexTile } from \"./hexTile\";\r\n\r\nexport class HexStore {\r\n  @serializable(map(object(HexTile)))\r\n  tiles: { [k: string]: HexTile } = {};\r\n\r\n  private hash(i: number, j: number) {\r\n    return `${i},${j}`;\r\n  }\r\n\r\n  get(i: number, j: number): HexTile | undefined {\r\n    return this.tiles[this.hash(i, j)];\r\n  }\r\n\r\n  set(i: number, j: number, tile: HexTile) {\r\n    this.tiles[this.hash(i, j)] = tile;\r\n  }\r\n\r\n  *[Symbol.iterator]() {\r\n    for (const key in this.tiles) {\r\n      yield this.tiles[key];\r\n    }\r\n  }\r\n}\r\n","import { Species } from \"core/species\";\r\nimport { object, reference, serializable } from \"serializr\";\r\nimport SimplexNoise from \"simplex-noise\";\r\nimport { HexStore } from \"./hexStore\";\r\nimport { HexTile } from \"./hexTile\";\r\n\r\nexport class OverWorld {\r\n  @serializable(object(HexStore))\r\n  storage: HexStore;\r\n\r\n  @serializable(reference(HexTile))\r\n  startTile: HexTile;\r\n\r\n  constructor(storage?: HexStore, startTile?: HexTile) {\r\n    this.storage = storage!;\r\n    this.startTile = startTile!;\r\n\r\n    // ensure the start tile is visible\r\n    if (this.startTile) {\r\n      this.startTile.info.visible = true;\r\n    }\r\n  }\r\n\r\n  private static randomHeight(tile: HexTile, noise: SimplexNoise) {\r\n    const { x, y } = tile.cartesian;\r\n    let height = 0;\r\n    height += (noise.noise3D(x / 24, y / 24, 0) - 0.2) * 6;\r\n    height += noise.noise3D(x / 24, y / 24, 1.453) * 6;\r\n    height += noise.noise3D(x / 6, y / 6, 1.453) * 1.5;\r\n    height += 1;\r\n    // info.height += 4 - Math.abs(tile.magnitude * tile.magnitude) * 0.02;\r\n    height -= Math.abs(y * y) * 0.025;\r\n    if (height < 0 && height >= -1) {\r\n      height = 0;\r\n    }\r\n    height = Math.round(Math.max(Math.min(height, 6), -1));\r\n    return height;\r\n  }\r\n\r\n  private static populateLevelInfo(tile: HexTile, noise: SimplexNoise) {\r\n    const { info } = tile;\r\n    info.height = OverWorld.randomHeight(tile, noise);\r\n  }\r\n\r\n  static generateFilledHex(maxDist: number = 20): OverWorld {\r\n    const storage = new HexStore();\r\n    const noise = new SimplexNoise();\r\n    // the rule is: i + j + k = 0\r\n    // abs(i) <= maxDist\r\n    // abs(j) <= maxDist\r\n    // abs(k) <= maxDist\r\n    for (let i = -maxDist; i <= maxDist; i++) {\r\n      for (let j = -maxDist; j <= maxDist; j++) {\r\n        let k = -(i + j);\r\n        if (Math.abs(k) > maxDist) {\r\n          continue;\r\n        }\r\n        const tile = new HexTile(i, j);\r\n        OverWorld.populateLevelInfo(tile, noise);\r\n        storage.set(i, j, tile);\r\n      }\r\n    }\r\n    const startTile = OverWorld.getDefaultStartTile(storage);\r\n    return new OverWorld(storage, startTile);\r\n  }\r\n\r\n  static generateRectangle(width: number = 50, height: number = 25): OverWorld {\r\n    const storage = new HexStore();\r\n    const noise = new SimplexNoise();\r\n    // the rule is: i + j + k = 0\r\n    // abs(i) <= maxDist\r\n    // abs(j) <= maxDist\r\n    // abs(k) <= maxDist\r\n    const maxDist = Math.max(width / 2, height / 2);\r\n\r\n    for (let i = -maxDist; i <= maxDist; i++) {\r\n      for (let j = -maxDist; j <= maxDist; j++) {\r\n        let k = -(i + j);\r\n        if (Math.abs(k) > maxDist) {\r\n          continue;\r\n        }\r\n        const tile = new HexTile(i, j);\r\n        const { x, y } = tile.cartesian;\r\n        if (x < -width / 2 || x > width / 2 || y < -height / 2 || y > height / 2) {\r\n          continue;\r\n        }\r\n\r\n        OverWorld.populateLevelInfo(tile, noise);\r\n        storage.set(i, j, tile);\r\n      }\r\n    }\r\n\r\n    const startTile = OverWorld.getDefaultStartTile(storage);\r\n    return new OverWorld(storage, startTile);\r\n  }\r\n\r\n  static getDefaultStartTile(storage?: HexStore) {\r\n    if (storage == null) {\r\n      return undefined;\r\n    }\r\n    const tiles = Array.from(storage);\r\n    return tiles.filter((t) => t.info.height === 0).sort((t1, t2) => t1.magnitude - t2.magnitude)[0];\r\n  }\r\n\r\n  /**\r\n   * store neighbors at angles [30, 90, 150, 210, 270, 330]\r\n   *\r\n   * 30: (1, 0, -1)\r\n   *\r\n   * 90: (0, 1, -1)\r\n   *\r\n   * 150: (-1, 1, 0)\r\n   *\r\n   * 210: (-1, 0, 1)\r\n   *\r\n   * 270: (0, -1, 1)\r\n   *\r\n   * 330: (1, -1, 0)\r\n   */\r\n  public hexNeighbors(hex: HexTile) {\r\n    const { i, j } = hex;\r\n    const neighbors: (HexTile | undefined)[] = [];\r\n    neighbors[0] = this.storage.get(i + 1, j);\r\n    neighbors[1] = this.storage.get(i, j + 1);\r\n    neighbors[2] = this.storage.get(i - 1, j + 1);\r\n    neighbors[3] = this.storage.get(i - 1, j);\r\n    neighbors[4] = this.storage.get(i, j - 1);\r\n    neighbors[5] = this.storage.get(i + 1, j - 1);\r\n    return neighbors;\r\n  }\r\n\r\n  /**\r\n   * For a given target hex, find the source hexes that\r\n   * can migrate into it.\r\n   */\r\n  public possibleMigrationSources(target: HexTile) {\r\n    const populatedActiveNeighbors = this.hexNeighbors(target).filter((hex) => {\r\n      return hex?.info.flora != null;\r\n    }) as HexTile[];\r\n    if (target.info.flora == null) {\r\n      // if the target is unpopulated, allow any neighbor to migrate into it\r\n      return populatedActiveNeighbors;\r\n    } else {\r\n      // if the target is already populated, disallow \"migration\" from the same source species\r\n      return populatedActiveNeighbors.filter((s) => s != null && s.info.flora!.species !== target.info.flora!.species);\r\n    }\r\n  }\r\n\r\n  public possibleMigrationTargets(source: HexTile) {\r\n    if (source.info.flora == null) {\r\n      console.error(\"can't migrate from a null flora source\");\r\n      return [];\r\n    }\r\n    const unpopulatedNeighbors = this.hexNeighbors(source).filter((hex) => {\r\n      // find neighbors that are either:\r\n      //  unpopulated, or\r\n      //  populated but with a different species\r\n      return hex != null && (hex.info.flora == null || hex.info.flora.species !== source.info.flora!.species);\r\n    }) as HexTile[];\r\n    return unpopulatedNeighbors;\r\n  }\r\n\r\n  public getStartHex() {\r\n    return this.startTile;\r\n  }\r\n\r\n  public hexAt(i: number, j: number) {\r\n    return this.storage.get(i, j);\r\n  }\r\n\r\n  *[Symbol.iterator]() {\r\n    for (const tile of this.storage) {\r\n      yield tile;\r\n    }\r\n  }\r\n\r\n  getMaxGenePool(species: Species) {\r\n    let pool = 0;\r\n    for (const tile of this.storage) {\r\n      const { flora } = tile.info;\r\n      if (flora && flora.species === species) {\r\n        pool += flora.mutationPointsPerEpoch;\r\n      }\r\n    }\r\n    return pool;\r\n  }\r\n}\r\n","import { GameResult } from \"game/gameResult\";\r\nimport { createSimpleSchema, object, reference } from \"serializr\";\r\nimport { HexTile } from \"../../core/overworld/hexTile\";\r\nimport { OverWorld } from \"../../core/overworld/overWorld\";\r\nimport { Species, SpeciesSchema } from \"../../core/species\";\r\nimport { AppActions } from \"./reducer\";\r\n\r\n/**\r\n * For now, we mutate classes and manually call dummy placeholder\r\n * actions to get a state update.\r\n */\r\nexport interface AppState {\r\n  overWorld: OverWorld;\r\n  /**\r\n   * Determines whether we're in the game or in the overworld.\r\n   *\r\n   * Null activeLevel means we're in overworld.\r\n   * Non-null means we're in-game, or in the game results screen.\r\n   */\r\n  activePopulationAttempt?: PopulationAttempt;\r\n  /**\r\n   * Determines whether to show the game over screen. While non-null,\r\n   * we show a game result screen.\r\n   */\r\n  activeGameResult?: GameResult;\r\n  rootSpecies: Species;\r\n  // species: Record<string, Species>;\r\n  epoch: number;\r\n  transition?: AppActions;\r\n}\r\n\r\nexport interface PopulationAttempt {\r\n  sourceHex?: HexTile;\r\n  targetHex: HexTile;\r\n  settlingSpecies: Species;\r\n}\r\n\r\nexport const PopulationAttemptSchema = createSimpleSchema<PopulationAttempt>({\r\n  sourceHex: reference(HexTile),\r\n  targetHex: reference(HexTile),\r\n  settlingSpecies: reference(SpeciesSchema),\r\n});\r\n\r\nexport const AppStateSchema = createSimpleSchema<AppState>({\r\n  overWorld: object(OverWorld),\r\n  // no active population attempt\r\n  // activePopulationAttempt: object(PopulationAttemptSchema),\r\n  // no activeGameResult\r\n  rootSpecies: object(SpeciesSchema),\r\n  epoch: true,\r\n});\r\n","import localforage from \"localforage\";\r\nimport { deserialize, serialize } from \"serializr\";\r\nimport { AppActions } from \"./reducer\";\r\nimport { AppState, AppStateSchema } from \"./state\";\r\n\r\nconst GAME_DATA_KEY = \"gameData\";\r\n\r\nexport function save(appState: AppState) {\r\n  const json = serialize(AppStateSchema, appState);\r\n  console.log(\"saved json\", json);\r\n  const stringToSave = JSON.stringify(json);\r\n  return localforage.setItem(GAME_DATA_KEY, stringToSave);\r\n}\r\n\r\nexport async function load(): Promise<AppState> {\r\n  const string = await localforage.getItem<string>(GAME_DATA_KEY);\r\n  const json = JSON.parse(string);\r\n  const appState = deserialize(AppStateSchema, json);\r\n  return appState;\r\n}\r\n\r\nexport function resetGame() {\r\n  const confirm = window.confirm(\"Are you sure you want to reset your whole game?\");\r\n  if (confirm) {\r\n    return localforage.removeItem(GAME_DATA_KEY).then(() => {\r\n      window.location.reload();\r\n    });\r\n  } else {\r\n    return Promise.reject();\r\n  }\r\n}\r\n\r\nconst ACTIONS_TO_SAVE_ON: Partial<Record<AppActions[\"type\"], true>> = {\r\n  AAGameResultDone: true,\r\n  AAGetGameResult: true,\r\n  AAUpdateSpecies: true,\r\n  AANextEpoch: true,\r\n  AAPopulationAttemptSuccess: true,\r\n  AAStartPopulationAttempt: true,\r\n};\r\n\r\nexport function saveOnActionMiddleware(reducer: React.Reducer<AppState, AppActions>) {\r\n  return (state: AppState, action: AppActions) => {\r\n    const newState = reducer(state, action);\r\n    if (ACTIONS_TO_SAVE_ON.hasOwnProperty(action.type)) {\r\n      console.log(\"saved from\", action);\r\n      save(newState);\r\n    }\r\n    return newState;\r\n  };\r\n}\r\n","import React from \"react\";\r\nimport classNames from \"classnames\";\r\n\r\nimport \"./Button.scss\";\r\n\r\nexport function Button(props: JSX.IntrinsicElements[\"button\"] & { color?: \"purple\" | \"green\" }) {\r\n  return (\r\n    <button {...props} className={classNames(\"button\", props.className, props.color || \"purple\")}>\r\n      {props.children}\r\n    </button>\r\n  );\r\n}\r\n","// import useMouse from \"@rooks/use-mouse\";\r\nimport useBoundingclientrectRef from \"@rooks/use-boundingclientrect-ref\";\r\nimport classNames from \"classnames\";\r\nimport React from \"react\";\r\nimport useMousePosition from \"../../../common/useMousePosition\";\r\nimport \"./LookAtMouse.scss\";\r\n\r\ninterface LookAtMouseProps {\r\n  displayBlock?: boolean;\r\n  zScale?: number;\r\n}\r\n\r\nfunction LookAtMouse(props: JSX.IntrinsicElements[\"div\"] & LookAtMouseProps) {\r\n  const mouse = useMousePosition();\r\n  const [ref, size] = useBoundingclientrectRef() as any;\r\n  const { displayBlock = false, children, className, zScale = 5, ...restProps } = props;\r\n\r\n  const z = window.innerWidth * zScale;\r\n\r\n  const style = React.useMemo(() => {\r\n    if (size != null) {\r\n      const midX = size.left + size.width / 2;\r\n      const midY = size.top + size.height / 2;\r\n\r\n      const ox = mouse.x - midX;\r\n      const oy = mouse.y - midY;\r\n      // const rotY = Math.atan((ox * 2) / clientRect.width);\r\n      // const rotX = Math.atan(-(oy * 2) / clientRect.height);\r\n\r\n      const rotY = Math.atan((ox * 2) / z);\r\n      const rotX = Math.atan(-(oy * 2) / z);\r\n      const s: React.CSSProperties = {\r\n        transform: `perspective(525px) rotateX(${rotX}rad) rotateY(${rotY}rad)`,\r\n      };\r\n      return s;\r\n    } else {\r\n      return {};\r\n    }\r\n  }, [mouse.x, mouse.y, size, z]);\r\n\r\n  return (\r\n    <div ref={ref} className={classNames(\"look-at-mouse\", className, { \"display-block\": displayBlock })} {...restProps}>\r\n      <div className=\"look-at-mouse-transform\" style={style}>\r\n        {children}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default LookAtMouse;\r\n","import LookAtMouse from \"game/ui/common/LookAtMouse\";\r\nimport React, { useCallback } from \"react\";\r\nimport { Species } from \"../../../core/species\";\r\nimport Character from \"../common/Character\";\r\nimport MP from \"../common/MP\";\r\nimport \"./SpeciesNode.scss\";\r\n\r\nexport interface SpeciesNodeProps {\r\n  species: Species;\r\n  onMutate: (m: Species) => void;\r\n}\r\n\r\nfunction SpeciesNode({ species, onMutate }: SpeciesNodeProps) {\r\n  const descendants =\r\n    species.descendants.length > 0 ? (\r\n      <div className=\"descendants-container\">\r\n        {species.descendants.map((s, i) => (\r\n          <SpeciesNode key={i} species={s} onMutate={onMutate} />\r\n        ))}\r\n      </div>\r\n    ) : null;\r\n  const handleClick = useCallback(() => {\r\n    onMutate(species);\r\n  }, [onMutate, species]);\r\n  return (\r\n    <div className=\"species-node\">\r\n      {descendants}\r\n      <LookAtMouse zScale={5} onClick={handleClick}>\r\n        <div className=\"species-info\">\r\n          <div className=\"species-info-name\">{species.name}</div>\r\n          <div className=\"species-info-animation\">\r\n            <Character size=\"small\" />\r\n          </div>\r\n          <MP amount={species.freeMutationPoints} />\r\n        </div>\r\n      </LookAtMouse>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default SpeciesNode;\r\n","import { useAppReducer } from \"game/app\";\r\nimport React from \"react\";\r\nimport { Species } from \"../../../core/species\";\r\nimport \"./PhylogeneticTree.scss\";\r\nimport SpeciesNode from \"./SpeciesNode\";\r\n\r\ninterface PhylogeneticTreeProps {\r\n  onMutate: (s: Species) => void;\r\n}\r\n\r\nfunction PhylogeneticTree({ onMutate }: PhylogeneticTreeProps) {\r\n  const [{ rootSpecies }] = useAppReducer();\r\n  return (\r\n    <div className=\"phylogenetic-tree\">\r\n      <div className=\"title\">Phylogenetic Tree</div>\r\n      <div className=\"tree-nodes\">\r\n        <SpeciesNode species={rootSpecies} onMutate={onMutate} />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default PhylogeneticTree;\r\n","import classNames from \"classnames\";\r\nimport { useAppReducer } from \"game/app\";\r\nimport DynamicNumber from \"game/ui/common/DynamicNumber\";\r\nimport React, { useState } from \"react\";\r\nimport { GiSandsOfTime } from \"react-icons/gi\";\r\nimport { HexTile } from \"../../../core/overworld/hexTile\";\r\nimport \"./EpochUI.scss\";\r\n\r\nexport function EpochUI({ onNextEpoch, onFocusHex }: EpochUIProps) {\r\n  const [{ epoch }] = useAppReducer();\r\n  const [transitioning, setTransitioning] = useState(false);\r\n  const handleNextEpoch = () => {\r\n    setTransitioning(true);\r\n    setTimeout(() => setTransitioning(false), 5000);\r\n    onNextEpoch();\r\n  };\r\n  return (\r\n    <div className={classNames(\"epoch-display\", { \"ready-to-advance\": false, transitioning })}>\r\n      <span className=\"number\">\r\n        <DynamicNumber sigFigs={6} value={epoch * 1e6} speed={0.08} /> Years\r\n      </span>\r\n      <button className=\"button-next-epoch\" onClick={handleNextEpoch} disabled={transitioning}>\r\n        <GiSandsOfTime className=\"icon\" />\r\n      </button>\r\n    </div>\r\n  );\r\n}\r\nexport interface EpochUIProps {\r\n  onNextEpoch: () => void;\r\n  onFocusHex: (hex: HexTile) => void;\r\n}\r\n","import { Vector2 } from \"three\";\r\n\r\n// https://github.com/beaugunderson/poisson-disc-sampler/blob/master/poisson-disc-sampler.js\r\nexport function poissonDisc({\r\n  width = 1,\r\n  height = 1,\r\n  radius = 0.1,\r\n  max = 1000,\r\n  initialSample = undefined as [number, number] | undefined,\r\n  rng = Math.random,\r\n}): Vector2[] {\r\n  // maximum number of samples before rejection\r\n  var k = 30;\r\n  var radius2 = radius * radius;\r\n  var R = 3 * radius2;\r\n  var cellSize = radius * Math.SQRT1_2;\r\n\r\n  var gridWidth = Math.ceil(width / cellSize);\r\n  var gridHeight = Math.ceil(height / cellSize);\r\n\r\n  var grid = new Array(gridWidth * gridHeight);\r\n\r\n  var queue: number[][] = [];\r\n  var queueSize = 0;\r\n\r\n  var sampleSize = 0;\r\n\r\n  rng = rng || Math.random;\r\n\r\n  function far(x: number, y: number) {\r\n    var i = (x / cellSize) | 0;\r\n    var j = (y / cellSize) | 0;\r\n\r\n    var i0 = Math.max(i - 2, 0);\r\n    var j0 = Math.max(j - 2, 0);\r\n    var i1 = Math.min(i + 3, gridWidth);\r\n    var j1 = Math.min(j + 3, gridHeight);\r\n\r\n    for (j = j0; j < j1; ++j) {\r\n      var o = j * gridWidth;\r\n\r\n      for (i = i0; i < i1; ++i) {\r\n        var s;\r\n\r\n        if ((s = grid[o + i])) {\r\n          var dx = s[0] - x,\r\n            dy = s[1] - y;\r\n\r\n          if (dx * dx + dy * dy < radius2) {\r\n            return false;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function sample(x: number, y: number) {\r\n    const s = [x, y];\r\n\r\n    queue.push(s);\r\n\r\n    grid[gridWidth * ((y / cellSize) | 0) + ((x / cellSize) | 0)] = s;\r\n\r\n    sampleSize++;\r\n    queueSize++;\r\n\r\n    return s;\r\n  }\r\n\r\n  const sampler = function() {\r\n    if (!sampleSize) {\r\n      if (initialSample != null) {\r\n        return sample(initialSample[0], initialSample[1]);\r\n      } else {\r\n        return sample(rng() * width, rng() * height);\r\n      }\r\n    }\r\n\r\n    // Pick a random existing sample and remove it from the queue.\r\n    while (queueSize) {\r\n      var i = (rng() * queueSize) | 0;\r\n      var s = queue[i];\r\n\r\n      // Make a new candidate between [radius, 2 * radius] from the existing\r\n      // sample.\r\n      for (var j = 0; j < k; ++j) {\r\n        var a = 2 * Math.PI * rng();\r\n        var r = Math.sqrt(rng() * R + radius2);\r\n        var x = s[0] + r * Math.cos(a);\r\n        var y = s[1] + r * Math.sin(a);\r\n\r\n        // Reject candidates that are outside the allowed extent,\r\n        // or closer than 2 * radius to any existing sample.\r\n        if (x >= 0 && x < width && y >= 0 && y < height && far(x, y)) {\r\n          return sample(x, y);\r\n        }\r\n      }\r\n\r\n      queue[i] = queue[--queueSize];\r\n      queue.length = queueSize;\r\n    }\r\n  };\r\n\r\n  const samples: Vector2[] = [];\r\n  for (let i = 0; i < max; i++) {\r\n    const sample = sampler();\r\n    // we can't get any more\r\n    if (sample == null) {\r\n      break;\r\n    }\r\n    samples.push(new Vector2(sample[0], sample[1]));\r\n  }\r\n  return samples;\r\n}\r\n","import { poissonDisc } from \"math/poissonDisc\";\r\nimport { Vector2 } from \"three\";\r\nimport { HexTile } from \"../../../core/overworld/hexTile\";\r\nimport { CameraState } from \"./map/OverWorldMap\";\r\n\r\n/**\r\n * Tiled hexes are not square - they are rectangular, where\r\n * the pointy-to-pointy direction is length 1 and the edge-to-edge\r\n * direction is length sqrt(3) / 2. Since we have flat-topped\r\n * hexes, the Y gets the squish factor.\r\n */\r\nexport const Y_SQUISH_FACTOR = Math.sqrt(3) / 2;\r\n\r\nexport function getClickedHexCoords(canvas: HTMLCanvasElement, camera: CameraState, event: React.MouseEvent) {\r\n  const { scale, dX, dY } = camera;\r\n  const cX = canvas.width / 2 + dX;\r\n  const cY = canvas.height / 2 + dY;\r\n\r\n  const e = event.nativeEvent;\r\n  const pxX = e.offsetX;\r\n  const pxY = e.offsetY;\r\n  const x = (pxX - cX) / scale;\r\n  const y = (pxY - cY) / scale;\r\n  // we now have a fractional cartesian coordinates\r\n  // now we flip the equations:\r\n\r\n  // x = 1.5i\r\n  // i = x / 1.5\r\n\r\n  // y = 2Cj + Ci\r\n  // j = (y - Ci) / (2 * C)\r\n\r\n  const i = x / 1.5;\r\n  const j = (y - Y_SQUISH_FACTOR * i) / (2 * Y_SQUISH_FACTOR);\r\n  const k = -(i + j);\r\n\r\n  return roundCubeCoordinates(i, j, k);\r\n}\r\n\r\nexport function roundCubeCoordinates(i: number, j: number, k: number) {\r\n  var rx = Math.round(i);\r\n  var ry = Math.round(j);\r\n  var rz = Math.round(k);\r\n\r\n  var x_diff = Math.abs(rx - i);\r\n  var y_diff = Math.abs(ry - j);\r\n  var z_diff = Math.abs(rz - k);\r\n\r\n  if (x_diff > y_diff && x_diff > z_diff) {\r\n    rx = -ry - rz;\r\n  } else if (y_diff > z_diff) {\r\n    ry = -rx - rz;\r\n  } else {\r\n    rz = -rx - ry;\r\n  }\r\n  return { i: rx, j: ry, k: rz };\r\n}\r\n\r\nexport function pixelPosition(tile: HexTile, camera: CameraState) {\r\n  const { dX, dY, scale } = camera;\r\n  const { x, y } = tile.cartesian;\r\n\r\n  const cX = window.innerWidth / 2 + dX;\r\n  const cY = window.innerHeight / 2 + dY;\r\n  return [cX + x * scale, cY + y * scale];\r\n}\r\n\r\n/**\r\n * Get the camera state that would center the camera on hex with the given scale.\r\n */\r\nexport function getCameraPositionCenteredOn(hex: HexTile, scale: number) {\r\n  const { x, y } = hex.cartesian;\r\n  const cX = window.innerWidth / 2 - x * scale;\r\n  const cY = window.innerHeight / 2 - y * scale;\r\n\r\n  const dX = cX - window.innerWidth / 2;\r\n  const dY = cY - window.innerHeight / 2;\r\n\r\n  return [dX, dY];\r\n}\r\n\r\nexport const randomPointInHexagon = (() => {\r\n  const vectors = [new Vector2(-1, 0), new Vector2(0.5, Y_SQUISH_FACTOR), new Vector2(0.5, -Y_SQUISH_FACTOR)];\r\n\r\n  return (scale: number) => {\r\n    // adapted from https://stackoverflow.com/a/3241819\r\n    const vIndex = Math.floor(Math.random() * 3);\r\n    const [v1, v2] = [vectors[vIndex], vectors[(vIndex + 1) % 3]];\r\n    const [v1Scale, v2Scale] = [Math.random(), Math.random()];\r\n    const [x, y] = [v1Scale * v1.x + v2Scale * v2.x, v1Scale * v1.y + v2Scale * v2.y];\r\n    return new Vector2(x * scale, y * scale);\r\n  };\r\n})();\r\n\r\nexport const generateNaturalRandomHexagonPoints = (radius: number, dropFirst = false) => {\r\n  const width = 2;\r\n  const height = Y_SQUISH_FACTOR * width;\r\n  // const areaAvailable = width * height;\r\n  // const radius = areaAvailable / maxPoints * 0.5; // technically you could get pretty close with .8; but do 0.5 for some more leeway\r\n  const samples = poissonDisc({ width, height, radius, initialSample: [width / 2, height / 2], max: 10000 });\r\n  const normSamples = samples\r\n    .map((s) => {\r\n      s.x -= width / 2;\r\n      s.y -= height / 2;\r\n      return s;\r\n    })\r\n    .filter((s) => isPointInHexagon(s.x, s.y));\r\n  if (dropFirst) {\r\n    normSamples.shift();\r\n  }\r\n  return normSamples;\r\n};\r\n\r\n/**\r\n * Return true if the point is inside a radius 1 hexagon (width 2, height sqrt(3))\r\n */\r\nexport const isPointInHexagon = (() => {\r\n  const RADIUS = 1;\r\n  const HALF_HEIGHT = RADIUS * Y_SQUISH_FACTOR;\r\n  // based on http://www.playchilla.com/how-to-check-if-a-point-is-inside-a-hexagon\r\n  return (x: number, y: number) => {\r\n    // transform the test point locally and to quadrant 2\r\n    const q2x = Math.abs(x);\r\n    const q2y = Math.abs(y);\r\n    // bounding test (since q2 is in quadrant 2 only 2 tests are needed)\r\n    if (q2x > RADIUS || q2y > HALF_HEIGHT) {\r\n      return false;\r\n    }\r\n    // dot product can be reduced to this due to the hexagon symmetry\r\n    // return HALF_HEIGHT * RADIUS * q2x - RADIUS * q2y >= 0;\r\n    return RADIUS * HALF_HEIGHT - HALF_HEIGHT * q2x - 0.5 * q2y >= 0;\r\n  };\r\n})();\r\n","import React, { useState } from \"react\";\r\n\r\nimport \"./Expand.scss\";\r\nimport classNames from \"classnames\";\r\n\r\ninterface ExpandProps {\r\n  className?: string;\r\n  children: React.ReactNode;\r\n  shrunkElements: React.ReactNode;\r\n}\r\n\r\nfunction Expand({ className, children, shrunkElements }: ExpandProps) {\r\n  const [expanded, setExpanded] = useState(false);\r\n\r\n  const handleExpandClick = () => {\r\n    setExpanded(!expanded);\r\n  };\r\n\r\n  return (\r\n    <div className={classNames(className, \"expand\")}>\r\n      <div className=\"expand-button\" onClick={handleExpandClick}>\r\n        {shrunkElements}\r\n        <div className=\"expand-caret\">{expanded ? \"\" : \"\"}</div>\r\n      </div>\r\n      {expanded ? <div>{children}</div> : null}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default Expand;\r\n","import { Species } from \"core/species\";\r\nimport React from \"react\";\r\nimport { HexTile } from \"../../../../core/overworld/hexTile\";\r\nimport { Button } from \"../../common/Button\";\r\nimport Expand from \"../../common/Expand\";\r\nimport MP from \"../../common/MP\";\r\nimport \"./HexInfo.scss\";\r\n\r\ninterface HexInfo {\r\n  playSpecies: Species;\r\n  tile: HexTile;\r\n  onClickPlay: () => void;\r\n}\r\n\r\nfunction HexInfo({ playSpecies, tile, onClickPlay }: HexInfo) {\r\n  const { height, flora } = tile.info;\r\n\r\n  const playButtonElement =\r\n    height === -1 ? null : (\r\n      <div className=\"play-selector\">\r\n        <span>{playSpecies.name}</span>\r\n        <Button color=\"green\" className=\"play-button\" onClick={onClickPlay}>\r\n          Play Level\r\n        </Button>\r\n      </div>\r\n    );\r\n\r\n  const header =\r\n    flora != null ? (\r\n      <div>\r\n        <h1>\r\n          Inhabited by <i>{flora.species.name}</i>\r\n        </h1>\r\n        <p>\r\n          <MP amount={flora.mutationPointsPerEpoch} /> per epoch\r\n        </p>\r\n      </div>\r\n    ) : tile.isHabitable ? (\r\n      <h1>Uninhabited</h1>\r\n    ) : (\r\n      <h1>Uninhabitable (Deep Water)</h1>\r\n    );\r\n\r\n  const stringifyInfo = { ...tile.info };\r\n  delete stringifyInfo.flora;\r\n\r\n  const expand = tile.isHabitable ? (\r\n    <Expand shrunkElements={<div className=\"details\">Details</div>}>\r\n      <pre style={{ fontSize: \"12px\" }}>{JSON.stringify(stringifyInfo, null, 4)}</pre>\r\n    </Expand>\r\n  ) : null;\r\n\r\n  return (\r\n    <div className=\"hex-info-container\">\r\n      {header}\r\n      {expand}\r\n      {playButtonElement}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default HexInfo;\r\n","import testVignetteUrl from \"assets/images/test-vignette.png\";\r\nimport { sleep } from \"common/promise\";\r\nimport { HexTile } from \"core/overworld/hexTile\";\r\nimport { Species } from \"core/species\";\r\nimport { easeExpIn } from \"d3-ease\";\r\nimport { scaleLinear } from \"d3-scale\";\r\nimport { PopulationAttempt } from \"game/app\";\r\nimport { generateNaturalRandomHexagonPoints, pixelPosition } from \"game/ui/overworld/hexMath\";\r\nimport { clamp, map, sawTooth } from \"math\";\r\nimport Ticker from \"std/ticker\";\r\nimport { Vector2 } from \"three\";\r\nimport { CameraState } from \"./OverWorldMap\";\r\n\r\nconst testVignette = new Image();\r\ntestVignette.src = testVignetteUrl;\r\n\r\nconst COLOR_SCALE_HEIGHT = scaleLinear<string, string>()\r\n  .domain([-1, 0, 1, 5, 6])\r\n  .range([\"rgb(0, 60, 255)\", \"lightblue\", \"yellow\", \"orange\"]);\r\n\r\nexport interface DrawingContext {\r\n  populationAttempt?: PopulationAttempt;\r\n  highlightedHex?: HexTile;\r\n}\r\n\r\nexport default class HexTileSprite {\r\n  private vignettePositions?: Vector2[];\r\n\r\n  private isHovered = false;\r\n\r\n  constructor(public tile: HexTile, public context: DrawingContext) {}\r\n\r\n  public get zIndex() {\r\n    let z = this.tile.cartesian.y;\r\n    if (this.tile.info.flora != null) {\r\n      z += 1000;\r\n    }\r\n    return z;\r\n  }\r\n\r\n  public get isShadowed() {\r\n    if (this.context.highlightedHex != null) {\r\n      return this.context.highlightedHex !== this.tile;\r\n    } else if (this.context.populationAttempt != null) {\r\n      return (\r\n        this.context.populationAttempt.sourceHex !== this.tile && this.context.populationAttempt.targetHex !== this.tile\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This resets every draw.\r\n   */\r\n  setIsHovered() {\r\n    this.isHovered = true;\r\n  }\r\n\r\n  draw(c: CanvasRenderingContext2D, camera: CameraState) {\r\n    const { scale } = camera;\r\n    const [px, py] = pixelPosition(this.tile, camera);\r\n\r\n    c.lineWidth = (1 * scale) / 48;\r\n\r\n    if (this.isShadowed) {\r\n      c.globalAlpha = 0.2;\r\n    } else {\r\n      c.globalAlpha = 1;\r\n    }\r\n    if (this.tile.info.visible || true) {\r\n      // base color\r\n      c.fillStyle = COLOR_SCALE_HEIGHT(this.tile.info.height);\r\n      c.strokeStyle = \"rgb(112, 112, 112)\";\r\n      drawHex(c, px, py, scale);\r\n\r\n      // 0-6 number (can be covered by vignettes)\r\n      if (!this.isHovered) {\r\n        this.drawNumericHeight(c, scale, px, py);\r\n      }\r\n\r\n      // \"active\" pulse\r\n      if (this.tile.info.flora != null) {\r\n        this.drawVignettes(c, this.tile.info.flora.species, px, py, scale);\r\n      }\r\n    } else {\r\n      c.strokeStyle = \"rgb(112, 112, 112)\";\r\n      drawHex(c, px, py, scale, false);\r\n    }\r\n\r\n    // hovered outline\r\n    if (this.isHovered) {\r\n      c.strokeStyle = \"rgb(112, 112, 112)\";\r\n      c.lineWidth = (1 * scale) / 48;\r\n      drawCircle(c, px, py, (scale / 48) * 12, false);\r\n      if (this.tile.info.visible) {\r\n        this.drawNumericHeight(c, scale, px, py);\r\n      }\r\n    }\r\n\r\n    this.isHovered = false;\r\n  }\r\n\r\n  private static easePulse = easeExpIn;\r\n\r\n  public drawActivePulse(c: CanvasRenderingContext2D, scale: number, px: number, py: number) {\r\n    for (let i = 0; i < 10; i++) {\r\n      this.drawPulse(i / 10, c, scale, px, py);\r\n    }\r\n  }\r\n\r\n  private drawPulse(tOffset: number, c: CanvasRenderingContext2D, scale: number, px: number, py: number) {\r\n    const thickness = map(\r\n      HexTileSprite.easePulse(clamp(map(sawTooth(Ticker.now / 6000 + tOffset), 0, 1, -1, 2), -Infinity, 1)),\r\n      0,\r\n      1,\r\n      0,\r\n      20\r\n    );\r\n    c.lineWidth = (thickness * scale) / 48;\r\n    const a = 100 / (thickness * thickness * thickness);\r\n    c.strokeStyle = `rgba(255, 255, 255, ${a})`;\r\n    drawHex(c, px, py, scale + c.lineWidth / 2, false);\r\n  }\r\n\r\n  private drawNumericHeight(c: CanvasRenderingContext2D, scale: number, px: number, py: number) {\r\n    if (this.tile.info.height >= 0) {\r\n      c.font = `${(12 * scale) / 48}px serif`;\r\n      c.textAlign = \"center\";\r\n      c.textBaseline = \"middle\";\r\n      c.fillStyle = \"#666\";\r\n      c.fillText(this.tile.info.height + \"\", px, py, scale);\r\n    }\r\n  }\r\n\r\n  drawVignettes(c: CanvasRenderingContext2D, species: Species, px: number, py: number, scale: number) {\r\n    if (this.vignettePositions == null) {\r\n      const positions = generateNaturalRandomHexagonPoints(0.3, true); //.sort((a, b) => a.y - b.y);\r\n      this.vignettePositions = [];\r\n      const vignettePositions = this.vignettePositions;\r\n      (async function() {\r\n        for (const p of positions) {\r\n          vignettePositions.push(p);\r\n          await sleep(300);\r\n        }\r\n      })();\r\n    }\r\n    const sizeScale = scale / 48 / 2;\r\n    for (const p of this.vignettePositions) {\r\n      c.drawImage(\r\n        testVignette,\r\n        px + p.x * scale - (testVignette.width / 2) * sizeScale,\r\n        py + p.y * scale - testVignette.height * sizeScale,\r\n        testVignette.width * sizeScale,\r\n        testVignette.height * sizeScale\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nfunction drawHex(c: CanvasRenderingContext2D, x: number, y: number, r: number, fill = true) {\r\n  c.beginPath();\r\n  c.moveTo(x + r, y);\r\n  for (let i = 1; i < 6; i++) {\r\n    const angle = (i / 6) * Math.PI * 2;\r\n    c.lineTo(x + Math.cos(angle) * r, y + Math.sin(angle) * r);\r\n  }\r\n  c.closePath();\r\n  if (fill) {\r\n    c.fill();\r\n  }\r\n  c.stroke();\r\n}\r\n\r\nfunction drawCircle(c: CanvasRenderingContext2D, x: number, y: number, r: number, fill = true) {\r\n  c.beginPath();\r\n  c.moveTo(x + r, y);\r\n  c.arc(x, y, r, 0, Math.PI * 2);\r\n  // for (let i = 1; i < 6; i++) {\r\n  //   const angle = (i / 6) * Math.PI * 2;\r\n  //   c.lineTo(x + Math.cos(angle) * r, y + Math.sin(angle) * r);\r\n  // }\r\n  // c.closePath();\r\n  if (fill) {\r\n    c.fill();\r\n  }\r\n  c.stroke();\r\n}\r\n","import React from \"react\";\r\nimport { HexTile } from \"../../../../core/overworld/hexTile\";\r\nimport { pixelPosition } from \"../hexMath\";\r\nimport { CameraState } from \"./OverWorldMap\";\r\nimport \"./OverWorldPopover.scss\";\r\n\r\ninterface OverWorldPopoverProps {\r\n  camera: CameraState;\r\n  tile: HexTile;\r\n  children: React.ReactNode;\r\n}\r\n\r\nfunction OverWorldPopover({ tile, camera, children }: OverWorldPopoverProps) {\r\n  const [px, py] = pixelPosition(tile, camera);\r\n  // this element is put in the center\r\n  const container: React.CSSProperties = {\r\n    left: px + camera.scale * 0.3,\r\n    top: py,\r\n  };\r\n  return (\r\n    <div className=\"overworld-popover\" style={container}>\r\n      <div className=\"overworld-popover-positioner\">{children}</div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default OverWorldPopover;\r\n","import { AppActions, AppReducerContext, PopulationAttempt } from \"game/app\";\r\nimport { lerp } from \"math\";\r\nimport React from \"react\";\r\nimport Ticker from \"std/ticker\";\r\nimport { Vector2 } from \"three\";\r\nimport { HexTile } from \"../../../../core/overworld/hexTile\";\r\nimport { getCameraPositionCenteredOn, getClickedHexCoords, pixelPosition } from \"../hexMath\";\r\nimport HexInfo from \"./HexInfo\";\r\nimport HexTileSprite, { DrawingContext } from \"./hexTileSprite\";\r\nimport \"./OverWorldMap.scss\";\r\nimport OverWorldPopover from \"./OverWorldPopover\";\r\n\r\ninterface OverWorldMapProps {\r\n  // TODO turn this into a trigger, or global state\r\n  focusedHex?: HexTile;\r\n}\r\n\r\nexport interface CameraState {\r\n  /**\r\n   * Multiply cartesian hex coord values by scale to get pixel coordinates.\r\n   * Each hex is drawn with radius `scale`.\r\n   */\r\n\r\n  scale: number;\r\n  /**\r\n   * dX and dY are pure pixel offsets.\r\n   */\r\n  dX: number;\r\n  dY: number;\r\n}\r\n\r\n// function zoomCenteredOn(state: CameraState);\r\n\r\ninterface OverWorldMapState {\r\n  cameraState: CameraState;\r\n  pressedKeys: { [code: string]: boolean };\r\n  populationAttempt?: PopulationAttempt;\r\n  // TODO one of population attempt or highlighted hex can be\r\n  // non-null at a time\r\n  highlightedHex?: HexTile;\r\n  hoveredHex?: HexTile;\r\n  frame: number;\r\n}\r\n\r\nexport class OverWorldMap extends React.PureComponent<OverWorldMapProps, OverWorldMapState> implements DrawingContext {\r\n  static contextType = AppReducerContext;\r\n\r\n  context!: React.ContextType<typeof AppReducerContext>;\r\n\r\n  private hexTileSprites: Map<HexTile, HexTileSprite> = new Map();\r\n\r\n  private canvas: HTMLCanvasElement | null = null;\r\n\r\n  private rafId?: number;\r\n\r\n  get populationAttempt() {\r\n    return this.state.populationAttempt;\r\n  }\r\n\r\n  get highlightedHex() {\r\n    return this.state.highlightedHex;\r\n  }\r\n\r\n  constructor(props: OverWorldMapProps, context: any) {\r\n    super(props, context);\r\n    const scale = 96;\r\n    const [{ overWorld }] = context;\r\n    const [dX, dY] = getCameraPositionCenteredOn(overWorld.getStartHex(), scale);\r\n    this.state = {\r\n      cameraState: { scale, dX, dY },\r\n      pressedKeys: {},\r\n      frame: 0,\r\n    };\r\n    for (const tile of overWorld) {\r\n      const sprite = new HexTileSprite(tile, this);\r\n      this.hexTileSprites.set(tile, sprite);\r\n    }\r\n  }\r\n\r\n  private handleCanvasRef = (ref: HTMLCanvasElement | null) => {\r\n    this.canvas = ref;\r\n    if (ref != null) {\r\n      Ticker.addAnimation(() => {\r\n        if (this.canvas != null) {\r\n          this.setState({ frame: this.state.frame + 1 });\r\n        }\r\n        return this.canvas == null;\r\n      });\r\n      this.handleResize();\r\n    }\r\n  };\r\n\r\n  private handleCanvasClick = (e: React.MouseEvent) => {\r\n    if (this.state.populationAttempt != null || this.state.highlightedHex != null) {\r\n      this.setState({\r\n        populationAttempt: undefined,\r\n        highlightedHex: undefined,\r\n      });\r\n    } else {\r\n      const coords = getClickedHexCoords(this.canvas!, this.state.cameraState, e);\r\n      const [{ overWorld }] = this.context;\r\n      const clicked = overWorld.hexAt(coords.i, coords.j);\r\n      // simplest check - we clicked on a tile we can see\r\n      if (clicked != null && clicked.info.visible) {\r\n        // if clicked has no flora, migrate into it\r\n        if (clicked.info.flora == null) {\r\n          const target = clicked;\r\n          const source = overWorld.possibleMigrationSources(clicked)[0];\r\n          if (source != null) {\r\n            const populationAttempt: PopulationAttempt = {\r\n              targetHex: target,\r\n              sourceHex: source,\r\n              settlingSpecies: source.info.flora!.species,\r\n            };\r\n            this.setState({ populationAttempt, highlightedHex: undefined });\r\n          } else {\r\n            // TODO add a Popover for when you see a tile but can't reach it with anything\r\n            // this can happen in the future if earthquakes happen and destroy\r\n            // blocks you used to own\r\n          }\r\n        } else {\r\n          // clicked does have flora; just show a highlight\r\n          const highlightedHex = clicked;\r\n          this.setState({ highlightedHex, populationAttempt: undefined });\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  private handleCanvasMouseLeave = () => {\r\n    this.setState({\r\n      hoveredHex: undefined,\r\n    });\r\n  };\r\n\r\n  private handleCanvasMouseMove = (e: React.MouseEvent) => {\r\n    const coords = getClickedHexCoords(this.canvas!, this.state.cameraState, e);\r\n    const hex = this.context[0].overWorld.hexAt(coords.i, coords.j);\r\n    this.setState({ hoveredHex: hex });\r\n  };\r\n\r\n  private handleClickPlay = () => {\r\n    const [, dispatch] = this.context;\r\n    const appAction = this.getAppAction();\r\n    if (appAction) {\r\n      dispatch({\r\n        type: \"AATransitionStart\",\r\n        transition: appAction,\r\n      });\r\n    }\r\n  };\r\n\r\n  private getAppAction(): AppActions | undefined {\r\n    if (this.state.populationAttempt != null) {\r\n      return {\r\n        type: \"AAStartPopulationAttempt\",\r\n        populationAttempt: this.state.populationAttempt,\r\n      };\r\n    } else if (this.state.highlightedHex != null) {\r\n      // re-populate the same tile\r\n      const sourceHex = this.state.highlightedHex;\r\n      return {\r\n        type: \"AAStartPopulationAttempt\",\r\n        populationAttempt: {\r\n          sourceHex,\r\n          targetHex: sourceHex,\r\n          settlingSpecies: sourceHex.info.flora!.species,\r\n        },\r\n      };\r\n    }\r\n  }\r\n\r\n  private handleKeyDown = (e: KeyboardEvent) => {\r\n    if (!e.repeat) {\r\n      const newPressedKeys = { ...this.state.pressedKeys, [e.code]: true };\r\n      this.setState({\r\n        pressedKeys: newPressedKeys,\r\n      });\r\n    }\r\n  };\r\n\r\n  private handleKeyUp = (e: KeyboardEvent) => {\r\n    const newPressedKeys = { ...this.state.pressedKeys };\r\n    delete newPressedKeys[e.code];\r\n    this.setState({\r\n      pressedKeys: newPressedKeys,\r\n    });\r\n  };\r\n\r\n  private handleWheel = (e: WheelEvent) => {\r\n    const delta = -(e.deltaX + e.deltaY) / 125 / 10;\r\n    const scalar = Math.pow(2, delta);\r\n\r\n    const scale = this.state.cameraState.scale * scalar;\r\n    this.setState({\r\n      cameraState: {\r\n        ...this.state.cameraState,\r\n        scale,\r\n      },\r\n    });\r\n  };\r\n\r\n  private handleResize = () => {\r\n    if (this.canvas != null) {\r\n      this.canvas.width = window.innerWidth;\r\n      this.canvas.height = window.innerHeight;\r\n      this.updateCanvas();\r\n    }\r\n  };\r\n\r\n  private updateCamera = () => {\r\n    const [state] = this.context;\r\n    const { transition } = state;\r\n    if (transition != null) {\r\n      if (transition.type === \"AAStartPopulationAttempt\") {\r\n        // zoom in\r\n        const { targetHex } = transition.populationAttempt;\r\n        const { scale, dX, dY } = this.state.cameraState;\r\n        const nextScale = scale * 1.02;\r\n        const [targetDX, targetDY] = getCameraPositionCenteredOn(targetHex, scale);\r\n        this.setState({\r\n          cameraState: {\r\n            dX: lerp(dX, targetDX, 0.2),\r\n            dY: lerp(dY, targetDY, 0.2),\r\n            scale: nextScale,\r\n          },\r\n        });\r\n      }\r\n    }\r\n    const panSpeed = 20;\r\n    let offset = new Vector2();\r\n    for (const key in this.state.pressedKeys) {\r\n      if (key === \"KeyW\" || key === \"ArrowUp\") {\r\n        offset.y += panSpeed;\r\n      } else if (key === \"KeyS\" || key === \"ArrowDown\") {\r\n        offset.y -= panSpeed;\r\n      } else if (key === \"KeyA\" || key === \"ArrowLeft\") {\r\n        offset.x += panSpeed;\r\n      } else if (key === \"KeyD\" || key === \"ArrowRight\") {\r\n        offset.x -= panSpeed;\r\n      }\r\n    }\r\n    offset.setLength(panSpeed);\r\n\r\n    if (offset.x !== 0 || offset.y !== 0) {\r\n      const cameraState = this.state.cameraState;\r\n\r\n      this.setState({\r\n        cameraState: {\r\n          ...cameraState,\r\n          dX: cameraState.dX + offset.x,\r\n          dY: cameraState.dY + offset.y,\r\n        },\r\n      });\r\n    }\r\n  };\r\n\r\n  private updateCanvas() {\r\n    if (this.canvas != null) {\r\n      const c = this.canvas.getContext(\"2d\")!;\r\n      this.drawMap(c);\r\n      this.drawMigrationArrows(c);\r\n      this.drawPopulationAttempt(c);\r\n    }\r\n  }\r\n\r\n  private drawMap(c: CanvasRenderingContext2D) {\r\n    const { hoveredHex, cameraState } = this.state;\r\n    c.clearRect(0, 0, c.canvas.width, c.canvas.height);\r\n\r\n    if (hoveredHex != null) {\r\n      this.hexTileSprites.get(hoveredHex)!.setIsHovered();\r\n    }\r\n\r\n    const sprites = Array.from(this.hexTileSprites.values());\r\n    sprites.sort((b, a) => {\r\n      return b.zIndex - a.zIndex;\r\n    });\r\n\r\n    for (const sprite of sprites) {\r\n      sprite.draw(c, cameraState);\r\n    }\r\n  }\r\n\r\n  private drawMigrationArrows(c: CanvasRenderingContext2D) {\r\n    const { hoveredHex, populationAttempt } = this.state;\r\n    if (hoveredHex != null && populationAttempt == null) {\r\n      if (hoveredHex.info.flora == null) {\r\n        this.drawPossibleMigrationIntoArrows(c, hoveredHex);\r\n      } else {\r\n        this.drawPossibleMigrationOutOfArrows(c, hoveredHex);\r\n      }\r\n    }\r\n  }\r\n\r\n  private drawPopulationAttempt(c: CanvasRenderingContext2D) {\r\n    const { populationAttempt } = this.state;\r\n    if (populationAttempt != null) {\r\n      this.drawMigrationArrow(c, populationAttempt.sourceHex!, populationAttempt.targetHex);\r\n    }\r\n  }\r\n\r\n  componentDidMount() {\r\n    document.addEventListener(\"keydown\", this.handleKeyDown);\r\n    document.addEventListener(\"keyup\", this.handleKeyUp);\r\n    document.addEventListener(\"wheel\", this.handleWheel);\r\n    window.addEventListener(\"resize\", this.handleResize);\r\n    this.rafId = Ticker.addAnimation(this.updateCamera);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    document.removeEventListener(\"keydown\", this.handleKeyDown);\r\n    document.removeEventListener(\"keyup\", this.handleKeyUp);\r\n    document.removeEventListener(\"wheel\", this.handleWheel);\r\n    window.removeEventListener(\"resize\", this.handleResize);\r\n    Ticker.removeAnimation(this.rafId!);\r\n  }\r\n\r\n  componentDidUpdate(prevProps: OverWorldMapProps) {\r\n    if (prevProps.focusedHex !== this.props.focusedHex && this.props.focusedHex != null) {\r\n      this.focusHex(this.props.focusedHex);\r\n    }\r\n    this.updateCanvas();\r\n  }\r\n\r\n  focusHex(hex: HexTile) {\r\n    let tStart = 0;\r\n    Ticker.addAnimation((t) => {\r\n      if (tStart === 0) {\r\n        tStart = t;\r\n      }\r\n      const dt = t - tStart;\r\n      const [targetX, targetY] = getCameraPositionCenteredOn(hex, this.state.cameraState.scale);\r\n      const dX = this.state.cameraState.dX * 0.5 + targetX * 0.5;\r\n      const dY = this.state.cameraState.dY * 0.5 + targetY * 0.5;\r\n      this.setState({\r\n        cameraState: {\r\n          ...this.state.cameraState,\r\n          dX,\r\n          dY,\r\n        },\r\n      });\r\n      return dt > 1000 || (Math.abs(targetX - dX) < 1e-2 && Math.abs(targetY - dY) < 1e-2);\r\n    });\r\n  }\r\n\r\n  render() {\r\n    return (\r\n      <div className=\"overworld-map-container\">\r\n        <canvas\r\n          tabIndex={-1}\r\n          ref={this.handleCanvasRef}\r\n          onClick={this.handleCanvasClick}\r\n          onMouseLeave={this.handleCanvasMouseLeave}\r\n          onMouseMove={this.handleCanvasMouseMove}\r\n        />\r\n        {this.maybeRenderPopover()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  drawPossibleMigrationIntoArrows(c: CanvasRenderingContext2D, target: HexTile) {\r\n    const [{ overWorld }] = this.context;\r\n    for (const source of overWorld.possibleMigrationSources(target)) {\r\n      this.drawMigrationArrow(c, source, target);\r\n    }\r\n  }\r\n\r\n  drawPossibleMigrationOutOfArrows(c: CanvasRenderingContext2D, source: HexTile) {\r\n    const [{ overWorld }] = this.context;\r\n    for (const target of overWorld.possibleMigrationTargets(source)) {\r\n      this.drawMigrationArrow(c, source, target);\r\n    }\r\n  }\r\n\r\n  public drawMigrationArrow(c: CanvasRenderingContext2D, source: HexTile, target: HexTile) {\r\n    const isShadowed = (() => {\r\n      if (this.highlightedHex != null) {\r\n        return true;\r\n      } else if (this.populationAttempt != null) {\r\n        return source !== this.populationAttempt.sourceHex || target !== this.populationAttempt.targetHex;\r\n      } else {\r\n        return false;\r\n      }\r\n    })();\r\n    if (isShadowed) {\r\n      c.globalAlpha = 0.2;\r\n    } else {\r\n      c.globalAlpha = 1;\r\n    }\r\n    const { scale } = this.state.cameraState;\r\n    c.shadowBlur = (3 * scale) / 48;\r\n    c.shadowOffsetX = (4 * scale) / 48;\r\n    c.shadowOffsetY = (4 * scale) / 48;\r\n    c.shadowColor = \"black\";\r\n    c.strokeStyle = \"white\";\r\n\r\n    c.lineWidth = (3 * scale) / 48;\r\n    c.lineCap = \"round\";\r\n    c.lineJoin = \"round\";\r\n    const targetCenter = new Vector2(...pixelPosition(target, this.state.cameraState));\r\n    const sourceCenter = new Vector2(...pixelPosition(source, this.state.cameraState));\r\n    const arrowStart = sourceCenter.clone().lerp(targetCenter, 0.2);\r\n    const arrowEnd = targetCenter.clone().lerp(sourceCenter, 0.2);\r\n    drawArrow(c, arrowStart.x, arrowStart.y, arrowEnd.x, arrowEnd.y, (10 * scale) / 48);\r\n    c.shadowColor = \"transparent\";\r\n  }\r\n\r\n  maybeRenderPopover() {\r\n    const { cameraState, populationAttempt, highlightedHex } = this.state;\r\n    if (populationAttempt != null) {\r\n      return (\r\n        <OverWorldPopover camera={cameraState} tile={populationAttempt.targetHex}>\r\n          <HexInfo\r\n            playSpecies={populationAttempt.settlingSpecies}\r\n            tile={populationAttempt.targetHex}\r\n            onClickPlay={this.handleClickPlay}\r\n          />\r\n        </OverWorldPopover>\r\n      );\r\n    } else if (highlightedHex != null) {\r\n      return (\r\n        <OverWorldPopover camera={cameraState} tile={highlightedHex}>\r\n          <HexInfo\r\n            playSpecies={highlightedHex.info.flora!.species}\r\n            tile={highlightedHex}\r\n            onClickPlay={this.handleClickPlay}\r\n          />\r\n        </OverWorldPopover>\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nfunction drawArrow(c: CanvasRenderingContext2D, fromx: number, fromy: number, tox: number, toy: number, headlen = 10) {\r\n  c.beginPath();\r\n  var dx = tox - fromx;\r\n  var dy = toy - fromy;\r\n  var angle = Math.atan2(dy, dx);\r\n  c.moveTo(fromx, fromy);\r\n  c.lineTo(tox, toy);\r\n  c.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));\r\n  c.moveTo(tox, toy);\r\n  c.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));\r\n  c.stroke();\r\n}\r\n","import Chromosome from \"core/cell/chromosome\";\r\nimport React from \"react\";\r\nimport { IoIosAddCircleOutline } from \"react-icons/io\";\r\nimport { Color, Vector2 } from \"three\";\r\nimport Genome, { CellType } from \"../../../core/cell/genome\";\r\n\r\nexport const AddCellCard: React.FC<{\r\n  genome: Genome;\r\n}> = ({ genome }) => {\r\n  // const [state, setState] = React.useContext(DraggedContext);\r\n  const handleAddCell = React.useCallback(() => {\r\n    const newCellType = new CellType(\r\n      \"Cell \" + (genome.cellTypes.length + 1),\r\n      0,\r\n      Chromosome.basic(),\r\n      {\r\n        texturePosition: new Vector2(1, 1),\r\n        color: new Color(Math.random(), Math.random(), Math.random()),\r\n      },\r\n      {\r\n        type: \"give\",\r\n        resources: \"water and sugar\",\r\n      }\r\n    );\r\n    genome.cellTypes.push(newCellType);\r\n  }, [genome.cellTypes]);\r\n  return (\r\n    <div className=\"add-cell-card\">\r\n      <div className=\"add-cell\" onClick={handleAddCell}>\r\n        Add Cell\r\n      </div>\r\n      <button onClick={handleAddCell}>\r\n        <IoIosAddCircleOutline />\r\n      </button>\r\n    </div>\r\n  );\r\n};\r\n","export default function lazy<T>(fn: () => T): () => T {\r\n  let cache: T;\r\n  return () => {\r\n    if (cache === undefined) {\r\n      cache = fn();\r\n    }\r\n    return cache;\r\n  };\r\n}\r\n","import spritesheetUrl from \"assets/images/spritesheet.png\";\r\nimport * as THREE from \"three\";\r\nimport lazy from \"../common/lazy\";\r\n\r\nconst spriteSize = 32; // 32x32 sprites\r\nexport let spritesheetLoaded = false;\r\nexport const SPRITESHEET = lazy(() =>\r\n  new THREE.TextureLoader().load(spritesheetUrl, (texture) => {\r\n    texture.magFilter = THREE.NearestFilter;\r\n    texture.flipY = true;\r\n    texture.wrapS = texture.wrapT = THREE.ClampToEdgeWrapping;\r\n    SPRITESHEET().dispatchEvent({ type: \"update\" });\r\n    spritesheetLoaded = true;\r\n  })\r\n);\r\n\r\nexport const cache: { [key: string]: THREE.Texture } = {};\r\n// x, y are spritesheet coordinates, starting top-left and going down/right\r\nexport function textureFromSpritesheet(x: number, y: number, backgroundColor = \"transparent\") {\r\n  x = Math.floor(x);\r\n  y = Math.floor(y);\r\n  const key = `${x},${y}`;\r\n  if (cache[key] == null) {\r\n    const canvas = document.createElement(\"canvas\");\r\n    canvas.width = spriteSize;\r\n    canvas.height = spriteSize;\r\n    const texture = new THREE.Texture(canvas);\r\n    texture.magFilter = THREE.NearestFilter;\r\n    texture.flipY = true;\r\n    texture.wrapS = THREE.RepeatWrapping;\r\n    texture.wrapT = THREE.RepeatWrapping;\r\n    function drawSpriteToCanvas() {\r\n      const image = SPRITESHEET().image;\r\n      const context = canvas.getContext(\"2d\")!;\r\n      context.fillStyle = backgroundColor;\r\n      context.fillRect(0, 0, spriteSize, spriteSize);\r\n      // context.fillStyle = \"white\";\r\n      // flip the image vertically\r\n      context.drawImage(\r\n        image,\r\n        // sx, sy, sWidth, sHeight\r\n        spriteSize * x,\r\n        spriteSize * y,\r\n        spriteSize,\r\n        spriteSize,\r\n        // dx, dy, dWidth, dHeight\r\n        0,\r\n        0,\r\n        spriteSize,\r\n        spriteSize\r\n      );\r\n      texture.needsUpdate = true;\r\n      // devlog(\"updated spritesheet for\", x, y);\r\n    }\r\n    if (spritesheetLoaded) {\r\n      drawSpriteToCanvas();\r\n    } else {\r\n      SPRITESHEET().addEventListener(\"update\", () => {\r\n        drawSpriteToCanvas();\r\n      });\r\n    }\r\n    cache[key] = texture;\r\n  }\r\n  return cache[key];\r\n}\r\n","import classNames from \"classnames\";\r\nimport React from \"react\";\r\nimport { CellType } from \"../../../core/cell/genome\";\r\nimport { textureFromSpritesheet } from \"../../spritesheet\";\r\nimport \"./IconCell.scss\";\r\n\r\nexport const ActionBarItem: React.FC<React.HTMLProps<HTMLDivElement>> = ({ children, className, ...props }) => {\r\n  return (\r\n    <div className={classNames(\"action-bar-item\", className)} {...props}>\r\n      {children}\r\n    </div>\r\n  );\r\n};\r\n\r\nconst IconCell: React.FC<{ cellType: CellType; spritesheetLoaded: boolean } & React.HTMLProps<HTMLDivElement>> = ({\r\n  children,\r\n  cellType,\r\n  spritesheetLoaded,\r\n  ...props\r\n}) => {\r\n  const { material } = cellType;\r\n  const color = (material.color && material.color.getStyle()) || \"transparent\";\r\n  const texture = textureFromSpritesheet(material.texturePosition.x, material.texturePosition.y, color);\r\n  const style: React.CSSProperties = React.useMemo(() => {\r\n    const image = texture.image;\r\n    const url = (() => {\r\n      if (image != null) {\r\n        if (image instanceof HTMLCanvasElement && spritesheetLoaded) {\r\n          return image.toDataURL();\r\n        } else if (image instanceof Image) {\r\n          return image.src;\r\n        } else {\r\n          throw new Error(\"image is\" + image);\r\n        }\r\n      } else {\r\n        return \"\";\r\n      }\r\n    })();\r\n    const backgroundImage = `url(${url}), linear-gradient(${color}, ${color})`;\r\n    return {\r\n      backgroundImage,\r\n    };\r\n  }, [color, spritesheetLoaded, texture.image]);\r\n  return (\r\n    <ActionBarItem {...props} className=\"icon-cell\" style={style}>\r\n      {children}\r\n    </ActionBarItem>\r\n  );\r\n};\r\nexport default IconCell;\r\n","import React from \"react\";\r\nimport { CellInteraction, describeCellInteraction } from \"../../../core/cell/genome\";\r\n\r\nexport const CellInteractionSelector: React.FC<{\r\n  interaction?: CellInteraction;\r\n  setInteraction: (i: CellInteraction | undefined) => void;\r\n}> = React.memo(({ interaction, setInteraction }) => {\r\n  const handleSelect = React.useCallback(\r\n    (event: React.ChangeEvent<HTMLSelectElement>) => {\r\n      const indexOrUndefined = event.target.value;\r\n      if (indexOrUndefined == null) {\r\n        setInteraction(undefined);\r\n        // cellType.interaction = undefined;\r\n      } else {\r\n        setInteraction(possibleInteractions[Number(indexOrUndefined)]);\r\n        // cellType.interaction = possibleInteractions[Number(indexOrUndefined)];\r\n      }\r\n    },\r\n    [setInteraction]\r\n  );\r\n  const selectValue =\r\n    interaction == null\r\n      ? undefined\r\n      : possibleInteractions.findIndex((i) => interaction.resources === i.resources && interaction.type === i.type);\r\n  const interactionEl = (\r\n    <select className=\"interaction-select\" onChange={handleSelect} value={selectValue}>\r\n      <option value={undefined}>do nothing</option>\r\n      {possibleInteractions.map((interaction, index) => {\r\n        return (\r\n          <option key={index} value={index}>\r\n            {describeCellInteraction(interaction)}\r\n          </option>\r\n        );\r\n      })}\r\n    </select>\r\n  );\r\n  return <div className=\"interaction-select-container\">Left-click to {interactionEl}.</div>;\r\n});\r\n\r\nconst interactionTypes = [\"give\", \"take\"] as const;\r\nconst resourceTypes = [\"water\", \"sugar\", \"water and sugar\"] as const;\r\nexport const possibleInteractions: CellInteraction[] = interactionTypes.flatMap((type) =>\r\n  resourceTypes.map((resources) => ({\r\n    type,\r\n    resources,\r\n  }))\r\n);\r\npossibleInteractions.push(\r\n  {\r\n    type: \"give\",\r\n    resources: \"water take sugar\",\r\n  },\r\n  {\r\n    type: \"give\",\r\n    resources: \"sugar take water\",\r\n  }\r\n);\r\n","import React from \"react\";\r\nimport { CellType } from \"../../../core/cell/genome\";\r\nimport { RealizedGene } from \"../../../core/cell/realizedGene\";\r\ninterface DragInfo {\r\n  gene: RealizedGene;\r\n  cellType: CellType;\r\n}\r\nexport interface GenomeViewerState {\r\n  dragged?: DragInfo;\r\n  view: \"small\" | \"expanded\";\r\n}\r\ntype GenomeViewerStateTupleType = [GenomeViewerState, React.Dispatch<React.SetStateAction<GenomeViewerState>>];\r\nexport const DraggedContext = React.createContext<GenomeViewerStateTupleType>(null!);\r\n","import classNames from \"classnames\";\r\nimport DynamicNumber from \"game/ui/common/DynamicNumber\";\r\nimport React from \"react\";\r\nexport function GeneCost({\r\n  cost,\r\n  className,\r\n  ...props\r\n}: {\r\n  cost: number;\r\n} & React.HTMLAttributes<HTMLSpanElement>) {\r\n  return (\r\n    <span\r\n      {...props}\r\n      className={classNames(\"gene-cost\", className, {\r\n        negative: cost < 0,\r\n      })}\r\n    >\r\n      {cost < 0 ? \"+\" : null}\r\n      <DynamicNumber value={Math.abs(cost)} speed={0.5} />\r\n    </span>\r\n  );\r\n}\r\n","import classNames from \"classnames\";\r\nimport React from \"react\";\r\nimport { FaGripLines } from \"react-icons/fa\";\r\nimport { CellType } from \"../../../core/cell/genome\";\r\nimport { RealizedGene } from \"../../../core/cell/realizedGene\";\r\nimport { DraggedContext } from \"./DragInfo\";\r\nimport { GeneCost } from \"./GeneCost\";\r\nexport const GeneViewer: React.FC<{\r\n  cellType: CellType;\r\n  gene: RealizedGene;\r\n}> = ({ cellType, gene }) => {\r\n  const [state, setState] = React.useContext(DraggedContext);\r\n  const { gene: gd } = gene;\r\n  const handleDragStart = React.useCallback(\r\n    (event: React.DragEvent) => {\r\n      event.dataTransfer.setData(\"mito/gene\", \"data\");\r\n      setState((s) => ({\r\n        ...s,\r\n        dragged: {\r\n          cellType,\r\n          gene,\r\n        },\r\n      }));\r\n    },\r\n    [cellType, gene, setState]\r\n  );\r\n  const cost = gene.getCost();\r\n  const draggable = !(gene.gene.blueprint.name === \"Living\" || gene.gene.blueprint.name === \"Inventory\");\r\n  return (\r\n    // <LookAtMouse zScale={8} displayBlock>\r\n    <div\r\n      className={classNames(\"gene\", state.view, gd.blueprint.name.replace(\" \", \"\"), { draggable })}\r\n      draggable={draggable}\r\n      onDragStart={handleDragStart}\r\n    >\r\n      <div className=\"gene-header\">\r\n        <GeneCost cost={cost} />\r\n        <h4>\r\n          {gd.blueprint.name} {gene.gene.blueprint.levelCosts.length > 1 ? gene.level + 1 : \"\"}\r\n        </h4>\r\n        {draggable ? <FaGripLines className=\"grip-lines\" /> : null}\r\n      </div>\r\n\r\n      <div className=\"description\">{gd.blueprint.description(gene.getProps(), gene.getStaticProperties())}</div>\r\n    </div>\r\n    // </LookAtMouse>\r\n  );\r\n};\r\n","import DynamicNumber from \"game/ui/common/DynamicNumber\";\r\nimport React from \"react\";\r\nimport { CellInteraction, CellType } from \"../../../core/cell/genome\";\r\nimport { spritesheetLoaded } from \"../../spritesheet\";\r\nimport IconCell from \"../common/IconCell\";\r\nimport { CellInteractionSelector } from \"./CellInteractionSelector\";\r\nimport { DraggedContext } from \"./DragInfo\";\r\nimport { GeneViewer } from \"./GeneViewer\";\r\nexport const CellTypeViewer: React.FC<{\r\n  cellType: CellType;\r\n}> = ({ cellType }) => {\r\n  const { chromosome, name } = cellType;\r\n  const [state, setState] = React.useContext(DraggedContext);\r\n  const handleDrop = React.useCallback(\r\n    (event: React.DragEvent) => {\r\n      event.preventDefault();\r\n      if (state.dragged != null) {\r\n        const { gene, cellType: leavingCellType } = state.dragged;\r\n        leavingCellType.chromosome.genes = leavingCellType.chromosome.genes.filter((g) => g !== gene);\r\n        cellType.chromosome.genes.push(gene);\r\n        setState((s) => ({ ...s, dragged: undefined }));\r\n      }\r\n    },\r\n    [cellType.chromosome.genes, state.dragged, setState]\r\n  );\r\n  const handleDragOver = React.useCallback((event: React.DragEvent) => {\r\n    event.preventDefault();\r\n    event.dataTransfer.dropEffect = \"move\";\r\n  }, []);\r\n  const handleSetInteraction = React.useCallback(\r\n    (i: CellInteraction | undefined) => {\r\n      cellType.interaction = i;\r\n    },\r\n    [cellType.interaction]\r\n  );\r\n  return (\r\n    <div className=\"cell-type\">\r\n      <div className=\"cell-header\">\r\n        <IconCell cellType={cellType} spritesheetLoaded={spritesheetLoaded} />\r\n        <div>\r\n          <h2>{name}</h2>\r\n          <CellInteractionSelector\r\n            key={cellType.name}\r\n            interaction={cellType.interaction}\r\n            setInteraction={handleSetInteraction}\r\n          />\r\n        </div>\r\n      </div>\r\n      <div className=\"gene-slots\">\r\n        Gene Slots Available:{\" \"}\r\n        <span className=\"slots-used\">\r\n          <DynamicNumber value={chromosome.geneSlotsNet()} />\r\n        </span>\r\n      </div>\r\n      <div className=\"chromosome\" onDragOver={handleDragOver} onDrop={handleDrop}>\r\n        {chromosome.genes.map((g, i) => (\r\n          <GeneViewer key={i} cellType={cellType} gene={g} />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n","import GenomeViewer from \"./GenomeViewer\";\r\n\r\nexport default GenomeViewer;\r\n","import classNames from \"classnames\";\r\nimport * as React from \"react\";\r\nimport { FaArrowsAltV } from \"react-icons/fa\";\r\nimport { TiThMenu } from \"react-icons/ti\";\r\nimport Genome from \"../../../core/cell/genome\";\r\nimport { AddCellCard } from \"./AddCellCard\";\r\nimport { CellTypeViewer } from \"./CellTypeViewer\";\r\nimport { DraggedContext, GenomeViewerState } from \"./DragInfo\";\r\nimport \"./GenomeViewer.scss\";\r\n\r\nconst GenomeViewer: React.FC<{ genome: Genome }> = ({ genome }) => {\r\n  const tuple = React.useState<GenomeViewerState>({ view: \"expanded\" });\r\n  const [state, setState] = tuple;\r\n  const handleViewSmall = React.useCallback(() => {\r\n    setState((s) => ({ ...s, view: \"small\" }));\r\n  }, [setState]);\r\n  const handleViewExpanded = React.useCallback(() => {\r\n    setState((s) => ({ ...s, view: \"expanded\" }));\r\n  }, [setState]);\r\n\r\n  return (\r\n    <DraggedContext.Provider value={tuple}>\r\n      <div className={classNames(\"genome-viewer\", { dragging: state.dragged != null })}>\r\n        <div className=\"view-switcher\">\r\n          <TiThMenu onClick={handleViewSmall} className={classNames(\"\", { active: state.view === \"small\" })} />\r\n          <FaArrowsAltV\r\n            onClick={handleViewExpanded}\r\n            className={classNames(\"\", { active: state.view === \"expanded\" })}\r\n          />\r\n        </div>\r\n        <div className=\"cell-types\">\r\n          {genome.cellTypes.map((c) => (\r\n            <CellTypeViewer key={c.name} cellType={c} />\r\n          ))}\r\n          <AddCellCard genome={genome} />\r\n        </div>\r\n      </div>\r\n    </DraggedContext.Provider>\r\n  );\r\n};\r\n\r\nexport default GenomeViewer;\r\n","import { Species } from \"core/species\";\r\nimport MP from \"game/ui/common/MP\";\r\nimport GenomeViewer from \"game/ui/GenomeViewer\";\r\nimport { DraggedContext, GenomeViewerState } from \"game/ui/GenomeViewer/DragInfo\";\r\nimport { generateRandomGenes } from \"game/ui/GenomeViewer/generateRandomGenes\";\r\nimport { GeneViewer } from \"game/ui/GenomeViewer/GeneViewer\";\r\nimport React, { useEffect } from \"react\";\r\nimport \"./SpeciesViewer.scss\";\r\nexport const SpeciesViewer: React.FC<{\r\n  species: Species;\r\n}> = ({ species }) => {\r\n  return (\r\n    <div className=\"species-viewer\">\r\n      <div className=\"header\">\r\n        <div className=\"species-name\">{species.name}</div>\r\n      </div>\r\n      {species.freeMutationPoints > 0 ? <MutationChooser species={species} /> : null}\r\n      <GenomeViewer genome={species.genome} />\r\n    </div>\r\n  );\r\n};\r\n\r\nconst MutationChooser: React.FC<{ species: Species }> = ({ species }) => {\r\n  const { freeMutationPoints, geneOptions } = species;\r\n  let geneEl: JSX.Element[] = [];\r\n  for (const geneOption of geneOptions) {\r\n    geneEl.push(<GeneViewer gene={geneOption} cellType={undefined!} />);\r\n  }\r\n\r\n  const tuple = React.useState<GenomeViewerState>({ view: \"expanded\" });\r\n  const [state, setState] = tuple;\r\n\r\n  useEffect(() => {\r\n    if (state.dragged) {\r\n      // add clicked genome to\r\n      species.genome.cellTypes[0].chromosome.genes.push(state.dragged.gene);\r\n      species.freeMutationPoints -= 1;\r\n      if (species.freeMutationPoints > 0) {\r\n        species.geneOptions = generateRandomGenes(3);\r\n      }\r\n      setState({\r\n        ...state,\r\n        dragged: undefined,\r\n      });\r\n    }\r\n  }, [setState, species.freeMutationPoints, species.geneOptions, species.genome.cellTypes, state, state.dragged]);\r\n\r\n  return (\r\n    <DraggedContext.Provider value={tuple}>\r\n      <div className=\"mutation-chooser\">\r\n        <h1>\r\n          <MP amount={freeMutationPoints} /> mutations left!\r\n        </h1>\r\n        <div className=\"gene-options\">{geneEl}</div>\r\n      </div>\r\n    </DraggedContext.Provider>\r\n  );\r\n};\r\n","import classNames from \"classnames\";\r\nimport { lineage, Species } from \"core/species\";\r\nimport { useAppReducer } from \"game/app\";\r\nimport { resetGame, save } from \"game/app/saveLoad\";\r\nimport { mitoOverworld } from \"game/audio\";\r\nimport { Button } from \"game/ui/common/Button\";\r\nimport PhylogeneticTree from \"game/ui/overworld/PhylogeneticTree\";\r\nimport React, { useCallback, useEffect, useState } from \"react\";\r\nimport { GiFamilyTree } from \"react-icons/gi\";\r\nimport ReactModal from \"react-modal\";\r\nimport { HexTile } from \"../../core/overworld/hexTile\";\r\nimport { EpochUI } from \"../ui/overworld/EpochUI\";\r\nimport { OverWorldMap } from \"../ui/overworld/map/OverWorldMap\";\r\nimport \"./OverWorldScreen.scss\";\r\nimport { SpeciesViewer } from \"./SpeciesViewer\";\r\n\r\nexport interface OverWorldScreenProps {\r\n  onNextEpoch: () => void;\r\n}\r\n\r\nconst OverWorldScreen = ({ onNextEpoch }: OverWorldScreenProps) => {\r\n  useEffect(() => {\r\n    mitoOverworld.play();\r\n    return () => {\r\n      mitoOverworld.stop();\r\n    };\r\n  }, []);\r\n\r\n  const [leftPanelOpen, setLeftPanelOpen] = useState(false);\r\n\r\n  useEffect(() => {\r\n    function handleKeyDown(e: KeyboardEvent) {\r\n      if (e.code === \"Tab\") {\r\n        setLeftPanelOpen((open) => !open);\r\n        e.preventDefault();\r\n      }\r\n    }\r\n    document.addEventListener(\"keydown\", handleKeyDown);\r\n    return () => {\r\n      document.removeEventListener(\"keydown\", handleKeyDown);\r\n    };\r\n  }, []);\r\n\r\n  const [genomeViewerSpecies, setGenomeViewerSpecies] = useState<Species>();\r\n\r\n  const handleStartMutate = useCallback((s: Species) => {\r\n    // TODO fill in\r\n    setGenomeViewerSpecies(s);\r\n  }, []);\r\n\r\n  const [{ rootSpecies }] = useAppReducer();\r\n\r\n  function maybeRenderPhylogeneticTreePanel() {\r\n    const unusedPoints = lineage(rootSpecies)\r\n      .map((x) => x.freeMutationPoints)\r\n      .reduce((a, b) => a + b);\r\n    const unusedPointsEl = unusedPoints > 0 ? <div className=\"unused-points\">{unusedPoints}</div> : null;\r\n    return (\r\n      <div className={classNames(\"panel-left\", { open: leftPanelOpen })}>\r\n        {leftPanelOpen ? <PhylogeneticTree onMutate={handleStartMutate} /> : null}\r\n        <button className=\"panel-left-handle\" onClick={() => setLeftPanelOpen((open) => !open)}>\r\n          <GiFamilyTree className=\"icon\" />\r\n          {unusedPointsEl}\r\n        </button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const closeGenomeViewer = useCallback(() => {\r\n    setGenomeViewerSpecies(undefined);\r\n  }, []);\r\n  function maybeRenderGenomeViewer() {\r\n    return (\r\n      <ReactModal\r\n        ariaHideApp\r\n        isOpen={genomeViewerSpecies != null}\r\n        shouldCloseOnEsc\r\n        shouldCloseOnOverlayClick\r\n        onRequestClose={closeGenomeViewer}\r\n        className=\"genome-viewer-modal\"\r\n      >\r\n        {genomeViewerSpecies != null ? (\r\n          <>\r\n            <button className=\"close\" onClick={closeGenomeViewer}>\r\n              \r\n            </button>\r\n            <SpeciesViewer species={genomeViewerSpecies} />\r\n          </>\r\n        ) : null}\r\n      </ReactModal>\r\n    );\r\n  }\r\n\r\n  const [focusedHex, setFocusedHex] = useState<HexTile | undefined>(undefined);\r\n  const handleFocusHex = useCallback((hex: HexTile) => {\r\n    setFocusedHex(hex);\r\n  }, []);\r\n\r\n  const [appState] = useAppReducer();\r\n\r\n  return (\r\n    <div className=\"overworld-screen\">\r\n      <OverWorldMap focusedHex={focusedHex} />\r\n      {maybeRenderPhylogeneticTreePanel()}\r\n      {maybeRenderGenomeViewer()}\r\n      <EpochUI onNextEpoch={onNextEpoch} onFocusHex={handleFocusHex} />\r\n      <div style={{ position: \"absolute\", right: \"10px\", top: \"10px\" }}>\r\n        <Button onClick={() => save(appState)}>Save</Button>\r\n      </div>\r\n      <div style={{ position: \"absolute\", right: \"10px\", top: \"60px\" }}>\r\n        <Button onClick={() => resetGame()}>Reset Game</Button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default OverWorldScreen;\r\n","import { sleep } from \"common/promise\";\r\nimport { OverWorld } from \"core/overworld/overWorld\";\r\nimport { newBaseSpecies } from \"core/species\";\r\nimport React, { useEffect } from \"react\";\r\nimport { AATransitionEnd, AppActions, AppReducerContext, reducer } from \"./reducer\";\r\nimport { load, saveOnActionMiddleware } from \"./saveLoad\";\r\nimport { AppState } from \"./state\";\r\n\r\nexport interface AppStateProviderProps {\r\n  children: React.ReactNode;\r\n  appState: AppState;\r\n}\r\n\r\n// when a TransitionStart action happens, automatically trigger a TransitionEnd\r\n// after millis\r\nexport function autoTransitionEndDispatchMiddleware(dispatch: React.Dispatch<AppActions>, millis = 2000) {\r\n  const newDispatch: React.Dispatch<AppActions> = (action: AppActions) => {\r\n    dispatch(action);\r\n    if (action.type === \"AATransitionStart\") {\r\n      sleep(millis).then(() => {\r\n        dispatch({ type: \"AATransitionEnd\" });\r\n      });\r\n    }\r\n  };\r\n  return newDispatch;\r\n}\r\n\r\nexport function handleTransitionEndMiddleware(\r\n  reducer: React.Reducer<AppState, AppActions>\r\n): React.Reducer<AppState, AppActions> {\r\n  function handleTransitionEnd(state: AppState, action: AATransitionEnd): AppState {\r\n    const { transition, ...stateWithoutTransition } = state;\r\n    const newState = reducer(stateWithoutTransition, transition!);\r\n    return newState;\r\n  }\r\n\r\n  return (state, action) => {\r\n    if (action.type === \"AATransitionEnd\") {\r\n      return handleTransitionEnd(state, action);\r\n    } else {\r\n      return reducer(state, action);\r\n    }\r\n  };\r\n}\r\n\r\nexport function AppStateProvider({ children, appState }: AppStateProviderProps) {\r\n  const reducerWithMiddleware = React.useMemo(() => handleTransitionEndMiddleware(saveOnActionMiddleware(reducer)), []);\r\n  const [state, dispatchRaw] = React.useReducer(reducerWithMiddleware, appState);\r\n  const dispatch = React.useMemo(() => autoTransitionEndDispatchMiddleware(dispatchRaw), []);\r\n  const reducerTuple = React.useMemo(() => [state, dispatch] as [AppState, React.Dispatch<AppActions>], [\r\n    state,\r\n    dispatch,\r\n  ]);\r\n  return <AppReducerContext.Provider value={reducerTuple}>{children}</AppReducerContext.Provider>;\r\n}\r\n\r\nexport const LocalForageStateProvider: React.FC<{ loadingComponent: JSX.Element }> = ({\r\n  children,\r\n  loadingComponent = null,\r\n}) => {\r\n  const [state, setState] = React.useState<AppState | null>(null);\r\n  useEffect(() => {\r\n    load()\r\n      .then((appState) => {\r\n        setState(appState);\r\n        console.log(\"loading\", appState);\r\n      })\r\n      .catch(() => {\r\n        const newGameState = newInitialAppState();\r\n        console.log(\"couldn't load appState from localForage; resetting game\", newGameState);\r\n        setState(newGameState);\r\n      });\r\n  }, []);\r\n\r\n  return state == null ? loadingComponent : <AppStateProvider appState={state}>{children}</AppStateProvider>;\r\n};\r\n\r\nexport function newInitialAppState(): AppState {\r\n  const overWorld = OverWorld.generateRectangle(100, 50);\r\n  const rootSpecies = newBaseSpecies(\"plantum originus\");\r\n  const startHex = overWorld.getStartHex();\r\n  // rootSpecies.freeMutationPoints = 25;\r\n  // const s3 = newBaseSpecies(\"s3\");\r\n  // s3.descendants = [newBaseSpecies(\"ya\"), newBaseSpecies(\"no\"), newBaseSpecies(\"whoa\")];\r\n  // let s: Species;\r\n  // rootSpecies.descendants = [s = newBaseSpecies(\"foo\"), newBaseSpecies(\"bar\"), s3];\r\n  // s.descendants = [newBaseSpecies(\"1\"), newBaseSpecies(\"2\")]\r\n  return {\r\n    overWorld,\r\n    rootSpecies,\r\n    activePopulationAttempt: {\r\n      settlingSpecies: rootSpecies,\r\n      targetHex: startHex,\r\n    },\r\n    epoch: 0,\r\n  };\r\n}\r\n","import { parse, stringify } from \"query-string\";\r\n\r\nconst PARAMS_DEFAULT = {\r\n  hud: true,\r\n  showGodUI: false,\r\n  debugPerf: false,\r\n  debug: process.env.NODE_ENV === \"development\",\r\n};\r\n\r\ntype Params = typeof PARAMS_DEFAULT;\r\n\r\nexport const params = { ...PARAMS_DEFAULT };\r\n\r\nconst search = parse(window.location.search);\r\nif (search.params != null) {\r\n  const urlHashParams: object = JSON.parse(search.params as string);\r\n  Object.assign(params, urlHashParams);\r\n}\r\n\r\nexport function updateParamsHash() {\r\n  const nonDefaultParams: Partial<Params> = {};\r\n  const keys = Object.keys(PARAMS_DEFAULT) as Array<keyof Params>;\r\n  for (const key of keys) {\r\n    const k = params[key];\r\n    if (k !== PARAMS_DEFAULT[key]) {\r\n      nonDefaultParams[key] = k as any;\r\n    }\r\n  }\r\n  if (Object.keys(nonDefaultParams).length > 0) {\r\n    const stringified = stringify({\r\n      ...parse(window.location.search),\r\n      params: JSON.stringify(nonDefaultParams),\r\n    });\r\n    window.location.search = stringified;\r\n  } else {\r\n  }\r\n}\r\nupdateParamsHash();\r\n","import { Vector2 } from \"three\";\r\n\r\nexport class Mouse {\r\n  public readonly position = new Vector2();\r\n\r\n  public isPressed = false;\r\n\r\n  public button = -1;\r\n\r\n  constructor(el: HTMLElement) {\r\n    el.addEventListener(\"mousedown\", this.handleMouseDown);\r\n    el.addEventListener(\"mousemove\", this.handleMouseMove);\r\n    el.addEventListener(\"mouseup\", this.handleMouseUp);\r\n  }\r\n\r\n  private handleMouseDown = (event: MouseEvent) => {\r\n    this.isPressed = true;\r\n    this.button = event.button;\r\n    this.handleMouseMove(event);\r\n  };\r\n\r\n  private handleMouseMove = (event: MouseEvent) => {\r\n    this.position.x = event.clientX!;\r\n    this.position.y = event.clientY!;\r\n  };\r\n\r\n  private handleMouseUp = (event: MouseEvent) => {\r\n    this.isPressed = false;\r\n    this.button = -1;\r\n    this.handleMouseMove(event);\r\n  };\r\n}\r\n","import * as React from \"react\";\r\nimport * as THREE from \"three\";\r\n\r\nexport const UI_EVENTS = {\r\n  click: true,\r\n  contextmenu: true,\r\n  dblclick: true,\r\n  mousedown: true,\r\n  mouseup: true,\r\n  mousemove: true,\r\n  touchstart: true,\r\n  touchmove: true,\r\n  touchend: true,\r\n  keyup: true,\r\n  keydown: true,\r\n  keypress: true,\r\n  wheel: true,\r\n};\r\n\r\nexport type UIEventReciever = {\r\n  [E in keyof typeof UI_EVENTS]?: (this: HTMLElement, ev: GlobalEventHandlersEventMap[E]) => void;\r\n  // [E in keyof typeof UI_EVENTS]?: (ev: Event) => void;\r\n};\r\n\r\nexport abstract class ISketch {\r\n  static id?: string;\r\n\r\n  public elements?: JSX.Element[];\r\n\r\n  public events?: UIEventReciever;\r\n\r\n  /**\r\n   * milliseconds since sketch started running.\r\n   */\r\n  public timeElapsed = 0;\r\n\r\n  public frameCount = 0;\r\n\r\n  constructor(public renderer: THREE.WebGLRenderer, public audioContext: SketchAudioContext) {}\r\n\r\n  /**\r\n   * height / width\r\n   */\r\n  get aspectRatio() {\r\n    return this.renderer.domElement.height / this.renderer.domElement.width;\r\n  }\r\n\r\n  get resolution() {\r\n    return new THREE.Vector2(this.renderer.domElement.width, this.renderer.domElement.height);\r\n  }\r\n\r\n  get canvas() {\r\n    return this.renderer.domElement;\r\n  }\r\n\r\n  abstract animate(millisElapsed: number): void;\r\n\r\n  render?(): React.ReactNode;\r\n\r\n  resize?(width: number, height: number): void;\r\n\r\n  destroy?(): void;\r\n}\r\n\r\nexport interface SketchAudioContext extends AudioContext {\r\n  gain: GainNode;\r\n}\r\n","import { Scene } from \"three\";\r\nimport { Mito } from \"../mito/mito\";\r\nexport abstract class Renderer<T> {\r\n  constructor(public target: T, public scene: Scene, public mito: Mito) {}\r\n\r\n  abstract update(): void;\r\n\r\n  abstract destroy(): void;\r\n}\r\n","// hack - to work with vscode-glsl-literal\r\nconst glsl = (x: TemplateStringsArray) => x[0];\r\n\r\nexport default glsl;\r\n","import { BufferAttribute, BufferGeometry, Color, DynamicDrawUsage, Points, ShaderMaterial, Texture } from \"three\";\r\nimport glsl from \"./glsl\";\r\n\r\nexport class CommittablePoints extends Points {\r\n  public geometry: BufferGeometry;\r\n\r\n  public material: ResourcePointsMaterial;\r\n\r\n  static newGeometry(size: number) {\r\n    const geometry = new BufferGeometry();\r\n    const positions = new Float32Array(size * 3);\r\n    const rotations = new Float32Array(size);\r\n    const sizes = new Float32Array(size);\r\n    const alphas = new Float32Array(size);\r\n    geometry.setAttribute(\"position\", new BufferAttribute(positions, 3).setUsage(DynamicDrawUsage));\r\n    geometry.setAttribute(\"rotation\", new BufferAttribute(rotations, 1).setUsage(DynamicDrawUsage));\r\n    geometry.setAttribute(\"size\", new BufferAttribute(sizes, 1).setUsage(DynamicDrawUsage));\r\n    geometry.setAttribute(\"alpha\", new BufferAttribute(alphas, 1).setUsage(DynamicDrawUsage));\r\n    return geometry;\r\n  }\r\n\r\n  constructor(size: number, public params: CommittablePointsParameters) {\r\n    super();\r\n    this.geometry = CommittablePoints.newGeometry(size);\r\n    this.material = new ResourcePointsMaterial(params);\r\n    this.frustumCulled = false;\r\n  }\r\n\r\n  private index = 0;\r\n\r\n  startFrame() {\r\n    this.index = 0;\r\n  }\r\n\r\n  commit(x: number, y: number, z: number, size: number, alpha: number, r?: number) {\r\n    this.geometry.attributes.position.setXYZ(this.index, x, y, z);\r\n    this.geometry.attributes.size.setX(this.index, size);\r\n    this.geometry.attributes.alpha.setX(this.index, alpha);\r\n    if (r != null) {\r\n      this.geometry.attributes.rotation.setX(this.index, r);\r\n    }\r\n    this.index++;\r\n  }\r\n\r\n  endFrame() {\r\n    const positions = this.geometry.attributes.position as BufferAttribute;\r\n    positions.needsUpdate = true;\r\n    const sizes = this.geometry.attributes.size as BufferAttribute;\r\n    sizes.needsUpdate = true;\r\n    const rotations = this.geometry.attributes.rotation as BufferAttribute;\r\n    rotations.needsUpdate = true;\r\n    const alphas = this.geometry.attributes.alpha as BufferAttribute;\r\n    alphas.needsUpdate = true;\r\n    this.geometry.setDrawRange(0, this.index);\r\n  }\r\n}\r\n\r\nexport interface CommittablePointsParameters {\r\n  opacity: number;\r\n  color: Color;\r\n  size: number;\r\n  map?: Texture;\r\n}\r\n\r\nclass ResourcePointsMaterial extends ShaderMaterial {\r\n  public map: Texture | undefined;\r\n\r\n  constructor(public params: CommittablePointsParameters) {\r\n    super({\r\n      uniforms: {\r\n        opacity: { value: params.opacity },\r\n        sizeGlobal: { value: params.size },\r\n        color: { value: params.color },\r\n        // you have to put it here too\r\n        map: { value: params.map },\r\n      },\r\n      vertexShader,\r\n      fragmentShader,\r\n      depthTest: false,\r\n      transparent: true,\r\n    } as any);\r\n\r\n    // OH MY GOD you can do this. You have to do this *AFTER* the super call!\r\n    // This hooks into threejs WebGLProgram's built-in properties that hooks up\r\n    // various named textures to glsl variables and #DEFINEs.\r\n    this.map = params.map;\r\n  }\r\n}\r\n\r\nconst vertexShader = glsl`\r\nattribute float size;\r\nattribute float rotation;\r\nattribute float alpha;\r\nuniform float sizeGlobal;\r\n\r\nvarying float vAlpha;\r\nvarying float vRotation;\r\n\r\nvoid main() {\r\n  vRotation = rotation;\r\n  vAlpha = alpha;\r\n  vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\r\n  gl_PointSize = size * sizeGlobal * -projectionMatrix[1].y;\r\n  gl_Position = projectionMatrix * mvPosition;\r\n}\r\n`;\r\n\r\nconst fragmentShader = glsl`\r\nuniform vec3 color;\r\nuniform sampler2D texture;\r\nuniform float opacity;\r\n\r\nvarying float vRotation;\r\nvarying float vAlpha;\r\n\r\n#ifdef USE_MAP\r\n  uniform mat3 uvTransform;\r\n  uniform sampler2D map;\r\n#endif\r\n\r\nvec2 rotateAround ( in vec2 v, in vec2 center, in float angle ) {\r\n\r\n  float c = cos( angle );\r\n  float s = sin( angle );\r\n\r\n  float x = v.x - center.x;\r\n  float y = v.y - center.y;\r\n\r\n  vec2 r = vec2(x * c - y * s + center.x, x * s + y * c + center.y);\r\n\r\n  return r;\r\n}\r\n\r\nvoid main() {\r\n  gl_FragColor = vec4( color, 1. );\r\n\r\n  #ifdef USE_MAP\r\n    vec2 uv = gl_PointCoord;\r\n\r\n    // flip vRotation to account for flipped y viewport\r\n    uv = clamp(rotateAround(uv, vec2(0.5), -vRotation), vec2(0.), vec2(1.));\r\n    vec4 mapTexel = texture2D( map, uv );\r\n    gl_FragColor *= mapTexelToLinear( mapTexel );\r\n  #endif\r\n  gl_FragColor.a *= opacity * vAlpha;\r\n}\r\n`;\r\n","import { CommittablePoints, CommittablePointsParameters } from \"./committablePoints\";\r\n\r\ninterface PointState<S> {\r\n  r?: number;\r\n  time: number;\r\n  size: number;\r\n  alpha: number;\r\n  x: number;\r\n  y: number;\r\n  z: number;\r\n  info: S;\r\n}\r\n\r\nexport class FireAndForgetPoints<S = any> extends CommittablePoints {\r\n  private state: Set<PointState<S>> = new Set();\r\n\r\n  constructor(public lifeFn: (s: PointState<S>, dt: number) => undefined | false, params: CommittablePointsParameters) {\r\n    super(10000, params);\r\n  }\r\n\r\n  fire(s: PointState<S>) {\r\n    this.state.add(s);\r\n  }\r\n\r\n  update(dt: number) {\r\n    const toRemove: PointState<S>[] = [];\r\n    for (const p of this.state) {\r\n      p.time += dt;\r\n      const nextState = this.lifeFn(p, dt);\r\n      if (nextState === false) {\r\n        toRemove.push(p);\r\n      }\r\n    }\r\n    for (const p of toRemove) {\r\n      this.state.delete(p);\r\n    }\r\n  }\r\n\r\n  commitAll() {\r\n    this.startFrame();\r\n    for (const p of this.state) {\r\n      this.commit(p.x, p.y, p.z, p.size, p.alpha, p.r);\r\n    }\r\n    this.endFrame();\r\n  }\r\n}\r\n","import { TileEvent } from \"core/tile/tileEvent\";\r\nimport { Renderer } from \"../Renderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\n\r\nexport abstract class EventRenderer<T extends TileEvent> extends Renderer<T[]> {\r\n  constructor(public eventName: T[\"type\"], public worldRenderer: WorldRenderer) {\r\n    super([], worldRenderer.scene, worldRenderer.mito);\r\n  }\r\n\r\n  abstract handle(event: T): void;\r\n\r\n  update() {\r\n    this.target = this.worldRenderer.target.getLastStepStats().events[this.eventName] as T[];\r\n  }\r\n}\r\n","import { TileEvent } from \"core/tile/tileEvent\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRenderer } from \"./eventRenderer\";\r\n\r\nexport abstract class EventRendererFFPoints<T extends TileEvent> extends EventRenderer<T> {\r\n  constructor(public eventName: T[\"type\"], public worldRenderer: WorldRenderer, public ffPoints: FireAndForgetPoints) {\r\n    super(eventName, worldRenderer);\r\n    this.scene.add(this.ffPoints);\r\n  }\r\n\r\n  abstract handle(event: T): void;\r\n\r\n  update() {\r\n    super.update();\r\n    this.ffPoints.update(1 / 30);\r\n    for (const event of this.target) {\r\n      this.handle(event);\r\n    }\r\n    this.ffPoints.commitAll();\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.ffPoints);\r\n  }\r\n}\r\n","import { EventCellEat } from \"core/tile/tileEvent\";\r\nimport { distScalar, eatBuffer } from \"game/audio\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { Audio, Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { InstancedTileRenderer } from \"../tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventCellEatRenderer extends EventRendererFFPoints<EventCellEat> {\r\n  static makePoints() {\r\n    const duration = 0.6;\r\n    return new FireAndForgetPoints(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const x = s.time / duration;\r\n        s.size = 4 * (x - x * x);\r\n      },\r\n      {\r\n        color: new Color(\"yellow\"),\r\n        opacity: 0.8,\r\n        size: 200,\r\n        map: textureFromSpritesheet(1, 3, \"transparent\"),\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"cell-eat\", target, EventCellEatRenderer.makePoints());\r\n  }\r\n\r\n  private audio = (() => {\r\n    const audio = new Audio(this.mito.audioListener);\r\n    audio.loop = true;\r\n    audio.setVolume(0);\r\n    eatBuffer.then((buffer) => {\r\n      audio.setBuffer(buffer);\r\n      audio.play();\r\n      audio.setDetune(600);\r\n    });\r\n    return audio;\r\n  })();\r\n\r\n  handle(event: EventCellEat) {\r\n    const { who } = event;\r\n    const baseVolume = 0.04;\r\n    const volume = distScalar(who, this.mito.world.player) * baseVolume;\r\n    if (volume > this.audio.gain.gain.value) {\r\n      this.audio.gain.gain.setValueAtTime(volume, 0);\r\n      this.audio.gain.gain.cancelScheduledValues(this.audio.context.currentTime + 1);\r\n      this.audio.gain.gain.setTargetAtTime(0, this.audio.context.currentTime + 1, 0.1);\r\n    }\r\n    const tileRenderer = this.worldRenderer.renderers.get(who) as InstancedTileRenderer | null;\r\n    const activeSugar = tileRenderer && tileRenderer.inventoryRenderer.getActiveSugar();\r\n    const dX = (activeSugar && activeSugar.x) || 0;\r\n    const dY = (activeSugar && activeSugar.y) || 0;\r\n    this.ffPoints.fire({\r\n      x: who.pos.x + dX,\r\n      y: who.pos.y + dY,\r\n      z: 1,\r\n      size: 1,\r\n      alpha: 1,\r\n      info: event,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","import { EventCellTransferEnergy } from \"core/tile/tileEvent\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { map } from \"math\";\r\nimport { Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventCellTransferEnergyRenderer extends EventRendererFFPoints<EventCellTransferEnergy> {\r\n  static makePoints() {\r\n    const duration = 0.5;\r\n    return new FireAndForgetPoints<EventCellTransferEnergy>(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n        const size = 4 * (t - t * t);\r\n\r\n        const { from, to } = s.info;\r\n        const { x, y } = from.pos.clone().lerp(to.pos, map(t, 0, 1, 0.45, 0.55));\r\n        // const x = (from.pos.x + to.pos.x) / 2;\r\n        // const y = (from.pos.y + to.pos.y) / 2;\r\n        s.x = x;\r\n        s.y = y;\r\n        s.size = size;\r\n      },\r\n      {\r\n        color: new Color(\"yellow\"),\r\n        opacity: 0.8,\r\n        size: 350,\r\n        map: textureFromSpritesheet(2, 3, \"transparent\"),\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"cell-transfer-energy\", target, EventCellTransferEnergyRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventCellTransferEnergy) {\r\n    const { from, to } = event;\r\n    const r = Math.atan2(to.pos.y - from.pos.y, to.pos.x - from.pos.x);\r\n\r\n    this.ffPoints.fire({\r\n      x: event.from.pos.x,\r\n      y: event.from.pos.y,\r\n      r,\r\n      z: 1,\r\n      size: 0.1,\r\n      alpha: 1,\r\n      info: event,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","export function mirrored(f: (t: number) => number) {\r\n  // https://bl.ocks.org/mbostock/3145795\r\n  return (t: number) => (t < 0.5 ? f(2 * t) : f(2 - 2 * t));\r\n}\r\n\r\nexport function reversed(f: (t: number) => number) {\r\n  return (t: number) => f(1 - t);\r\n}\r\n\r\n/**\r\n * t - t^2, scaled between 0-1\r\n * 0 = 0\r\n * 0.5 = 1\r\n * 1 = 0\r\n */\r\nexport function polyUpDown(t: number) {\r\n  return 4 * (t - t * t);\r\n}\r\n\r\n/**\r\n * (t^2-t^3) scaled to 0 and 1\r\n * 0 = 0\r\n * ...smooth upwards curve\r\n * 2/3 = 1\r\n * ...sharper downards curve\r\n * 1 = 0\r\n */\r\nexport function polyLateUpDown(t: number) {\r\n  return (27 / 4) * (t * t - t * t * t);\r\n}\r\n\r\nexport const polyEarlyUpDown = reversed(polyLateUpDown);\r\n","import { EventCollectSunlight } from \"core/tile/tileEvent\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { randFloat } from \"math\";\r\nimport { polyEarlyUpDown } from \"math/easing\";\r\nimport { Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRenderer } from \"./eventRenderer\";\r\n\r\nexport default class EventCollectSunlightRenderer extends EventRenderer<EventCollectSunlight> {\r\n  // private lightRays: LightRays;\r\n  private ffPoints: FireAndForgetPoints;\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"collect-sunlight\", target);\r\n    // this.lightRays = new LightRays();\r\n    // this.scene.add(this.lightRays.lineSegments);\r\n    const duration = 0.5;\r\n    // t.magFilter = LinearFilter;\r\n    this.ffPoints = new FireAndForgetPoints(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n        s.alpha = polyEarlyUpDown(t);\r\n        s.size = polyEarlyUpDown(t);\r\n      },\r\n      {\r\n        color: new Color(\"white\"),\r\n        opacity: 0.95,\r\n        size: 25,\r\n        map: textureFromSpritesheet(0, 4),\r\n      }\r\n    );\r\n    this.scene.add(this.ffPoints);\r\n  }\r\n\r\n  handle(event: EventCollectSunlight) {\r\n    let { numSunlight, leaf, point } = event;\r\n    while (numSunlight > 0) {\r\n      // if numSunlight is 0.5, only show half the sunlight events\r\n      if (numSunlight < 1 && numSunlight < Math.random()) {\r\n        return;\r\n      }\r\n      const x = point == null ? leaf.pos.x + (Math.random() - 0.5) : point.x + randFloat(-0.1, 0.1);\r\n      const y = point == null ? leaf.pos.y + (Math.random() - 0.5) : point.y + randFloat(-0.1, 0.1);\r\n      this.ffPoints.fire({\r\n        x,\r\n        y,\r\n        z: 10,\r\n        size: 1,\r\n        alpha: 1,\r\n        info: 0,\r\n        // stagger with the shouldUpdate of Tile so they look more continuous\r\n        time: Math.random() * (1 / 10),\r\n      });\r\n      numSunlight--;\r\n    }\r\n  }\r\n\r\n  update() {\r\n    super.update();\r\n    this.ffPoints.update(1 / 30);\r\n    for (const event of this.target) {\r\n      this.handle(event);\r\n    }\r\n    // this.lightRays.update(1 / 30);\r\n    this.ffPoints.commitAll();\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.ffPoints);\r\n    // this.scene.remove(this.lightRays.lineSegments);\r\n  }\r\n}\r\n","import Ticker from \"std/ticker\";\r\nimport { Color, Scene, Vector2 } from \"three\";\r\nimport lazy from \"../../common/lazy\";\r\nimport { Inventory } from \"../../core/inventory\";\r\nimport { map } from \"../../math\";\r\nimport { Mito } from \"../mito/mito\";\r\nimport { textureFromSpritesheet } from \"../spritesheet\";\r\nimport { CommittablePoints } from \"./committablePoints\";\r\nimport { Renderer } from \"./Renderer\";\r\n\r\n// default\r\nconst graphics = {\r\n  particlesPerWater: 1,\r\n  particleSize: 45,\r\n  particleRepelStrength: 0.003,\r\n};\r\n\r\n// woooow\r\n// const graphics = {\r\n//   particlesPerWater: 10,\r\n//   particleSize: 25,\r\n//   particleRepelStrength: 0.0005,\r\n// };\r\n\r\n// we represent Resources as dots of certain colors.\r\nexport class InventoryRenderer extends Renderer<Inventory> {\r\n  static WaterParticles = lazy(\r\n    () =>\r\n      new CommittablePoints(10000, {\r\n        color: new Color(\"rgb(9, 12, 255)\"),\r\n        size: graphics.particleSize,\r\n        opacity: 0.75,\r\n      })\r\n  );\r\n\r\n  static SugarParticles = lazy(\r\n    () =>\r\n      new CommittablePoints(10000, {\r\n        color: new Color(\"yellow\"),\r\n        size: 85,\r\n        opacity: 0.9,\r\n        map: textureFromSpritesheet(2, 2, \"transparent\"),\r\n      })\r\n  );\r\n\r\n  static startFrame() {\r\n    InventoryRenderer.WaterParticles().startFrame();\r\n    InventoryRenderer.SugarParticles().startFrame();\r\n  }\r\n\r\n  static endFrame() {\r\n    InventoryRenderer.WaterParticles().endFrame();\r\n    InventoryRenderer.SugarParticles().endFrame();\r\n  }\r\n\r\n  public animationOffset = 0;\r\n\r\n  public waters: Vector2[] = [];\r\n\r\n  public sugars: Vector2[] = [];\r\n\r\n  private activeSugar?: Vector2;\r\n\r\n  private stableWater?: Vector2;\r\n\r\n  constructor(target: Inventory, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    target.on(\"get\", this.handleGetResources);\r\n    target.on(\"give\", this.handleGiveResources);\r\n    target.on(\"add\", this.handleAddResources);\r\n\r\n    this.updateSugarAndWaterParticles();\r\n  }\r\n\r\n  private handleGetResources = (giver: Inventory) => {\r\n    this.updateSugarAndWaterParticles(giver);\r\n  };\r\n\r\n  private verifyArrayLengths() {\r\n    if (this.waters.length !== Math.ceil(this.target.water * graphics.particlesPerWater)) {\r\n      throw new Error(\r\n        \"water array lengths mismatch: \" + this.waters.length + \" should be \" + Math.ceil(this.target.water)\r\n      );\r\n    }\r\n    if (this.sugars.length !== Math.ceil(this.target.sugar)) {\r\n      throw new Error(\r\n        \"sugar array lengths mismatch: \" + this.sugars.length + \" should be \" + Math.ceil(this.target.sugar)\r\n      );\r\n    }\r\n  }\r\n\r\n  private handleGiveResources = () => {\r\n    this.updateSugarAndWaterParticles();\r\n  };\r\n\r\n  private handleAddResources = (water: number, sugar: number) => {\r\n    this.updateSugarAndWaterParticles();\r\n  };\r\n\r\n  private updateSugarAndWaterParticles(giver?: Inventory) {\r\n    this.updateParticlesArray(this.waters, this.target.water * graphics.particlesPerWater, giver);\r\n    this.updateParticlesArray(this.sugars, this.target.sugar, giver);\r\n    this.verifyArrayLengths();\r\n  }\r\n\r\n  private updateParticlesArray(particles: Vector2[], resource: number, giver?: Inventory) {\r\n    const wantedParticles = Math.ceil(resource);\r\n    while (particles.length < wantedParticles) {\r\n      // // see if we can find the giver's InventoryRenderer\r\n      // if (giver != null) {\r\n      //   const carrier = giver.carrier;\r\n      //   const carrierRenderer = this.mito.worldRenderer.getOrCreateRenderer(carrier as any);\r\n      //   if (carrierRenderer instanceof InstancedTileRenderer) {\r\n      //     const carrierInventoryRenderer = carrierRenderer.inventoryRenderer;\r\n      //     const\r\n      //   }\r\n      const v = giver != null ? giver.carrier.pos.clone().sub(this.target.carrier.pos) : newParticle();\r\n      v.x += (Math.random() - 0.5) * 0.1;\r\n      v.y += (Math.random() - 0.5) * 0.1;\r\n      particles.push(v);\r\n    }\r\n    if (particles.length > wantedParticles) {\r\n      // delete from the start - makes soil water feel\r\n      // more dynamic since every small movement shows an animation\r\n      // particles.splice(0, particles.length - wantedParticles);\r\n\r\n      // delete from the end:\r\n      // otherwise going from 2.1 -> 2 water looks broken\r\n      // (the size 0.1 water suddenly becomes the size 1 water)\r\n      // makes soil water feel much more static\r\n      particles.splice(wantedParticles);\r\n    }\r\n    if (particles.length !== wantedParticles) {\r\n      throw new Error(\"array lengths mismatch: \" + particles.length + \" should be \" + wantedParticles);\r\n    }\r\n    return particles;\r\n  }\r\n\r\n  private commitParticles(particles: CommittablePoints, resource: number, resourceArray: Vector2[]) {\r\n    // this.verifyArrayLengths();\r\n    const numFullSizedParticles = Math.floor(resource);\r\n    for (let i = 0; i < numFullSizedParticles; i++) {\r\n      const p = resourceArray[i];\r\n      particles.commit(p.x + this.target.carrier.pos.x, p.y + this.target.carrier.pos.y, 10, 1, 1);\r\n    }\r\n    const fract = resource - numFullSizedParticles;\r\n    if (fract > 0) {\r\n      const p = resourceArray[resourceArray.length - 1];\r\n      particles.commit(\r\n        p.x + this.target.carrier.pos.x,\r\n        p.y + this.target.carrier.pos.y,\r\n        10,\r\n        map(Math.sqrt(fract), 0, 1, 0.2, 1),\r\n        1\r\n      );\r\n    }\r\n  }\r\n\r\n  private simulateResourcePositions() {\r\n    const numWaters = this.waters.length;\r\n    const numResources = numWaters + this.sugars.length;\r\n    for (let i = 0; i < numResources; i++) {\r\n      const r = i < numWaters ? this.waters[i] : this.sugars[i - numWaters];\r\n      let vx = 0,\r\n        vy = 0;\r\n\r\n      const angle = Ticker.now / 3000 + this.animationOffset;\r\n      vx += Math.cos(angle) * 0.02;\r\n\r\n      const goTowardsCenterStrength = 0.1 + r.length() * 0.1;\r\n      vx += -r.x * goTowardsCenterStrength;\r\n      vy += -r.y * goTowardsCenterStrength;\r\n\r\n      // vx += -((r.x * 2) ** 1) * 0.2;\r\n      // vy += -((r.y * 2) ** 3) * 0.1;\r\n      const player = this.mito.world.player;\r\n      if (player.pos.equals(this.target.carrier.pos)) {\r\n        const playerX = player.posFloat.x - player.pos.x;\r\n        const playerY = player.posFloat.y - player.pos.y;\r\n        const offsetX = r.x - playerX;\r\n        const offsetY = r.y - playerY;\r\n        const mag2 = offsetX * offsetX + offsetY * offsetY;\r\n        const avoidPlayerStrength = Math.max(Math.min(map(mag2, 0, 1, 3, -5), 3), 0);\r\n        const accelerationX = offsetX * avoidPlayerStrength * 0.2;\r\n        const accelerationY = offsetY * avoidPlayerStrength * 0.2;\r\n        vx += accelerationX;\r\n        vy += accelerationY;\r\n      }\r\n      for (let j = 0; j < numResources; j++) {\r\n        const l = j < numWaters ? this.waters[j] : this.sugars[j - numWaters];\r\n        if (r === l) {\r\n          break;\r\n        }\r\n        const dx = r.x - l.x;\r\n        const dy = r.y - l.y;\r\n        const lengthSq = dx * dx + dy * dy;\r\n        if (lengthSq > 0) {\r\n          const isFractional = j < numWaters ? j === this.waters.length - 1 : j - numWaters === this.sugars.length - 1;\r\n          let strength = graphics.particleRepelStrength / lengthSq; // + graphics.particleRepelStrength / Math.sqrt(lengthSq);\r\n          if (isFractional) {\r\n            const fraction = j < numWaters ? this.target.water % 1 : this.target.sugar % 1;\r\n            strength *= fraction;\r\n          }\r\n          vx += dx * strength;\r\n          vy += dy * strength;\r\n        }\r\n      }\r\n      r.x += vx;\r\n      r.y += vy;\r\n      // r.x *= 0.9;\r\n    }\r\n  }\r\n\r\n  update() {\r\n    this.simulateResourcePositions();\r\n    this.commitParticles(\r\n      InventoryRenderer.WaterParticles(),\r\n      this.target.water * graphics.particlesPerWater,\r\n      this.waters\r\n    );\r\n    this.commitParticles(InventoryRenderer.SugarParticles(), this.target.sugar, this.sugars);\r\n    this.activeSugar = this.sugars[this.sugars.length - 1];\r\n    this.stableWater = this.waters[0];\r\n  }\r\n\r\n  destroy() {\r\n    this.target.off(\"get\", this.handleGetResources);\r\n    this.target.off(\"give\", this.handleGiveResources);\r\n    this.target.off(\"add\", this.handleAddResources);\r\n  }\r\n\r\n  /**\r\n   * Stores the position of the fractional sugar in the last update.\r\n   * This is used by other renderers to position e.g. eat effects directly\r\n   * on the particle.\r\n   */\r\n  public getActiveSugar() {\r\n    return this.activeSugar;\r\n  }\r\n\r\n  /**\r\n   * See getActiveSugar(), but this returns the \"oldest\" water.\r\n   */\r\n  public getStableWater() {\r\n    return this.stableWater;\r\n  }\r\n}\r\n\r\nfunction newParticle() {\r\n  return new Vector2((Math.random() - 0.5) * 0.01, (Math.random() - 0.5) * 0.01);\r\n}\r\n","import { EventEvaporation } from \"core/tile/tileEvent\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { InventoryRenderer } from \"../InventoryRenderer\";\r\nimport { InstancedTileRenderer } from \"../tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventEvaporationRenderer extends EventRendererFFPoints<EventEvaporation> {\r\n  static makePoints() {\r\n    const duration = 1.5;\r\n    return new FireAndForgetPoints<EventEvaporation>(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n        const size = 1 + t;\r\n        const alpha = 1 - t;\r\n\r\n        s.x += Math.sin(t * 12) * 0.01;\r\n        s.y -= 0.01;\r\n        s.alpha = alpha;\r\n        s.size = size;\r\n      },\r\n      { ...InventoryRenderer.WaterParticles().params }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"evaporation\", target, EventEvaporationRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventEvaporation) {\r\n    if (event.tile.darkness >= 1) {\r\n      return;\r\n    }\r\n    const tileRenderer = this.worldRenderer.renderers.get(event.tile) as InstancedTileRenderer | null;\r\n    const stableWater = tileRenderer && tileRenderer.inventoryRenderer.getStableWater();\r\n    const dX = (stableWater && stableWater.x) || 0;\r\n    const dY = (stableWater && stableWater.y) || 0;\r\n    this.ffPoints.fire({\r\n      x: event.tile.pos.x + dX,\r\n      y: event.tile.pos.y + dY,\r\n      z: 1,\r\n      size: 1,\r\n      alpha: 1,\r\n      info: event,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","import { EventGrowFruit } from \"core/tile/tileEvent\";\r\nimport { easeCubicIn } from \"d3-ease\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { map } from \"math\";\r\nimport { polyUpDown } from \"math/easing\";\r\nimport { Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventGrowFruitRenderer extends EventRendererFFPoints<EventGrowFruit> {\r\n  static makePoints() {\r\n    const duration = 1.0;\r\n    return new FireAndForgetPoints(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n\r\n        const { cell, resourcesUsed, a0 } = s.info;\r\n        const dist = map(easeCubicIn(t), 0, 1, 0.7, 0.0);\r\n        const angle = map(t, 0, 1, 0, Math.PI / 2) + a0;\r\n        const size = Math.sqrt(polyUpDown(t)) * resourcesUsed;\r\n        s.x = cell.pos.x + Math.cos(angle) * dist;\r\n        s.y = cell.pos.y + Math.sin(angle) * dist;\r\n        s.size = size;\r\n        s.r = angle;\r\n      },\r\n      {\r\n        size: 200,\r\n        opacity: 0.8,\r\n        color: new Color(\"white\"),\r\n        map: textureFromSpritesheet(0, 5),\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"grow-fruit\", target, EventGrowFruitRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventGrowFruit) {\r\n    const { cell } = event;\r\n\r\n    for (let i = 0; i < 4; i++) {\r\n      this.ffPoints.fire({\r\n        x: cell.pos.x,\r\n        y: cell.pos.y,\r\n        z: 1,\r\n        alpha: 1,\r\n        info: { ...event, a0: Math.random() * Math.PI * 2 },\r\n        size: 0,\r\n        time: 0,\r\n      });\r\n    }\r\n  }\r\n}\r\n","import { EventPhotosynthesis } from \"core/tile/tileEvent\";\r\nimport { textureFromSpritesheet } from \"game/spritesheet\";\r\nimport { polyUpDown } from \"math/easing\";\r\nimport { Color } from \"three\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { InstancedTileRenderer } from \"../tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventPhotosynthesisRenderer extends EventRendererFFPoints<EventPhotosynthesis> {\r\n  static makePoints() {\r\n    const duration = 0.5;\r\n    return new FireAndForgetPoints<EventPhotosynthesis>(\r\n      (s) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n\r\n        s.alpha = polyUpDown(t) ** (1 / 4);\r\n        s.size = ((1 - t) ** 1 / 2) * 2 * s.info.amount;\r\n        s.r = t * s.time;\r\n      },\r\n      {\r\n        color: new Color(\"yellow\"),\r\n        opacity: 0.95,\r\n        size: 200,\r\n        map: textureFromSpritesheet(3, 3),\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"photosynthesis\", target, EventPhotosynthesisRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventPhotosynthesis) {\r\n    const tileRenderer = this.worldRenderer.renderers.get(event.cell) as InstancedTileRenderer | null;\r\n    const stableWater = tileRenderer && tileRenderer.inventoryRenderer.getStableWater();\r\n    const dX = (stableWater && stableWater.x) || 0;\r\n    const dY = (stableWater && stableWater.y) || 0;\r\n    this.ffPoints.fire({\r\n      x: event.cell.pos.x + dX,\r\n      y: event.cell.pos.y + dY,\r\n      z: 1,\r\n      size: 1,\r\n      alpha: 1,\r\n      info: event,\r\n      time: 0,\r\n    });\r\n  }\r\n}\r\n","import { CancerEffect } from \"core/cell/cellEffect\";\r\nimport { lerp } from \"math\";\r\nimport { Color, DoubleSide, Mesh, MeshBasicMaterial, PlaneBufferGeometry, RingBufferGeometry, Scene } from \"three\";\r\nimport { Cell, CellEffect, FreezeEffect } from \"../../../core/tile\";\r\nimport Mito from \"../../mito/mito\";\r\nimport { textureFromSpritesheet } from \"../../spritesheet\";\r\nimport { Renderer } from \"../Renderer\";\r\n\r\nexport class CellEffectsRenderer extends Renderer<Cell> {\r\n  private renderers: Renderer<CellEffect>[] = [];\r\n\r\n  update() {\r\n    // account for if target has more effects\r\n    let index;\r\n    for (index = 0; index < this.target.effects.length; index++) {\r\n      const effect = this.target.effects[index];\r\n      const renderer = this.renderers[index];\r\n      if (renderer == null) {\r\n        this.renderers[index] = createEffectRenderer(effect, this.scene, this.mito);\r\n      } else if (effect !== renderer.target) {\r\n        // delete and add new renderer\r\n        renderer.destroy();\r\n        this.renderers[index] = createEffectRenderer(effect, this.scene, this.mito);\r\n      }\r\n    }\r\n    // delete extraneous effects\r\n    for (; index < this.renderers.length; index++) {\r\n      const renderer = this.renderers[index];\r\n      renderer.destroy();\r\n    }\r\n\r\n    for (const r of this.renderers) {\r\n      r.update();\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const r of this.renderers) {\r\n      r.destroy();\r\n    }\r\n  }\r\n}\r\n\r\nfunction createEffectRenderer<T extends CellEffect>(effect: T, scene: Scene, mito: Mito): Renderer<CellEffect> {\r\n  if (effect instanceof FreezeEffect) {\r\n    return new FreezeEffectRenderer(effect, scene, mito);\r\n  } else if (effect instanceof CancerEffect) {\r\n    return new CancerEffectRenderer(effect, scene, mito);\r\n  } else {\r\n    throw new Error(\"effect renderer not defined for\" + effect);\r\n  }\r\n}\r\n\r\n// export const FREEZE_BLUE = new Color(\"#1E90FF\").lerp(new Color(0), 0.5);\r\nexport const FREEZE_BLUE = new Color(\"lightblue\");\r\n\r\nclass FreezeEffectRenderer extends Renderer<FreezeEffect> {\r\n  static newMesh = (() => {\r\n    const g = new PlaneBufferGeometry(1, 1);\r\n    const material = new MeshBasicMaterial({\r\n      map: textureFromSpritesheet(1, 2),\r\n      side: DoubleSide,\r\n      color: FREEZE_BLUE,\r\n      transparent: true,\r\n      opacity: 0.5,\r\n    });\r\n    const mesh = new Mesh(g, material);\r\n    return () => mesh.clone();\r\n  })();\r\n\r\n  private mesh: Mesh;\r\n\r\n  constructor(target: FreezeEffect, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    this.mesh = FreezeEffectRenderer.newMesh();\r\n    scene.add(this.mesh);\r\n    this.mesh.scale.set(0.01, 0.01, 1);\r\n  }\r\n\r\n  update() {\r\n    const percentFrozen = this.target.percentFrozen;\r\n    const s = percentFrozen ** 0.5;\r\n    this.mesh.scale.x = lerp(this.mesh.scale.x, s, 0.2);\r\n    this.mesh.scale.y = lerp(this.mesh.scale.y, s, 0.2);\r\n    const cell = this.target.cell;\r\n    const pos = cell.pos;\r\n    this.mesh.position.set(pos.x, pos.y + cell.droopY, 2);\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.mesh);\r\n  }\r\n}\r\n\r\nclass CancerEffectRenderer extends Renderer<CancerEffect> {\r\n  static newMesh = (() => {\r\n    // const g = new PlaneBufferGeometry(1, 1);\r\n    const g = new RingBufferGeometry(0.4, 0.5, 20, 20);\r\n    const material = new MeshBasicMaterial({\r\n      map: textureFromSpritesheet(0, 1),\r\n      side: DoubleSide,\r\n      color: new Color(\"purple\"),\r\n      transparent: true,\r\n      opacity: 0.5,\r\n    });\r\n    const mesh = new Mesh(g, material);\r\n    return () => mesh.clone();\r\n  })();\r\n\r\n  private mesh: Mesh;\r\n\r\n  constructor(target: CancerEffect, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    this.mesh = CancerEffectRenderer.newMesh();\r\n    scene.add(this.mesh);\r\n    this.mesh.scale.set(0.01, 0.01, 1);\r\n  }\r\n\r\n  update() {\r\n    const { timeToDuplicate, secondsPerDuplication } = this.target;\r\n    const s = (1 - timeToDuplicate / secondsPerDuplication) ** 0.5;\r\n    this.mesh.scale.x = lerp(this.mesh.scale.x, s, 0.2);\r\n    this.mesh.scale.y = lerp(this.mesh.scale.y, s, 0.2);\r\n    const cell = this.target.cell;\r\n    const pos = cell.pos;\r\n    this.mesh.position.set(pos.x, pos.y + cell.droopY, 2);\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.mesh);\r\n  }\r\n}\r\n","import { EventThawIce } from \"core/tile/tileEvent\";\r\nimport { easeSinOut } from \"d3-ease\";\r\nimport { map } from \"math\";\r\nimport { FireAndForgetPoints } from \"../fireAndForgetPoints\";\r\nimport { FREEZE_BLUE } from \"../tile/CellEffectsRenderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { EventRendererFFPoints } from \"./eventRendererFFPoints\";\r\n\r\nexport default class EventThawIceRenderer extends EventRendererFFPoints<EventThawIce> {\r\n  static makePoints() {\r\n    const duration = 0.6;\r\n    return new FireAndForgetPoints(\r\n      (s, dt) => {\r\n        if (s.time > duration) {\r\n          return false;\r\n        }\r\n        const t = s.time / duration;\r\n        const { dx, dy } = s.info;\r\n        s.x += dx * dt;\r\n        s.y += dy * dt;\r\n        s.alpha = t < 0.75 ? 1 : easeSinOut(map(t, 0.75, 1, 1, 0));\r\n      },\r\n      {\r\n        size: 40,\r\n        opacity: 0.5,\r\n        color: FREEZE_BLUE,\r\n      }\r\n    );\r\n  }\r\n\r\n  constructor(target: WorldRenderer) {\r\n    super(\"thaw\", target, EventThawIceRenderer.makePoints());\r\n  }\r\n\r\n  handle(event: EventThawIce) {\r\n    const { where } = event;\r\n\r\n    for (let i = 0; i < 4; i++) {\r\n      const angle = Math.random() * Math.PI * 2;\r\n      const speed = 1;\r\n      const dx = Math.cos(angle) * speed;\r\n      const dy = Math.sin(angle) * speed;\r\n      this.ffPoints.fire({\r\n        x: where.pos.x,\r\n        y: where.pos.y,\r\n        z: 1,\r\n        alpha: 1,\r\n        info: { dx, dy },\r\n        size: map(Math.random(), 0, 1, 0.5, 1.5),\r\n        time: 0,\r\n        r: angle,\r\n      });\r\n    }\r\n  }\r\n}\r\n","import { TileEvent, TileEventType } from \"../../../core/tile/tileEvent\";\r\nimport { Renderer } from \"../Renderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport EventCellEatRenderer from \"./eventCellEatRenderer\";\r\nimport EventCellTransferEnergyRenderer from \"./eventCellTransferEnergyRenderer\";\r\nimport EventCollectSunlightRenderer from \"./eventCollectSunlightRenderer\";\r\nimport EventEvaporationRenderer from \"./eventEvaporationRenderer\";\r\nimport EventGrowFruitRenderer from \"./eventGrowFruitRenderer\";\r\nimport EventPhotosynthesisRenderer from \"./eventPhotosynthesisRenderer\";\r\nimport { EventRenderer } from \"./eventRenderer\";\r\nimport EventThawIceRenderer from \"./eventThawIceRenderer\";\r\n\r\nexport class EventLogRenderer extends Renderer<WorldRenderer> {\r\n  private singleEventRenderers = {\r\n    \"cell-eat\": new EventCellEatRenderer(this.target),\r\n    \"cell-transfer-energy\": new EventCellTransferEnergyRenderer(this.target),\r\n    evaporation: new EventEvaporationRenderer(this.target),\r\n    photosynthesis: new EventPhotosynthesisRenderer(this.target),\r\n    thaw: new EventThawIceRenderer(this.target),\r\n    \"collect-sunlight\": new EventCollectSunlightRenderer(this.target),\r\n    \"grow-fruit\": new EventGrowFruitRenderer(this.target),\r\n  } as { [K in TileEventType]?: EventRenderer<Extract<TileEvent, { type: K }>> };\r\n\r\n  constructor(worldRenderer: WorldRenderer) {\r\n    super(worldRenderer, worldRenderer.scene, worldRenderer.mito);\r\n  }\r\n\r\n  update() {\r\n    const events = this.target.target.getLastStepStats().events;\r\n    let eventName: TileEventType;\r\n    for (eventName in events) {\r\n      const renderer = this.singleEventRenderers[eventName];\r\n      if (renderer != null) {\r\n        renderer.update();\r\n      }\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    for (const renderer of Object.values(this.singleEventRenderers)) {\r\n      if (renderer != null) {\r\n        renderer.destroy();\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { lerp, lerp2 } from \"math\";\r\nimport { arrayRange } from \"math/arrays\";\r\nimport {\r\n  CircleBufferGeometry,\r\n  DoubleSide,\r\n  Geometry,\r\n  Line,\r\n  LineBasicMaterial,\r\n  Mesh,\r\n  MeshBasicMaterial,\r\n  Object3D,\r\n  Vector2,\r\n} from \"three\";\r\n\r\nexport const playerBrown = 0x8f673f;\r\nexport const playerTeal = 0x5eb780;\r\n\r\nconst baseMesh = (() => {\r\n  const geometry = new CircleBufferGeometry(0.07, 20);\r\n  const material = new MeshBasicMaterial({\r\n    color: playerTeal,\r\n    // color: ,\r\n    side: DoubleSide,\r\n  });\r\n  const mesh = new Mesh(geometry, material);\r\n  return mesh;\r\n})();\r\n\r\nclass Node {\r\n  constructor(public pos: Vector2, public vel: Vector2 = new Vector2(0, 0), public scale = 1) {}\r\n}\r\n/**\r\n * For now: A thick line that branches out into 3 nodes.\r\n *\r\n * Should have a physics-y feel to it (maybe bones?)\r\n * Be UV-able\r\n */\r\nclass NeuronMesh extends Object3D {\r\n  // const geom = new LineGeometry();\r\n  // geom.setPositions([0, 0, 0, 1, 0, 0]);\r\n  // geom.setColors([1, 1, 1, 1, 0, 0]);\r\n  // const mat = new LineMaterial({\r\n  //   color: 0xffffff,\r\n  //   linewidth: 5,\r\n  //   vertexColors: VertexColors,\r\n  //   dashed: false,\r\n  // });\r\n  // mat.resolution.set(window.innerWidth, window.innerHeight);\r\n\r\n  // const line = new Line2(geom, mat);\r\n  // line.computeLineDistances();\r\n  // line.scale.set(1, 1, 1);\r\n  // return line;\r\n\r\n  public nodes: Node[] = [];\r\n\r\n  public meshes: Mesh[] = [];\r\n\r\n  public line: Line;\r\n\r\n  constructor(numNodes: number) {\r\n    super();\r\n    this.nodes = arrayRange(numNodes).map((i) => {\r\n      return new Node(new Vector2(i / numNodes, 0));\r\n    });\r\n    this.meshes = this.nodes.map((n) => {\r\n      const m = baseMesh.clone();\r\n      m.position.set(n.pos.x, n.pos.y, m.position.z);\r\n      return m;\r\n    });\r\n    this.add(...this.meshes);\r\n    const lineGeo = new Geometry();\r\n    lineGeo.vertices.push(...this.meshes.map((m) => m.position));\r\n    this.line = new Line(\r\n      lineGeo,\r\n      new LineBasicMaterial({\r\n        color: playerTeal,\r\n      })\r\n    );\r\n    this.add(this.line);\r\n    // const r1 = new Mesh(\r\n    //   new PlaneBufferGeometry(0.7, 0.1).translate(0.35, 0, 0),\r\n    //   new MeshBasicMaterial({ side: DoubleSide, color: 0x8f673f })\r\n    // );\r\n    // const branchLeft = new Mesh(\r\n    //   new PlaneBufferGeometry(0.3, 0.05).translate(0.15, 0, 0),\r\n    //   new MeshBasicMaterial({ side: DoubleSide, color: 0x5eb780 })\r\n    // );\r\n    // branchLeft.position.set(0.35, 0, 0);\r\n    // const branchCenter = branchLeft.clone();\r\n    // const branchRight = branchLeft.clone();\r\n    // branchLeft.rotation.z = -Math.PI / 3;\r\n    // branchRight.rotation.z = Math.PI / 3;\r\n\r\n    // r1.add(branchLeft, branchCenter, branchRight);\r\n    // this.add(r1);\r\n\r\n    // const gui = new GUI();\r\n    // gui.add(this, \"pullForceScalar\", 0, 100);\r\n    // gui.add(this, \"towardsTargetForce\", 0, 100);\r\n    // gui.add(this, \"dragForceScalar\", -100, -0);\r\n  }\r\n\r\n  public handleInteracted() {\r\n    const last = this.nodes[this.nodes.length - 1];\r\n    last.scale = 2.1;\r\n  }\r\n\r\n  private pullForceScalar = 10;\r\n\r\n  private towardsTargetForce = 5;\r\n\r\n  private dragForceScalar = -3;\r\n\r\n  update(dt: number, target: Vector2) {\r\n    // node 0 is always tied to 0, 0\r\n    // node n is tied directly at target\r\n    // intermediate nodes move towards their targets\r\n    // const first = this.nodes[0];\r\n    const last = this.nodes[this.nodes.length - 1];\r\n    lerp2(last.pos, target, 0.5);\r\n    let force = new Vector2();\r\n    for (let i = 1; i < this.nodes.length - 1; i++) {\r\n      force.set(0, 0);\r\n\r\n      const node = this.nodes[i];\r\n      const prev = this.nodes[i - 1];\r\n      const next = this.nodes[i + 1];\r\n\r\n      // prev force\r\n      force.add(this.pullForce(node, prev, this.pullForceScalar));\r\n      force.add(this.pullForce(node, next, this.pullForceScalar));\r\n      force.add(this.goTowardsTargetForce(node, target, i / (this.nodes.length - 1), this.towardsTargetForce));\r\n      force.add(this.dragForce(node, this.dragForceScalar));\r\n\r\n      node.scale = lerp(node.scale, next.scale, 0.5);\r\n\r\n      node.vel.add(force.multiplyScalar(dt));\r\n    }\r\n\r\n    this.nodes.forEach((node, i) => {\r\n      node.pos.x += node.vel.x * dt;\r\n      node.pos.y += node.vel.y * dt;\r\n      const mesh = this.meshes[i];\r\n      mesh.position.set(node.pos.x, node.pos.y, mesh.position.z);\r\n      mesh.scale.set(node.scale, node.scale, 1);\r\n    });\r\n    last.scale = lerp(last.scale, 1, 0.5);\r\n    (this.line.geometry as Geometry).verticesNeedUpdate = true;\r\n  }\r\n\r\n  goTowardsTargetForce = (() => {\r\n    const offset = new Vector2();\r\n    return (node: Node, target: Vector2, percent: number, pow: number) => {\r\n      offset\r\n        .copy(target)\r\n        .multiplyScalar(percent)\r\n        .sub(node.pos);\r\n      return offset.multiplyScalar(pow);\r\n    };\r\n  })();\r\n\r\n  dragForce = (() => {\r\n    const drag = new Vector2();\r\n    return (node: Node, pow: number) => {\r\n      drag.copy(node.vel).multiplyScalar(pow);\r\n      return drag;\r\n    };\r\n  })();\r\n\r\n  private pullForce = (() => {\r\n    const offset = new Vector2();\r\n    return (node: Node, other: Node, pow: number) => {\r\n      offset.copy(node.pos).sub(other.pos);\r\n      return offset.multiplyScalar(-pow);\r\n    };\r\n  })();\r\n}\r\n\r\nexport default NeuronMesh;\r\n","import Ticker from \"std/ticker\";\r\n\r\nexport type Animation = (t: number, dt: number) => boolean;\r\n\r\nexport class AnimationController {\r\n  public animation?: Animation;\r\n\r\n  timeStarted?: number;\r\n\r\n  timeLastUpdated?: number;\r\n\r\n  set(a: Animation) {\r\n    this.animation = a;\r\n    this.timeLastUpdated = this.timeStarted = Ticker.now / 1000;\r\n  }\r\n\r\n  update() {\r\n    if (this.animation != null && this.timeStarted != null && this.timeLastUpdated != null) {\r\n      const now = Ticker.now / 1000;\r\n      const t = now - this.timeStarted;\r\n      const dt = now - this.timeLastUpdated;\r\n      const ended = this.animation(t, dt);\r\n      this.timeLastUpdated = now;\r\n      if (ended) {\r\n        this.animation = undefined;\r\n        this.timeStarted = undefined;\r\n        this.timeLastUpdated = undefined;\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Sequence animations after each other.\r\n */\r\nexport function chain(...animations: Animation[]): Animation {\r\n  let numEnded = 0;\r\n  let lastStarted = 0;\r\n  return (t, dt) => {\r\n    const currAnimation = animations[numEnded];\r\n    const ended = currAnimation(t - lastStarted, dt);\r\n    if (ended) {\r\n      numEnded++;\r\n      lastStarted = t;\r\n    }\r\n    return numEnded >= animations.length;\r\n  };\r\n}\r\n\r\n/**\r\n * Do both animations at once; end when first one ends.\r\n */\r\nexport function also(firstAnim: Animation, secondAnim: Animation): Animation {\r\n  let secondEnded = false;\r\n  return (t, dt) => {\r\n    const firstEnded = firstAnim(t, dt);\r\n    if (!secondEnded) {\r\n      secondEnded = secondAnim(t, dt);\r\n    }\r\n\r\n    return firstEnded;\r\n  };\r\n}\r\n\r\nexport function animPause(time: number): Animation {\r\n  return (t) => {\r\n    return t > time;\r\n  };\r\n}\r\n","import { sleep } from \"common/promise\";\r\nimport { EventOof } from \"core/tile/tileEvent\";\r\nimport { easeSinInOut } from \"d3-ease\";\r\nimport { Color, DoubleSide, Mesh, MeshBasicMaterial, PlaneBufferGeometry, Scene, Vector2 } from \"three\";\r\nimport { Player } from \"../../core\";\r\nimport { Action, ActionBuild, ActionLong } from \"../../core/player/action\";\r\nimport { Tile } from \"../../core/tile\";\r\nimport { clamp, lerp2, map, randFloat } from \"../../math\";\r\nimport { build, deconstruct, dropSugar, dropWater, footsteps, interactSound, sticky } from \"../audio\";\r\nimport { Mito } from \"../mito/mito\";\r\nimport { textureFromSpritesheet } from \"../spritesheet\";\r\nimport NeuronMesh from \"./neuronMesh\";\r\nimport { Renderer } from \"./Renderer\";\r\nimport { also, Animation, AnimationController, animPause, chain } from \"./tile/Animation\";\r\n\r\nexport class PlayerRenderer extends Renderer<Player> {\r\n  public mesh: Mesh;\r\n\r\n  public neuronMesh = new NeuronMesh(8);\r\n\r\n  protected animation = new AnimationController();\r\n\r\n  constructor(target: Player, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    this.mesh = newMesh();\r\n    this.mesh.name = \"Player Mesh\";\r\n    lerp2(this.mesh.position, this.target.pos, 1);\r\n    this.mesh.position.z = 2;\r\n    this.mesh.add(this.neuronMesh);\r\n\r\n    // wait a bit so the player doesn't pop out behind the seed\r\n    sleep(300).then(() => {\r\n      this.scene.add(this.mesh);\r\n    });\r\n\r\n    this.target.on(\"start-long-action\", this.handleStartLongAction);\r\n    this.target.on(\"action\", this.handleAction);\r\n  }\r\n\r\n  handleStartLongAction = (action: ActionLong) => {\r\n    if (action.effect.type === \"build\") {\r\n      this.animation.set(this.buildReproducerAnimation(action as ActionLong<ActionBuild>));\r\n    }\r\n  };\r\n\r\n  handleAction = (action: Action) => {\r\n    if (action.type === \"pickup\" || action.type === \"drop\") {\r\n      this.neuronMesh.handleInteracted();\r\n      interactSound.fade(1.0, 0.0, 200);\r\n      interactSound.rate(randFloat(0.8, 1.5));\r\n      if (action.type === \"drop\") {\r\n        if (action.sugar > 0) {\r\n          dropSugar.play();\r\n        }\r\n        if (action.water > 0) {\r\n          const id = dropWater.play();\r\n          dropWater.fade(0.2, 0, 400, id);\r\n        }\r\n      }\r\n    } else if (action.type === \"build\") {\r\n      const id = build.play();\r\n      build.rate(randFloat(0.5, 1.0), id);\r\n    } else if (action.type === \"deconstruct\") {\r\n      const id = deconstruct.play();\r\n      deconstruct.rate(randFloat(0.9, 1.1), id);\r\n    } else if (action.type === \"move\") {\r\n      footsteps.fade(0.1, 0, 50);\r\n      footsteps.rate(randFloat(0.8, 1.5));\r\n    }\r\n  };\r\n\r\n  private prevHighlightedTile?: Tile;\r\n\r\n  update() {\r\n    const pos = this.target.droopPosFloat().clone();\r\n\r\n    const oof = this.target.world.getLastStepStats().events.oof[0] as EventOof;\r\n    if (oof) {\r\n      this.mito.addFloatingText(pos, \"oof\");\r\n    }\r\n\r\n    this.mesh.position.set(pos.x, pos.y, 2);\r\n\r\n    const dt = 1 / 60;\r\n    const isInteract = this.mito.controls?.wouldLeftClickInteract() ?? false;\r\n    const highlight = this.mito.getHighlightedTile();\r\n    const neuronMeshTarget = isInteract ? highlight!.pos.clone().sub(pos) : ZERO;\r\n    if (this.prevHighlightedTile !== highlight) {\r\n      const id = sticky.play();\r\n      sticky.rate(randFloat(0.9, 1.1), id);\r\n      sticky.volume(randFloat(0.8, 1), id);\r\n    }\r\n    this.neuronMesh.update(isInteract ? dt * 10 : dt * 5, neuronMeshTarget);\r\n    this.prevHighlightedTile = highlight;\r\n    // this.neuronMesh.visible = this.mito.getHighlightedTile() instanceof Cell;\r\n\r\n    // pos.x += Math.cos(Ticker.now / 1000) * 0.04;\r\n    // pos.y += Math.sin(Ticker.now / 400) * 0.08;\r\n    // lerp2(this.mesh.position, pos, 0.5);\r\n\r\n    this.animation.update();\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.mesh);\r\n  }\r\n\r\n  buildReproducerAnimation(actionLong: ActionLong<ActionBuild>): Animation {\r\n    const animWaitForCameraZoomIn = animPause(0.5);\r\n    let w = 0;\r\n    const animShakeDuration = 1.5;\r\n    const animShake: Animation = (t, dt) => {\r\n      const tNorm = t / animShakeDuration;\r\n      // const pow = clamp(polyBiasUpDown(tNorm), 0, 1);\r\n      const pow = clamp(tNorm, 0, 1);\r\n      const shakeFrequency = 9 * Math.sqrt(pow);\r\n      const shakeAmplitude = 0.15 * pow ** 1.5;\r\n      w += dt * Math.PI * 2 * shakeFrequency;\r\n      this.mesh.position.x += Math.sin(w) * shakeAmplitude;\r\n      return tNorm > 1;\r\n    };\r\n    const animPulse: Animation = (t) => {\r\n      const tNorm = t / 0.25;\r\n      const s = map(clamp(4 * (tNorm - tNorm * tNorm), 0, 1), 0, 1, 1, 1.5);\r\n      this.mesh.scale.set(s, s, 1);\r\n      return t > tNorm;\r\n    };\r\n    const animSendCopy = this.animSendCopy(actionLong.effect.position);\r\n    const animWaitEnd = animPause(0.5);\r\n\r\n    const focusCamera: Animation = () => {\r\n      this.mito.suggestCamera({\r\n        center: this.target.posFloat,\r\n        zoom: 3,\r\n      });\r\n      return false;\r\n    };\r\n\r\n    return also(chain(animWaitForCameraZoomIn, animShake, also(animSendCopy, animPulse), animWaitEnd), focusCamera);\r\n  }\r\n\r\n  animSendCopy(target: Vector2): Animation {\r\n    const copy = newMesh();\r\n    copy.scale.x = this.mesh.scale.x * 1;\r\n    copy.scale.y = this.mesh.scale.y * 1;\r\n    copy.position.z = this.mesh.position.z - 0.01;\r\n    this.scene.add(copy);\r\n    const animDuplicate: Animation = (t) => {\r\n      const tNorm = t / 0.5;\r\n      const dX = easeSinInOut(tNorm) * 0.5;\r\n      this.mesh.position.x -= dX;\r\n      lerp2(copy.position, this.target.droopPosFloat(), 1);\r\n      copy.position.x += dX;\r\n      return tNorm > 1;\r\n    };\r\n    const animStayLeft: Animation = (t) => {\r\n      this.mesh.position.x -= 0.5;\r\n      return false;\r\n    };\r\n    const animReturnOriginal: Animation = (t) => {\r\n      const tNorm = t / 0.5;\r\n      const dX = easeSinInOut(1 - tNorm) * 0.5;\r\n      this.mesh.position.x -= dX;\r\n      return tNorm > 1;\r\n    };\r\n    const animShrinkAndMove: Animation = (t, dt) => {\r\n      const tNorm = t / 1.2;\r\n      // lerp2(copy.position, this.mesh.position, 1);\r\n      lerp2(copy.position, target, 0.1);\r\n      // lerp2(copy.position, target, easeExpOut(tNorm));\r\n      // lerp2(copy.scale, { x: this.mesh.scale.x, y: this.mesh.scale.y }, 1);\r\n      // lerp2(copy.scale, { x: this.mesh.scale.x * 0.2, y: this.mesh.scale.y * 0.2 }, easeSinInOut(tNorm));\r\n      lerp2(copy.scale, { x: this.mesh.scale.x * 0.2, y: this.mesh.scale.y * 0.2 }, 0.1);\r\n      return tNorm > 1;\r\n    };\r\n    const animShrinkToZeroAndRemove: Animation = (t) => {\r\n      const tNorm = t / 0.5;\r\n      lerp2(copy.scale, { x: this.mesh.scale.x * 0.2, y: this.mesh.scale.y * 0.2 }, 1);\r\n      lerp2(copy.scale, { x: 0, y: 0 }, easeSinInOut(tNorm));\r\n\r\n      const ended = tNorm > 1;\r\n      if (ended) {\r\n        this.scene.remove(copy);\r\n      }\r\n      return ended;\r\n    };\r\n    return chain(\r\n      animDuplicate,\r\n      also(animPause(0.5), animStayLeft),\r\n      also(animShrinkAndMove, animReturnOriginal),\r\n      animShrinkToZeroAndRemove\r\n    );\r\n  }\r\n}\r\n\r\nfunction newMesh() {\r\n  const m = new Mesh(\r\n    new PlaneBufferGeometry(0.75, 0.75),\r\n    new MeshBasicMaterial({\r\n      transparent: true,\r\n      // depthWrite: false,\r\n      // depthTest: false,\r\n      map: textureFromSpritesheet(3, 2, \"transparent\"),\r\n      color: new Color(\"white\"),\r\n      side: DoubleSide,\r\n    })\r\n  );\r\n  m.renderOrder = 9;\r\n  return m;\r\n}\r\n\r\nconst ZERO = new Vector2();\r\n","import { easeBounceOut, easeQuadOut } from \"d3-ease\";\r\nimport { polyUpDown } from \"math/easing\";\r\nimport Ticker from \"std/ticker\";\r\nimport { Color, DoubleSide, Mesh, MeshBasicMaterial, PlaneBufferGeometry, Scene } from \"three\";\r\nimport { PlayerSeed } from \"../../core\";\r\nimport { MaterialInfo } from \"../../core/cell/materialInfo\";\r\nimport { lerp, map } from \"../../math\";\r\nimport { fruitPoof, introBounce } from \"../audio\";\r\nimport { Mito } from \"../mito/mito\";\r\nimport { textureFromSpritesheet } from \"../spritesheet\";\r\nimport { Renderer } from \"./Renderer\";\r\nimport { also, Animation, AnimationController, animPause, chain } from \"./tile/Animation\";\r\n\r\nexport class PlayerSeedRenderer extends Renderer<PlayerSeed> {\r\n  public mesh: Mesh;\r\n\r\n  protected animation = new AnimationController();\r\n\r\n  constructor(target: PlayerSeed, scene: Scene, mito: Mito) {\r\n    super(target, scene, mito);\r\n    const reproducerCellType = target.world.genome.cellTypes.find(\r\n      (cellType) => cellType.chromosome.mergeStaticProperties().isReproductive\r\n    )!;\r\n    const material = reproducerCellType.material;\r\n    this.mesh = newMesh(material);\r\n    this.mesh.name = \"Player Seed Mesh\";\r\n    this.mito.scenePlayerSeed.add(this.mesh);\r\n    this.animation.set(chain(this.fallInAnimation(), animPause(2), this.wiggleAnimationForever()));\r\n    // this.animation.set(this.wiggleAnimationForever());\r\n  }\r\n\r\n  update() {\r\n    const pos = this.target.posFloat.clone();\r\n    this.mesh.rotation.set(0, 0, 0);\r\n    this.mesh.position.set(pos.x, pos.y, 11);\r\n    this.animation.update();\r\n  }\r\n\r\n  destroy() {\r\n    this.animation.set(\r\n      chain(this.popOutAnimation(), () => {\r\n        this.scene.remove(this.mesh);\r\n        return true;\r\n      })\r\n    );\r\n    Ticker.addAnimation((t) => {\r\n      this.animation.update();\r\n      if (this.animation.animation == null) {\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n\r\n  public popOutAnimation(): Animation {\r\n    const growBigDuration = 0.5;\r\n    const finalScale = 6.5;\r\n    const growBig: Animation = (t) => {\r\n      const tNorm = t / growBigDuration;\r\n      this.mesh.scale.setScalar(lerp(1, finalScale, easeQuadOut(tNorm)));\r\n      // (this.mesh.material as MeshBasicMaterial).opacity = lerp(1, 0.5, tNorm);\r\n      return tNorm > 1;\r\n    };\r\n    const stayBig: Animation = (t) => {\r\n      this.mesh.scale.setScalar(finalScale);\r\n      return t > 1;\r\n    };\r\n    const fadeOut: Animation = (t) => {\r\n      const tNorm = t / 0.5;\r\n      (this.mesh.material as MeshBasicMaterial).opacity = lerp(1, 0, tNorm);\r\n      return tNorm > 1;\r\n    };\r\n    return chain(\r\n      also(growBig, () => {\r\n        fruitPoof.play();\r\n        return true;\r\n      }),\r\n      stayBig,\r\n      fadeOut\r\n    );\r\n  }\r\n\r\n  public fallInAnimation(): Animation {\r\n    const startY = 12;\r\n    const startPosition: Animation = (t) => {\r\n      this.mesh.position.y -= startY;\r\n      return false;\r\n    };\r\n    const duration = 2;\r\n    const anim: Animation = (t) => {\r\n      const tNorm = t / duration;\r\n      this.mesh.position.y -= lerp(startY, 0, easeBounceOut(tNorm));\r\n      return tNorm > 1;\r\n    };\r\n    return chain(\r\n      also(animPause(1), startPosition),\r\n      also(anim, () => {\r\n        introBounce.play();\r\n        return true;\r\n      })\r\n    );\r\n  }\r\n\r\n  public wiggleAnimationForever(): Animation {\r\n    const wiggleDuration = 1;\r\n    const waitDuration = 2;\r\n    return (t) => {\r\n      const tBounded = t % (wiggleDuration + waitDuration);\r\n      if (tBounded < wiggleDuration) {\r\n        const tNorm = tBounded / wiggleDuration;\r\n        const zRot = Math.sin(map(Math.sin(tNorm * Math.PI * 4), -1, 1, -Math.PI / 6, Math.PI / 6)) * polyUpDown(tNorm);\r\n        // this.mesh.rotation.set(0, 0, zRot);\r\n        this.mesh.position.y -= Math.abs(zRot * 1);\r\n      }\r\n      return false;\r\n    };\r\n  }\r\n}\r\n\r\nfunction newMesh(material: MaterialInfo) {\r\n  const m = new Mesh(\r\n    new PlaneBufferGeometry(1, 1),\r\n    new MeshBasicMaterial({\r\n      transparent: true,\r\n      // depthWrite: false,\r\n      // depthTest: false,\r\n      map: textureFromSpritesheet(material.texturePosition.x, material.texturePosition.y),\r\n      color: material.color ?? new Color(\"white\"),\r\n      side: DoubleSide,\r\n    })\r\n  );\r\n  m.renderOrder = 9;\r\n  return m;\r\n}\r\n","/**\r\n * A Proxy that makes every .get() into a method that, upon invocation,\r\n * calls the corresponding method name in its backing array with the arguments.\r\n * Returns void.\r\n */\r\nexport function arrayProxy<T>(values: T[]) {\r\n  return new Proxy(\r\n    {},\r\n    {\r\n      get: (target, p: keyof T) => {\r\n        const v0 = values[0];\r\n        if (v0 != null && typeof v0[p] === \"function\") {\r\n          return function(...args: any[]) {\r\n            for (const t of values) {\r\n              const method = t[p];\r\n              if (typeof method === \"function\") {\r\n                method.apply(t, args);\r\n              }\r\n            }\r\n          };\r\n        } else {\r\n          return NO_OP;\r\n        }\r\n      },\r\n    }\r\n  ) as T;\r\n}\r\n\r\nconst NO_OP = () => {};\r\n","import { Gene } from \"core/cell/gene\";\r\nimport { GeneInstance } from \"core/cell/geneInstance\";\r\nimport { Renderer } from \"../Renderer\";\r\nimport { InstancedTileRenderer } from \"./InstancedTileRenderer\";\r\n\r\nexport abstract class GeneRenderer<G extends Gene = Gene> extends Renderer<GeneInstance<G>> {\r\n  constructor(t: GeneInstance<G>, public tr: InstancedTileRenderer) {\r\n    super(t, tr.scene, tr.mito);\r\n    this.init();\r\n  }\r\n\r\n  init() {}\r\n\r\n  abstract hover?(): void;\r\n}\r\n","import { easeExpOut } from \"d3-ease\";\r\nimport { GeneDirectionalPush } from \"std/genes/GeneDirectionalPush\";\r\nimport { ArrowHelper, Object3D, Vector2, Vector3 } from \"three\";\r\nimport { Animation } from \"./Animation\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\n\r\nexport class GeneDirectionalPushRenderer extends GeneRenderer<GeneDirectionalPush> {\r\n  private arrow!: Object3D;\r\n\r\n  private origin!: Vector2;\r\n\r\n  private lastDir?: Vector2;\r\n\r\n  update() {\r\n    this.updateArrow();\r\n    this.updateArrowPosition();\r\n\r\n    if (this.target.state.didJustTransport) {\r\n      this.tr.animation.set(this.arrowMoveAnimation());\r\n    }\r\n  }\r\n\r\n  updateArrow() {\r\n    if (this.lastDir !== this.target.cell.args!.direction) {\r\n      if (this.arrow != null) {\r\n        this.arrow.parent!.remove(this.arrow);\r\n      }\r\n      // const length = target.dir.length() - 0.25;\r\n      const length = 0.75;\r\n      const arrowDir = this.target.cell.args!.direction!.clone().normalize();\r\n      this.origin = arrowDir.clone().multiplyScalar(-length / 2);\r\n      this.arrow = new ArrowHelper(\r\n        new Vector3(arrowDir.x, arrowDir.y, 0),\r\n        new Vector3(this.origin.x, this.origin.y, 2),\r\n        length,\r\n        0xffffff,\r\n        0.1,\r\n        0.1\r\n      );\r\n      this.scene.add(this.arrow);\r\n      this.lastDir = this.target.cell.args!.direction!;\r\n    }\r\n  }\r\n\r\n  updateArrowPosition({ x, y }: { x: number; y: number } = this.origin) {\r\n    this.arrow.position.set(this.target.cell.pos.x + x, this.target.cell.pos.y + this.target.cell.droopY + y, 2);\r\n  }\r\n\r\n  arrowMoveAnimation(): Animation {\r\n    const duration = 0.25;\r\n    const len = this.origin.length();\r\n    const start = this.origin.clone().setLength(len * 1.1);\r\n    const target = this.origin.clone().setLength(len * 0.5);\r\n    return (t) => {\r\n      const tNorm = t / duration;\r\n      this.updateArrowPosition(start.clone().lerp(target, easeExpOut(tNorm)));\r\n      return tNorm >= 1;\r\n    };\r\n  }\r\n\r\n  hover() {}\r\n\r\n  destroy() {\r\n    this.scene.remove(this.arrow);\r\n  }\r\n}\r\n","import { BufferGeometry, Float32BufferAttribute, Line, LineBasicMaterial, Vector3 } from \"three\";\r\n\r\nconst lineGeometry = (() => {\r\n  const g = new BufferGeometry();\r\n  g.setAttribute(\"position\", new Float32BufferAttribute([0, 0, 0, 0, 1, 0], 3));\r\n  return g;\r\n})();\r\n\r\nexport default function makeLine(dir: Vector3, origin: Vector3, length: number, color: number) {\r\n  // copied from https://github.com/mrdoob/js/blob/master/src/helpers/ArrowHelper.js\r\n  const line = new Line(lineGeometry, new LineBasicMaterial({ color: color }));\r\n  line.position.copy(origin);\r\n  // dir is assumed to be normalized\r\n  if (dir.y > 0.99999) {\r\n    line.quaternion.set(0, 0, 0, 1);\r\n  } else if (dir.y < -0.99999) {\r\n    line.quaternion.set(1, 0, 0, 0);\r\n  } else {\r\n    const axis = new Vector3(dir.z, 0, -dir.x).normalize();\r\n    const radians = Math.acos(dir.y);\r\n    line.quaternion.setFromAxisAngle(axis, radians);\r\n  }\r\n  line.scale.set(1, Math.max(0, length), 1);\r\n  line.position.z = 0.1;\r\n  line.updateMatrix();\r\n  line.matrixAutoUpdate = false;\r\n  return line;\r\n}\r\n","import { blopBuffer, distScalar } from \"game/audio\";\r\nimport { GenePhotosynthesis } from \"std/genes/GenePhotosynthesis\";\r\nimport { Audio, Object3D, Vector2, Vector3 } from \"three\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport makeLine from \"./makeLine\";\r\nexport class GenePhotosynthesisRenderer extends GeneRenderer<GenePhotosynthesis> {\r\n  private audio = (() => {\r\n    const audio = new Audio(this.mito.audioListener);\r\n    blopBuffer.then((buffer) => audio.setBuffer(buffer));\r\n    return audio;\r\n  })();\r\n\r\n  private lastAudioValueTracker = 0;\r\n\r\n  private neighborLines = new Object3D();\r\n\r\n  update() {\r\n    // audio\r\n    const newAudioValueTracker = this.target.state.totalSugarProduced;\r\n    if (newAudioValueTracker > this.lastAudioValueTracker) {\r\n      const baseVolume = this.target.state.sugarConverted * this.target.state.sugarConverted;\r\n      const volume = distScalar(this.target.cell, this.mito.world.player) * baseVolume;\r\n      this.audio.setVolume(volume);\r\n      // this.audio.setRefDistance(2);\r\n      // play blop sound\r\n      this.audio.play();\r\n      this.tr.animation.set(this.tr.growPulseAnimation());\r\n    }\r\n    this.lastAudioValueTracker = newAudioValueTracker;\r\n    if (this.neighborLines.parent != null) {\r\n      this.scene.remove(this.neighborLines);\r\n    }\r\n  }\r\n\r\n  hover() {\r\n    this.scene.add(this.neighborLines);\r\n    this.neighborLines.position.set(this.tr.target.pos.x, this.tr.target.pos.y, 1);\r\n    const lines: Vector2[] = this.target.state.activeNeighbors;\r\n    if (lines.length !== this.neighborLines.children.length) {\r\n      // redo neighbor lines\r\n      this.neighborLines.remove(...this.neighborLines.children);\r\n      lines.forEach((dir) => {\r\n        const length = dir.length() - 0.25;\r\n        const arrowDir = new Vector3(dir.x, dir.y, 0).normalize();\r\n        const line = makeLine(arrowDir, new Vector3(), length, color);\r\n        this.neighborLines.add(line);\r\n      });\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.neighborLines);\r\n    if (this.audio != null) {\r\n      this.audio.disconnect();\r\n    }\r\n  }\r\n}\r\n\r\nconst color = 0xffc90e;\r\n","import { nf } from \"common/formatters\";\r\nimport { Gene } from \"core/cell/gene\";\r\nimport { map } from \"math\";\r\nimport React from \"react\";\r\nimport { reproducerGetPercentMatured, ReproducerState } from \"std/genes/GeneReproducer\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport \"./GeneReproducerRenderer.scss\";\r\n\r\nexport class GeneReproducerRenderer extends GeneRenderer<Gene<ReproducerState, any>> {\r\n  percentMatureElement = this.tr.worldRenderer.renderResources\r\n    ? this.mito.addWorldDOMElement(\r\n        () => this.target.cell,\r\n        () => {\r\n          const matured = reproducerGetPercentMatured(this.target);\r\n          return <div className=\"reproducer-percent-mature\">{nf(matured * 100, 2)}%</div>;\r\n        }\r\n      )\r\n    : null;\r\n\r\n  hover() {}\r\n\r\n  update() {\r\n    this.updateScale();\r\n  }\r\n\r\n  updateScale() {\r\n    const scale = map(reproducerGetPercentMatured(this.target), 0, 1, 0.2, 1);\r\n    this.tr.scale.set(scale, scale, 1);\r\n  }\r\n\r\n  //   super.update();\r\n  // if (this.target.age - this.lastEmitAge > 0.5) {\r\n  //   const angle = Math.random() * Math.PI * 2;\r\n  //   const speed = 0.1;\r\n  //   const dx = Math.cos(angle) * speed;\r\n  //   const dy = Math.sin(angle) * speed;\r\n  //   fruitSparkle.fire({\r\n  //     x: this.target.pos.x,\r\n  //     y: this.target.pos.y,\r\n  //     z: 1,\r\n  //     alpha: 1,\r\n  //     info: { dx, dy },\r\n  //     size: 1,\r\n  //     time: 0,\r\n  //     // r: angle,\r\n  //   });\r\n  //   this.lastEmitAge = this.target.age;\r\n  // }\r\n  // }\r\n\r\n  destroy() {\r\n    if (this.percentMatureElement) {\r\n      this.mito.removeWorldDOMElement(this.percentMatureElement);\r\n    }\r\n  }\r\n}\r\n","import { distScalar, suckWaterBuffer } from \"game/audio\";\r\nimport { GeneSoilAbsorption } from \"std/genes\";\r\nimport { Audio, Color, Object3D, Vector2, Vector3 } from \"three\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport makeLine from \"./makeLine\";\r\nexport class GeneSoilAbsorptionRenderer extends GeneRenderer<GeneSoilAbsorption> {\r\n  private audio = (() => {\r\n    const audio = new Audio(this.mito.audioListener);\r\n    suckWaterBuffer.then((buffer) => audio.setBuffer(buffer));\r\n    return audio;\r\n  })();\r\n\r\n  private lastAudioValueTracker = 0;\r\n\r\n  private neighborLines = new Object3D();\r\n\r\n  update() {\r\n    const newAudioValueTracker = this.target.state.totalSucked;\r\n    if (newAudioValueTracker !== this.lastAudioValueTracker) {\r\n      // const baseVolume = this.target.waterTransferAmount / (2 + this.target.waterTransferAmount);\r\n      const baseVolume = 1;\r\n      const volume = distScalar(this.target.cell, this.mito.world.player) * baseVolume;\r\n      this.audio.setVolume(volume);\r\n      if (this.audio.source != null) {\r\n        this.audio.stop();\r\n      }\r\n      this.audio.play();\r\n      this.tr.animation.set(this.tr.growPulseAnimation());\r\n    }\r\n    this.lastAudioValueTracker = newAudioValueTracker;\r\n    if (this.neighborLines.parent != null) {\r\n      this.scene.remove(this.neighborLines);\r\n    }\r\n  }\r\n\r\n  hover() {\r\n    this.scene.add(this.neighborLines);\r\n    this.neighborLines.position.set(this.tr.target.pos.x, this.tr.target.pos.y, 1);\r\n    const lines: Vector2[] = this.target.state.activeNeighbors;\r\n    if (lines.length !== this.neighborLines.children.length) {\r\n      // redo neighbor lines\r\n      this.neighborLines.remove(...this.neighborLines.children);\r\n      lines.forEach((dir) => {\r\n        const length = dir.length() - 0.25;\r\n        const arrowDir = new Vector3(dir.x, dir.y, 0).normalize();\r\n        const line = makeLine(arrowDir, new Vector3(), length, color);\r\n        this.neighborLines.add(line);\r\n      });\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this.scene.remove(this.neighborLines);\r\n    this.audio.disconnect();\r\n  }\r\n}\r\nconst color = new Color(\"rgb(9, 12, 255)\").getHex();\r\n","import { arrayProxy } from \"common/arrayProxy\";\r\nimport { GeneInstance } from \"core/cell/geneInstance\";\r\nimport { Temperature } from \"core/temperature\";\r\nimport { Air, Cell, DeadCell, Fountain, GrowingCell, Rock, Tile } from \"core/tile\";\r\nimport { Clay, Sand, Silt } from \"core/tile/soil\";\r\nimport { easeCubic } from \"d3-ease\";\r\nimport Mito from \"game/mito/mito\";\r\nimport { clamp, lerp, lerp2, map } from \"math\";\r\nimport { reversed } from \"math/easing\";\r\nimport { GeneSoilAbsorption } from \"std/genes\";\r\nimport { GeneDirectionalPush } from \"std/genes/GeneDirectionalPush\";\r\nimport { GenePhotosynthesis } from \"std/genes/GenePhotosynthesis\";\r\nimport { GeneFruit, GeneSeed } from \"std/genes/GeneReproducer\";\r\nimport { Color, Scene, Vector2, Vector3 } from \"three\";\r\nimport { Constructor } from \"typings/constructor\";\r\nimport { MaterialInfo } from \"../../../core/cell/materialInfo\";\r\nimport { InventoryRenderer } from \"../InventoryRenderer\";\r\nimport { Renderer } from \"../Renderer\";\r\nimport { WorldRenderer } from \"../WorldRenderer\";\r\nimport { Animation, AnimationController } from \"./Animation\";\r\nimport { CellEffectsRenderer } from \"./CellEffectsRenderer\";\r\nimport { GeneDirectionalPushRenderer } from \"./GeneDirectionalPushRenderer\";\r\nimport { GenePhotosynthesisRenderer } from \"./GenePhotosynthesisRenderer\";\r\nimport { GeneRenderer } from \"./GeneRenderer\";\r\nimport { GeneReproducerRenderer } from \"./GeneReproducerRenderer\";\r\nimport { GeneSoilAbsorptionRenderer } from \"./GeneSoilAbsorptionRenderer\";\r\nimport TileBatcher, { BatchInstance } from \"./tileBatcher\";\r\n\r\nexport class InstancedTileRenderer<T extends Tile = Tile> extends Renderer<T> {\r\n  public static readonly TEMPERATURE_COLORS = {\r\n    [Temperature.Scorching]: new Color(\"orange\"),\r\n    [Temperature.Hot]: new Color(\"orange\").lerp(new Color(\"white\"), 0.5),\r\n    [Temperature.Mild]: new Color(\"white\"),\r\n    [Temperature.Cold]: new Color(\"lightblue\").lerp(new Color(\"white\"), 0.5),\r\n    [Temperature.Freezing]: new Color(\"lightblue\"),\r\n  } as Record<Temperature, Color>;\r\n\r\n  private static readonly ONE = Object.freeze(new Vector2(1, 1));\r\n\r\n  public inventoryRenderer: InventoryRenderer;\r\n\r\n  private originalColor: Color;\r\n\r\n  private cellEffectsRenderer?: CellEffectsRenderer;\r\n\r\n  private geneRenderer?: GeneRenderer;\r\n\r\n  animation = new AnimationController();\r\n\r\n  scale = new Vector3(1, 1, 1);\r\n\r\n  private color = new Color();\r\n\r\n  private instance: BatchInstance;\r\n\r\n  worldRenderer: WorldRenderer;\r\n\r\n  get materialInfo() {\r\n    return getMaterialInfo(this.target);\r\n  }\r\n\r\n  constructor(target: T, scene: Scene, mito: Mito, batchMesh: TileBatcher, worldRenderer: WorldRenderer) {\r\n    super(target, scene, mito);\r\n    this.worldRenderer = worldRenderer;\r\n    this.instance = batchMesh.getBatchInstance(target);\r\n    if (this.target instanceof GrowingCell) {\r\n      this.scale.set(0.01, 0.01, 1);\r\n    }\r\n\r\n    this.originalColor = (this.materialInfo.color || WHITE).clone();\r\n    this.inventoryRenderer = new InventoryRenderer(this.target.inventory, this.scene, this.mito);\r\n    this.inventoryRenderer.animationOffset = (this.target.pos.x + this.target.pos.y) / 2;\r\n    if (this.target instanceof Cell) {\r\n      // if it takes no time to build, start it off small just for show\r\n      if (this.target.timeToBuild === 0) {\r\n        this.scale.set(0.01, 0.01, 1);\r\n      }\r\n      this.cellEffectsRenderer = new CellEffectsRenderer(this.target, this.scene, this.mito);\r\n      this.geneRenderer = arrayProxy(\r\n        this.target.geneInstances.map((g) => this.createGeneRendererFor(g)!).filter((g) => g != null)\r\n      );\r\n    }\r\n\r\n    if (this.target.darkness < 1) {\r\n      this.commit();\r\n    }\r\n  }\r\n\r\n  private createGeneRendererFor(inst: GeneInstance<any>): GeneRenderer<any> | undefined {\r\n    if (inst.isType(GeneSoilAbsorption)) {\r\n      return new GeneSoilAbsorptionRenderer(inst, this);\r\n    } else if (inst.isType(GenePhotosynthesis)) {\r\n      return new GenePhotosynthesisRenderer(inst, this);\r\n    } else if (inst.isType(GeneDirectionalPush)) {\r\n      return new GeneDirectionalPushRenderer(inst, this);\r\n    } else if (inst.isType(GeneFruit) || inst.isType(GeneSeed)) {\r\n      return new GeneReproducerRenderer(inst, this);\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  commit() {\r\n    if (this.target instanceof GrowingCell) {\r\n      const { start, pos } = this.target;\r\n      const p = start.clone().lerp(pos, 0.5);\r\n      const t1Pos = pos;\r\n      const t = this.scale.x;\r\n      lerp2(p, t1Pos, t);\r\n      this.instance.commitCenter(p.x, p.y, 1);\r\n    } else if (this.target instanceof Cell) {\r\n      this.instance.commitCenter(this.target.pos.x, this.target.pos.y + this.target.droopY, 1);\r\n    } else {\r\n      const z = this.target instanceof Air ? -10 : 0;\r\n      this.instance.commitCenter(this.target.pos.x, this.target.pos.y, z);\r\n    }\r\n    this.instance.commitTexturePosition(this.materialInfo.texturePosition);\r\n    this.instance.commitColor(this.color);\r\n    // const dist = this.target.pos.distanceTo(this.mito.world.player.pos);\r\n    // const timeAlive = this.target.age;\r\n    // const alpha = clamp(easeCubicIn(timeAlive * 3 - dist), 0, 1);\r\n    // this.instance.commitAlpha(alpha);\r\n    this.instance.commitScale(this.scale);\r\n  }\r\n\r\n  update() {\r\n    if (this.target.darkness < 1) {\r\n      this.updateScale();\r\n      this.updateColor();\r\n\r\n      this.updateInventory();\r\n      this.maybeUpdateCellEffectsRenderer();\r\n\r\n      if (this.geneRenderer) {\r\n        this.geneRenderer.update();\r\n      }\r\n\r\n      this.animation.update();\r\n      this.commit();\r\n    }\r\n  }\r\n\r\n  maybeUpdateCellEffectsRenderer() {\r\n    if (this.cellEffectsRenderer != null) {\r\n      this.cellEffectsRenderer.update();\r\n    }\r\n  }\r\n\r\n  updateInventory() {\r\n    if (this.inventoryRenderer != null) {\r\n      // will not render without an update\r\n      this.inventoryRenderer.update();\r\n    }\r\n  }\r\n\r\n  updateScale() {\r\n    if (this.target instanceof GrowingCell) {\r\n      const s = this.target.percentMatured;\r\n      lerp2(this.scale, { x: s, y: s }, 0.5);\r\n    } else if (this.target instanceof Cell && this.target.isReproductive) {\r\n      // Do nothing; GeneRenderer sets scale for you\r\n    } else {\r\n      lerp2(this.scale, InstancedTileRenderer.ONE, 0.1);\r\n    }\r\n  }\r\n\r\n  updateColor() {\r\n    const lightAmount = this.target.lightAmount();\r\n    if (this.target instanceof Air) {\r\n      const colorIndex = Math.max(0, map(this.target.co2(), 1 / 6, 1.001, 0, AIR_COLORSCALE.length - 1));\r\n      const startColorIndex = Math.floor(colorIndex);\r\n      const startColor = AIR_COLORSCALE[startColorIndex];\r\n      this.originalColor = startColor.clone();\r\n      if (startColorIndex !== AIR_COLORSCALE.length - 1) {\r\n        const alpha = colorIndex - startColorIndex;\r\n        const endColorIndex = startColorIndex + 1;\r\n        const endColor = AIR_COLORSCALE[endColorIndex];\r\n        this.originalColor.lerp(endColor, alpha);\r\n      }\r\n    }\r\n    this.color.copy(this.originalColor);\r\n    if (this.target instanceof Cell) {\r\n      this.color.lerp(new Color(0), 1 - this.target.energy);\r\n    }\r\n\r\n    this.color = this.lerpColorTemperature(this.color);\r\n    this.color = new Color(0).lerp(this.color, map(lightAmount, 0, 1, 0.2, 1));\r\n  }\r\n\r\n  private temperatureColor: Color = InstancedTileRenderer.TEMPERATURE_COLORS[Temperature.Mild];\r\n\r\n  private currentLerp = 0;\r\n\r\n  lerpColorTemperature(color: Color) {\r\n    const { temperature } = this.target;\r\n    let tColor = InstancedTileRenderer.TEMPERATURE_COLORS[temperature];\r\n    if (tColor !== this.temperatureColor) {\r\n      this.currentLerp = 0;\r\n    }\r\n    const targetLerp = temperature === Temperature.Mild ? 0 : 0.25;\r\n    this.temperatureColor = tColor;\r\n    this.currentLerp = lerp(this.currentLerp, targetLerp, 0.1);\r\n    color.lerp(this.temperatureColor, this.currentLerp);\r\n    return color;\r\n  }\r\n\r\n  updateHover() {\r\n    this.geneRenderer && this.geneRenderer.hover!();\r\n  }\r\n\r\n  growPulseAnimation(): Animation {\r\n    const duration = 0.5;\r\n    const ease = reversed(easeCubic);\r\n    return (t) => {\r\n      const tNorm = clamp((t / duration) * ((this.target as any).tempo || 1), 0, 1);\r\n      const scale = map(ease(tNorm), 0, 1, 1, 1.3);\r\n      this.scale.setScalar(scale);\r\n      return tNorm >= 1;\r\n    };\r\n  }\r\n\r\n  hasActiveNeighbors(\r\n    t: any\r\n  ): t is {\r\n    activeNeighbors: Vector2[];\r\n  } {\r\n    return Array.isArray(t.activeNeighbors);\r\n  }\r\n\r\n  destroy() {\r\n    this.instance.destroy();\r\n    // this.scene.remove(this.mesh);\r\n    if (this.inventoryRenderer != null) {\r\n      this.inventoryRenderer.destroy();\r\n    }\r\n    if (this.cellEffectsRenderer != null) {\r\n      this.cellEffectsRenderer.destroy();\r\n    }\r\n    this.geneRenderer && this.geneRenderer.destroy();\r\n  }\r\n}\r\n\r\nconst materialInfoMapping = (() => {\r\n  const materials = new Map<Constructor<Tile>, MaterialInfo>();\r\n  materials.set(Air, {\r\n    texturePosition: new Vector2(0, 3),\r\n    color: new Color(\"white\"),\r\n  });\r\n  const siltColor = new Color(\"rgb(112, 89, 44)\");\r\n  materials.set(Sand, {\r\n    texturePosition: new Vector2(1, 0),\r\n    color: new Color(\"rgb(223, 220, 231)\").multiplyScalar(1 / 1.2),\r\n  });\r\n  materials.set(Silt, {\r\n    texturePosition: new Vector2(1, 0),\r\n    color: siltColor,\r\n  });\r\n  materials.set(Clay, {\r\n    texturePosition: new Vector2(1, 0),\r\n    color: siltColor.clone().multiplyScalar(1 / 1.5),\r\n  });\r\n  materials.set(Fountain, {\r\n    color: new Color(\"white\"),\r\n    texturePosition: new Vector2(2, 0),\r\n  });\r\n  materials.set(Rock, {\r\n    texturePosition: new Vector2(3, 0),\r\n    color: new Color(\"rgb(63, 77, 84)\"),\r\n  });\r\n  materials.set(DeadCell, {\r\n    texturePosition: new Vector2(0, 1),\r\n    color: new Color(\"rgb(128, 128, 128)\"),\r\n  });\r\n  return materials;\r\n})();\r\n\r\nexport function getMaterialInfo(tile: Tile): MaterialInfo {\r\n  if (tile instanceof GrowingCell) {\r\n    return getMaterialInfo(tile.completedCell);\r\n  } else if (tile instanceof Cell) {\r\n    return tile.type.material;\r\n  } else {\r\n    return materialInfoMapping.get(tile.constructor as Constructor<Tile>)!;\r\n  }\r\n}\r\n\r\nconst AIR_COLORSCALE = [\r\n  new Color(\"hsl(67, 31%, 25%)\"),\r\n  new Color(\"hsl(180, 31%, 76%)\"),\r\n  new Color(\"hsl(213, 63%, 58%)\"),\r\n];\r\n\r\nconst WHITE = new Color(1, 1, 1);\r\n","import { World } from \"core\";\r\nimport { Cell, Tile } from \"core/tile\";\r\nimport { SPRITESHEET } from \"game/spritesheet\";\r\nimport {\r\n  Color,\r\n  DoubleSide,\r\n  DynamicDrawUsage,\r\n  InstancedBufferAttribute,\r\n  InstancedBufferGeometry,\r\n  Mesh,\r\n  PlaneBufferGeometry,\r\n  RawShaderMaterial,\r\n  Vector2,\r\n  Vector3,\r\n} from \"three\";\r\nimport glsl from \"../glsl\";\r\n\r\nconst vertexShader = glsl`\r\nprecision mediump float;\r\n\r\n// the vertex shader's main goals are:\r\n// 1. set gl_Position to a clip-coordinate\r\n// 2. pass varyings along to fragment shader.\r\n// you can accept two types of inputs:\r\n//   'attribute' variables, which change per vertex\r\n//   'uniform' variables, which are constant for a given draw context.\r\n// WebGL thankfully hooks up a bunch of attributes and uniforms, see https://threejs.org/docs/index.html#api/en/renderers/webgl/WebGLProgram\r\n// see also my explorations: https://codesandbox.io/s/reactthreejstemplate-lwvhu\r\n\r\n\r\n// Comes from WebGLProgram\r\nuniform mat4 modelViewMatrix;\r\nuniform mat4 projectionMatrix;\r\n\r\n// Comes from threejs Geometry\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\nattribute vec2 uv;\r\n\r\n// attributes we provide\r\n// these are constant per instance\r\nattribute vec3 instancedTileCenter;\r\nattribute vec3 instancedTileScale;\r\nattribute vec3 instancedTileColor;\r\nattribute vec2 instancedTexturePosition;\r\nattribute float instancedAlpha;\r\n\r\n// things we pass onto fragment\r\nvarying vec3 vTileCenter;\r\nvarying vec3 vColor;\r\nvarying vec2 vUv;\r\nvarying vec2 vTexturePosition;\r\nvarying float vAlpha;\r\n\r\n// based on https://github.com/mrdoob/three.js/blob/master/examples/webgl_buffergeometry_instancing_billboards.html\r\nvoid main() {\r\n  vTileCenter = instancedTileCenter;\r\n  vColor = instancedTileColor;\r\n  vUv = uv;\r\n  vTexturePosition = instancedTexturePosition;\r\n  vAlpha = instancedAlpha;\r\n\r\n  vec4 mvPosition = modelViewMatrix * vec4(instancedTileCenter, 1.);\r\n  mvPosition.xyz += position * instancedTileScale;\r\n  // mvPosition.xyz += position;\r\n  gl_Position = projectionMatrix * mvPosition;\r\n}\r\n`;\r\n\r\nconst fragmentShader = glsl`\r\n// for the fragment shader, the main goal is to set gl_FragColor. Its inputs are\r\n//   'varying' variables from the vertex shader, interpolated along the triangle\r\n//   'uniform' variables\r\nprecision mediump float;\r\n\r\n// these should match the corresponding section in the vertexShader exactly\r\nvarying vec3 vTileCenter;\r\nvarying vec3 vColor;\r\nvarying vec2 vUv;\r\nvarying vec2 vTexturePosition;\r\nvarying float vAlpha;\r\n\r\nconst vec2 spritesheetSize = vec2(256., 256.);\r\nuniform sampler2D spriteSheet;\r\n\r\nfloat myRound(float x) {\r\n  return sign(x) * floor(abs(x) + 0.5);\r\n}\r\n\r\nfloat random(float x) {\r\n  return fract(sin(x * .43));\r\n}\r\n\r\n// uv - [0,1]x[0,1] - our local sprite (16x16) UV coords\r\n// texturePosition - the grid x/y where our sprite lives in our texture. NOTE:\r\n// for texturePosition, top-left is 0, 0 (Y is image coordinates)\r\n// textureSize - the pixel width/height of the full spritesheet\r\n// returns: a UV coordinate for this sprite, relative to the full spritesheet\r\nvec2 getCorrectUv(vec2 uv, vec2 texturePosition, vec2 textureSize) {\r\n  vec2 spriteSheetPxStart = texturePosition * vec2(32.);\r\n  spriteSheetPxStart.y = textureSize.y - spriteSheetPxStart.y - 32.;\r\n  vec2 spriteSheetUv = spriteSheetPxStart + uv * vec2(32.);\r\n  vec2 minUv = spriteSheetPxStart + vec2(1.);\r\n  vec2 maxUv = spriteSheetPxStart + vec2(32. - 1.);\r\n  return clamp(spriteSheetUv / textureSize, minUv / textureSize, maxUv / textureSize);\r\n}\r\n\r\nvoid main() {\r\n  vec2 correctUv = getCorrectUv(vUv, vTexturePosition, spritesheetSize);\r\n  vec4 textureColor = texture2D(spriteSheet, correctUv);\r\n  gl_FragColor = vec4(textureColor.rgb * vColor, textureColor.a * vAlpha);\r\n}\r\n`;\r\n\r\nconst TileShaderMaterial = new RawShaderMaterial({\r\n  uniforms: {\r\n    spriteSheet: { value: SPRITESHEET() },\r\n  },\r\n  transparent: true,\r\n  vertexShader,\r\n  fragmentShader,\r\n  side: DoubleSide,\r\n});\r\n\r\nclass TileBatcher {\r\n  private static newGeometry() {\r\n    const referenceGeometry = new PlaneBufferGeometry(1, 1);\r\n    const geometry = new InstancedBufferGeometry();\r\n    // this copies:\r\n    // [0, 2, 1, 2, 3, 1]\r\n    // index has a specific and somewhat cryptic data storage format\r\n    // it's a flattened array of size three elements\r\n    // each three adjacent numbers gets interpreted as one triangle\r\n    // each individual number's value is an *index* into a \"virtual\r\n    // vertex array\" that's defined the attributes array.\r\n    geometry.index = referenceGeometry.index;\r\n    // this copies:\r\n    // position: BufferAttribute, 4 items, size 3\r\n    // normal: BufferAttribute, 4 items, size 3\r\n    // uv: BufferAttribute, 4 items, size 2\r\n    geometry.attributes = referenceGeometry.attributes;\r\n    return geometry;\r\n  }\r\n\r\n  geometry!: InstancedBufferGeometry;\r\n\r\n  public maxTiles = this.world.height * this.world.width * 2;\r\n\r\n  centers = new InstancedBufferAttribute(new Float32Array(3 * this.maxTiles), 3, false, 1);\r\n\r\n  colors = new InstancedBufferAttribute(new Float32Array(3 * this.maxTiles), 3, false, 1);\r\n\r\n  scales = new InstancedBufferAttribute(new Float32Array(3 * this.maxTiles), 3, false, 1);\r\n\r\n  texturePositions = new InstancedBufferAttribute(new Float32Array(2 * this.maxTiles), 2, false, 1);\r\n\r\n  alphas = new InstancedBufferAttribute(new Float32Array(this.maxTiles).fill(1), 1, false, 1);\r\n\r\n  public readonly mesh: Mesh;\r\n\r\n  constructor(public world: World) {\r\n    this.geometry = TileBatcher.newGeometry();\r\n    this.mesh = new Mesh(this.geometry, TileShaderMaterial);\r\n    this.mesh.name = \"TileBatcher Mesh\";\r\n    this.mesh.frustumCulled = false;\r\n    this.mesh.matrixAutoUpdate = false;\r\n    this.mesh.updateMatrixWorld();\r\n    this.centers.setUsage(DynamicDrawUsage);\r\n    this.colors.setUsage(DynamicDrawUsage);\r\n    this.scales.setUsage(DynamicDrawUsage);\r\n    this.texturePositions.setUsage(DynamicDrawUsage);\r\n    this.alphas.setUsage(DynamicDrawUsage);\r\n    this.geometry.setAttribute(\"instancedTileCenter\", this.centers);\r\n    this.geometry.setAttribute(\"instancedTileColor\", this.colors);\r\n    this.geometry.setAttribute(\"instancedTileScale\", this.scales);\r\n    this.geometry.setAttribute(\"instancedTexturePosition\", this.texturePositions);\r\n    this.geometry.setAttribute(\"instancedAlpha\", this.alphas);\r\n  }\r\n\r\n  private instances = new Map<string, BatchInstance>();\r\n\r\n  // getInstance(layer: number, pos: Vector2) {\r\n  getBatchInstance(tile: Tile) {\r\n    const pos = tile.pos;\r\n    const layer = tile instanceof Cell ? 1 : 0;\r\n    const layerOffset = (layer * this.maxTiles) / 2;\r\n    const positionOffset = pos.y * this.world.width + pos.x;\r\n    const index = layerOffset + positionOffset;\r\n    if (!Number.isInteger(index)) {\r\n      console.error(\"index \" + index + \" is not integer!\");\r\n    }\r\n    const key = String(index);\r\n    if (!this.instances.has(key)) {\r\n      this.instances.set(key, new BatchInstance(this, index));\r\n    }\r\n    const instance = this.instances.get(key)!;\r\n    instance.checkout(tile);\r\n    return instance;\r\n  }\r\n\r\n  endFrame() {\r\n    this.centers.needsUpdate = true;\r\n    this.colors.needsUpdate = true;\r\n    this.scales.needsUpdate = true;\r\n    this.texturePositions.needsUpdate = true;\r\n    this.alphas.needsUpdate = true;\r\n  }\r\n}\r\n\r\nconst BLACK = new Color(0, 0, 0);\r\nconst ZERO = new Vector3(0, 0, 0);\r\nexport class BatchInstance {\r\n  public readonly batcher: TileBatcher;\r\n\r\n  public readonly index: number;\r\n\r\n  private static numInUse = 0;\r\n\r\n  private owner?: object;\r\n\r\n  constructor(batcher: TileBatcher, index: number) {\r\n    this.batcher = batcher;\r\n    this.index = index;\r\n  }\r\n\r\n  checkout(owner: object) {\r\n    if (this.owner != null) {\r\n      // throw new Error(\"Checking out instance that's already in use!\" + this.index);\r\n      console.warn(\"Checking out instance that's already in use!\", this.index, owner);\r\n    }\r\n    this.owner = owner;\r\n    BatchInstance.numInUse++;\r\n  }\r\n\r\n  commitColor(color: Color) {\r\n    if (!this.owner) {\r\n      console.error(\"freed tileBatcher still in use!\");\r\n    }\r\n    this.batcher.colors.setXYZ(this.index, color.r, color.g, color.b);\r\n  }\r\n\r\n  commitCenter(x: number, y: number, z: number) {\r\n    if (!this.owner) {\r\n      console.error(\"freed tileBatcher still in use!\");\r\n    }\r\n    this.batcher.centers.setXYZ(this.index, x, y, z);\r\n  }\r\n\r\n  commitScale(scale: Vector3) {\r\n    if (!this.owner) {\r\n      console.error(\"freed tileBatcher still in use!\");\r\n    }\r\n    this.batcher.scales.setXYZ(this.index, scale.x, scale.y, scale.z);\r\n  }\r\n\r\n  commitTexturePosition(pos: Vector2) {\r\n    this.batcher.texturePositions.setXY(this.index, pos.x, pos.y);\r\n  }\r\n\r\n  commitAlpha(alpha: number) {\r\n    this.batcher.alphas.setX(this.index, alpha);\r\n  }\r\n\r\n  destroy() {\r\n    this.commitColor(BLACK);\r\n    this.commitScale(ZERO);\r\n    this.owner = undefined;\r\n    BatchInstance.numInUse--;\r\n  }\r\n}\r\n\r\nexport default TileBatcher;\r\n","import { createSelector } from \"reselect\";\r\nimport { Scene } from \"three\";\r\nimport { Entity, Player, PlayerSeed, StepStats, World } from \"../../core\";\r\nimport { Tile } from \"../../core/tile\";\r\nimport Mito from \"../mito/mito\";\r\nimport { EventLogRenderer } from \"./events/eventLogRenderer\";\r\nimport { InventoryRenderer } from \"./InventoryRenderer\";\r\nimport { PlayerRenderer } from \"./PlayerRenderer\";\r\nimport { PlayerSeedRenderer } from \"./PlayerSeedRenderer\";\r\nimport { Renderer } from \"./Renderer\";\r\nimport { InstancedTileRenderer } from \"./tile/InstancedTileRenderer\";\r\nimport TileBatcher from \"./tile/tileBatcher\";\r\n\r\nexport class WorldRenderer extends Renderer<World> {\r\n  public renderers = new Map<Entity, Renderer<Entity>>();\r\n\r\n  public readonly tileBatcher: TileBatcher;\r\n\r\n  // private lightEmitter: LightEmitter;\r\n  public eventLogRenderer?: EventLogRenderer;\r\n\r\n  constructor(target: World, scene: Scene, mito: Mito, public renderResources = true) {\r\n    super(target, scene, mito);\r\n\r\n    // must be added before all particles\r\n    this.tileBatcher = new TileBatcher(this.target);\r\n    scene.add(this.tileBatcher.mesh);\r\n\r\n    if (renderResources) {\r\n      scene.add(InventoryRenderer.WaterParticles());\r\n      scene.add(InventoryRenderer.SugarParticles());\r\n      this.eventLogRenderer = new EventLogRenderer(this);\r\n    }\r\n    // this.lightEmitter = new LightEmitter(this);\r\n  }\r\n\r\n  public getOrCreateRenderer(entity: Entity) {\r\n    const renderer = this.renderers.get(entity);\r\n    if (renderer == null) {\r\n      const created = this.createRendererFor(entity);\r\n      if (created) {\r\n        this.renderers.set(entity, created);\r\n        return created;\r\n      }\r\n    } else {\r\n      return renderer;\r\n    }\r\n  }\r\n\r\n  public createRendererFor<E extends Entity>(object: E): Renderer<Entity> | null {\r\n    if (object instanceof Player) {\r\n      return new PlayerRenderer(object, this.scene, this.mito);\r\n    } else if (object instanceof PlayerSeed) {\r\n      return new PlayerSeedRenderer(object, this.scene, this.mito);\r\n    } else if (object instanceof Tile) {\r\n      return new InstancedTileRenderer(object, this.scene, this.mito, this.tileBatcher, this);\r\n    } else {\r\n      console.error(`Couldn't find renderer for`, object);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private deleteDeadEntityRenderers = createSelector(\r\n    (stats: StepStats) => stats,\r\n    (stats) => {\r\n      const deletedEntities = stats.deleted;\r\n\r\n      for (const e of deletedEntities) {\r\n        const renderer = this.renderers.get(e);\r\n        if (renderer == null) {\r\n          console.warn(`Couldn't find renderer for ${e}!`);\r\n          continue;\r\n        }\r\n        renderer.destroy();\r\n        this.renderers.delete(e);\r\n      }\r\n    }\r\n  );\r\n\r\n  update(): void {\r\n    this.deleteDeadEntityRenderers(this.target.getLastStepStats());\r\n    // this.lightEmitter.update(1 / 30);\r\n\r\n    // careful - event log renderers rely on state from other renderers (e.g. position\r\n    // of water particle as it's evaporating) that requires it to update before others\r\n    if (this.eventLogRenderer) {\r\n      this.eventLogRenderer.update();\r\n    }\r\n\r\n    InventoryRenderer.startFrame();\r\n    this.target.entities().forEach((entity) => {\r\n      const renderer = this.getOrCreateRenderer(entity);\r\n      renderer?.update();\r\n    });\r\n    InventoryRenderer.endFrame();\r\n    this.tileBatcher.endFrame();\r\n  }\r\n\r\n  destroy(): void {\r\n    throw new Error(\"Method not implemented.\");\r\n  }\r\n}\r\n","import { TIME_PER_DAY } from \"core/constants\";\r\nimport { Tile } from \"core/tile\";\r\nimport Mito from \"game/mito/mito\";\r\nimport { WorldRenderer } from \"game/renderers/WorldRenderer\";\r\nimport { map } from \"math\";\r\n// import { createRendererFor } from \"sketches/mito/renderers/WorldRenderer\";\r\nimport { OrthographicCamera, Scene, Vector2, WebGLRenderTarget } from \"three\";\r\n\r\n/**\r\n * A Vignette is a visual snapshot of a plant at a specific stage of growth. It's actually\r\n * just an image.\r\n *\r\n * You can control:\r\n *   How big the vignette is.\r\n */\r\nclass VignetteCapturer {\r\n  static renderTarget = new WebGLRenderTarget(1024, 1024);\r\n\r\n  static rtBuffer = new Uint8Array(VignetteCapturer.renderTarget.width * VignetteCapturer.renderTarget.height * 4);\r\n\r\n  static rtCanvas = (() => {\r\n    const c = document.createElement(\"canvas\");\r\n    c.width = VignetteCapturer.renderTarget.width;\r\n    c.height = VignetteCapturer.renderTarget.height;\r\n    return c;\r\n  })();\r\n\r\n  private lastCaptureTime: number = 0;\r\n\r\n  public constructor(public readonly mito: Mito, public pxPerTile = 32, public captureInterval = TIME_PER_DAY) {}\r\n\r\n  isTimeForNewCapture() {\r\n    return this.mito.world.time - this.lastCaptureTime > this.captureInterval;\r\n  }\r\n\r\n  capture() {\r\n    const { renderTarget, rtBuffer, rtCanvas } = VignetteCapturer;\r\n    this.lastCaptureTime = this.mito.world.time;\r\n\r\n    // Cells that form the vignette:\r\n    const picturesqueCells = Array.from(this.mito.world.allCells());\r\n    // .filter(\r\n    //   (t) => t.pos.y < t.world.height / 2 && !(t instanceof GrowingCell)\r\n    // );\r\n\r\n    const [minBounds, maxBounds] = this.getBounds(picturesqueCells);\r\n\r\n    // add all renderers to a scene\r\n    const scene = new Scene();\r\n    const worldRenderer = new WorldRenderer(this.mito.world, scene, this.mito, false);\r\n    const picturesqueRenderers = picturesqueCells.map((c) => {\r\n      const renderer = worldRenderer.createRendererFor(c);\r\n      renderer?.update();\r\n      return renderer;\r\n    });\r\n\r\n    worldRenderer.tileBatcher.endFrame();\r\n\r\n    // webgl render to a renderTarget\r\n    const camera = this.cameraEncompassingBounds([minBounds, maxBounds]);\r\n    const { renderer } = this.mito;\r\n    renderer.setRenderTarget(renderTarget);\r\n    renderer.clear(true, true, true);\r\n    renderer.render(scene, camera);\r\n    renderer.setRenderTarget(null);\r\n\r\n    // buffer will now contain [r1, g1, b1, a1, r2, g2, b2, a2, ...]\r\n    renderer.readRenderTargetPixels(renderTarget, 0, 0, renderTarget.width, renderTarget.height, rtBuffer);\r\n\r\n    // copy buffer pixels into the full resolution canvas\r\n    const context = rtCanvas.getContext(\"2d\")!;\r\n    const imageData: ImageData = context.createImageData(rtCanvas.width, rtCanvas.height);\r\n    const imageBuffer = imageData.data;\r\n    for (let i = 0; i < rtBuffer.length; i++) {\r\n      imageBuffer[i] = rtBuffer[i];\r\n    }\r\n    context.putImageData(imageData, 0, 0);\r\n\r\n    const boundsWidth = maxBounds.x - minBounds.x;\r\n    const boundsHeight = maxBounds.y - minBounds.y;\r\n    const maxDimension = Math.max(boundsWidth, boundsHeight);\r\n\r\n    const roiWidth = map(boundsWidth, 0, maxDimension, 0, 1024);\r\n    const roiHeight = map(boundsHeight, 0, maxDimension, 0, 1024);\r\n    const roiTopLeft = new Vector2(512 - roiWidth / 2, 512 - roiHeight / 2);\r\n\r\n    const dest = document.createElement(\"canvas\");\r\n    dest.width = Math.ceil(boundsWidth * this.pxPerTile);\r\n    dest.height = Math.ceil(boundsHeight * this.pxPerTile);\r\n    const destContext = dest.getContext(\"2d\")!;\r\n    destContext.drawImage(rtCanvas, roiTopLeft.x, roiTopLeft.y, roiWidth, roiHeight, 0, 0, dest.width, dest.height);\r\n\r\n    const img = new Image();\r\n    img.src = dest.toDataURL();\r\n    document.body.appendChild(img);\r\n\r\n    picturesqueRenderers.forEach((t) => {\r\n      t?.destroy();\r\n    });\r\n    return dest;\r\n  }\r\n\r\n  getBounds(tiles: Tile[]): [Vector2, Vector2] {\r\n    const min = new Vector2();\r\n    const max = new Vector2();\r\n    if (tiles[0] != null) {\r\n      min.copy(tiles[0].pos);\r\n      max.copy(tiles[0].pos);\r\n    }\r\n    for (const t of tiles) {\r\n      min.min(t.pos);\r\n      max.max(t.pos);\r\n    }\r\n    // .pos is the center; pad to the edges of each tile\r\n    min.subScalar(0.5);\r\n    max.addScalar(0.5);\r\n    return [min, max];\r\n  }\r\n\r\n  private cameraEncompassingBounds([min, max]: [Vector2, Vector2]) {\r\n    const center = min.clone().lerp(max, 0.5);\r\n\r\n    const width = max.x - min.x;\r\n    const height = max.y - min.y;\r\n\r\n    // now that we know the bounding box, we want the camera to fit that bounding\r\n    // box perfectly while maintaining the aspect ratio of the renderTarget.\r\n    const largerDim = Math.max(width, height);\r\n    const camera = new OrthographicCamera(\r\n      center.x - largerDim / 2,\r\n      center.x + largerDim / 2,\r\n      center.y + largerDim / 2,\r\n      center.y - largerDim / 2,\r\n      -100,\r\n      100\r\n    );\r\n    return camera;\r\n  }\r\n}\r\n\r\nexport default VignetteCapturer;\r\n","import { Cell } from \"../core/tile\";\r\nimport { World } from \"../core/world/world\";\r\nimport Mito from \"./mito/mito\";\r\n\r\nexport interface GameResult {\r\n  status: \"won\" | \"lost\";\r\n  mpEarners: Map<Cell, number>;\r\n  /**\r\n   * Computed - sum of mpEarners.\r\n   */\r\n  mutationPointsPerEpoch: number;\r\n  world: World;\r\n  vignettes?: HTMLCanvasElement[];\r\n}\r\n\r\nexport function maybeGetGameResult(mito: Mito): GameResult | null {\r\n  const { world } = mito;\r\n  let anyCellsAlive = false || world.playerSeed != null;\r\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n  for (const cell of world.allCells()) {\r\n    anyCellsAlive = true;\r\n    break;\r\n  }\r\n  // const isStandingOnDeadCell = this.tileAt(this.player.pos.x, this.player.pos.y) instanceof DeadCell;\r\n  // const isTimePastOneYear = this.time >= TIME_PER_YEAR;\r\n  // const shouldGameEnd = isStandingOnDeadCell;\r\n  const shouldGameEnd = !anyCellsAlive;\r\n  if (!shouldGameEnd) {\r\n    return null;\r\n  }\r\n\r\n  // make a decision\r\n  return getDecidedGameResult(mito);\r\n}\r\n\r\nexport function getDecidedGameResult(mito: Mito): GameResult {\r\n  const { world, vignettes } = mito;\r\n  const matureEarners = Array.from(world.mpEarners.entries()).filter(([f, mpEarned]) => mpEarned > 0);\r\n  const shouldWin = matureEarners.length > 0;\r\n\r\n  return {\r\n    mpEarners: world.mpEarners,\r\n    mutationPointsPerEpoch: matureEarners.map(([, mp]) => mp).reduce((a, b) => a + b, 0),\r\n    status: shouldWin ? \"won\" : \"lost\",\r\n    vignettes,\r\n    world,\r\n  };\r\n}\r\n","import { params } from \"game/params\";\r\n\r\n// when you press one, the other one gets removed from the keyMap\r\nconst OPPOSITE_KEYS: Record<string, string> = {\r\n  KeyS: \"KeyW\",\r\n  KeyW: \"KeyS\",\r\n  KeyA: \"KeyD\",\r\n  KeyD: \"KeyA\",\r\n};\r\n\r\n/**\r\n * Singleton that listens to key events on window.\r\n */\r\nexport const Keyboard = new (class Keyboard {\r\n  readonly keyMap = new Set<string>();\r\n\r\n  constructor() {\r\n    window.addEventListener(\"blur\", this.handleBlur);\r\n    window.addEventListener(\"keydown\", this.handleKeyDown);\r\n    window.addEventListener(\"keyup\", this.handleKeyUp);\r\n  }\r\n\r\n  private handleBlur = () => {\r\n    this.keyMap.clear();\r\n  };\r\n\r\n  private handleKeyDown = (event: KeyboardEvent) => {\r\n    const code = event.code;\r\n    this.keyMap.add(code);\r\n    if (event.code in OPPOSITE_KEYS) {\r\n      this.keyMap.delete(OPPOSITE_KEYS[code]);\r\n    }\r\n    if (code === \"KeyH\") {\r\n      params.hud = !params.hud;\r\n    }\r\n    if (code === \"Slash\") {\r\n      params.showGodUI = !params.showGodUI;\r\n    }\r\n    const isOpeningDevtoolsOnChrome =\r\n      (code === \"KeyI\" && event.shiftKey && event.ctrlKey) || (code === \"KeyI\" && event.altKey && event.metaKey);\r\n    if (!isOpeningDevtoolsOnChrome) {\r\n      event.preventDefault();\r\n      return false;\r\n    }\r\n  };\r\n\r\n  private handleKeyUp = (event: KeyboardEvent) => {\r\n    this.keyMap.delete(event.code);\r\n  };\r\n})();\r\n\r\nexport default Keyboard;\r\n","import { DIRECTIONS } from \"../../core/directions\";\r\nimport { Action, ActionMove } from \"../../core/player/action\";\r\n\r\nexport const ACTION_CONTINUOUS_KEYMAP: { [key: string]: Action } = {\r\n  // Space: {\r\n  //   type: \"pickup\",\r\n  //   sugar: 30,\r\n  //   water: 30,\r\n  // },\r\n};\r\n\r\nexport const ACTION_INSTANT_KEYMAP: { [key: string]: Action } = {\r\n  // KeyQ: {\r\n  //   type: \"drop\",\r\n  //   sugar: 0,\r\n  //   water: 5,\r\n  // },\r\n  // KeyE: {\r\n  //   type: \"drop\",\r\n  //   sugar: 1,\r\n  //   water: 0,\r\n  // },\r\n};\r\n\r\nexport const MOVEMENT_KEYS: { [key: string]: ActionMove } = {\r\n  KeyW: {\r\n    type: \"move\",\r\n    dir: DIRECTIONS.n,\r\n  },\r\n  KeyA: {\r\n    type: \"move\",\r\n    dir: DIRECTIONS.w,\r\n  },\r\n  KeyS: {\r\n    type: \"move\",\r\n    dir: DIRECTIONS.s,\r\n  },\r\n  KeyD: {\r\n    type: \"move\",\r\n    dir: DIRECTIONS.e,\r\n  },\r\n};\r\n\r\nexport const MOVEMENTS = Object.keys(MOVEMENT_KEYS).map((key) => MOVEMENT_KEYS[key]);\r\n","import { Cell } from \"core/cell\";\r\nimport { Action, ActionMove } from \"core/player/action\";\r\nimport { Vector2 } from \"three\";\r\nimport { Mito } from \"../mito/mito\";\r\nimport Keyboard from \"./keyboard\";\r\nimport { ACTION_CONTINUOUS_KEYMAP, ACTION_INSTANT_KEYMAP, MOVEMENT_KEYS } from \"./keymap\";\r\n\r\nexport interface ControlScheme {\r\n  animate(ms: number): void;\r\n\r\n  destroy(): void;\r\n\r\n  wouldLeftClickInteract(): boolean;\r\n}\r\n\r\nexport class PlayerControlScheme implements ControlScheme {\r\n  public constructor(public mito: Mito) {\r\n    window.addEventListener(\"keydown\", this.handleKeyDown);\r\n    window.addEventListener(\"mousedown\", this.handleMouseDown);\r\n  }\r\n\r\n  destroy() {\r\n    window.removeEventListener(\"keydown\", this.handleKeyDown);\r\n    window.removeEventListener(\"mousedown\", this.handleMouseDown);\r\n  }\r\n\r\n  handleMouseDown = (event: MouseEvent) => {\r\n    // control inspectedCell on click\r\n    if (event.target === this.mito.canvas) {\r\n      if (this.mito.inspectedCell != null) {\r\n        this.mito.inspectedCell = undefined;\r\n        return;\r\n      }\r\n      if (event.button === 0) {\r\n        this.leftClick();\r\n      } else if (event.button === 2) {\r\n        this.rightClick();\r\n      }\r\n    }\r\n  };\r\n\r\n  animate(_ms: number) {\r\n    const { mito } = this;\r\n    if (mito.instructionsOpen) {\r\n      return;\r\n    }\r\n\r\n    // keyboard actions\r\n    const moveAction = this.keysToMovement(Keyboard.keyMap);\r\n    if (moveAction) {\r\n      mito.world.player.setAction(moveAction);\r\n    }\r\n    for (const key of Keyboard.keyMap) {\r\n      if (ACTION_CONTINUOUS_KEYMAP[key]) {\r\n        mito.world.player.setAction(ACTION_CONTINUOUS_KEYMAP[key]);\r\n      }\r\n    }\r\n\r\n    // mouse actions\r\n    switch (this.mito.mouse.button) {\r\n      case 0:\r\n        this.leftClickHold();\r\n        break;\r\n    }\r\n  }\r\n\r\n  handleKeyDown = (event: KeyboardEvent) => {\r\n    const { mito } = this;\r\n    const code = event.code;\r\n    if (!event.repeat) {\r\n      const instructionsCapturedEvent = mito.maybeToggleInstructions(code);\r\n      if (instructionsCapturedEvent) {\r\n        return;\r\n      }\r\n      if (ACTION_INSTANT_KEYMAP[code]) {\r\n        mito.world.player.setAction(ACTION_INSTANT_KEYMAP[code]);\r\n      } else if (mito.inspectedCell != null && code === \"Escape\") {\r\n        mito.inspectedCell = undefined;\r\n      }\r\n    }\r\n    mito.toolBar.keyDown(event);\r\n  };\r\n\r\n  public keysToMovement(keys: Set<string>): ActionMove | null {\r\n    const dir = new Vector2();\r\n    for (const key of keys) {\r\n      if (MOVEMENT_KEYS[key]) {\r\n        dir.add(MOVEMENT_KEYS[key].dir);\r\n      }\r\n    }\r\n    if (dir.x === 0 && dir.y === 0) {\r\n      return null;\r\n    } else {\r\n      return {\r\n        type: \"move\",\r\n        dir,\r\n      };\r\n    }\r\n  }\r\n\r\n  public leftClick() {\r\n    // no-op for left-clicking\r\n    const { mito } = this;\r\n    const target = mito.getHighlightedTile();\r\n    if (target == null) {\r\n      return;\r\n    }\r\n    const action = mito.toolBar.leftClick(target);\r\n    if (action != null && !this.isActionContinuous(action)) {\r\n      mito.world.player.setAction(action);\r\n    }\r\n  }\r\n\r\n  public rightClick() {\r\n    const tile = this.mito.getHighlightedTile();\r\n    if (tile == null) {\r\n      return;\r\n    }\r\n    if (tile instanceof Cell) {\r\n      this.mito.inspectedCell = tile;\r\n    }\r\n  }\r\n\r\n  public leftClickHold() {\r\n    const { mito } = this;\r\n    const target = mito.getHighlightedTile();\r\n    if (target == null) {\r\n      return;\r\n    }\r\n    const action = mito.toolBar.leftClick(target);\r\n    if (this.isActionContinuous(action)) {\r\n      mito.world.player.setAction(action);\r\n    }\r\n  }\r\n\r\n  public wouldLeftClickInteract() {\r\n    const { mito } = this;\r\n    const tile = mito.getHighlightedTile();\r\n    // return tile != null && mito.actionBar.leftClick(tile)?.type === \"interact\";\r\n    const type = tile && mito.toolBar.leftClick(tile)?.type;\r\n    return type === \"pickup\" || type === \"drop\";\r\n  }\r\n\r\n  /**\r\n   * A continuous action should be refreshed while holding the mouse button.\r\n   */\r\n  isActionContinuous(action?: Action): action is Action {\r\n    if (action != null && (action.type === \"pickup\" || action.type === \"drop\")) {\r\n      return !!action.continuous;\r\n    }\r\n    return false;\r\n  }\r\n}\r\n\r\nexport class PlayerSeedControlScheme implements ControlScheme {\r\n  handleKeyDown = (event: KeyboardEvent) => {\r\n    if (event.code === \"Space\") {\r\n      this.popOut();\r\n    }\r\n  };\r\n\r\n  constructor(public mito: Mito) {\r\n    window.addEventListener(\"keydown\", this.handleKeyDown);\r\n  }\r\n\r\n  destroy() {\r\n    window.removeEventListener(\"keydown\", this.handleKeyDown);\r\n  }\r\n\r\n  animate(_ms: number): void {\r\n    if (this.mito.mouse.button === 0) {\r\n      this.handleLeftClick();\r\n    }\r\n  }\r\n\r\n  public popOut() {\r\n    if (this.mito.world.playerSeed && this.mito.world.time > 3) {\r\n      this.mito.world.playerSeed!.popOut();\r\n      this.mito.controls = new PlayerControlScheme(this.mito);\r\n    }\r\n  }\r\n\r\n  public handleLeftClick(): void {\r\n    const clickedPos = this.mito.getHighlightPosition().round();\r\n    if (this.mito.world.playerSeed!.pos.distanceTo(clickedPos) < 0.5) {\r\n      this.popOut();\r\n    }\r\n  }\r\n\r\n  public wouldLeftClickInteract() {\r\n    return false;\r\n  }\r\n}\r\n","import { CellType } from \"core/cell\";\r\nimport { CellArgs } from \"../../core/cell/cell\";\r\nimport { isInteractable } from \"../../core/interactable\";\r\nimport { Action, ActionBuild } from \"../../core/player/action\";\r\nimport { Tile } from \"../../core/tile\";\r\nimport Mito from \"../mito/mito\";\r\n\r\nexport class ToolBar {\r\n  static DIGIT_KEYS = [\"Digit1\", \"Digit2\", \"Digit3\", \"Digit4\", \"Digit5\", \"Digit6\", \"Digit7\", \"Digit8\"];\r\n\r\n  tools: Record<string, Tool> = {\r\n    KeyQ: TOOL_INTERACT,\r\n  };\r\n\r\n  public currentKey: string = \"KeyQ\";\r\n\r\n  constructor(public mito: Mito) {\r\n    for (const index in mito.world.genome.cellTypes) {\r\n      const cellType = mito.world.genome.cellTypes[index];\r\n      const digitKey = ToolBar.DIGIT_KEYS[index];\r\n      this.tools[digitKey] = makeToolToBuildCellType(cellType);\r\n    }\r\n  }\r\n\r\n  isInteract() {\r\n    return this.currentTool === TOOL_INTERACT;\r\n  }\r\n\r\n  leftClick(target: Tile): Action | undefined {\r\n    return this.currentTool.leftClick(target);\r\n  }\r\n\r\n  rightClick(target: Tile): Action | undefined {\r\n    return this.currentTool.rightClick(target);\r\n  }\r\n\r\n  get currentTool() {\r\n    return this.tools[this.currentKey];\r\n  }\r\n\r\n  setKey(key: string) {\r\n    if (key in this.tools) {\r\n      const lastKey = this.currentKey;\r\n\r\n      // if you tap the same cellType twice, modify the args direction\r\n      if (key === lastKey) {\r\n        this.currentTool.nextConfiguration?.();\r\n      }\r\n      this.currentKey = key;\r\n    }\r\n  }\r\n\r\n  keyDown(event: KeyboardEvent) {\r\n    if (event.code === \"Escape\" && this.currentKey !== \"KeyQ\") {\r\n      this.setKey(\"KeyQ\");\r\n    } else if (this.shouldCapture(event)) {\r\n      this.setKey(event.code);\r\n    }\r\n  }\r\n\r\n  shouldCapture(event: KeyboardEvent) {\r\n    return !event.repeat && event.code in this.tools;\r\n  }\r\n}\r\n\r\nexport type Tool = ToolInteract | ToolBuild;\r\n\r\ninterface ToolBase {\r\n  name: string;\r\n  leftClick: (tile: Tile) => Action | undefined;\r\n  rightClick: (tile: Tile) => Action | undefined;\r\n  nextConfiguration?(): void;\r\n}\r\n\r\nexport interface ToolInteract extends ToolBase {\r\n  type: \"interact\";\r\n}\r\n\r\nexport interface ToolBuild extends ToolBase {\r\n  type: \"build\";\r\n  cellType: CellType;\r\n}\r\n\r\nconst TOOL_INTERACT: ToolInteract = {\r\n  name: \"Interact\",\r\n  type: \"interact\",\r\n  leftClick: (target: Tile): Action | undefined => (isInteractable(target) ? target.interact(null!) : undefined),\r\n  rightClick: (target: Tile): Action | undefined => ({\r\n    type: \"deconstruct\",\r\n    position: target.pos,\r\n  }),\r\n};\r\n\r\nfunction makeToolToBuildCellType(cellType: CellType): ToolBuild {\r\n  return {\r\n    name: cellType.name,\r\n    type: \"build\",\r\n    cellType,\r\n    leftClick(target: Tile) {\r\n      let args: CellArgs | undefined;\r\n      if (cellType.args) {\r\n        args = { ...cellType.args };\r\n      }\r\n\r\n      const action: ActionBuild = {\r\n        type: \"build\",\r\n        cellType,\r\n        position: target.pos.clone(),\r\n        args,\r\n      };\r\n      return action;\r\n    },\r\n    rightClick(tile: Tile) {\r\n      return undefined;\r\n    },\r\n    nextConfiguration() {\r\n      cellType.rotateArgDirection();\r\n    },\r\n  };\r\n}\r\n\r\n// function maybeDeconstructAction(tile: Tile): ActionDeconstruct | undefined {\r\n//   if (tile instanceof Cell && tile.isReproductive) {\r\n//     return undefined; // disallow deleting reproductive cells\r\n//   }\r\n//   return {\r\n//     type: \"deconstruct\",\r\n//     position: tile.pos,\r\n//   };\r\n// }\r\n","import classNames from \"classnames\";\r\nimport React, { useRef } from \"react\";\r\nimport { Vector2 } from \"three\";\r\nimport uuid from \"uuid\";\r\nimport { Tile } from \"../../core/tile\";\r\nimport { Mito } from \"./mito\";\r\n\r\nexport class WorldDOMElement {\r\n  uuid = uuid();\r\n\r\n  constructor(\r\n    public mito: Mito,\r\n    public positionFn: () => Vector2 | Tile | null,\r\n    public renderFn: () => React.ReactNode\r\n  ) {}\r\n\r\n  render() {\r\n    const posOrTile = this.positionFn();\r\n    if (posOrTile == null) {\r\n      return null;\r\n    }\r\n    let style: React.CSSProperties;\r\n    if (posOrTile instanceof Vector2) {\r\n      const pos = posOrTile;\r\n      const pixelPosition = this.mito.worldToScreen(pos);\r\n      const left = pixelPosition.x;\r\n      const top = pixelPosition.y;\r\n      style = {\r\n        left,\r\n        top,\r\n      };\r\n    } else {\r\n      const tile = posOrTile;\r\n      const worldTopLeft = tile.pos.clone().addScalar(-0.5);\r\n      const worldBottomRight = tile.pos.clone().addScalar(0.5);\r\n      const pixelTopLeft = this.mito.worldToScreen(worldTopLeft);\r\n      const pixelBottomRight = this.mito.worldToScreen(worldBottomRight);\r\n      const left = pixelTopLeft.x;\r\n      const top = pixelTopLeft.y;\r\n      const width = pixelBottomRight.x - left;\r\n      const height = pixelBottomRight.y - top;\r\n      style = {\r\n        left,\r\n        top,\r\n        width,\r\n        height,\r\n      };\r\n    }\r\n    return (\r\n      <div key={this.uuid} style={style}>\r\n        {this.renderFn()}\r\n      </div>\r\n    );\r\n  }\r\n}\r\n\r\nexport const WorldDOMComponent: React.FC<{\r\n  className?: string;\r\n  mito: Mito;\r\n  positionFn: () => Vector2 | Tile | null;\r\n}> = ({ className, children, mito, positionFn }) => {\r\n  const id = useRef(uuid());\r\n\r\n  const posOrTile = positionFn();\r\n  if (posOrTile == null) {\r\n    return null;\r\n  }\r\n  let style: React.CSSProperties;\r\n  if (posOrTile instanceof Vector2) {\r\n    const pos = posOrTile;\r\n    const pixelPosition = mito.worldToScreen(pos);\r\n    const left = pixelPosition.x;\r\n    const top = pixelPosition.y;\r\n    style = {\r\n      left,\r\n      top,\r\n    };\r\n  } else {\r\n    const tile = posOrTile;\r\n    const worldTopLeft = tile.pos.clone().addScalar(-0.5);\r\n    const worldBottomRight = tile.pos.clone().addScalar(0.5);\r\n    const pixelTopLeft = mito.worldToScreen(worldTopLeft);\r\n    const pixelBottomRight = mito.worldToScreen(worldBottomRight);\r\n    const left = pixelTopLeft.x;\r\n    const top = pixelTopLeft.y;\r\n    const width = pixelBottomRight.x - left;\r\n    const height = pixelBottomRight.y - top;\r\n    style = {\r\n      left,\r\n      top,\r\n      width,\r\n      height,\r\n    };\r\n  }\r\n\r\n  return (\r\n    <div key={id.current} style={style} className={classNames(\"world-dom-component\", className)}>\r\n      {children}\r\n    </div>\r\n  );\r\n};\r\n","import React from \"react\";\r\nimport Ticker from \"std/ticker\";\r\n\r\nexport class Animate extends React.Component<{\r\n  a: (time: number) => void;\r\n}> {\r\n  private rafid?: number;\r\n\r\n  private animate = (time: number) => {\r\n    this.props.a(time / 1000);\r\n  };\r\n\r\n  render() {\r\n    return null;\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.rafid = Ticker.addAnimation(this.animate);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    if (this.rafid) {\r\n      Ticker.removeAnimation(this.rafid);\r\n    }\r\n  }\r\n}\r\n","import * as React from \"react\";\r\n\r\ninterface SceneObjectProps {\r\n  object: THREE.Object3D;\r\n  parent: THREE.Object3D;\r\n  // children?: SceneObject[];\r\n}\r\nexport class SceneObject extends React.PureComponent<SceneObjectProps, {}> {\r\n  // render() {\r\n  //     if (this.props.children) {\r\n  //         return <>\r\n  //             {\r\n  //                 this.props.children.map((child) => React.cloneElement(child, { parent: this.props.object }))\r\n  //             }\r\n  //         </>;\r\n  //     }\r\n  // }\r\n\r\n  render() {\r\n    return null;\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.props.parent.add(this.props.object);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.props.parent.remove(this.props.object);\r\n  }\r\n}\r\n","import * as React from \"react\";\r\nimport * as THREE from \"three\";\r\nimport lazy from \"../../common/lazy\";\r\nimport { Animate } from \"./Animate\";\r\nimport { SceneObject } from \"./sceneObject\";\r\n\r\nexport const TILE_HIGHLIGHT = lazy(() => {\r\n  const geometry = new THREE.PlaneBufferGeometry(1, 1);\r\n  const edgesGeometry = new THREE.EdgesGeometry(geometry, 1); // or WireframeGeometry( geometry )\r\n  const material = new THREE.LineBasicMaterial({\r\n    color: 0xffffff,\r\n    transparent: true,\r\n    opacity: 0.75,\r\n  });\r\n  const lineSegments = new THREE.LineSegments(edgesGeometry, material);\r\n  lineSegments.position.z = 10;\r\n  return lineSegments;\r\n});\r\n\r\nexport interface TileHighlightProps {\r\n  x: number;\r\n  y: number;\r\n  scene: THREE.Scene;\r\n}\r\n\r\nclass TileHighlight extends React.PureComponent<TileHighlightProps, {}> {\r\n  private object = TILE_HIGHLIGHT().clone();\r\n\r\n  render() {\r\n    this.object.position.x = this.props.x;\r\n    this.object.position.y = this.props.y;\r\n    return (\r\n      <>\r\n        <Animate a={(t) => this.object.scale.setScalar(Math.sin(t * 3.7) * 0.04 + 0.94)} />\r\n        <SceneObject object={this.object} parent={this.props.scene} />\r\n      </>\r\n    );\r\n  }\r\n}\r\n\r\nexport default TileHighlight;\r\n","import * as React from \"react\";\r\nimport { Color, DoubleSide, Mesh, MeshBasicMaterial, PlaneBufferGeometry } from \"three\";\r\nimport { CellType } from \"../../core/cell/genome\";\r\nimport { textureFromSpritesheet } from \"../spritesheet\";\r\nimport { SceneObject } from \"./sceneObject\";\r\n\r\nexport const BUILD_BLUEPRINT = (() => {\r\n  const geometry = new PlaneBufferGeometry(1, 1);\r\n  const material = new MeshBasicMaterial({\r\n    side: DoubleSide,\r\n    color: 0xffffff,\r\n    transparent: true,\r\n    opacity: 0.5,\r\n  });\r\n  const mesh = new Mesh(geometry, material);\r\n  mesh.name = \"Build Blueprint\";\r\n  mesh.position.z = 1;\r\n  return mesh;\r\n})();\r\n\r\nexport interface TileHighlightProps {\r\n  x: number;\r\n  y: number;\r\n  cellType: CellType;\r\n  scene: THREE.Scene;\r\n}\r\n\r\nconst BuildBlueprint: React.FC<TileHighlightProps> = ({ x, y, cellType, scene }) => {\r\n  const object = React.useMemo(() => BUILD_BLUEPRINT.clone(), []);\r\n\r\n  React.useEffect(() => {\r\n    object.position.x = x;\r\n    object.position.y = y;\r\n  }, [object.position.x, object.position.y, x, y]);\r\n\r\n  React.useEffect(() => {\r\n    const { material } = cellType;\r\n    const { color, texturePosition } = material;\r\n    const texture = textureFromSpritesheet(texturePosition.x, texturePosition.y);\r\n    const mat = object.material as MeshBasicMaterial;\r\n    mat.map = texture;\r\n    mat.color.set(color || new Color(1, 1, 1));\r\n    mat.needsUpdate = true;\r\n  }, [cellType, object.material]);\r\n\r\n  return <SceneObject object={object} parent={scene} />;\r\n};\r\n\r\nexport default BuildBlueprint;\r\n","import * as React from \"react\";\r\nimport * as THREE from \"three\";\r\nimport lazy from \"../../common/lazy\";\r\nimport { SceneObject } from \"./sceneObject\";\r\n\r\nexport const POINT_HIGHLIGHT = lazy(() => {\r\n  const geometry = new THREE.CircleBufferGeometry(0.1, 20);\r\n  const material = new THREE.MeshBasicMaterial({\r\n    color: 0xffffff,\r\n    transparent: true,\r\n    opacity: 0.75,\r\n    side: THREE.DoubleSide,\r\n  });\r\n  const mesh = new THREE.Mesh(geometry, material);\r\n  mesh.position.z = 10;\r\n  return mesh;\r\n  // const edgesGeometry = new THREE.EdgesGeometry(geometry, 1); // or WireframeGeometry( geometry )\r\n  // const material = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.75 });\r\n  // const lineSegments = new THREE.LineSegments(edgesGeometry, material);\r\n  // lineSegments.position.z = 10;\r\n  // return lineSegments;\r\n});\r\n\r\nexport interface PointHighlightProps {\r\n  x: number;\r\n  y: number;\r\n  z?: number;\r\n  scene: THREE.Scene;\r\n}\r\n\r\nclass PointHighlight extends React.PureComponent<PointHighlightProps, {}> {\r\n  private object = POINT_HIGHLIGHT().clone();\r\n\r\n  render() {\r\n    this.object.position.x = this.props.x;\r\n    this.object.position.y = this.props.y;\r\n    return (\r\n      <>\r\n        {/* <Animate a={((t) => this.object.scale.setScalar(Math.sin(t * 3.7) * 0.04 + 0.94))} /> */}\r\n        <SceneObject object={this.object} parent={this.props.scene} />\r\n      </>\r\n    );\r\n  }\r\n}\r\n\r\nexport default PointHighlight;\r\n","import classNames from \"classnames\";\r\nimport { WorldDOMComponent } from \"game/mito/WorldDOMElement\";\r\nimport TileHighlight from \"game/tutorial/tileHighlight\";\r\nimport * as React from \"react\";\r\nimport { Tile } from \"../../../core/tile\";\r\nimport Mito from \"../../mito/mito\";\r\nimport BuildBlueprint from \"../../tutorial/buildBlueprint\";\r\nimport PointHighlight from \"../../tutorial/PointHighlight\";\r\nimport \"./Hover.scss\";\r\n\r\ninterface HoverProps {\r\n  mito: Mito;\r\n}\r\n\r\nexport class Hover extends React.Component<HoverProps> {\r\n  get scene() {\r\n    return this.props.mito.scene;\r\n  }\r\n\r\n  public render() {\r\n    const isTakingLongAction = this.props.mito.world.player.isTakingLongAction();\r\n    if (isTakingLongAction) {\r\n      return null;\r\n    }\r\n    const { highlightedTile } = this.props.mito;\r\n    const highlightedPosition = this.props.mito.getHighlightPosition();\r\n    return (\r\n      <>\r\n        <PointHighlight x={highlightedPosition.x} y={highlightedPosition.y} scene={this.scene} />\r\n        {this.maybeRenderBuildBlueprint(highlightedTile)}\r\n        {this.maybeRenderTileHighlight(highlightedTile)}\r\n        {/* {this.maybeRenderPath()} */}\r\n      </>\r\n    );\r\n  }\r\n\r\n  public maybeRenderTileHighlight(tile?: Tile) {\r\n    if (tile == null) {\r\n      return;\r\n    }\r\n    const { mito } = this.props;\r\n    const leftClickType = mito.toolBar.leftClick(tile)?.type;\r\n    const showBuildBlueprint = leftClickType === \"pickup\" || leftClickType === \"drop\";\r\n    const tileHighlight = showBuildBlueprint ? (\r\n      <TileHighlight x={tile.pos.x} y={tile.pos.y} scene={this.props.mito.scene} />\r\n    ) : null;\r\n    return tileHighlight;\r\n  }\r\n\r\n  public maybeRenderBuildBlueprint(tile?: Tile) {\r\n    if (tile == null) {\r\n      return;\r\n    }\r\n    const { mito } = this.props;\r\n    const action = mito.toolBar.leftClick(tile);\r\n    if (action != null && action.type === \"build\") {\r\n      const isBuildValid = mito.world.player.canBuildAt(tile);\r\n      return (\r\n        <>\r\n          <WorldDOMComponent\r\n            className={classNames(\"build-drop-shadow\", { valid: isBuildValid })}\r\n            mito={mito}\r\n            positionFn={() => tile}\r\n          ></WorldDOMComponent>\r\n          <BuildBlueprint x={tile.pos.x} y={tile.pos.y} cellType={action.cellType} scene={this.props.mito.scene} />\r\n        </>\r\n      );\r\n    }\r\n  }\r\n}\r\n","import classNames from \"classnames\";\r\nimport * as React from \"react\";\r\n\r\ninterface HotkeyButtonProps extends React.HTMLProps<HTMLDivElement> {\r\n  hotkey: string;\r\n}\r\n\r\nexport function HotkeyButton({ hotkey, className, onClick, ...restProps }: HotkeyButtonProps) {\r\n  const handleClick = (e: React.MouseEvent<HTMLDivElement>) => {\r\n    onClick && onClick(e);\r\n    ensureCanvasFocus(e);\r\n  };\r\n  return (\r\n    <div className={classNames(\"mito-hud-button\", className)} onClick={handleClick} {...restProps}>\r\n      <span className=\"mito-hud-button-hotkey\">{hotkey}</span>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ensureCanvasFocus(e: React.SyntheticEvent<any>) {\r\n  e.preventDefault();\r\n  const canvas = document.getElementsByTagName(\"canvas\")[0];\r\n  canvas.focus();\r\n}\r\n","import sugarSrc from \"assets/images/sugar.png\";\r\nimport waterSrc from \"assets/images/water.png\";\r\nimport * as React from \"react\";\r\nexport const ResourceIcon: React.FC<{\r\n  name: \"sugar\" | \"water\";\r\n}> = React.memo(({ name }) => <img alt=\"\" src={name === \"sugar\" ? sugarSrc : waterSrc} className=\"resource-icon\" />);\r\n","import classNames from \"classnames\";\r\nimport DynamicNumber from \"game/ui/common/DynamicNumber\";\r\nimport * as React from \"react\";\r\nimport { ResourceIcon } from \"../common/ResourceIcon\";\r\nimport \"./InventoryBar.scss\";\r\n\r\nexport const InventoryBar: React.FC<{\r\n  water: number;\r\n  sugar: number;\r\n  capacity: number;\r\n  format: \"text\" | \"icons\";\r\n  colored?: boolean;\r\n  capacityBasedWidth?: boolean;\r\n  className?: string;\r\n}> = React.memo(({ water, sugar, capacity, className, colored = true, format, capacityBasedWidth }) => {\r\n  if (capacity === 0) {\r\n    return null;\r\n  }\r\n  const waterPercent = water / capacity;\r\n  const sugarPercent = sugar / capacity;\r\n  const emptyPercent = 1 - (water + sugar) / capacity;\r\n  const waterStyles: React.CSSProperties = {\r\n    width: `${waterPercent * 100}%`,\r\n  };\r\n  const sugarStyles: React.CSSProperties = {\r\n    width: `${sugarPercent * 100}%`,\r\n  };\r\n  const emptyStyles: React.CSSProperties = {\r\n    width: `${emptyPercent * 100}%`,\r\n  };\r\n  const textElements =\r\n    format === \"text\" ? (\r\n      <>\r\n        <span className=\"text water\">\r\n          <DynamicNumber speed={0.5} value={water} /> water\r\n        </span>\r\n        &nbsp;\r\n        <span className=\"text sugar\">\r\n          <DynamicNumber speed={0.5} value={sugar} /> sugar\r\n        </span>\r\n      </>\r\n    ) : (\r\n      <>\r\n        {water > 0 ? (\r\n          <span className=\"text water\">\r\n            {sugar > 0 ? <ResourceIcon name=\"water\" /> : null} <DynamicNumber speed={0.5} value={water} />\r\n          </span>\r\n        ) : null}\r\n        {sugar > 0 ? (\r\n          <span className=\"text sugar\">\r\n            <ResourceIcon name=\"sugar\" /> <DynamicNumber speed={0.5} value={sugar} />\r\n          </span>\r\n        ) : null}\r\n      </>\r\n    );\r\n\r\n  const barStyles: React.CSSProperties = {\r\n    width: capacityBasedWidth ? 10 * capacity : undefined,\r\n  };\r\n\r\n  return (\r\n    <div className={classNames(\"inventory-bar-container\", className)}>\r\n      <div className=\"inventory-bar\" style={barStyles}>\r\n        <div style={waterStyles} className=\"bar-water\"></div>\r\n        <div style={sugarStyles} className=\"bar-sugar\"></div>\r\n        <div style={emptyStyles} className=\"bar-empty\"></div>\r\n        {capacityBasedWidth ? <div className=\"markers\" /> : null}\r\n      </div>\r\n      <div className={classNames(\"inventory-text\", { colored })}>{textElements}</div>\r\n    </div>\r\n  );\r\n});\r\n","import { map } from \"math\";\r\nimport * as React from \"react\";\r\nimport { Temperature, temperatureFor } from \"../../../core/temperature\";\r\nimport { Tile } from \"../../../core/tile\";\r\n\r\nconst COLOR_FOR_TEMPERATURE: Record<Temperature, string> = {\r\n  Freezing: \"darkblue\",\r\n  Cold: \"lightblue\",\r\n  Mild: \"lightgray\",\r\n  Hot: \"orange\",\r\n  Scorching: \"red\",\r\n};\r\n\r\nconst TemperatureInfo: React.FC<{ tile: Tile }> = ({ tile }) => {\r\n  const size = 30;\r\n\r\n  const temperatureScaleElements: JSX.Element[] = [];\r\n  for (let tempBarLow = 0; tempBarLow < 32 * 3; tempBarLow += 32 / 3) {\r\n    const tempBarHigh = tempBarLow + 32 / 3;\r\n    const tempBarMid = (tempBarLow + tempBarHigh) / 2;\r\n    const midAngle = map(tempBarMid, 0, 96, -210, 30);\r\n    const div = (\r\n      <div\r\n        key={midAngle}\r\n        className=\"temperature-scale\"\r\n        style={{\r\n          transform: `rotate(${midAngle}deg)`,\r\n          borderRight: `${size / 4}px solid ${COLOR_FOR_TEMPERATURE[temperatureFor(tempBarMid)]}`,\r\n        }}\r\n      />\r\n    );\r\n    temperatureScaleElements.push(div);\r\n  }\r\n\r\n  const tempAngle = map(tile.temperatureFloat, 0, 96, -210, 30);\r\n  return (\r\n    <div className=\"info-tile-temperature\">\r\n      <div style={{ width: size, height: size }}>\r\n        {temperatureScaleElements}\r\n        <div className=\"temperature-pointer\" style={{ transform: `rotate(${tempAngle}deg)` }}></div>\r\n        <div className=\"temperature-label\">F</div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default TemperatureInfo;\r\n","/* eslint-disable jsx-a11y/accessible-emoji */\r\nimport { nf } from \"common/formatters\";\r\nimport * as React from \"react\";\r\nimport { GiDustCloud } from \"react-icons/gi\";\r\nimport { CellEffectConstructor } from \"../../../core/cell/cellEffect\";\r\nimport { Gene } from \"../../../core/cell/gene\";\r\nimport { GeneInstance } from \"../../../core/cell/geneInstance\";\r\nimport { describeCellInteraction } from \"../../../core/cell/genome\";\r\nimport { Air, Cell, Fountain, FreezeEffect, GrowingCell, Soil, Tile } from \"../../../core/tile\";\r\nimport { GeneLiving, GeneSoilAbsorption, SoilAbsorptionState } from \"../../../std/genes\";\r\nimport { GenePhotosynthesis, PhotosynthesisState } from \"../../../std/genes/GenePhotosynthesis\";\r\nimport { GeneFruit, GeneSeed, ReproducerState } from \"../../../std/genes/GeneReproducer\";\r\nimport { InventoryBar } from \"./InventoryBar\";\r\nimport TemperatureInfo from \"./TemperatureInfo\";\r\nimport \"./TileDetails.scss\";\r\n\r\ninterface TileDetailsProps {\r\n  tile?: Tile;\r\n}\r\n\r\nfunction formatSeconds(seconds: number, fractionDigits = 1) {\r\n  return `${Math.max(0, seconds).toFixed(fractionDigits)}s`;\r\n}\r\n\r\nexport class TileDetails extends React.Component<TileDetailsProps> {\r\n  public render() {\r\n    const { tile } = this.props;\r\n    if (!tile) {\r\n      return null;\r\n    }\r\n    return (\r\n      <div className=\"tile-details\">\r\n        {this.tileInfo(tile)}\r\n        {this.cellInfo(tile)}\r\n        {this.growingCellInfo(tile)}\r\n        {this.airInfo(tile)}\r\n        {this.soilInfo(tile)}\r\n        {this.fountainInfo(tile)}\r\n        {this.interactInfo(tile)}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private interactInfo(tile: Tile) {\r\n    if (tile instanceof Cell) {\r\n      const leftClickEl =\r\n        tile.type.interaction != null ? (\r\n          <div className=\"interact-info first\">Left click - {describeCellInteraction(tile.type.interaction)}.</div>\r\n        ) : null;\r\n      return (\r\n        <div className=\"interact-infos\">\r\n          {leftClickEl}\r\n          <div className=\"interact-info\">Right click - more options.</div>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  private cellInfo(tile: Tile) {\r\n    if (tile instanceof Cell) {\r\n      const secondsPerUpkeep = tile.findGene(GeneLiving)!.props.secondsPerUpkeep;\r\n      const secondsRemaining = tile.energy * secondsPerUpkeep;\r\n      return (\r\n        <>\r\n          <div className=\"info-energy\">\r\n            &nbsp;{nf(tile.energy * 100, 2)}% Energy ({Math.floor(secondsRemaining)} seconds remaining)\r\n          </div>\r\n          {tile.droopY * 200 > 1 ? <div className=\"info-cell\">{(tile.droopY * 200).toFixed(0)}% droop</div> : null}\r\n          {this.cellEffects(tile)}\r\n          {this.geneInfos(tile)}\r\n        </>\r\n      );\r\n    }\r\n  }\r\n\r\n  private geneInfos(cell: Cell) {\r\n    return (\r\n      <>\r\n        {cell.geneInstances.map((gene, index) => {\r\n          if (gene.isType(GeneSoilAbsorption)) {\r\n            return <React.Fragment key={index}>{this.soilAbsorptionInfo(gene.state)}</React.Fragment>;\r\n          } else if (gene.isType(GenePhotosynthesis)) {\r\n            return <React.Fragment key={index}>{this.photosynthesisInfo(gene.state)}</React.Fragment>;\r\n          } else if (gene.isType(GeneFruit) || gene.isType(GeneSeed)) {\r\n            return <React.Fragment key={index}>{this.reproducerInfo(gene)}</React.Fragment>;\r\n          } else {\r\n            return null;\r\n          }\r\n        })}\r\n      </>\r\n    );\r\n  }\r\n\r\n  private soilAbsorptionInfo(state: SoilAbsorptionState) {\r\n    return (\r\n      <div className=\"info-root\">\r\n        <div>Absorbs in {formatSeconds(state.cooldown)}.</div>\r\n        <div>{state.totalSucked.toFixed(1)} total water absorbed so far.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private photosynthesisInfo(state: PhotosynthesisState) {\r\n    return (\r\n      <div className=\"info-leaf\">\r\n        <div>{(state.averageChancePerSecond * 100).toFixed(1)}% chance to photosynthesize per second.</div>\r\n        <div>{(1 / state.averageConversionRate).toFixed(2)} water per sugar.</div>\r\n        <div>{state.totalSugarProduced.toFixed(2)} total sugar produced so far.</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private reproducerInfo(instance: GeneInstance<Gene<ReproducerState, any>>) {\r\n    const { state, props } = instance;\r\n    return (\r\n      <div>\r\n        <div>\r\n          {nf(state.committedResources.water, 3)}/{props.neededResources / 2} water consumed.\r\n        </div>\r\n        <div>\r\n          {nf(state.committedResources.sugar, 3)}/{props.neededResources / 2} sugar consumed.\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private airInfo(tile: Tile) {\r\n    if (tile instanceof Air) {\r\n      return (\r\n        <div className=\"info-air\">\r\n          <div> {nf(tile.sunlight() * 100, 2)}%</div>\r\n          <div>\r\n            <GiDustCloud /> {nf((1 - tile.co2()) * 100, 2)}%\r\n          </div>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  private soilInfo(tile: Tile) {\r\n    if (tile instanceof Soil) {\r\n      return (\r\n        <div className=\"info-soil\">\r\n          <div>Depth {tile.depth}.</div>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  private fountainInfo(tile: Tile) {\r\n    if (tile instanceof Fountain) {\r\n      return (\r\n        <div className=\"info-fountain\">\r\n          <div>{formatSeconds(tile.cooldown)} until next water.</div>\r\n          <div>{tile.waterRemaining} water left.</div>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  private tileInfo(tile: Tile) {\r\n    return (\r\n      <div className=\"info-tile\">\r\n        <div className=\"info-tile-row\">\r\n          <div className=\"info-tile-name\">{tile.displayName}</div>\r\n          <TemperatureInfo tile={tile} />\r\n          <InventoryBar\r\n            water={tile.inventory.water}\r\n            sugar={tile.inventory.sugar}\r\n            capacity={tile.inventory.capacity}\r\n            format=\"icons\"\r\n            colored={false}\r\n            capacityBasedWidth\r\n          />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private cellEffects(cell: Cell) {\r\n    const { effects } = cell;\r\n    if (effects.length > 0) {\r\n      const descriptors = effects\r\n        .map((e) => {\r\n          const name = (e.constructor as CellEffectConstructor).displayName;\r\n          if (e instanceof FreezeEffect) {\r\n            return `${(e.percentFrozen * 100).toFixed(0)}% ${name}`;\r\n          } else {\r\n            return name;\r\n          }\r\n        })\r\n        .join(\", \");\r\n      return <div className=\"info-cell\">{descriptors}</div>;\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private growingCellInfo(tile: Tile) {\r\n    if (tile instanceof GrowingCell) {\r\n      return <div className=\"info-growing-cell\">{nf(tile.percentMatured * 100, 2)}% mature</div>;\r\n    }\r\n  }\r\n}\r\n","import { Player } from \"core\";\r\nimport { Cell } from \"core/tile\";\r\nimport { ResourceIcon } from \"game/ui/common/ResourceIcon\";\r\nimport React from \"react\";\r\nimport \"./CellInspector.scss\";\r\n\r\nexport const CellInspector: React.FC<{\r\n  cell: Cell;\r\n  player: Player;\r\n}> = ({ cell, player }) => {\r\n  return (\r\n    <div className=\"cell-inspector\">\r\n      <div>\r\n        <h3>{cell.displayName}</h3>\r\n      </div>\r\n      <div className=\"buttons\">\r\n        <div className=\"resources\">\r\n          <div className=\"resource-row\">\r\n            <button\r\n              disabled={cell.inventory.water === 0}\r\n              onClickCapture={(e) => {\r\n                cell.inventory.give(player.inventory, 1, 0);\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n              }}\r\n            >\r\n              Take&nbsp;\r\n              <ResourceIcon name=\"water\" />\r\n            </button>\r\n            <button\r\n              disabled={player.inventory.water === 0}\r\n              onClickCapture={(e) => {\r\n                player.inventory.give(cell.inventory, 1, 0);\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n              }}\r\n            >\r\n              Give&nbsp;\r\n              <ResourceIcon name=\"water\" />\r\n            </button>\r\n          </div>\r\n          <div className=\"resource-row\">\r\n            <button\r\n              disabled={cell.inventory.sugar === 0}\r\n              onClickCapture={(e) => {\r\n                cell.inventory.give(player.inventory, 0, 1);\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n              }}\r\n            >\r\n              Take&nbsp;\r\n              <ResourceIcon name=\"sugar\" />\r\n            </button>\r\n            <button\r\n              disabled={player.inventory.sugar === 0}\r\n              onClickCapture={(e) => {\r\n                player.inventory.give(cell.inventory, 0, 1);\r\n                e.preventDefault();\r\n                e.stopPropagation();\r\n              }}\r\n            >\r\n              Give&nbsp;\r\n              <ResourceIcon name=\"sugar\" />\r\n            </button>\r\n          </div>\r\n        </div>\r\n        <button className=\"deconstruct\" onClick={() => player.setAction({ type: \"deconstruct\", position: cell.pos })}>\r\n          Deconstruct\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n","import * as React from \"react\";\r\nimport { Season, SEASON_NAMES } from \"../../../../core\";\r\nimport \"./SeasonsTracker.scss\";\r\n\r\nexport default function SeasonsTracker({ time, season }: { time: number; season: Season }) {\r\n  return (\r\n    <div className=\"seasons-tracker\">\r\n      <div className=\"season-display\">\r\n        {season.year > 0 ? <>Year {season.year + 1}, </> : null}\r\n        {SEASON_NAMES[season.season]}\r\n        <br />\r\n        Month {season.month}\r\n        <br />\r\n        Day {season.day}\r\n      </div>\r\n      <div className=\"time\">{formatTime(time)}</div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction formatTime(t: number) {\r\n  return new Date(1000 * t).toISOString().substr(14, 5);\r\n}\r\n","import classNames from \"classnames\";\r\nimport { spritesheetLoaded } from \"game/spritesheet\";\r\nimport IconCell, { ActionBarItem } from \"game/ui/common/IconCell\";\r\nimport * as React from \"react\";\r\nimport { Vector2 } from \"three\";\r\nimport { Tool, ToolBar, ToolBuild } from \"../../../input/toolBar\";\r\nimport { HotkeyButton } from \"../HotkeyButton\";\r\nimport \"./ToolBarUI.scss\";\r\n\r\nexport const ToolBarUI: React.FC<{ bar: ToolBar }> = ({ bar }) => {\r\n  const keys = Object.keys(bar.tools);\r\n  return (\r\n    <div className=\"tool-bar\">\r\n      <div className=\"tool-bar-items\">\r\n        {keys.map((code) => {\r\n          return (\r\n            <ToolBarItem key={code} bar={bar} code={code} selected={bar.currentKey === code} tool={bar.tools[code]} />\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst ToolBarItem: React.FC<{ bar: ToolBar; code: string; selected: boolean; tool: Tool }> = ({\r\n  bar,\r\n  code,\r\n  selected,\r\n  tool,\r\n}) => {\r\n  const onClick = React.useCallback(() => {\r\n    bar.setKey(code);\r\n  }, [bar, code]);\r\n\r\n  const itemIcon =\r\n    tool.type === \"interact\" ? (\r\n      <ActionBarItem onClick={onClick} className=\"interact-tool-icon\">\r\n        {tool.name}\r\n      </ActionBarItem>\r\n    ) : (\r\n      <ToolBuildIcon onClick={onClick} tool={tool} spritesheetLoaded={spritesheetLoaded} />\r\n    );\r\n\r\n  const hotkey = code.charAt(code.length - 1);\r\n  return (\r\n    <div className={classNames(\"tool-bar-item\", { selected })}>\r\n      {itemIcon}\r\n      <HotkeyButton className=\"mito-hud-build-item\" hotkey={hotkey} onClick={onClick} />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport interface CellBarItemProps {\r\n  onClick: () => void;\r\n  spritesheetLoaded: boolean;\r\n  tool: ToolBuild;\r\n}\r\n\r\nconst ToolBuildIcon: React.FC<CellBarItemProps> = ({ onClick, spritesheetLoaded, tool }) => {\r\n  const argsChildren: JSX.Element[] = [];\r\n  const type = tool.cellType;\r\n  if (type.args && type.args.direction) {\r\n    argsChildren.push(<TransportDirArrow key={argsChildren.length} dir={type.args.direction} />);\r\n  }\r\n  return (\r\n    <IconCell onClick={onClick} cellType={type} spritesheetLoaded={spritesheetLoaded}>\r\n      {type.name}\r\n      {argsChildren}\r\n    </IconCell>\r\n  );\r\n};\r\n\r\nconst TransportDirArrow: React.FC<{ dir: Vector2 }> = ({ dir }) => {\r\n  return <div className=\"transport-dir-arrow\" style={{ transform: `rotate(${dir.angle()}rad)` }}></div>;\r\n};\r\n","import classnames from \"classnames\";\r\nimport { WorldDOMComponent } from \"game/mito/WorldDOMElement\";\r\nimport { Button } from \"game/ui/common/Button\";\r\nimport * as React from \"react\";\r\nimport uuid from \"uuid\";\r\nimport { getDecidedGameResult } from \"../../../gameResult\";\r\nimport { PlayerSeedControlScheme } from \"../../../input/ControlScheme\";\r\nimport Mito from \"../../../mito/mito\";\r\nimport GenomeViewer from \"../../GenomeViewer\";\r\nimport { HotkeyButton } from \"../HotkeyButton\";\r\nimport { InventoryBar } from \"../InventoryBar\";\r\nimport { TileDetails } from \"../TileDetails\";\r\nimport { CellInspector } from \"./CellInspector\";\r\nimport \"./HUD.scss\";\r\nimport SeasonsTracker from \"./SeasonsTracker\";\r\nimport { ToolBarUI } from \"./ToolBarUI\";\r\n\r\nexport interface HUDProps {\r\n  mito: Mito;\r\n}\r\n\r\nexport interface HUDState {\r\n  traitsPanelOpen: boolean;\r\n  genomeViewerOpen: boolean;\r\n}\r\n\r\nexport class HUD extends React.Component<HUDProps, HUDState> {\r\n  state: HUDState = {\r\n    traitsPanelOpen: true,\r\n    genomeViewerOpen: false,\r\n  };\r\n\r\n  get mito() {\r\n    return this.props.mito;\r\n  }\r\n\r\n  get world() {\r\n    return this.mito.world;\r\n  }\r\n\r\n  get player() {\r\n    return this.world.player;\r\n  }\r\n\r\n  get inventory() {\r\n    return this.player.inventory;\r\n  }\r\n\r\n  private isTutorialFinished() {\r\n    return this.mito.tutorialRef == null ? true : this.mito.tutorialRef.isFinished();\r\n  }\r\n\r\n  componentDidMount() {\r\n    window.addEventListener(\"keydown\", this.handleKeyDown);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    window.removeEventListener(\"keydown\", this.handleKeyDown);\r\n  }\r\n\r\n  private handleKeyDown = (e: KeyboardEvent) => {\r\n    if (e.code === \"Tab\") {\r\n      this.setState({\r\n        genomeViewerOpen: !this.state.genomeViewerOpen,\r\n      });\r\n    }\r\n  };\r\n\r\n  public render() {\r\n    const isMaxed = this.inventory.isMaxed();\r\n    const isMaxedEl = <div className={`mito-inventory-maxed${isMaxed ? \" is-maxed\" : \"\"}`}>maxed</div>;\r\n    const showPlayerHUD = this.world.playerSeed == null;\r\n    return (\r\n      <>\r\n        <div className={classnames(\"hud-top-center\", { hidden: !showPlayerHUD })}>\r\n          <SeasonsTracker time={this.world.time} season={this.world.season} />\r\n        </div>\r\n        {this.maybeRenderGenomeViewer()}\r\n        {this.maybeRenderCollectButton()}\r\n        {this.maybeRenderGerminateButton()}\r\n        {this.maybeRenderInvalidAction()}\r\n        <div className={classnames(\"hud-bottom-right\", { hidden: !showPlayerHUD })}>\r\n          <TileDetails tile={this.mito.getHighlightedTile()} />\r\n          <div className=\"player-inventory-container\">\r\n            {isMaxedEl}\r\n            <InventoryBar\r\n              water={this.inventory.water}\r\n              sugar={this.inventory.sugar}\r\n              capacity={this.inventory.capacity}\r\n              format=\"icons\"\r\n              className=\"player-inventory-bar\"\r\n            />\r\n          </div>\r\n          <ToolBarUI bar={this.mito.toolBar} />\r\n        </div>\r\n        {this.maybeRenderCellInspector()}\r\n      </>\r\n    );\r\n  }\r\n\r\n  private positionFn = () => {\r\n    return this.mito.inspectedCell ?? null;\r\n  };\r\n\r\n  maybeRenderCellInspector() {\r\n    const cell = this.mito.inspectedCell;\r\n    if (cell != null) {\r\n      return (\r\n        // <ReactModal\r\n        //   isOpen\r\n        //   ariaHideApp={false}\r\n        //   shouldCloseOnEsc\r\n        //   shouldCloseOnOverlayClick\r\n        //   onRequestClose={() => {\r\n        //     this.mito.inspectedCell = undefined;\r\n        //   }}\r\n        // >\r\n        <WorldDOMComponent mito={this.mito} positionFn={this.positionFn}>\r\n          <CellInspector cell={cell} player={this.player} />\r\n        </WorldDOMComponent>\r\n      );\r\n    }\r\n  }\r\n\r\n  maybeRenderInvalidAction() {\r\n    const invalidAction = this.mito.invalidAction;\r\n    if (invalidAction != null) {\r\n      return <InvalidActionMessage invalidAction={invalidAction} />;\r\n    }\r\n  }\r\n\r\n  maybeRenderGerminateButton() {\r\n    const showSeedHUD = this.world.playerSeed != null;\r\n    const popOutFn = () => {\r\n      const { controls } = this.mito;\r\n      if (controls instanceof PlayerSeedControlScheme) {\r\n        controls.popOut();\r\n      }\r\n    };\r\n    if (showSeedHUD) {\r\n      return (\r\n        <div className=\"hud-germinate\" onClick={popOutFn}>\r\n          <p>Germinate</p>\r\n          <HotkeyButton hotkey=\"Space\" onClick={popOutFn} />\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  maybeRenderCollectButton() {\r\n    const result = getDecidedGameResult(this.mito);\r\n    if (result.status === \"won\") {\r\n      return (\r\n        <div className=\"hud-right-of-time\">\r\n          <Button color=\"purple\" onClick={() => this.mito.onWinLoss(result)}>\r\n            Win (+ {result.mutationPointsPerEpoch} MP)\r\n          </Button>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  maybeRenderGenomeViewer() {\r\n    if (this.state.genomeViewerOpen) {\r\n      return (\r\n        <div className=\"hud-top\">\r\n          <GenomeViewer genome={this.mito.world.genome} />\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n}\r\n\r\nconst InvalidActionMessage: React.FC<{ invalidAction: { message: string } }> = React.memo(({ invalidAction }) => {\r\n  // get new id on every render (aka reference equal invalidAction)\r\n  // to trigger animation each time\r\n  const id = uuid();\r\n  return (\r\n    <div className=\"hud-below-center\">\r\n      <div className=\"invalid-action\" key={id}>\r\n        {invalidAction.message}\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n","import { nf } from \"common/formatters\";\r\nimport React, { memo, useRef } from \"react\";\r\nimport { World } from \"../../../core\";\r\nimport { TIME_PER_SEASON } from \"../../../core/constants\";\r\nimport { GenePhotosynthesis, GeneSoilAbsorption } from \"../../../std/genes\";\r\nimport { ResourceIcon } from \"../common/ResourceIcon\";\r\n\r\n// time is just used for re-rendering\r\nconst PlantStats: React.FC<{ world: World; time: number }> = memo(({ world, time }) => {\r\n  const lastTime = useRef(0);\r\n  const lastTotalEnergy = useRef(0);\r\n  const dt = time - lastTime.current;\r\n\r\n  let numWater = 0;\r\n  let numSugar = 0;\r\n  let totalEnergy = 0;\r\n  let numCells = 0;\r\n  let totalWaterAbsorbed = 0;\r\n  let totalSugarProduced = 0;\r\n  for (const cell of world.allCells()) {\r\n    numWater += cell.inventory.water;\r\n    numSugar += cell.inventory.sugar;\r\n    totalEnergy += cell.energy;\r\n    numCells++;\r\n    const soilAbsorb = cell.findGene(GeneSoilAbsorption);\r\n    if (soilAbsorb) {\r\n      totalWaterAbsorbed += soilAbsorb.state.totalSucked;\r\n    }\r\n    const photosynthesis = cell.findGene(GenePhotosynthesis);\r\n    if (photosynthesis) {\r\n      totalSugarProduced += photosynthesis.state.totalSugarProduced;\r\n    }\r\n  }\r\n  const energyUsed = lastTotalEnergy.current - totalEnergy;\r\n  const energyUsePerSecond = energyUsed / dt;\r\n  const energyUsePerSeason = energyUsePerSecond * TIME_PER_SEASON;\r\n  const sugarUsePerSeason = energyUsePerSeason;\r\n  const timeUntilStarvation = totalEnergy / energyUsePerSecond;\r\n  const averageWaterPerSeason = (totalWaterAbsorbed / world.time) * TIME_PER_SEASON;\r\n  const averageSugarPerSeason = (totalSugarProduced / world.time) * TIME_PER_SEASON;\r\n\r\n  lastTotalEnergy.current = totalEnergy;\r\n  lastTime.current = time;\r\n\r\n  return (\r\n    <div className=\"plant-stats\" style={{ margin: \"10px 0\", textAlign: \"left\" }}>\r\n      <div>\r\n        {nf(numWater, 3)} <ResourceIcon name=\"water\" />,{nf(numSugar, 3)} <ResourceIcon name=\"sugar\" />\r\n      </div>\r\n      <div>Water per season: {nf(averageWaterPerSeason, 3)}</div>\r\n      <div>Sugar per season: {nf(averageSugarPerSeason, 3)}</div>\r\n      <div>Total energy: {nf(totalEnergy, 4)}</div>\r\n      <div>Average energy: {nf((totalEnergy / numCells) * 100, 2)}%</div>\r\n      <div>Sugar use per season: {nf(sugarUsePerSeason, 3)}</div>\r\n      <div>Time until starvation: {nf(timeUntilStarvation, 3)} seconds.</div>\r\n    </div>\r\n  );\r\n});\r\n\r\nexport default PlantStats;\r\n","import { Button } from \"game/ui/common/Button\";\r\nimport * as React from \"react\";\r\nimport Keyboard from \"../../input/keyboard\";\r\nimport Mito from \"../../mito/mito\";\r\nimport PlantStats from \"./PlantStats\";\r\n\r\nconst Debug: React.FC<{ mito: Mito }> = ({ mito }) => {\r\n  const doWin = React.useCallback(() => {\r\n    mito.onWinLoss({\r\n      mpEarners: mito.world.mpEarners,\r\n      world: mito.world,\r\n      status: \"won\",\r\n      mutationPointsPerEpoch: 2,\r\n      vignettes: mito.vignettes,\r\n    });\r\n  }, [mito]);\r\n\r\n  const doLose = React.useCallback(() => {\r\n    mito.onWinLoss({\r\n      mpEarners: mito.world.mpEarners,\r\n      world: mito.world,\r\n      status: \"lost\",\r\n      mutationPointsPerEpoch: 0,\r\n      vignettes: mito.vignettes,\r\n    });\r\n  }, [mito]);\r\n\r\n  return (\r\n    <div style={{ position: \"absolute\", bottom: 0, left: 0, background: \"white\" }}>\r\n      <div style={{ display: \"flex\" }}>\r\n        <Button color=\"green\" onClick={doWin}>\r\n          Win\r\n        </Button>\r\n        <Button color=\"green\" onClick={doLose}>\r\n          Lose\r\n        </Button>\r\n      </div>\r\n      <PlantStats world={mito.world} time={Math.floor(mito.world.time)} />\r\n      <div>\r\n        <div>Rainwater: {mito.world.numRainWater}</div>\r\n        <div>Evaporated Air: {mito.world.numEvaporatedAir}</div>\r\n        <div>Evaporated Soil: {mito.world.numEvaporatedSoil}</div>\r\n      </div>\r\n      <div style={{ background: \"white\" }}>{Array.from(Keyboard.keyMap.values()).join(\", \")}</div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Debug;\r\n","import * as React from \"react\";\r\nimport { LEAF_REACTION_TIME, PLAYER_MAX_RESOURCES, TISSUE_INVENTORY_CAPACITY } from \"../../../core/constants\";\r\n\r\ninterface InstructionsProps {\r\n  play: () => void;\r\n}\r\nexport class Instructions extends React.PureComponent<InstructionsProps, {}> {\r\n  render() {\r\n    return (\r\n      <div className=\"mito-instructions\">\r\n        <div className=\"mito-instructions-container\">\r\n          <div className=\"esc\" onClick={() => this.props.play()}>\r\n            Back (Esc)\r\n          </div>\r\n          <h1>Mito</h1>\r\n          <div className=\"play-button\" onClick={() => this.props.play()}>\r\n            Play\r\n          </div>\r\n          <p>\r\n            <ol>\r\n              <li>Build Tissue to expand your reach (press t and walk into empty space).</li>\r\n              <li>Build Roots (press r) underground to suck up adjacent water.</li>\r\n              <li>Build Leaves (press l) above ground and drop water (press 1) to convert water into sugar.</li>\r\n              <li>\r\n                <b>Win the game by building and loading the Fruit with 1000 sugar.</b>\r\n              </li>\r\n              <li>Click around to see the different properties of each tile.</li>\r\n              <li>Build leaves early.</li>\r\n              <li>Leaves higher up have better water/sugar ratios, determined by the co2 percentage in the air.</li>\r\n              <li>Explore underground for water reservoires and Fountains.</li>\r\n              <li>Build transports (capital T) to carry water back up the plant.</li>\r\n              <li>You can scroll out infinitely far.</li>\r\n            </ol>\r\n          </p>\r\n          <h3>You</h3>\r\n          <p>\r\n            You can carry max {PLAYER_MAX_RESOURCES} resources, and you automatically suck in any resources you're\r\n            standing over. You can only walk on Tissue (and Transport). You start at the center of the map, with soil\r\n            below and air above.\r\n          </p>\r\n          <h3>Soil and Underground</h3>\r\n          <p>\r\n            Underground, Soil holds water, rocks block your way, and occasionally Fountains (at the very bottom) are a\r\n            permanent source of water. Soil is split up into Sand, Silt, and Clay. Water flows through sand easily, silt\r\n            normally, and clay slowly. Fountains emit one water per 3 seconds.\r\n          </p>\r\n          <h3>Air and Aboveground</h3>\r\n          <p>\r\n            Aboveground, Air provides both sunlight and co2. Sunlight determines the ratio of waters-per-sugar at which\r\n            reactions happen and are affected by shadows. Co2 determines the speed of reaction and gets better as you\r\n            build higher up. Orange is low co2, blue is high co2. Gravity will pull down on your structures, so make\r\n            sure they're structurally sound. Your structures cast shadows on the leaves below in relation to the sun,\r\n            which gently sways left to right.\r\n          </p>\r\n          <h3>Water</h3>\r\n          <p>\r\n            Water is one of the main two resources. Water slowly diffuses from high to low densities, and is pulled down\r\n            by gravity. Obtain water in the ground through Roots. Leaves require water to photosynthesize. You require\r\n            water to build.\r\n          </p>\r\n          <h3>Sugar</h3>\r\n          <p>\r\n            Sugar is the other main resource. Sugar does not diffuse. Leaves convert water into sugar. Obtain sugar by\r\n            putting water next to leaves. Cells require sugar to survive. You require sugar to build.\r\n          </p>\r\n          <h3>Building</h3>\r\n          <p>\r\n            Build Tissue, Leaves, Roots, and The Fruit by toggling \"build mode\" on and walking into Air or Soil. Build\r\n            Transport over existing tissue by walking around. Building costs 1 sugar and 1 water. You can build Tissue\r\n            over Leaves and Roots - be careful! When you build above ground, Cells will Droop if they're not properly\r\n            supported underneath them.\r\n          </p>\r\n          <h3>Cells</h3>\r\n          <p>\r\n            All cells require energy upkeep and will automatically eat sugar on their tile, or get energy from their\r\n            neighbors.\r\n          </p>\r\n          <h3>Tissue</h3>\r\n          <p>\r\n            Tissue connects your plant together, you may only walk on Tissue. Each Tissue carries up to{\" \"}\r\n            {TISSUE_INVENTORY_CAPACITY} resources.\r\n          </p>\r\n          <h3>Roots</h3>\r\n          <p>\r\n            Roots are the only way to get water. Each turn Roots transport one water per neighboring soil into the\r\n            Tissue in the opposite direction (so the Tissue North of the root get water in the South tile). This is\r\n            called a Pairing.\r\n          </p>\r\n          <h3>Leaves</h3>\r\n          <p>\r\n            When exposed to Air, Leaves convert water to sugar. Leaves also use Pairings between opposite direction\r\n            Air/Tissue with water. In perfect co2 and Water availability, Leaves produce 1 sugar every{\" \"}\r\n            {LEAF_REACTION_TIME.toFixed(2)} seconds per pair. Leaf efficiency is heavily influenced by co2 and sunlight\r\n            of its neighboring Air. If your leaf is in too much shadow, it will not be able to photosynthesize. Leaves\r\n            higher up produce sugar faster.\r\n          </p>\r\n          <h3>Transport</h3>\r\n          <p>\r\n            Transports move 1 water from its own Tile in the direction it was laid per turn, as well as moving you.\r\n            Transport hungers at double speed.\r\n          </p>\r\n          <h3>The Fruit</h3>\r\n          <p>\r\n            You can only build one Fruit, and it is the goal of the game to fill it up with resources. Fruit has up to\r\n            1000 sugar storage and aggressively pulls in every available sugar in its surrounding vicinity.\r\n          </p>\r\n          {this.renderCredit()}\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  renderCredit() {\r\n    return (\r\n      <>\r\n        <h2>Attribution</h2>\r\n        <p>\r\n          Tiles:{\" \"}\r\n          <a href=\"http://kenney.nl/assets?s=roguelike\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n            Kenney.nl Roguelike Assets\r\n          </a>\r\n        </p>\r\n        <p>\r\n          Pop sound when leaves convert:{\" \"}\r\n          <a href=\"http://soundbible.com/2067-Blop.html\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n            Blop by Mark DiAngelo\r\n          </a>{\" \"}\r\n          (<a href=\"https://creativecommons.org/licenses/by/3.0/us/\">CC BY 3.0 US</a>)\r\n        </p>\r\n        <p>\r\n          Perlin noise:{\" \"}\r\n          <a href=\"https://github.com/josephg/noisejs\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n            josephg/noisejs\r\n          </a>\r\n        </p>\r\n        <p>\r\n          Part of 7drl 2018:{\" \"}\r\n          <a href=\"http://7drl.org/\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n            http://7drl.org/\r\n          </a>\r\n        </p>\r\n        <p>\r\n          Fruit icon:{\" \"}\r\n          <a href=\"https://www.freepik.com/free-vector/fruits-set-pixel-icons_1001072.htm\">Designed by Freepik</a>\r\n        </p>\r\n      </>\r\n    );\r\n  }\r\n}\r\n","import { FunctionNode, Node, NodeBuilder, TempNode, UVNode } from \"three/examples/jsm/nodes/Nodes\";\r\n\r\nexport class OvalNode extends TempNode {\r\n  private uv = new UVNode();\r\n\r\n  // VERY IMPORTANT TO TRIM WHITESPACE because THREE's internal regex is whitespace sensitive\r\n  static ovalOutFn = new FunctionNode(\r\n    `\r\nfloat ovalOut(vec2 vUv, float time) {\r\n    return clamp((time - length(vUv - vec2(0.5))) * 15., 0.0, 1.0);\r\n}`.trim()\r\n  );\r\n\r\n  constructor(public time: Node) {\r\n    super(\"f\");\r\n  }\r\n\r\n  generate(builder: NodeBuilder, output: string) {\r\n    const fn = builder.include(OvalNode.ovalOutFn);\r\n    return builder.format(\r\n      fn + \"( \" + this.uv.build(builder, \"v2\") + \", \" + this.time.build(builder, \"f\") + \" )\",\r\n      this.getType(builder),\r\n      output\r\n    );\r\n  }\r\n}\r\n","import { sleep } from \"common/promise\";\r\nimport { Action } from \"core/player/action\";\r\nimport { easeSinIn } from \"d3-ease\";\r\nimport { PopulationAttempt } from \"game/app\";\r\nimport { Mouse } from \"game/input/mouse\";\r\nimport { ISketch, SketchAudioContext } from \"game/screens/sketch/sketch\";\r\nimport * as React from \"react\";\r\nimport { environmentFromLevelInfo } from \"std/environments\";\r\nimport VignetteCapturer from \"std/vignette\";\r\nimport * as THREE from \"three\";\r\nimport { OrthographicCamera, PerspectiveCamera, Scene, Vector2, Vector3, WebGLRenderer } from \"three\";\r\nimport { OrbitControls } from \"three/examples/jsm/controls/OrbitControls\";\r\nimport * as Nodes from \"three/examples/jsm/nodes/Nodes\";\r\nimport configure from \"../../common/configure\";\r\nimport { World } from \"../../core\";\r\nimport { Cell, Tile } from \"../../core/tile\";\r\nimport { clamp, lerp, lerp2, map } from \"../../math/index\";\r\nimport { drums, hookUpAudio, strings, whoosh } from \"../audio\";\r\nimport { GameResult, maybeGetGameResult } from \"../gameResult\";\r\nimport { ControlScheme, PlayerSeedControlScheme } from \"../input/ControlScheme\";\r\nimport { ToolBar } from \"../input/toolBar\";\r\nimport { params } from \"../params\";\r\nimport { InstancedTileRenderer } from \"../renderers/tile/InstancedTileRenderer\";\r\nimport { WorldRenderer } from \"../renderers/WorldRenderer\";\r\nimport { NewPlayerTutorial } from \"../tutorial\";\r\nimport { Hover, HUD } from \"../ui/ingame\";\r\nimport Debug from \"../ui/ingame/Debug\";\r\nimport { Instructions } from \"../ui/ingame/Instructions\";\r\nimport { CameraState } from \"./cameraState\";\r\nimport { logRenderInfo } from \"./logRenderInfo\";\r\nimport \"./mito.scss\";\r\nimport { OvalNode } from \"./ovalNode\";\r\nimport { perfDebugThreeObjects } from \"./perfDebugThreeObjects\";\r\nimport { WorldDOMElement } from \"./WorldDOMElement\";\r\n\r\nexport class Mito extends ISketch {\r\n  static id = \"mito\";\r\n\r\n  public readonly world: World;\r\n\r\n  public readonly toolBar: ToolBar;\r\n\r\n  public readonly scene = configure(new Scene(), (s) => {\r\n    s.background = new THREE.Color(\"black\");\r\n  });\r\n\r\n  public readonly scenePlayerSeed = new Scene();\r\n\r\n  private readonly camera = new OrthographicCamera(0, 0, 0, 0, -100, 100);\r\n\r\n  public tutorialRef: NewPlayerTutorial | null = null;\r\n\r\n  public mouse = new Mouse(this.canvas);\r\n\r\n  public instructionsOpen = false;\r\n\r\n  public readonly audioListener = new THREE.AudioListener();\r\n\r\n  public highlightedTile?: Tile;\r\n\r\n  private _inspectedCell?: Cell;\r\n\r\n  public get inspectedCell() {\r\n    return this._inspectedCell;\r\n  }\r\n\r\n  public set inspectedCell(c: Cell | undefined) {\r\n    console.trace(\"set inspectedCell to\", c);\r\n    this._inspectedCell = c;\r\n  }\r\n\r\n  public readonly worldRenderer: WorldRenderer;\r\n\r\n  private vignetteCapturer = new VignetteCapturer(this);\r\n\r\n  public vignettes: HTMLCanvasElement[] = [];\r\n\r\n  private hackCamera?: PerspectiveCamera;\r\n\r\n  private orbitControls?: OrbitControls;\r\n\r\n  private suggestedCamera?: CameraState;\r\n\r\n  private userZoom: number;\r\n\r\n  private _controls?: ControlScheme;\r\n\r\n  public get controls() {\r\n    return this._controls;\r\n  }\r\n\r\n  public set controls(controls: ControlScheme | undefined) {\r\n    if (this._controls != null) {\r\n      this._controls.destroy();\r\n    }\r\n    this._controls = controls;\r\n  }\r\n\r\n  public nodeFrame = new Nodes.NodeFrame(0);\r\n\r\n  public nodePost: Nodes.NodePostProcessing;\r\n\r\n  public ovalOutTime: Nodes.FloatNode;\r\n\r\n  constructor(\r\n    renderer: WebGLRenderer,\r\n    context: SketchAudioContext,\r\n    attempt: PopulationAttempt,\r\n    public onWinLoss: (result: GameResult) => void\r\n  ) {\r\n    super(renderer, context);\r\n    this.renderer.autoClear = false;\r\n    this.nodePost = new Nodes.NodePostProcessing(renderer);\r\n    this.ovalOutTime = new Nodes.FloatNode(0);\r\n    const noiseNode = new Nodes.MathNode(\r\n      new Nodes.ScreenNode(),\r\n      new OvalNode(this.ovalOutTime),\r\n      this.ovalOutTime,\r\n      Nodes.MathNode.MIN\r\n    );\r\n    this.nodePost.output = noiseNode as any;\r\n    const { info } = attempt.targetHex;\r\n    this.world = new World(environmentFromLevelInfo(info), info.seed, attempt.settlingSpecies);\r\n    this.world.player.on(\"action-fail\", this.handlePlayerActionFail);\r\n\r\n    this.camera.position.z = 10;\r\n    this.camera.lookAt(0, 0, 0);\r\n    this.camera.position.x = this.world.player.pos.x;\r\n    this.camera.position.y = this.world.player.pos.y;\r\n    this.camera.zoom = this.userZoom = 1.5;\r\n    this.camera.add(this.audioListener);\r\n\r\n    // this.hackCamera = new PerspectiveCamera(60, this.canvas.height / this.canvas.width);\r\n\r\n    if (this.hackCamera != null) {\r\n      // this.hackCamera.position.copy(this.camera.position);\r\n      // this.hackCamera.lookAt(0, 0, 0);\r\n      this.orbitControls = new OrbitControls(this.hackCamera, this.canvas);\r\n      this.scene.add(new THREE.AxesHelper(25));\r\n    }\r\n\r\n    this.worldRenderer = new WorldRenderer(this.world, this.scene, this);\r\n\r\n    hookUpAudio(this.audioContext);\r\n    this.updateAmbientAudio();\r\n    this.attachWindowEvents();\r\n\r\n    this.toolBar = new ToolBar(this);\r\n    // this.actionBar = new SwitchableBar(new CellBar(this), new InteractBar(this));\r\n    // this.actionBar = new AltHeldBar(this);\r\n    // this.controls = new ControlScheme(this);\r\n    this.controls = new PlayerSeedControlScheme(this);\r\n  }\r\n\r\n  public events = {\r\n    wheel: (e: WheelEvent) => {\r\n      const delta = -(e.deltaX + e.deltaY) / 125 / 20;\r\n      const currZoom = this.userZoom;\r\n      const scalar = Math.pow(2, delta);\r\n      const newZoom = currZoom * scalar;\r\n      this.userZoom = newZoom;\r\n    },\r\n  };\r\n\r\n  private handlePlayerActionFail = (action: Action) => {\r\n    if (action.type === \"pickup\" && this.world.player.inventory.isMaxed()) {\r\n      this.showInvalidAction({ message: \"Inventory full!\" });\r\n    } else if (action.type === \"drop\" && action.target && action.target.inventory.isMaxed()) {\r\n      this.showInvalidAction({ message: `${action.target.displayName} inventory full!` });\r\n    } else if (action.type === \"build\") {\r\n      const buildError = this.world.player.getBuildError();\r\n      if (buildError) {\r\n        this.showInvalidAction({ message: `Need ${buildError}!` });\r\n      } else {\r\n        this.showInvalidAction({ message: \"Can't build there!\" });\r\n      }\r\n    }\r\n  };\r\n\r\n  private handleBeforeUnload = () => {\r\n    return true;\r\n  };\r\n\r\n  private handleContextMenu = (e: MouseEvent) => {\r\n    e.preventDefault();\r\n    return false;\r\n  };\r\n\r\n  private attachWindowEvents() {\r\n    window.onbeforeunload = this.handleBeforeUnload;\r\n    window.addEventListener(\"contextmenu\", this.handleContextMenu);\r\n    (window as any).mito = this;\r\n    (window as any).THREE = THREE;\r\n  }\r\n\r\n  destroy() {\r\n    // settings controls to undefined calls destroy on controls\r\n    window.removeEventListener(\"contextmenu\", this.handleContextMenu);\r\n    this.controls = undefined;\r\n    window.onbeforeunload = null;\r\n  }\r\n\r\n  public render() {\r\n    if (!params.hud) {\r\n      return null;\r\n    }\r\n    const worldDomElementComponents: React.ReactNode[] = [];\r\n    for (const e of this.worldDomElements) {\r\n      worldDomElementComponents.push(e.render());\r\n    }\r\n    const showPlayerHUD = this.world.playerSeed == null;\r\n    return (\r\n      <>\r\n        {/* <NewPlayerTutorial ref={(ref) => this.tutorialRef = ref } mito={this} />, */}\r\n        <HUD mito={this} />\r\n        {showPlayerHUD ? <Hover mito={this} /> : null}\r\n        <div className=\"world-dom-components\">{worldDomElementComponents}</div>\r\n        {params.showGodUI ? <Debug mito={this} /> : null}\r\n        {this.instructionsOpen ? <Instructions play={() => (this.instructionsOpen = false)} /> : null}\r\n      </>\r\n    );\r\n  }\r\n\r\n  public updateAmbientAudio() {\r\n    const yPos = this.world.player.pos.y;\r\n    const drumVolume = map(yPos, this.world.height / 2, this.world.height, 0, 0.5);\r\n    const stringsVolume = map(yPos, this.world.height / 2, 0, 0, 0.5);\r\n    drums.gain.gain.value = Math.max(0, drumVolume);\r\n    strings.gain.gain.value = Math.max(0, stringsVolume);\r\n  }\r\n\r\n  maybeToggleInstructions(code: string) {\r\n    if (code === \"F1\") {\r\n      this.instructionsOpen = !this.instructionsOpen;\r\n      return true;\r\n    }\r\n    if (this.instructionsOpen) {\r\n      if (code === \"Escape\") {\r\n        this.instructionsOpen = false;\r\n        return true;\r\n      }\r\n    }\r\n  }\r\n\r\n  public worldStep(dt: number) {\r\n    if (this.instructionsOpen) {\r\n      return;\r\n    }\r\n\r\n    this.world.step(dt);\r\n\r\n    if (this.tutorialRef) {\r\n      this.tutorialRef.setState({ time: this.world.time });\r\n    }\r\n\r\n    const gameResult = maybeGetGameResult(this);\r\n    if (gameResult != null) {\r\n      this.onWinLoss(gameResult);\r\n    }\r\n\r\n    this.updateAmbientAudio();\r\n  }\r\n\r\n  private getCameraNormCoordinates(clientX: number, clientY: number) {\r\n    return new THREE.Vector2((clientX / this.canvas.width) * 2 - 1, (-clientY / this.canvas.height) * 2 + 1);\r\n  }\r\n\r\n  public readonly PLAYER_TETHER_DISTANCE = 0.9;\r\n\r\n  public getPlayerInfluenceVector(clientX = this.mouse.position.x, clientY = this.mouse.position.y) {\r\n    const cursorCameraNorm = this.getCameraNormCoordinates(clientX, clientY);\r\n    const cursorWorld = new Vector3(cursorCameraNorm.x, cursorCameraNorm.y, 0).unproject(this.camera);\r\n\r\n    const offset = new Vector2(cursorWorld.x, cursorWorld.y).sub(this.world.player.posFloat);\r\n    offset.clampLength(0, this.PLAYER_TETHER_DISTANCE);\r\n    return offset;\r\n  }\r\n\r\n  public getHighlightPosition() {\r\n    if (this.inspectedCell) {\r\n      return this.inspectedCell.pos;\r\n    }\r\n    const clientX = this.mouse.position.x,\r\n      clientY = this.mouse.position.y;\r\n    // if (this.actionBar.current instanceof CellBar) {\r\n    const offset = this.getPlayerInfluenceVector(clientX, clientY);\r\n    const { x, y } = this.world.player.posFloat;\r\n\r\n    offset.x += x;\r\n    offset.y += y;\r\n    return offset;\r\n    // } else {\r\n    //   const cursorCameraNorm = this.getCameraNormCoordinates(clientX, clientY);\r\n    //   const cursorWorld = new Vector3(cursorCameraNorm.x, cursorCameraNorm.y, 0).unproject(this.camera);\r\n    //   return cursorWorld;\r\n    // }\r\n  }\r\n\r\n  public getHighlightedTile() {\r\n    const p = this.getHighlightPosition();\r\n    p.round();\r\n\r\n    const tile = this.world.tileAt(p.x, p.y);\r\n    if (tile != null && tile.lightAmount() > 0) {\r\n      return tile;\r\n    }\r\n  }\r\n\r\n  worldToScreen(world: Vector2) {\r\n    const screen = new Vector3(world.x, world.y, 0);\r\n    screen.project(this.camera); // `camera` is a THREE.PerspectiveCamera\r\n\r\n    screen.x = Math.round((0.5 + screen.x / 2) * this.canvas.width);\r\n    screen.y = Math.round((0.5 - screen.y / 2) * this.canvas.height);\r\n\r\n    return screen;\r\n  }\r\n\r\n  private worldDomElements = new Set<WorldDOMElement>();\r\n\r\n  addWorldDOMElement(positionFn: () => THREE.Vector2 | Tile, renderFn: () => React.ReactNode): WorldDOMElement {\r\n    const e = new WorldDOMElement(this, positionFn, renderFn);\r\n    this.worldDomElements.add(e);\r\n    return e;\r\n  }\r\n\r\n  removeWorldDOMElement(worldDomElement: WorldDOMElement) {\r\n    this.worldDomElements.delete(worldDomElement);\r\n  }\r\n\r\n  async addFloatingText(position: Vector2 | Tile, text: React.ReactNode) {\r\n    const element = this.addWorldDOMElement(\r\n      () => position,\r\n      () => <div className=\"floating-text\">{text}</div>\r\n    );\r\n    await sleep(1000);\r\n    this.removeWorldDOMElement(element);\r\n  }\r\n\r\n  invalidAction?: { message: string };\r\n\r\n  async showInvalidAction(invalidAction: { message: string }) {\r\n    this.invalidAction = invalidAction;\r\n    await sleep(3000);\r\n    if (this.invalidAction === invalidAction) {\r\n      this.invalidAction = undefined;\r\n    }\r\n  }\r\n\r\n  public animate(millisDelta: number) {\r\n    this.controls?.animate(millisDelta);\r\n\r\n    if (this.inspectedCell?.isDead) {\r\n      this.inspectedCell = undefined;\r\n    }\r\n    if (\r\n      this.inspectedCell != null &&\r\n      this.inspectedCell.pos.distanceTo(this.world.player.posFloat) > this.PLAYER_TETHER_DISTANCE * 2\r\n    ) {\r\n      this.inspectedCell = undefined;\r\n    }\r\n\r\n    // cap out at 1/3rd of a second in one frame (about 10 frames)\r\n    const dt = Math.min(millisDelta / 1000, 1 / 3);\r\n    this.worldStep(dt);\r\n    this.worldRenderer.update();\r\n\r\n    this.highlightedTile = this.getHighlightedTile();\r\n    if (this.highlightedTile != null) {\r\n      (this.worldRenderer.getOrCreateRenderer(this.highlightedTile) as InstancedTileRenderer).updateHover();\r\n    }\r\n\r\n    if (this.vignetteCapturer.isTimeForNewCapture()) {\r\n      const v = this.vignetteCapturer.capture();\r\n      this.vignettes.push(v);\r\n    }\r\n\r\n    this.updateCamera(this.suggestedCamera || this.defaultCameraState());\r\n\r\n    this.suggestedCamera = undefined;\r\n\r\n    if (this.hackCamera != null) {\r\n      this.renderer.render(this.scene, this.hackCamera);\r\n    } else {\r\n      const ovalOutStart = 3.5;\r\n      // did trigger this frame?\r\n      if (this.world.time - dt < ovalOutStart && this.world.time > ovalOutStart) {\r\n        whoosh.play();\r\n      }\r\n      this.ovalOutTime.value = easeSinIn(clamp((this.world.time - ovalOutStart) / 1.5, 0, 1));\r\n      this.nodeFrame.update(millisDelta / 1000);\r\n\r\n      // render everything as per norm\r\n      this.renderer.clear();\r\n      this.nodePost.render(this.scene, this.camera, this.nodeFrame);\r\n\r\n      // render the player seed on top, after PostProcessing, so it's always there\r\n      this.renderer.clearDepth();\r\n      this.renderer.render(this.scenePlayerSeed, this.camera);\r\n    }\r\n    if (params.debugPerf && this.frameCount % 100 === 0) {\r\n      perfDebugThreeObjects(this);\r\n      logRenderInfo(this.renderer);\r\n    }\r\n  }\r\n\r\n  defaultCameraState(): CameraState {\r\n    if (this.world.playerSeed == null) {\r\n      const mouseNorm = this.getCameraNormCoordinates(this.mouse.position.x, this.mouse.position.y);\r\n\r\n      const cameraTarget = this.world.player.droopPosFloat().clone();\r\n      cameraTarget.x += mouseNorm.x / 2;\r\n      cameraTarget.y -= mouseNorm.y / 2;\r\n\r\n      return {\r\n        center: cameraTarget,\r\n        zoom: this.userZoom,\r\n      };\r\n    } else {\r\n      return {\r\n        center: this.world.playerSeed.pos,\r\n        zoom: this.userZoom,\r\n      };\r\n    }\r\n  }\r\n\r\n  updateCamera(targetState: CameraState) {\r\n    const { center, zoom } = targetState;\r\n    lerp2(this.camera.position, center, 0.2);\r\n    if (Math.abs(this.camera.zoom - zoom) > 0.001) {\r\n      this.camera.zoom = lerp(this.camera.zoom, targetState.zoom, 0.1);\r\n      this.camera.updateProjectionMatrix();\r\n    }\r\n  }\r\n\r\n  suggestCamera(suggestedCamera: CameraState) {\r\n    this.suggestedCamera = suggestedCamera;\r\n  }\r\n\r\n  public resize(w: number, h: number) {\r\n    const aspect = h / w;\r\n    // at zoom 1, we see 12 pixels up and 12 pixels down\r\n    const cameraHeight = 12;\r\n    this.camera.left = -cameraHeight / aspect;\r\n    this.camera.right = cameraHeight / aspect;\r\n    this.camera.top = -cameraHeight;\r\n    this.camera.bottom = cameraHeight;\r\n    // this.camera.position.z = 1;\r\n    // this.camera.lookAt(new Vector3(0, 0, 0));\r\n    this.camera.updateProjectionMatrix();\r\n    this.nodePost.setSize(w, h);\r\n  }\r\n}\r\n\r\nexport default Mito;\r\n","export default function configure<T>(obj: T, callback: (obj: T) => void): T {\r\n  callback(obj);\r\n  return obj;\r\n}\r\n","import { WebGLRenderer } from \"three\";\r\n\r\nexport function logRenderInfo(renderer: WebGLRenderer) {\r\n  console.log(`Geometries in memory: ${renderer.info.memory.geometries}\r\nTextures in memory: ${renderer.info.memory.textures}\r\nNumber of Programs: ${renderer.info.programs!.length}\r\n# Render Calls: ${renderer.info.render.calls}\r\n# Render Lines: ${renderer.info.render.lines}\r\n# Render Points: ${renderer.info.render.points}\r\n# Render Tris: ${renderer.info.render.triangles}\r\n`);\r\n}\r\n","import { Mito } from \"./mito\";\r\n\r\nexport function perfDebugThreeObjects(mito: Mito) {\r\n  // count how many have autoUpdate enabled\r\n  let yes = 0,\r\n    no = 0;\r\n  mito.scene.traverse((o) => {\r\n    if (o.matrixAutoUpdate) {\r\n      yes++;\r\n    } else {\r\n      no++;\r\n    }\r\n  });\r\n  console.log(\"matrixAutoUpdate: yes\", yes, \", no\", no);\r\n  // count how many Objects of each type there are\r\n  const s = new Map();\r\n  mito.scene.traverse((o) => {\r\n    const k = s.get(o.name || o.constructor.name) || [];\r\n    s.set(o.name || o.constructor.name, k);\r\n    k.push(o);\r\n  });\r\n  console.log(s);\r\n}\r\n","import classnames from \"classnames\";\r\nimport { params } from \"game/params\";\r\nimport { Howler } from \"howler\";\r\nimport * as React from \"react\";\r\nimport { FaVolumeOff, FaVolumeUp } from \"react-icons/fa\";\r\nimport Ticker from \"std/ticker\";\r\nimport * as THREE from \"three\";\r\nimport Mito from \"../../mito/mito\";\r\nimport { ISketch, SketchAudioContext, UI_EVENTS } from \"./sketch\";\r\nimport \"./SketchComponent.scss\";\r\n\r\nexport interface ISketchComponentProps extends React.DOMAttributes<HTMLDivElement> {\r\n  eventsOnBody?: boolean;\r\n  errorElement?: JSX.Element;\r\n  otherArgs?: any[];\r\n}\r\n\r\nexport interface SketchSuccess {\r\n  type: \"success\";\r\n  sketch: ISketch;\r\n}\r\n\r\nexport interface SketchError {\r\n  type: \"error\";\r\n  error: Error;\r\n}\r\n\r\nexport interface SketchLoading {\r\n  type: \"loading\";\r\n}\r\n\r\nexport type SketchStatus = SketchSuccess | SketchError | SketchLoading;\r\n\r\n// Expects sketch to be setup but not init. SketchSuccessComponent is responsible for:\r\n//      firing resize events\r\n//      attaching ui event listeners\r\n//      keeping focus on the canvas\r\ninterface SketchSuccessComponentProps {\r\n  sketch: ISketch;\r\n  eventsOnBody?: boolean;\r\n}\r\n\r\ninterface SketchSuccessComponentState {\r\n  frameCount: number;\r\n  volumeEnabled: boolean;\r\n}\r\n\r\nclass SketchSuccessComponent extends React.PureComponent<SketchSuccessComponentProps, SketchSuccessComponentState> {\r\n  private frameId?: number;\r\n\r\n  private lastTimestamp = 0;\r\n\r\n  private stop = false;\r\n\r\n  constructor(props: SketchSuccessComponentProps) {\r\n    super(props);\r\n    this.state = {\r\n      frameCount: props.sketch.frameCount,\r\n      volumeEnabled: JSON.parse(window.localStorage.getItem(\"sketch-volumeEnabled\") || \"true\"),\r\n    };\r\n  }\r\n\r\n  public shouldPlayAudio() {\r\n    return this.state.volumeEnabled && document.visibilityState === \"visible\" && document.hasFocus();\r\n  }\r\n\r\n  public syncAudioContext() {\r\n    const { audioContext } = this.props.sketch;\r\n    if (audioContext != null) {\r\n      // this.userVolume.gain.value = this.state.volumeEnabled ? 1 : 0;\r\n      if (this.shouldPlayAudio() && audioContext.state === \"suspended\") {\r\n        audioContext.resume();\r\n      } else if (!this.shouldPlayAudio() && audioContext.state === \"running\") {\r\n        audioContext.suspend();\r\n      }\r\n    }\r\n  }\r\n\r\n  componentDidMount() {\r\n    window.addEventListener(\"resize\", this.handleWindowResize);\r\n    document.addEventListener(\"visibilitychange\", this.handleVisibilityChange);\r\n    this.handleWindowResize();\r\n\r\n    // canvas setup\r\n    const canvas = this.props.sketch.renderer.domElement;\r\n    canvas.tabIndex = 1;\r\n    (Object.keys(UI_EVENTS) as Array<keyof typeof UI_EVENTS>).forEach((eventName) => {\r\n      if (this.props.sketch.events != null) {\r\n        const callback = this.props.sketch.events[eventName] as EventListener;\r\n        if (callback != null) {\r\n          if (this.props.eventsOnBody) {\r\n            document.body.addEventListener(eventName, callback);\r\n          } else {\r\n            canvas.addEventListener(eventName, callback);\r\n          }\r\n        }\r\n      }\r\n    });\r\n    // prevent scrolling the viewport\r\n    // $canvas.on(\"touchmove\", (event) => {\r\n    //     event.preventDefault();\r\n    // });\r\n\r\n    this.frameId = Ticker.addAnimation(this.loop);\r\n  }\r\n\r\n  render() {\r\n    const sketchElementsWithKey: React.ReactNode[] = [];\r\n    if (this.props.sketch.render != null) {\r\n      sketchElementsWithKey.push(this.props.sketch.render());\r\n    }\r\n    if (this.props.sketch.elements != null) {\r\n      sketchElementsWithKey.push(...this.props.sketch.elements);\r\n    }\r\n    return (\r\n      <div className=\"sketch-elements\">\r\n        {/* {sketchElementsWithKey} */}\r\n        {sketchElementsWithKey.map((el, idx) => {\r\n          if (React.isValidElement(el)) {\r\n            return React.cloneElement(el, { key: idx });\r\n          } else {\r\n            return el;\r\n          }\r\n        })}\r\n        {this.renderVolumeButton()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderVolumeButton() {\r\n    if (params.hud) {\r\n      const { volumeEnabled } = this.state;\r\n      return (\r\n        <button className=\"user-volume\" onClick={this.handleVolumeButtonClick}>\r\n          {volumeEnabled ? <FaVolumeUp /> : <FaVolumeOff />}\r\n        </button>\r\n      );\r\n    }\r\n  }\r\n\r\n  private handleVolumeButtonClick = () => {\r\n    const volumeEnabled = !this.state.volumeEnabled;\r\n    this.setState({ volumeEnabled });\r\n    window.localStorage.setItem(\"sketch-volumeEnabled\", JSON.stringify(volumeEnabled));\r\n  };\r\n\r\n  componentWillUnmount() {\r\n    this.stop = true;\r\n\r\n    if (this.props.sketch.destroy) {\r\n      this.props.sketch.destroy();\r\n    }\r\n    if (this.frameId != null) {\r\n      Ticker.removeAnimation(this.frameId);\r\n    }\r\n    this.props.sketch.renderer.dispose();\r\n    window.removeEventListener(\"resize\", this.handleWindowResize);\r\n    document.removeEventListener(\"visibilitychange\", this.handleVisibilityChange);\r\n\r\n    const canvas = this.props.sketch.canvas;\r\n    (Object.keys(UI_EVENTS) as Array<keyof typeof UI_EVENTS>).forEach((eventName) => {\r\n      if (this.props.sketch.events != null) {\r\n        const callback = this.props.sketch.events[eventName] as EventListener;\r\n        if (callback != null) {\r\n          if (this.props.eventsOnBody) {\r\n            document.body.removeEventListener(eventName, callback);\r\n          } else {\r\n            canvas.removeEventListener(eventName, callback);\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private loop = (timestamp: number) => {\r\n    const millisElapsed = timestamp - this.lastTimestamp;\r\n    this.lastTimestamp = timestamp;\r\n    this.props.sketch.frameCount++;\r\n    this.props.sketch.timeElapsed = timestamp;\r\n    this.syncAudioContext();\r\n    try {\r\n      this.props.sketch.animate(millisElapsed);\r\n    } catch (e) {\r\n      console.error(e);\r\n    }\r\n\r\n    // careful - sketch.animate() might have triggered a whole React update loop\r\n    // and made this component unmount.\r\n    if (!this.stop) {\r\n      // force new render()\r\n      this.setState({\r\n        frameCount: this.props.sketch.frameCount,\r\n      });\r\n    } else {\r\n      Ticker.removeAnimation(this.frameId!);\r\n    }\r\n  };\r\n\r\n  private handleWindowResize = () => {\r\n    const { renderer } = this.props.sketch;\r\n    this.updateRendererCanvasToMatchParent(renderer);\r\n    if (this.props.sketch.resize != null) {\r\n      this.props.sketch.resize(renderer.domElement.width, renderer.domElement.height);\r\n    }\r\n  };\r\n\r\n  private handleVisibilityChange = () => {\r\n    this.syncAudioContext();\r\n  };\r\n\r\n  private updateRendererCanvasToMatchParent(renderer: THREE.WebGLRenderer) {\r\n    const parent = renderer.domElement.parentElement;\r\n    if (parent != null) {\r\n      renderer.setSize(parent.clientWidth, parent.clientHeight);\r\n    }\r\n  }\r\n}\r\n\r\nexport interface ISketchComponentState {\r\n  status: SketchStatus;\r\n}\r\n\r\nexport class SketchComponent extends React.PureComponent<ISketchComponentProps, ISketchComponentState> {\r\n  public state: ISketchComponentState = {\r\n    status: { type: \"loading\" },\r\n  };\r\n\r\n  // private renderer?: THREE.WebGLRenderer;\r\n  private audioContext?: SketchAudioContext;\r\n\r\n  private userVolume?: GainNode;\r\n\r\n  private handleContainerRef = (ref: HTMLDivElement | null) => {\r\n    if (ref != null) {\r\n      try {\r\n        // create dependencies, setup sketch, and move to success state\r\n        // we are responsible for live-updating the global user volume.\r\n        // const AudioContextConstructor: typeof AudioContext =\r\n        //   (window as any).AudioContext || (window as any).webkitAudioContext;\r\n        // const audioContext = (this.audioContext = new AudioContextConstructor() as SketchAudioContext);\r\n        const audioContext = (this.audioContext = Howler.ctx as SketchAudioContext);\r\n        (THREE.AudioContext as any).setContext(audioContext);\r\n        this.userVolume = audioContext.createGain();\r\n        this.userVolume.gain.setValueAtTime(0.8, 0);\r\n        this.userVolume.connect(Howler.masterGain);\r\n        const audioContextGain = (audioContext.gain = audioContext.createGain());\r\n        audioContextGain.connect(this.userVolume);\r\n\r\n        const renderer = new THREE.WebGLRenderer({\r\n          alpha: true,\r\n          preserveDrawingBuffer: true,\r\n          antialias: true,\r\n        });\r\n        renderer.debug.checkShaderErrors = true;\r\n        ref.appendChild(renderer.domElement);\r\n\r\n        const [attempt, onWinLoss] = this.props.otherArgs || [];\r\n        const sketch = new Mito(renderer, this.audioContext, attempt as any, onWinLoss as any);\r\n        this.setState({ status: { type: \"success\", sketch: sketch } });\r\n      } catch (e) {\r\n        this.setState({ status: { type: \"error\", error: e } });\r\n        console.error(e);\r\n      }\r\n    } else {\r\n      if (this.state.status.type === \"success\") {\r\n        this.state.status.sketch.canvas.remove();\r\n      }\r\n      this.userVolume?.disconnect();\r\n      this.setState({ status: { type: \"loading\" } });\r\n    }\r\n  };\r\n\r\n  public render() {\r\n    const { otherArgs, eventsOnBody, errorElement, ...containerProps } = this.props;\r\n    const className = classnames(\"sketch-component\", this.state.status.type);\r\n    return (\r\n      <div {...containerProps} className={className} ref={this.handleContainerRef}>\r\n        {this.renderSketchOrStatus()}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private renderSketchOrStatus() {\r\n    const { status } = this.state;\r\n    if (status.type === \"success\") {\r\n      // key on id to not destroy and re-create the component somehow\r\n      return <SketchSuccessComponent sketch={status.sketch} eventsOnBody={this.props.eventsOnBody} />;\r\n    } else if (status.type === \"error\") {\r\n      const errorElement = this.props.errorElement || this.renderDefaultErrorElement(status.error.message);\r\n      return errorElement;\r\n    } else if (status.type === \"loading\") {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  private renderDefaultErrorElement(message: string) {\r\n    return (\r\n      <p className=\"sketch-error\">\r\n        Oops - something went wrong! Make sure you're using Chrome, or are on your desktop.\r\n        <pre>{message}</pre>\r\n      </p>\r\n    );\r\n  }\r\n}\r\n","import { SketchComponent } from \"game/screens/sketch/SketchComponent\";\r\nimport * as React from \"react\";\r\nimport \"./MitoScreen.scss\";\r\n\r\nexport interface ISketchRouteProps {\r\n  otherArgs?: any[];\r\n}\r\n\r\nexport default class MitoScreen extends React.PureComponent<ISketchRouteProps, {}> {\r\n  public render() {\r\n    return (\r\n      <div className=\"full-page-sketch\" ref={this.handleDivRef}>\r\n        <SketchComponent otherArgs={this.props.otherArgs} />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  private handleDivRef = (div: HTMLDivElement | null) => {\r\n    if (div != null) {\r\n      // this.requestFullscreen(div);\r\n    } else {\r\n      this.exitFullscreen();\r\n    }\r\n  };\r\n\r\n  private exitFullscreen() {\r\n    if (document.webkitExitFullscreen) {\r\n      document.webkitExitFullscreen();\r\n    } else if (document.mozCancelFullScreen) {\r\n      document.mozCancelFullScreen();\r\n    }\r\n  }\r\n}\r\n","import { Button } from \"game/ui/common/Button\";\r\nimport Character from \"game/ui/common/Character\";\r\nimport React, { useEffect } from \"react\";\r\nimport \"./StartScreen.scss\";\r\n\r\nconst StartScreen: React.FC<{ onStart: () => void }> = ({ onStart }) => {\r\n  // useEffect(() => {\r\n  //   mitoStartScreen.play();\r\n  //   return () => {\r\n  //     mitoStartScreen.stop();\r\n  //   };\r\n  // }, []);\r\n  useEffect(() => {\r\n    const listenForEnter = (event: KeyboardEvent) => {\r\n      if (event.code === \"Enter\" || event.code === \"Space\") {\r\n        onStart();\r\n      }\r\n    };\r\n    window.addEventListener(\"keydown\", listenForEnter);\r\n    return () => {\r\n      window.removeEventListener(\"keydown\", listenForEnter);\r\n    };\r\n  }, [onStart]);\r\n\r\n  return (\r\n    <div className=\"start-screen\">\r\n      <h1>\r\n        Mito\r\n        <Character size=\"small\" className=\"mito-i\" />\r\n      </h1>\r\n      <Button color=\"green\" onClick={onStart}>\r\n        Start Game\r\n      </Button>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default StartScreen;\r\n","import { MousePositionContext } from \"common/useMousePosition\";\r\nimport { GameResult } from \"game/gameResult\";\r\nimport OverWorldScreen from \"game/screens/OverWorldScreen\";\r\nimport React from \"react\";\r\nimport { CSSTransition } from \"react-transition-group\";\r\nimport { createSelector } from \"reselect\";\r\nimport { LocalForageStateProvider } from \"../app/AppStateProvider\";\r\nimport { AppReducerContext, useAppReducer } from \"../app/reducer\";\r\nimport { AppState } from \"../app/state\";\r\nimport \"./App.scss\";\r\nimport GameResultsScreen from \"./GameResultsScreen\";\r\nimport MitoScreen from \"./MitoScreen\";\r\nimport StartScreen from \"./StartScreen\";\r\n\r\ninterface AppComponentState {\r\n  mousePosition: { x: number; y: number };\r\n  showTestLoseScreen?: boolean;\r\n  showStartScreen: boolean;\r\n}\r\n\r\nclass AppComponent extends React.PureComponent<{}, AppComponentState> {\r\n  static contextType = AppReducerContext;\r\n\r\n  context!: React.ContextType<typeof AppReducerContext>;\r\n\r\n  constructor(props: {}, context: any) {\r\n    super(props, context);\r\n    this.state = {\r\n      mousePosition: { x: window.innerWidth / 2, y: window.innerHeight / 2 },\r\n      showStartScreen: true,\r\n    };\r\n  }\r\n\r\n  handleMousePosition = (e: MouseEvent) => {\r\n    this.setState({\r\n      mousePosition: { x: e.clientX, y: e.clientY },\r\n    });\r\n  };\r\n\r\n  componentDidMount() {\r\n    document.addEventListener(\"mousemove\", this.handleMousePosition);\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    document.removeEventListener(\"mousemove\", this.handleMousePosition);\r\n  }\r\n\r\n  handleNextEpoch = () => {\r\n    const [, dispatch] = this.context;\r\n    dispatch({ type: \"AANextEpoch\" });\r\n  };\r\n\r\n  handleWinLoss = (result: GameResult) => {\r\n    const [, dispatch] = this.context;\r\n    dispatch({\r\n      type: \"AATransitionStart\",\r\n      transition: {\r\n        type: \"AAGetGameResult\",\r\n        result,\r\n      },\r\n    });\r\n  };\r\n\r\n  handleResultsDone = () => {\r\n    const [, dispatch] = this.context;\r\n    dispatch({\r\n      type: \"AATransitionStart\",\r\n      transition: {\r\n        type: \"AAGameResultDone\",\r\n      },\r\n    });\r\n  };\r\n\r\n  render() {\r\n    const [state] = this.context;\r\n    return (\r\n      <MousePositionContext.Provider value={this.state.mousePosition}>\r\n        <div className=\"App\">\r\n          <AppScreen show={this.state.showStartScreen}>\r\n            <StartScreen onStart={() => this.setState({ showStartScreen: false })} />\r\n          </AppScreen>\r\n          <AppScreen show={state.activePopulationAttempt == null && !this.state.showStartScreen}>\r\n            <OverWorldScreen onNextEpoch={this.handleNextEpoch} />\r\n          </AppScreen>\r\n          <AppScreen show={state.activePopulationAttempt != null && state.activeGameResult == null}>\r\n            <MitoScreen otherArgs={this.otherArgsSelector(state)} />\r\n          </AppScreen>\r\n          <AppScreen show={state.activeGameResult != null}>\r\n            {state.activeGameResult ? (\r\n              <GameResultsScreen results={state.activeGameResult} onDone={this.handleResultsDone} />\r\n            ) : (\r\n              // HACK AppScreen *needs* one element; I think there's one single tick where\r\n              // AppScreen is still rendering its children even when it shouldn't.\r\n              <div></div>\r\n            )}\r\n          </AppScreen>\r\n        </div>\r\n      </MousePositionContext.Provider>\r\n    );\r\n  }\r\n\r\n  private otherArgsSelector = createSelector(\r\n    (s: AppState) => s.activePopulationAttempt,\r\n    (activePopulationAttempt) => [activePopulationAttempt, this.handleWinLoss]\r\n  );\r\n}\r\n\r\nconst AppScreen: React.FC<{ show: boolean; children?: JSX.Element }> = ({ show, children }) => {\r\n  const [state] = useAppReducer();\r\n  return (\r\n    <CSSTransition\r\n      in={show && state.transition == null}\r\n      timeout={2000}\r\n      mountOnEnter\r\n      unmountOnExit\r\n      classNames=\"fade-to-black\"\r\n    >\r\n      {children}\r\n    </CSSTransition>\r\n  );\r\n};\r\n\r\nconst App = () => (\r\n  <LocalForageStateProvider loadingComponent={<div>Loading...</div>}>\r\n    <AppComponent />\r\n  </LocalForageStateProvider>\r\n);\r\n\r\nexport default App;\r\n","import { Environment } from \"core/environment\";\r\nimport { Layout, PlotData } from \"plotly.js\";\r\nimport React from \"react\";\r\nimport { World } from \"../core\";\r\nimport { hasInventory } from \"../core/inventory\";\r\nimport { newBaseSpecies } from \"../core/species\";\r\nimport { Air, Fountain, Rock, Soil } from \"../core/tile\";\r\nimport { Desert, Rocky, Temperate } from \"../std/environments\";\r\nimport { findBuildCandidateTiles } from \"../std/worldUtils\";\r\nimport { Experiment, ExperimentSuite } from \"./experiment\";\r\n\r\nfunction runTests(environment: Environment, id: string) {\r\n  console.log(\"running\");\r\n  const suite = new ExperimentSuite([\r\n    new Experiment({\r\n      countAir: (t) => t.filter((tile) => tile.constructor === Air).length,\r\n    }),\r\n    new Experiment({\r\n      countSoil: (t) => t.filter((tile) => tile.constructor === Soil).length,\r\n    }),\r\n    new Experiment({\r\n      countRock: (t) => t.filter((tile) => tile.constructor === Rock).length,\r\n    }),\r\n    new Experiment({\r\n      countFountain: (t) => t.filter((tile) => tile.constructor === Fountain).length,\r\n    }),\r\n    new Experiment({\r\n      playerY: (_, w) => w.player.pos.y,\r\n    }),\r\n    new Experiment({\r\n      startAdjacentWaters: (_, w) => {\r\n        const adjacentTiles = findBuildCandidateTiles(w, (t) => t instanceof Soil);\r\n        let water = 0;\r\n        for (const t of adjacentTiles) {\r\n          if (hasInventory(t)) {\r\n            water += t.inventory.water;\r\n          }\r\n        }\r\n        return water;\r\n      },\r\n    }),\r\n    new Experiment({\r\n      countWaters: (t) => {\r\n        return t.reduce((w, tile) => w + (hasInventory(tile) ? tile.inventory.water : 0), 0);\r\n      },\r\n    }),\r\n  ]);\r\n  for (let i = 0; i < 20; i++) {\r\n    console.time(\"trial \" + i);\r\n    const world = new World(environment, i, newBaseSpecies());\r\n    suite.recordDataFor(Array.from(world.allEnvironmentTiles()));\r\n    console.timeEnd(\"trial \" + i);\r\n  }\r\n\r\n  plotStackedBar(suite.experiments.slice(0, 4), id);\r\n\r\n  for (const e of suite.experiments) {\r\n    plotHistogram(e, id);\r\n  }\r\n}\r\n\r\nfunction plotStackedBar(experiments: Experiment[], divId: string) {\r\n  const data = [];\r\n  const names = experiments.map((e) => e.visitorNames().join(\"\"));\r\n  for (const idx in names) {\r\n    const name = names[idx];\r\n    const x = [];\r\n    const y = [];\r\n    for (let i = 0; i < experiments[0].trials.length; i++) {\r\n      x.push(i);\r\n\r\n      const e = experiments[idx];\r\n      const trial = e.trials[i];\r\n      const value = trial[name];\r\n      y.push(value);\r\n    }\r\n    const trace: Partial<PlotData> = {\r\n      x,\r\n      y,\r\n      name,\r\n      type: \"bar\",\r\n    };\r\n    data.push(trace);\r\n  }\r\n  var layout: Partial<Layout> = { barmode: \"stack\" };\r\n\r\n  const div = document.createElement(\"div\");\r\n  const el = document.getElementById(divId)!;\r\n  el.appendChild(div);\r\n  window.Plotly.newPlot(div, data, layout);\r\n}\r\n\r\nfunction plotHistogram(stats: Experiment, divId: string) {\r\n  const data = [];\r\n  const layout: Partial<Layout> = {};\r\n\r\n  for (const name of stats.visitorNames()) {\r\n    var trace: Partial<PlotData> = {\r\n      x: stats.trials.map((t) => t[name]),\r\n      type: \"histogram\",\r\n      name: name,\r\n    };\r\n    data.push(trace);\r\n\r\n    layout.title = {\r\n      text: name,\r\n    };\r\n  }\r\n  const div = document.createElement(\"div\");\r\n  const el = document.getElementById(divId)!;\r\n  el.appendChild(div);\r\n  div.style.height = \"240px\";\r\n  div.style.width = \"320px\";\r\n  div.style.display = \"inline-block\";\r\n  window.Plotly.newPlot(div, data, layout);\r\n}\r\n\r\nfunction TestStats() {\r\n  React.useEffect(() => {\r\n    var script = document.createElement(\"script\");\r\n    script.src = \"https://cdn.plot.ly/plotly-latest.min.js\";\r\n    script.addEventListener(\"load\", function() {\r\n      runTests(Temperate, \"temperate\");\r\n      runTests(Rocky, \"rocky\");\r\n      runTests(Desert, \"desert\");\r\n    });\r\n\r\n    document.body.appendChild(script);\r\n  }, []);\r\n\r\n  return (\r\n    <div>\r\n      <h1>Experiments</h1>\r\n      <div id=\"temperate\">\r\n        <h2>Temperate</h2>\r\n      </div>\r\n      <div id=\"rocky\">\r\n        <h2>Rocky</h2>\r\n      </div>\r\n      <div id=\"desert\">\r\n        <h2>Desert</h2>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default TestStats;\r\n","import { World } from \"../core\";\r\nimport { Tile } from \"../core/tile\";\r\n\r\nexport function findBuildCandidateTiles(world: World, predicate?: (tile: Tile) => boolean) {\r\n  const entityPredicate: (tile: Tile) => boolean = (t) => world.player.isWalkable(t);\r\n  const candidates: Set<Tile> = new Set();\r\n  for (const entity of world.entities()) {\r\n    if (entity instanceof Tile && entityPredicate(entity)) {\r\n      for (const [, neighbor] of world.tileNeighbors(entity.pos)) {\r\n        if (world.player.canBuildAt(neighbor)) {\r\n          if (predicate == null) {\r\n            candidates.add(neighbor);\r\n          } else if (predicate(neighbor)) {\r\n            candidates.add(neighbor);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return candidates;\r\n}\r\n","import React from \"react\";\r\nimport { Link, Route, RouteComponentProps, Switch } from \"react-router-dom\";\r\nimport TestDiffusion from \"tests/TestDiffusion\";\r\nimport { TestLoseScreen } from \"tests/TestLoseScreen\";\r\nimport { TestWinScreen } from \"tests/TestWinScreen\";\r\nimport App from \"./game/screens/App\";\r\nimport \"./index.scss\";\r\nimport TestStats from \"./tests/TestStats\";\r\n\r\nexport default () => (\r\n  <Switch>\r\n    <Route path=\"/test-lose\">\r\n      <TestLoseScreen />\r\n    </Route>\r\n    <Route path=\"/test-win\">\r\n      <TestWinScreen />\r\n    </Route>\r\n    <Route path=\"/test-stats\">\r\n      <TestStats />\r\n    </Route>\r\n    <Route path=\"/test-diffusion\">\r\n      <TestDiffusion />\r\n    </Route>\r\n    <Route exact path=\"/\">\r\n      <App />\r\n    </Route>\r\n    <Route path=\"*\" component={Page404} />\r\n  </Switch>\r\n);\r\n\r\nconst Page404: React.FC<RouteComponentProps> = () => {\r\n  return (\r\n    <div>\r\n      <h1>Unknown page</h1>\r\n      <Link to=\"/\">Back to main screen</Link>\r\n    </div>\r\n  );\r\n};\r\n","import { createModelSchema, primitive } from \"serializr\";\r\nimport { Color, Vector2 } from \"three\";\r\ncreateModelSchema(Color, {\r\n  r: primitive(),\r\n  g: primitive(),\r\n  b: primitive(),\r\n});\r\ncreateModelSchema(Vector2, {\r\n  x: primitive(),\r\n  y: primitive(),\r\n});\r\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === \"localhost\" ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === \"[::1]\" ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(/^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/)\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === \"production\" && \"serviceWorker\" in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL((process as { env: { [key: string]: string } }).env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener(\"load\", () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            \"This web app is being served cache-first by a service \" +\n              \"worker. To learn more, visit https://bit.ly/CRA-PWA\"\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then((registration) => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === \"installed\") {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                \"New content is available and will be used when all \" +\n                  \"tabs for this page are closed. See https://bit.ly/CRA-PWA.\"\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log(\"Content is cached for offline use.\");\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch((error) => {\n      console.error(\"Error during service worker registration:\", error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then((response) => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get(\"content-type\");\n      if (response.status === 404 || (contentType != null && contentType.indexOf(\"javascript\") === -1)) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then((registration) => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\"No internet connection found. App is running in offline mode.\");\n    });\n}\n\nexport function unregister() {\n  if (\"serviceWorker\" in navigator) {\n    navigator.serviceWorker.ready.then((registration) => {\n      registration.unregister();\n    });\n  }\n}\n","import React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\nimport \"react-dropdown/style.css\";\r\nimport { HashRouter } from \"react-router-dom\";\r\nimport Routes from \"Routes\";\r\nimport \"./addThreeJsModelSchemas\";\r\nimport \"./index.scss\";\r\nimport * as serviceWorker from \"./serviceWorker\";\r\n\r\nfunction requireAll(r: any) {\r\n  r.keys().forEach(r);\r\n}\r\nrequireAll((require as any).context(\"./std/genes/\", true, /Gene.*\\.tsx?$/));\r\n\r\nReactDOM.render(\r\n  <HashRouter>\r\n    <Routes />\r\n  </HashRouter>,\r\n\r\n  document.getElementById(\"root\")\r\n);\r\n\r\n// If you want your app to work offline and load faster, you can change\r\n// unregister() to register() below. Note this comes with some pitfalls.\r\n// Learn more about service workers: https://bit.ly/CRA-PWA\r\nserviceWorker.unregister();\r\n"],"sourceRoot":""}